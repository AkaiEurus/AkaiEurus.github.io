

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon/icon.jpg">
  <link rel="icon" href="/img/favicon/icon.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Eurus">
  <meta name="keywords" content="">
  
    <meta name="description" content="æ•´ç†ç ´ç¢çš„çŸ¥è¯†ä½“ç³»â€¦â€¦ æ ¹æ®è¿™ä¸ªå¤§ä½¬çš„å…¬ä¼—å·ğŸ‘‰#èŠèŠLinuxå†…æ ¸">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernelæºç åˆ†æ-å†…å­˜ç®¡ç†">
<meta property="og:url" content="http://akaieurus.github.io/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/index.html">
<meta property="og:site_name" content="Eurusç¦æ­¢æ‘†çƒ‚ï¼">
<meta property="og:description" content="æ•´ç†ç ´ç¢çš„çŸ¥è¯†ä½“ç³»â€¦â€¦ æ ¹æ®è¿™ä¸ªå¤§ä½¬çš„å…¬ä¼—å·ğŸ‘‰#èŠèŠLinuxå†…æ ¸">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://akaieurus.github.io/img/posts/pc27.jpg">
<meta property="article:published_time" content="2023-11-13T01:58:00.000Z">
<meta property="article:modified_time" content="2025-01-03T11:00:16.113Z">
<meta property="article:author" content="Eurus">
<meta property="article:tag" content="kernel">
<meta property="article:tag" content="source code">
<meta property="article:tag" content="memory">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://akaieurus.github.io/img/posts/pc27.jpg">
  
  
  
  <title>Kernelæºç åˆ†æ-å†…å­˜ç®¡ç† - Eurusç¦æ­¢æ‘†çƒ‚ï¼</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"akaieurus.github.io","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 100vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Eurus&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>é¦–é¡µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>å½’æ¡£</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>åˆ†ç±»</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>æ ‡ç­¾</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>å…³äº</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/posts/pc27.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Kernelæºç åˆ†æ-å†…å­˜ç®¡ç†"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-11-13 09:58" pubdate>
          2023å¹´11æœˆ13æ—¥ ä¸Šåˆ
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          6.1k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          51 åˆ†é’Ÿ
        
      </span>
    

    
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Kernelæºç åˆ†æ-å†…å­˜ç®¡ç†</h1>
            
            
              <div class="markdown-body">
                
                <p>æ•´ç†ç ´ç¢çš„çŸ¥è¯†ä½“ç³»â€¦â€¦</p>
<p>æ ¹æ®è¿™ä¸ªå¤§ä½¬çš„å…¬ä¼—å·ğŸ‘‰<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg2MzU3Mjc3Ng==&action=getalbum&album_id=2559805446807928833&scene=173&from_msgid=2247488210&from_itemidx=1&count=3&nolastread=1#wechat_redirect">#èŠèŠLinuxå†…æ ¸</a></p>
<span id="more"></span>

<p>å†…æ ¸ç‰ˆæœ¬5.19ï¼ˆbuddy systemå‰ï¼‰ï¼Œ5.4ï¼ˆbuddy systemå³ä¹‹åï¼‰</p>
<h1 id="è™šæ‹Ÿå†…å­˜ç®¡ç†"><a href="#è™šæ‹Ÿå†…å­˜ç®¡ç†" class="headerlink" title="è™šæ‹Ÿå†…å­˜ç®¡ç†"></a>è™šæ‹Ÿå†…å­˜ç®¡ç†</h1><p>å…ˆæ”¾ä¸€å¼ ç»“æ„å›¾</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/mm_struct.png" srcset="/img/loading.gif" lazyload class title="mm_struct">

<ul>
<li>task_structçš„mmæŒ‡å‘mm_structç»“æ„ä½“</li>
<li>mm_structçš„mmapæˆå‘˜æŒ‡å‘vm_area_structåŒå‘é“¾è¡¨çš„å¤´èŠ‚ç‚¹</li>
<li>vm_area_structé€šè¿‡åŒå‘é“¾è¡¨ä¸²è”</li>
<li>vm_area_structçš„vm_mmæŒ‡å‘æ‰€å±çš„mm_struct</li>
<li>mm_structçš„mm_rbé€šè¿‡çº¢é»‘æ ‘ç»„ç»‡æ‰€æœ‰vm_area_struct</li>
<li>vm_area_structçš„vm_rbæŒ‡å‘æ‰€å±çº¢é»‘æ ‘</li>
</ul>
<p>æ–°ç‰ˆæœ¬çš„vm_area_structæ”¹ç”¨maple_treeç»„ç»‡äº†</p>
<h2 id="mm-structç»“æ„ä½“"><a href="#mm-structç»“æ„ä½“" class="headerlink" title="mm_structç»“æ„ä½“"></a>mm_structç»“æ„ä½“</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> &#123;</span><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">mmap</span>;</span>		<span class="hljs-comment">/* list of VMAs */</span><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_root</span> <span class="hljs-title">mm_rb</span>;</span><br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> task_size;	<span class="hljs-comment">/* size of task vm space */</span><br><br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> total_vm;	   <span class="hljs-comment">/* Total pages mapped */</span><br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> locked_vm;   <span class="hljs-comment">/* Pages that have PG_mlocked set */</span><br>		<span class="hljs-type">atomic64_t</span>    pinned_vm;   <span class="hljs-comment">/* Refcount permanently increased */</span><br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> data_vm;	   <span class="hljs-comment">/* VM_WRITE &amp; ~VM_SHARED &amp; ~VM_STACK */</span><br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> exec_vm;	   <span class="hljs-comment">/* VM_EXEC &amp; ~VM_WRITE &amp; ~VM_STACK */</span><br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_vm;	   <span class="hljs-comment">/* VM_STACK */</span><br><br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start_code, end_code, start_data, end_data;<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start_brk, brk, start_stack;<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg_start, arg_end, env_start, env_end;<br>&#125;;<br></code></pre></td></tr></table></figure>

<ul>
<li>task_sizeï¼šç”¨æˆ·ç©ºé—´è™šæ‹Ÿåœ°å€å¤§å°ï¼Œç­‰äºTASK_SIZEå®ï¼Œ64ä½æ˜¯0x00007ffffffff000</li>
<li>å®šä¹‰å†…å­˜åŒºåŸŸçš„æˆå‘˜ï¼š<ul>
<li>start_codeï¼Œend_codeï¼šä»£ç æ®µ</li>
<li>start_dataï¼Œend_dataï¼šæ•°æ®æ®µ</li>
<li>start_brkï¼Œbrkï¼šå †åœ°å€èµ·å§‹åœ°å€ï¼Œç»“æŸåœ°å€</li>
<li>mmap_baseï¼šå†…å­˜æ˜ å°„åŒºèµ·å§‹åœ°å€</li>
<li>start_stackï¼šæ ˆèµ·å§‹ä½ç½®ï¼ˆæ ˆåº•ï¼‰</li>
<li>arg_startï¼Œarg_endï¼šå‚æ•°åˆ—è¡¨</li>
<li>env_startï¼Œenv_endï¼šç¯å¢ƒå˜é‡</li>
</ul>
</li>
<li>ç‰©ç†å†…å­˜æ˜ å°„å†…å®¹ç›¸å…³ç»Ÿè®¡å˜é‡ï¼š<ul>
<li>total_vmï¼šè¿›ç¨‹è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­æ˜ å°„ç‰©ç†å†…å­˜é¡µçš„æ€»æ•°</li>
<li>locked_vmï¼šé”å®šä¸èƒ½æ¢å‡ºçš„å†…å­˜é¡µæ€»æ•°</li>
<li>pinned_vmï¼šæ—¢ä¸èƒ½æ¢å‡ºï¼Œä¹Ÿä¸èƒ½ç§»åŠ¨çš„å†…å­˜é¡µæ€»æ•°</li>
<li>data_vmï¼šæ•°æ®æ®µä¸­æ˜ å°„çš„å†…å­˜é¡µæ•°ç›®</li>
<li>exec_vmï¼šä»£ç æ®µä¸­å­˜æ”¾å¯æ‰§è¡Œæ–‡ä»¶çš„å†…å­˜é¡µæ•°ç›®</li>
<li>stack_vmï¼šæ ˆä¸­æ‰€æ˜ å°„çš„å†…å­˜é¡µæ•°ç›®</li>
</ul>
</li>
</ul>
<h2 id="vm-area-structç»“æ„ä½“"><a href="#vm-area-structç»“æ„ä½“" class="headerlink" title="vm_area_structç»“æ„ä½“"></a>vm_area_structç»“æ„ä½“</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> &#123;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> vm_start;		<span class="hljs-comment">/* Our start address within vm_mm. */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> vm_end;<br>    <br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vm_next</span>, *<span class="hljs-title">vm_prev</span>;</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> <span class="hljs-title">vm_rb</span>;</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">vm_mm</span>;</span>	<span class="hljs-comment">/* The address space we belong to. */</span><br><br>	<span class="hljs-type">pgprot_t</span> vm_page_prot;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> vm_flags;		<span class="hljs-comment">/* Flags, see mm.h. */</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">anon_vma</span> *<span class="hljs-title">anon_vma</span>;</span>	<span class="hljs-comment">/* Serialized by page_table_lock */</span><br><br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_operations_struct</span> *<span class="hljs-title">vm_ops</span>;</span><br><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> vm_pgoff;		<span class="hljs-comment">/* Offset (within vm_file) in PAGE_SIZE</span><br><span class="hljs-comment">					   units */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> * <span class="hljs-title">vm_file</span>;</span>		<span class="hljs-comment">/* File we map to (can be NULL). */</span><br>	<span class="hljs-type">void</span> * vm_private_data;		<span class="hljs-comment">/* was vm_pte (shared mem) */</span><br>&#125; __randomize_layout;<br></code></pre></td></tr></table></figure>

<ul>
<li><p>vm_startï¼Œvm_endï¼šè™šæ‹Ÿåœ°å€èŒƒå›´ï¼ˆå·¦é—­å³å¼€ï¼‰</p>
<ul>
<li>vm_page_protï¼šé¡µçº§åˆ«è®¿é—®æ§åˆ¶</li>
<li>vm_flagsï¼šè™šæ‹Ÿå†…å­˜è®¿é—®æ§åˆ¶</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">vma-&gt;vm_page_prot = vm_get_page_prot(vma-&gt;vm_flags) <span class="hljs-comment">// è½¬æ¢</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>vm_fileï¼šå…³è”è¢«æ˜ å°„çš„æ–‡ä»¶</p>
</li>
<li><p>vm_pgoffï¼šæ˜ å°„è¿›è™šæ‹Ÿå†…å­˜ä¸­çš„æ–‡ä»¶å†…å®¹ï¼Œåœ¨æ–‡ä»¶ä¸­çš„åç§»</p>
</li>
<li><p>anon_vmaï¼šåŒ¿åæ˜ å°„</p>
</li>
<li><p>vm_private_dataï¼šç”¨äºå­˜å‚¨VMAä¸­çš„ç§æœ‰æ•°æ®</p>
</li>
<li><p>vm_opsï¼šé’ˆå¯¹è™šæ‹Ÿå†…å­˜åŒºåŸŸVMAçš„ç›¸å…³æ“ä½œçš„å‡½æ•°æŒ‡é’ˆ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_operations_struct</span> &#123;</span><br>	<span class="hljs-type">void</span> (*open)(<span class="hljs-keyword">struct</span> vm_area_struct * area);<br>	<span class="hljs-type">void</span> (*close)(<span class="hljs-keyword">struct</span> vm_area_struct * area);<br>	<span class="hljs-type">vm_fault_t</span> (*fault)(<span class="hljs-keyword">struct</span> vm_fault *vmf);<br>&#125;;<br></code></pre></td></tr></table></figure>

<ul>
<li>openï¼šæŒ‡å®šçš„è™šæ‹Ÿå†…å­˜åŒºåŸŸè¢«åŠ å…¥åˆ°è¿›ç¨‹è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­æ—¶è°ƒç”¨</li>
<li>closeï¼šè™šæ‹Ÿå†…å­˜åŒºåŸŸVMAä»è¿›ç¨‹è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­è¢«åˆ é™¤æ—¶è°ƒç”¨</li>
<li>faultï¼šå‘ç”Ÿç¼ºé¡µå¼‚å¸¸æ—¶è°ƒç”¨ï¼ˆæœªåˆ†é…ç‰©ç†é¡µæˆ–è¢«æ¢å‡ºï¼‰</li>
<li>page_mkwriteï¼šå½“ä¸€ä¸ªåªè¯»çš„é¡µé¢å°†è¦å˜ä¸ºå¯å†™æ—¶è°ƒç”¨</li>
</ul>
</li>
</ul>
<h2 id="è™šæ‹Ÿå†…å­˜ç©ºé—´å¸ƒå±€"><a href="#è™šæ‹Ÿå†…å­˜ç©ºé—´å¸ƒå±€" class="headerlink" title="è™šæ‹Ÿå†…å­˜ç©ºé—´å¸ƒå±€"></a>è™šæ‹Ÿå†…å­˜ç©ºé—´å¸ƒå±€</h2><h3 id="32ä½"><a href="#32ä½" class="headerlink" title="32ä½"></a>32ä½</h3><p>è¿˜æ˜¯å…ˆæ”¾ä¸€å¼ å›¾</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/32%E4%BD%8D.png" srcset="/img/loading.gif" lazyload class title="32ä½">

<ul>
<li><p>å‰896Mç‰©ç†å†…å­˜ç›´æ¥æ˜ å°„åˆ°3Gâ€”3G+896M</p>
<ul>
<li>å‰1Mè¢«ç³»ç»Ÿå¯åŠ¨å ç”¨ï¼ˆBIOSä»€ä¹ˆçš„ï¼‰</li>
<li>åé¢æ˜¯å†…æ ¸ä»£ç æ®µï¼Œæ•°æ®æ®µï¼ŒBSSæ®µ</li>
<li>è¿›ç¨‹ç›¸å…³çš„æ•°æ®ç»“æ„ï¼Œå†…æ ¸æ ˆä¹Ÿä¼šå­˜æ”¾åœ¨ç‰©ç†å†…å­˜å‰896Mçš„è¿™æ®µåŒºåŸŸä¸­</li>
</ul>
<p>X86 ä½“ç³»ç»“æ„ä¸‹ï¼ŒISAæ€»çº¿çš„DMAï¼ˆç›´æ¥å†…å­˜å­˜å–ï¼‰æ§åˆ¶å™¨ï¼Œåªèƒ½å¯¹å†…å­˜çš„å‰16M è¿›è¡Œå¯»å€ï¼Œæ‰€ä»¥ç›´æ¥æ˜ å°„åŒºåˆåˆ†ä¸ºDMAæ˜ å°„åŒºå’ŒNORMALæ˜ å°„åŒº</p>
</li>
<li><p>å‰©ä¸‹çš„ç‰©ç†å†…å­˜åŠ¨æ€æ˜ å°„åˆ°vmallocåŠ¨æ€æ˜ å°„åŒºï¼Œä½¿ç”¨vmallocè¿›è¡Œåˆ†é…ï¼Œåˆ†é…çš„ç‰©ç†é¡µæ˜¯ä¸è¿ç»­çš„</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/vmalloc.png" srcset="/img/loading.gif" lazyload class title="vmalloc">
</li>
<li><p>æ°¸ä¹…æ˜ å°„åŒºå…è®¸å»ºç«‹ä¸ç‰©ç†é«˜ç«¯å†…å­˜ï¼ˆ896Mä»¥ä¸Šï¼‰çš„é•¿æœŸæ˜ å°„å…³ç³»ï¼Œæ¯”å¦‚å†…æ ¸é€šè¿‡ alloc_pages() å‡½æ•°åœ¨ç‰©ç†å†…å­˜çš„é«˜ç«¯å†…å­˜ä¸­ç”³è¯·è·å–åˆ°çš„ç‰©ç†å†…å­˜é¡µï¼Œè¿™äº›ç‰©ç†å†…å­˜é¡µå¯ä»¥é€šè¿‡è°ƒç”¨ kmap æ˜ å°„åˆ°æ°¸ä¹…æ˜ å°„åŒºä¸­</p>
</li>
<li><p>å›ºå®šæ˜ å°„åŒºç±»ä¼¼æ°¸ä¹…æ˜ å°„åŒºï¼Œä½†æ˜ å°„çš„ç‰©ç†é¡µæ˜¯å›ºå®šçš„ï¼Œåœ¨ç¼–è¯‘æœŸé—´å°±å·²ç»ç¡®å®š</p>
</li>
<li><p>ä¸´æ—¶æ˜ å°„åŒºç”¨äºæ‹·è´ç‰©ç†é¡µæ—¶ä¸´æ—¶å°†ç‰©ç†å†…å­˜é¡µæ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜</p>
</li>
</ul>
<h3 id="64ä½"><a href="#64ä½" class="headerlink" title="64ä½"></a>64ä½</h3><p>ä¾ç„¶å…ˆæ”¾ä¸€å¼ å›¾</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/64%E4%BD%8D.png" srcset="/img/loading.gif" lazyload class title="64ä½">

<p>å¤§éƒ¨åˆ†åœ¨32ä½éƒ½æœ‰</p>
<ul>
<li>è™šæ‹Ÿå†…å­˜æ˜ å°„åŒºç”¨äºå­˜æ”¾pageç»“æ„ä½“</li>
<li>ä»£ç æ®µç”¨äºæ˜ å°„å†…æ ¸ä»£ç </li>
</ul>
<h1 id="ç‰©ç†å†…å­˜ç®¡ç†"><a href="#ç‰©ç†å†…å­˜ç®¡ç†" class="headerlink" title="ç‰©ç†å†…å­˜ç®¡ç†"></a>ç‰©ç†å†…å­˜ç®¡ç†</h1><h2 id="ç‰©ç†å†…å­˜æ¨¡å‹"><a href="#ç‰©ç†å†…å­˜æ¨¡å‹" class="headerlink" title="ç‰©ç†å†…å­˜æ¨¡å‹"></a>ç‰©ç†å†…å­˜æ¨¡å‹</h2><h3 id="FLATMEMå¹³å¦å†…å­˜æ¨¡å‹"><a href="#FLATMEMå¹³å¦å†…å­˜æ¨¡å‹" class="headerlink" title="FLATMEMå¹³å¦å†…å­˜æ¨¡å‹"></a>FLATMEMå¹³å¦å†…å­˜æ¨¡å‹</h3><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/FLATMEM.png" srcset="/img/loading.gif" lazyload class title="FLATMEM">

<p>ä¸€ä¸ªpageå…¨å±€æ•°ç»„mem_mapç®¡å…¨éƒ¨</p>
<p>pfnå’Œpageçš„è½¬æ¢</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(CONFIG_FLATMEM)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __pfn_to_page(pfn)	(mem_map + ((pfn) - ARCH_PFN_OFFSET))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __page_to_pfn(page)	((unsigned long)((page) - mem_map) + \</span><br><span class="hljs-meta">				 ARCH_PFN_OFFSET)</span><br><span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined(CONFIG_DISCONTIGMEM)</span><br></code></pre></td></tr></table></figure>

<h3 id="DISCONTIGMEMéè¿ç»­å†…å­˜æ¨¡å‹"><a href="#DISCONTIGMEMéè¿ç»­å†…å­˜æ¨¡å‹" class="headerlink" title="DISCONTIGMEMéè¿ç»­å†…å­˜æ¨¡å‹"></a>DISCONTIGMEMéè¿ç»­å†…å­˜æ¨¡å‹</h3><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/DISCONTIGMEM.png" srcset="/img/loading.gif" lazyload class title="DISCONTIGMEM">

<p>pglist_dataè¡¨ç¤ºnode</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pglist_data</span> &#123;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_FLAT_NODE_MEM_MAP	<span class="hljs-comment">/* means !SPARSEMEM */</span></span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">node_mem_map</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_PAGE_EXTENSION</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>node_mem_mapæ•°ç»„ç®¡ç†page</p>
<p>pfnå’Œpageçš„è½¬æ¢å¤šäº†ä¸€æ­¥</p>
<ul>
<li>arch_pfn_to_nidæ ¹æ®ç‰©ç†é¡µçš„pfnå®šä½åˆ°æ‰€åœ¨node</li>
<li>page_to_nidæ ¹æ®pageå®šä½åˆ°æ‰€åœ¨node</li>
</ul>
<p>ä¹‹åä¸€æ ·</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined(CONFIG_DISCONTIGMEM)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __pfn_to_page(pfn)			\</span><br><span class="hljs-meta">(&#123;	unsigned long __pfn = (pfn);		\</span><br><span class="hljs-meta">	unsigned long __nid = arch_pfn_to_nid(__pfn);  \</span><br><span class="hljs-meta">	NODE_DATA(__nid)-&gt;node_mem_map + arch_local_page_offset(__pfn, __nid);\</span><br><span class="hljs-meta">&#125;)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __page_to_pfn(pg)						\</span><br><span class="hljs-meta">(&#123;	const struct page *__pg = (pg);					\</span><br><span class="hljs-meta">	struct pglist_data *__pgdat = NODE_DATA(page_to_nid(__pg));	\</span><br><span class="hljs-meta">	(unsigned long)(__pg - __pgdat-&gt;node_mem_map) +			\</span><br><span class="hljs-meta">	 __pgdat-&gt;node_start_pfn;					\</span><br><span class="hljs-meta">&#125;)</span><br></code></pre></td></tr></table></figure>

<h3 id="SPARSEMEMç¨€ç–å†…å­˜æ¨¡å‹"><a href="#SPARSEMEMç¨€ç–å†…å­˜æ¨¡å‹" class="headerlink" title="SPARSEMEMç¨€ç–å†…å­˜æ¨¡å‹"></a>SPARSEMEMç¨€ç–å†…å­˜æ¨¡å‹</h3><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/SPARSEMEM.png" srcset="/img/loading.gif" lazyload class title="SPARSEMEM">

<p>mem_sectionç®¡ç†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mem_section</span> &#123;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> section_mem_map;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>section_mem_mapå…¶å®æ˜¯ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ç®¡ç†çš„pageæ•°ç»„</p>
<p>ç”¨ä¸€ä¸ªå…¨å±€æ•°ç»„ç®¡ç†æ‰€æœ‰section</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">extern</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mem_section</span> **<span class="hljs-title">mem_section</span>;</span><br></code></pre></td></tr></table></figure>

<p>pfnå’Œpageçš„è½¬æ¢æ›´å¤æ‚äº†</p>
<ul>
<li>å¦‚æœæœ‰vmemmapç›´æ¥ä½¿ç”¨vmemapï¼ˆ64ä½ç©ºé—´å¤šéšæ„æŒ¥éœ( â€¢Ì€ Ï‰ â€¢Ì )âœ§ï¼‰</li>
<li>page_to_pfnå…ˆæ ¹æ®pageå®šä½åˆ°sectionï¼Œå†é€šè¿‡section_mem_mapå®šä½åˆ°pfn</li>
<li>pfn_to_pageå…ˆæ ¹æ®pfnå®šä½åˆ°sectionï¼Œå†é€šè¿‡pfnä»section_mem_mapæŒ‡å‘çš„æ•°ç»„å®šä½åˆ°page</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined(CONFIG_SPARSEMEM_VMEMMAP)</span><br><br><span class="hljs-comment">/* memmap is virtually contiguous.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __pfn_to_page(pfn)	(vmemmap + (pfn))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __page_to_pfn(page)	(unsigned long)((page) - vmemmap)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined(CONFIG_SPARSEMEM)</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Note: section&#x27;s mem_map is encoded to reflect its start_pfn.</span><br><span class="hljs-comment"> * section[i].section_mem_map == mem_map&#x27;s address - start_pfn;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __page_to_pfn(pg)					\</span><br><span class="hljs-meta">(&#123;	const struct page *__pg = (pg);				\</span><br><span class="hljs-meta">	int __sec = page_to_section(__pg);			\</span><br><span class="hljs-meta">	(unsigned long)(__pg - __section_mem_map_addr(__nr_to_section(__sec)));	\</span><br><span class="hljs-meta">&#125;)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __pfn_to_page(pfn)				\</span><br><span class="hljs-meta">(&#123;	unsigned long __pfn = (pfn);			\</span><br><span class="hljs-meta">	struct mem_section *__sec = __pfn_to_section(__pfn);	\</span><br><span class="hljs-meta">	__section_mem_map_addr(__sec) + __pfn;		\</span><br><span class="hljs-meta">&#125;)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* CONFIG_FLATMEM/DISCONTIGMEM/SPARSEMEM */</span></span><br></code></pre></td></tr></table></figure>

<h2 id="ç‰©ç†å†…å­˜æ¶æ„"><a href="#ç‰©ç†å†…å­˜æ¶æ„" class="headerlink" title="ç‰©ç†å†…å­˜æ¶æ„"></a>ç‰©ç†å†…å­˜æ¶æ„</h2><ul>
<li><p>UMAæ¶æ„ï¼ˆä¸€è‡´æ€§å†…å­˜è®¿é—®ï¼‰</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/UMA.png" srcset="/img/loading.gif" lazyload class title="UMA">
</li>
<li><p>NUMAæ¶æ„ï¼ˆéä¸€è‡´æ€§å†…å­˜è®¿é—®ï¼‰</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/NUMA.png" srcset="/img/loading.gif" lazyload class title="NUMA">

<p>è®¿é—®æœ¬åœ°å†…å­˜èŠ‚ç‚¹å¾ˆå¿«ï¼Œè®¿é—®å…¶ä»–å†…å­˜èŠ‚ç‚¹å¾ˆæ…¢</p>
</li>
</ul>
<p>NUMAçš„åˆ†é…ç­–ç•¥</p>
<ul>
<li>MPOL_BINDï¼šå¿…é¡»åœ¨ç»‘å®šçš„èŠ‚ç‚¹è¿›è¡Œåˆ†é…ï¼Œå†…å­˜ä¸è¶³åˆ™è¿›è¡Œswap</li>
<li>MPOL_INTERLEAVEï¼šæœ¬åœ°èŠ‚ç‚¹å’Œè¿œç¨‹èŠ‚ç‚¹éƒ½å¯ä»¥è¿›è¡Œåˆ†é…</li>
<li>MPOL_PREFERREDï¼šä¼˜å…ˆåœ¨æŒ‡å®šèŠ‚ç‚¹åˆ†é…å†…å­˜ï¼Œå½“æŒ‡å®šèŠ‚ç‚¹å†…å­˜ä¸è¶³æ—¶ï¼Œé€‰æ‹©ç¦»æŒ‡å®šèŠ‚ç‚¹æœ€è¿‘çš„èŠ‚ç‚¹åˆ†é…å†…å­˜</li>
<li>MPOL_LOCALï¼ˆé»˜è®¤ï¼‰ï¼šä¼˜å…ˆåœ¨æœ¬åœ°èŠ‚ç‚¹åˆ†é…ï¼Œå½“æœ¬åœ°èŠ‚ç‚¹å†…å­˜ä¸è¶³æ—¶ï¼Œå¯ä»¥åœ¨è¿œç¨‹èŠ‚ç‚¹åˆ†é…å†…å­˜</li>
</ul>
<h2 id="NUMAèŠ‚ç‚¹ç®¡ç†"><a href="#NUMAèŠ‚ç‚¹ç®¡ç†" class="headerlink" title="NUMAèŠ‚ç‚¹ç®¡ç†"></a>NUMAèŠ‚ç‚¹ç®¡ç†</h2><p>ç‰©ç†å†…å­˜åœ¨å†…æ ¸ä¸­ç®¡ç†çš„å±‚çº§å…³ç³»ä¸ºï¼šNodeâ†’Zoneâ†’page</p>
<p>ä¸€ä¸ªnodeè¡¨ç¤ºä¸€ä¸ªNUMAèŠ‚ç‚¹</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/nodes.png" srcset="/img/loading.gif" lazyload class title="nodes">

<p>å…ˆæ”¾ä¸€å¼ æ€»ä½“ç»“æ„å›¾</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/numanode.png" srcset="/img/loading.gif" lazyload class title="numanode">

<ul>
<li><p>ä½¿ç”¨ä¸€ä¸ªpglist_dataçš„å…¨å±€æ•°ç»„node_dataç®¡ç†æ‰€æœ‰node</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pglist_data</span> *<span class="hljs-title">node_data</span>[<span class="hljs-title">MAX_NUMNODES</span>] __<span class="hljs-title">read_mostly</span>;</span><br>EXPORT_SYMBOL(node_data);<br></code></pre></td></tr></table></figure>
</li>
<li><p>NUMAèŠ‚ç‚¹æè¿°ç»“æ„ä½“pglist_data</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pglist_data</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zone</span> <span class="hljs-title">node_zones</span>[<span class="hljs-title">MAX_NR_ZONES</span>];</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zonelist</span> <span class="hljs-title">node_zonelists</span>[<span class="hljs-title">MAX_ZONELISTS</span>];</span><br><br>	<span class="hljs-type">int</span> nr_zones; <span class="hljs-comment">/* number of populated zones in this node */</span><br><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> node_start_pfn;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> node_present_pages; <span class="hljs-comment">/* total number of physical pages */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> node_spanned_pages; <span class="hljs-comment">/* total size of physical page</span><br><span class="hljs-comment">					     range, including holes */</span><br>	<span class="hljs-type">int</span> node_id;<br>	<span class="hljs-type">wait_queue_head_t</span> kswapd_wait;<br>	<span class="hljs-type">wait_queue_head_t</span> pfmemalloc_wait;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> *<span class="hljs-title">kswapd</span>;</span>	<span class="hljs-comment">/* Protected by</span><br><span class="hljs-comment">					   mem_hotplug_begin/end() */</span><br>	<span class="hljs-type">int</span> kswapd_order;<br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">zone_type</span> <span class="hljs-title">kswapd_highest_zoneidx</span>;</span><br><br>	<span class="hljs-type">int</span> kswapd_failures;		<span class="hljs-comment">/* Number of &#x27;reclaimed == 0&#x27; runs */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_COMPACTION</span><br>	<span class="hljs-type">int</span> kcompactd_max_order;<br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">zone_type</span> <span class="hljs-title">kcompactd_highest_zoneidx</span>;</span><br>	<span class="hljs-type">wait_queue_head_t</span> kcompactd_wait;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> *<span class="hljs-title">kcompactd</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125; <span class="hljs-type">pg_data_t</span>;<br></code></pre></td></tr></table></figure>

<ul>
<li><p>node_idï¼šNUMAèŠ‚ç‚¹id</p>
</li>
<li><p>node_mem_mapï¼špageç±»å‹æ•°ç»„ï¼ŒåŒ…å«NUMAä¸­çš„æ‰€æœ‰ç‰©ç†é¡µ</p>
</li>
<li><p>node_start_pfnï¼šæŒ‡å‘NUMAèŠ‚ç‚¹å†…ç¬¬ä¸€ä¸ªç‰©ç†é¡µçš„PFNï¼ˆPFNå…¨å±€å”¯ä¸€ï¼‰</p>
</li>
<li><p>node_present_pagesï¼šå¯ç”¨çš„ç‰©ç†é¡µé¢æ•°é‡ï¼ˆä¸åŒ…å«ç©ºæ´ï¼‰</p>
</li>
<li><p>node_spanned_pagesï¼šæ‰€æœ‰ç‰©ç†é¡µé¢æ•°é‡ï¼ˆåŒ…å«ç©ºæ´ï¼‰</p>
</li>
<li><p>nr_zonesï¼šç”¨äºç»Ÿè®¡NUMAèŠ‚ç‚¹å†…åŒ…å«çš„ç‰©ç†å†…å­˜åŒºåŸŸä¸ªæ•°</p>
<p><strong>æ³¨ï¼šåªæœ‰ç¬¬ä¸€ä¸ªNUMAèŠ‚ç‚¹å¯ä»¥åŒ…å«æ‰€æœ‰ç§ç±»çš„zoneï¼Œæ¯”å¦‚DMAå¿…é¡»ä»ç‰©ç†å†…å­˜èµ·ç‚¹å¼€å§‹</strong></p>
</li>
<li><p>node_zonesï¼šzoneæ•°ç»„ï¼ŒåŒ…å«NUMAèŠ‚ç‚¹ä¸­çš„æ‰€æœ‰ç‰©ç†å†…å­˜åŒºåŸŸ</p>
</li>
<li><p>node_zonelistsï¼šzonelistæ•°ç»„ï¼ŒåŒ…å«äº†å¤‡ç”¨NUMAèŠ‚ç‚¹å’Œè¿™äº›å¤‡ç”¨èŠ‚ç‚¹ä¸­çš„ç‰©ç†å†…å­˜åŒºåŸŸï¼ˆå¤‡ç”¨èŠ‚ç‚¹æŒ‰è®¿é—®è·ç¦»è¿œè¿‘æ’åˆ—ï¼‰</p>
</li>
<li><p>kswapdï¼šä¸€ä¸ªç”¨äºå›æ”¶ä¸ç»å¸¸ä½¿ç”¨çš„é¡µé¢çš„è¿›ç¨‹</p>
</li>
<li><p>kcompactdï¼šä¸€ä¸ªç”¨äºå†…å­˜çš„è§„æ•´é¿å…å†…å­˜ç¢ç‰‡çš„è¿›ç¨‹</p>
</li>
</ul>
</li>
<li><p>NUMAèŠ‚ç‚¹ç‰©ç†å†…å­˜åŒºåŸŸçš„åˆ’åˆ†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">zone_type</span> &#123;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_ZONE_DMA</span><br>	ZONE_DMA,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_ZONE_DMA32</span><br>	ZONE_DMA32,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	ZONE_NORMAL,<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_HIGHMEM</span><br>	ZONE_HIGHMEM,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	ZONE_MOVABLE,<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_ZONE_DEVICE</span><br>	ZONE_DEVICE,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	__MAX_NR_ZONES<br><br>&#125;;<br></code></pre></td></tr></table></figure>

<ul>
<li>ZONE_DMAï¼šç”¨äºé‚£äº›æ— æ³•å¯¹å…¨éƒ¨ç‰©ç†å†…å­˜è¿›è¡Œå¯»å€çš„ç¡¬ä»¶è®¾å¤‡ï¼Œè¿›è¡Œ DMA æ—¶çš„å†…å­˜åˆ†é…ï¼ˆå¦‚ISAåªèƒ½å¯»å€å‰16Mï¼‰</li>
<li>ZONE_DMA32ï¼šæä¾›ç»™32ä½è®¾å¤‡ï¼ˆåªèƒ½å¯»å€4Gç‰©ç†å†…å­˜ï¼‰æ‰§è¡ŒDMAæ“ä½œæ—¶ä½¿ç”¨çš„ï¼ˆåªåœ¨64ä½ç³»ç»Ÿä¸­èµ·ä½œç”¨ï¼‰</li>
<li>ZONE_NORMALï¼šç›´æ¥æ˜ å°„çš„896Må‰©ä¸‹çš„éƒ¨åˆ†</li>
<li>ZONE_HIGHMEMï¼šå‰©ä¸‹çš„é«˜ç«¯å†…å­˜</li>
<li>ZONE_DEVICEï¼šä¸ºæ”¯æŒçƒ­æ’æ‹”è®¾å¤‡è€Œåˆ†é…çš„éæ˜“å¤±æ€§å†…å­˜ï¼ˆä¹Ÿå¯ç”¨äºå†…æ ¸å´©æºƒæ—¶ä¿å­˜ç›¸å…³çš„è°ƒè¯•ä¿¡æ¯ï¼‰</li>
<li>ZONE_MOVABLEï¼šå†…æ ¸å®šä¹‰çš„ä¸€ä¸ªè™šæ‹Ÿå†…å­˜åŒºåŸŸï¼Œè¯¥zoneä¸­çš„ç‰©ç†é¡µå¯ä»¥æ¥è‡ªäºä¸Šè¾¹ä»‹ç»çš„å‡ ç§çœŸå®çš„ç‰©ç†åŒºåŸŸï¼Œé¡µéƒ½æ˜¯å¯ä»¥è¿ç§»çš„ï¼Œä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢å†…å­˜ç¢ç‰‡å’Œæ”¯æŒå†…å­˜çš„çƒ­æ’æ‹”</li>
</ul>
</li>
<li><p>node_statesï¼šNUMAèŠ‚ç‚¹ä¸æ­¢ä¸€ä¸ªçš„æ—¶å€™ä½¿ç”¨ï¼Œä½å›¾ï¼Œç”¨äºç»´æŠ¤å„ä¸ªNUMAèŠ‚ç‚¹çš„çŠ¶æ€ä¿¡æ¯ï¼ˆåªæœ‰ä¸€ä¸ªNUMAèŠ‚ç‚¹æ—¶æ²¡æœ‰ï¼‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> DECLARE_BITMAP(bits, MAX_NUMNODES); &#125; <span class="hljs-type">nodemask_t</span>;<br><span class="hljs-keyword">extern</span> <span class="hljs-type">nodemask_t</span> _unused_nodemask_arg_;<br></code></pre></td></tr></table></figure>

<p>èŠ‚ç‚¹çŠ¶æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">node_states</span> &#123;</span><br>	N_POSSIBLE,		<span class="hljs-comment">/* The node could become online at some point */</span><br>	N_ONLINE,		<span class="hljs-comment">/* The node is online */</span><br>	N_NORMAL_MEMORY,	<span class="hljs-comment">/* The node has regular memory */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_HIGHMEM</span><br>	N_HIGH_MEMORY,		<span class="hljs-comment">/* The node has regular or high memory */</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>	N_HIGH_MEMORY = N_NORMAL_MEMORY,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	N_MEMORY,		<span class="hljs-comment">/* The node has memory(regular, high, movable) */</span><br>	N_CPU,		<span class="hljs-comment">/* The node has one or more cpus */</span><br>	N_GENERIC_INITIATOR,	<span class="hljs-comment">/* The node has one or more Generic Initiators */</span><br>	NR_NODE_STATES<br>&#125;;<br></code></pre></td></tr></table></figure>

<ul>
<li>N_POSSIBLEï¼šèŠ‚ç‚¹éšæ—¶ä¼šä¸Šçº¿</li>
<li>N_ONLINEï¼šèŠ‚ç‚¹å·²ä¸Šçº¿</li>
<li>N_NORMAL_MEMORYï¼šèŠ‚ç‚¹æ²¡æœ‰é«˜ç«¯å†…å­˜ï¼Œåªæœ‰ZONE_NORMAL</li>
<li>N_HIGH_MEMORYï¼šèŠ‚ç‚¹æœ‰ZONE_NORMALæˆ–è€…æœ‰ZONE_HIGHMEM</li>
<li>N_MEMORYï¼šèŠ‚ç‚¹æœ‰ZONE_NORMALï¼ŒZONE_HIGHMEMï¼ŒZONE_MOVABLE</li>
<li>N_CPUï¼šè¡¨ç¤ºèŠ‚ç‚¹åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª CPU</li>
</ul>
</li>
</ul>
<h2 id="NUMAèŠ‚ç‚¹ä¸­çš„ç‰©ç†å†…å­˜ç®¡ç†"><a href="#NUMAèŠ‚ç‚¹ä¸­çš„ç‰©ç†å†…å­˜ç®¡ç†" class="headerlink" title="NUMAèŠ‚ç‚¹ä¸­çš„ç‰©ç†å†…å­˜ç®¡ç†"></a>NUMAèŠ‚ç‚¹ä¸­çš„ç‰©ç†å†…å­˜ç®¡ç†</h2><p>zoneå’Œnodeçš„å…³ç³»</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/zone.png" srcset="/img/loading.gif" lazyload class title="zone">

<p>zoneç»“æ„ä½“</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zone</span> &#123;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> _watermark[NR_WMARK];<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> watermark_boost;<br><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> nr_reserved_highatomic;<br><br>	<span class="hljs-type">long</span> lowmem_reserve[MAX_NR_ZONES];<br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pglist_data</span>	*<span class="hljs-title">zone_pgdat</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">per_cpu_pageset</span> __<span class="hljs-title">percpu</span> *<span class="hljs-title">pageset</span>;</span><br><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>		zone_start_pfn;<br><br>	<span class="hljs-type">atomic_long_t</span>		managed_pages;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>		spanned_pages;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>		present_pages;<br><br>	<span class="hljs-type">const</span> <span class="hljs-type">char</span>		*name;<br><br>	ZONE_PADDING(_pad1_)<br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">free_area</span>	<span class="hljs-title">free_area</span>[<span class="hljs-title">MAX_ORDER</span>];</span><br><br>	<span class="hljs-type">spinlock_t</span>		lock;<br><br>	ZONE_PADDING(_pad3_)<br>	<span class="hljs-type">atomic_long_t</span>		vm_stat[NR_VM_ZONE_STAT_ITEMS];<br>&#125; ____cacheline_internodealigned_in_smp;<br></code></pre></td></tr></table></figure>

<ul>
<li><p>lockï¼šé˜²æ­¢å¹¶å‘è®¿é—®</p>
</li>
<li><p>nameï¼šå†…å­˜åŒºåŸŸåç§°ï¼ŒNormal &#x2F; DMA &#x2F; HighMem</p>
</li>
<li><p>zone_pgdatï¼šæŒ‡å‘æ‰€å±çš„NUMAèŠ‚ç‚¹</p>
</li>
<li><p>zone_start_pfnï¼šå±äºè¯¥zoneä¸­çš„ç¬¬ä¸€ä¸ªç‰©ç†é¡µPFN</p>
</li>
<li><p>spanned_pagesï¼šzoneä¸­æ‰€æœ‰ç‰©ç†é¡µä¸ªæ•°ï¼ˆåŒ…æ‹¬ç©ºæ´ï¼‰</p>
</li>
<li><p>present_pagesï¼šzoneä¸­å¯ç”¨ç‰©ç†é¡µä¸ªæ•°ï¼ˆä¸åŒ…æ‹¬ç©ºæ´ï¼‰</p>
</li>
<li><p>managed_pagesï¼šbuddy systemç®¡ç†çš„ç‰©ç†é¡µä¸ªæ•°</p>
</li>
<li><p>free_areaï¼šbuddy systemçš„æ ¸å¿ƒæ•°æ®ç»“æ„</p>
</li>
<li><p>vm_statï¼šè¯¥zoneä½¿ç”¨çš„ç»Ÿè®¡ä¿¡æ¯</p>
</li>
<li><p>nr_reserved_highatomicï¼šè¯¥zoneé¢„ç•™å†…å­˜çš„å¤§å°[128KB, 65536KB]</p>
</li>
<li><p>lowmem_reserveï¼šè§„å®šæ¯ä¸ªå†…å­˜åŒºåŸŸå¿…é¡»ä¸ºè‡ªå·±ä¿ç•™çš„ç‰©ç†é¡µæ•°é‡ï¼Œé˜²æ­¢æ›´é«˜ä½çš„å†…å­˜åŒºåŸŸå¯¹è‡ªå·±çš„å†…å­˜ç©ºé—´è¿›è¡Œè¿‡å¤šçš„ä¾µå æŒ¤å‹</p>
</li>
<li><p>_watermarkï¼šç‰©ç†å†…å­˜åŒºåŸŸä¸­çš„æ°´ä½çº¿</p>
<ul>
<li>ç‰©ç†å†…å­˜å‰©ä½™å®¹é‡å¤§äº_watermark[WMARK_HIGH] â†’ å†…å­˜å……è¶³ï¼Œåˆ†é…æ— å‹åŠ›</li>
<li>å¤§äº_watermark[WMARK_LOW]ï¼Œå°äº_watermark[WMARK_HIGH] â†’ åˆ†é…æœ‰å‹åŠ›ä½†å¯æ¥å—</li>
<li>å¤§äº_watermark[WMARK_MIN]ï¼Œå°äº_watermark[WMARK_LOW] â†’ å”¤é†’kswapdè¿›ç¨‹å¼€å§‹å¼‚æ­¥å›æ”¶</li>
<li>å°äº_watermark[WMARK_MIN] â†’ é˜»å¡è¯·æ±‚åˆ†é…çš„è¿›ç¨‹ï¼Œå”¤é†’kswapdè¿›ç¨‹è¿›è¡Œå›æ”¶ï¼Œå›æ”¶å®Œæ¯•å”¤é†’é˜»å¡çš„è¿›ç¨‹</li>
</ul>
</li>
<li><p>watermark_boostï¼šä¼˜åŒ–å†…å­˜ç¢ç‰‡å¯¹å†…å­˜åˆ†é…çš„å½±å“ï¼Œå¯ä»¥åŠ¨æ€æ”¹å˜å†…å­˜åŒºåŸŸçš„åŸºå‡†æ°´ä½çº¿</p>
</li>
<li><p>pagesetï¼šper_cpu_pagesetï¼Œç®¡ç†å†·çƒ­é¡µï¼ˆ__percpuå˜é‡ï¼‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">per_cpu_pageset</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">per_cpu_pages</span> <span class="hljs-title">pcp</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>ç”¨ä¸€ä¸ªåŒå‘åˆ—è¡¨ç®¡ç†per_cpu_pagesï¼Œçƒ­é¡µåœ¨å‰ï¼Œå†·é¡µåœ¨å</p>
<p>per_cpu_pagesç»“æ„ä½“</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">per_cpu_pages</span> &#123;</span><br>	<span class="hljs-type">int</span> count;		<span class="hljs-comment">/* number of pages in the list */</span><br>	<span class="hljs-type">int</span> high;		<span class="hljs-comment">/* high watermark, emptying needed */</span><br>	<span class="hljs-type">int</span> batch;		<span class="hljs-comment">/* chunk size for buddy add/remove */</span><br><br>	<span class="hljs-comment">/* Lists of pages, one per migrate type stored on the pcp-lists */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">lists</span>[<span class="hljs-title">MIGRATE_PCPTYPES</span>];</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<ul>
<li>listsï¼šåŒå‘åˆ—è¡¨</li>
<li>countï¼šç‰©ç†é¡µæ•°é‡</li>
<li>highï¼šcountè¶…è¿‡äº†highï¼Œé‚£ä¹ˆè¡¨ç¤ºlistä¸­çš„é¡µé¢å¤ªå¤šäº†ï¼Œå†…æ ¸ä¼šä»é«˜é€Ÿç¼“å­˜ä¸­é‡Šæ”¾batchä¸ªé¡µé¢åˆ°ç‰©ç†å†…å­˜åŒºåŸŸä¸­çš„ä¼™ä¼´ç³»ç»Ÿä¸­</li>
<li>batchï¼šè§ä¸Š</li>
</ul>
</li>
</ul>
<h2 id="ç‰©ç†å†…å­˜é¡µæè¿°"><a href="#ç‰©ç†å†…å­˜é¡µæè¿°" class="headerlink" title="ç‰©ç†å†…å­˜é¡µæè¿°"></a>ç‰©ç†å†…å­˜é¡µæè¿°</h2><p>pageç»“æ„ä½“</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> &#123;</span><br>    <span class="hljs-comment">// å­˜å‚¨ page çš„å®šä½ä¿¡æ¯ä»¥åŠç›¸å…³æ ‡å¿—ä½</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;        <br><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span>    <span class="hljs-comment">/* Page cache and anonymous pages */</span><br>            <span class="hljs-comment">// ç”¨æ¥æŒ‡å‘ç‰©ç†é¡µ page è¢«æ”¾ç½®åœ¨äº†å“ªä¸ª lru é“¾è¡¨ä¸Š</span><br>            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">lru</span>;</span><br>            <span class="hljs-comment">// å¦‚æœ page ä¸ºæ–‡ä»¶é¡µçš„è¯ï¼Œä½ä½ä¸º0ï¼ŒæŒ‡å‘ page æ‰€åœ¨çš„ page cache</span><br>            <span class="hljs-comment">// å¦‚æœ page ä¸ºåŒ¿åé¡µçš„è¯ï¼Œä½ä½ä¸º1ï¼ŒæŒ‡å‘å…¶å¯¹åº”è™šæ‹Ÿåœ°å€ç©ºé—´çš„åŒ¿åæ˜ å°„åŒº anon_vma</span><br>            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">address_space</span> *<span class="hljs-title">mapping</span>;</span><br>            <span class="hljs-comment">// å¦‚æœ page ä¸ºæ–‡ä»¶é¡µçš„è¯ï¼Œindex ä¸º page åœ¨ page cache ä¸­çš„ç´¢å¼•</span><br>            <span class="hljs-comment">// å¦‚æœ page ä¸ºåŒ¿åé¡µçš„è¯ï¼Œè¡¨ç¤ºåŒ¿åé¡µåœ¨å¯¹åº”è¿›ç¨‹è™šæ‹Ÿå†…å­˜åŒºåŸŸ VMA ä¸­çš„åç§»</span><br>            <span class="hljs-type">pgoff_t</span> index;<br>            <span class="hljs-comment">// åœ¨ä¸åŒåœºæ™¯ä¸‹ï¼Œprivate æŒ‡å‘çš„åœºæ™¯ä¿¡æ¯ä¸åŒ</span><br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>        &#125;;<br>        <br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span>    <span class="hljs-comment">/* slab, slob and slub */</span><br>            <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>                <span class="hljs-comment">// ç”¨äºæŒ‡å®šå½“å‰ page ä½äº slab ä¸­çš„å“ªä¸ªå…·ä½“ç®¡ç†é“¾è¡¨ä¸Šã€‚</span><br>                <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">slab_list</span>;</span><br>                <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>                    <span class="hljs-comment">// å½“ page ä½äº slab ç»“æ„ä¸­çš„æŸä¸ªç®¡ç†é“¾è¡¨ä¸Šæ—¶ï¼Œnext æŒ‡é’ˆç”¨äºæŒ‡å‘é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ª page</span><br>                    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">next</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_64BIT</span><br>                    <span class="hljs-comment">// è¡¨ç¤º slab ä¸­æ€»å…±æ‹¥æœ‰çš„ page ä¸ªæ•°</span><br>                    <span class="hljs-type">int</span> pages;  <br>                    <span class="hljs-comment">// è¡¨ç¤º slab ä¸­æ‹¥æœ‰çš„ç‰¹å®šç±»å‹çš„å¯¹è±¡ä¸ªæ•°</span><br>                    <span class="hljs-type">int</span> pobjects;   <br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>                    <span class="hljs-type">short</span> <span class="hljs-type">int</span> pages;<br>                    <span class="hljs-type">short</span> <span class="hljs-type">int</span> pobjects;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>                &#125;;<br>            &#125;;<br>            <span class="hljs-comment">// ç”¨äºæŒ‡å‘å½“å‰ page æ‰€å±çš„ slab ç®¡ç†ç»“æ„</span><br>            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *<span class="hljs-title">slab_cache</span>;</span> <br>        <br>            <span class="hljs-comment">// æŒ‡å‘ page ä¸­çš„ç¬¬ä¸€ä¸ªæœªåˆ†é…å‡ºå»çš„ç©ºé—²å¯¹è±¡</span><br>            <span class="hljs-type">void</span> *freelist;     <br>            <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>                <span class="hljs-comment">// æŒ‡å‘ page ä¸­çš„ç¬¬ä¸€ä¸ªå¯¹è±¡</span><br>                <span class="hljs-type">void</span> *s_mem;    <br>                <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span>            <span class="hljs-comment">/* SLUB */</span><br>                    <span class="hljs-comment">// è¡¨ç¤º slab ä¸­å·²ç»è¢«åˆ†é…å‡ºå»çš„å¯¹è±¡ä¸ªæ•°</span><br>                    <span class="hljs-type">unsigned</span> inuse:<span class="hljs-number">16</span>;<br>                    <span class="hljs-comment">// slab ä¸­æ‰€æœ‰çš„å¯¹è±¡ä¸ªæ•°</span><br>                    <span class="hljs-type">unsigned</span> objects:<span class="hljs-number">15</span>;<br>                    <span class="hljs-comment">// å½“å‰å†…å­˜é¡µ page è¢« slab æ”¾ç½®åœ¨ CPU æœ¬åœ°ç¼“å­˜åˆ—è¡¨ä¸­ï¼Œfrozen = 1ï¼Œå¦åˆ™ frozen = 0</span><br>                    <span class="hljs-type">unsigned</span> frozen:<span class="hljs-number">1</span>;<br>                &#125;;<br>            &#125;;<br>        &#125;;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span>    <span class="hljs-comment">/* å¤åˆé¡µ compound page ç›¸å…³*/</span><br>            <span class="hljs-comment">// å¤åˆé¡µçš„å°¾é¡µæŒ‡å‘é¦–é¡µ</span><br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> compound_head;    <br>            <span class="hljs-comment">// ç”¨äºé‡Šæ”¾å¤åˆé¡µçš„ææ„å‡½æ•°ï¼Œä¿å­˜åœ¨é¦–é¡µä¸­</span><br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> compound_dtor;<br>            <span class="hljs-comment">// è¯¥å¤åˆé¡µæœ‰å¤šå°‘ä¸ª page ç»„æˆ</span><br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> compound_order;<br>            <span class="hljs-comment">// è¯¥å¤åˆé¡µè¢«å¤šå°‘ä¸ªè¿›ç¨‹ä½¿ç”¨ï¼Œå†…å­˜é¡µåå‘æ˜ å°„çš„æ¦‚å¿µï¼Œé¦–é¡µä¸­ä¿å­˜</span><br>            <span class="hljs-type">atomic_t</span> compound_mapcount;<br>        &#125;;<br><br>        <span class="hljs-comment">// è¡¨ç¤º slab ä¸­éœ€è¦é‡Šæ”¾å›æ”¶çš„å¯¹è±¡é“¾è¡¨</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rcu_head</span> <span class="hljs-title">rcu_head</span>;</span><br>    &#125;;<br><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span>     <span class="hljs-comment">/* This union is 4 bytes in size. */</span><br>        <span class="hljs-comment">// è¡¨ç¤ºè¯¥ page æ˜ å°„äº†å¤šå°‘ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œä¸€ä¸ª page å¯ä»¥è¢«å¤šä¸ªè¿›ç¨‹æ˜ å°„</span><br>        <span class="hljs-type">atomic_t</span> _mapcount;<br><br>    &#125;;<br><br>    <span class="hljs-comment">// å†…æ ¸ä¸­å¼•ç”¨è¯¥ç‰©ç†é¡µçš„æ¬¡æ•°ï¼Œè¡¨ç¤ºè¯¥ç‰©ç†é¡µçš„æ´»è·ƒç¨‹åº¦ã€‚</span><br>    <span class="hljs-type">atomic_t</span> _refcount;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(WANT_PAGE_VIRTUAL)</span><br>    <span class="hljs-type">void</span> *virtual;  <span class="hljs-comment">// å†…å­˜é¡µå¯¹åº”çš„è™šæ‹Ÿå†…å­˜åœ°å€</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* WANT_PAGE_VIRTUAL */</span></span><br><br>&#125; _struct_page_alignment;<br></code></pre></td></tr></table></figure>

<ul>
<li><p>mappingï¼špage cacheï¼ˆé«˜é€Ÿé¡µç¼“å­˜ï¼‰ç»“æ„ä½“address_spaceï¼Œè¢«æ–‡ä»¶çš„inodeæŒæœ‰</p>
<ul>
<li>pageä¸ºæ–‡ä»¶é¡µï¼šmappingæœ€ä½ä½ä¸º0ï¼ŒæŒ‡å‘é¡µå…³è”æ–‡ä»¶çš„address_space</li>
<li>pageä¸ºåŒ¿åé¡µï¼šmappingæœ€ä½ä½ä¸º1ï¼ŒæŒ‡å‘åŒ¿åé¡µåœ¨è¿›ç¨‹è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­çš„åŒ¿åæ˜ å°„åŒºåŸŸanon_vmaç»“æ„ï¼Œç”¨äºç‰©ç†å†…å­˜åˆ°è™šæ‹Ÿå†…å­˜çš„åå‘æ˜ å°„</li>
</ul>
</li>
<li><p>indexï¼špgoff_t</p>
<ul>
<li>pageä¸ºæ–‡ä»¶é¡µï¼šè¡¨ç¤ºè¯¥å†…å­˜é¡µä¸­çš„æ–‡ä»¶æ•°æ®åœ¨æ–‡ä»¶å†…éƒ¨çš„åç§»offsetï¼Œåç§»å•ä½ä¸ºé¡µå¤§å°</li>
<li>pageä¸ºåŒ¿åé¡µï¼šè¡¨ç¤ºåŒ¿åé¡µåœ¨å¯¹åº”è¿›ç¨‹è™šæ‹Ÿå†…å­˜åŒºåŸŸVMAä¸­çš„åç§»</li>
</ul>
</li>
<li><p>_mapcountï¼šè¡¨ç¤ºè¯¥pageæ˜ å°„äº†å¤šå°‘ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œä¸€ä¸ªpageå¯ä»¥è¢«å¤šä¸ªè¿›ç¨‹æ˜ å°„</p>
</li>
<li><p>lruï¼šæŒ‡å‘ç‰©ç†é¡µè¢«æ”¾ç½®åœ¨äº†å“ªä¸ªé“¾è¡¨ä¸Šï¼ˆactiveï¼Œinactiveï¼‰</p>
</li>
<li><p>_refcountï¼šç”¨æ¥è®°å½•å†…æ ¸ä¸­å¼•ç”¨è¯¥ç‰©ç†é¡µçš„æ¬¡æ•°ï¼Œè¡¨ç¤ºè¯¥ç‰©ç†é¡µçš„æ´»è·ƒç¨‹åº¦</p>
</li>
<li><p>flagsï¼š</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/flags.png" srcset="/img/loading.gif" lazyload class title="flags">

<ul>
<li>é«˜8ä½å‚¨å­˜å®šä½ä¿¡æ¯ï¼ˆsectionï¼Œzoneï¼Œnodeï¼‰</li>
<li>å‚¨å­˜è®¿é—®ç›¸å…³ï¼Œæ¢å…¥æ¢å‡ºç›¸å…³ç­‰æ ‡å¿—</li>
</ul>
</li>
<li><p>å¤åˆé¡µç›¸å…³</p>
<ul>
<li>flagsï¼šå¦‚æœæ˜¯é¦–é¡µä¼šè®¾ç½®PG_head</li>
<li>compound_headï¼šå¤åˆé¡µçš„å°¾é¡µç”¨æ¥æŒ‡å‘é¦–é¡µ</li>
<li>compound_dtorï¼šç”¨äºé‡Šæ”¾å¤åˆé¡µçš„ææ„å‡½æ•°</li>
<li>compound_orderï¼šå¤åˆé¡µçš„order</li>
<li>compound_mapcountï¼šä½¿ç”¨å¤åˆé¡µçš„è¿›ç¨‹ä¸ªæ•°ï¼Œå†…å­˜é¡µåå‘æ˜ å°„çš„æ¦‚å¿µï¼Œé¦–é¡µä¸­ä¿å­˜</li>
<li>compound_pincountï¼šå¤åˆé¡µä½¿ç”¨è®¡æ•°ï¼Œé¦–é¡µä¸­ä¿å­˜</li>
</ul>
</li>
</ul>
<h3 id="åŒ¿åé¡µçš„åå‘æ˜ å°„"><a href="#åŒ¿åé¡µçš„åå‘æ˜ å°„" class="headerlink" title="åŒ¿åé¡µçš„åå‘æ˜ å°„"></a>åŒ¿åé¡µçš„åå‘æ˜ å°„</h3><p>åœ¨ç‰©ç†é¡µéœ€è¦è¢«è¿ç§»æˆ–è€…å›æ”¶æ—¶ä½¿ç”¨ï¼Œæ­¤æ—¶éœ€è¦æ‰¾åˆ°ç‰©ç†é¡µæ˜ å°„çš„è™šæ‹Ÿåœ°å€ï¼Œå¹¶æ–­å¼€è¿æ¥</p>
<ul>
<li><p>pageï¼šç»“æ„ä½“è¡¨ç¤ºä¸€ä¸ªç‰©ç†é¡µ</p>
</li>
<li><p>anon_vmaï¼šè¡¨ç¤ºä¸€ä¸ªåŒ¿åé¡µï¼ˆä»…ç”¨äºåå‘æ˜ å°„ï¼‰</p>
</li>
<li><p>anon_vma_chainï¼šè¡¨ç¤ºä¸€ä¸ªåŒ¿åé¡µå’Œä¸€æ®µè™šæ‹Ÿå†…å­˜çš„å…³ç³»</p>
<p><strong>åŒ¿åé¡µå’Œè™šæ‹Ÿå†…å­˜æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œå› ä¸ºä¸€ä¸ªåŒ¿åé¡µå¯èƒ½æ˜ å°„åˆ°å¾ˆå¤šè¿›ç¨‹çš„è™šæ‹Ÿç©ºé—´ â†’ anon_vmaå’Œanon_vma_chainä¹Ÿæ˜¯ä¸€å¯¹å¤šçš„å…³ç³»</strong></p>
</li>
<li><p>vm_area_structï¼šè¡¨ç¤ºä¸€æ®µè™šæ‹Ÿå†…å­˜</p>
</li>
</ul>


<ul>
<li><p>pageä¸­çš„mappingæŒ‡å‘anon_vmaç»“æ„ä½“</p>
</li>
<li><p>anon_vmaç»“æ„ä½“ä¸­çš„rb_rootçº¢é»‘æ ‘å‚¨å­˜äº†æ‰€æœ‰ä¸åŒ¿åé¡µç›¸å…³çš„anon_vma_chain</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">anon_vma</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">anon_vma</span> *<span class="hljs-title">root</span>;</span>		<span class="hljs-comment">/* Root of this anon_vma tree */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rw_semaphore</span> <span class="hljs-title">rwsem</span>;</span>	<span class="hljs-comment">/* W: modification, R: walking the list */</span><br>	<span class="hljs-type">atomic_t</span> refcount;<br>	<span class="hljs-type">unsigned</span> degree;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">anon_vma</span> *<span class="hljs-title">parent</span>;</span>	<span class="hljs-comment">/* Parent of this anon_vma */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_root_cached</span> <span class="hljs-title">rb_root</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure>
</li>
<li><p>anon_vma_chainç»“æ„ä½“ä¸²è”vm_area_structå’Œanon_vma</p>
<ul>
<li>vmaæŒ‡å‘ç›¸å…³çš„vm_area_struct</li>
<li>anon_vmaæŒ‡å‘ç›¸å…³çš„è™šæ‹Ÿé¡µ</li>
<li>same_vmaåŒå‘é“¾è¡¨ä¸²è”äº†vmaçš„æ‰€æœ‰åŒ¿åé¡µ</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">anon_vma_chain</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">anon_vma</span> *<span class="hljs-title">anon_vma</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">same_vma</span>;</span>   <span class="hljs-comment">/* locked by mmap_lock &amp; page_table_lock */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> <span class="hljs-title">rb</span>;</span>			<span class="hljs-comment">/* locked by anon_vma-&gt;rwsem */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rb_subtree_last;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DEBUG_VM_RB</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> cached_vma_start, cached_vma_last;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure>
</li>
<li><p>vm_area_structè¡¨ç¤ºVMA</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">anon_vma_chain</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">anon_vma</span> *<span class="hljs-title">anon_vma</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<ul>
<li>anon_vma_chainåŒå‘é“¾è¡¨ä¸²è¿äº†VMAçš„æ‰€æœ‰åŒ¿åé¡µ</li>
<li>anon_vmaç”¨äºå¿«é€Ÿåˆ¤æ–­ VMA æœ‰æ²¡æœ‰å¯¹åº”çš„åŒ¿å page</li>
</ul>
</li>
</ul>
<h1 id="ç‰©ç†å†…å­˜åˆ†é…"><a href="#ç‰©ç†å†…å­˜åˆ†é…" class="headerlink" title="ç‰©ç†å†…å­˜åˆ†é…"></a>ç‰©ç†å†…å­˜åˆ†é…</h1><h2 id="ç‰©ç†å†…å­˜åˆ†é…æ¥å£"><a href="#ç‰©ç†å†…å­˜åˆ†é…æ¥å£" class="headerlink" title="ç‰©ç†å†…å­˜åˆ†é…æ¥å£"></a>ç‰©ç†å†…å­˜åˆ†é…æ¥å£</h2><p>alloc_pageså‡½æ•°ç”¨äºè¯·æ±‚2çš„orderæ¬¡å¹‚ä¸ªpage</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> page *<span class="hljs-title function_">alloc_pages</span><span class="hljs-params">(<span class="hljs-type">gfp_t</span> gfp, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order)</span>;<br></code></pre></td></tr></table></figure>

<ul>
<li>orderï¼šåˆ†é…é˜¶</li>
<li>gfpï¼šç”¨äºè§„èŒƒç‰©ç†å†…å­˜åˆ†é…è¡Œä¸ºçš„ä¿®é¥°ç¬¦</li>
</ul>
<p>è¿”å›çš„æ˜¯pageç»“æ„ä½“ï¼Œéœ€è¦è½¬æ¢æˆè™šæ‹Ÿåœ°å€ä½¿ç”¨ï¼Œ__get_free_pageså‡½æ•°å¯ä»¥è¿”å›è™šæ‹Ÿåœ°å€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> __get_free_pages(<span class="hljs-type">gfp_t</span> gfp_mask, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order)<br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><br>	page = alloc_pages(gfp_mask &amp; ~__GFP_HIGHMEM, order);<br>	<span class="hljs-keyword">if</span> (!page)<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">return</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page_address(page);<br>&#125;<br>EXPORT_SYMBOL(__get_free_pages);<br></code></pre></td></tr></table></figure>

<p>å†…éƒ¨ä¹Ÿæ˜¯è°ƒç”¨äº†alloc_pagesï¼Œè¿›è¡Œäº†åœ°å€è½¬æ¢</p>
<ul>
<li>ä¸èƒ½åˆ†é…é«˜ç«¯å†…å­˜ï¼Œé«˜ç«¯å†…å­˜ä¸é€‚ç”¨äºç›´æ¥åœ°å€è½¬æ¢</li>
<li>è¿”å›åœ°å€ä½äºç›´æ¥æ˜ å°„åŒº</li>
</ul>
<p>get_zeroed_pageä¼šæŠŠpageå†…å®¹æ¸…é›¶</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-title function_">get_zeroed_page</span><span class="hljs-params">(<span class="hljs-type">gfp_t</span> gfp_mask)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> __get_free_pages(gfp_mask | __GFP_ZERO, <span class="hljs-number">0</span>);<br>&#125;<br>EXPORT_SYMBOL(get_zeroed_page);<br></code></pre></td></tr></table></figure>

<p>__get_dma_pagesåªåˆ†é…DMAå†…å­˜é¡µ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> __get_dma_pages(gfp_mask, order) \</span><br><span class="hljs-meta">		__get_free_pages((gfp_mask) | GFP_DMA, (order))</span><br></code></pre></td></tr></table></figure>

<p>ä¸¤ä¸ªå†…å­˜é‡Šæ”¾å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __free_pages(<span class="hljs-keyword">struct</span> page *page, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order);<br><span class="hljs-type">void</span> <span class="hljs-title function_">free_pages</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order)</span>;<br></code></pre></td></tr></table></figure>

<ul>
<li>__free_pageså¯¹åº”alloc_pagesï¼Œä½¿ç”¨pageç»“æ„ä½“</li>
<li>free_pageså¯¹åº”__get_free_pagesï¼Œä½¿ç”¨è™šæ‹Ÿå†…å­˜åœ°å€</li>
</ul>
<h2 id="ç‰©ç†å†…å­˜åˆ†é…æºç å®ç°"><a href="#ç‰©ç†å†…å­˜åˆ†é…æºç å®ç°" class="headerlink" title="ç‰©ç†å†…å­˜åˆ†é…æºç å®ç°"></a>ç‰©ç†å†…å­˜åˆ†é…æºç å®ç°</h2><p>å¤§ä½¬å†™çš„å¾ˆè¯¦ç»†äº†æ‰€ä»¥å°±æ”¾ä¸¤å¼ å›¾doge</p>
<p>å‡½æ•°è°ƒç”¨å›¾</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/allocpages.png" srcset="/img/loading.gif" lazyload class title="allocpages">

<p>__alloc_pageså‡½æ•°çš„é€»è¾‘</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/wateralloc.png" srcset="/img/loading.gif" lazyload class title="wateralloc">

<h1 id="buddy-system"><a href="#buddy-system" class="headerlink" title="buddy system"></a>buddy system</h1><p>zoneä¸­buddy systemç›¸å…³æˆå‘˜</p>
<p>free_areaçš„ä¸‹æ ‡è¡¨ç¤ºorder</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zone</span> &#123;</span><br>    <span class="hljs-comment">// è¢«ä¼™ä¼´ç³»ç»Ÿæ‰€ç®¡ç†çš„ç‰©ç†å†…å­˜é¡µä¸ªæ•°ï¼ˆpresent_pages-reserved_pagesï¼‰</span><br>    <span class="hljs-type">atomic_long_t</span>       managed_pages;<br>    <span class="hljs-comment">// ä¼™ä¼´ç³»ç»Ÿçš„æ ¸å¿ƒæ•°æ®ç»“æ„</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">free_area</span>    <span class="hljs-title">free_area</span>[<span class="hljs-title">MAX_ORDER</span>];</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>free_areaï¼Œä¸åŒè¿ç§»ç±»å‹çš„pageç”¨ä¸åŒçš„é“¾è¡¨ç®¡ç†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">free_area</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span>	<span class="hljs-title">free_list</span>[<span class="hljs-title">MIGRATE_TYPES</span>];</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>		nr_free;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> *<span class="hljs-title">next</span>, *<span class="hljs-title">prev</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>è¿ç§»ç±»å‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">migratetype</span> &#123;</span><br>	MIGRATE_UNMOVABLE,						<span class="hljs-comment">// ä¸å¯è¿ç§»</span><br>	MIGRATE_MOVABLE,						<span class="hljs-comment">// å¯è¿ç§»</span><br>	MIGRATE_RECLAIMABLE,					<span class="hljs-comment">// å¯å›æ”¶</span><br>	MIGRATE_PCPTYPES,						<span class="hljs-comment">// å±äºé«˜é€Ÿç¼“å­˜ï¼ˆper_cpu_pagesetï¼‰</span><br>	MIGRATE_HIGHATOMIC = MIGRATE_PCPTYPES,	  <span class="hljs-comment">// ç´§æ€¥å†…å­˜</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_CMA</span><br>	MIGRATE_CMA,							<span class="hljs-comment">// é¢„ç•™çš„è¿ç»­å†…å­˜CMA</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_MEMORY_ISOLATION</span><br>	MIGRATE_ISOLATE,						<span class="hljs-comment">// can&#x27;t allocate from here</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	MIGRATE_TYPES							<span class="hljs-comment">// è¿ç§»ç±»å‹æ•°é‡</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<ul>
<li>UNMOVABLEï¼šä¸€èˆ¬ä½äºç›´æ¥æ˜ å°„åŒºï¼Œå†…æ ¸æ‰€éœ€è¦çš„æ ¸å¿ƒå†…å­˜ä¸€èˆ¬ä»è¿™åˆ†é…</li>
<li>MOVABLEï¼šä¸€èˆ¬ç”¨äºåœ¨è¿›ç¨‹ç”¨æˆ·ç©ºé—´ä¸­åˆ†é…ï¼Œå› ä¸ºåœ¨ç”¨æˆ·ç©ºé—´ä¸­è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜éƒ½æ˜¯é€šè¿‡é¡µè¡¨æ¥åŠ¨æ€æ˜ å°„çš„ï¼Œç‰©ç†é¡µç§»åŠ¨ä¹‹åï¼Œåªéœ€è¦æ”¹å˜é¡µè¡¨ä¸­çš„æ˜ å°„å…³ç³»å³å¯ï¼Œè€Œè™šæ‹Ÿå†…å­˜åœ°å€å¹¶ä¸éœ€è¦æ”¹å˜</li>
<li>PCPTYPESï¼šé‡Œé¢åŒ…å«äº†é«˜é€Ÿç¼“å­˜ä¸­çš„å†·é¡µå’Œçƒ­é¡µ</li>
<li>RECLAIMABLEï¼šä¸èƒ½ç§»åŠ¨ä½†å¯ä»¥å›æ”¶ï¼Œæ¯”å¦‚æ–‡ä»¶ç¼“å­˜é¡µï¼Œä¹‹åå†ä»æ–‡ä»¶ä¸­è¯»å–å°±è¡Œ</li>
<li>CMAï¼šcontiguous memory allocatorï¼Œæ˜¯ä¸€ä¸ªåˆ†é…è¿ç»­ç‰©ç†å†…å­˜é¡µé¢çš„åˆ†é…å™¨ï¼Œç”¨äºåˆ†é…è¿ç»­çš„ç‰©ç†å†…å­˜</li>
<li>ISOLATEï¼šä¸€ä¸ªè™šæ‹ŸåŒºåŸŸï¼Œç”¨äºè·¨è¶ŠNUMAèŠ‚ç‚¹ç§»åŠ¨ç‰©ç†å†…å­˜é¡µï¼Œå†…æ ¸å¯ä»¥å°†ç‰©ç†å†…å­˜é¡µç§»åŠ¨åˆ°ä½¿ç”¨è¯¥é¡µæœ€é¢‘ç¹çš„CPU æ‰€åœ¨çš„NUMAèŠ‚ç‚¹ä¸­</li>
</ul>
<p>é•¿è¿™æ ·</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/buddy.png" srcset="/img/loading.gif" lazyload class title="buddy">

<p>å¦‚æœå¯¹åº”orderï¼Œmigratetypeçš„pageä¸å¤Ÿï¼Œä»å…¶ä»–migratetypeä¸­ç”³è¯·çš„é¡ºåºï¼Œæ³¨æ„fallbacksåˆ†é…çš„é¡ºåºå’Œæ­£å¸¸åˆ†é…çš„é¡ºåºæ˜¯åçš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> fallbacks[MIGRATE_TYPES][<span class="hljs-number">3</span>] = &#123;<br>	[MIGRATE_UNMOVABLE]   = &#123; MIGRATE_RECLAIMABLE, MIGRATE_MOVABLE,   MIGRATE_TYPES &#125;,<br>	[MIGRATE_MOVABLE]     = &#123; MIGRATE_RECLAIMABLE, MIGRATE_UNMOVABLE, MIGRATE_TYPES &#125;,<br>	[MIGRATE_RECLAIMABLE] = &#123; MIGRATE_UNMOVABLE,   MIGRATE_MOVABLE,   MIGRATE_TYPES &#125;,<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>æ”¾ä¸€å¼ get_page_from_freelistå‡½æ•°çš„é€»è¾‘</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/freelist.png" srcset="/img/loading.gif" lazyload class title="freelist">

<ul>
<li>for_next_zone_zonelist_nodemaskéå†<strong>å½“å‰NUMAèŠ‚ç‚¹ä»¥åŠå¤‡ç”¨èŠ‚ç‚¹çš„æ‰€æœ‰zoneï¼ˆzonelistï¼‰</strong></li>
<li>zone_watermark_fastæ£€æŸ¥zoneä¸­çš„å‰©ä½™å†…å­˜æ˜¯å¦åœ¨æŒ‡å®šæ°´ä½çº¿ä¸Šï¼Œæ˜¯åˆ™è·³è½¬è‡³try_this_zoneè°ƒç”¨rmqueueè¿›å…¥buddy systemè¿›è¡Œå†…å­˜åˆ†é…ï¼Œåˆ†é…æˆåŠŸåè°ƒç”¨prep_new_pageåˆå§‹åŒ–åˆ†é…å¥½çš„pageï¼Œå¦åˆ™ç»§ç»­</li>
<li>node_reclaimè§¦å‘å†…å­˜å›æ”¶ï¼Œå›æ”¶åé€šè¿‡zone_watermark_okæ£€æŸ¥å›æ”¶çš„å†…å­˜æ˜¯å¦æ»¡è¶³æœ¬æ¬¡åˆ†é…éœ€è¦ï¼Œæ˜¯åˆ™è·³è½¬è‡³try_this_zoneåœ¨zoneä¸­åˆ†é…å†…å­˜</li>
</ul>
<p>rmqueueåŒ…æ‹¬äº†buddy systemçš„ä¸»é€»è¾‘</p>
<ul>
<li>__rmqueue_smallestå°è£…buddy systemçš„æ ¸å¿ƒæµç¨‹</li>
<li>__rmqueueåº•å±‚è°ƒç”¨__rmqueue_smallestï¼Œè¿˜åŒ…æ‹¬fallbackçš„è¿‡ç¨‹</li>
</ul>
<p>ä¸€æ¬¡åˆ†é…çš„æµç¨‹å›¾</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/alloc3-0.png" srcset="/img/loading.gif" lazyload class title="alloc3-0">

<p>å†…å­˜é‡Šæ”¾æºç é€»è¾‘</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/freepages.png" srcset="/img/loading.gif" lazyload class title="freepages">

<p>é¡µç‰©ç†è§†å›¾</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/%E7%89%A9%E7%90%86.png" srcset="/img/loading.gif" lazyload class title="ç‰©ç†">

<p>ä¸€æ¬¡é‡Šæ”¾çš„è¿‡ç¨‹</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/%E9%87%8A%E6%94%BE.png" srcset="/img/loading.gif" lazyload class title="é‡Šæ”¾">

<h1 id="slab"><a href="#slab" class="headerlink" title="slab"></a>slab</h1><p>å†…æ ¸ç‰ˆæœ¬5.4ï¼Œslub</p>
<h2 id="slabæ•°æ®ç»“æ„ä½“"><a href="#slabæ•°æ®ç»“æ„ä½“" class="headerlink" title="slabæ•°æ®ç»“æ„ä½“"></a>slabæ•°æ®ç»“æ„ä½“</h2><p>slabç»“æ„å›¾</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/slab.jpg" srcset="/img/loading.gif" lazyload class title="slab">

<ul>
<li><p>kmem_cacheç»“æ„ä½“</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_cpu</span> __<span class="hljs-title">percpu</span> *<span class="hljs-title">cpu_slab</span>;</span><br>	<span class="hljs-comment">/* Used for retrieving partial slabs, etc. */</span><br>	<span class="hljs-type">slab_flags_t</span> flags;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size;	<span class="hljs-comment">/* The size of an object including metadata */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> object_size;<span class="hljs-comment">/* The size of an object without metadata */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset;	<span class="hljs-comment">/* Free pointer offset */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_order_objects</span> <span class="hljs-title">oo</span>;</span><br><br>	<span class="hljs-comment">/* Allocation and freeing of slabs */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_order_objects</span> <span class="hljs-title">max</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_order_objects</span> <span class="hljs-title">min</span>;</span><br>	<span class="hljs-type">gfp_t</span> allocflags;	<span class="hljs-comment">/* gfp flags to use on each alloc */</span><br>	<span class="hljs-type">int</span> refcount;		<span class="hljs-comment">/* Refcount for slab cache destroy */</span><br>	<span class="hljs-type">void</span> (*ctor)(<span class="hljs-type">void</span> *);<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> inuse;		<span class="hljs-comment">/* Offset to metadata */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> align;		<span class="hljs-comment">/* Alignment */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> red_left_pad;	<span class="hljs-comment">/* Left redzone padding size */</span><br>	<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;	<span class="hljs-comment">/* Name (only for display!) */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">list</span>;</span>	<span class="hljs-comment">/* List of slab caches */</span><br><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> useroffset;	<span class="hljs-comment">/* Usercopy region offset */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> usersize;		<span class="hljs-comment">/* Usercopy region size */</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_node</span> *<span class="hljs-title">node</span>[<span class="hljs-title">MAX_NUMNODES</span>];</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<ul>
<li><p>flagsï¼šç®¡ç†æ ‡å¿—ä½</p>
<ul>
<li><p>SLAB_HWCACHE_ALIGNï¼šéœ€è¦è¿›è¡Œcache lineï¼ˆ64ä½ï¼‰å¯¹é½</p>
</li>
<li><p>SLAB_POISONï¼šéœ€è¦å¡«å……ç‰¹æ®Šå­—èŠ‚è¡¨ç¤ºçŠ¶æ€</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/poison.jpg" srcset="/img/loading.gif" lazyload class title="poison">
</li>
<li><p>SLAB_RED_ZONEï¼šéœ€è¦æ’å…¥red zoneé˜²æ­¢è¶Šç•Œè¯»å†™</p>
</li>
<li><p>SLAB_CACHE_DMAï¼šslabä¸­å†…å­˜æ¥è‡ªå“ªä¸ªå†…å­˜åŒºåŸŸ</p>
</li>
<li><p>SLAB_STORE_USERï¼šè¿½è¸ªå¯¹è±¡çš„åˆ†é…é‡Šæ”¾ä¿¡æ¯ï¼Œè¿½åŠ ä¸¤ä¸ªtrackå—</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/track.jpg" srcset="/img/loading.gif" lazyload class title="track"></li>
</ul>
</li>
<li><p>sizeï¼šslabå¯¹è±¡çœŸå®å¤§å°</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/size.jpg" srcset="/img/loading.gif" lazyload class title="size">
</li>
<li><p>object_sizeï¼šä½¿ç”¨çš„å†…å­˜å¤§å°ï¼ˆä¸Šå›¾object sizeè“è‰²éƒ¨åˆ†ï¼‰</p>
</li>
<li><p>offsetï¼šfreepointerçš„åç§»</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/freepointer.jpg" srcset="/img/loading.gif" lazyload class title="freepointer">
</li>
<li><p>ooï¼šå‚¨å­˜slabéœ€è¦çš„pageä¸ªæ•°</p>
</li>
<li><p>maxï¼šooçš„æœ€å¤§å€¼ï¼Œåˆå§‹åŒ–ä¸ºoo</p>
</li>
<li><p>minï¼šooçš„æœ€å°å€¼ï¼Œåˆå§‹åŒ–ä¸º1</p>
</li>
<li><p>allocflagsï¼šåˆ†é…æ—¶æ‰€ç”¨çš„æ ‡å¿—ä½</p>
</li>
<li><p>inuseï¼šword sizeå¯¹é½åçš„å¤§å°</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/inuse.jpg" srcset="/img/loading.gif" lazyload class title="inuse">
</li>
<li><p>alignï¼šç»¼åˆword sizeï¼Œcache lineï¼Œalignè®¡ç®—ä¸€ä¸ªåˆç†çš„å¯¹é½å°ºå¯¸</p>
</li>
<li><p>nameï¼šslab cacheçš„åç§°</p>
</li>
<li><p>refcountï¼šå¼•ç”¨è®¡æ•°</p>
</li>
<li><p>listï¼škmem_cacheç”¨åŒå‘é“¾è¡¨ä¸²è”</p>
</li>
<li><p>cpu_slabï¼šæ¯ä¸ªcpuæœ‰ä¸€ä¸ªslabæœ¬åœ°ç¼“å­˜</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_cpu</span> &#123;</span><br>	<span class="hljs-type">void</span> **freelist;	<span class="hljs-comment">/* Pointer to next available object */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> tid;	<span class="hljs-comment">/* Globally unique transaction id */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span>	<span class="hljs-comment">/* The slab from which we are allocating */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">partial</span>;</span>	<span class="hljs-comment">/* Partially allocated frozen slabs */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure>

<ul>
<li>freelistï¼šè¯¥slabç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡</li>
<li>tidï¼šcpuç¼–å·</li>
<li>pageï¼šslabæ‰€åœ¨çš„page</li>
<li>partialï¼šå¤‡ç”¨çš„slab</li>
</ul>
</li>
<li><p>nodeï¼šå¤‡ç”¨slabï¼ˆæ¯ä¸ªNUMAèŠ‚ç‚¹ä¸€ä¸ªï¼‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_node</span> &#123;</span><br>	<span class="hljs-type">spinlock_t</span> list_lock;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> nr_partial;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">partial</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_DEBUG</span><br>	<span class="hljs-type">atomic_long_t</span> nr_slabs;<br>	<span class="hljs-type">atomic_long_t</span> total_objects;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">full</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>&#125;;<br></code></pre></td></tr></table></figure>

<ul>
<li>nr_patialï¼šè¯¥NUMAèŠ‚ç‚¹å¤‡ç”¨slabä¸ªæ•°</li>
<li>patialï¼šå¤‡ç”¨slabç”¨ä¸€ä¸ªpatialåŒé“¾è¡¨ä¸²è”èµ·æ¥</li>
<li>fullï¼šä¸²è”æ‰€æœ‰åˆ†é…å®Œçš„slab</li>
</ul>
</li>
</ul>
</li>
<li><p>pageç»“æ„ä½“ä¸­slabç›¸å…³æˆå‘˜ï¼ˆé«˜ç‰ˆæœ¬å¦æœ‰slabç»“æ„ä½“ï¼‰ï¼Œä¸€ä¸ªpageæ˜¯ä¸€ä¸ªslab</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> &#123;</span><br>    	<span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span>	<span class="hljs-comment">/* slab, slob and slub */</span><br>			<span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>				<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">slab_list</span>;</span><br>				<span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span>	<span class="hljs-comment">/* Partial pages */</span><br>					<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">next</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_64BIT</span><br>					<span class="hljs-type">int</span> pages;	<span class="hljs-comment">/* Nr of pages left */</span><br>					<span class="hljs-type">int</span> pobjects;	<span class="hljs-comment">/* Approximate count */</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>					<span class="hljs-type">short</span> <span class="hljs-type">int</span> pages;<br>					<span class="hljs-type">short</span> <span class="hljs-type">int</span> pobjects;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>				&#125;;<br>			&#125;;<br>			<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *<span class="hljs-title">slab_cache</span>;</span> <span class="hljs-comment">/* not slob */</span><br>			<span class="hljs-comment">/* Double-word boundary */</span><br>			<span class="hljs-type">void</span> *freelist;		<span class="hljs-comment">/* first free object */</span><br>			<span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>				<span class="hljs-type">void</span> *s_mem;	<span class="hljs-comment">/* slab: first object */</span><br>				<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> counters;		<span class="hljs-comment">/* SLUB */</span><br>				<span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span>			<span class="hljs-comment">/* SLUB */</span><br>					<span class="hljs-type">unsigned</span> inuse:<span class="hljs-number">16</span>;<br>					<span class="hljs-type">unsigned</span> objects:<span class="hljs-number">15</span>;<br>					<span class="hljs-type">unsigned</span> frozen:<span class="hljs-number">1</span>;<br>				&#125;;<br>			&#125;;<br>		&#125;;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>slab_listï¼šslabæ‰€åœ¨ç®¡ç†é“¾è¡¨</li>
<li>nextï¼špartialä½¿ç”¨</li>
<li>pagesï¼šslabæ‰€åœ¨ç®¡ç†é“¾è¡¨ä¸­çš„åŒ…å«çš„slabæ€»æ•°</li>
<li>pobjectsï¼šslabæ‰€åœ¨ç®¡ç†é“¾è¡¨ä¸­åŒ…å«çš„å¯¹è±¡æ€»æ•°</li>
<li>slab_cacheï¼šæŒ‡å‘kmem_cache</li>
<li>freelistï¼šæŒ‡å‘slabä¸­ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡ï¼Œslabæ”¾è¿›cpu_slabåå°†è¿™ä¸ªæŒ‡é’ˆèµ‹ç»™cpu_slabï¼Œç„¶åç½®ç©º</li>
<li>inuseï¼šä½¿ç”¨çš„ç©ºé—´</li>
<li>objectsï¼šåŒ…å«çš„å¯¹è±¡ä¸ªæ•°</li>
<li>frozenï¼š1è¡¨ç¤ºåœ¨æœ¬åœ°cpuç¼“å­˜ä¸­</li>
</ul>
</li>
</ul>
<h2 id="åˆ†é…é€»è¾‘"><a href="#åˆ†é…é€»è¾‘" class="headerlink" title="åˆ†é…é€»è¾‘"></a>åˆ†é…é€»è¾‘</h2><ul>
<li><p>ä»æœ¬åœ°cpuç¼“å­˜ä¸­åˆ†é…ï¼ˆfast pathï¼‰ï¼šæŸ¥çœ‹freelistæ˜¯å¦æœ‰ç©ºé—²å¯¹è±¡</p>
</li>
<li><p>ä»æœ¬åœ°cpuç¼“å­˜partialåˆ—è¡¨ä¸­åˆ†é…ï¼šæœ¬åœ°cpuç¼“å­˜çš„slabï¼ˆpageï¼‰ä¸­æ²¡æœ‰ç©ºé—²å¯¹è±¡</p>
<ul>
<li>éå†partialåˆ—è¡¨ï¼Œæ‰¾ä¸€ä¸ªæ»¡è¶³åˆ†é…çš„slab</li>
<li>å°†è¿™ä¸ªslabä»partialä¸­æ‘˜ä¸‹ï¼Œæå‡ä¸ºæœ¬åœ°cpuç¼“å­˜</li>
</ul>
</li>
<li><p>ä»NUMAèŠ‚ç‚¹ç¼“å­˜ä¸­åˆ†é…ï¼šéå†kmem_cache_node-&gt;partialåˆ—è¡¨ï¼Œå°†é“¾è¡¨ä¸­çš„slabæ‘˜ä¸‹æ¥å¡«å……åˆ°æœ¬åœ°cpuç¼“å­˜çš„partialé“¾è¡¨ä¸­ï¼ˆæœ€å¤šcpu_partial &#x2F; 2ä¸ªï¼‰</p>
</li>
<li><p>ä»buddy systemä¸­é‡æ–°ç”³è¯·slabï¼šæœ€å¼€å§‹slabæ˜¯ç©ºçš„</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/%E7%A9%BAslab.jpg" srcset="/img/loading.gif" lazyload class title="ç©ºslab">

<p>åˆå§‹åŒ–æ–°ç”³è¯·çš„slabï¼Œæå‡ä¸ºcpuæœ¬åœ°ç¼“å­˜çš„page</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/newslab.jpg" srcset="/img/loading.gif" lazyload class title="newslab"></li>
</ul>
<p>å‡½æ•°è°ƒç”¨å…³ç³»å›¾</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/alloc.jpg" srcset="/img/loading.gif" lazyload class title="alloc111">

<h2 id="é‡Šæ”¾é€»è¾‘"><a href="#é‡Šæ”¾é€»è¾‘" class="headerlink" title="é‡Šæ”¾é€»è¾‘"></a>é‡Šæ”¾é€»è¾‘</h2><ul>
<li>é‡Šæ”¾å¯¹è±¡æ‰€å±slabåœ¨cpuæœ¬åœ°ç¼“å­˜ä¸­ï¼ˆfast pathï¼‰ï¼šç›´æ¥æ”¾å›cpuæœ¬åœ°ç¼“å­˜çš„slab</li>
<li>é‡Šæ”¾å¯¹è±¡æ‰€å±slabåœ¨cpuæœ¬åœ°ç¼“å­˜partialé“¾è¡¨ä¸­ï¼šç›´æ¥é‡Šæ”¾</li>
<li>é‡Šæ”¾å¯¹è±¡æ‰€å±slabä»fullå˜æˆpartialï¼ˆslabä¸åœ¨cpuæœ¬åœ°ç¼“å­˜ä¸­ï¼‰<ul>
<li>å¯¹è±¡æ”¾å›slabå¹¶å°†slabæ”¾å…¥æœ¬åœ°cpuç¼“å­˜çš„partialé“¾è¡¨ä¸­ï¼ˆpartialä¸­slabä¸ªæ•°æœªè¶…æ ‡ï¼‰</li>
<li>å°†partialé“¾è¡¨ä¸­çš„æ‰€æœ‰slabè½¬ç§»è‡³å¯¹åº”NUMAèŠ‚ç‚¹çš„node-&gt;partialé“¾è¡¨çš„å°¾éƒ¨ï¼Œå†å°†slabæ’å…¥æœ¬åœ°ç¼“å­˜çš„partialé“¾è¡¨ï¼ˆpartialä¸­slabä¸ªæ•°è¶…æ ‡ï¼‰</li>
</ul>
</li>
<li>é‡Šæ”¾å¯¹è±¡æ‰€å±slabä»partialå˜æˆempty<ul>
<li>ä¸æ˜¯æ´»è·ƒslabï¼Œæ”¾å›kmem_cache_node-&gt;partialé“¾è¡¨ï¼ˆpartialä¸­slabä¸ªæ•°æœªè¶…æ ‡ï¼Œmin_partialï¼‰</li>
<li>æ”¾å›buddy systemï¼ˆpartialä¸­slabä¸ªæ•°è¶…æ ‡ï¼‰</li>
</ul>
</li>
</ul>
<p>å‡½æ•°è°ƒç”¨å…³ç³»å›¾</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/free.jpg" srcset="/img/loading.gif" lazyload class title="free111">

<h2 id="slabå†…å­˜æ± çš„åˆ›å»ºåˆå§‹åŒ–æµç¨‹"><a href="#slabå†…å­˜æ± çš„åˆ›å»ºåˆå§‹åŒ–æµç¨‹" class="headerlink" title="slabå†…å­˜æ± çš„åˆ›å»ºåˆå§‹åŒ–æµç¨‹"></a>slabå†…å­˜æ± çš„åˆ›å»ºåˆå§‹åŒ–æµç¨‹</h2><p>å°±æ”¾ä¸€å¼ å‡½æ•°è°ƒç”¨å…³ç³»å›¾</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/create.jpg" srcset="/img/loading.gif" lazyload class title="create">

<h2 id="slabå†…å­˜æ± çš„é”€æ¯"><a href="#slabå†…å­˜æ± çš„é”€æ¯" class="headerlink" title="slabå†…å­˜æ± çš„é”€æ¯"></a>slabå†…å­˜æ± çš„é”€æ¯</h2><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/destroy.jpg" srcset="/img/loading.gif" lazyload class title="destroy">

<h2 id="kmallocä½“ç³»"><a href="#kmallocä½“ç³»" class="headerlink" title="kmallocä½“ç³»"></a>kmallocä½“ç³»</h2><p>kmallocä½“ç³»åŸºäºslab allocatorä½“ç³»ï¼Œæœ¬è´¨æ˜¯ä¸åŒå°ºå¯¸çš„é€šç”¨slab cache</p>
<h3 id="kmallocå†…å­˜å—å°ºå¯¸"><a href="#kmallocå†…å­˜å—å°ºå¯¸" class="headerlink" title="kmallocå†…å­˜å—å°ºå¯¸"></a>kmallocå†…å­˜å—å°ºå¯¸</h3><p>slab cacheä¿¡æ¯å‚¨å­˜åœ¨kmalloc_infoæ•°ç»„ä¸­ï¼Œç”±kmalloc_info_structç»“æ„ä½“è¡¨ç¤º</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">extern</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmalloc_info_struct</span> &#123;</span><br>	<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size;<br>&#125; kmalloc_info[];<br></code></pre></td></tr></table></figure>

<ul>
<li>nameï¼šslab cacheåå­—</li>
<li>sizeï¼šå†…å­˜å—å¤§å°</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmalloc_info_struct</span> <span class="hljs-title">kmalloc_info</span>[] __<span class="hljs-title">initconst</span> =</span> &#123;<br>	&#123;<span class="hljs-literal">NULL</span>,                      <span class="hljs-number">0</span>&#125;,		&#123;<span class="hljs-string">&quot;kmalloc-96&quot;</span>,             <span class="hljs-number">96</span>&#125;,<br>	&#123;<span class="hljs-string">&quot;kmalloc-192&quot;</span>,           <span class="hljs-number">192</span>&#125;,		&#123;<span class="hljs-string">&quot;kmalloc-8&quot;</span>,               <span class="hljs-number">8</span>&#125;,<br>	&#123;<span class="hljs-string">&quot;kmalloc-16&quot;</span>,             <span class="hljs-number">16</span>&#125;,		&#123;<span class="hljs-string">&quot;kmalloc-32&quot;</span>,             <span class="hljs-number">32</span>&#125;,<br>	&#123;<span class="hljs-string">&quot;kmalloc-64&quot;</span>,             <span class="hljs-number">64</span>&#125;,		&#123;<span class="hljs-string">&quot;kmalloc-128&quot;</span>,           <span class="hljs-number">128</span>&#125;,<br>	&#123;<span class="hljs-string">&quot;kmalloc-256&quot;</span>,           <span class="hljs-number">256</span>&#125;,		&#123;<span class="hljs-string">&quot;kmalloc-512&quot;</span>,           <span class="hljs-number">512</span>&#125;,<br>	&#123;<span class="hljs-string">&quot;kmalloc-1k&quot;</span>,           <span class="hljs-number">1024</span>&#125;,		&#123;<span class="hljs-string">&quot;kmalloc-2k&quot;</span>,           <span class="hljs-number">2048</span>&#125;,<br>	&#123;<span class="hljs-string">&quot;kmalloc-4k&quot;</span>,           <span class="hljs-number">4096</span>&#125;,		&#123;<span class="hljs-string">&quot;kmalloc-8k&quot;</span>,           <span class="hljs-number">8192</span>&#125;,<br>	&#123;<span class="hljs-string">&quot;kmalloc-16k&quot;</span>,         <span class="hljs-number">16384</span>&#125;,		&#123;<span class="hljs-string">&quot;kmalloc-32k&quot;</span>,         <span class="hljs-number">32768</span>&#125;,<br>	&#123;<span class="hljs-string">&quot;kmalloc-64k&quot;</span>,         <span class="hljs-number">65536</span>&#125;,		&#123;<span class="hljs-string">&quot;kmalloc-128k&quot;</span>,       <span class="hljs-number">131072</span>&#125;,<br>	&#123;<span class="hljs-string">&quot;kmalloc-256k&quot;</span>,       <span class="hljs-number">262144</span>&#125;,		&#123;<span class="hljs-string">&quot;kmalloc-512k&quot;</span>,       <span class="hljs-number">524288</span>&#125;,<br>	&#123;<span class="hljs-string">&quot;kmalloc-1M&quot;</span>,        <span class="hljs-number">1048576</span>&#125;,		&#123;<span class="hljs-string">&quot;kmalloc-2M&quot;</span>,        <span class="hljs-number">2097152</span>&#125;,<br>	&#123;<span class="hljs-string">&quot;kmalloc-4M&quot;</span>,        <span class="hljs-number">4194304</span>&#125;,		&#123;<span class="hljs-string">&quot;kmalloc-8M&quot;</span>,        <span class="hljs-number">8388608</span>&#125;,<br>	&#123;<span class="hljs-string">&quot;kmalloc-16M&quot;</span>,      <span class="hljs-number">16777216</span>&#125;,		&#123;<span class="hljs-string">&quot;kmalloc-32M&quot;</span>,      <span class="hljs-number">33554432</span>&#125;,<br>	&#123;<span class="hljs-string">&quot;kmalloc-64M&quot;</span>,      <span class="hljs-number">67108864</span>&#125;<br>&#125;;<br></code></pre></td></tr></table></figure>

<ul>
<li>index &gt; 2 æ—¶sizeä¸º2 ^ index</li>
<li>ç”±äºå†…æ ¸å¤§éƒ¨åˆ†ç”³è¯·å¤§å°éƒ½åœ¨192å’Œ96å·¦å³æ‰€ä»¥å•ç‹¬æä¾›è¿™ä¸¤ç§å¤§å°çš„slab cache</li>
</ul>
<p>size_index[24]æ•°ç»„ç”¨äºå®šä¹‰å°äº192å¤§å°çš„å†…å­˜å—çš„å¤§å°é€‰å–è§„åˆ™</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> u8 size_index[<span class="hljs-number">24</span>] __ro_after_init = &#123;<br>	<span class="hljs-number">3</span>,	<span class="hljs-comment">/* 8 */</span><br>	<span class="hljs-number">4</span>,	<span class="hljs-comment">/* 16 */</span><br>	<span class="hljs-number">5</span>,	<span class="hljs-comment">/* 24 */</span><br>	<span class="hljs-number">5</span>,	<span class="hljs-comment">/* 32 */</span><br>	<span class="hljs-number">6</span>,	<span class="hljs-comment">/* 40 */</span><br>	<span class="hljs-number">6</span>,	<span class="hljs-comment">/* 48 */</span><br>	<span class="hljs-number">6</span>,	<span class="hljs-comment">/* 56 */</span><br>	<span class="hljs-number">6</span>,	<span class="hljs-comment">/* 64 */</span><br>	<span class="hljs-number">1</span>,	<span class="hljs-comment">/* 72 */</span><br>	<span class="hljs-number">1</span>,	<span class="hljs-comment">/* 80 */</span><br>	<span class="hljs-number">1</span>,	<span class="hljs-comment">/* 88 */</span><br>	<span class="hljs-number">1</span>,	<span class="hljs-comment">/* 96 */</span><br>	<span class="hljs-number">7</span>,	<span class="hljs-comment">/* 104 */</span><br>	<span class="hljs-number">7</span>,	<span class="hljs-comment">/* 112 */</span><br>	<span class="hljs-number">7</span>,	<span class="hljs-comment">/* 120 */</span><br>	<span class="hljs-number">7</span>,	<span class="hljs-comment">/* 128 */</span><br>	<span class="hljs-number">2</span>,	<span class="hljs-comment">/* 136 */</span><br>	<span class="hljs-number">2</span>,	<span class="hljs-comment">/* 144 */</span><br>	<span class="hljs-number">2</span>,	<span class="hljs-comment">/* 152 */</span><br>	<span class="hljs-number">2</span>,	<span class="hljs-comment">/* 160 */</span><br>	<span class="hljs-number">2</span>,	<span class="hljs-comment">/* 168 */</span><br>	<span class="hljs-number">2</span>,	<span class="hljs-comment">/* 176 */</span><br>	<span class="hljs-number">2</span>,	<span class="hljs-comment">/* 184 */</span><br>	<span class="hljs-number">2</span>	<span class="hljs-comment">/* 192 */</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>æ³¨é‡Šå†…æ˜¯ç”³è¯·å¤§å°ï¼Œæ•°ç»„å…ƒç´ æ˜¯slab cacheå¯¹åº”ä¸‹æ ‡</p>
<p>ç”³è¯·å°ºå¯¸å¤§äº192æ—¶ä½¿ç”¨flså‡½æ•°è®¡ç®—ï¼Œflså¯ä»¥è·å–å‚æ•°çš„æœ€é«˜æœ‰æ•ˆbitçš„ä½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * fls = Find Last Set in word</span><br><span class="hljs-comment"> * @result: [1-32]</span><br><span class="hljs-comment"> * fls(1) = 1, fls(0x80000000) = 32, fls(0) = 0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> __attribute__ ((<span class="hljs-type">const</span>)) <span class="hljs-type">int</span> <span class="hljs-title function_">fls</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> x)</span><br>&#123;<br>	<span class="hljs-type">int</span> n;<br><br>	<span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span><span class="hljs-params">(</span><br><span class="hljs-params">	<span class="hljs-string">&quot;	fls.f	%0, %1		\n&quot;</span>  <span class="hljs-comment">/* 0:31; 0(Z) if src 0 */</span></span><br><span class="hljs-params">	<span class="hljs-string">&quot;	add.nz	%0, %0, 1	\n&quot;</span>  <span class="hljs-comment">/* 0:31 -&gt; 1:32 */</span></span><br><span class="hljs-params">	: <span class="hljs-string">&quot;=r&quot;</span>(n)	<span class="hljs-comment">/* Early clobber not needed */</span></span><br><span class="hljs-params">	: <span class="hljs-string">&quot;r&quot;</span>(x)</span><br><span class="hljs-params">	: <span class="hljs-string">&quot;cc&quot;</span>)</span>;<br><br>	<span class="hljs-keyword">return</span> n;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="kmallocæ¶æ„"><a href="#kmallocæ¶æ„" class="headerlink" title="kmallocæ¶æ„"></a>kmallocæ¶æ„</h3><img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/kmalloc%E5%86%85%E5%AD%98%E6%B1%A0.jpg" srcset="/img/loading.gif" lazyload class title="kmallocå†…å­˜æ± ">

<p>æ‰€æœ‰çš„kmem_cacheå‚¨å­˜åœ¨ä¸€ä¸ªå…¨å±€æ•°ç»„ä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *</span><br><span class="hljs-class"><span class="hljs-title">kmalloc_caches</span>[<span class="hljs-title">NR_KMALLOC_TYPES</span>][<span class="hljs-title">KMALLOC_SHIFT_HIGH</span> + 1] __<span class="hljs-title">ro_after_init</span> =</span><br>&#123; <span class="hljs-comment">/* initialization for https://bugs.llvm.org/show_bug.cgi?id=42570 */</span> &#125;;<br>EXPORT_SYMBOL(kmalloc_caches);<br></code></pre></td></tr></table></figure>

<ul>
<li><p>ç¬¬ä¸€ä¸ªä¸‹æ ‡è¡¨ç¤ºç‰©ç†å†…å­˜åŒºåŸŸç±»å‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">kmalloc_cache_type</span> &#123;</span><br>	KMALLOC_NORMAL = <span class="hljs-number">0</span>,<br>	KMALLOC_RECLAIM,<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_ZONE_DMA</span><br>	KMALLOC_DMA,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	NR_KMALLOC_TYPES<br>&#125;;<br></code></pre></td></tr></table></figure>
</li>
<li><p>ç¬¬äºŒä¸ªä¸‹æ ‡è¡¨ç¤ºslab cache</p>
</li>
</ul>
<h3 id="kmallocä½“ç³»çš„åˆ›å»º"><a href="#kmallocä½“ç³»çš„åˆ›å»º" class="headerlink" title="kmallocä½“ç³»çš„åˆ›å»º"></a>kmallocä½“ç³»çš„åˆ›å»º</h3><p>å‡½æ•°è°ƒç”¨æµç¨‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">start_kernel -&gt; mm_init -&gt; kmem_cache_init<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __init <span class="hljs-title function_">kmem_cache_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">/* slab allocatorä½“ç³»çš„åˆ›å»ºåˆå§‹åŒ– */</span><br>	<span class="hljs-comment">/* Now we can use the kmem_cache to allocate kmalloc slabs */</span><br>	setup_kmalloc_cache_index_table();<br>	create_kmalloc_caches(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸»è¦å°±æ˜¯ä¸¤ä¸ªå‡½æ•°</p>
<ul>
<li>setup_kmalloc_cache_index_tableï¼šåˆå§‹åŒ–size_indexæ•°ç»„</li>
<li>create_kmalloc_cachesï¼šåˆ›å»ºåˆå§‹åŒ–kmalloc_cachesäºŒç»´æ•°ç»„</li>
</ul>
<h3 id="kmallocå†…å­˜æ± çš„åˆ†é…å’Œå›æ”¶"><a href="#kmallocå†…å­˜æ± çš„åˆ†é…å’Œå›æ”¶" class="headerlink" title="kmallocå†…å­˜æ± çš„åˆ†é…å’Œå›æ”¶"></a>kmallocå†…å­˜æ± çš„åˆ†é…å’Œå›æ”¶</h3><p>kmallocåˆ†é…</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/kmalloc_alloc.jpg" srcset="/img/loading.gif" lazyload class title="kmalloc_alloc">

<p>kfreeå›æ”¶ï¼ˆè¿‡äºç®€å•ç”šè‡³ä¸é…æ‹¥æœ‰ä¸€å¼ å›¾ï¼‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">kfree</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *x)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br>	<span class="hljs-type">void</span> *object = (<span class="hljs-type">void</span> *)x;<br><br>	page = virt_to_head_page(x);<br>	<span class="hljs-keyword">if</span> (unlikely(!PageSlab(page))) &#123;<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order = compound_order(page);<br><br>		BUG_ON(!PageCompound(page));<br>		kfree_hook(object);<br>		mod_node_page_state(page_pgdat(page), NR_SLAB_UNRECLAIMABLE,<br>				    -(<span class="hljs-number">1</span> &lt;&lt; order));<br>		__free_pages(page, order);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br>	slab_free(page-&gt;slab_cache, page, object, <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, _RET_IP_);<br>&#125;<br>EXPORT_SYMBOL(kfree);<br></code></pre></td></tr></table></figure>

<ul>
<li>ä½¿ç”¨virt_to_head_pageå‡½æ•°å°†è™šæ‹Ÿåœ°å€è½¬åŒ–ä¸ºpageç»“æ„ä½“</li>
<li>é€šè¿‡PageSlabæŸ¥çœ‹pageçš„æ˜¯å¦è®¾ç½®PG_slabæ ‡è¯†<ul>
<li>æ²¡æœ‰åˆ™æ˜¯ä»buddy systemä¸­åˆ†é…çš„ï¼Œä½¿ç”¨__free_pagesæ”¾å›buddy system</li>
<li>å¦åˆ™è°ƒç”¨slab_freeæ”¾å›å¯¹åº”slab</li>
</ul>
</li>
</ul>
<h1 id="é¡µè¡¨ä½“ç³»"><a href="#é¡µè¡¨ä½“ç³»" class="headerlink" title="é¡µè¡¨ä½“ç³»"></a>é¡µè¡¨ä½“ç³»</h1><p>å°±æ”¾ä¸¤å¼ å›¾ï¼Œè°ƒè¯•å¯åŠ¨æµç¨‹çš„æ—¶å€™å¯¹è¿™ç©æ„æœ‰æ·±åˆ»çš„è®¤è¯†äº†(Ë‰â–½Ë‰ï¼›)â€¦</p>
<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/%E5%9B%9B%E7%BA%A7%E9%A1%B5%E8%A1%A8.png" srcset="/img/loading.gif" lazyload class title="å››çº§é¡µè¡¨">

<img src="/2023/11/13/Kernel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/%E5%9B%9B%E7%BA%A7%E9%A1%B5%E8%A1%A82.png" srcset="/img/loading.gif" lazyload class title="å››çº§é¡µè¡¨2">

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Kernel/" class="category-chain-item">Kernel</a>
  
  
    <span>></span>
    
  <a href="/categories/Kernel/Source-Code/" class="category-chain-item">Source Code</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/kernel/" class="print-no-link">#kernel</a>
      
        <a href="/tags/source-code/" class="print-no-link">#source code</a>
      
        <a href="/tags/memory/" class="print-no-link">#memory</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Kernelæºç åˆ†æ-å†…å­˜ç®¡ç†</div>
      <div>http://akaieurus.github.io/2023/11/13/Kernelæºç åˆ†æ-å†…å­˜ç®¡ç†/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>Eurus</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2023å¹´11æœˆ13æ—¥</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>è®¸å¯åè®®</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/11/30/2023%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81-water-ker/" title="2023 å¼ºç½‘æ‹Ÿæ€ water-ker">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">2023 å¼ºç½‘æ‹Ÿæ€ water-ker</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/11/08/kernel-userfaultfd/" title="userfaultfd">
                        <span class="hidden-mobile">userfaultfd</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ç›®å½•</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
